import C from"process";var H=typeof globalThis!=="undefined"?globalThis:typeof self!=="undefined"?self:global;var te={};var le=C;(function(C,H){te=H()})(0,(function(){var C,te,ce;function define(H,le){if(C)if(te){var he="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+C+")(sharedChunk); ("+te+")(sharedChunk); self.onerror = null;";var ue={};C(ue);ce=le(ue);typeof window!=="undefined"&&window&&window.URL&&window.URL.createObjectURL&&(ce.workerUrl=window.URL.createObjectURL(new Blob([he],{type:"text/javascript"})))}else te=le;else C=le}define(["exports"],(function(C){var te="undefined"!=typeof self?self:{},ce="3.0.1";let he;const ue={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){if(null==he){const C=/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i;try{he=null!=le.env.API_URL_REGEX?new RegExp(le.env.API_URL_REGEX):C}catch(H){he=C}}return he},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!ue.API_URL)return null;try{const C=new URL(ue.API_URL);return"api.mapbox.cn"===C.hostname?"https://events.mapbox.cn/events/v2":"api.mapbox.com"===C.hostname?"https://events.mapbox.com/events/v2":null}catch(C){return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},de={supported:!1,testSupport:function(C){!ve&&ye&&(Me?h(C):_e=C)}};let _e,ye,ve=!1,Me=!1;function h(C){const H=C.createTexture();C.bindTexture(C.TEXTURE_2D,H);try{if(C.texImage2D(C.TEXTURE_2D,0,C.RGBA,C.RGBA,C.UNSIGNED_BYTE,ye),C.isContextLost())return;de.supported=!0}catch(C){}C.deleteTexture(H),ve=!0}te.document&&(ye=te.document.createElement("img"),ye.onload=function(){_e&&h(_e),_e=null,Me=!0},ye.onerror=function(){ve=!0,_e=null},ye.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const Se="01";function d(C){return C&&C.__esModule&&Object.prototype.hasOwnProperty.call(C,"default")?C.default:C}var Ae=f;function f(C,te,le,ce){(this||H).cx=3*C,(this||H).bx=3*(le-C)-(this||H).cx,(this||H).ax=1-(this||H).cx-(this||H).bx,(this||H).cy=3*te,(this||H).by=3*(ce-te)-(this||H).cy,(this||H).ay=1-(this||H).cy-(this||H).by,(this||H).p1x=C,(this||H).p1y=te,(this||H).p2x=le,(this||H).p2y=ce}f.prototype={sampleCurveX:function(C){return(((this||H).ax*C+(this||H).bx)*C+(this||H).cx)*C},sampleCurveY:function(C){return(((this||H).ay*C+(this||H).by)*C+(this||H).cy)*C},sampleCurveDerivativeX:function(C){return(3*(this||H).ax*C+2*(this||H).bx)*C+(this||H).cx},solveCurveX:function(C,H){if(void 0===H&&(H=1e-6),C<0)return 0;if(C>1)return 1;for(var te=C,le=0;le<8;le++){var ce=this.sampleCurveX(te)-C;if(Math.abs(ce)<H)return te;var he=this.sampleCurveDerivativeX(te);if(Math.abs(he)<1e-6)break;te-=ce/he}var ue=0,de=1;for(te=C,le=0;le<20&&(ce=this.sampleCurveX(te),!(Math.abs(ce-C)<H));le++)C>ce?ue=te:de=te,te=.5*(de-ue)+ue;return te},solve:function(C,H){return this.sampleCurveY(this.solveCurveX(C,H))}};var Ce=d(Ae),Oe=g;function g(C,te){(this||H).x=C,(this||H).y=te}g.prototype={clone:function(){return new g((this||H).x,(this||H).y)},add:function(C){return this.clone()._add(C)},sub:function(C){return this.clone()._sub(C)},multByPoint:function(C){return this.clone()._multByPoint(C)},divByPoint:function(C){return this.clone()._divByPoint(C)},mult:function(C){return this.clone()._mult(C)},div:function(C){return this.clone()._div(C)},rotate:function(C){return this.clone()._rotate(C)},rotateAround:function(C,H){return this.clone()._rotateAround(C,H)},matMult:function(C){return this.clone()._matMult(C)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt((this||H).x*(this||H).x+(this||H).y*(this||H).y)},equals:function(C){return(this||H).x===C.x&&(this||H).y===C.y},dist:function(C){return Math.sqrt(this.distSqr(C))},distSqr:function(C){var te=C.x-(this||H).x,le=C.y-(this||H).y;return te*te+le*le},angle:function(){return Math.atan2((this||H).y,(this||H).x)},angleTo:function(C){return Math.atan2((this||H).y-C.y,(this||H).x-C.x)},angleWith:function(C){return this.angleWithSep(C.x,C.y)},angleWithSep:function(C,te){return Math.atan2((this||H).x*te-(this||H).y*C,(this||H).x*C+(this||H).y*te)},_matMult:function(C){var te=C[2]*(this||H).x+C[3]*(this||H).y;return(this||H).x=C[0]*(this||H).x+C[1]*(this||H).y,(this||H).y=te,this||H},_add:function(C){return(this||H).x+=C.x,(this||H).y+=C.y,this||H},_sub:function(C){return(this||H).x-=C.x,(this||H).y-=C.y,this||H},_mult:function(C){return(this||H).x*=C,(this||H).y*=C,this||H},_div:function(C){return(this||H).x/=C,(this||H).y/=C,this||H},_multByPoint:function(C){return(this||H).x*=C.x,(this||H).y*=C.y,this||H},_divByPoint:function(C){return(this||H).x/=C.x,(this||H).y/=C.y,this||H},_unit:function(){return this._div(this.mag()),this||H},_perp:function(){var C=(this||H).y;return(this||H).y=(this||H).x,(this||H).x=-C,this||H},_rotate:function(C){var te=Math.cos(C),le=Math.sin(C),ce=le*(this||H).x+te*(this||H).y;return(this||H).x=te*(this||H).x-le*(this||H).y,(this||H).y=ce,this||H},_rotateAround:function(C,te){var le=Math.cos(C),ce=Math.sin(C),he=te.y+ce*((this||H).x-te.x)+le*((this||H).y-te.y);return(this||H).x=te.x+le*((this||H).x-te.x)-ce*((this||H).y-te.y),(this||H).y=he,this||H},_round:function(){return(this||H).x=Math.round((this||H).x),(this||H).y=Math.round((this||H).y),this||H}},g.convert=function(C){return C instanceof g?C:Array.isArray(C)?new g(C[0],C[1]):C};var Ne=d(Oe);function x(C,H){if(Array.isArray(C)){if(!Array.isArray(H)||C.length!==H.length)return!1;for(let te=0;te<C.length;te++)if(!x(C[te],H[te]))return!1;return!0}if("object"==typeof C&&null!==C&&null!==H){if("object"!=typeof H)return!1;if(Object.keys(C).length!==Object.keys(H).length)return!1;for(const te in C)if(!x(C[te],H[te]))return!1;return!0}return C===H}const je=Math.PI/180,Ge=180/Math.PI;function w(C){return C*je}function T(C){return C*Ge}const Ze=[[0,0],[1,0],[1,1],[0,1]];function M(C){if(C<=0)return 0;if(C>=1)return 1;const H=C*C,te=H*C;return 4*(C<.5?te:3*(C-H)+te-.75)}function A(C){let H=1/0,te=1/0,le=-1/0,ce=-1/0;for(const he of C)H=Math.min(H,he.x),te=Math.min(te,he.y),le=Math.max(le,he.x),ce=Math.max(ce,he.y);return{min:new Ne(H,te),max:new Ne(le,ce)}}function S(C,H,te=0,le=!0){const ce=new Ne(te,te),he=C.sub(ce),ue=H.add(ce),de=[he,new Ne(ue.x,he.y),ue,new Ne(he.x,ue.y)];return le&&de.push(he.clone()),de}function I(C,H,te,le){const ce=new Ce(C,H,te,le);return function(C){return ce.solve(C)}}const qe=I(.25,.1,.25,1);function z(C,H,te){return Math.min(te,Math.max(H,C))}function D(C,H,te){return(te=z((te-C)/(H-C),0,1))*te*(3-2*te)}function P(C,H,te){const le=te-H,ce=((C-H)%le+le)%le+H;return ce===H?te:ce}function R(C,H,te){if(!C.length)return te(null,[]);let le=C.length;const ce=new Array(C.length);let he=null;C.forEach(((C,ue)=>{H(C,((C,H)=>{C&&(he=C),ce[ue]=H,0==--le&&te(he,ce)}))}))}function L(C){const H=[];for(const te in C)H.push(C[te]);return H}function k(C,...H){for(const te of H)for(const H in te)C[H]=te[H];return C}function O(C,H){const te={};for(let le=0;le<H.length;le++){const ce=H[le];ce in C&&(te[ce]=C[ce])}return te}let $e=1;function F(){return $e++}function N(){return function e(C){return C?(C^Math.random()*(16>>C/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,e)}()}function U(C){return C<=1?1:Math.pow(2,Math.ceil(Math.log(C)/Math.LN2))}function V(C){return!!C&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(C)}function j(C,H){C.forEach((C=>{H[C]&&(H[C]=H[C].bind(H))}))}function G(C,H){return-1!==C.indexOf(H,C.length-H.length)}function q(C,te,le){const ce={};for(const he in C)ce[he]=te.call(le||this||H,C[he],he,C);return ce}function Z(C,te,le){const ce={};for(const he in C)te.call(le||this||H,C[he],he,C)&&(ce[he]=C[he]);return ce}function $(C){return Array.isArray(C)?C.map($):"object"==typeof C&&C?q(C,$):C}const We={};function W(C){We[C]||("undefined"!=typeof console&&console.warn(C),We[C]=!0)}function X(C,H,te){return(te.y-C.y)*(H.x-C.x)>(H.y-C.y)*(te.x-C.x)}function Y(C){let H=0;for(let te,le,ce=0,he=C.length,ue=he-1;ce<he;ue=ce++)te=C[ce],le=C[ue],H+=(le.x-te.x)*(te.y+le.y);return H}function K([C,H,te]){const le=w(H+90),ce=w(te);return{x:C*Math.cos(le)*Math.sin(ce),y:C*Math.sin(le)*Math.sin(ce),z:C*Math.cos(ce),azimuthal:H,polar:te}}function J(C,H,te){const le=Math.sqrt(C*C+H*H+te*te),ce=le>0?Math.acos(te/le)*Ge:0;let he=0!==C||0!==H?Math.atan2(-H,-C)*Ge+90:0;return he<0&&(he+=360),[le,he,ce]}function Q(){return"undefined"!=typeof WorkerGlobalScope&&"undefined"!=typeof self&&self instanceof WorkerGlobalScope}function ee(C){const H={};if(C.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,((C,te,le,ce)=>{const he=le||ce;return H[te]=!he||he.toLowerCase(),""})),H["max-age"]){const C=parseInt(H["max-age"],10);isNaN(C)?delete H["max-age"]:H["max-age"]=C}return H}let He=null;function ie(){return!!te.document.fullscreenElement||!!te.document.webkitFullscreenElement}function re(C){try{const H=te[C];return H.setItem("_mapbox_test_",1),H.removeItem("_mapbox_test_"),!0}catch(C){return!1}}function ne(C,H){return[C[4*H],C[4*H+1],C[4*H+2],C[4*H+3]]}function oe(C,H,te){C[4*H+0]=te[0],C[4*H+1]=te[1],C[4*H+2]=te[2],C[4*H+3]=te[3]}function se(C,H){return[Math.pow(C[0],2.2)*H,Math.pow(C[1],2.2)*H,Math.pow(C[2],2.2)*H]}function ae(C){return[Math.pow(C[0],1/2.2),Math.pow(C[1],1/2.2),Math.pow(C[2],1/2.2)]}const Xe="mapbox-tiles";let Ye=500,Je=50;let Qe,tt;function pe(){try{return te.caches}catch(C){}}function fe(){pe()&&!Qe&&(Qe=te.caches.open(Xe))}function me(C){const H=C.indexOf("?");if(H<0)return C;const te=function(C){const H=C.indexOf("?");return H>0?C.slice(H+1).split("&"):[]}(C),le=te.filter((C=>{const H=C.split("=");return"language"===H[0]||"worldview"===H[0]}));return le.length?`${C.slice(0,H)}?${le.join("&")}`:C.slice(0,H)}let rt=1/0;function ge(C){rt++,rt>Je&&(C.getActor().send("enforceCacheSizeLimit",Ye),rt=0)}const ot={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Image:"Image",Model:"Model"};"function"==typeof Object.freeze&&Object.freeze(ot);class xe extends Error{constructor(C,H,te){401===H&&Pe(te)&&(C+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(C),this.status=H,this.url=te}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const st=Q()?()=>self.worker&&self.worker.referrer:()=>("blob:"===te.location.protocol?te.parent:te).location.href;const be=function(C,H){if(!(/^file:/.test(le=C.url)||/^file:/.test(st())&&!/^\w+:/.test(le))){if(te.fetch&&te.Request&&te.AbortController&&te.Request.prototype.hasOwnProperty("signal"))return function(C,H){const le=new te.AbortController,ce=new te.Request(C.url,{method:C.method||"GET",body:C.body,credentials:C.credentials,headers:C.headers,referrer:st(),referrerPolicy:C.referrerPolicy,signal:le.signal});let he=!1,ue=!1;const de=(_e=ce.url).indexOf("sku=")>0&&Pe(_e);var _e;"json"===C.type&&ce.headers.set("Accept","application/json");const c=(le,he,_e)=>{if(ue)return;if(le&&"SecurityError"!==le.message&&W(le.toString()),he&&_e)return h(he);const ye=Date.now();te.fetch(ce).then((te=>{if(te.ok){const C=de?te.clone():null;return h(te,C,ye)}return H(new xe(te.statusText,te.status,C.url))})).catch((te=>{"AbortError"!==te.name&&H(new Error(`${te.message} ${C.url}`))}))},h=(le,de,_e)=>{("arrayBuffer"===C.type?le.arrayBuffer():"json"===C.type?le.json():le.text()).then((C=>{ue||(de&&_e&&function(C,H,le){if(fe(),!Qe)return;const ce={status:H.status,statusText:H.statusText,headers:new te.Headers};H.headers.forEach(((C,H)=>ce.headers.set(H,C)));const he=ee(H.headers.get("Cache-Control")||"");if(he["no-store"])return;he["max-age"]&&ce.headers.set("Expires",new Date(le+1e3*he["max-age"]).toUTCString());const ue=ce.headers.get("Expires");ue&&(new Date(ue).getTime()-le<42e4||function(C,H){if(void 0===tt)try{new Response(new ReadableStream),tt=!0}catch(C){tt=!1}tt?H(C.body):C.blob().then(H)}(H,(H=>{const le=new te.Response(H,ce);fe(),Qe&&Qe.then((H=>H.put(me(C.url),le))).catch((C=>W(C.message)))})))}(ce,de,_e),he=!0,H(null,C,le.headers.get("Cache-Control"),le.headers.get("Expires")))})).catch((C=>{ue||H(new Error(C.message))}))};return de?function(C,H){if(fe(),!Qe)return H(null);const te=me(C.url);Qe.then((C=>{C.match(te).then((le=>{const ce=function(C){if(!C)return!1;const H=new Date(C.headers.get("Expires")||0),te=ee(C.headers.get("Cache-Control")||"");return H>Date.now()&&!te["no-cache"]}(le);C.delete(te),ce&&C.put(te,le.clone()),H(null,le,ce)})).catch(H)})).catch(H)}(ce,c):c(null,null),{cancel:()=>{ue=!0,he||le.abort()}}}(C,H);if(Q()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",C,H,void 0,!0)}var le;return function(C,H){const le=new te.XMLHttpRequest;le.open(C.method||"GET",C.url,!0),"arrayBuffer"===C.type&&(le.responseType="arraybuffer");for(const H in C.headers)le.setRequestHeader(H,C.headers[H]);return"json"===C.type&&(le.responseType="text",le.setRequestHeader("Accept","application/json")),le.withCredentials="include"===C.credentials,le.onerror=()=>{H(new Error(le.statusText))},le.onload=()=>{if((le.status>=200&&le.status<300||0===le.status)&&null!==le.response){let te=le.response;if("json"===C.type)try{te=JSON.parse(le.response)}catch(C){return H(C)}H(null,te,le.getResponseHeader("Cache-Control"),le.getResponseHeader("Expires"))}else H(new xe(le.statusText,le.status,C.url))},le.send(C.body),{cancel:()=>le.abort()}}(C,H)},we=function(C,H){return be(k(C,{type:"json"}),H)},Te=function(C,H){return be(k(C,{type:"arrayBuffer"}),H)};function Ee(C){const H=te.document.createElement("a");return H.href=C,H.protocol===te.document.location.protocol&&H.host===te.document.location.host}const at="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let lt,ct;lt=[],ct=0;const Ie=function(C,le){if(de.supported&&(C.headers||(C.headers={}),C.headers.accept="image/webp,*/*"),ct>=ue.MAX_PARALLEL_IMAGE_REQUESTS){const te={requestParameters:C,callback:le,cancelled:!1,cancel(){(this||H).cancelled=!0}};return lt.push(te),te}ct++;let ce=!1;const s=()=>{if(!ce)for(ce=!0,ct--;lt.length&&ct<ue.MAX_PARALLEL_IMAGE_REQUESTS;){const C=lt.shift(),{requestParameters:H,callback:te,cancelled:le}=C;le||(C.cancel=Ie(H,te).cancel)}},he=Te(C,((C,H,ce,he)=>{s(),C?le(C):H&&(te.createImageBitmap?function(C,H){const le=new te.Blob([new Uint8Array(C)],{type:"image/png"});te.createImageBitmap(le).then((C=>{H(null,C)})).catch((C=>{H(new Error(`Could not load image because of ${C.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))}))}(H,((C,H)=>le(C,H,ce,he))):function(C,H){const le=new te.Image,ce=te.URL;le.onload=()=>{H(null,le),ce.revokeObjectURL(le.src),le.onload=null,te.requestAnimationFrame((()=>{le.src=at}))},le.onerror=()=>H(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const he=new te.Blob([new Uint8Array(C)],{type:"image/png"});le.src=C.byteLength?ce.createObjectURL(he):at}(H,((C,H)=>le(C,H,ce,he))))}));return{cancel:()=>{he.cancel(),s()}}},ht="NO_ACCESS_TOKEN";class ze{constructor(C,H,te){this._transformRequestFn=C,this._customAccessToken=H,this._silenceAuthErrors=!!te,this._createSkuToken()}_createSkuToken(){const C=function(){let C="";for(let H=0;H<10;H++)C+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",Se,C].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=C.token,this._skuTokenExpiresAt=C.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(C,H){return this._transformRequestFn&&this._transformRequestFn(C,H)||{url:C}}normalizeStyleURL(C,H){if(!De(C))return C;const te=Be(C);return te.params.push(`sdk=js-${ce}`),te.path=`/styles/v1${te.path}`,this._makeAPIURL(te,this._customAccessToken||H)}normalizeGlyphsURL(C,H){if(!De(C))return C;const te=Be(C);return te.path=`/fonts/v1${te.path}`,this._makeAPIURL(te,this._customAccessToken||H)}normalizeModelURL(C,H){if(!De(C))return C;const te=Be(C);return te.path=`/models/v1${te.path}`,this._makeAPIURL(te,this._customAccessToken||H)}normalizeSourceURL(C,H,te,le){if(!De(C))return C;const ce=Be(C);return ce.path=`/v4/${ce.authority}.json`,ce.params.push("secure"),te&&ce.params.push(`language=${te}`),le&&ce.params.push(`worldview=${le}`),this._makeAPIURL(ce,this._customAccessToken||H)}normalizeSpriteURL(C,H,te,le){const ce=Be(C);return De(C)?(ce.path=`/styles/v1${ce.path}/sprite${H}${te}`,this._makeAPIURL(ce,this._customAccessToken||le)):(ce.path+=`${H}${te}`,Fe(ce))}normalizeTileURL(C,H,te){if(this._isSkuTokenExpired()&&this._createSkuToken(),C&&!De(C))return C;const le=Be(C);le.path=le.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${H||te&&"raster"!==le.authority&&512===te?"@2x":""}${de.supported?".webp":"$1"}`),"raster"===le.authority?le.path=`/${ue.RASTER_URL_PREFIX}${le.path}`:(le.path=le.path.replace(/^.+\/v4\//,"/"),le.path=`/${ue.TILE_URL_VERSION}${le.path}`);const ce=this._customAccessToken||function(C){for(const H of C){const C=H.match(/^access_token=(.*)$/);if(C)return C[1]}return null}(le.params)||ue.ACCESS_TOKEN;return ue.REQUIRE_ACCESS_TOKEN&&ce&&this._skuToken&&le.params.push(`sku=${this._skuToken}`),this._makeAPIURL(le,ce)}canonicalizeTileURL(C,H){const te=Be(C);if(!te.path.match(/^(\/v4\/|\/raster\/v1\/)/)||!te.path.match(/\.[\w]+$/))return C;let le="mapbox://";te.path.match(/^\/raster\/v1\//)?le+=`raster/${te.path.replace(`/${ue.RASTER_URL_PREFIX}/`,"")}`:le+=`tiles/${te.path.replace(`/${ue.TILE_URL_VERSION}/`,"")}`;let ce=te.params;return H&&(ce=ce.filter((C=>!C.match(/^access_token=/)))),ce.length&&(le+=`?${ce.join("&")}`),le}canonicalizeTileset(C,H){const te=!!H&&De(H),le=[];for(const H of C.tiles||[])Pe(H)?le.push(this.canonicalizeTileURL(H,te)):le.push(H);return le}_makeAPIURL(C,H){const te="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",le=Be(ue.API_URL);if(C.protocol=le.protocol,C.authority=le.authority,"http"===C.protocol){const H=C.params.indexOf("secure");H>=0&&C.params.splice(H,1)}if("/"!==le.path&&(C.path=`${le.path}${C.path}`),!ue.REQUIRE_ACCESS_TOKEN)return Fe(C);if(H=H||ue.ACCESS_TOKEN,!this._silenceAuthErrors){if(!H)throw new Error(`An API access token is required to use Mapbox GL. ${te}`);if("s"===H[0])throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${te}`)}return C.params=C.params.filter((C=>-1===C.indexOf("access_token"))),C.params.push(`access_token=${H||""}`),Fe(C)}}function De(C){return 0===C.indexOf("mapbox:")}function Pe(C){return ue.API_URL_REGEX.test(C)}function Re(C){return ue.API_CDN_URL_REGEX.test(C)}function Le(C){return ue.API_STYLE_REGEX.test(C)&&!ke(C)}function ke(C){return ue.API_SPRITE_REGEX.test(C)}const pt=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function Be(C){const H=C.match(pt);if(!H)throw new Error("Unable to parse URL object");return{protocol:H[1],authority:H[2],path:H[3]||"/",params:H[4]?H[4].split("&"):[]}}function Fe(C){const H=C.params.length?`?${C.params.join("&")}`:"";return`${C.protocol}://${C.authority}${C.path}${H}`}const ft="mapbox.eventData";function Ue(C){if(!C)return null;const H=C.split(".");if(!H||3!==H.length)return null;try{return JSON.parse(decodeURIComponent(te.atob(H[1]).split("").map((C=>"%"+("00"+C.charCodeAt(0).toString(16)).slice(-2))).join("")))}catch(C){return null}}class Ve{constructor(C){this.type=C,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(C){const H=Ue(ue.ACCESS_TOKEN);let le="";return le=H&&H.u?te.btoa(encodeURIComponent(H.u).replace(/%([0-9A-F]{2})/g,((C,H)=>String.fromCharCode(Number("0x"+H))))):ue.ACCESS_TOKEN||"",C?`${ft}.${C}:${le}`:`${ft}:${le}`}fetchEventData(){const C=re("localStorage"),H=this.getStorageKey(),le=this.getStorageKey("uuid");if(C)try{const C=te.localStorage.getItem(H);C&&(this.eventData=JSON.parse(C));const ce=te.localStorage.getItem(le);ce&&(this.anonId=ce)}catch(C){W("Unable to read from LocalStorage")}}saveEventData(){const C=re("localStorage"),H=this.getStorageKey(),le=this.getStorageKey("uuid");if(C)try{te.localStorage.setItem(le,this.anonId),Object.keys(this.eventData).length>=1&&te.localStorage.setItem(H,JSON.stringify(this.eventData))}catch(C){W("Unable to write to LocalStorage")}}processRequests(C){}postEvent(C,H,te,le){if(!ue.EVENTS_URL)return;const ce=Be(ue.EVENTS_URL);ce.params.push(`access_token=${le||ue.ACCESS_TOKEN||""}`);const he={event:this.type,created:new Date(C).toISOString()},de=H?k(he,H):he,_e={url:Fe(ce),headers:{"Content-Type":"text/plain"},body:JSON.stringify([de])};this.pendingRequest=function(C,H){return be(k(C,{method:"POST"}),H)}(_e,(C=>{this.pendingRequest=null,te(C),this.saveEventData(),this.processRequests(le)}))}queueRequest(C,H){this.queue.push(C),this.processRequests(H)}}const mt=new class extends Ve{constructor(C){super("appUserTurnstile"),this._customAccessToken=C}postTurnstileEvent(C,H){ue.EVENTS_URL&&ue.ACCESS_TOKEN&&Array.isArray(C)&&C.some((C=>De(C)||Pe(C)))&&this.queueRequest(Date.now(),H)}processRequests(C){if(this.pendingRequest||0===this.queue.length)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const H=Ue(ue.ACCESS_TOKEN),te=H?H.u:ue.ACCESS_TOKEN;let le=te!==this.eventData.tokenU;V(this.anonId)||(this.anonId=N(),le=!0);const he=this.queue.shift();if(this.eventData.lastSuccess){const C=new Date(this.eventData.lastSuccess),H=new Date(he),te=(he-this.eventData.lastSuccess)/864e5;le=le||te>=1||te<-1||C.getDate()!==H.getDate()}else le=!0;le?this.postEvent(he,{sdkIdentifier:"mapbox-gl-js",sdkVersion:ce,skuId:Se,"enabled.telemetry":!1,userId:this.anonId},(C=>{C||(this.eventData.lastSuccess=he,this.eventData.tokenU=te)}),C):this.processRequests()}},Ct=mt.postTurnstileEvent.bind(mt),Ot=new class extends Ve{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(C,H,te,le){this.skuToken=H,this.errorCb=le,ue.EVENTS_URL&&(te||ue.ACCESS_TOKEN?this.queueRequest({id:C,timestamp:Date.now()},te):this.errorCb(new Error(ht)))}processRequests(C){if(this.pendingRequest||0===this.queue.length)return;const{id:H,timestamp:te}=this.queue.shift();H&&this.success[H]||(this.anonId||this.fetchEventData(),V(this.anonId)||(this.anonId=N()),this.postEvent(te,{sdkIdentifier:"mapbox-gl-js",sdkVersion:ce,skuId:Se,skuToken:this.skuToken,userId:this.anonId},(C=>{C?this.errorCb(C):H&&(this.success[H]=!0)}),C))}},Ft=Ot.postMapLoadEvent.bind(Ot),Nt=new class extends Ve{constructor(){super("gljs.performance")}postPerformanceEvent(C,H){ue.EVENTS_URL&&(C||ue.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:H},C)}processRequests(C){if(this.pendingRequest||0===this.queue.length)return;const{timestamp:H,performanceData:le}=this.queue.shift(),he=function(C){const H=te.performance.getEntriesByType("resource"),le=te.performance.getEntriesByType("mark"),he=function(C){const H={};if(C)for(const te in C)if("other"!==te)for(const le of C[te]){const C=`${te}ResolveRangeMin`,ce=`${te}ResolveRangeMax`,he=`${te}RequestCount`,ue=`${te}RequestCachedCount`;H[C]=Math.min(H[C]||1/0,le.startTime),H[ce]=Math.max(H[ce]||-1/0,le.responseEnd);const a=C=>{void 0===H[C]&&(H[C]=0),++H[C]};void 0!==le.transferSize&&0===le.transferSize&&a(ue),a(he)}return H}(function(C,H){const te={};if(C)for(const le of C){const C=H(le);void 0===te[C]&&(te[C]=[]),te[C].push(le)}return te}(H,et)),ue=te.devicePixelRatio,de=te.navigator.connection||te.navigator.mozConnection||te.navigator.webkitConnection,_e={counters:[],metadata:[],attributes:[]},c=(C,H,te)=>{null!=te&&C.push({name:H,value:te.toString()})};for(const C in he)c(_e.counters,C,he[C]);if(C.interactionRange[0]!==1/0&&C.interactionRange[1]!==-1/0&&(c(_e.counters,"interactionRangeMin",C.interactionRange[0]),c(_e.counters,"interactionRangeMax",C.interactionRange[1])),le)for(const C of Object.keys(Zt)){const H=Zt[C],te=le.find((C=>C.name===H));te&&c(_e.counters,H,te.startTime)}return c(_e.counters,"visibilityHidden",C.visibilityHidden),c(_e.attributes,"style",function(C){if(C)for(const H of C){const C=H.name.split("?")[0];if(Le(C)){const H=C.split("/").slice(-2);if(2===H.length)return`mapbox://styles/${H[0]}/${H[1]}`}}}(H)),c(_e.attributes,"terrainEnabled",C.terrainEnabled?"true":"false"),c(_e.attributes,"fogEnabled",C.fogEnabled?"true":"false"),c(_e.attributes,"projection",C.projection),c(_e.attributes,"zoom",C.zoom),c(_e.metadata,"devicePixelRatio",ue),c(_e.metadata,"connectionEffectiveType",de?de.effectiveType:void 0),c(_e.metadata,"navigatorUserAgent",te.navigator.userAgent),c(_e.metadata,"screenWidth",te.screen.width),c(_e.metadata,"screenHeight",te.screen.height),c(_e.metadata,"windowWidth",te.innerWidth),c(_e.metadata,"windowHeight",te.innerHeight),c(_e.metadata,"mapWidth",C.width/ue),c(_e.metadata,"mapHeight",C.height/ue),c(_e.metadata,"webglRenderer",C.renderer),c(_e.metadata,"webglVendor",C.vendor),c(_e.metadata,"sdkVersion",ce),c(_e.metadata,"sdkIdentifier","mapbox-gl-js"),_e}(le);for(const C of he.metadata);for(const C of he.counters);for(const C of he.attributes);this.postEvent(H,he,(()=>{}),C)}},Ut=Nt.postPerformanceEvent.bind(Nt),Vt=new class extends Ve{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(C,H,te,le){if(!ue.API_URL||!ue.SESSION_PATH)return;const ce=Be(ue.API_URL+ue.SESSION_PATH);ce.params.push(`sku=${H||""}`),ce.params.push(`access_token=${le||ue.ACCESS_TOKEN||""}`);const he={url:Fe(ce),headers:{"Content-Type":"text/plain"}};this.pendingRequest=function(C,H){return be(k(C,{method:"GET"}),H)}(he,(C=>{this.pendingRequest=null,te(C),this.saveEventData(),this.processRequests(le)}))}getSessionAPI(C,H,te,le){this.skuToken=H,this.errorCb=le,ue.SESSION_PATH&&ue.API_URL&&(te||ue.ACCESS_TOKEN?this.queueRequest({id:C,timestamp:Date.now()},te):this.errorCb(new Error(ht)))}processRequests(C){if(this.pendingRequest||0===this.queue.length)return;const{id:H,timestamp:te}=this.queue.shift();H&&this.success[H]||this.getSession(te,this.skuToken,(C=>{C?this.errorCb(C):H&&(this.success[H]=!0)}),C)}},jt=Vt.getSessionAPI.bind(Vt),Gt=new Set;function Ke(C,H){H?Gt.add(C):Gt.delete(C)}const Zt={create:"create",load:"load",fullLoad:"fullLoad"},qt={mark(C){te.performance.mark(C)},measure(C,H,le){te.performance.measure(C,H,le)}};function et(C){const H=C.name.split("?")[0];return Re(H)&&H.includes("mapbox-gl.js")?"javascript":Re(H)&&H.includes("mapbox-gl.css")?"css":function(C){return ue.API_FONTS_REGEX.test(C)}(H)?"fontRange":ke(H)?"sprite":Le(H)?"style":function(C){return ue.API_TILEJSON_REGEX.test(C)}(H)?"tilejson":"other"}const $t=te.performance;function it(C){const H=C?C.url.toString():void 0;return $t.getEntriesByName(H)}var Wt=nt;function nt(C){return!function(C){return"undefined"==typeof window||"undefined"==typeof document?"not a browser":Array.prototype&&Array.prototype.every&&Array.prototype.filter&&Array.prototype.forEach&&Array.prototype.indexOf&&Array.prototype.lastIndexOf&&Array.prototype.map&&Array.prototype.some&&Array.prototype.reduce&&Array.prototype.reduceRight&&Array.isArray?Function.prototype&&Function.prototype.bind?Object.keys&&Object.create&&Object.getPrototypeOf&&Object.getOwnPropertyNames&&Object.isSealed&&Object.isFrozen&&Object.isExtensible&&Object.getOwnPropertyDescriptor&&Object.defineProperty&&Object.defineProperties&&Object.seal&&Object.freeze&&Object.preventExtensions?"JSON"in window&&"parse"in JSON&&"stringify"in JSON?function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var C,H,te=new Blob([""],{type:"text/javascript"}),le=URL.createObjectURL(te);try{H=new Worker(le),C=!0}catch(H){C=!1}return H&&H.terminate(),URL.revokeObjectURL(le),C}()?"Uint8ClampedArray"in window?ArrayBuffer.isView?function(){var C=document.createElement("canvas");C.width=C.height=1;var H=C.getContext("2d");if(!H)return!1;var te=H.getImageData(0,0,1,1);return te&&te.width===C.width}()?(void 0===Ht[H=C&&C.failIfMajorPerformanceCaveat]&&(Ht[H]=function(C){var H,te=function(C){var H=document.createElement("canvas"),te=Object.create(nt.webGLContextAttributes);return te.failIfMajorPerformanceCaveat=C,H.getContext("webgl",te)||H.getContext("experimental-webgl",te)}(C);if(!te)return!1;try{H=te.createShader(te.VERTEX_SHADER)}catch(C){return!1}return!(!H||te.isContextLost())&&(te.shaderSource(H,"void main() {}"),te.compileShader(H),!0===te.getShaderParameter(H,te.COMPILE_STATUS))}(H)),Ht[H]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL support"):"insufficient Canvas/getImageData support":"insufficient ArrayBuffer support":"insufficient Uint8ClampedArray support":"insufficient worker support":"insufficient JSON support":"insufficient Object support":"insufficient Function support":"insufficent Array support";var H}(C)}var Ht={};let Kt,ti,ii,li;nt.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0};const yi={now:()=>void 0!==ii?ii:te.performance.now(),setNow(C){ii=C},restoreNow(){ii=void 0},frame(C){const H=te.requestAnimationFrame(C);return{cancel:()=>te.cancelAnimationFrame(H)}},getImageData(C,H=0){const{width:le,height:ce}=C;li||(li=te.document.createElement("canvas"));const he=li.getContext("2d",{willReadFrequently:!0});if(!he)throw new Error("failed to create canvas 2d context");return(le>li.width||ce>li.height)&&(li.width=le,li.height=ce),he.clearRect(-H,-H,le+2*H,ce+2*H),he.drawImage(C,0,0,le,ce),he.getImageData(-H,-H,le+2*H,ce+2*H)},resolveURL:C=>(Kt||(Kt=te.document.createElement("a")),Kt.href=C,Kt.href),get devicePixelRatio(){return te.devicePixelRatio},get prefersReducedMotion(){return!!te.matchMedia&&(null==ti&&(ti=te.matchMedia("(prefers-reduced-motion: reduce)")),ti.matches)}};function ut(C,H,le){const ce=te.document.createElement(C);return void 0!==H&&(ce.className=H),le&&le.appendChild(ce),ce}function dt(C,H,le){const ce=te.document.createElementNS("http://www.w3.org/2000/svg",C);for(const C of Object.keys(H))ce.setAttributeNS(null,C,H[C]);return le&&le.appendChild(ce),ce}const xi=te.document&&te.document.documentElement.style,vi=xi&&void 0!==xi.userSelect?"userSelect":"WebkitUserSelect";let wi;function _t(){xi&&vi&&(wi=xi[vi],xi[vi]="none")}function gt(){xi&&vi&&(xi[vi]=wi)}function yt(C){C.preventDefault(),C.stopPropagation(),te.removeEventListener("click",yt,!0)}function xt(){te.addEventListener("click",yt,!0),te.setTimeout((()=>{te.removeEventListener("click",yt,!0)}),0)}function vt(C,H){const te=C.getBoundingClientRect();return Tt(C,te,H)}function bt(C,H){const te=C.getBoundingClientRect(),le=[];for(let ce=0;ce<H.length;ce++)le.push(Tt(C,te,H[ce]));return le}function wt(C){return void 0!==te.InstallTrigger&&2===C.button&&C.ctrlKey&&te.navigator.platform.toUpperCase().indexOf("MAC")>=0?0:C.button}function Tt(C,H,te){const le=C.offsetWidth===H.width?1:C.offsetWidth/H.width;return new Ne((te.clientX-H.left)*le,(te.clientY-H.top)*le)}function Et(C,H,te){te[C]&&-1!==te[C].indexOf(H)||(te[C]=te[C]||[],te[C].push(H))}function Mt(C,H,te){if(te&&te[C]){const le=te[C].indexOf(H);-1!==le&&te[C].splice(le,1)}}class At{constructor(C,H={}){k(this,H),this.type=C}}class St extends At{constructor(C,H={}){super("error",k({error:C},H))}}class It{on(C,H){return this._listeners=this._listeners||{},Et(C,H,this._listeners),this}off(C,H){return Mt(C,H,this._listeners),Mt(C,H,this._oneTimeListeners),this}once(C,H){return H?(this._oneTimeListeners=this._oneTimeListeners||{},Et(C,H,this._oneTimeListeners),this):new Promise((H=>this.once(C,H)))}fire(C,H){"string"==typeof C&&(C=new At(C,H||{}));const te=C.type;if(this.listens(te)){C.target=this;const H=this._listeners&&this._listeners[te]?this._listeners[te].slice():[];for(const te of H)te.call(this,C);const le=this._oneTimeListeners&&this._oneTimeListeners[te]?this._oneTimeListeners[te].slice():[];for(const H of le)Mt(te,H,this._oneTimeListeners),H.call(this,C);const ce=this._eventedParent;ce&&(k(C,"function"==typeof this._eventedParentData?this._eventedParentData():this._eventedParentData),ce.fire(C))}else C instanceof St&&console.error(C.error);return this}listens(C){return!!(this._listeners&&this._listeners[C]&&this._listeners[C].length>0||this._oneTimeListeners&&this._oneTimeListeners[C]&&this._oneTimeListeners[C].length>0||this._eventedParent&&this._eventedParent.listens(C))}setEventedParent(C,H){return this._eventedParent=C,this._eventedParentData=H,this}}var Ai=JSON.parse('{"$version":8,"$root":{"version":{"required":true,"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"required":false,"type":"array","value":"light-3d"},"terrain":{"type":"terrain"},"fog":{"type":"fog"},"camera":{"type":"camera"},"imports":{"type":"array","value":"import"},"schema":{"type":"schema"},"sources":{"required":true,"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"required":true,"type":"array","value":"layer"},"models":{"type":"models"}},"model":{"type":"string","required":true},"import":{"id":{"type":"string","required":true},"url":{"type":"string","required":true},"config":{"type":"config"},"data":{"type":"$root"}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","required":true},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string","required":true},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false,"expression":{},"property-type":"data-constant"},"shadow-intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"required":true,"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"required":true,"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"required":true,"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"required":true,"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"}},"source_video":{"type":{"required":true,"type":"enum","values":{"video":1}},"urls":{"required":true,"type":"array","value":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"required":true,"type":"enum","values":{"image":1}},"url":{"required":false,"type":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_model":{"type":{"required":true,"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"}},"layer":{"id":{"type":"string","required":true},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"raster":{},"hillshade":{},"model":{},"background":{},"sky":{},"slot":{}},"required":true},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"fill-extrusion-edge-radius":{"type":"number","private":true,"default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"constant"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-size":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*","required":false}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"high-color":{"type":"color","property-type":"data-constant","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"space-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"horizon-blend":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective","property-type":"data-constant"}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator","required":true},"center":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string","required":true},"exaggeration":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-ambient-occlusion-intensity":{"property-type":"data-constant","type":"number","private":true,"default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"property-type":"data-constant","type":"number","private":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"property-type":"data-constant","type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"property-type":"data-constant","type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"property-type":"data-constant","type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"property-type":"data-constant","type":"color","default":"#ffffff","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"property-type":"data-constant","type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"property-type":"data-constant","type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"property-type":"data-constant","type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"property-type":"data-constant","type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-gradient":{"type":"color","expression":{"interpolated":true,"parameters":["line-progress"]},"property-type":"color-ramp"},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"property-type":"constant"},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-border-width":{"type":"number","private":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","private":true,"default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"expression":{"interpolated":true,"parameters":["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-image-cross-fade":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"transition":true},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-value"]},"property-type":"color-ramp"},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","default":[0,1],"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_background":{"background-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100,"property-type":"data-constant"},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]},"property-type":"color-ramp"},"sky-atmosphere-halo-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-atmosphere-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d","property-type":"data-constant"},"model-cast-shadows":{"type":"boolean","default":true,"expression":{},"property-type":"data-constant"},"model-receive-shadows":{"type":"boolean","default":true,"expression":{},"property-type":"data-constant"},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant","transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"property-type":{"data-driven":{"type":"property-type"},"color-ramp":{"type":"property-type"},"data-constant":{"type":"property-type"},"constant":{"type":"property-type"}},"promoteId":{"*":{"type":"string"}}}');class zt{constructor(C,H,te,le){this.message=(C?`${C}: `:"")+te,le&&(this.identifier=le),null!=H&&H.__line__&&(this.line=H.__line__)}}class Dt extends zt{}function Pt(C,...H){for(const te of H)for(const H in te)C[H]=te[H];return C}function Rt(C){return C instanceof Number||C instanceof String||C instanceof Boolean?C.valueOf():C}function Lt(C){if(Array.isArray(C))return C.map(Lt);if(C instanceof Object&&!(C instanceof Number||C instanceof String||C instanceof Boolean)){const H={};for(const te in C)H[te]=Lt(C[te]);return H}return Rt(C)}class kt extends Error{constructor(C,H){super(H),this.message=H,this.key=C}}var Ii=kt;class Bt{constructor(C,H=[]){this.parent=C,this.bindings={};for(const[C,te]of H)this.bindings[C]=te}concat(C){return new Bt(this,C)}get(C){if(this.bindings[C])return this.bindings[C];if(this.parent)return this.parent.get(C);throw new Error(`${C} not found in scope.`)}has(C){return!!this.bindings[C]||!!this.parent&&this.parent.has(C)}}var Ci=Bt;const zi={kind:"null"},Pi={kind:"number"},ki={kind:"string"},Li={kind:"boolean"},Gi={kind:"color"},tr={kind:"object"},ir={kind:"value"},rr={kind:"collator"},nr={kind:"formatted"},or={kind:"resolvedImage"};function Xt(C,H){return{kind:"array",itemType:C,N:H}}function Yt(C){if("array"===C.kind){const H=Yt(C.itemType);return"number"==typeof C.N?`array<${H}, ${C.N}>`:"value"===C.itemType.kind?"array":`array<${H}>`}return C.kind}const sr=[zi,Pi,ki,Li,Gi,nr,tr,Xt(ir),or];function Jt(C,H){if("error"===H.kind)return null;if("array"===C.kind){if("array"===H.kind&&(0===H.N&&"value"===H.itemType.kind||!Jt(C.itemType,H.itemType))&&("number"!=typeof C.N||C.N===H.N))return null}else{if(C.kind===H.kind)return null;if("value"===C.kind)for(const C of sr)if(!Jt(C,H))return null}return`Expected ${Yt(C)} but found ${Yt(H)} instead.`}function Qt(C,H){return H.some((H=>H.kind===C.kind))}function ei(C,H){return H.some((H=>"null"===H?null===C:"array"===H?Array.isArray(C):"object"===H?C&&!Array.isArray(C)&&"object"==typeof C:H===typeof C))}var lr,cr={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function ri(C){return(C=Math.round(C))<0?0:C>255?255:C}function ni(C){return ri("%"===C[C.length-1]?parseFloat(C)/100*255:parseInt(C))}function oi(C){return(H="%"===C[C.length-1]?parseFloat(C)/100:parseFloat(C))<0?0:H>1?1:H;var H}function si(C,H,te){return te<0?te+=1:te>1&&(te-=1),6*te<1?C+(H-C)*te*6:2*te<1?H:3*te<2?C+(H-C)*(2/3-te)*6:C}try{lr={}.parseCSSColor=function(C){var H,te=C.replace(/ /g,"").toLowerCase();if(te in cr)return cr[te].slice();if("#"===te[0])return 4===te.length?(H=parseInt(te.substr(1),16))>=0&&H<=4095?[(3840&H)>>4|(3840&H)>>8,240&H|(240&H)>>4,15&H|(15&H)<<4,1]:null:7===te.length&&(H=parseInt(te.substr(1),16))>=0&&H<=16777215?[(16711680&H)>>16,(65280&H)>>8,255&H,1]:null;var le=te.indexOf("("),ce=te.indexOf(")");if(-1!==le&&ce+1===te.length){var he=te.substr(0,le),ue=te.substr(le+1,ce-(le+1)).split(","),de=1;switch(he){case"rgba":if(4!==ue.length)return null;de=oi(ue.pop());case"rgb":return 3!==ue.length?null:[ni(ue[0]),ni(ue[1]),ni(ue[2]),de];case"hsla":if(4!==ue.length)return null;de=oi(ue.pop());case"hsl":if(3!==ue.length)return null;var _e=(parseFloat(ue[0])%360+360)%360/360,ye=oi(ue[1]),ve=oi(ue[2]),Me=ve<=.5?ve*(ye+1):ve+ye-ve*ye,Se=2*ve-Me;return[ri(255*si(Se,Me,_e+1/3)),ri(255*si(Se,Me,_e)),ri(255*si(Se,Me,_e-1/3)),de];default:return null}}return null}}catch(C){}class ai{constructor(C,H,te,le=1){this.r=C,this.g=H,this.b=te,this.a=le}static parse(C){if(!C)return;if(C instanceof ai)return C;if("string"!=typeof C)return;const H=lr(C);return H?new ai(H[0]/255*H[3],H[1]/255*H[3],H[2]/255*H[3],H[3]):void 0}toString(){const[C,H,te,le]=this.toArray();return`rgba(${Math.round(C)},${Math.round(H)},${Math.round(te)},${le})`}toArray(){const{r:C,g:H,b:te,a:le}=this;return 0===le?[0,0,0,0]:[255*C/le,255*H/le,255*te/le,le]}toArray01(){const{r:C,g:H,b:te,a:le}=this;return 0===le?[0,0,0,0]:[C/le,H/le,te/le,le]}toArray01Scaled(C){const{r:H,g:te,b:le,a:ce}=this;return 0===ce?[0,0,0]:[H/ce*C,te/ce*C,le/ce*C]}toArray01PremultipliedAlpha(){const{r:C,g:H,b:te,a:le}=this;return[C,H,te,le]}toArray01Linear(){const{r:C,g:H,b:te,a:le}=this;return 0===le?[0,0,0,0]:[Math.pow(C/le,2.2),Math.pow(H/le,2.2),Math.pow(te/le,2.2),le]}}ai.black=new ai(0,0,0,1),ai.white=new ai(1,1,1,1),ai.transparent=new ai(0,0,0,0),ai.red=new ai(1,0,0,1),ai.blue=new ai(0,0,1,1);var kr=ai;class ci{constructor(C,H,te){this.sensitivity=C?H?"variant":"case":H?"accent":"base",this.locale=te,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(C,H){return this.collator.compare(C,H)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class hi{constructor(C,H,te,le,ce){this.text=C.normalize?C.normalize():C,this.image=H,this.scale=te,this.fontStack=le,this.textColor=ce}}class ui{constructor(C){this.sections=C}static fromString(C){return new ui([new hi(C,null,null,null,null)])}isEmpty(){return 0===this.sections.length||!this.sections.some((C=>0!==C.text.length||C.image&&0!==C.image.namePrimary.length))}static factory(C){return C instanceof ui?C:ui.fromString(C)}toString(){return 0===this.sections.length?"":this.sections.map((C=>C.text)).join("")}serialize(){const C=["format"];for(const H of this.sections){if(H.image){C.push(["image",H.image.namePrimary]);continue}C.push(H.text);const te={};H.fontStack&&(te["text-font"]=["literal",H.fontStack.split(",")]),H.scale&&(te["font-scale"]=H.scale),H.textColor&&(te["text-color"]=["rgba"].concat(H.textColor.toArray())),C.push(te)}return C}}class di{constructor(C){this.namePrimary=C.namePrimary,C.nameSecondary&&(this.nameSecondary=C.nameSecondary),this.available=C.available}toString(){return this.nameSecondary?`[${this.namePrimary},${this.nameSecondary}]`:this.namePrimary}static fromString(C,H){return C?new di({namePrimary:C,nameSecondary:H,available:!1}):null}serialize(){return this.nameSecondary?["image",this.namePrimary,this.nameSecondary]:["image",this.namePrimary]}}function pi(C,H,te,le){return"number"==typeof C&&C>=0&&C<=255&&"number"==typeof H&&H>=0&&H<=255&&"number"==typeof te&&te>=0&&te<=255?void 0===le||"number"==typeof le&&le>=0&&le<=1?null:`Invalid rgba value [${[C,H,te,le].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${("number"==typeof le?[C,H,te,le]:[C,H,te]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function fi(C){if(null===C)return!0;if("string"==typeof C)return!0;if("boolean"==typeof C)return!0;if("number"==typeof C)return!0;if(C instanceof kr)return!0;if(C instanceof ci)return!0;if(C instanceof ui)return!0;if(C instanceof di)return!0;if(Array.isArray(C)){for(const H of C)if(!fi(H))return!1;return!0}if("object"==typeof C){for(const H in C)if(!fi(C[H]))return!1;return!0}return!1}function mi(C){if(null===C)return zi;if("string"==typeof C)return ki;if("boolean"==typeof C)return Li;if("number"==typeof C)return Pi;if(C instanceof kr)return Gi;if(C instanceof ci)return rr;if(C instanceof ui)return nr;if(C instanceof di)return or;if(Array.isArray(C)){const H=C.length;let te;for(const H of C){const C=mi(H);if(te){if(te===C)continue;te=ir;break}te=C}return Xt(te||ir,H)}return tr}function _i(C){const H=typeof C;return null===C?"":"string"===H||"number"===H||"boolean"===H?String(C):C instanceof kr||C instanceof ui||C instanceof di?C.toString():JSON.stringify(C)}class gi{constructor(C,H){this.type=C,this.value=H}static parse(C,H){if(2!==C.length)return H.error(`'literal' expression requires exactly one argument, but found ${C.length-1} instead.`);if(!fi(C[1]))return H.error("invalid value");const te=C[1];let le=mi(te);const ce=H.expectedType;return"array"!==le.kind||0!==le.N||!ce||"array"!==ce.kind||"number"==typeof ce.N&&0!==ce.N||(le=ce),new gi(le,te)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return"array"===this.type.kind||"object"===this.type.kind?["literal",this.value]:this.value instanceof kr?["rgba"].concat(this.value.toArray()):this.value instanceof ui?this.value.serialize():this.value}}var Vr=gi,Gr=class{constructor(C){this.name="ExpressionEvaluationError",this.message=C}toJSON(){return this.message}};const Hr={string:ki,number:Pi,boolean:Li,object:tr};class bi{constructor(C,H){this.type=C,this.args=H}static parse(C,H){if(C.length<2)return H.error("Expected at least one argument.");let te,le=1;const ce=C[0];if("array"===ce){let ce,he;if(C.length>2){const te=C[1];if("string"!=typeof te||!(te in Hr)||"object"===te)return H.error('The item type argument of "array" must be one of string, number, boolean',1);ce=Hr[te],le++}else ce=ir;if(C.length>3){if(null!==C[2]&&("number"!=typeof C[2]||C[2]<0||C[2]!==Math.floor(C[2])))return H.error('The length argument to "array" must be a positive integer literal',2);he=C[2],le++}te=Xt(ce,he)}else te=Hr[ce];const he=[];for(;le<C.length;le++){const te=H.parse(C[le],le,ir);if(!te)return null;he.push(te)}return new bi(te,he)}evaluate(C){for(let H=0;H<this.args.length;H++){const te=this.args[H].evaluate(C);if(!Jt(this.type,mi(te)))return te;if(H===this.args.length-1)throw new Gr(`Expected value to be of type ${Yt(this.type)}, but found ${Yt(mi(te))} instead.`)}return null}eachChild(C){this.args.forEach(C)}outputDefined(){return this.args.every((C=>C.outputDefined()))}serialize(){const C=this.type,H=[C.kind];if("array"===C.kind){const te=C.itemType;if("string"===te.kind||"number"===te.kind||"boolean"===te.kind){H.push(te.kind);const le=C.N;("number"==typeof le||this.args.length>1)&&H.push(le)}}return H.concat(this.args.map((C=>C.serialize())))}}var Yr=bi;class Ti{constructor(C){this.type=nr,this.sections=C}static parse(C,H){if(C.length<2)return H.error("Expected at least one argument.");const te=C[1];if(!Array.isArray(te)&&"object"==typeof te)return H.error("First argument must be an image or text section.");const le=[];let ce=!1;for(let te=1;te<=C.length-1;++te){const he=C[te];if(ce&&"object"==typeof he&&!Array.isArray(he)){ce=!1;let C=null;if(he["font-scale"]&&(C=H.parse(he["font-scale"],1,Pi),!C))return null;let te=null;if(he["text-font"]&&(te=H.parse(he["text-font"],1,Xt(ki)),!te))return null;let ue=null;if(he["text-color"]&&(ue=H.parse(he["text-color"],1,Gi),!ue))return null;const de=le[le.length-1];de.scale=C,de.font=te,de.textColor=ue}else{const he=H.parse(C[te],1,ir);if(!he)return null;const ue=he.type.kind;if("string"!==ue&&"value"!==ue&&"null"!==ue&&"resolvedImage"!==ue)return H.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");ce=!0,le.push({content:he,scale:null,font:null,textColor:null})}}return new Ti(le)}evaluate(C){return new ui(this.sections.map((H=>{const te=H.content.evaluate(C);return mi(te)===or?new hi("",te,null,null,null):new hi(_i(te),null,H.scale?H.scale.evaluate(C):null,H.font?H.font.evaluate(C).join(","):null,H.textColor?H.textColor.evaluate(C):null)})))}eachChild(C){for(const H of this.sections)C(H.content),H.scale&&C(H.scale),H.font&&C(H.font),H.textColor&&C(H.textColor)}outputDefined(){return!1}serialize(){const C=["format"];for(const H of this.sections){C.push(H.content.serialize());const te={};H.scale&&(te["font-scale"]=H.scale.serialize()),H.font&&(te["text-font"]=H.font.serialize()),H.textColor&&(te["text-color"]=H.textColor.serialize()),C.push(te)}return C}}class Ei{constructor(C,H){this.type=or,this.inputPrimary=C,this.inputSecondary=H}static parse(C,H){if(C.length<2)return H.error("Expected two or more arguments.");const te=H.parse(C[1],1,ki);if(!te)return H.error("No image name provided.");if(2===C.length)return new Ei(te);const le=H.parse(C[2],1,ki);return le?new Ei(te,le):H.error("Secondary image variant is not a string.")}evaluate(C){const H=di.fromString(this.inputPrimary.evaluate(C),this.inputSecondary?this.inputSecondary.evaluate(C):void 0);return H&&C.availableImages&&(H.available=C.availableImages.indexOf(H.namePrimary)>-1,H.nameSecondary&&H.available&&C.availableImages&&(H.available=C.availableImages.indexOf(H.nameSecondary)>-1)),H}eachChild(C){C(this.inputPrimary),this.inputSecondary&&C(this.inputSecondary)}outputDefined(){return!1}serialize(){return this.inputSecondary?["image",this.inputPrimary.serialize(),this.inputSecondary.serialize()]:["image",this.inputPrimary.serialize()]}}function Mi(C){return C instanceof Number?"number":C instanceof String?"string":C instanceof Boolean?"boolean":Array.isArray(C)?"array":null===C?"null":typeof C}const Kr={"to-boolean":Li,"to-color":Gi,"to-number":Pi,"to-string":ki};class Si{constructor(C,H){this.type=C,this.args=H}static parse(C,H){if(C.length<2)return H.error("Expected at least one argument.");const te=C[0],le=[];let ce=zi;if("to-array"===te){if(!Array.isArray(C[1]))return null;const te=C[1].length;if(H.expectedType){if("array"!==H.expectedType.kind)return H.error(`Expected ${H.expectedType.kind} but found array.`);ce=Xt(H.expectedType.itemType,te)}else{if(!(te>0&&fi(C[1][0])))return null;ce=Xt(mi(C[1][0]),te)}for(let he=0;he<te;he++){const te=C[1][he];let ue;if("array"===Mi(te))ue=H.parse(te,void 0,ce.itemType);else{const C=Mi(te);if(C!==ce.itemType.kind)return H.error(`Expected ${ce.itemType.kind} but found ${C}.`);ue=H.registry.literal.parse(["literal",void 0===te?null:te],H)}if(!ue)return null;le.push(ue)}}else{if(("to-boolean"===te||"to-string"===te)&&2!==C.length)return H.error("Expected one argument.");ce=Kr[te];for(let te=1;te<C.length;te++){const ce=H.parse(C[te],te,ir);if(!ce)return null;le.push(ce)}}return new Si(ce,le)}evaluate(C){if("boolean"===this.type.kind)return Boolean(this.args[0].evaluate(C));if("color"===this.type.kind){let H,te;for(const le of this.args){if(H=le.evaluate(C),te=null,H instanceof kr)return H;if("string"==typeof H){const te=C.parseColor(H);if(te)return te}else if(Array.isArray(H)&&(te=H.length<3||H.length>4?`Invalid rbga value ${JSON.stringify(H)}: expected an array containing either three or four numeric values.`:pi(H[0],H[1],H[2],H[3]),!te))return new kr(H[0]/255,H[1]/255,H[2]/255,H[3])}throw new Gr(te||`Could not parse color from value '${"string"==typeof H?H:String(JSON.stringify(H))}'`)}if("number"===this.type.kind){let H=null;for(const te of this.args){if(H=te.evaluate(C),null===H)return 0;const le=Number(H);if(!isNaN(le))return le}throw new Gr(`Could not convert ${JSON.stringify(H)} to number.`)}return"formatted"===this.type.kind?ui.fromString(_i(this.args[0].evaluate(C))):"resolvedImage"===this.type.kind?di.fromString(_i(this.args[0].evaluate(C))):"array"===this.type.kind?this.args.map((H=>H.evaluate(C))):_i(this.args[0].evaluate(C))}eachChild(C){this.args.forEach(C)}outputDefined(){return this.args.every((C=>C.outputDefined()))}serialize(){if("formatted"===this.type.kind)return new Ti([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if("resolvedImage"===this.type.kind)return new Ei(this.args[0]).serialize();const C="array"===this.type.kind?[]:[`to-${this.type.kind}`];return this.eachChild((H=>{C.push(H.serialize())})),C}}var Jr=Si;const Qr=["Unknown","Point","LineString","Polygon"];var en=class{constructor(C){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.options=C}id(){return this.feature&&void 0!==this.feature.id?this.feature.id:null}geometryType(){return this.feature?"number"==typeof this.feature.type?Qr[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(C){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const C=this.featureDistanceData.center,H=this.featureDistanceData.scale,{x:te,y:le}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(te*H-C[0])+this.featureDistanceData.bearing[1]*(le*H-C[1])}return 0}parseColor(C){let H=this._parseColorCache[C];return H||(H=this._parseColorCache[C]=kr.parse(C)),H}getConfig(C){return this.options?this.options.get(C):null}};class Di{constructor(C,H,te,le){this.name=C,this.type=H,this._evaluate=te,this.args=le}evaluate(C){return this._evaluate(C,this.args)}eachChild(C){this.args.forEach(C)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map((C=>C.serialize())))}static parse(C,H){const te=C[0],le=Di.definitions[te];if(!le)return H.error(`Unknown expression "${te}". If you wanted a literal array, use ["literal", [...]].`,0);const ce=Array.isArray(le)?le[0]:le.type,he=Array.isArray(le)?[[le[1],le[2]]]:le.overloads,ue=he.filter((([H])=>!Array.isArray(H)||H.length===C.length-1));let de=null;for(const[le,he]of ue){de=new Pn(H.registry,H.path,null,H.scope,void 0,H.options);const ue=[];let _e=!1;for(let H=1;H<C.length;H++){const te=C[H],ce=Array.isArray(le)?le[H-1]:le.type,he=de.parse(te,1+ue.length,ce);if(!he){_e=!0;break}ue.push(he)}if(!_e)if(Array.isArray(le)&&le.length!==ue.length)de.error(`Expected ${le.length} arguments, but found ${ue.length} instead.`);else{for(let C=0;C<ue.length;C++){const H=Array.isArray(le)?le[C]:le.type,te=ue[C];de.concat(C+1).checkSubtype(H,te.type)}if(0===de.errors.length)return new Di(te,ce,he,ue)}}if(1===ue.length)H.errors.push(...de.errors);else{const te=(ue.length?ue:he).map((([C])=>{return H=C,Array.isArray(H)?`(${H.map(Yt).join(", ")})`:`(${Yt(H.type)}...)`;var H})).join(" | "),le=[];for(let te=1;te<C.length;te++){const ce=H.parse(C[te],1+le.length);if(!ce)return null;le.push(Yt(ce.type))}H.error(`Expected arguments of type ${te}, but found (${le.join(", ")}) instead.`)}return null}static register(C,H){Di.definitions=H;for(const te in H)C[te]=Di}}var tn=Di;class Ri{constructor(C,H,te){this.type=rr,this.locale=te,this.caseSensitive=C,this.diacriticSensitive=H}static parse(C,H){if(2!==C.length)return H.error("Expected one argument.");const te=C[1];if("object"!=typeof te||Array.isArray(te))return H.error("Collator options argument must be an object.");const le=H.parse(void 0!==te["case-sensitive"]&&te["case-sensitive"],1,Li);if(!le)return null;const ce=H.parse(void 0!==te["diacritic-sensitive"]&&te["diacritic-sensitive"],1,Li);if(!ce)return null;let he=null;return te.locale&&(he=H.parse(te.locale,1,ki),!he)?null:new Ri(le,ce,he)}evaluate(C){return new ci(this.caseSensitive.evaluate(C),this.diacriticSensitive.evaluate(C),this.locale?this.locale.evaluate(C):null)}eachChild(C){C(this.caseSensitive),C(this.diacriticSensitive),this.locale&&C(this.locale)}outputDefined(){return!1}serialize(){const C={};return C["case-sensitive"]=this.caseSensitive.serialize(),C["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(C.locale=this.locale.serialize()),["collator",C]}}var rn={exports:{}};rn.exports=function(){function e(C,H,te,le,ce){for(;le>te;){if(le-te>600){var he=le-te+1,ue=H-te+1,de=Math.log(he),_e=.5*Math.exp(2*de/3),ye=.5*Math.sqrt(de*_e*(he-_e)/he)*(ue-he/2<0?-1:1);e(C,H,Math.max(te,Math.floor(H-ue*_e/he+ye)),Math.min(le,Math.floor(H+(he-ue)*_e/he+ye)),ce)}var ve=C[H],Me=te,Se=le;for(t(C,te,H),ce(C[le],ve)>0&&t(C,te,le);Me<Se;){for(t(C,Me,Se),Me++,Se--;ce(C[Me],ve)<0;)Me++;for(;ce(C[Se],ve)>0;)Se--}0===ce(C[te],ve)?t(C,te,Se):t(C,++Se,le),Se<=H&&(te=Se+1),H<=Se&&(le=Se-1)}}function t(C,H,te){var le=C[H];C[H]=C[te],C[te]=le}function i(C,H){return C<H?-1:C>H?1:0}return function(C,H,te,le,ce){e(C,H,te||0,le||C.length-1,ce||i)}}();var nn=d(rn.exports);function Oi(C){let H=0;for(let te,le,ce=0,he=C.length,ue=he-1;ce<he;ue=ce++)te=C[ce],le=C[ue],H+=(le.x-te.x)*(te.y+le.y);return H}function Bi(C,H){C[0]=Math.min(C[0],H[0]),C[1]=Math.min(C[1],H[1]),C[2]=Math.max(C[2],H[0]),C[3]=Math.max(C[3],H[1])}function Fi(C,H){return!(C[0]<=H[0]||C[2]>=H[2]||C[1]<=H[1]||C[3]>=H[3])}function Ni(C,H,te){const le=C[0]-H[0],ce=C[1]-H[1],he=C[0]-te[0],ue=C[1]-te[1];return le*ue-he*ce==0&&le*he<=0&&ce*ue<=0}function Ui(C,H,te=!1){let le=!1;for(let de=0,_e=H.length;de<_e;de++){const _e=H[de];for(let H=0,de=_e.length,ye=de-1;H<de;ye=H++){const de=_e[ye],ve=_e[H];if(Ni(C,de,ve))return te;(he=de)[1]>(ce=C)[1]!=(ue=ve)[1]>ce[1]&&ce[0]<(ue[0]-he[0])*(ce[1]-he[1])/(ue[1]-he[1])+he[0]&&(le=!le)}}var ce,he,ue;return le}function Vi(C,H,te,le){const ce=le[0]-te[0],he=le[1]-te[1],ue=(C[0]-te[0])*he-ce*(C[1]-te[1]),de=(H[0]-te[0])*he-ce*(H[1]-te[1]);return ue>0&&de<0||ue<0&&de>0}function ji(C,H,te,le){return 0!=(ce=[le[0]-te[0],le[1]-te[1]])[0]*(he=[H[0]-C[0],H[1]-C[1]])[1]-ce[1]*he[0]&&!(!Vi(C,H,te,le)||!Vi(te,le,C,H));var ce,he}const on=8192;function qi(C,H){const te=(180+C[0])/360,le=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+C[1]*Math.PI/360)))/360,ce=Math.pow(2,H.z);return[Math.round(te*ce*on),Math.round(le*ce*on)]}function Zi(C,H){for(let te=0;te<H.length;te++)if(Ui(C,H[te]))return!0;return!1}function $i(C,H,te){for(const le of te)for(let te=0,ce=le.length,he=ce-1;te<ce;he=te++)if(ji(C,H,le[he],le[te]))return!0;return!1}function Hi(C,H){for(let te=0;te<C.length;++te)if(!Ui(C[te],H))return!1;for(let te=0;te<C.length-1;++te)if($i(C[te],C[te+1],H))return!1;return!0}function Wi(C,H){for(let te=0;te<H.length;te++)if(Hi(C,H[te]))return!0;return!1}function Xi(C,H,te){const le=[];for(let ce=0;ce<C.length;ce++){const he=[];for(let le=0;le<C[ce].length;le++){const ue=qi(C[ce][le],te);Bi(H,ue),he.push(ue)}le.push(he)}return le}function Yi(C,H,te){const le=[];for(let ce=0;ce<C.length;ce++){const he=Xi(C[ce],H,te);le.push(he)}return le}function Ki(C,H,te,le){if(C[0]<te[0]||C[0]>te[2]){const H=.5*le;let ce=C[0]-te[0]>H?-le:te[0]-C[0]>H?le:0;0===ce&&(ce=C[0]-te[2]>H?-le:te[2]-C[0]>H?le:0),C[0]+=ce}Bi(H,C)}function Ji(C,H,te,le){const ce=Math.pow(2,le.z)*on,he=[le.x*on,le.y*on],ue=[];if(!C)return ue;for(const le of C)for(const C of le){const le=[C.x+he[0],C.y+he[1]];Ki(le,H,te,ce),ue.push(le)}return ue}function Qi(C,H,te,le){const ce=Math.pow(2,le.z)*on,he=[le.x*on,le.y*on],ue=[];if(!C)return ue;for(const te of C){const C=[];for(const le of te){const te=[le.x+he[0],le.y+he[1]];Bi(H,te),C.push(te)}ue.push(C)}if(H[2]-H[0]<=ce/2){(de=H)[0]=de[1]=1/0,de[2]=de[3]=-1/0;for(const C of ue)for(const le of C)Ki(le,H,te,ce)}var de;return ue}class er{constructor(C,H){this.type=Li,this.geojson=C,this.geometries=H}static parse(C,H){if(2!==C.length)return H.error(`'within' expression requires exactly one argument, but found ${C.length-1} instead.`);if(fi(C[1])){const H=C[1];if("FeatureCollection"===H.type)for(let C=0;C<H.features.length;++C){const te=H.features[C].geometry.type;if("Polygon"===te||"MultiPolygon"===te)return new er(H,H.features[C].geometry)}else if("Feature"===H.type){const C=H.geometry.type;if("Polygon"===C||"MultiPolygon"===C)return new er(H,H.geometry)}else if("Polygon"===H.type||"MultiPolygon"===H.type)return new er(H,H)}return H.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(C){if(null!=C.geometry()&&null!=C.canonicalID()){if("Point"===C.geometryType())return function(C,H){const te=[1/0,1/0,-1/0,-1/0],le=[1/0,1/0,-1/0,-1/0],ce=C.canonicalID();if(!ce)return!1;if("Polygon"===H.type){const he=Xi(H.coordinates,le,ce),ue=Ji(C.geometry(),te,le,ce);if(!Fi(te,le))return!1;for(const C of ue)if(!Ui(C,he))return!1}if("MultiPolygon"===H.type){const he=Yi(H.coordinates,le,ce),ue=Ji(C.geometry(),te,le,ce);if(!Fi(te,le))return!1;for(const C of ue)if(!Zi(C,he))return!1}return!0}(C,this.geometries);if("LineString"===C.geometryType())return function(C,H){const te=[1/0,1/0,-1/0,-1/0],le=[1/0,1/0,-1/0,-1/0],ce=C.canonicalID();if(!ce)return!1;if("Polygon"===H.type){const he=Xi(H.coordinates,le,ce),ue=Qi(C.geometry(),te,le,ce);if(!Fi(te,le))return!1;for(const C of ue)if(!Hi(C,he))return!1}if("MultiPolygon"===H.type){const he=Yi(H.coordinates,le,ce),ue=Qi(C.geometry(),te,le,ce);if(!Fi(te,le))return!1;for(const C of ue)if(!Wi(C,he))return!1}return!0}(C,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}var pn=er,fn={exports:{}};fn.exports=function(){var C={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},te=1/298.257223563,le=te*(2-te),ce=Math.PI/180,n=function(te,he){if(void 0===te)throw new Error("No latitude given.");if(he&&!C[he])throw new Error("Unknown unit "+he+". Use one of: "+Object.keys(C).join(", "));var ue=6378.137*ce*(he?C[he]:1),de=Math.cos(te*ce),_e=1/(1-le*(1-de*de)),ye=Math.sqrt(_e);(this||H).kx=ue*ye*de,(this||H).ky=ue*ye*_e*(1-le)},he={units:{configurable:!0}};function s(C,H){return C[0]===H[0]&&C[1]===H[1]}function a(C,H,te){var le=l(H[0]-C[0]);return[C[0]+le*te,C[1]+(H[1]-C[1])*te]}function l(C){for(;C<-180;)C+=360;for(;C>180;)C-=360;return C}return n.fromTile=function(C,H,te){var le=Math.PI*(1-2*(C+.5)/Math.pow(2,H)),he=Math.atan(.5*(Math.exp(le)-Math.exp(-le)))/ce;return new n(he,te)},he.units.get=function(){return C},n.prototype.distance=function(C,te){var le=l(C[0]-te[0])*(this||H).kx,ce=(C[1]-te[1])*(this||H).ky;return Math.sqrt(le*le+ce*ce)},n.prototype.bearing=function(C,te){var le=l(te[0]-C[0])*(this||H).kx;return Math.atan2(le,(te[1]-C[1])*(this||H).ky)/ce},n.prototype.destination=function(C,H,te){var le=te*ce;return this.offset(C,Math.sin(le)*H,Math.cos(le)*H)},n.prototype.offset=function(C,te,le){return[C[0]+te/(this||H).kx,C[1]+le/(this||H).ky]},n.prototype.lineDistance=function(C){for(var H=0,te=0;te<C.length-1;te++)H+=this.distance(C[te],C[te+1]);return H},n.prototype.area=function(C){for(var te=0,le=0;le<C.length;le++)for(var ce=C[le],he=0,ue=ce.length,de=ue-1;he<ue;de=he++)te+=l(ce[he][0]-ce[de][0])*(ce[he][1]+ce[de][1])*(le?-1:1);return Math.abs(te)/2*(this||H).kx*(this||H).ky},n.prototype.along=function(C,H){var te=0;if(H<=0)return C[0];for(var le=0;le<C.length-1;le++){var ce=C[le],he=C[le+1],ue=this.distance(ce,he);if((te+=ue)>H)return a(ce,he,(H-(te-ue))/ue)}return C[C.length-1]},n.prototype.pointToSegmentDistance=function(C,te,le){var ce=te[0],he=te[1],ue=l(le[0]-ce)*(this||H).kx,de=(le[1]-he)*(this||H).ky,_e=0;return 0===ue&&0===de||((_e=(l(C[0]-ce)*(this||H).kx*ue+(C[1]-he)*(this||H).ky*de)/(ue*ue+de*de))>1?(ce=le[0],he=le[1]):_e>0&&(ce+=ue/(this||H).kx*_e,he+=de/(this||H).ky*_e)),ue=l(C[0]-ce)*(this||H).kx,de=(C[1]-he)*(this||H).ky,Math.sqrt(ue*ue+de*de)},n.prototype.pointOnLine=function(C,te){for(var le,ce,he,ue,de=1/0,_e=0;_e<C.length-1;_e++){var ye=C[_e][0],ve=C[_e][1],Me=l(C[_e+1][0]-ye)*(this||H).kx,Se=(C[_e+1][1]-ve)*(this||H).ky,Ae=0;0===Me&&0===Se||((Ae=(l(te[0]-ye)*(this||H).kx*Me+(te[1]-ve)*(this||H).ky*Se)/(Me*Me+Se*Se))>1?(ye=C[_e+1][0],ve=C[_e+1][1]):Ae>0&&(ye+=Me/(this||H).kx*Ae,ve+=Se/(this||H).ky*Ae));var Ce=(Me=l(te[0]-ye)*(this||H).kx)*Me+(Se=(te[1]-ve)*(this||H).ky)*Se;Ce<de&&(de=Ce,le=ye,ce=ve,he=_e,ue=Ae)}return{point:[le,ce],index:he,t:Math.max(0,Math.min(1,ue))}},n.prototype.lineSlice=function(C,H,te){var le=this.pointOnLine(te,C),ce=this.pointOnLine(te,H);if(le.index>ce.index||le.index===ce.index&&le.t>ce.t){var he=le;le=ce,ce=he}var ue=[le.point],de=le.index+1,_e=ce.index;!s(te[de],ue[0])&&de<=_e&&ue.push(te[de]);for(var ye=de+1;ye<=_e;ye++)ue.push(te[ye]);return s(te[_e],ce.point)||ue.push(ce.point),ue},n.prototype.lineSliceAlong=function(C,H,te){for(var le=0,ce=[],he=0;he<te.length-1;he++){var ue=te[he],de=te[he+1],_e=this.distance(ue,de);if((le+=_e)>C&&0===ce.length&&ce.push(a(ue,de,(C-(le-_e))/_e)),le>=H)return ce.push(a(ue,de,(H-(le-_e))/_e)),ce;le>C&&ce.push(de)}return ce},n.prototype.bufferPoint=function(C,te){var le=te/(this||H).ky,ce=te/(this||H).kx;return[C[0]-ce,C[1]-le,C[0]+ce,C[1]+le]},n.prototype.bufferBBox=function(C,te){var le=te/(this||H).ky,ce=te/(this||H).kx;return[C[0]-ce,C[1]-le,C[2]+ce,C[3]+le]},n.prototype.insideBBox=function(C,H){return l(C[0]-H[0])>=0&&l(C[0]-H[2])<=0&&C[1]>=H[1]&&C[1]<=H[3]},Object.defineProperties(n,he),n}();var mn=d(fn.exports),yn={exports:{}};yn.exports=function(){var e=function(C,te){if(void 0===C&&(C=[]),void 0===te&&(te=t),(this||H).data=C,(this||H).length=(this||H).data.length,(this||H).compare=te,(this||H).length>0)for(var le=((this||H).length>>1)-1;le>=0;le--)this._down(le)};function t(C,H){return C<H?-1:C>H?1:0}return e.prototype.push=function(C){(this||H).data.push(C),(this||H).length++,this._up((this||H).length-1)},e.prototype.pop=function(){if(0!==(this||H).length){var C=(this||H).data[0],te=(this||H).data.pop();return(this||H).length--,(this||H).length>0&&((this||H).data[0]=te,this._down(0)),C}},e.prototype.peek=function(){return(this||H).data[0]},e.prototype._up=function(C){for(var te=(this||H).data,le=(this||H).compare,ce=te[C];C>0;){var he=C-1>>1,ue=te[he];if(le(ce,ue)>=0)break;te[C]=ue,C=he}te[C]=ce},e.prototype._down=function(C){for(var te=(this||H).data,le=(this||H).compare,ce=(this||H).length>>1,he=te[C];C<ce;){var ue=1+(C<<1),de=te[ue],_e=ue+1;if(_e<(this||H).length&&le(te[_e],de)<0&&(ue=_e,de=te[_e]),le(de,he)>=0)break;te[C]=de,C=ue}te[C]=he},e}();var vn=d(yn.exports),wn=8192;function ar(C,H){return H.dist-C.dist}const En=100,An=50;function hr(C){const H=[1/0,1/0,-1/0,-1/0];if(H.length!==C.length)return!1;for(let te=0;te<H.length;te++)if(H[te]!==C[te])return!1;return!0}function ur(C){return C[1]-C[0]+1}function dr(C,H){const te=C[1]>=C[0]&&C[1]<H;return te||console.warn("Distance Expression: Index is out of range"),te}function pr(C,H){if(C[0]>C[1])return[null,null];const te=ur(C);if(H){if(2===te)return[C,null];const H=Math.floor(te/2);return[[C[0],C[0]+H],[C[0]+H,C[1]]]}{if(1===te)return[C,null];const H=Math.floor(te/2)-1;return[[C[0],C[0]+H],[C[0]+H+1,C[1]]]}}function fr(C,H){const te=[1/0,1/0,-1/0,-1/0];if(!dr(H,C.length))return te;for(let le=H[0];le<=H[1];++le)Bi(te,C[le]);return te}function mr(C){const H=[1/0,1/0,-1/0,-1/0];for(let te=0;te<C.length;++te)for(let le=0;le<C[te].length;++le)Bi(H,C[te][le]);return H}function _r(C,H,te){if(hr(C)||hr(H))return NaN;let le=0,ce=0;return C[2]<H[0]&&(le=H[0]-C[2]),C[0]>H[2]&&(le=C[0]-H[2]),C[1]>H[3]&&(ce=C[1]-H[3]),C[3]<H[1]&&(ce=H[1]-C[3]),te.distance([0,0],[le,ce])}function gr(C,H){const te=Math.pow(2,H.z);return[(ce=(C.x/wn+H.x)/te,360*ce-180),(le=(C.y/wn+H.y)/te,360/Math.PI*Math.atan(Math.exp((180-360*le)*Math.PI/180))-90)];var le,ce}function yr(C,H){const te=[];for(let le=0;le<C.length;++le)te.push(gr(C[le],H));return te}function xr(C,H,te){const le=te.pointOnLine(H,C).point;return te.distance(C,le)}function vr(C,H,te,le,ce){const he=te.slice(le[0],le[1]+1);let ue=1/0;for(let te=H[0];te<=H[1];++te)if(0===(ue=Math.min(ue,xr(C[te],he,ce))))return 0;return ue}function br(C,H,te,le,ce){const he=Math.min(ce.pointToSegmentDistance(C,te,le),ce.pointToSegmentDistance(H,te,le)),ue=Math.min(ce.pointToSegmentDistance(te,C,H),ce.pointToSegmentDistance(le,C,H));return Math.min(he,ue)}function wr(C,H,te,le,ce){if(!dr(H,C.length)||!dr(le,te.length))return NaN;let he=1/0;for(let ue=H[0];ue<H[1];++ue)for(let H=le[0];H<le[1];++H){if(ji(C[ue],C[ue+1],te[H],te[H+1]))return 0;he=Math.min(he,br(C[ue],C[ue+1],te[H],te[H+1],ce))}return he}function Tr(C,H,te,le,ce){if(!dr(H,C.length)||!dr(le,te.length))return NaN;let he=1/0;for(let ue=H[0];ue<=H[1];++ue)for(let H=le[0];H<=le[1];++H)if(0===(he=Math.min(he,ce.distance(C[ue],te[H]))))return he;return he}function Er(C,H,te){if(Ui(C,H,!0))return 0;let le=1/0;for(const ce of H){const H=ce.length;if(H<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(ce[0]!==ce[H-1]&&0===(le=Math.min(le,te.pointToSegmentDistance(C,ce[H-1],ce[0]))))return le;if(0===(le=Math.min(le,xr(C,ce,te))))return le}return le}function Mr(C,H,te,le){if(!dr(H,C.length))return NaN;for(let le=H[0];le<=H[1];++le)if(Ui(C[le],te,!0))return 0;let ce=1/0;for(let he=H[0];he<H[1];++he)for(const H of te)for(let te=0,ue=H.length,de=ue-1;te<ue;de=te++){if(ji(C[he],C[he+1],H[de],H[te]))return 0;ce=Math.min(ce,br(C[he],C[he+1],H[de],H[te],le))}return ce}function Ar(C,H){for(const te of C)for(let C=0;C<=te.length-1;++C)if(Ui(te[C],H,!0))return!0;return!1}function Sr(C,H,te,le=1/0){const ce=mr(C),he=mr(H);if(le!==1/0&&_r(ce,he,te)>=le)return le;if(Fi(ce,he)){if(Ar(C,H))return 0}else if(Ar(H,C))return 0;let ue=le;for(const le of C)for(let C=0,ce=le.length,he=ce-1;C<ce;he=C++)for(const ce of H)for(let H=0,de=ce.length,_e=de-1;H<de;_e=H++){if(ji(le[he],le[C],ce[_e],ce[H]))return 0;ue=Math.min(ue,br(le[he],le[C],ce[_e],ce[H],te))}return ue}function Ir(C,H,te,le,ce,he,ue){if(null===he||null===ue)return;const de=_r(fr(le,he),fr(ce,ue),te);de<H&&C.push({dist:de,range1:he,range2:ue})}function Cr(C,H,te,le,ce=1/0){let he=Math.min(le.distance(C[0],te[0][0]),ce);if(0===he)return he;const ue=new vn([{dist:0,range1:[0,C.length-1],range2:[0,0]}],ar),de=H?An:En,_e=mr(te);for(;ue.length;){const ce=ue.pop();if(ce.dist>=he)continue;const ye=ce.range1;if(ur(ye)<=de){if(!dr(ye,C.length))return NaN;if(H){const H=Mr(C,ye,te,le);if(0===(he=Math.min(he,H)))return he}else for(let H=ye[0];H<=ye[1];++H){const ce=Er(C[H],te,le);if(0===(he=Math.min(he,ce)))return he}}else{const te=pr(ye,H);if(null!==te[0]){const H=_r(fr(C,te[0]),_e,le);H<he&&ue.push({dist:H,range1:te[0],range2:[0,0]})}if(null!==te[1]){const H=_r(fr(C,te[1]),_e,le);H<he&&ue.push({dist:H,range1:te[1],range2:[0,0]})}}}return he}function zr(C,H,te,le,ce,he=1/0){let ue=Math.min(he,ce.distance(C[0],te[0]));if(0===ue)return ue;const de=new vn([{dist:0,range1:[0,C.length-1],range2:[0,te.length-1]}],ar),_e=H?An:En,ye=le?An:En;for(;de.length;){const he=de.pop();if(he.dist>=ue)continue;const ve=he.range1,Me=he.range2;if(ur(ve)<=_e&&ur(Me)<=ye){if(!dr(ve,C.length)||!dr(Me,te.length))return NaN;if(H&&le?ue=Math.min(ue,wr(C,ve,te,Me,ce)):H||le?H&&!le?ue=Math.min(ue,vr(te,Me,C,ve,ce)):!H&&le&&(ue=Math.min(ue,vr(C,ve,te,Me,ce))):ue=Math.min(ue,Tr(C,ve,te,Me,ce)),0===ue)return ue}else{const he=pr(ve,H),_e=pr(Me,le);Ir(de,ue,ce,C,te,he[0],_e[0]),Ir(de,ue,ce,C,te,he[0],_e[1]),Ir(de,ue,ce,C,te,he[1],_e[0]),Ir(de,ue,ce,C,te,he[1],_e[1])}}return ue}function Dr(C,H,te,le,ce=1/0){let he=ce;const ue=fr(C,[0,C.length-1]);for(const ce of te)if(!(he!==1/0&&_r(ue,fr(ce,[0,ce.length-1]),le)>=he)&&(he=Math.min(he,zr(C,H,ce,!0,le,he)),0===he))return he;return he}function Pr(C,H,te,le,ce=1/0){let he=ce;const ue=fr(C,[0,C.length-1]);for(const ce of te){if(he!==1/0&&_r(ue,mr(ce),le)>=he)continue;const te=Cr(C,H,ce,le,he);if(isNaN(te))return te;if(0===(he=Math.min(he,te)))return he}return he}function Rr(C){return"Point"===C||"MultiPoint"===C||"LineString"===C||"MultiLineString"===C||"Polygon"===C||"MultiPolygon"===C}class Lr{constructor(C,H){this.type=Pi,this.geojson=C,this.geometries=H}static parse(C,H){if(2!==C.length)return H.error(`'distance' expression requires either one argument, but found ' ${C.length-1} instead.`);if(fi(C[1])){const H=C[1];if("FeatureCollection"===H.type){for(let C=0;C<H.features.length;++C)if(Rr(H.features[C].geometry.type))return new Lr(H,H.features[C].geometry)}else if("Feature"===H.type){if(Rr(H.geometry.type))return new Lr(H,H.geometry)}else if(Rr(H.type))return new Lr(H,H)}return H.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(C){const H=C.geometry(),te=C.canonicalID();if(null!=H&&null!=te){if("Point"===C.geometryType())return function(C,H,te){const le=[];for(const te of C)for(const C of te)le.push(gr(C,H));const ce=new mn(le[0][1],"meters");return"Point"===te.type||"MultiPoint"===te.type||"LineString"===te.type?zr(le,!1,"Point"===te.type?[te.coordinates]:te.coordinates,"LineString"===te.type,ce):"MultiLineString"===te.type?Dr(le,!1,te.coordinates,ce):"Polygon"===te.type||"MultiPolygon"===te.type?Pr(le,!1,"Polygon"===te.type?[te.coordinates]:te.coordinates,ce):null}(H,te,this.geometries);if("LineString"===C.geometryType())return function(C,H,te){const le=[];for(const te of C){const C=[];for(const le of te)C.push(gr(le,H));le.push(C)}const ce=new mn(le[0][0][1],"meters");if("Point"===te.type||"MultiPoint"===te.type||"LineString"===te.type)return Dr("Point"===te.type?[te.coordinates]:te.coordinates,"LineString"===te.type,le,ce);if("MultiLineString"===te.type){let C=1/0;for(let H=0;H<te.coordinates.length;H++){const he=Dr(te.coordinates[H],!0,le,ce,C);if(isNaN(he))return he;if(0===(C=Math.min(C,he)))return C}return C}if("Polygon"===te.type||"MultiPolygon"===te.type){let C=1/0;for(let H=0;H<le.length;H++){const he=Pr(le[H],!0,"Polygon"===te.type?[te.coordinates]:te.coordinates,ce,C);if(isNaN(he))return he;if(0===(C=Math.min(C,he)))return C}return C}return null}(H,te,this.geometries);if("Polygon"===C.geometryType())return function(C,H,te){const le=[];for(const te of function(C,H){const te=C.length;if(te<=1)return[C];const le=[];let ce,he;for(let H=0;H<te;H++){const te=Oi(C[H]);0!==te&&(C[H].area=Math.abs(te),void 0===he&&(he=te<0),he===te<0?(ce&&le.push(ce),ce=[C[H]]):ce.push(C[H]))}return ce&&le.push(ce),le}(C)){const C=[];for(let le=0;le<te.length;++le)C.push(yr(te[le],H));le.push(C)}const ce=new mn(le[0][0][0][1],"meters");if("Point"===te.type||"MultiPoint"===te.type||"LineString"===te.type)return Pr("Point"===te.type?[te.coordinates]:te.coordinates,"LineString"===te.type,le,ce);if("MultiLineString"===te.type){let C=1/0;for(let H=0;H<te.coordinates.length;H++){const he=Pr(te.coordinates[H],!0,le,ce,C);if(isNaN(he))return he;if(0===(C=Math.min(C,he)))return C}return C}return"Polygon"===te.type||"MultiPolygon"===te.type?function(C,H,te){let le=1/0;for(const ce of C)for(const C of H){const H=Sr(ce,C,te,le);if(isNaN(H))return H;if(0===(le=Math.min(le,H)))return le}return le}("Polygon"===te.type?[te.coordinates]:te.coordinates,le,ce):null}(H,te,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}var In=Lr;function Or(C){if(C instanceof tn){if("get"===C.name&&1===C.args.length)return!1;if("feature-state"===C.name)return!1;if("has"===C.name&&1===C.args.length)return!1;if("properties"===C.name||"geometry-type"===C.name||"id"===C.name)return!1;if(/^filter-/.test(C.name))return!1}if(C instanceof pn)return!1;if(C instanceof In)return!1;let H=!0;return C.eachChild((C=>{H&&!Or(C)&&(H=!1)})),H}function Br(C){if(C instanceof tn&&"feature-state"===C.name)return!1;let H=!0;return C.eachChild((C=>{H&&!Br(C)&&(H=!1)})),H}function Fr(C){if(C instanceof tn&&"config"===C.name)return!1;let H=!0;return C.eachChild((C=>{H&&!Fr(C)&&(H=!1)})),H}function Nr(C,H){if(C instanceof tn&&H.indexOf(C.name)>=0)return!1;let te=!0;return C.eachChild((C=>{te&&!Nr(C,H)&&(te=!1)})),te}class Ur{constructor(C,H){this.type=H.type,this.name=C,this.boundExpression=H}static parse(C,H){if(2!==C.length||"string"!=typeof C[1])return H.error("'var' expression requires exactly one string literal argument.");const te=C[1];return H.scope.has(te)?new Ur(te,H.scope.get(te)):H.error(`Unknown variable "${te}". Make sure "${te}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(C){return this.boundExpression.evaluate(C)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}var zn=Ur;class jr{constructor(C,H=[],te,le=new Ci,ce=[],he){this.registry=C,this.path=H,this.key=H.map((C=>`[${C}]`)).join(""),this.scope=le,this.errors=ce,this.expectedType=te,this.options=he}parse(C,H,te,le,ce={}){return H||te?this.concat(H,te,le)._parse(C,ce):this._parse(C,ce)}_parse(C,H){function i(C,H,te){return"assert"===te?new Yr(H,[C]):"coerce"===te?new Jr(H,[C]):C}if(null!==C&&"string"!=typeof C&&"boolean"!=typeof C&&"number"!=typeof C||(C=["literal",C]),Array.isArray(C)){if(0===C.length)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const te="string"==typeof C[0]?this.registry[C[0]]:void 0;if(te){let le=te.parse(C,this);if(!le)return null;if(this.expectedType){const C=this.expectedType,te=le.type;if("string"!==C.kind&&"number"!==C.kind&&"boolean"!==C.kind&&"object"!==C.kind&&"array"!==C.kind||"value"!==te.kind)if("color"!==C.kind&&"formatted"!==C.kind&&"resolvedImage"!==C.kind||"value"!==te.kind&&"string"!==te.kind){if(this.checkSubtype(C,te))return null}else le=i(le,C,H.typeAnnotation||"coerce");else le=i(le,C,H.typeAnnotation||"assert")}if(!(le instanceof Vr)&&"resolvedImage"!==le.type.kind&&qr(le)){const H=new en(this.options);try{le=new Vr(le.type,le.evaluate(H))}catch(C){return this.error(C.message),null}}return le}return Jr.parse(["to-array",C],this)}return this.error(void 0===C?"'undefined' value invalid. Use null instead.":"object"==typeof C?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof C} instead.`)}concat(C,H,te){const le="number"==typeof C?this.path.concat(C):this.path,ce=te?this.scope.concat(te):this.scope;return new jr(this.registry,le,H||null,ce,this.errors,this.options)}error(C,...H){const te=`${this.key}${H.map((C=>`[${C}]`)).join("")}`;this.errors.push(new Ii(te,C))}checkSubtype(C,H){const te=Jt(C,H);return te&&this.error(te),te}}var Pn=jr;function qr(C){if(C instanceof zn)return qr(C.boundExpression);if(C instanceof tn&&"error"===C.name)return!1;if(C instanceof tn&&"config"===C.name)return!1;if(C instanceof Ri)return!1;if(C instanceof pn)return!1;if(C instanceof In)return!1;const H=C instanceof Jr||C instanceof Yr;let te=!0;return C.eachChild((C=>{te=H?te&&qr(C):te&&C instanceof Vr})),!!te&&Or(C)&&Nr(C,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light"])}function Zr(C,H){const te=C.length-1;let le,ce,he=0,ue=te,de=0;for(;he<=ue;)if(de=Math.floor((he+ue)/2),le=C[de],ce=C[de+1],le<=H){if(de===te||H<ce)return de;he=de+1}else{if(!(le>H))throw new Gr("Input is not a number.");ue=de-1}return 0}class $r{constructor(C,H,te){this.type=C,this.input=H,this.labels=[],this.outputs=[];for(const[C,H]of te)this.labels.push(C),this.outputs.push(H)}static parse(C,H){if(C.length-1<4)return H.error(`Expected at least 4 arguments, but found only ${C.length-1}.`);if((C.length-1)%2!=0)return H.error("Expected an even number of arguments.");const te=H.parse(C[1],1,Pi);if(!te)return null;const le=[];let ce=null;H.expectedType&&"value"!==H.expectedType.kind&&(ce=H.expectedType);for(let te=1;te<C.length;te+=2){const he=1===te?-1/0:C[te],ue=C[te+1],de=te,_e=te+1;if("number"!=typeof he)return H.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',de);if(le.length&&le[le.length-1][0]>=he)return H.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',de);const ye=H.parse(ue,_e,ce);if(!ye)return null;ce=ce||ye.type,le.push([he,ye])}return new $r(ce,te,le)}evaluate(C){const H=this.labels,te=this.outputs;if(1===H.length)return te[0].evaluate(C);const le=this.input.evaluate(C);if(le<=H[0])return te[0].evaluate(C);const ce=H.length;return le>=H[ce-1]?te[ce-1].evaluate(C):te[Zr(H,le)].evaluate(C)}eachChild(C){C(this.input);for(const H of this.outputs)C(H)}outputDefined(){return this.outputs.every((C=>C.outputDefined()))}serialize(){const C=["step",this.input.serialize()];for(let H=0;H<this.labels.length;H++)H>0&&C.push(this.labels[H]),C.push(this.outputs[H].serialize());return C}}var Ln=$r;function Wr(C,H,te){return C*(1-te)+H*te}function Xr(C,H,te){return C.map(((C,le)=>Wr(C,H[le],te)))}var Fn=Object.freeze({__proto__:null,array:Xr,color:function(C,H,te){return new kr(Wr(C.r,H.r,te),Wr(C.g,H.g,te),Wr(C.b,H.b,te),Wr(C.a,H.a,te))},number:Wr});const Nn=.95047,Un=1.08883,Vn=4/29,jn=6/29,Gn=3*jn*jn,Hn=jn*jn*jn,eo=Math.PI/180,Bo=180/Math.PI;function sn(C){return C>Hn?Math.pow(C,1/3):C/Gn+Vn}function an(C){return C>jn?C*C*C:Gn*(C-Vn)}function ln(C){return 255*(C<=.0031308?12.92*C:1.055*Math.pow(C,1/2.4)-.055)}function cn(C){return(C/=255)<=.04045?C/12.92:Math.pow((C+.055)/1.055,2.4)}function hn(C){const H=cn(C.r),te=cn(C.g),le=cn(C.b),ce=sn((.4124564*H+.3575761*te+.1804375*le)/Nn),he=sn((.2126729*H+.7151522*te+.072175*le)/1);return{l:116*he-16,a:500*(ce-he),b:200*(he-sn((.0193339*H+.119192*te+.9503041*le)/Un)),alpha:C.a}}function un(C){let H=(C.l+16)/116,te=isNaN(C.a)?H:H+C.a/500,le=isNaN(C.b)?H:H-C.b/200;return H=1*an(H),te=Nn*an(te),le=Un*an(le),new kr(ln(3.2404542*te-1.5371385*H-.4985314*le),ln(-.969266*te+1.8760108*H+.041556*le),ln(.0556434*te-.2040259*H+1.0572252*le),C.alpha)}function dn(C,H,te){const le=H-C;return C+te*(le>180||le<-180?le-360*Math.round(le/360):le)}const Jo={forward:hn,reverse:un,interpolate:function(C,H,te){return{l:Wr(C.l,H.l,te),a:Wr(C.a,H.a,te),b:Wr(C.b,H.b,te),alpha:Wr(C.alpha,H.alpha,te)}}},ss={forward:function(C){const{l:H,a:te,b:le}=hn(C),ce=Math.atan2(le,te)*Bo;return{h:ce<0?ce+360:ce,c:Math.sqrt(te*te+le*le),l:H,alpha:C.a}},reverse:function(C){const H=C.h*eo,te=C.c;return un({l:C.l,a:Math.cos(H)*te,b:Math.sin(H)*te,alpha:C.alpha})},interpolate:function(C,H,te){return{h:dn(C.h,H.h,te),c:Wr(C.c,H.c,te),l:Wr(C.l,H.l,te),alpha:Wr(C.alpha,H.alpha,te)}}};var Ts=Object.freeze({__proto__:null,hcl:ss,lab:Jo});class _n{constructor(C,H,te,le,ce){this.type=C,this.operator=H,this.interpolation=te,this.input=le,this.labels=[],this.outputs=[];for(const[C,H]of ce)this.labels.push(C),this.outputs.push(H)}static interpolationFactor(C,H,te,le){let ce=0;if("exponential"===C.name)ce=gn(H,C.base,te,le);else if("linear"===C.name)ce=gn(H,1,te,le);else if("cubic-bezier"===C.name){const he=C.controlPoints;ce=new Ce(he[0],he[1],he[2],he[3]).solve(gn(H,1,te,le))}return ce}static parse(C,H){let[te,le,ce,...he]=C;if(!Array.isArray(le)||0===le.length)return H.error("Expected an interpolation type expression.",1);if("linear"===le[0])le={name:"linear"};else if("exponential"===le[0]){const C=le[1];if("number"!=typeof C)return H.error("Exponential interpolation requires a numeric base.",1,1);le={name:"exponential",base:C}}else{if("cubic-bezier"!==le[0])return H.error(`Unknown interpolation type ${String(le[0])}`,1,0);{const C=le.slice(1);if(4!==C.length||C.some((C=>"number"!=typeof C||C<0||C>1)))return H.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);le={name:"cubic-bezier",controlPoints:C}}}if(C.length-1<4)return H.error(`Expected at least 4 arguments, but found only ${C.length-1}.`);if((C.length-1)%2!=0)return H.error("Expected an even number of arguments.");if(ce=H.parse(ce,2,Pi),!ce)return null;const ue=[];let de=null;"interpolate-hcl"===te||"interpolate-lab"===te?de=Gi:H.expectedType&&"value"!==H.expectedType.kind&&(de=H.expectedType);for(let C=0;C<he.length;C+=2){const te=he[C],le=he[C+1],ce=C+3,_e=C+4;if("number"!=typeof te)return H.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',ce);if(ue.length&&ue[ue.length-1][0]>=te)return H.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',ce);const ye=H.parse(le,_e,de);if(!ye)return null;de=de||ye.type,ue.push([te,ye])}return"number"===de.kind||"color"===de.kind||"array"===de.kind&&"number"===de.itemType.kind&&"number"==typeof de.N?new _n(de,te,le,ce,ue):H.error(`Type ${Yt(de)} is not interpolatable.`)}evaluate(C){const H=this.labels,te=this.outputs;if(1===H.length)return te[0].evaluate(C);const le=this.input.evaluate(C);if(le<=H[0])return te[0].evaluate(C);const ce=H.length;if(le>=H[ce-1])return te[ce-1].evaluate(C);const he=Zr(H,le),ue=_n.interpolationFactor(this.interpolation,le,H[he],H[he+1]),de=te[he].evaluate(C),_e=te[he+1].evaluate(C);return"interpolate"===this.operator?Fn[this.type.kind.toLowerCase()](de,_e,ue):"interpolate-hcl"===this.operator?ss.reverse(ss.interpolate(ss.forward(de),ss.forward(_e),ue)):Jo.reverse(Jo.interpolate(Jo.forward(de),Jo.forward(_e),ue))}eachChild(C){C(this.input);for(const H of this.outputs)C(H)}outputDefined(){return this.outputs.every((C=>C.outputDefined()))}serialize(){let C;C="linear"===this.interpolation.name?["linear"]:"exponential"===this.interpolation.name?1===this.interpolation.base?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const H=[this.operator,C,this.input.serialize()];for(let C=0;C<this.labels.length;C++)H.push(this.labels[C],this.outputs[C].serialize());return H}}function gn(C,H,te,le){const ce=le-te,he=C-te;return 0===ce?0:1===H?he/ce:(Math.pow(H,he)-1)/(Math.pow(H,ce)-1)}var Es=_n;class xn{constructor(C,H){this.type=C,this.args=H}static parse(C,H){if(C.length<2)return H.error("Expectected at least one argument.");let te=null;const le=H.expectedType;le&&"value"!==le.kind&&(te=le);const ce=[];for(const le of C.slice(1)){const C=H.parse(le,1+ce.length,te,void 0,{typeAnnotation:"omit"});if(!C)return null;te=te||C.type,ce.push(C)}const he=le&&ce.some((C=>Jt(le,C.type)));return new xn(he?ir:te,ce)}evaluate(C){let H,te=null,le=0;for(const ce of this.args){if(le++,te=ce.evaluate(C),te&&te instanceof di&&!te.available&&(H||(H=te),te=null,le===this.args.length))return H;if(null!==te)break}return te}eachChild(C){this.args.forEach(C)}outputDefined(){return this.args.every((C=>C.outputDefined()))}serialize(){const C=["coalesce"];return this.eachChild((H=>{C.push(H.serialize())})),C}}var Ss=xn;class bn{constructor(C,H){this.type=H.type,this.bindings=[].concat(C),this.result=H}evaluate(C){return this.result.evaluate(C)}eachChild(C){for(const H of this.bindings)C(H[1]);C(this.result)}static parse(C,H){if(C.length<4)return H.error(`Expected at least 3 arguments, but found ${C.length-1} instead.`);const te=[];for(let le=1;le<C.length-1;le+=2){const ce=C[le];if("string"!=typeof ce)return H.error(`Expected string, but found ${typeof ce} instead.`,le);if(/[^a-zA-Z0-9_]/.test(ce))return H.error("Variable names must contain only alphanumeric characters or '_'.",le);const he=H.parse(C[le+1],le+1);if(!he)return null;te.push([ce,he])}const le=H.parse(C[C.length-1],C.length-1,H.expectedType,te);return le?new bn(te,le):null}outputDefined(){return this.result.outputDefined()}serialize(){const C=["let"];for(const[H,te]of this.bindings)C.push(H,te.serialize());return C.push(this.result.serialize()),C}}var As=bn;class Tn{constructor(C,H,te){this.type=C,this.index=H,this.input=te}static parse(C,H){if(3!==C.length)return H.error(`Expected 2 arguments, but found ${C.length-1} instead.`);const te=H.parse(C[1],1,Pi),le=H.parse(C[2],2,Xt(H.expectedType||ir));return te&&le?new Tn(le.type.itemType,te,le):null}evaluate(C){const H=this.index.evaluate(C),te=this.input.evaluate(C);if(H<0)throw new Gr(`Array index out of bounds: ${H} < 0.`);if(H>=te.length)throw new Gr(`Array index out of bounds: ${H} > ${te.length-1}.`);if(H!==Math.floor(H))throw new Gr(`Array index must be an integer, but found ${H} instead.`);return te[H]}eachChild(C){C(this.index),C(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}var Rs=Tn;class Mn{constructor(C,H){this.type=Li,this.needle=C,this.haystack=H}static parse(C,H){if(3!==C.length)return H.error(`Expected 2 arguments, but found ${C.length-1} instead.`);const te=H.parse(C[1],1,ir),le=H.parse(C[2],2,ir);return te&&le?Qt(te.type,[Li,ki,Pi,zi,ir])?new Mn(te,le):H.error(`Expected first argument to be of type boolean, string, number or null, but found ${Yt(te.type)} instead`):null}evaluate(C){const H=this.needle.evaluate(C),te=this.haystack.evaluate(C);if(null==te)return!1;if(!ei(H,["boolean","string","number","null"]))throw new Gr(`Expected first argument to be of type boolean, string, number or null, but found ${Yt(mi(H))} instead.`);if(!ei(te,["string","array"]))throw new Gr(`Expected second argument to be of type array or string, but found ${Yt(mi(te))} instead.`);return te.indexOf(H)>=0}eachChild(C){C(this.needle),C(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}var js=Mn;class Sn{constructor(C,H,te){this.type=Pi,this.needle=C,this.haystack=H,this.fromIndex=te}static parse(C,H){if(C.length<=2||C.length>=5)return H.error(`Expected 3 or 4 arguments, but found ${C.length-1} instead.`);const te=H.parse(C[1],1,ir),le=H.parse(C[2],2,ir);if(!te||!le)return null;if(!Qt(te.type,[Li,ki,Pi,zi,ir]))return H.error(`Expected first argument to be of type boolean, string, number or null, but found ${Yt(te.type)} instead`);if(4===C.length){const ce=H.parse(C[3],3,Pi);return ce?new Sn(te,le,ce):null}return new Sn(te,le)}evaluate(C){const H=this.needle.evaluate(C),te=this.haystack.evaluate(C);if(!ei(H,["boolean","string","number","null"]))throw new Gr(`Expected first argument to be of type boolean, string, number or null, but found ${Yt(mi(H))} instead.`);if(!ei(te,["string","array"]))throw new Gr(`Expected second argument to be of type array or string, but found ${Yt(mi(te))} instead.`);if(this.fromIndex){const le=this.fromIndex.evaluate(C);return te.indexOf(H,le)}return te.indexOf(H)}eachChild(C){C(this.needle),C(this.haystack),this.fromIndex&&C(this.fromIndex)}outputDefined(){return!1}serialize(){if(null!=this.fromIndex&&void 0!==this.fromIndex){const C=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),C]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}var Gs=Sn;class Cn{constructor(C,H,te,le,ce,he){this.inputType=C,this.type=H,this.input=te,this.cases=le,this.outputs=ce,this.otherwise=he}static parse(C,H){if(C.length<5)return H.error(`Expected at least 4 arguments, but found only ${C.length-1}.`);if(C.length%2!=1)return H.error("Expected an even number of arguments.");let te,le;H.expectedType&&"value"!==H.expectedType.kind&&(le=H.expectedType);const ce={},he=[];for(let ue=2;ue<C.length-1;ue+=2){let de=C[ue];const _e=C[ue+1];Array.isArray(de)||(de=[de]);const ye=H.concat(ue);if(0===de.length)return ye.error("Expected at least one branch label.");for(const C of de){if("number"!=typeof C&&"string"!=typeof C)return ye.error("Branch labels must be numbers or strings.");if("number"==typeof C&&Math.abs(C)>Number.MAX_SAFE_INTEGER)return ye.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if("number"==typeof C&&Math.floor(C)!==C)return ye.error("Numeric branch labels must be integer values.");if(te){if(ye.checkSubtype(te,mi(C)))return null}else te=mi(C);if(void 0!==ce[String(C)])return ye.error("Branch labels must be unique.");ce[String(C)]=he.length}const ve=H.parse(_e,ue,le);if(!ve)return null;le=le||ve.type,he.push(ve)}const ue=H.parse(C[1],1,ir);if(!ue)return null;const de=H.parse(C[C.length-1],C.length-1,le);return de?"value"!==ue.type.kind&&H.concat(1).checkSubtype(te,ue.type)?null:new Cn(te,le,ue,ce,he,de):null}evaluate(C){const H=this.input.evaluate(C);return(mi(H)===this.inputType&&this.outputs[this.cases[H]]||this.otherwise).evaluate(C)}eachChild(C){C(this.input),this.outputs.forEach(C),C(this.otherwise)}outputDefined(){return this.outputs.every((C=>C.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const C=["match",this.input.serialize()],H=Object.keys(this.cases).sort(),te=[],le={};for(const C of H){const H=le[this.cases[C]];void 0===H?(le[this.cases[C]]=te.length,te.push([this.cases[C],[C]])):te[H][1].push(C)}const n=C=>"number"===this.inputType.kind?Number(C):C;for(const[H,le]of te)C.push(1===le.length?n(le[0]):le.map(n)),C.push(this.outputs[H].serialize());return C.push(this.otherwise.serialize()),C}}var Zs=Cn;class Dn{constructor(C,H,te){this.type=C,this.branches=H,this.otherwise=te}static parse(C,H){if(C.length<4)return H.error(`Expected at least 3 arguments, but found only ${C.length-1}.`);if(C.length%2!=0)return H.error("Expected an odd number of arguments.");let te;H.expectedType&&"value"!==H.expectedType.kind&&(te=H.expectedType);const le=[];for(let ce=1;ce<C.length-1;ce+=2){const he=H.parse(C[ce],ce,Li);if(!he)return null;const ue=H.parse(C[ce+1],ce+1,te);if(!ue)return null;le.push([he,ue]),te=te||ue.type}const ce=H.parse(C[C.length-1],C.length-1,te);return ce?new Dn(te,le,ce):null}evaluate(C){for(const[H,te]of this.branches)if(H.evaluate(C))return te.evaluate(C);return this.otherwise.evaluate(C)}eachChild(C){for(const[H,te]of this.branches)C(H),C(te);C(this.otherwise)}outputDefined(){return this.branches.every((([C,H])=>H.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const C=["case"];return this.eachChild((H=>{C.push(H.serialize())})),C}}var qs=Dn;class Rn{constructor(C,H,te,le){this.type=C,this.input=H,this.beginIndex=te,this.endIndex=le}static parse(C,H){if(C.length<=2||C.length>=5)return H.error(`Expected 3 or 4 arguments, but found ${C.length-1} instead.`);const te=H.parse(C[1],1,ir),le=H.parse(C[2],2,Pi);if(!te||!le)return null;if(!Qt(te.type,[Xt(ir),ki,ir]))return H.error(`Expected first argument to be of type array or string, but found ${Yt(te.type)} instead`);if(4===C.length){const ce=H.parse(C[3],3,Pi);return ce?new Rn(te.type,te,le,ce):null}return new Rn(te.type,te,le)}evaluate(C){const H=this.input.evaluate(C),te=this.beginIndex.evaluate(C);if(!ei(H,["string","array"]))throw new Gr(`Expected first argument to be of type array or string, but found ${Yt(mi(H))} instead.`);if(this.endIndex){const le=this.endIndex.evaluate(C);return H.slice(te,le)}return H.slice(te)}eachChild(C){C(this.input),C(this.beginIndex),this.endIndex&&C(this.endIndex)}outputDefined(){return!1}serialize(){if(null!=this.endIndex&&void 0!==this.endIndex){const C=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),C]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}var $s=Rn;function kn(C,H){return"=="===C||"!="===C?"boolean"===H.kind||"string"===H.kind||"number"===H.kind||"null"===H.kind||"value"===H.kind:"string"===H.kind||"number"===H.kind||"value"===H.kind}function On(C,H,te,le){return 0===le.compare(H,te)}function Bn(C,H,te){const le="=="!==C&&"!="!==C;return class n{constructor(C,H,te){this.type=Li,this.lhs=C,this.rhs=H,this.collator=te,this.hasUntypedArgument="value"===C.type.kind||"value"===H.type.kind}static parse(C,H){if(3!==C.length&&4!==C.length)return H.error("Expected two or three arguments.");const te=C[0];let ce=H.parse(C[1],1,ir);if(!ce)return null;if(!kn(te,ce.type))return H.concat(1).error(`"${te}" comparisons are not supported for type '${Yt(ce.type)}'.`);let he=H.parse(C[2],2,ir);if(!he)return null;if(!kn(te,he.type))return H.concat(2).error(`"${te}" comparisons are not supported for type '${Yt(he.type)}'.`);if(ce.type.kind!==he.type.kind&&"value"!==ce.type.kind&&"value"!==he.type.kind)return H.error(`Cannot compare types '${Yt(ce.type)}' and '${Yt(he.type)}'.`);le&&("value"===ce.type.kind&&"value"!==he.type.kind?ce=new Yr(he.type,[ce]):"value"!==ce.type.kind&&"value"===he.type.kind&&(he=new Yr(ce.type,[he])));let ue=null;if(4===C.length){if("string"!==ce.type.kind&&"string"!==he.type.kind&&"value"!==ce.type.kind&&"value"!==he.type.kind)return H.error("Cannot use collator to compare non-string types.");if(ue=H.parse(C[3],3,rr),!ue)return null}return new n(ce,he,ue)}evaluate(ce){const he=this.lhs.evaluate(ce),ue=this.rhs.evaluate(ce);if(le&&this.hasUntypedArgument){const H=mi(he),te=mi(ue);if(H.kind!==te.kind||"string"!==H.kind&&"number"!==H.kind)throw new Gr(`Expected arguments for "${C}" to be (string, string) or (number, number), but found (${H.kind}, ${te.kind}) instead.`)}if(this.collator&&!le&&this.hasUntypedArgument){const C=mi(he),te=mi(ue);if("string"!==C.kind||"string"!==te.kind)return H(ce,he,ue)}return this.collator?te(ce,he,ue,this.collator.evaluate(ce)):H(ce,he,ue)}eachChild(C){C(this.lhs),C(this.rhs),this.collator&&C(this.collator)}outputDefined(){return!0}serialize(){const H=[C];return this.eachChild((C=>{H.push(C.serialize())})),H}}}const Hs=Bn("==",(function(C,H,te){return H===te}),On),Ys=Bn("!=",(function(C,H,te){return H!==te}),(function(C,H,te,le){return!On(0,H,te,le)})),Qs=Bn("<",(function(C,H,te){return H<te}),(function(C,H,te,le){return le.compare(H,te)<0})),ma=Bn(">",(function(C,H,te){return H>te}),(function(C,H,te,le){return le.compare(H,te)>0})),ya=Bn("<=",(function(C,H,te){return H<=te}),(function(C,H,te,le){return le.compare(H,te)<=0})),hl=Bn(">=",(function(C,H,te){return H>=te}),(function(C,H,te,le){return le.compare(H,te)>=0}));class qn{constructor(C,H,te,le,ce,he){this.type=ki,this.number=C,this.locale=H,this.currency=te,this.unit=le,this.minFractionDigits=ce,this.maxFractionDigits=he}static parse(C,H){if(3!==C.length)return H.error("Expected two arguments.");const te=H.parse(C[1],1,Pi);if(!te)return null;const le=C[2];if("object"!=typeof le||Array.isArray(le))return H.error("NumberFormat options argument must be an object.");let ce=null;if(le.locale&&(ce=H.parse(le.locale,1,ki),!ce))return null;let he=null;if(le.currency&&(he=H.parse(le.currency,1,ki),!he))return null;let ue=null;if(le.unit&&(ue=H.parse(le.unit,1,ki),!ue))return null;let de=null;if(le["min-fraction-digits"]&&(de=H.parse(le["min-fraction-digits"],1,Pi),!de))return null;let _e=null;return le["max-fraction-digits"]&&(_e=H.parse(le["max-fraction-digits"],1,Pi),!_e)?null:new qn(te,ce,he,ue,de,_e)}evaluate(C){return new Intl.NumberFormat(this.locale?this.locale.evaluate(C):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(C):void 0,unit:this.unit?this.unit.evaluate(C):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(C):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(C):void 0}).format(this.number.evaluate(C))}eachChild(C){C(this.number),this.locale&&C(this.locale),this.currency&&C(this.currency),this.unit&&C(this.unit),this.minFractionDigits&&C(this.minFractionDigits),this.maxFractionDigits&&C(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const C={};return this.locale&&(C.locale=this.locale.serialize()),this.currency&&(C.currency=this.currency.serialize()),this.unit&&(C.unit=this.unit.serialize()),this.minFractionDigits&&(C["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(C["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),C]}}class Zn{constructor(C){this.type=Pi,this.input=C}static parse(C,H){if(2!==C.length)return H.error(`Expected 1 argument, but found ${C.length-1} instead.`);const te=H.parse(C[1],1);return te?"array"!==te.type.kind&&"string"!==te.type.kind&&"value"!==te.type.kind?H.error(`Expected argument of type string or array, but found ${Yt(te.type)} instead.`):new Zn(te):null}evaluate(C){const H=this.input.evaluate(C);if("string"==typeof H)return H.length;if(Array.isArray(H))return H.length;throw new Gr(`Expected value to be of type string or array, but found ${Yt(mi(H))} instead.`)}eachChild(C){C(this.input)}outputDefined(){return!1}serialize(){const C=["length"];return this.eachChild((H=>{C.push(H.serialize())})),C}}function $n(C){return function(){C=1831565813+(C|=0)|0;let H=Math.imul(C^C>>>15,1|C);return H=H+Math.imul(H^H>>>7,61|H)^H,((H^H>>>14)>>>0)/4294967296}}const ul={"==":Hs,"!=":Ys,">":ma,"<":Qs,">=":hl,"<=":ya,array:Yr,at:Rs,boolean:Yr,case:qs,coalesce:Ss,collator:Ri,format:Ti,image:Ei,in:js,"index-of":Gs,interpolate:Es,"interpolate-hcl":Es,"interpolate-lab":Es,length:Zn,let:As,literal:Vr,match:Zs,number:Yr,"number-format":qn,object:Yr,slice:$s,step:Ln,string:Yr,"to-boolean":Jr,"to-color":Jr,"to-number":Jr,"to-string":Jr,var:zn,within:pn,distance:In};function Wn(C,[H,te,le,ce]){H=H.evaluate(C),te=te.evaluate(C),le=le.evaluate(C);const he=ce?ce.evaluate(C):1,ue=pi(H,te,le,he);if(ue)throw new Gr(ue);return new kr(H/255*he,te/255*he,le/255*he,he)}function Xn(C,[H,te,le,ce]){H=H.evaluate(C),te=te.evaluate(C),le=le.evaluate(C);const he=ce?ce.evaluate(C):1,ue=function(C,H,te,le){return"number"==typeof C&&C>=0&&C<=360?"number"==typeof H&&H>=0&&H<=100&&"number"==typeof te&&te>=0&&te<=100?void 0===le||"number"==typeof le&&le>=0&&le<=1?null:`Invalid hsla value [${[C,H,te,le].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${("number"==typeof le?[C,H,te,le]:[C,H,te]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${("number"==typeof le?[C,H,te,le]:[C,H,te]).join(", ")}]: 'h' must be between 0 and 360.`}(H,te,le,he);if(ue)throw new Gr(ue);const de=`hsla(${H}, ${te}%, ${le}%, ${he})`,_e=kr.parse(de);if(!_e)throw new Gr(`Failed to parse HSLA color: ${de}`);return _e}function Yn(C,H){return C in H}function Kn(C,H){const te=H[C];return void 0===te?null:te}function Jn(C,H,te){te.length&&(H+=`${te}`);const le=C.getConfig(H);return le?le.evaluate(C):null}function Qn(C){return{type:C}}tn.register(ul,{error:[{kind:"error"},[ki],(C,[H])=>{throw new Gr(H.evaluate(C))}],typeof:[ki,[ir],(C,[H])=>Yt(mi(H.evaluate(C)))],"to-rgba":[Xt(Pi,4),[Gi],(C,[H])=>H.evaluate(C).toArray()],rgb:[Gi,[Pi,Pi,Pi],Wn],rgba:[Gi,[Pi,Pi,Pi,Pi],Wn],hsl:[Gi,[Pi,Pi,Pi],Xn],hsla:[Gi,[Pi,Pi,Pi,Pi],Xn],has:{type:Li,overloads:[[[ki],(C,[H])=>Yn(H.evaluate(C),C.properties())],[[ki,tr],(C,[H,te])=>Yn(H.evaluate(C),te.evaluate(C))]]},get:{type:ir,overloads:[[[ki],(C,[H])=>Kn(H.evaluate(C),C.properties())],[[ki,tr],(C,[H,te])=>Kn(H.evaluate(C),te.evaluate(C))]]},config:{type:ir,overloads:[[[ki],(C,[H])=>Jn(C,H.evaluate(C),"")],[[ki,ki],(C,[H,te])=>Jn(C,H.evaluate(C),te.evaluate(C))]]},"feature-state":[ir,[ki],(C,[H])=>Kn(H.evaluate(C),C.featureState||{})],properties:[tr,[],C=>C.properties()],"geometry-type":[ki,[],C=>C.geometryType()],id:[ir,[],C=>C.id()],zoom:[Pi,[],C=>C.globals.zoom],pitch:[Pi,[],C=>C.globals.pitch||0],"distance-from-center":[Pi,[],C=>C.distanceFromCenter()],"measure-light":[Pi,[ki],(C,[H])=>C.measureLight(H.evaluate(C))],"heatmap-density":[Pi,[],C=>C.globals.heatmapDensity||0],"line-progress":[Pi,[],C=>C.globals.lineProgress||0],"raster-value":[Pi,[],C=>C.globals.rasterValue||0],"sky-radial-progress":[Pi,[],C=>C.globals.skyRadialProgress||0],accumulated:[ir,[],C=>void 0===C.globals.accumulated?null:C.globals.accumulated],"+":[Pi,Qn(Pi),(C,H)=>{let te=0;for(const le of H)te+=le.evaluate(C);return te}],"*":[Pi,Qn(Pi),(C,H)=>{let te=1;for(const le of H)te*=le.evaluate(C);return te}],"-":{type:Pi,overloads:[[[Pi,Pi],(C,[H,te])=>H.evaluate(C)-te.evaluate(C)],[[Pi],(C,[H])=>-H.evaluate(C)]]},"/":[Pi,[Pi,Pi],(C,[H,te])=>H.evaluate(C)/te.evaluate(C)],"%":[Pi,[Pi,Pi],(C,[H,te])=>H.evaluate(C)%te.evaluate(C)],ln2:[Pi,[],()=>Math.LN2],pi:[Pi,[],()=>Math.PI],e:[Pi,[],()=>Math.E],"^":[Pi,[Pi,Pi],(C,[H,te])=>Math.pow(H.evaluate(C),te.evaluate(C))],sqrt:[Pi,[Pi],(C,[H])=>Math.sqrt(H.evaluate(C))],log10:[Pi,[Pi],(C,[H])=>Math.log(H.evaluate(C))/Math.LN10],ln:[Pi,[Pi],(C,[H])=>Math.log(H.evaluate(C))],log2:[Pi,[Pi],(C,[H])=>Math.log(H.evaluate(C))/Math.LN2],sin:[Pi,[Pi],(C,[H])=>Math.sin(H.evaluate(C))],cos:[Pi,[Pi],(C,[H])=>Math.cos(H.evaluate(C))],tan:[Pi,[Pi],(C,[H])=>Math.tan(H.evaluate(C))],asin:[Pi,[Pi],(C,[H])=>Math.asin(H.evaluate(C))],acos:[Pi,[Pi],(C,[H])=>Math.acos(H.evaluate(C))],atan:[Pi,[Pi],(C,[H])=>Math.atan(H.evaluate(C))],min:[Pi,Qn(Pi),(C,H)=>Math.min(...H.map((H=>H.evaluate(C))))],max:[Pi,Qn(Pi),(C,H)=>Math.max(...H.map((H=>H.evaluate(C))))],abs:[Pi,[Pi],(C,[H])=>Math.abs(H.evaluate(C))],round:[Pi,[Pi],(C,[H])=>{const te=H.evaluate(C);return te<0?-Math.round(-te):Math.round(te)}],floor:[Pi,[Pi],(C,[H])=>Math.floor(H.evaluate(C))],ceil:[Pi,[Pi],(C,[H])=>Math.ceil(H.evaluate(C))],"filter-==":[Li,[ki,ir],(C,[H,te])=>C.properties()[H.value]===te.value],"filter-id-==":[Li,[ir],(C,[H])=>C.id()===H.value],"filter-type-==":[Li,[ki],(C,[H])=>C.geometryType()===H.value],"filter-<":[Li,[ki,ir],(C,[H,te])=>{const le=C.properties()[H.value],ce=te.value;return typeof le==typeof ce&&le<ce}],"filter-id-<":[Li,[ir],(C,[H])=>{const te=C.id(),le=H.value;return typeof te==typeof le&&te<le}],"filter->":[Li,[ki,ir],(C,[H,te])=>{const le=C.properties()[H.value],ce=te.value;return typeof le==typeof ce&&le>ce}],"filter-id->":[Li,[ir],(C,[H])=>{const te=C.id(),le=H.value;return typeof te==typeof le&&te>le}],"filter-<=":[Li,[ki,ir],(C,[H,te])=>{const le=C.properties()[H.value],ce=te.value;return typeof le==typeof ce&&le<=ce}],"filter-id-<=":[Li,[ir],(C,[H])=>{const te=C.id(),le=H.value;return typeof te==typeof le&&te<=le}],"filter->=":[Li,[ki,ir],(C,[H,te])=>{const le=C.properties()[H.value],ce=te.value;return typeof le==typeof ce&&le>=ce}],"filter-id->=":[Li,[ir],(C,[H])=>{const te=C.id(),le=H.value;return typeof te==typeof le&&te>=le}],"filter-has":[Li,[ir],(C,[H])=>H.value in C.properties()],"filter-has-id":[Li,[],C=>null!==C.id()&&void 0!==C.id()],"filter-type-in":[Li,[Xt(ki)],(C,[H])=>H.value.indexOf(C.geometryType())>=0],"filter-id-in":[Li,[Xt(ir)],(C,[H])=>H.value.indexOf(C.id())>=0],"filter-in-small":[Li,[ki,Xt(ir)],(C,[H,te])=>te.value.indexOf(C.properties()[H.value])>=0],"filter-in-large":[Li,[ki,Xt(ir)],(C,[H,te])=>function(C,H,te,le){for(;te<=le;){const ce=te+le>>1;if(H[ce]===C)return!0;H[ce]>C?le=ce-1:te=ce+1}return!1}(C.properties()[H.value],te.value,0,te.value.length-1)],all:{type:Li,overloads:[[[Li,Li],(C,[H,te])=>H.evaluate(C)&&te.evaluate(C)],[Qn(Li),(C,H)=>{for(const te of H)if(!te.evaluate(C))return!1;return!0}]]},any:{type:Li,overloads:[[[Li,Li],(C,[H,te])=>H.evaluate(C)||te.evaluate(C)],[Qn(Li),(C,H)=>{for(const te of H)if(te.evaluate(C))return!0;return!1}]]},"!":[Li,[Li],(C,[H])=>!H.evaluate(C)],"is-supported-script":[Li,[ki],(C,[H])=>{const te=C.globals&&C.globals.isSupportedScript;return!te||te(H.evaluate(C))}],upcase:[ki,[ki],(C,[H])=>H.evaluate(C).toUpperCase()],downcase:[ki,[ki],(C,[H])=>H.evaluate(C).toLowerCase()],concat:[ki,Qn(ir),(C,H)=>H.map((H=>_i(H.evaluate(C)))).join("")],"resolved-locale":[ki,[rr],(C,[H])=>H.evaluate(C).resolvedLocale()],random:[Pi,[Pi,Pi,ir],(C,H)=>{const[te,le,ce]=H.map((H=>H.evaluate(C)));if(te>le)return te;if(te===le)return te;let he;if("string"==typeof ce)he=function(C){let H=0;if(0===C.length)return H;for(let te=0;te<C.length;te++)H=(H<<5)-H+C.charCodeAt(te),H&=H;return H}(ce);else{if("number"!=typeof ce)throw new Gr(`Invalid seed input: ${ce}`);he=ce}return te+$n(he)()*(le-te)}]});var fl=ul;function to(C){return{result:"success",value:C}}function io(C){return{result:"error",value:C}}function ro(C,H){return!!C&&!!C.parameters&&C.parameters.indexOf(H)>-1}function no(C){return"data-driven"===C["property-type"]}function oo(C){return ro(C.expression,"measure-light")}function so(C){return ro(C.expression,"zoom")}function ao(C){return!!C.expression&&C.expression.interpolated}function lo(C){return"object"==typeof C&&null!==C&&!Array.isArray(C)}function co(C){return C}function ho(C,H){const te="color"===H.type,le=C.stops&&"object"==typeof C.stops[0][0],ce=le||!(le||void 0!==C.property),he=C.type||(ao(H)?"exponential":"interval");if(te&&((C=Pt({},C)).stops&&(C.stops=C.stops.map((C=>[C[0],kr.parse(C[1])]))),C.default=kr.parse(C.default?C.default:H.default)),C.colorSpace&&"rgb"!==C.colorSpace&&!Ts[C.colorSpace])throw new Error(`Unknown color space: ${C.colorSpace}`);let ue,de,_e;if("exponential"===he)ue=mo;else if("interval"===he)ue=fo;else if("categorical"===he){ue=po,de=Object.create(null);for(const H of C.stops)de[H[0]]=H[1];_e=typeof C.stops[0][0]}else{if("identity"!==he)throw new Error(`Unknown function type "${he}"`);ue=_o}if(le){const te={},le=[];for(let H=0;H<C.stops.length;H++){const ce=C.stops[H],he=ce[0].zoom;void 0===te[he]&&(te[he]={zoom:he,type:C.type,property:C.property,default:C.default,stops:[]},le.push(he)),te[he].stops.push([ce[0].value,ce[1]])}const ce=[];for(const C of le)ce.push([te[C].zoom,ho(te[C],H)]);const he={name:"linear"};return{kind:"composite",interpolationType:he,interpolationFactor:Es.interpolationFactor.bind(void 0,he),zoomStops:ce.map((C=>C[0])),evaluate:({zoom:te},le)=>mo({stops:ce,base:C.base},H,te).evaluate(te,le)}}if(ce){const te="exponential"===he?{name:"exponential",base:void 0!==C.base?C.base:1}:null;return{kind:"camera",interpolationType:te,interpolationFactor:Es.interpolationFactor.bind(void 0,te),zoomStops:C.stops.map((C=>C[0])),evaluate:({zoom:te})=>ue(C,H,te,de,_e)}}return{kind:"source",evaluate(te,le){const ce=le&&le.properties?le.properties[C.property]:void 0;return void 0===ce?uo(C.default,H.default):ue(C,H,ce,de,_e)}}}function uo(C,H,te){return void 0!==C?C:void 0!==H?H:void 0!==te?te:void 0}function po(C,H,te,le,ce){return uo(typeof te===ce?le[te]:void 0,C.default,H.default)}function fo(C,H,te){if("number"!==Mi(te))return uo(C.default,H.default);const le=C.stops.length;if(1===le)return C.stops[0][1];if(te<=C.stops[0][0])return C.stops[0][1];if(te>=C.stops[le-1][0])return C.stops[le-1][1];const ce=Zr(C.stops.map((C=>C[0])),te);return C.stops[ce][1]}function mo(C,H,te){const le=void 0!==C.base?C.base:1;if("number"!==Mi(te))return uo(C.default,H.default);const ce=C.stops.length;if(1===ce)return C.stops[0][1];if(te<=C.stops[0][0])return C.stops[0][1];if(te>=C.stops[ce-1][0])return C.stops[ce-1][1];const he=Zr(C.stops.map((C=>C[0])),te),ue=function(C,H,te,le){const ce=le-te,he=C-te;return 0===ce?0:1===H?he/ce:(Math.pow(H,he)-1)/(Math.pow(H,ce)-1)}(te,le,C.stops[he][0],C.stops[he+1][0]),de=C.stops[he][1],_e=C.stops[he+1][1];let ye=Fn[H.type]||co;if(C.colorSpace&&"rgb"!==C.colorSpace){const H=Ts[C.colorSpace];ye=(C,te)=>H.reverse(H.interpolate(H.forward(C),H.forward(te),ue))}return"function"==typeof de.evaluate?{evaluate(...C){const H=de.evaluate.apply(void 0,C),te=_e.evaluate.apply(void 0,C);if(void 0!==H&&void 0!==te)return ye(H,te,ue)}}:ye(de,_e,ue)}function _o(C,H,te){return"color"===H.type?te=kr.parse(te):"formatted"===H.type?te=ui.fromString(te.toString()):"resolvedImage"===H.type?te=di.fromString(te.toString()):Mi(te)===H.type||"enum"===H.type&&H.values[te]||(te=void 0),uo(te,C.default,H.default)}class go{constructor(C,H,te){this.expression=C,this._warningHistory={},this._evaluator=new en(te),this._defaultValue=H?function(C){return"color"===C.type&&(lo(C.default)||Array.isArray(C.default))?new kr(0,0,0,0):"color"===C.type?kr.parse(C.default)||null:void 0===C.default?null:C.default}(H):null,this._enumValues=H&&"enum"===H.type?H.values:null}evaluateWithoutErrorHandling(C,H,te,le,ce,he,ue,de){return this._evaluator.globals=C,this._evaluator.feature=H,this._evaluator.featureState=te,this._evaluator.canonical=le||null,this._evaluator.availableImages=ce||null,this._evaluator.formattedSection=he,this._evaluator.featureTileCoord=ue||null,this._evaluator.featureDistanceData=de||null,this.expression.evaluate(this._evaluator)}evaluate(C,H,te,le,ce,he,ue,de){this._evaluator.globals=C,this._evaluator.feature=H||null,this._evaluator.featureState=te||null,this._evaluator.canonical=le||null,this._evaluator.availableImages=ce||null,this._evaluator.formattedSection=he||null,this._evaluator.featureTileCoord=ue||null,this._evaluator.featureDistanceData=de||null;try{const C=this.expression.evaluate(this._evaluator);if(null==C||"number"==typeof C&&C!=C)return this._defaultValue;if(this._enumValues&&!(C in this._enumValues))throw new Gr(`Expected value to be one of ${Object.keys(this._enumValues).map((C=>JSON.stringify(C))).join(", ")}, but found ${JSON.stringify(C)} instead.`);return C}catch(C){return this._warningHistory[C.message]||(this._warningHistory[C.message]=!0,"undefined"!=typeof console&&console.warn(C.message)),this._defaultValue}}}function yo(C){return Array.isArray(C)&&C.length>0&&"string"==typeof C[0]&&C[0]in fl}function xo(C,H,te){const le=new Pn(fl,[],H?function(C){const H={color:Gi,string:ki,number:Pi,enum:ki,boolean:Li,formatted:nr,resolvedImage:or};return"array"===C.type?Xt(H[C.value]||ir,C.length):H[C.type]}(H):void 0,void 0,void 0,te),ce=le.parse(C,void 0,void 0,void 0,H&&"string"===H.type?{typeAnnotation:"coerce"}:void 0);return ce?to(new go(ce,H,te)):io(le.errors)}class vo{constructor(C,H,te){this.kind=C,this._styleExpression=H,this.isLightConstant=te,this.isStateDependent="constant"!==C&&!Br(H.expression),this.isConfigDependent=!Fr(H.expression)}evaluateWithoutErrorHandling(C,H,te,le,ce,he){return this._styleExpression.evaluateWithoutErrorHandling(C,H,te,le,ce,he)}evaluate(C,H,te,le,ce,he){return this._styleExpression.evaluate(C,H,te,le,ce,he)}}class bo{constructor(C,H,te,le,ce){this.kind=C,this.zoomStops=te,this._styleExpression=H,this.isStateDependent="camera"!==C&&!Br(H.expression),this.isLightConstant=ce,this.isConfigDependent=!Fr(H.expression),this.interpolationType=le}evaluateWithoutErrorHandling(C,H,te,le,ce,he){return this._styleExpression.evaluateWithoutErrorHandling(C,H,te,le,ce,he)}evaluate(C,H,te,le,ce,he){return this._styleExpression.evaluate(C,H,te,le,ce,he)}interpolationFactor(C,H,te){return this.interpolationType?Es.interpolationFactor(this.interpolationType,C,H,te):0}}function wo(C,H,te){if("error"===(C=xo(C,H,te)).result)return C;const le=C.value.expression,ce=Or(le);if(!ce&&!no(H))return io([new Ii("","data expressions not supported")]);const he=Nr(le,["zoom","pitch","distance-from-center"]);if(!he&&!so(H))return io([new Ii("","zoom expressions not supported")]);const ue=Nr(le,["measure-light"]);if(!ue&&!oo(H))return io([new Ii("","measure-light expression not supported")]);const de=H.expression&&H.expression.relaxZoomRestriction,_e=Eo(le);return _e||he||de?_e instanceof Ii?io([_e]):_e instanceof Es&&!ao(H)?io([new Ii("",'"interpolate" expressions cannot be used with this property')]):to(_e?new bo(ce?"camera":"composite",C.value,_e.labels,_e instanceof Es?_e.interpolation:void 0,ue):new vo(ce?"constant":"source",C.value,ue)):io([new Ii("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class To{constructor(C,H){this._parameters=C,this._specification=H,Pt(this,ho(this._parameters,this._specification))}static deserialize(C){return new To(C._parameters,C._specification)}static serialize(C){return{_parameters:C._parameters,_specification:C._specification}}}function Eo(C){let H=null;if(C instanceof As)H=Eo(C.result);else if(C instanceof Ss){for(const te of C.args)if(H=Eo(te),H)break}else(C instanceof Ln||C instanceof Es)&&C.input instanceof tn&&"zoom"===C.input.name&&(H=C);return H instanceof Ii||C.eachChild((C=>{const te=Eo(C);te instanceof Ii?H=te:H&&te&&H!==te&&(H=new Ii("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))})),H}function Mo(C){const H=C.key,te=C.value,le=C.valueSpec||{},ce=C.objectElementValidators||{},he=C.style,ue=C.styleSpec;let de=[];const _e=Mi(te);if("object"!==_e)return[new zt(H,te,`object expected, ${_e} found`)];for(const C in te){const _e=C.split(".")[0];let ye;ce[_e]?ye=ce[_e]:le[_e]?ye=as:ce["*"]?ye=ce["*"]:le["*"]&&(ye=as),ye?de=de.concat(ye({key:(H?`${H}.`:H)+C,value:te[C],valueSpec:le[_e]||le["*"],style:he,styleSpec:ue,object:te,objectKey:C},te)):de.push(new Dt(H,te[C],`unknown property "${C}"`))}for(const C in le)ce[C]||le[C].required&&void 0===le[C].default&&void 0===te[C]&&de.push(new zt(H,te,`missing required property "${C}"`));return de}function Ao(C){const H=C.value,te=C.valueSpec,le=C.style,ce=C.styleSpec,he=C.key,ue=C.arrayElementValidator||as;if("array"!==Mi(H))return[new zt(he,H,`array expected, ${Mi(H)} found`)];if(te.length&&H.length!==te.length)return[new zt(he,H,`array length ${te.length} expected, length ${H.length} found`)];if(te["min-length"]&&H.length<te["min-length"])return[new zt(he,H,`array length at least ${te["min-length"]} expected, length ${H.length} found`)];let de={type:te.value,values:te.values,minimum:te.minimum,maximum:te.maximum,function:void 0};ce.$version<7&&(de.function=te.function),"object"===Mi(te.value)&&(de=te.value);let _e=[];for(let C=0;C<H.length;C++)_e=_e.concat(ue({array:H,arrayIndex:C,value:H[C],valueSpec:de,style:le,styleSpec:ce,key:`${he}[${C}]`},!0));return _e}function So(C){const H=C.key,te=C.value,le=C.valueSpec;let ce=Mi(te);if("number"===ce&&te!=te&&(ce="NaN"),"number"!==ce)return[new zt(H,te,`number expected, ${ce} found`)];if("minimum"in le){let ce=le.minimum;if("array"===Mi(le.minimum)&&(ce=le.minimum[C.arrayIndex]),te<ce)return[new zt(H,te,`${te} is less than the minimum value ${ce}`)]}if("maximum"in le){let ce=le.maximum;if("array"===Mi(le.maximum)&&(ce=le.maximum[C.arrayIndex]),te>ce)return[new zt(H,te,`${te} is greater than the maximum value ${ce}`)]}return[]}function Io(C){const H=C.valueSpec,te=Rt(C.value.type);let le,ce,he,ue={};const de="categorical"!==te&&void 0===C.value.property,_e=!de,ye="array"===Mi(C.value.stops)&&"array"===Mi(C.value.stops[0])&&"object"===Mi(C.value.stops[0][0]),ve=Mo({key:C.key,value:C.value,valueSpec:C.styleSpec.function,style:C.style,styleSpec:C.styleSpec,objectElementValidators:{stops:function(C){if("identity"===te)return[new zt(C.key,C.value,'identity function may not have a "stops" property')];let H=[];const le=C.value;return H=H.concat(Ao({key:C.key,value:le,valueSpec:C.valueSpec,style:C.style,styleSpec:C.styleSpec,arrayElementValidator:u})),"array"===Mi(le)&&0===le.length&&H.push(new zt(C.key,le,"array must have at least one stop")),H},default:function(C){return as({key:C.key,value:C.value,valueSpec:H,style:C.style,styleSpec:C.styleSpec})}}});return"identity"===te&&de&&ve.push(new zt(C.key,C.value,'missing required property "property"')),"identity"===te||C.value.stops||ve.push(new zt(C.key,C.value,'missing required property "stops"')),"exponential"===te&&C.valueSpec.expression&&!ao(C.valueSpec)&&ve.push(new zt(C.key,C.value,"exponential functions not supported")),C.styleSpec.$version>=8&&(_e&&!no(C.valueSpec)?ve.push(new zt(C.key,C.value,"property functions not supported")):de&&!so(C.valueSpec)&&ve.push(new zt(C.key,C.value,"zoom functions not supported"))),"categorical"!==te&&!ye||void 0!==C.value.property||ve.push(new zt(C.key,C.value,'"property" property is required')),ve;function u(C){let te=[];const le=C.value,de=C.key;if("array"!==Mi(le))return[new zt(de,le,`array expected, ${Mi(le)} found`)];if(2!==le.length)return[new zt(de,le,`array length 2 expected, length ${le.length} found`)];if(ye){if("object"!==Mi(le[0]))return[new zt(de,le,`object expected, ${Mi(le[0])} found`)];if(void 0===le[0].zoom)return[new zt(de,le,"object stop key must have zoom")];if(void 0===le[0].value)return[new zt(de,le,"object stop key must have value")];const H=Rt(le[0].zoom);if("number"!=typeof H)return[new zt(de,le[0].zoom,"stop zoom values must be numbers")];if(he&&he>H)return[new zt(de,le[0].zoom,"stop zoom values must appear in ascending order")];H!==he&&(he=H,ce=void 0,ue={}),te=te.concat(Mo({key:`${de}[0]`,value:le[0],valueSpec:{zoom:{}},style:C.style,styleSpec:C.styleSpec,objectElementValidators:{zoom:So,value:d}}))}else te=te.concat(d({key:`${de}[0]`,value:le[0],valueSpec:{},style:C.style,styleSpec:C.styleSpec},le));return yo(Lt(le[1]))?te.concat([new zt(`${de}[1]`,le[1],"expressions are not allowed in function stops.")]):te.concat(as({key:`${de}[1]`,value:le[1],valueSpec:H,style:C.style,styleSpec:C.styleSpec}))}function d(C,he){const de=Mi(C.value),_e=Rt(C.value),ye=null!==C.value?C.value:he;if(le){if(de!==le)return[new zt(C.key,ye,`${de} stop domain type must match previous stop domain type ${le}`)]}else le=de;if("number"!==de&&"string"!==de&&"boolean"!==de&&"number"!=typeof _e&&"string"!=typeof _e&&"boolean"!=typeof _e)return[new zt(C.key,ye,"stop domain value must be a number, string, or boolean")];if("number"!==de&&"categorical"!==te){let le=`number expected, ${de} found`;return no(H)&&void 0===te&&(le+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new zt(C.key,ye,le)]}return"categorical"!==te||"number"!==de||"number"==typeof _e&&isFinite(_e)&&Math.floor(_e)===_e?"categorical"!==te&&"number"===de&&"number"==typeof _e&&"number"==typeof ce&&void 0!==ce&&_e<ce?[new zt(C.key,ye,"stop domain values must appear in ascending order")]:(ce=_e,"categorical"===te&&_e in ue?[new zt(C.key,ye,"stop domain values must be unique")]:(ue[_e]=!0,[])):[new zt(C.key,ye,`integer expected, found ${String(_e)}`)]}}function Co(C){const H=("property"===C.expressionContext?wo:xo)(Lt(C.value),C.valueSpec);if("error"===H.result)return H.value.map((H=>new zt(`${C.key}${H.key}`,C.value,H.message)));const te=H.value.expression||H.value._styleExpression.expression;if("property"===C.expressionContext&&"text-font"===C.propertyKey&&!te.outputDefined())return[new zt(C.key,C.value,`Invalid data expression for "${C.propertyKey}". Output values must be contained as literals within the expression.`)];if("property"===C.expressionContext&&"layout"===C.propertyType&&!Br(te))return[new zt(C.key,C.value,'"feature-state" data expressions are not supported with layout properties.')];if("filter"===C.expressionContext)return zo(te,C);if(C.expressionContext&&0===C.expressionContext.indexOf("cluster")){if(!Nr(te,["zoom","feature-state"]))return[new zt(C.key,C.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if("cluster-initial"===C.expressionContext&&!Or(te))return[new zt(C.key,C.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function zo(C,H){const te=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(H.valueSpec&&H.valueSpec.expression)for(const C of H.valueSpec.expression.parameters)te.delete(C);if(0===te.size)return[];const le=[];return C instanceof tn&&te.has(C.name)?[new zt(H.key,H.value,`["${C.name}"] expression is not supported in a filter for a ${H.object.type} layer with id: ${H.object.id}`)]:(C.eachChild((C=>{le.push(...zo(C,H))})),le)}function Do(C){const H=C.key,te=C.value,le=C.valueSpec,ce=[];return Array.isArray(le.values)?-1===le.values.indexOf(Rt(te))&&ce.push(new zt(H,te,`expected one of [${le.values.join(", ")}], ${JSON.stringify(te)} found`)):-1===Object.keys(le.values).indexOf(Rt(te))&&ce.push(new zt(H,te,`expected one of [${Object.keys(le.values).join(", ")}], ${JSON.stringify(te)} found`)),ce}function Po(C){if(!0===C||!1===C)return!0;if(!Array.isArray(C)||0===C.length)return!1;switch(C[0]){case"has":return C.length>=2&&"$id"!==C[1]&&"$type"!==C[1];case"in":return C.length>=3&&("string"!=typeof C[1]||Array.isArray(C[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return 3!==C.length||Array.isArray(C[1])||Array.isArray(C[2]);case"any":case"all":for(const H of C.slice(1))if(!Po(H)&&"boolean"!=typeof H)return!1;return!0;default:return!0}}function Ro(C,H="fill"){if(null==C)return{filter:()=>!0,needGeometry:!1,needFeature:!1};Po(C)||(C=Uo(C));const te=C;let le=!0;try{le=function(C){if(!Oo(C))return C;let H=Lt(C);return ko(H),H=Lo(H),H}(te)}catch(C){console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.\nThis is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md\nand paste the contents of this message in the report.\nThank you!\nFilter Expression:\n${JSON.stringify(te,null,2)}\n        `)}const ce=Ai[`filter_${H}`],he=xo(le,ce);let ue=null;if("error"===he.result)throw new Error(he.value.map((C=>`${C.key}: ${C.message}`)).join(", "));ue=(C,H,te)=>he.value.evaluate(C,H,{},te);let de=null,_e=null;if(le!==te){const C=xo(te,ce);if("error"===C.result)throw new Error(C.value.map((C=>`${C.key}: ${C.message}`)).join(", "));de=(H,te,le,ce,he)=>C.value.evaluate(H,te,{},le,void 0,void 0,ce,he),_e=!Or(C.value.expression)}return{filter:ue,dynamicFilter:de||void 0,needGeometry:No(le),needFeature:!!_e}}function Lo(C){if(!Array.isArray(C))return C;const H=function(C){if(ml.has(C[0]))for(let H=1;H<C.length;H++)if(Oo(C[H]))return!0;return C}(C);return!0===H?H:H.map((C=>Lo(C)))}function ko(C){let H=!1;const te=[];if("case"===C[0]){for(let le=1;le<C.length-1;le+=2)H=H||Oo(C[le]),te.push(C[le+1]);te.push(C[C.length-1])}else if("match"===C[0]){H=H||Oo(C[1]);for(let H=2;H<C.length-1;H+=2)te.push(C[H+1]);te.push(C[C.length-1])}else if("step"===C[0]){H=H||Oo(C[1]);for(let H=1;H<C.length-1;H+=2)te.push(C[H+1])}H&&(C.length=0,C.push("any",...te));for(let H=1;H<C.length;H++)ko(C[H])}function Oo(C){if(!Array.isArray(C))return!1;if("pitch"===(H=C[0])||"distance-from-center"===H)return!0;var H;for(let H=1;H<C.length;H++)if(Oo(C[H]))return!0;return!1}const ml=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function Fo(C,H){return C<H?-1:C>H?1:0}function No(C){if(!Array.isArray(C))return!1;if("within"===C[0]||"distance"===C[0])return!0;for(let H=1;H<C.length;H++)if(No(C[H]))return!0;return!1}function Uo(C){if(!C)return!0;const H=C[0];return C.length<=1?"any"!==H:"=="===H?Vo(C[1],C[2],"=="):"!="===H?qo(Vo(C[1],C[2],"==")):"<"===H||">"===H||"<="===H||">="===H?Vo(C[1],C[2],H):"any"===H?(te=C.slice(1),["any"].concat(te.map(Uo))):"all"===H?["all"].concat(C.slice(1).map(Uo)):"none"===H?["all"].concat(C.slice(1).map(Uo).map(qo)):"in"===H?jo(C[1],C.slice(2)):"!in"===H?qo(jo(C[1],C.slice(2))):"has"===H?Go(C[1]):"!has"!==H||qo(Go(C[1]));var te}function Vo(C,H,te){switch(C){case"$type":return[`filter-type-${te}`,H];case"$id":return[`filter-id-${te}`,H];default:return[`filter-${te}`,C,H]}}function jo(C,H){if(0===H.length)return!1;switch(C){case"$type":return["filter-type-in",["literal",H]];case"$id":return["filter-id-in",["literal",H]];default:return H.length>200&&!H.some((C=>typeof C!=typeof H[0]))?["filter-in-large",C,["literal",H.sort(Fo)]]:["filter-in-small",C,["literal",H]]}}function Go(C){switch(C){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",C]}}function qo(C){return["!",C]}function Zo(C){return Po(Lt(C.value))?Co(Pt({},C,{expressionContext:"filter",valueSpec:C.styleSpec[`filter_${C.layerType||"fill"}`]})):$o(C)}function $o(C){const H=C.value,te=C.key;if("array"!==Mi(H))return[new zt(te,H,`array expected, ${Mi(H)} found`)];const le=C.styleSpec;let ce,he=[];if(H.length<1)return[new zt(te,H,"filter array must have at least 1 element")];switch(he=he.concat(Do({key:`${te}[0]`,value:H[0],valueSpec:le.filter_operator,style:C.style,styleSpec:C.styleSpec})),Rt(H[0])){case"<":case"<=":case">":case">=":H.length>=2&&"$type"===Rt(H[1])&&he.push(new zt(te,H,`"$type" cannot be use with operator "${H[0]}"`));case"==":case"!=":3!==H.length&&he.push(new zt(te,H,`filter array for operator "${H[0]}" must have 3 elements`));case"in":case"!in":H.length>=2&&(ce=Mi(H[1]),"string"!==ce&&he.push(new zt(`${te}[1]`,H[1],`string expected, ${ce} found`)));for(let ue=2;ue<H.length;ue++)ce=Mi(H[ue]),"$type"===Rt(H[1])?he=he.concat(Do({key:`${te}[${ue}]`,value:H[ue],valueSpec:le.geometry_type,style:C.style,styleSpec:C.styleSpec})):"string"!==ce&&"number"!==ce&&"boolean"!==ce&&he.push(new zt(`${te}[${ue}]`,H[ue],`string, number, or boolean expected, ${ce} found`));break;case"any":case"all":case"none":for(let le=1;le<H.length;le++)he=he.concat($o({key:`${te}[${le}]`,value:H[le],style:C.style,styleSpec:C.styleSpec}));break;case"has":case"!has":ce=Mi(H[1]),2!==H.length?he.push(new zt(te,H,`filter array for "${H[0]}" operator must have 2 elements`)):"string"!==ce&&he.push(new zt(`${te}[1]`,H[1],`string expected, ${ce} found`))}return he}function Ho(C,H){const te=C.key,le=C.style,ce=C.layer,he=C.styleSpec,ue=C.value,de=C.objectKey,_e=he[`${H}_${C.layerType}`];if(!_e)return[];const ye=de.match(/^(.*)-transition$/);if("paint"===H&&ye&&_e[ye[1]]&&_e[ye[1]].transition)return as({key:te,value:ue,valueSpec:he.transition,style:le,styleSpec:he});const ve=C.valueSpec||_e[de];if(!ve)return[new Dt(te,ue,`unknown property "${de}"`)];let Me;if("string"===Mi(ue)&&no(ve)&&!ve.tokens&&(Me=/^{([^}]+)}$/.exec(ue))){const C=`\`{ "type": "identity", "property": ${Me?JSON.stringify(Me[1]):'"_"'} }\``;return[new zt(te,ue,`"${de}" does not support interpolation syntax\nUse an identity property function instead: ${C}.`)]}const Se=[];if("symbol"===C.layerType)"text-field"!==de||!le||le.glyphs||le.imports||Se.push(new zt(te,ue,'use of "text-field" requires a style "glyphs" property')),"text-font"===de&&lo(Lt(ue))&&"identity"===Rt(ue.type)&&Se.push(new zt(te,ue,'"text-font" does not support identity functions'));else if("model"===C.layerType&&"paint"===H&&ce&&ce.layout&&ce.layout.hasOwnProperty("model-id")&&no(ve)&&(oo(ve)||so(ve))){const C=wo(Lt(ue),ve),H=C.value.expression||C.value._styleExpression.expression;H&&!Nr(H,["measure-light"])&&Se.push(new zt(te,ue,`${de} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`))}return Se.concat(as({key:C.key,value:ue,valueSpec:ve,style:le,styleSpec:he,expressionContext:"property",propertyType:H,propertyKey:de}))}function Wo(C){return Ho(C,"paint")}function Xo(C){return Ho(C,"layout")}function Yo(C){let H=[];const te=C.value,le=C.key,ce=C.style,he=C.styleSpec;te.type||te.ref||H.push(new zt(le,te,'either "type" or "ref" is required'));let ue=Rt(te.type);const de=Rt(te.ref);if(te.id){const he=Rt(te.id);for(let ue=0;ue<C.arrayIndex;ue++){const C=ce.layers[ue];Rt(C.id)===he&&H.push(new zt(le,te.id,`duplicate layer id "${te.id}", previously used at line ${C.id.__line__}`))}}if("ref"in te){let C;["type","source","source-layer","filter","layout"].forEach((C=>{C in te&&H.push(new zt(le,te[C],`"${C}" is prohibited for ref layers`))})),ce.layers.forEach((H=>{Rt(H.id)===de&&(C=H)})),C?C.ref?H.push(new zt(le,te.ref,"ref cannot reference another ref layer")):ue=Rt(C.type):"string"==typeof de&&H.push(new zt(le,te.ref,`ref layer "${de}" not found`))}else if("background"!==ue&&"sky"!==ue&&"slot"!==ue)if(te.source){const C=ce.sources&&ce.sources[te.source],he=C&&Rt(C.type);C?"vector"===he&&"raster"===ue?H.push(new zt(le,te.source,`layer "${te.id}" requires a raster source`)):"raster"===he&&"raster"!==ue?H.push(new zt(le,te.source,`layer "${te.id}" requires a vector source`)):"vector"!==he||te["source-layer"]?"raster-dem"===he&&"hillshade"!==ue?H.push(new zt(le,te.source,"raster-dem source can only be used with layer type 'hillshade'.")):"line"!==ue||!te.paint||!te.paint["line-gradient"]&&!te.paint["line-trim-offset"]||"geojson"===he&&C.lineMetrics||H.push(new zt(le,te,`layer "${te.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):H.push(new zt(le,te,`layer "${te.id}" must specify a "source-layer"`)):H.push(new zt(le,te.source,`source "${te.source}" not found`))}else H.push(new zt(le,te,'missing required property "source"'));return H=H.concat(Mo({key:le,value:te,valueSpec:he.layer,style:C.style,styleSpec:C.styleSpec,objectElementValidators:{"*":()=>[],type:()=>as({key:`${le}.type`,value:te.type,valueSpec:he.layer.type,style:C.style,styleSpec:C.styleSpec,object:te,objectKey:"type"}),filter:C=>Zo(Pt({layerType:ue},C)),layout:C=>Mo({layer:te,key:C.key,value:C.value,valueSpec:{},style:C.style,styleSpec:C.styleSpec,objectElementValidators:{"*":C=>Xo(Pt({layerType:ue},C))}}),paint:C=>Mo({layer:te,key:C.key,value:C.value,valueSpec:{},style:C.style,styleSpec:C.styleSpec,objectElementValidators:{"*":C=>Wo(Pt({layerType:ue,layer:te},C))}})}})),H}function Ko(C){const H=C.value,te=C.key,le=Mi(H);return"string"!==le?[new zt(te,H,`string expected, ${le} found`)]:[]}const _l={promoteId:function({key:C,value:H}){if("string"===Mi(H))return Ko({key:C,value:H});{const te=[];for(const le in H)te.push(...Ko({key:`${C}.${le}`,value:H[le]}));return te}}};function Qo(C){const H=C.value,te=C.key,le=C.styleSpec,ce=C.style;if(!H.type)return[new zt(te,H,'"type" is required')];const he=Rt(H.type);let ue;switch(he){case"vector":case"raster":case"raster-dem":return ue=Mo({key:te,value:H,valueSpec:le[`source_${he.replace("-","_")}`],style:C.style,styleSpec:le,objectElementValidators:_l}),ue;case"geojson":if(ue=Mo({key:te,value:H,valueSpec:le.source_geojson,style:ce,styleSpec:le,objectElementValidators:_l}),H.cluster)for(const C in H.clusterProperties){const[le,ce]=H.clusterProperties[C],he="string"==typeof le?[le,["accumulated"],["get",C]]:le;ue.push(...Co({key:`${te}.${C}.map`,value:ce,expressionContext:"cluster-map"})),ue.push(...Co({key:`${te}.${C}.reduce`,value:he,expressionContext:"cluster-reduce"}))}return ue;case"video":return Mo({key:te,value:H,valueSpec:le.source_video,style:ce,styleSpec:le});case"image":return Mo({key:te,value:H,valueSpec:le.source_image,style:ce,styleSpec:le});case"canvas":return[new zt(te,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return Do({key:`${te}.type`,value:H.type,valueSpec:{values:es(le)},style:ce,styleSpec:le})}}function es(C){return C.source.reduce(((H,te)=>{const le=C[te];return"enum"===le.type.type&&(H=H.concat(Object.keys(le.type.values))),H}),[])}function ts(C){const H=C.value;let te=[];if(!H)return te;const le=Mi(H);return"string"!==le?(te=te.concat([new zt(C.key,H,`string expected, "${le}" found`)]),te):(function(C){const H=-1===C.indexOf("://");try{return new URL(C,H?"http://example.com":void 0),!0}catch(C){return!1}}(H)||(te=te.concat([new zt(C.key,H,`invalid url "${H}"`)])),te)}function is(C){const H=C.value,te=C.styleSpec,le=te.light,ce=C.style;let he=[];const ue=Mi(H);if(void 0===H)return he;if("object"!==ue)return he=he.concat([new zt("light",H,`object expected, ${ue} found`)]),he;for(const C in H){const ue=C.match(/^(.*)-transition$/);he=he.concat(ue&&le[ue[1]]&&le[ue[1]].transition?as({key:C,value:H[C],valueSpec:te.transition,style:ce,styleSpec:te}):le[C]?as({key:C,value:H[C],valueSpec:le[C],style:ce,styleSpec:te}):[new zt(C,H[C],`unknown property "${C}"`)])}return he}function rs(C){const H=C.value;let te=[];if(!H)return te;const le=Mi(H);if("object"!==le)return te=te.concat([new zt("light-3d",H,`object expected, ${le} found`)]),te;const ce=C.styleSpec,he=ce["light-3d"],ue=C.key,de=C.style,_e=C.style.lights;for(const C of["type","id"])if(!(C in H))return te=te.concat([new zt("light-3d",H,`missing property ${C} on light`)]),te;if(H.type&&_e)for(let le=0;le<C.arrayIndex;le++){const C=Rt(H.type),ce=_e[le];Rt(ce.type)===C&&te.push(new zt(ue,H.id,`duplicate light type "${H.type}", previously defined at line ${ce.id.__line__}`))}const ye=`properties_light_${H.type}`;if(!(ye in ce))return te=te.concat([new zt("light-3d",H,`Invalid light type ${H.type}`)]),te;const ve=ce[ye];for(const le in H)if("properties"===le){const he=H[le],ue=Mi(he);if("object"!==ue)return te=te.concat([new zt("properties",he,`object expected, ${ue} found`)]),te;for(const H in he)te=te.concat(ve[H]?as({key:H,value:he[H],valueSpec:ve[H],style:de,styleSpec:ce}):[new Dt(C.key,he[H],`unknown property "${H}"`)])}else{const C=le.match(/^(.*)-transition$/);te=te.concat(C&&he[C[1]]&&he[C[1]].transition?as({key:le,value:H[le],valueSpec:ce.transition,style:de,styleSpec:ce}):he[le]?as({key:le,value:H[le],valueSpec:he[le],style:de,styleSpec:ce}):[new Dt(le,H[le],`unknown property "${le}"`)])}return te}function ns(C){const H=C.value,te=C.key,le=C.style,ce=C.styleSpec,he=ce.terrain;let ue=[];const de=Mi(H);if(void 0===H)return ue;if("object"!==de)return ue=ue.concat([new zt("terrain",H,`object expected, ${de} found`)]),ue;for(const C in H){const te=C.match(/^(.*)-transition$/);ue=ue.concat(te&&he[te[1]]&&he[te[1]].transition?as({key:C,value:H[C],valueSpec:ce.transition,style:le,styleSpec:ce}):he[C]?as({key:C,value:H[C],valueSpec:he[C],style:le,styleSpec:ce}):[new Dt(C,H[C],`unknown property "${C}"`)])}if(H.source){const C=le.sources&&le.sources[H.source],ce=C&&Rt(C.type);C?"raster-dem"!==ce&&ue.push(new zt(te,H.source,`terrain cannot be used with a source of type ${String(ce)}, it only be used with a "raster-dem" source type`)):ue.push(new zt(te,H.source,`source "${H.source}" not found`))}else ue.push(new zt(te,H,'terrain is missing required property "source"'));return ue}function os(C){const H=C.value,te=C.style,le=C.styleSpec,ce=le.fog;let he=[];const ue=Mi(H);if(void 0===H)return he;if("object"!==ue)return he=he.concat([new zt("fog",H,`object expected, ${ue} found`)]),he;for(const C in H){const ue=C.match(/^(.*)-transition$/);he=he.concat(ue&&ce[ue[1]]&&ce[ue[1]].transition?as({key:C,value:H[C],valueSpec:le.transition,style:te,styleSpec:le}):ce[C]?as({key:C,value:H[C],valueSpec:ce[C],style:te,styleSpec:le}):[new Dt(C,H[C],`unknown property "${C}"`)])}return he}const gl={"*":()=>[],array:Ao,boolean:function(C){const H=C.value,te=C.key,le=Mi(H);return"boolean"!==le?[new zt(te,H,`boolean expected, ${le} found`)]:[]},number:So,color:function(C){const H=C.key,te=C.value,le=Mi(te);return"string"!==le?[new zt(H,te,`color expected, ${le} found`)]:null===lr(te)?[new zt(H,te,`color expected, "${te}" found`)]:[]},enum:Do,filter:Zo,function:Io,layer:Yo,object:Mo,source:Qo,model:ts,light:is,"light-3d":rs,terrain:ns,fog:os,string:Ko,formatted:function(C){return 0===Ko(C).length?[]:Co(C)},resolvedImage:function(C){return 0===Ko(C).length?[]:Co(C)},projection:function(C){const H=C.value,te=C.styleSpec,le=te.projection,ce=C.style;let he=[];const ue=Mi(H);if("object"===ue)for(const C in H)he=he.concat(as({key:C,value:H[C],valueSpec:le[C],style:ce,styleSpec:te}));else"string"!==ue&&(he=he.concat([new zt("projection",H,`object or string expected, ${ue} found`)]));return he},import:function(C){const{value:H,styleSpec:te}=C,{data:le,...ce}=H;Object.defineProperty(ce,"__line__",{value:H.__line__,enumerable:!1});let he=Mo(Pt({},C,{value:ce,valueSpec:te.import}));return""===Rt(ce.id)&&he.push(new zt(`${C.key}.id`,ce,"import id can't be an empty string")),le&&(he=he.concat(cs(le,te,{key:`${C.key}.data`}))),he}};function as(C,H=!1){const te=C.value,le=C.valueSpec,ce=C.styleSpec;if(le.expression&&lo(Rt(te)))return Io(C);if(le.expression&&yo(Lt(te)))return Co(C);if(le.type&&gl[le.type]){const te=gl[le.type](C);return!0===H&&te.length>0&&"array"===Mi(C.value)?Co(C):te}return Mo(Pt({},C,{valueSpec:le.type?ce[le.type]:le}))}function ls(C){const H=C.value,te=C.key,le=Ko(C);return le.length||(-1===H.indexOf("{fontstack}")&&le.push(new zt(te,H,'"glyphs" url must include a "{fontstack}" token')),-1===H.indexOf("{range}")&&le.push(new zt(te,H,'"glyphs" url must include a "{range}" token'))),le}function cs(C,H=Ai,te={}){return as({key:te.key||"",value:C,valueSpec:H.$root,styleSpec:H,style:C,objectElementValidators:{glyphs:ls,"*":()=>[]}})}function hs(C,H=Ai){return bs(cs(C,H))}const us=C=>bs(Qo(C)),ds=C=>bs(is(C)),ps=C=>bs(rs(C)),fs=C=>bs(ns(C)),ms=C=>bs(os(C)),_s=C=>bs(Yo(C)),gs=C=>bs(Zo(C)),ys=C=>bs(Wo(C)),xs=C=>bs(Xo(C)),vs=C=>bs(ts(C));function bs(C){return C.slice().sort(((C,H)=>C.line&&H.line?C.line-H.line:0))}function ws(C,H){let te=!1;if(H&&H.length)for(const le of H)le instanceof Dt?W(le.message):(C.fire(new St(new Error(le.message))),te=!0);return te}var yl=Ms,xl=3;function Ms(C,te,le){var ce=(this||H).cells=[];if(C instanceof ArrayBuffer){(this||H).arrayBuffer=C;var he=new Int32Array((this||H).arrayBuffer);C=he[0],(this||H).d=(te=he[1])+2*(le=he[2]);for(var ue=0;ue<(this||H).d*(this||H).d;ue++){var de=he[xl+ue],_e=he[xl+ue+1];ce.push(de===_e?null:he.subarray(de,_e))}var ye=he[xl+ce.length+1];(this||H).keys=he.subarray(he[xl+ce.length],ye),(this||H).bboxes=he.subarray(ye),(this||H).insert=(this||H)._insertReadonly}else{(this||H).d=te+2*le;for(var ve=0;ve<(this||H).d*(this||H).d;ve++)ce.push([]);(this||H).keys=[],(this||H).bboxes=[]}(this||H).n=te,(this||H).extent=C,(this||H).padding=le,(this||H).scale=te/C,(this||H).uid=0;var Me=le/te*C;(this||H).min=-Me,(this||H).max=C+Me}Ms.prototype.insert=function(C,te,le,ce,he){this._forEachCell(te,le,ce,he,(this||H)._insertCell,(this||H).uid++),(this||H).keys.push(C),(this||H).bboxes.push(te),(this||H).bboxes.push(le),(this||H).bboxes.push(ce),(this||H).bboxes.push(he)},Ms.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},Ms.prototype._insertCell=function(C,te,le,ce,he,ue){(this||H).cells[he].push(ue)},Ms.prototype.query=function(C,te,le,ce,he){var ue=(this||H).min,de=(this||H).max;if(C<=ue&&te<=ue&&de<=le&&de<=ce&&!he)return Array.prototype.slice.call((this||H).keys);var _e=[];return this._forEachCell(C,te,le,ce,(this||H)._queryCell,_e,{},he),_e},Ms.prototype._queryCell=function(C,te,le,ce,he,ue,de,_e){var ye=(this||H).cells[he];if(null!==ye)for(var ve=(this||H).keys,Me=(this||H).bboxes,Se=0;Se<ye.length;Se++){var Ae=ye[Se];if(void 0===de[Ae]){var Ce=4*Ae;(_e?_e(Me[Ce+0],Me[Ce+1],Me[Ce+2],Me[Ce+3]):C<=Me[Ce+2]&&te<=Me[Ce+3]&&le>=Me[Ce+0]&&ce>=Me[Ce+1])?(de[Ae]=!0,ue.push(ve[Ae])):de[Ae]=!1}}},Ms.prototype._forEachCell=function(C,te,le,ce,he,ue,de,_e){for(var ye=this._convertToCellCoord(C),ve=this._convertToCellCoord(te),Me=this._convertToCellCoord(le),Se=this._convertToCellCoord(ce),Ae=ye;Ae<=Me;Ae++)for(var Ce=ve;Ce<=Se;Ce++){var Oe=(this||H).d*Ce+Ae;if((!_e||_e(this._convertFromCellCoord(Ae),this._convertFromCellCoord(Ce),this._convertFromCellCoord(Ae+1),this._convertFromCellCoord(Ce+1)))&&he.call(this||H,C,te,le,ce,Oe,ue,de,_e))return}},Ms.prototype._convertFromCellCoord=function(C){return(C-(this||H).padding)/(this||H).scale},Ms.prototype._convertToCellCoord=function(C){return Math.max(0,Math.min((this||H).d-1,Math.floor(C*(this||H).scale)+(this||H).padding))},Ms.prototype.toArrayBuffer=function(){if((this||H).arrayBuffer)return(this||H).arrayBuffer;for(var C=(this||H).cells,te=xl+(this||H).cells.length+1+1,le=0,ce=0;ce<(this||H).cells.length;ce++)le+=(this||H).cells[ce].length;var he=new Int32Array(te+le+(this||H).keys.length+(this||H).bboxes.length);he[0]=(this||H).extent,he[1]=(this||H).n,he[2]=(this||H).padding;for(var ue=te,de=0;de<C.length;de++){var _e=C[de];he[xl+de]=ue,he.set(_e,ue),ue+=_e.length}return he[xl+C.length]=ue,he.set((this||H).keys,ue),he[xl+C.length+1]=ue+=(this||H).keys.length,he.set((this||H).bboxes,ue),ue+=(this||H).bboxes.length,he.buffer};var vl=d(yl);const bl={};function Is(C,H,te={}){Object.defineProperty(C,"_classRegistryKey",{value:H,writeable:!1}),bl[H]={klass:C,omit:te.omit||[]}}Is(Object,"Object"),vl.serialize=function(C,H){const te=C.toArrayBuffer();return H&&H.add(te),{buffer:te}},vl.deserialize=function(C){return new vl(C.buffer)},Object.defineProperty(vl,"name",{value:"Grid"}),Is(vl,"Grid"),Is(kr,"Color"),Is(Error,"Error"),Is(xe,"AJAXError"),Is(di,"ResolvedImage"),Is(To,"StylePropertyFunction"),Is(go,"StyleExpression",{omit:["_evaluator"]}),Is(bo,"ZoomDependentExpression"),Is(vo,"ZoomConstantExpression"),Is(tn,"CompoundExpression",{omit:["_evaluate"]});for(const C in fl)bl[fl[C]._classRegistryKey]||Is(fl[C],`Expression${C}`);function Cs(C){return C&&"undefined"!=typeof ArrayBuffer&&(C instanceof ArrayBuffer||C.constructor&&"ArrayBuffer"===C.constructor.name)}function zs(C){return te.ImageBitmap&&C instanceof te.ImageBitmap}function Ds(C,H){if(null==C||"boolean"==typeof C||"number"==typeof C||"string"==typeof C||C instanceof Boolean||C instanceof Number||C instanceof String||C instanceof Date||C instanceof RegExp)return C;if(Cs(C)||zs(C))return H&&H.add(C),C;if(ArrayBuffer.isView(C)){const te=C;return H&&H.add(te.buffer),te}if(C instanceof te.ImageData)return H&&H.add(C.data.buffer),C;if(Array.isArray(C)){const te=[];for(const le of C)te.push(Ds(le,H));return te}if(C instanceof Map){const H={$name:"Map"};for(const[te,le]of C.entries())H[te]=Ds(le);return H}if("object"==typeof C){const te=C.constructor,le=te._classRegistryKey;if(!le)throw new Error(`can't serialize object of unregistered class ${le}`);const ce=te.serialize?te.serialize(C,H):{};if(!te.serialize){for(const te in C)C.hasOwnProperty(te)&&(bl[le].omit.indexOf(te)>=0||(ce[te]=Ds(C[te],H)));C instanceof Error&&(ce.message=C.message)}if(ce.$name)throw new Error("$name property is reserved for worker serialization logic.");return"Object"!==le&&(ce.$name=le),ce}throw new Error("can't serialize object of type "+typeof C)}function Ps(C){if(null==C||"boolean"==typeof C||"number"==typeof C||"string"==typeof C||C instanceof Boolean||C instanceof Number||C instanceof String||C instanceof Date||C instanceof RegExp||Cs(C)||zs(C)||ArrayBuffer.isView(C)||C instanceof te.ImageData)return C;if(Array.isArray(C))return C.map(Ps);if("object"==typeof C){const H=C.$name||"Object";if("Map"===H){const H=new Map;for(const te of Object.keys(C))"$name"!==te&&H.set(te,Ps(C[te]));return H}const{klass:te}=bl[H];if(!te)throw new Error(`can't deserialize unregistered class ${H}`);if(te.deserialize)return te.deserialize(C);const le=Object.create(te.prototype);for(const H of Object.keys(C))"$name"!==H&&(le[H]=Ps(C[H]));return le}throw new Error("can't deserialize object of type "+typeof C)}const wl={"Latin-1 Supplement":C=>C>=128&&C<=255,Arabic:C=>C>=1536&&C<=1791,"Arabic Supplement":C=>C>=1872&&C<=1919,"Arabic Extended-A":C=>C>=2208&&C<=2303,"Hangul Jamo":C=>C>=4352&&C<=4607,"Unified Canadian Aboriginal Syllabics":C=>C>=5120&&C<=5759,Khmer:C=>C>=6016&&C<=6143,"Unified Canadian Aboriginal Syllabics Extended":C=>C>=6320&&C<=6399,"General Punctuation":C=>C>=8192&&C<=8303,"Letterlike Symbols":C=>C>=8448&&C<=8527,"Number Forms":C=>C>=8528&&C<=8591,"Miscellaneous Technical":C=>C>=8960&&C<=9215,"Control Pictures":C=>C>=9216&&C<=9279,"Optical Character Recognition":C=>C>=9280&&C<=9311,"Enclosed Alphanumerics":C=>C>=9312&&C<=9471,"Geometric Shapes":C=>C>=9632&&C<=9727,"Miscellaneous Symbols":C=>C>=9728&&C<=9983,"Miscellaneous Symbols and Arrows":C=>C>=11008&&C<=11263,"CJK Radicals Supplement":C=>C>=11904&&C<=12031,"Kangxi Radicals":C=>C>=12032&&C<=12255,"Ideographic Description Characters":C=>C>=12272&&C<=12287,"CJK Symbols and Punctuation":C=>C>=12288&&C<=12351,Hiragana:C=>C>=12352&&C<=12447,Katakana:C=>C>=12448&&C<=12543,Bopomofo:C=>C>=12544&&C<=12591,"Hangul Compatibility Jamo":C=>C>=12592&&C<=12687,Kanbun:C=>C>=12688&&C<=12703,"Bopomofo Extended":C=>C>=12704&&C<=12735,"CJK Strokes":C=>C>=12736&&C<=12783,"Katakana Phonetic Extensions":C=>C>=12784&&C<=12799,"Enclosed CJK Letters and Months":C=>C>=12800&&C<=13055,"CJK Compatibility":C=>C>=13056&&C<=13311,"CJK Unified Ideographs Extension A":C=>C>=13312&&C<=19903,"Yijing Hexagram Symbols":C=>C>=19904&&C<=19967,"CJK Unified Ideographs":C=>C>=19968&&C<=40959,"Yi Syllables":C=>C>=40960&&C<=42127,"Yi Radicals":C=>C>=42128&&C<=42191,"Hangul Jamo Extended-A":C=>C>=43360&&C<=43391,"Hangul Syllables":C=>C>=44032&&C<=55215,"Hangul Jamo Extended-B":C=>C>=55216&&C<=55295,"Private Use Area":C=>C>=57344&&C<=63743,"CJK Compatibility Ideographs":C=>C>=63744&&C<=64255,"Arabic Presentation Forms-A":C=>C>=64336&&C<=65023,"Vertical Forms":C=>C>=65040&&C<=65055,"CJK Compatibility Forms":C=>C>=65072&&C<=65103,"Small Form Variants":C=>C>=65104&&C<=65135,"Arabic Presentation Forms-B":C=>C>=65136&&C<=65279,"Halfwidth and Fullwidth Forms":C=>C>=65280&&C<=65519,"CJK Unified Ideographs Extension B":C=>C>=131072&&C<=173791};function Ls(C){for(const H of C)if(Bs(H.charCodeAt(0)))return!0;return!1}function ks(C){for(const H of C)if(!Os(H.charCodeAt(0)))return!1;return!0}function Os(C){return!(wl.Arabic(C)||wl["Arabic Supplement"](C)||wl["Arabic Extended-A"](C)||wl["Arabic Presentation Forms-A"](C)||wl["Arabic Presentation Forms-B"](C))}function Bs(C){return!(746!==C&&747!==C&&(C<4352||!(wl["Bopomofo Extended"](C)||wl.Bopomofo(C)||wl["CJK Compatibility Forms"](C)&&!(C>=65097&&C<=65103)||wl["CJK Compatibility Ideographs"](C)||wl["CJK Compatibility"](C)||wl["CJK Radicals Supplement"](C)||wl["CJK Strokes"](C)||!(!wl["CJK Symbols and Punctuation"](C)||C>=12296&&C<=12305||C>=12308&&C<=12319||12336===C)||wl["CJK Unified Ideographs Extension A"](C)||wl["CJK Unified Ideographs"](C)||wl["Enclosed CJK Letters and Months"](C)||wl["Hangul Compatibility Jamo"](C)||wl["Hangul Jamo Extended-A"](C)||wl["Hangul Jamo Extended-B"](C)||wl["Hangul Jamo"](C)||wl["Hangul Syllables"](C)||wl.Hiragana(C)||wl["Ideographic Description Characters"](C)||wl.Kanbun(C)||wl["Kangxi Radicals"](C)||wl["Katakana Phonetic Extensions"](C)||wl.Katakana(C)&&12540!==C||!(!wl["Halfwidth and Fullwidth Forms"](C)||65288===C||65289===C||65293===C||C>=65306&&C<=65310||65339===C||65341===C||65343===C||C>=65371&&C<=65503||65507===C||C>=65512&&C<=65519)||!(!wl["Small Form Variants"](C)||C>=65112&&C<=65118||C>=65123&&C<=65126)||wl["Unified Canadian Aboriginal Syllabics"](C)||wl["Unified Canadian Aboriginal Syllabics Extended"](C)||wl["Vertical Forms"](C)||wl["Yijing Hexagram Symbols"](C)||wl["Yi Syllables"](C)||wl["Yi Radicals"](C))))}function Fs(C){return!(Bs(C)||function(C){return!!(wl["Latin-1 Supplement"](C)&&(167===C||169===C||174===C||177===C||188===C||189===C||190===C||215===C||247===C)||wl["General Punctuation"](C)&&(8214===C||8224===C||8225===C||8240===C||8241===C||8251===C||8252===C||8258===C||8263===C||8264===C||8265===C||8273===C)||wl["Letterlike Symbols"](C)||wl["Number Forms"](C)||wl["Miscellaneous Technical"](C)&&(C>=8960&&C<=8967||C>=8972&&C<=8991||C>=8996&&C<=9e3||9003===C||C>=9085&&C<=9114||C>=9150&&C<=9165||9167===C||C>=9169&&C<=9179||C>=9186&&C<=9215)||wl["Control Pictures"](C)&&9251!==C||wl["Optical Character Recognition"](C)||wl["Enclosed Alphanumerics"](C)||wl["Geometric Shapes"](C)||wl["Miscellaneous Symbols"](C)&&!(C>=9754&&C<=9759)||wl["Miscellaneous Symbols and Arrows"](C)&&(C>=11026&&C<=11055||C>=11088&&C<=11097||C>=11192&&C<=11243)||wl["CJK Symbols and Punctuation"](C)||wl.Katakana(C)||wl["Private Use Area"](C)||wl["CJK Compatibility Forms"](C)||wl["Small Form Variants"](C)||wl["Halfwidth and Fullwidth Forms"](C)||8734===C||8756===C||8757===C||C>=9984&&C<=10087||C>=10102&&C<=10131||65532===C||65533===C)}(C))}function Ns(C){return C>=1424&&C<=2303||wl["Arabic Presentation Forms-A"](C)||wl["Arabic Presentation Forms-B"](C)}function Us(C,H){return!(!H&&Ns(C)||C>=2304&&C<=3583||C>=3840&&C<=4255||wl.Khmer(C))}function Vs(C){for(const H of C)if(Ns(H.charCodeAt(0)))return!0;return!1}const Ll="deferred",Ol="loading",Fl="loaded";let Wl=null,Yl="unavailable",Kl=null;const Ws=function(C){C&&"string"==typeof C&&C.indexOf("NetworkError")>-1&&(Yl="error"),Wl&&Wl(C)};function Xs(){ec.fire(new At("pluginStateChange",{pluginStatus:Yl,pluginURL:Kl}))}const ec=new It,Ks=function(){return Yl},Js=function(){if(Yl!==Ll||!Kl)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");Yl=Ol,Xs(),Kl&&Te({url:Kl},(C=>{C?Ws(C):(Yl=Fl,Xs())}))},tc={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>Yl===Fl||null!=tc.applyArabicShaping,isLoading:()=>Yl===Ol,setState(C){Yl=C.pluginStatus,Kl=C.pluginURL},isParsed:()=>null!=tc.applyArabicShaping&&null!=tc.processBidirectionalText&&null!=tc.processStyledBidirectionalText,getPluginURL:()=>Kl};class ea{constructor(C,H){this.zoom=C,H?(this.now=H.now,this.fadeDuration=H.fadeDuration,this.transition=H.transition,this.pitch=H.pitch,this.brightness=H.brightness):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(C){return function(C,H){for(const te of C)if(!Us(te.charCodeAt(0),H))return!1;return!0}(C,tc.isLoaded())}}class ta{constructor(C,H,te){this.property=C,this.value=H,this.expression=function(C,H,te){if(lo(C))return new To(C,H);if(yo(C)||Array.isArray(C)&&C.length>0){const le=wo(C,H,te);if("error"===le.result)throw new Error(le.value.map((C=>`${C.key}: ${C.message}`)).join(", "));return le.value}{let te=C;return"string"==typeof C&&"color"===H.type&&(te=kr.parse(C)),{kind:"constant",isConfigDependent:!1,evaluate:()=>te}}}(void 0===H?C.specification.default:H,C.specification,te)}isDataDriven(){return"source"===this.expression.kind||"composite"===this.expression.kind}possiblyEvaluate(C,H,te){return this.property.possiblyEvaluate(this,C,H,te)}}class ia{constructor(C,H){this.property=C,this.value=new ta(C,void 0,H)}transitioned(C,H){return new na(this.property,this.value,H,k({},C.transition,this.transition),C.now)}untransitioned(){return new na(this.property,this.value,null,{},0)}}class ra{constructor(C,H){this._properties=C,this._values=Object.create(C.defaultTransitionablePropertyValues),this._options=H,this.isConfigDependent=!1}getValue(C){return $(this._values[C].value.value)}setValue(C,H){this._values.hasOwnProperty(C)||(this._values[C]=new ia(this._values[C].property,this._options)),this._values[C].value=new ta(this._values[C].property,null===H?void 0:$(H),this._options),this.isConfigDependent=this.isConfigDependent||this._values[C].value.expression.isConfigDependent}setTransitionOrValue(C,H){H&&(this._options=H);const te=this._properties.properties;if(C)for(const H in C){const le=C[H];if(G(H,"-transition")){const C=H.slice(0,-11);te[C]&&this.setTransition(C,le)}else te[H]&&this.setValue(H,le)}}getTransition(C){return $(this._values[C].transition)}setTransition(C,H){this._values.hasOwnProperty(C)||(this._values[C]=new ia(this._values[C].property)),this._values[C].transition=$(H)||void 0}serialize(){const C={};for(const H of Object.keys(this._values)){const te=this.getValue(H);void 0!==te&&(C[H]=te);const le=this.getTransition(H);void 0!==le&&(C[`${H}-transition`]=le)}return C}transitioned(C,H){const te=new oa(this._properties);for(const le of Object.keys(this._values))te._values[le]=this._values[le].transitioned(C,H._values[le]);return te}untransitioned(){const C=new oa(this._properties);for(const H of Object.keys(this._values))C._values[H]=this._values[H].untransitioned();return C}}class na{constructor(C,H,te,le,ce){const he=le.delay||0,ue=le.duration||0;ce=ce||0,this.property=C,this.value=H,this.begin=ce+he,this.end=this.begin+ue,C.specification.transition&&(le.delay||le.duration)&&(this.prior=te)}possiblyEvaluate(C,H,te){const le=C.now||0,ce=this.value.possiblyEvaluate(C,H,te),he=this.prior;if(he){if(le>this.end)return this.prior=null,ce;if(this.value.isDataDriven())return this.prior=null,ce;if(le<this.begin)return he.possiblyEvaluate(C,H,te);{const ue=(le-this.begin)/(this.end-this.begin);return this.property.interpolate(he.possiblyEvaluate(C,H,te),ce,M(ue))}}return ce}}class oa{constructor(C){this._properties=C,this._values=Object.create(C.defaultTransitioningPropertyValues)}possiblyEvaluate(C,H,te){const le=new la(this._properties);for(const ce of Object.keys(this._values))le._values[ce]=this._values[ce].possiblyEvaluate(C,H,te);return le}hasTransition(){for(const C of Object.keys(this._values))if(this._values[C].prior)return!0;return!1}}class sa{constructor(C,H){this._properties=C,this._values=Object.create(C.defaultPropertyValues),this._options=H,this.isConfigDependent=!1}getValue(C){return $(this._values[C].value)}setValue(C,H){this._values[C]=new ta(this._values[C].property,null===H?void 0:$(H),this._options),this.isConfigDependent=this.isConfigDependent||this._values[C].expression.isConfigDependent}serialize(){const C={};for(const H of Object.keys(this._values)){const te=this.getValue(H);void 0!==te&&(C[H]=te)}return C}possiblyEvaluate(C,H,te){const le=new la(this._properties);for(const ce of Object.keys(this._values))le._values[ce]=this._values[ce].possiblyEvaluate(C,H,te);return le}}class aa{constructor(C,H,te){this.property=C,this.value=H,this.parameters=te}isConstant(){return"constant"===this.value.kind}constantOr(C){return"constant"===this.value.kind?this.value.value:C}evaluate(C,H,te,le){return this.property.evaluate(this.value,this.parameters,C,H,te,le)}}class la{constructor(C){this._properties=C,this._values=Object.create(C.defaultPossiblyEvaluatedValues)}get(C){return this._values[C]}}class ca{constructor(C){this.specification=C}possiblyEvaluate(C,H){return C.expression.evaluate(H)}interpolate(C,H,te){const le=Fn[this.specification.type];return le?le(C,H,te):C}}class ha{constructor(C,H){this.specification=C,this.overrides=H}possiblyEvaluate(C,H,te,le){return new aa(this,"constant"===C.expression.kind||"camera"===C.expression.kind?{kind:"constant",value:C.expression.evaluate(H,null,{},te,le)}:C.expression,H)}interpolate(C,H,te){if("constant"!==C.value.kind||"constant"!==H.value.kind)return C;if(void 0===C.value.value||void 0===H.value.value)return new aa(this,{kind:"constant",value:void 0},C.parameters);const le=Fn[this.specification.type];return le?new aa(this,{kind:"constant",value:le(C.value.value,H.value.value,te)},C.parameters):C}evaluate(C,H,te,le,ce,he){return"constant"===C.kind?C.value:C.evaluate(H,te,le,ce,he)}}class ua{constructor(C){this.specification=C}possiblyEvaluate(C,H,te,le){return!!C.expression.evaluate(H,null,{},te,le)}interpolate(){return!1}}class da{constructor(C){this.properties=C,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const H=new ea(0,{});for(const te in C){const le=C[te];le.specification.overridable&&this.overridableProperties.push(te);const ce=this.defaultPropertyValues[te]=new ta(le,void 0),he=this.defaultTransitionablePropertyValues[te]=new ia(le);this.defaultTransitioningPropertyValues[te]=he.untransitioned(),this.defaultPossiblyEvaluatedValues[te]=ce.possiblyEvaluate(H)}}}function pa(C,H){return H?`${C}${H}`:C}function fa(C){const H=C.indexOf("");return H>=0?C.slice(0,H):C}Is(ha,"DataDrivenProperty"),Is(ca,"DataConstantProperty"),Is(ua,"ColorRampProperty");const ic="-transition";class _a extends It{constructor(C,H,te){if(super(),this.id=C.id,this.type=C.type,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.isConfigDependent=!1,"custom"!==C.type&&(this.metadata=C.metadata,this.minzoom=C.minzoom,this.maxzoom=C.maxzoom,"background"!==C.type&&"sky"!==C.type&&"slot"!==C.type&&(this.source=C.source,this.sourceLayer=C["source-layer"],this.filter=C.filter),this.options=te,C.slot&&(this.slot=C.slot),H.layout&&(this._unevaluatedLayout=new sa(H.layout,te),this.isConfigDependent=this.isConfigDependent||this._unevaluatedLayout.isConfigDependent),H.paint)){this._transitionablePaint=new ra(H.paint,te);for(const H in C.paint)this.setPaintProperty(H,C.paint[H],{validate:!1});for(const H in C.layout)this.setLayoutProperty(H,C.layout[H],{validate:!1});this.isConfigDependent=this.isConfigDependent||this._transitionablePaint.isConfigDependent,this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new la(H.paint)}}setScope(C){this.scope=C,this.fqid=pa(this.id,C)}getLayoutProperty(C){return"visibility"===C?this.visibility:this._unevaluatedLayout.getValue(C)}setLayoutProperty(C,H,te={}){if(null!=H&&this._validate(xs,`layers.${this.id}.layout.${C}`,C,H,te))return;if("custom"===this.type&&"visibility"===C)return void(this.visibility=H);const le=this._unevaluatedLayout;le._properties.properties[C]&&(le.setValue(C,H),this.isConfigDependent=this.isConfigDependent||le.isConfigDependent,"visibility"===C&&this.possiblyEvaluateVisibility())}possiblyEvaluateVisibility(){this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0})}getPaintProperty(C){return G(C,ic)?this._transitionablePaint.getTransition(C.slice(0,-11)):this._transitionablePaint.getValue(C)}setPaintProperty(C,H,te={}){if(null!=H&&this._validate(ys,`layers.${this.id}.paint.${C}`,C,H,te))return!1;const le=this._transitionablePaint,ce=le._properties.properties;if(G(C,ic)){const te=C.slice(0,-11);return ce[te]&&le.setTransition(te,H||void 0),!1}if(!ce[C])return!1;const he=le._values[C],ue=he.value.isDataDriven(),de=he.value;le.setValue(C,H),this.isConfigDependent=this.isConfigDependent||le.isConfigDependent,this._handleSpecialPaintPropertyUpdate(C);const _e=le._values[C].value,ye=_e.isDataDriven(),ve=G(C,"pattern")||"line-dasharray"===C;return ye||ue||ve||this._handleOverridablePaintPropertyUpdate(C,de,_e)}_handleSpecialPaintPropertyUpdate(C){}getProgramIds(){return null}getDefaultProgramParams(C,H){return null}_handleOverridablePaintPropertyUpdate(C,H,te){return!1}isHidden(C){return!!(this.minzoom&&C<this.minzoom)||!!(this.maxzoom&&C>=this.maxzoom)||"none"===this.visibility}updateTransitions(C){this._transitioningPaint=this._transitionablePaint.transitioned(C,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(C,H){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(C,void 0,H)),this.paint=this._transitioningPaint.possiblyEvaluate(C,void 0,H)}serialize(){return Z({id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()},((C,H)=>!(void 0===C||"layout"===H&&!Object.keys(C).length||"paint"===H&&!Object.keys(C).length)))}_validate(C,H,te,le,ce={}){return(!ce||!1!==ce.validate)&&ws(this,C.call(hs,{key:H,layerType:this.type,objectKey:te,value:le,styleSpec:Ai,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}resize(){}isStateDependent(){for(const C in this.paint._values){const H=this.paint.get(C);if(H instanceof aa&&no(H.property.specification)&&("source"===H.value.kind||"composite"===H.value.kind)&&H.value.isStateDependent)return!0}return!1}compileFilter(){this._filterCompiled||(this._featureFilter=Ro(this.filter),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}}class ga{constructor(){this.changed=!1,this._updatedLayers={},this._removedLayers={},this.updatedSourceCaches={},this.updatedPaintProps=new Set,this.changedImages=new Set}updateLayer(C){const H=C.scope;this._updatedLayers[H]=this._updatedLayers[H]||new Set,this._updatedLayers[H].add(C.id)}removeLayer(C){const H=C.scope;this._removedLayers[H]=this._removedLayers[H]||{},this._updatedLayers[H]=this._updatedLayers[H]||new Set,this._removedLayers[H][C.id]=C,this._updatedLayers[H].delete(C.id),this.updatedPaintProps.delete(C.fqid)}getRemovedLayer(C){return this._removedLayers[C.scope]?this._removedLayers[C.scope][C.id]:null}discardLayerRemoval(C){this._removedLayers[C.scope]&&delete this._removedLayers[C.scope][C.id]}getLayerUpdatesByScope(){const C={};for(const H in this._updatedLayers)C[H]=C[H]||{},C[H].updatedIds=Array.from(this._updatedLayers[H].values());for(const H in this._removedLayers)C[H]=C[H]||{},C[H].removedIds=Object.keys(this._removedLayers[H]);return C}reset(){this.changed=!1,this._updatedLayers={},this._removedLayers={},this.updatedSourceCaches={},this.updatedPaintProps.clear(),this.changedImages.clear()}}const rc={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class xa{constructor(C,H){this._structArray=C,this._pos1=H*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class va{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(C,H){return C._trim(),H&&(C.isTransferred=!0,H.add(C.arrayBuffer)),{length:C.length,arrayBuffer:C.arrayBuffer}}static deserialize(C){const H=Object.create(this.prototype);return H.arrayBuffer=C.arrayBuffer,H.length=C.length,H.capacity=C.arrayBuffer.byteLength/H.bytesPerElement,H._refreshViews(),H}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(C){this.reserve(C),this.length=C}reserve(C){if(C>this.capacity){this.capacity=Math.max(C,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const H=this.uint8;this._refreshViews(),H&&this.uint8.set(H)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function ba(C,H=1){let te=0,le=0;return{members:C.map((C=>{const ce=rc[C.type].BYTES_PER_ELEMENT,he=te=wa(te,Math.max(H,ce)),ue=C.components||1;return le=Math.max(le,ce),te+=ce*ue,{name:C.name,type:C.type,components:ue,offset:he}})),size:wa(te,Math.max(le,H)),alignment:H}}function wa(C,H){return Math.ceil(C/H)*H}class Ta extends va{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(C,H){const te=this.length;return this.resize(te+1),this.emplace(te,C,H)}emplace(C,H,te){const le=2*C;return this.int16[le+0]=H,this.int16[le+1]=te,C}}Ta.prototype.bytesPerElement=4,Is(Ta,"StructArrayLayout2i4");class Ea extends va{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(C,H,te){const le=this.length;return this.resize(le+1),this.emplace(le,C,H,te)}emplace(C,H,te,le){const ce=3*C;return this.int16[ce+0]=H,this.int16[ce+1]=te,this.int16[ce+2]=le,C}}Ea.prototype.bytesPerElement=6,Is(Ea,"StructArrayLayout3i6");class Ma extends va{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(C,H,te,le){const ce=this.length;return this.resize(ce+1),this.emplace(ce,C,H,te,le)}emplace(C,H,te,le,ce){const he=4*C;return this.int16[he+0]=H,this.int16[he+1]=te,this.int16[he+2]=le,this.int16[he+3]=ce,C}}Ma.prototype.bytesPerElement=8,Is(Ma,"StructArrayLayout4i8");class Aa extends va{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(C,H,te,le,ce){const he=this.length;return this.resize(he+1),this.emplace(he,C,H,te,le,ce)}emplace(C,H,te,le,ce,he){const ue=5*C;return this.int16[ue+0]=H,this.int16[ue+1]=te,this.int16[ue+2]=le,this.int16[ue+3]=ce,this.int16[ue+4]=he,C}}Aa.prototype.bytesPerElement=10,Is(Aa,"StructArrayLayout5i10");class Sa extends va{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(C,H,te,le,ce,he,ue){const de=this.length;return this.resize(de+1),this.emplace(de,C,H,te,le,ce,he,ue)}emplace(C,H,te,le,ce,he,ue,de){const _e=6*C,ye=12*C,ve=3*C;return this.int16[_e+0]=H,this.int16[_e+1]=te,this.uint8[ye+4]=le,this.uint8[ye+5]=ce,this.uint8[ye+6]=he,this.uint8[ye+7]=ue,this.float32[ve+2]=de,C}}Sa.prototype.bytesPerElement=12,Is(Sa,"StructArrayLayout2i4ub1f12");class Ia extends va{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(C,H,te,le){const ce=this.length;return this.resize(ce+1),this.emplace(ce,C,H,te,le)}emplace(C,H,te,le,ce){const he=4*C;return this.float32[he+0]=H,this.float32[he+1]=te,this.float32[he+2]=le,this.float32[he+3]=ce,C}}Ia.prototype.bytesPerElement=16,Is(Ia,"StructArrayLayout4f16");class Ca extends va{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(C,H,te,le,ce){const he=this.length;return this.resize(he+1),this.emplace(he,C,H,te,le,ce)}emplace(C,H,te,le,ce,he){const ue=6*C,de=3*C;return this.uint16[ue+0]=H,this.uint16[ue+1]=te,this.uint16[ue+2]=le,this.uint16[ue+3]=ce,this.float32[de+2]=he,C}}Ca.prototype.bytesPerElement=12,Is(Ca,"StructArrayLayout4ui1f12");class za extends va{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(C,H,te,le){const ce=this.length;return this.resize(ce+1),this.emplace(ce,C,H,te,le)}emplace(C,H,te,le,ce){const he=4*C;return this.uint16[he+0]=H,this.uint16[he+1]=te,this.uint16[he+2]=le,this.uint16[he+3]=ce,C}}za.prototype.bytesPerElement=8,Is(za,"StructArrayLayout4ui8");class Da extends va{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(C,H,te,le,ce,he){const ue=this.length;return this.resize(ue+1),this.emplace(ue,C,H,te,le,ce,he)}emplace(C,H,te,le,ce,he,ue){const de=6*C;return this.int16[de+0]=H,this.int16[de+1]=te,this.int16[de+2]=le,this.int16[de+3]=ce,this.int16[de+4]=he,this.int16[de+5]=ue,C}}Da.prototype.bytesPerElement=12,Is(Da,"StructArrayLayout6i12");class Pa extends va{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(C,H,te,le,ce,he,ue,de,_e,ye,ve,Me){const Se=this.length;return this.resize(Se+1),this.emplace(Se,C,H,te,le,ce,he,ue,de,_e,ye,ve,Me)}emplace(C,H,te,le,ce,he,ue,de,_e,ye,ve,Me,Se){const Ae=12*C;return this.int16[Ae+0]=H,this.int16[Ae+1]=te,this.int16[Ae+2]=le,this.int16[Ae+3]=ce,this.uint16[Ae+4]=he,this.uint16[Ae+5]=ue,this.uint16[Ae+6]=de,this.uint16[Ae+7]=_e,this.int16[Ae+8]=ye,this.int16[Ae+9]=ve,this.int16[Ae+10]=Me,this.int16[Ae+11]=Se,C}}Pa.prototype.bytesPerElement=24,Is(Pa,"StructArrayLayout4i4ui4i24");class Ra extends va{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(C,H,te,le,ce,he){const ue=this.length;return this.resize(ue+1),this.emplace(ue,C,H,te,le,ce,he)}emplace(C,H,te,le,ce,he,ue){const de=10*C,_e=5*C;return this.int16[de+0]=H,this.int16[de+1]=te,this.int16[de+2]=le,this.float32[_e+2]=ce,this.float32[_e+3]=he,this.float32[_e+4]=ue,C}}Ra.prototype.bytesPerElement=20,Is(Ra,"StructArrayLayout3i3f20");class La extends va{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(C){const H=this.length;return this.resize(H+1),this.emplace(H,C)}emplace(C,H){return this.uint32[1*C+0]=H,C}}La.prototype.bytesPerElement=4,Is(La,"StructArrayLayout1ul4");class ka extends va{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(C,H){const te=this.length;return this.resize(te+1),this.emplace(te,C,H)}emplace(C,H,te){const le=2*C;return this.uint16[le+0]=H,this.uint16[le+1]=te,C}}ka.prototype.bytesPerElement=4,Is(ka,"StructArrayLayout2ui4");class Oa extends va{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(C,H,te,le,ce,he,ue,de,_e,ye,ve,Me,Se){const Ae=this.length;return this.resize(Ae+1),this.emplace(Ae,C,H,te,le,ce,he,ue,de,_e,ye,ve,Me,Se)}emplace(C,H,te,le,ce,he,ue,de,_e,ye,ve,Me,Se,Ae){const Ce=20*C,Oe=10*C;return this.int16[Ce+0]=H,this.int16[Ce+1]=te,this.int16[Ce+2]=le,this.int16[Ce+3]=ce,this.int16[Ce+4]=he,this.float32[Oe+3]=ue,this.float32[Oe+4]=de,this.float32[Oe+5]=_e,this.float32[Oe+6]=ye,this.int16[Ce+14]=ve,this.uint32[Oe+8]=Me,this.uint16[Ce+18]=Se,this.uint16[Ce+19]=Ae,C}}Oa.prototype.bytesPerElement=40,Is(Oa,"StructArrayLayout5i4f1i1ul2ui40");class Ba extends va{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(C,H,te,le,ce,he,ue){const de=this.length;return this.resize(de+1),this.emplace(de,C,H,te,le,ce,he,ue)}emplace(C,H,te,le,ce,he,ue,de){const _e=8*C;return this.int16[_e+0]=H,this.int16[_e+1]=te,this.int16[_e+2]=le,this.int16[_e+4]=ce,this.int16[_e+5]=he,this.int16[_e+6]=ue,this.int16[_e+7]=de,C}}Ba.prototype.bytesPerElement=16,Is(Ba,"StructArrayLayout3i2i2i16");class Fa extends va{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(C,H,te,le,ce){const he=this.length;return this.resize(he+1),this.emplace(he,C,H,te,le,ce)}emplace(C,H,te,le,ce,he){const ue=4*C,de=8*C;return this.float32[ue+0]=H,this.float32[ue+1]=te,this.float32[ue+2]=le,this.int16[de+6]=ce,this.int16[de+7]=he,C}}Fa.prototype.bytesPerElement=16,Is(Fa,"StructArrayLayout2f1f2i16");class Na extends va{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(C,H,te,le){const ce=this.length;return this.resize(ce+1),this.emplace(ce,C,H,te,le)}emplace(C,H,te,le,ce){const he=12*C,ue=3*C;return this.uint8[he+0]=H,this.uint8[he+1]=te,this.float32[ue+1]=le,this.float32[ue+2]=ce,C}}Na.prototype.bytesPerElement=12,Is(Na,"StructArrayLayout2ub2f12");class Ua extends va{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(C,H,te){const le=this.length;return this.resize(le+1),this.emplace(le,C,H,te)}emplace(C,H,te,le){const ce=3*C;return this.float32[ce+0]=H,this.float32[ce+1]=te,this.float32[ce+2]=le,C}}Ua.prototype.bytesPerElement=12,Is(Ua,"StructArrayLayout3f12");class Va extends va{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(C,H,te){const le=this.length;return this.resize(le+1),this.emplace(le,C,H,te)}emplace(C,H,te,le){const ce=3*C;return this.uint16[ce+0]=H,this.uint16[ce+1]=te,this.uint16[ce+2]=le,C}}Va.prototype.bytesPerElement=6,Is(Va,"StructArrayLayout3ui6");class ja extends va{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(C,H,te,le,ce,he,ue,de,_e,ye,ve,Me,Se,Ae,Ce,Oe,Ne,je,Ge,Ze,qe){const $e=this.length;return this.resize($e+1),this.emplace($e,C,H,te,le,ce,he,ue,de,_e,ye,ve,Me,Se,Ae,Ce,Oe,Ne,je,Ge,Ze,qe)}emplace(C,H,te,le,ce,he,ue,de,_e,ye,ve,Me,Se,Ae,Ce,Oe,Ne,je,Ge,Ze,qe,$e){const We=30*C,He=15*C,Xe=60*C;return this.int16[We+0]=H,this.int16[We+1]=te,this.int16[We+2]=le,this.float32[He+2]=ce,this.float32[He+3]=he,this.uint16[We+8]=ue,this.uint16[We+9]=de,this.uint32[He+5]=_e,this.uint32[He+6]=ye,this.uint32[He+7]=ve,this.uint16[We+16]=Me,this.uint16[We+17]=Se,this.uint16[We+18]=Ae,this.float32[He+10]=Ce,this.float32[He+11]=Oe,this.uint8[Xe+48]=Ne,this.uint8[Xe+49]=je,this.uint8[Xe+50]=Ge,this.uint32[He+13]=Ze,this.int16[We+28]=qe,this.uint8[Xe+58]=$e,C}}ja.prototype.bytesPerElement=60,Is(ja,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class Ga extends va{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(C,H,te,le,ce,he,ue,de,_e,ye,ve,Me,Se,Ae,Ce,Oe,Ne,je,Ge,Ze,qe,$e,We,He,Xe,Ye,Je,Qe,tt,rt,ot,st){const at=this.length;return this.resize(at+1),this.emplace(at,C,H,te,le,ce,he,ue,de,_e,ye,ve,Me,Se,Ae,Ce,Oe,Ne,je,Ge,Ze,qe,$e,We,He,Xe,Ye,Je,Qe,tt,rt,ot,st)}emplace(C,H,te,le,ce,he,ue,de,_e,ye,ve,Me,Se,Ae,Ce,Oe,Ne,je,Ge,Ze,qe,$e,We,He,Xe,Ye,Je,Qe,tt,rt,ot,st,at){const lt=20*C,ct=40*C,ht=80*C;return this.float32[lt+0]=H,this.float32[lt+1]=te,this.int16[ct+4]=le,this.int16[ct+5]=ce,this.int16[ct+6]=he,this.int16[ct+7]=ue,this.int16[ct+8]=de,this.int16[ct+9]=_e,this.int16[ct+10]=ye,this.int16[ct+11]=ve,this.int16[ct+12]=Me,this.uint16[ct+13]=Se,this.uint16[ct+14]=Ae,this.uint16[ct+15]=Ce,this.uint16[ct+16]=Oe,this.uint16[ct+17]=Ne,this.uint16[ct+18]=je,this.uint16[ct+19]=Ge,this.uint16[ct+20]=Ze,this.uint16[ct+21]=qe,this.uint16[ct+22]=$e,this.uint16[ct+23]=We,this.uint16[ct+24]=He,this.uint16[ct+25]=Xe,this.uint16[ct+26]=Ye,this.uint16[ct+27]=Je,this.uint32[lt+14]=Qe,this.float32[lt+15]=tt,this.float32[lt+16]=rt,this.float32[lt+17]=ot,this.float32[lt+18]=st,this.uint8[ht+76]=at,C}}Ga.prototype.bytesPerElement=80,Is(Ga,"StructArrayLayout2f9i15ui1ul4f1ub80");class qa extends va{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(C){const H=this.length;return this.resize(H+1),this.emplace(H,C)}emplace(C,H){return this.float32[1*C+0]=H,C}}qa.prototype.bytesPerElement=4,Is(qa,"StructArrayLayout1f4");class Za extends va{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(C,H,te,le,ce){const he=this.length;return this.resize(he+1),this.emplace(he,C,H,te,le,ce)}emplace(C,H,te,le,ce,he){const ue=5*C;return this.float32[ue+0]=H,this.float32[ue+1]=te,this.float32[ue+2]=le,this.float32[ue+3]=ce,this.float32[ue+4]=he,C}}Za.prototype.bytesPerElement=20,Is(Za,"StructArrayLayout5f20");class $a extends va{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(C,H,te,le,ce,he,ue){const de=this.length;return this.resize(de+1),this.emplace(de,C,H,te,le,ce,he,ue)}emplace(C,H,te,le,ce,he,ue,de){const _e=7*C;return this.float32[_e+0]=H,this.float32[_e+1]=te,this.float32[_e+2]=le,this.float32[_e+3]=ce,this.float32[_e+4]=he,this.float32[_e+5]=ue,this.float32[_e+6]=de,C}}$a.prototype.bytesPerElement=28,Is($a,"StructArrayLayout7f28");class Ha extends va{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(C,H,te,le){const ce=this.length;return this.resize(ce+1),this.emplace(ce,C,H,te,le)}emplace(C,H,te,le,ce){const he=6*C;return this.uint32[3*C+0]=H,this.uint16[he+2]=te,this.uint16[he+3]=le,this.uint16[he+4]=ce,C}}Ha.prototype.bytesPerElement=12,Is(Ha,"StructArrayLayout1ul3ui12");class Wa extends va{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(C){const H=this.length;return this.resize(H+1),this.emplace(H,C)}emplace(C,H){return this.uint16[1*C+0]=H,C}}Wa.prototype.bytesPerElement=2,Is(Wa,"StructArrayLayout1ui2");class Xa extends va{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(C,H){const te=this.length;return this.resize(te+1),this.emplace(te,C,H)}emplace(C,H,te){const le=2*C;return this.float32[le+0]=H,this.float32[le+1]=te,C}}Xa.prototype.bytesPerElement=8,Is(Xa,"StructArrayLayout2f8");class Ya extends va{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(C,H,te,le,ce,he,ue,de,_e,ye,ve,Me,Se,Ae,Ce,Oe){const Ne=this.length;return this.resize(Ne+1),this.emplace(Ne,C,H,te,le,ce,he,ue,de,_e,ye,ve,Me,Se,Ae,Ce,Oe)}emplace(C,H,te,le,ce,he,ue,de,_e,ye,ve,Me,Se,Ae,Ce,Oe,Ne){const je=16*C;return this.float32[je+0]=H,this.float32[je+1]=te,this.float32[je+2]=le,this.float32[je+3]=ce,this.float32[je+4]=he,this.float32[je+5]=ue,this.float32[je+6]=de,this.float32[je+7]=_e,this.float32[je+8]=ye,this.float32[je+9]=ve,this.float32[je+10]=Me,this.float32[je+11]=Se,this.float32[je+12]=Ae,this.float32[je+13]=Ce,this.float32[je+14]=Oe,this.float32[je+15]=Ne,C}}Ya.prototype.bytesPerElement=64,Is(Ya,"StructArrayLayout16f64");class Ka extends va{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(C,H,te,le,ce,he,ue){const de=this.length;return this.resize(de+1),this.emplace(de,C,H,te,le,ce,he,ue)}emplace(C,H,te,le,ce,he,ue,de){const _e=10*C,ye=5*C;return this.uint16[_e+0]=H,this.uint16[_e+1]=te,this.uint16[_e+2]=le,this.uint16[_e+3]=ce,this.float32[ye+2]=he,this.float32[ye+3]=ue,this.float32[ye+4]=de,C}}Ka.prototype.bytesPerElement=20,Is(Ka,"StructArrayLayout4ui3f20");class Ja extends va{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(C){const H=this.length;return this.resize(H+1),this.emplace(H,C)}emplace(C,H){return this.uint8[1*C+0]=H,C}}Ja.prototype.bytesPerElement=1,Is(Ja,"StructArrayLayout1ub1");class Qa extends xa{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}Qa.prototype.size=40;class el extends Oa{get(C){return new Qa(this,C)}}Is(el,"CollisionBoxArray");class tl extends xa{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(C){this._structArray.uint8[this._pos1+49]=C}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(C){this._structArray.uint8[this._pos1+50]=C}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(C){this._structArray.uint32[this._pos4+13]=C}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(C){this._structArray.uint8[this._pos1+58]=C}}tl.prototype.size=60;class il extends ja{get(C){return new tl(this,C)}}Is(il,"PlacedSymbolArray");class rl extends xa{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(C){this._structArray.uint32[this._pos4+14]=C}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(C){this._structArray.float32[this._pos4+18]=C}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}}rl.prototype.size=80;class nl extends Ga{get(C){return new rl(this,C)}}Is(nl,"SymbolInstanceArray");class ol extends qa{getoffsetX(C){return this.float32[1*C+0]}}Is(ol,"GlyphOffsetArray");class sl extends Ta{getx(C){return this.int16[2*C+0]}gety(C){return this.int16[2*C+1]}}Is(sl,"SymbolLineVertexArray");class al extends xa{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}al.prototype.size=12;class ll extends Ha{get(C){return new al(this,C)}}Is(ll,"FeatureIndexArray");class cl extends ka{geta_centroid_pos0(C){return this.uint16[2*C+0]}geta_centroid_pos1(C){return this.uint16[2*C+1]}}Is(cl,"FillExtrusionCentroidArray");const nc=ba([{name:"a_pos",components:2,type:"Int16"}],4),oc=ba([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class dl{constructor(C=[]){this.segments=C}_prepareSegment(C,H,te,le){let ce=this.segments[this.segments.length-1];return C>dl.MAX_VERTEX_ARRAY_LENGTH&&W(`Max vertices per segment is ${dl.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${C}`),(!ce||ce.vertexLength+C>dl.MAX_VERTEX_ARRAY_LENGTH||ce.sortKey!==le)&&(ce={vertexOffset:H,primitiveOffset:te,vertexLength:0,primitiveLength:0},void 0!==le&&(ce.sortKey=le),this.segments.push(ce)),ce}prepareSegment(C,H,te,le){return this._prepareSegment(C,H.length,te.length,le)}get(){return this.segments}destroy(){for(const C of this.segments)for(const H in C.vaos)C.vaos[H].destroy()}static simpleSegment(C,H,te,le){return new dl([{vertexOffset:C,primitiveOffset:H,vertexLength:te,primitiveLength:le,vaos:{},sortKey:0}])}}function pl(C,H){return 256*(C=z(Math.floor(C),0,255))+z(Math.floor(H),0,255)}dl.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,Is(dl,"SegmentVector");const sc=ba([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),lc=ba([{name:"a_dash",components:4,type:"Uint16"}]);var dc={exports:{}},fc={exports:{}};!function(C){C.exports=function(C,H){var te,le,ce,he,ue,de,_e,ye;for(le=C.length-(te=3&C.length),ce=H,ue=3432918353,de=461845907,ye=0;ye<le;)_e=255&C.charCodeAt(ye)|(255&C.charCodeAt(++ye))<<8|(255&C.charCodeAt(++ye))<<16|(255&C.charCodeAt(++ye))<<24,++ye,ce=27492+(65535&(he=5*(65535&(ce=(ce^=_e=(65535&(_e=(_e=(65535&_e)*ue+(((_e>>>16)*ue&65535)<<16)&4294967295)<<15|_e>>>17))*de+(((_e>>>16)*de&65535)<<16)&4294967295)<<13|ce>>>19))+((5*(ce>>>16)&65535)<<16)&4294967295))+((58964+(he>>>16)&65535)<<16);switch(_e=0,te){case 3:_e^=(255&C.charCodeAt(ye+2))<<16;case 2:_e^=(255&C.charCodeAt(ye+1))<<8;case 1:ce^=_e=(65535&(_e=(_e=(65535&(_e^=255&C.charCodeAt(ye)))*ue+(((_e>>>16)*ue&65535)<<16)&4294967295)<<15|_e>>>17))*de+(((_e>>>16)*de&65535)<<16)&4294967295}return ce^=C.length,ce=2246822507*(65535&(ce^=ce>>>16))+((2246822507*(ce>>>16)&65535)<<16)&4294967295,ce=3266489909*(65535&(ce^=ce>>>13))+((3266489909*(ce>>>16)&65535)<<16)&4294967295,(ce^=ce>>>16)>>>0}}(fc);var yc=fc.exports,vc={exports:{}};!function(C){C.exports=function(C,H){for(var te,le=C.length,ce=H^le,he=0;le>=4;)te=1540483477*(65535&(te=255&C.charCodeAt(he)|(255&C.charCodeAt(++he))<<8|(255&C.charCodeAt(++he))<<16|(255&C.charCodeAt(++he))<<24))+((1540483477*(te>>>16)&65535)<<16),ce=1540483477*(65535&ce)+((1540483477*(ce>>>16)&65535)<<16)^(te=1540483477*(65535&(te^=te>>>24))+((1540483477*(te>>>16)&65535)<<16)),le-=4,++he;switch(le){case 3:ce^=(255&C.charCodeAt(he+2))<<16;case 2:ce^=(255&C.charCodeAt(he+1))<<8;case 1:ce=1540483477*(65535&(ce^=255&C.charCodeAt(he)))+((1540483477*(ce>>>16)&65535)<<16)}return ce=1540483477*(65535&(ce^=ce>>>13))+((1540483477*(ce>>>16)&65535)<<16),(ce^=ce>>>15)>>>0}}(vc);var Ec=yc,Ac=vc.exports;dc.exports=Ec,dc.exports.murmur3=Ec,dc.exports.murmur2=Ac;var kc=d(dc.exports);class Tl{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(C,H,te,le){this.ids.push(El(C)),this.positions.push(H,te,le)}eachPosition(C,H){const te=El(C);let le=0,ce=this.ids.length-1;for(;le<ce;){const C=le+ce>>1;this.ids[C]>=te?ce=C:le=C+1}for(;this.ids[le]===te;)H(this.positions[3*le],this.positions[3*le+1],this.positions[3*le+2]),le++}static serialize(C,H){const te=new Float64Array(C.ids),le=new Uint32Array(C.positions);return Ml(te,le,0,te.length-1),H&&(H.add(te.buffer),H.add(le.buffer)),{ids:te,positions:le}}static deserialize(C){const H=new Tl;let te;H.ids=C.ids,H.positions=C.positions;for(const C of H.ids)C!==te&&H.uniqueIds.push(C),te=C;return H.indexed=!0,H}}function El(C){const H=+C;return!isNaN(H)&&Number.MIN_SAFE_INTEGER<=H&&H<=Number.MAX_SAFE_INTEGER?H:kc(String(C))}function Ml(C,H,te,le){for(;te<le;){const ce=C[te+le>>1];let he=te-1,ue=le+1;for(;;){do{he++}while(C[he]<ce);do{ue--}while(C[ue]>ce);if(he>=ue)break;Al(C,he,ue),Al(H,3*he,3*ue),Al(H,3*he+1,3*ue+1),Al(H,3*he+2,3*ue+2)}ue-te<le-ue?(Ml(C,H,te,ue),te=ue+1):(Ml(C,H,ue+1,le),le=ue)}}function Al(C,H,te){const le=C[H];C[H]=C[te],C[te]=le}Is(Tl,"FeaturePositionMap");class Sl{constructor(C){this.gl=C.gl,this.initialized=!1}fetchUniformLocation(C,H){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(C,H),this.initialized=!0),!!this.location}}class Il extends Sl{constructor(C){super(C),this.current=0}set(C,H,te){this.fetchUniformLocation(C,H)&&this.current!==te&&(this.current=te,this.gl.uniform1i(this.location,te))}}class Cl extends Sl{constructor(C){super(C),this.current=0}set(C,H,te){this.fetchUniformLocation(C,H)&&this.current!==te&&(this.current=te,this.gl.uniform1f(this.location,te))}}class zl extends Sl{constructor(C){super(C),this.current=[0,0]}set(C,H,te){this.fetchUniformLocation(C,H)&&(te[0]===this.current[0]&&te[1]===this.current[1]||(this.current=te,this.gl.uniform2f(this.location,te[0],te[1])))}}class Dl extends Sl{constructor(C){super(C),this.current=[0,0,0]}set(C,H,te){this.fetchUniformLocation(C,H)&&(te[0]===this.current[0]&&te[1]===this.current[1]&&te[2]===this.current[2]||(this.current=te,this.gl.uniform3f(this.location,te[0],te[1],te[2])))}}class Pl extends Sl{constructor(C){super(C),this.current=[0,0,0,0]}set(C,H,te){this.fetchUniformLocation(C,H)&&(te[0]===this.current[0]&&te[1]===this.current[1]&&te[2]===this.current[2]&&te[3]===this.current[3]||(this.current=te,this.gl.uniform4f(this.location,te[0],te[1],te[2],te[3])))}}class Rl extends Sl{constructor(C){super(C),this.current=kr.transparent}set(C,H,te){this.fetchUniformLocation(C,H)&&(te.r===this.current.r&&te.g===this.current.g&&te.b===this.current.b&&te.a===this.current.a||(this.current=te,this.gl.uniform4f(this.location,te.r,te.g,te.b,te.a)))}}const Oc=new Float32Array(16);class kl extends Sl{constructor(C){super(C),this.current=Oc}set(C,H,te){if(this.fetchUniformLocation(C,H)){if(te[12]!==this.current[12]||te[0]!==this.current[0])return this.current=te,void this.gl.uniformMatrix4fv(this.location,!1,te);for(let C=1;C<16;C++)if(te[C]!==this.current[C]){this.current=te,this.gl.uniformMatrix4fv(this.location,!1,te);break}}}}const Fc=new Float32Array(9);class Bl extends Sl{constructor(C){super(C),this.current=Fc}set(C,H,te){if(this.fetchUniformLocation(C,H))for(let C=0;C<9;C++)if(te[C]!==this.current[C]){this.current=te,this.gl.uniformMatrix3fv(this.location,!1,te);break}}}const Xc=new Float32Array(4);class Nl extends Sl{constructor(C){super(C),this.current=Xc}set(C,H,te){if(this.fetchUniformLocation(C,H))for(let C=0;C<4;C++)if(te[C]!==this.current[C]){this.current=te,this.gl.uniformMatrix2fv(this.location,!1,te);break}}}function Ul(C){return[pl(255*C.r,255*C.g),pl(255*C.b,255*C.a)]}class Vl{constructor(C,H,te){this.value=C,this.uniformNames=H.map((C=>`u_${C}`)),this.type=te}setUniform(C,H,te,le,ce){H.set(C,ce,le.constantOr(this.value))}getBinding(C,H){return"color"===this.type?new Rl(C):new Cl(C)}}class jl{constructor(C,H){this.uniformNames=H.map((C=>`u_${C}`)),this.pattern=null,this.pixelRatio=1}setConstantPatternPositions(C){this.pixelRatio=C.pixelRatio||1,this.pattern=C.tl.concat(C.br)}setUniform(C,H,te,le,ce){const he="u_pattern"===ce||"u_dash"===ce?this.pattern:"u_pixel_ratio"===ce?this.pixelRatio:null;he&&H.set(C,ce,he)}getBinding(C,H){return"u_pattern"===H||"u_dash"===H?new Pl(C):new Cl(C)}}class Gl{constructor(C,H,te,le){this.expression=C,this.type=te,this.maxValue=0,this.paintVertexAttributes=H.map((C=>({name:`a_${C}`,type:"Float32",components:"color"===te?2:1,offset:0}))),this.paintVertexArray=new le}populatePaintArray(C,H,te,le,ce,he,ue){const de=this.paintVertexArray.length,_e=this.expression.evaluate(new ea(0,{brightness:he}),H,{},ce,le,ue);this.paintVertexArray.resize(C),this._setPaintValue(de,C,_e)}updatePaintArray(C,H,te,le,ce,he,ue){const de=this.expression.evaluate({zoom:0,brightness:ue},te,le,void 0,ce);this._setPaintValue(C,H,de)}_setPaintValue(C,H,te){if("color"===this.type){const le=Ul(te);for(let te=C;te<H;te++)this.paintVertexArray.emplace(te,le[0],le[1])}else{for(let le=C;le<H;le++)this.paintVertexArray.emplace(le,te);this.maxValue=Math.max(this.maxValue,Math.abs(te))}}upload(C){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=C.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class ql{constructor(C,H,te,le,ce,he){this.expression=C,this.uniformNames=H.map((C=>`u_${C}_t`)),this.type=te,this.useIntegerZoom=le,this.zoom=ce,this.maxValue=0,this.paintVertexAttributes=H.map((C=>({name:`a_${C}`,type:"Float32",components:"color"===te?4:2,offset:0}))),this.paintVertexArray=new he}populatePaintArray(C,H,te,le,ce,he,ue){const de=this.expression.evaluate(new ea(this.zoom,{brightness:he}),H,{},ce,le,ue),_e=this.expression.evaluate(new ea(this.zoom+1,{brightness:he}),H,{},ce,le,ue),ye=this.paintVertexArray.length;this.paintVertexArray.resize(C),this._setPaintValue(ye,C,de,_e)}updatePaintArray(C,H,te,le,ce,he,ue){const de=this.expression.evaluate({zoom:this.zoom,brightness:ue},te,le,void 0,ce),_e=this.expression.evaluate({zoom:this.zoom+1,brightness:ue},te,le,void 0,ce);this._setPaintValue(C,H,de,_e)}_setPaintValue(C,H,te,le){if("color"===this.type){const ce=Ul(te),he=Ul(le);for(let te=C;te<H;te++)this.paintVertexArray.emplace(te,ce[0],ce[1],he[0],he[1])}else{for(let ce=C;ce<H;ce++)this.paintVertexArray.emplace(ce,te,le);this.maxValue=Math.max(this.maxValue,Math.abs(te),Math.abs(le))}}upload(C){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=C.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(C,H,te,le,ce){const he=this.useIntegerZoom?Math.floor(te.zoom):te.zoom,ue=z(this.expression.interpolationFactor(he,this.zoom,this.zoom+1),0,1);H.set(C,ce,ue)}getBinding(C,H){return new Cl(C)}}class Zl{constructor(C,H,te,le,ce){this.expression=C,this.layerId=ce,this.paintVertexAttributes=("array"===te?lc:sc).members;for(let C=0;C<H.length;++C);this.paintVertexArray=new le}populatePaintArray(C,H,te){const le=this.paintVertexArray.length;this.paintVertexArray.resize(C),this._setPaintValues(le,C,H.patterns&&H.patterns[this.layerId],te)}updatePaintArray(C,H,te,le,ce,he,ue){this._setPaintValues(C,H,te.patterns&&te.patterns[this.layerId],he)}_setPaintValues(C,H,te,le){if(!le||!te)return;const ce=le[te];if(!ce)return;const{tl:he,br:ue,pixelRatio:de}=ce;for(let te=C;te<H;te++)this.paintVertexArray.emplace(te,he[0],he[1],ue[0],ue[1],de)}upload(C){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=C.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class $l{constructor(C,H,te=(()=>!0)){this.binders={},this._buffers=[];const le=[];for(const ce in C.paint._values){const he=C.paint.get(ce);if(!te(ce))continue;if(!(he instanceof aa&&no(he.property.specification)))continue;const ue=Xl(ce,C.type),de=he.value,_e=he.property.specification.type,ye=!!he.property.useIntegerZoom,ve="line-dasharray"===ce||ce.endsWith("pattern"),Me="line-dasharray"===ce&&"constant"!==C.layout.get("line-cap").value.kind;if("constant"!==de.kind||Me)if("source"===de.kind||Me||ve){const H=Jl(ce,_e,"source");this.binders[ce]=ve?new Zl(de,ue,_e,H,C.id):new Gl(de,ue,_e,H),le.push(`/a_${ce}`)}else{const C=Jl(ce,_e,"composite");this.binders[ce]=new ql(de,ue,_e,ye,H,C),le.push(`/z_${ce}`)}else this.binders[ce]=ve?new jl(de.value,ue):new Vl(de.value,ue,_e),le.push(`/u_${ce}`)}this.cacheKey=le.sort().join("")}getMaxValue(C){const H=this.binders[C];return H instanceof Gl||H instanceof ql?H.maxValue:0}populatePaintArrays(C,H,te,le,ce,he,ue){for(const de in this.binders){const _e=this.binders[de];(_e instanceof Gl||_e instanceof ql||_e instanceof Zl)&&_e.populatePaintArray(C,H,te,le,ce,he,ue)}}setConstantPatternPositions(C){for(const H in this.binders){const te=this.binders[H];te instanceof jl&&te.setConstantPatternPositions(C)}}updatePaintArrays(C,H,te,le,ce,he,ue,de){let _e=!1;const ye=Object.keys(C),ve=0!==ye.length,Me=ve?ye:H.uniqueIds;for(const ye in this.binders){const Se=this.binders[ye];if((Se instanceof Gl||Se instanceof ql||Se instanceof Zl)&&(!0===Se.expression.isStateDependent||!1===Se.expression.isLightConstant)){const Ae=ce.paint.get(ye);Se.expression=Ae.value;for(const te of Me){const ce=C[te.toString()];H.eachPosition(te,((C,H,te)=>{const _e=le.feature(C);Se.updatePaintArray(H,te,_e,ce,he,ue,de)}))}if(!ve)for(const H of te.uniqueIds){const ce=C[H.toString()];te.eachPosition(H,((C,H,te)=>{const _e=le.feature(C);Se.updatePaintArray(H,te,_e,ce,he,ue,de)}))}_e=!0}}return _e}defines(){const C=[];for(const H in this.binders){const te=this.binders[H];(te instanceof Vl||te instanceof jl)&&C.push(...te.uniformNames.map((C=>`#define HAS_UNIFORM_${C}`)))}return C}getBinderAttributes(){const C=[];for(const H in this.binders){const te=this.binders[H];if(te instanceof Gl||te instanceof ql||te instanceof Zl)for(let H=0;H<te.paintVertexAttributes.length;H++)C.push(te.paintVertexAttributes[H].name)}return C}getBinderUniforms(){const C=[];for(const H in this.binders){const te=this.binders[H];if(te instanceof Vl||te instanceof jl||te instanceof ql)for(const H of te.uniformNames)C.push(H)}return C}getPaintVertexBuffers(){return this._buffers}getUniforms(C){const H=[];for(const te in this.binders){const le=this.binders[te];if(le instanceof Vl||le instanceof jl||le instanceof ql)for(const ce of le.uniformNames)H.push({name:ce,property:te,binding:le.getBinding(C,ce)})}return H}setUniforms(C,H,te,le,ce){for(const{name:H,property:he,binding:ue}of te)this.binders[he].setUniform(C,ue,ce,le.get(he),H)}updatePaintBuffers(){this._buffers=[];for(const C in this.binders){const H=this.binders[C];(H instanceof Gl||H instanceof ql||H instanceof Zl)&&H.paintVertexBuffer&&this._buffers.push(H.paintVertexBuffer)}}upload(C){for(const H in this.binders){const te=this.binders[H];(te instanceof Gl||te instanceof ql||te instanceof Zl)&&te.upload(C)}this.updatePaintBuffers()}destroy(){for(const C in this.binders){const H=this.binders[C];(H instanceof Gl||H instanceof ql||H instanceof Zl)&&H.destroy()}}}class Hl{constructor(C,H,te=(()=>!0)){this.programConfigurations={};for(const le of C)this.programConfigurations[le.id]=new $l(le,H,te);this.needsUpload=!1,this._featureMap=new Tl,this._featureMapWithoutIds=new Tl,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(C,H,te,le,ce,he,ue,de){for(const te in this.programConfigurations)this.programConfigurations[te].populatePaintArrays(C,H,le,ce,he,ue,de);void 0!==H.id?this._featureMap.add(H.id,te,this._bufferOffset,C):(this._featureMapWithoutIds.add(this._idlessCounter,te,this._bufferOffset,C),this._idlessCounter+=1),this._bufferOffset=C,this.needsUpload=!0}updatePaintArrays(C,H,te,le,ce,he){for(const ue of te)this.needsUpload=this.programConfigurations[ue.id].updatePaintArrays(C,this._featureMap,this._featureMapWithoutIds,H,ue,le,ce,he||0)||this.needsUpload}get(C){return this.programConfigurations[C]}upload(C){if(this.needsUpload){for(const H in this.programConfigurations)this.programConfigurations[H].upload(C);this.needsUpload=!1}}destroy(){for(const C in this.programConfigurations)this.programConfigurations[C].destroy()}}const Yc={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio"],"fill-pattern":["pattern","pixel_ratio"],"fill-extrusion-pattern":["pattern","pixel_ratio"],"line-dasharray":["dash"]};function Xl(C,H){return Yc[C]||[C.replace(`${H}-`,"").replace(/-/g,"_")]}const Kc={"line-pattern":{source:Ca,composite:Ca},"fill-pattern":{source:Ca,composite:Ca},"fill-extrusion-pattern":{source:Ca,composite:Ca},"line-dasharray":{source:za,composite:za}},Qc={color:{source:Xa,composite:Ia},number:{source:qa,composite:Xa}};function Jl(C,H,te){const le=Kc[C];return le&&le[te]||Qc[H][te]}Is(Vl,"ConstantBinder"),Is(jl,"PatternConstantBinder"),Is(Gl,"SourceExpressionBinder"),Is(Zl,"PatternCompositeBinder"),Is(ql,"CompositeExpressionBinder"),Is($l,"ProgramConfiguration",{omit:["_buffers"]}),Is(Hl,"ProgramConfigurationSet");class Ql{constructor(C,H){C&&(H?this.setSouthWest(C).setNorthEast(H):4===C.length?this.setSouthWest([C[0],C[1]]).setNorthEast([C[2],C[3]]):this.setSouthWest(C[0]).setNorthEast(C[1]))}setNorthEast(C){return this._ne=C instanceof Of?new Of(C.lng,C.lat):Of.convert(C),this}setSouthWest(C){return this._sw=C instanceof Of?new Of(C.lng,C.lat):Of.convert(C),this}extend(C){const H=this._sw,te=this._ne;let le,ce;if(C instanceof Of)le=C,ce=C;else{if(!(C instanceof Ql))return Array.isArray(C)?4===C.length||C.every(Array.isArray)?this.extend(Ql.convert(C)):this.extend(Of.convert(C)):"object"==typeof C&&null!==C&&C.hasOwnProperty("lat")&&(C.hasOwnProperty("lon")||C.hasOwnProperty("lng"))?this.extend(Of.convert(C)):this;if(le=C._sw,ce=C._ne,!le||!ce)return this}return H||te?(H.lng=Math.min(le.lng,H.lng),H.lat=Math.min(le.lat,H.lat),te.lng=Math.max(ce.lng,te.lng),te.lat=Math.max(ce.lat,te.lat)):(this._sw=new Of(le.lng,le.lat),this._ne=new Of(ce.lng,ce.lat)),this}getCenter(){return new Of((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new Of(this.getWest(),this.getNorth())}getSouthEast(){return new Of(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(C){const{lng:H,lat:te}=Of.convert(C);let le=this._sw.lng<=H&&H<=this._ne.lng;return this._sw.lng>this._ne.lng&&(le=this._sw.lng>=H&&H>=this._ne.lng),this._sw.lat<=te&&te<=this._ne.lat&&le}static convert(C){return!C||C instanceof Ql?C:new Ql(C)}}var ch={},uh={};Object.defineProperty(uh,"__esModule",{value:!0}),uh.setMatrixArrayType=function(C){uh.ARRAY_TYPE=ph=C},uh.toRadian=function(C){return C*Eh},uh.equals=function(C,H){return Math.abs(C-H)<=dh*Math.max(1,Math.abs(C),Math.abs(H))},uh.RANDOM=uh.ARRAY_TYPE=uh.EPSILON=void 0;var dh=1e-6;uh.EPSILON=dh;var ph="undefined"!=typeof Float32Array?Float32Array:Array;uh.ARRAY_TYPE=ph;var fh=Math.random;uh.RANDOM=fh;var Eh=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var C=0,H=arguments.length;H--;)C+=arguments[H]*arguments[H];return Math.sqrt(C)});var Mh={};function ac(C){return ac="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(C){return typeof C}:function(C){return C&&"function"==typeof Symbol&&C.constructor===Symbol&&C!==Symbol.prototype?"symbol":typeof C},ac(C)}Object.defineProperty(Mh,"__esModule",{value:!0}),Mh.create=function(){var C=new Sh.ARRAY_TYPE(4);return Sh.ARRAY_TYPE!=Float32Array&&(C[1]=0,C[2]=0),C[0]=1,C[3]=1,C},Mh.clone=function(C){var H=new Sh.ARRAY_TYPE(4);return H[0]=C[0],H[1]=C[1],H[2]=C[2],H[3]=C[3],H},Mh.copy=function(C,H){return C[0]=H[0],C[1]=H[1],C[2]=H[2],C[3]=H[3],C},Mh.identity=function(C){return C[0]=1,C[1]=0,C[2]=0,C[3]=1,C},Mh.fromValues=function(C,H,te,le){var ce=new Sh.ARRAY_TYPE(4);return ce[0]=C,ce[1]=H,ce[2]=te,ce[3]=le,ce},Mh.set=function(C,H,te,le,ce){return C[0]=H,C[1]=te,C[2]=le,C[3]=ce,C},Mh.transpose=function(C,H){if(C===H){var te=H[1];C[1]=H[2],C[2]=te}else C[0]=H[0],C[1]=H[2],C[2]=H[1],C[3]=H[3];return C},Mh.invert=function(C,H){var te=H[0],le=H[1],ce=H[2],he=H[3],ue=te*he-ce*le;return ue?(C[0]=he*(ue=1/ue),C[1]=-le*ue,C[2]=-ce*ue,C[3]=te*ue,C):null},Mh.adjoint=function(C,H){var te=H[0];return C[0]=H[3],C[1]=-H[1],C[2]=-H[2],C[3]=te,C},Mh.determinant=function(C){return C[0]*C[3]-C[2]*C[1]},Mh.multiply=hc,Mh.rotate=function(C,H,te){var le=H[0],ce=H[1],he=H[2],ue=H[3],de=Math.sin(te),_e=Math.cos(te);return C[0]=le*_e+he*de,C[1]=ce*_e+ue*de,C[2]=le*-de+he*_e,C[3]=ce*-de+ue*_e,C},Mh.scale=function(C,H,te){var le=H[1],ce=H[2],he=H[3],ue=te[0],de=te[1];return C[0]=H[0]*ue,C[1]=le*ue,C[2]=ce*de,C[3]=he*de,C},Mh.fromRotation=function(C,H){var te=Math.sin(H),le=Math.cos(H);return C[0]=le,C[1]=te,C[2]=-te,C[3]=le,C},Mh.fromScaling=function(C,H){return C[0]=H[0],C[1]=0,C[2]=0,C[3]=H[1],C},Mh.str=function(C){return"mat2("+C[0]+", "+C[1]+", "+C[2]+", "+C[3]+")"},Mh.frob=function(C){return Math.hypot(C[0],C[1],C[2],C[3])},Mh.LDU=function(C,H,te,le){return C[2]=le[2]/le[0],te[0]=le[0],te[1]=le[1],te[3]=le[3]-C[2]*te[1],[C,H,te]},Mh.add=function(C,H,te){return C[0]=H[0]+te[0],C[1]=H[1]+te[1],C[2]=H[2]+te[2],C[3]=H[3]+te[3],C},Mh.subtract=uc,Mh.exactEquals=function(C,H){return C[0]===H[0]&&C[1]===H[1]&&C[2]===H[2]&&C[3]===H[3]},Mh.equals=function(C,H){var te=C[0],le=C[1],ce=C[2],he=C[3],ue=H[0],de=H[1],_e=H[2],ye=H[3];return Math.abs(te-ue)<=Sh.EPSILON*Math.max(1,Math.abs(te),Math.abs(ue))&&Math.abs(le-de)<=Sh.EPSILON*Math.max(1,Math.abs(le),Math.abs(de))&&Math.abs(ce-_e)<=Sh.EPSILON*Math.max(1,Math.abs(ce),Math.abs(_e))&&Math.abs(he-ye)<=Sh.EPSILON*Math.max(1,Math.abs(he),Math.abs(ye))},Mh.multiplyScalar=function(C,H,te){return C[0]=H[0]*te,C[1]=H[1]*te,C[2]=H[2]*te,C[3]=H[3]*te,C},Mh.multiplyScalarAndAdd=function(C,H,te,le){return C[0]=H[0]+te[0]*le,C[1]=H[1]+te[1]*le,C[2]=H[2]+te[2]*le,C[3]=H[3]+te[3]*le,C},Mh.sub=Mh.mul=void 0;var Sh=function(C,H){if(C&&C.__esModule)return C;if(null===C||"object"!==ac(C)&&"function"!=typeof C)return{default:C};var te=cc(void 0);if(te&&te.has(C))return te.get(C);var le={},ce=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var he in C)if("default"!==he&&Object.prototype.hasOwnProperty.call(C,he)){var ue=ce?Object.getOwnPropertyDescriptor(C,he):null;ue&&(ue.get||ue.set)?Object.defineProperty(le,he,ue):le[he]=C[he]}return le.default=C,te&&te.set(C,le),le}(uh);function cc(C){if("function"!=typeof WeakMap)return null;var H=new WeakMap,te=new WeakMap;return(cc=function(C){return C?te:H})(C)}function hc(C,H,te){var le=H[0],ce=H[1],he=H[2],ue=H[3],de=te[0],_e=te[1],ye=te[2],ve=te[3];return C[0]=le*de+he*_e,C[1]=ce*de+ue*_e,C[2]=le*ye+he*ve,C[3]=ce*ye+ue*ve,C}function uc(C,H,te){return C[0]=H[0]-te[0],C[1]=H[1]-te[1],C[2]=H[2]-te[2],C[3]=H[3]-te[3],C}Mh.mul=hc,Mh.sub=uc;var Ah={};function pc(C){return pc="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(C){return typeof C}:function(C){return C&&"function"==typeof Symbol&&C.constructor===Symbol&&C!==Symbol.prototype?"symbol":typeof C},pc(C)}Object.defineProperty(Ah,"__esModule",{value:!0}),Ah.create=function(){var C=new Ih.ARRAY_TYPE(6);return Ih.ARRAY_TYPE!=Float32Array&&(C[1]=0,C[2]=0,C[4]=0,C[5]=0),C[0]=1,C[3]=1,C},Ah.clone=function(C){var H=new Ih.ARRAY_TYPE(6);return H[0]=C[0],H[1]=C[1],H[2]=C[2],H[3]=C[3],H[4]=C[4],H[5]=C[5],H},Ah.copy=function(C,H){return C[0]=H[0],C[1]=H[1],C[2]=H[2],C[3]=H[3],C[4]=H[4],C[5]=H[5],C},Ah.identity=function(C){return C[0]=1,C[1]=0,C[2]=0,C[3]=1,C[4]=0,C[5]=0,C},Ah.fromValues=function(C,H,te,le,ce,he){var ue=new Ih.ARRAY_TYPE(6);return ue[0]=C,ue[1]=H,ue[2]=te,ue[3]=le,ue[4]=ce,ue[5]=he,ue},Ah.set=function(C,H,te,le,ce,he,ue){return C[0]=H,C[1]=te,C[2]=le,C[3]=ce,C[4]=he,C[5]=ue,C},Ah.invert=function(C,H){var te=H[0],le=H[1],ce=H[2],he=H[3],ue=H[4],de=H[5],_e=te*he-le*ce;return _e?(C[0]=he*(_e=1/_e),C[1]=-le*_e,C[2]=-ce*_e,C[3]=te*_e,C[4]=(ce*de-he*ue)*_e,C[5]=(le*ue-te*de)*_e,C):null},Ah.determinant=function(C){return C[0]*C[3]-C[1]*C[2]},Ah.multiply=_c,Ah.rotate=function(C,H,te){var le=H[0],ce=H[1],he=H[2],ue=H[3],de=H[4],_e=H[5],ye=Math.sin(te),ve=Math.cos(te);return C[0]=le*ve+he*ye,C[1]=ce*ve+ue*ye,C[2]=le*-ye+he*ve,C[3]=ce*-ye+ue*ve,C[4]=de,C[5]=_e,C},Ah.scale=function(C,H,te){var le=H[1],ce=H[2],he=H[3],ue=H[4],de=H[5],_e=te[0],ye=te[1];return C[0]=H[0]*_e,C[1]=le*_e,C[2]=ce*ye,C[3]=he*ye,C[4]=ue,C[5]=de,C},Ah.translate=function(C,H,te){var le=H[0],ce=H[1],he=H[2],ue=H[3],de=H[4],_e=H[5],ye=te[0],ve=te[1];return C[0]=le,C[1]=ce,C[2]=he,C[3]=ue,C[4]=le*ye+he*ve+de,C[5]=ce*ye+ue*ve+_e,C},Ah.fromRotation=function(C,H){var te=Math.sin(H),le=Math.cos(H);return C[0]=le,C[1]=te,C[2]=-te,C[3]=le,C[4]=0,C[5]=0,C},Ah.fromScaling=function(C,H){return C[0]=H[0],C[1]=0,C[2]=0,C[3]=H[1],C[4]=0,C[5]=0,C},Ah.fromTranslation=function(C,H){return C[0]=1,C[1]=0,C[2]=0,C[3]=1,C[4]=H[0],C[5]=H[1],C},Ah.str=function(C){return"mat2d("+C[0]+", "+C[1]+", "+C[2]+", "+C[3]+", "+C[4]+", "+C[5]+")"},Ah.frob=function(C){return Math.hypot(C[0],C[1],C[2],C[3],C[4],C[5],1)},Ah.add=function(C,H,te){return C[0]=H[0]+te[0],C[1]=H[1]+te[1],C[2]=H[2]+te[2],C[3]=H[3]+te[3],C[4]=H[4]+te[4],C[5]=H[5]+te[5],C},Ah.subtract=gc,Ah.multiplyScalar=function(C,H,te){return C[0]=H[0]*te,C[1]=H[1]*te,C[2]=H[2]*te,C[3]=H[3]*te,C[4]=H[4]*te,C[5]=H[5]*te,C},Ah.multiplyScalarAndAdd=function(C,H,te,le){return C[0]=H[0]+te[0]*le,C[1]=H[1]+te[1]*le,C[2]=H[2]+te[2]*le,C[3]=H[3]+te[3]*le,C[4]=H[4]+te[4]*le,C[5]=H[5]+te[5]*le,C},Ah.exactEquals=function(C,H){return C[0]===H[0]&&C[1]===H[1]&&C[2]===H[2]&&C[3]===H[3]&&C[4]===H[4]&&C[5]===H[5]},Ah.equals=function(C,H){var te=C[0],le=C[1],ce=C[2],he=C[3],ue=C[4],de=C[5],_e=H[0],ye=H[1],ve=H[2],Me=H[3],Se=H[4],Ae=H[5];return Math.abs(te-_e)<=Ih.EPSILON*Math.max(1,Math.abs(te),Math.abs(_e))&&Math.abs(le-ye)<=Ih.EPSILON*Math.max(1,Math.abs(le),Math.abs(ye))&&Math.abs(ce-ve)<=Ih.EPSILON*Math.max(1,Math.abs(ce),Math.abs(ve))&&Math.abs(he-Me)<=Ih.EPSILON*Math.max(1,Math.abs(he),Math.abs(Me))&&Math.abs(ue-Se)<=Ih.EPSILON*Math.max(1,Math.abs(ue),Math.abs(Se))&&Math.abs(de-Ae)<=Ih.EPSILON*Math.max(1,Math.abs(de),Math.abs(Ae))},Ah.sub=Ah.mul=void 0;var Ih=function(C,H){if(C&&C.__esModule)return C;if(null===C||"object"!==pc(C)&&"function"!=typeof C)return{default:C};var te=mc(void 0);if(te&&te.has(C))return te.get(C);var le={},ce=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var he in C)if("default"!==he&&Object.prototype.hasOwnProperty.call(C,he)){var ue=ce?Object.getOwnPropertyDescriptor(C,he):null;ue&&(ue.get||ue.set)?Object.defineProperty(le,he,ue):le[he]=C[he]}return le.default=C,te&&te.set(C,le),le}(uh);function mc(C){if("function"!=typeof WeakMap)return null;var H=new WeakMap,te=new WeakMap;return(mc=function(C){return C?te:H})(C)}function _c(C,H,te){var le=H[0],ce=H[1],he=H[2],ue=H[3],de=H[4],_e=H[5],ye=te[0],ve=te[1],Me=te[2],Se=te[3],Ae=te[4],Ce=te[5];return C[0]=le*ye+he*ve,C[1]=ce*ye+ue*ve,C[2]=le*Me+he*Se,C[3]=ce*Me+ue*Se,C[4]=le*Ae+he*Ce+de,C[5]=ce*Ae+ue*Ce+_e,C}function gc(C,H,te){return C[0]=H[0]-te[0],C[1]=H[1]-te[1],C[2]=H[2]-te[2],C[3]=H[3]-te[3],C[4]=H[4]-te[4],C[5]=H[5]-te[5],C}Ah.mul=_c,Ah.sub=gc;var Ch={};function xc(C){return xc="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(C){return typeof C}:function(C){return C&&"function"==typeof Symbol&&C.constructor===Symbol&&C!==Symbol.prototype?"symbol":typeof C},xc(C)}Object.defineProperty(Ch,"__esModule",{value:!0}),Ch.create=function(){var C=new zh.ARRAY_TYPE(9);return zh.ARRAY_TYPE!=Float32Array&&(C[1]=0,C[2]=0,C[3]=0,C[5]=0,C[6]=0,C[7]=0),C[0]=1,C[4]=1,C[8]=1,C},Ch.fromMat4=function(C,H){return C[0]=H[0],C[1]=H[1],C[2]=H[2],C[3]=H[4],C[4]=H[5],C[5]=H[6],C[6]=H[8],C[7]=H[9],C[8]=H[10],C},Ch.clone=function(C){var H=new zh.ARRAY_TYPE(9);return H[0]=C[0],H[1]=C[1],H[2]=C[2],H[3]=C[3],H[4]=C[4],H[5]=C[5],H[6]=C[6],H[7]=C[7],H[8]=C[8],H},Ch.copy=function(C,H){return C[0]=H[0],C[1]=H[1],C[2]=H[2],C[3]=H[3],C[4]=H[4],C[5]=H[5],C[6]=H[6],C[7]=H[7],C[8]=H[8],C},Ch.fromValues=function(C,H,te,le,ce,he,ue,de,_e){var ye=new zh.ARRAY_TYPE(9);return ye[0]=C,ye[1]=H,ye[2]=te,ye[3]=le,ye[4]=ce,ye[5]=he,ye[6]=ue,ye[7]=de,ye[8]=_e,ye},Ch.set=function(C,H,te,le,ce,he,ue,de,_e,ye){return C[0]=H,C[1]=te,C[2]=le,C[3]=ce,C[4]=he,C[5]=ue,C[6]=de,C[7]=_e,C[8]=ye,C},Ch.identity=function(C){return C[0]=1,C[1]=0,C[2]=0,C[3]=0,C[4]=1,C[5]=0,C[6]=0,C[7]=0,C[8]=1,C},Ch.transpose=function(C,H){if(C===H){var te=H[1],le=H[2],ce=H[5];C[1]=H[3],C[2]=H[6],C[3]=te,C[5]=H[7],C[6]=le,C[7]=ce}else C[0]=H[0],C[1]=H[3],C[2]=H[6],C[3]=H[1],C[4]=H[4],C[5]=H[7],C[6]=H[2],C[7]=H[5],C[8]=H[8];return C},Ch.invert=function(C,H){var te=H[0],le=H[1],ce=H[2],he=H[3],ue=H[4],de=H[5],_e=H[6],ye=H[7],ve=H[8],Me=ve*ue-de*ye,Se=-ve*he+de*_e,Ae=ye*he-ue*_e,Ce=te*Me+le*Se+ce*Ae;return Ce?(C[0]=Me*(Ce=1/Ce),C[1]=(-ve*le+ce*ye)*Ce,C[2]=(de*le-ce*ue)*Ce,C[3]=Se*Ce,C[4]=(ve*te-ce*_e)*Ce,C[5]=(-de*te+ce*he)*Ce,C[6]=Ae*Ce,C[7]=(-ye*te+le*_e)*Ce,C[8]=(ue*te-le*he)*Ce,C):null},Ch.adjoint=function(C,H){var te=H[0],le=H[1],ce=H[2],he=H[3],ue=H[4],de=H[5],_e=H[6],ye=H[7],ve=H[8];return C[0]=ue*ve-de*ye,C[1]=ce*ye-le*ve,C[2]=le*de-ce*ue,C[3]=de*_e-he*ve,C[4]=te*ve-ce*_e,C[5]=ce*he-te*de,C[6]=he*ye-ue*_e,C[7]=le*_e-te*ye,C[8]=te*ue-le*he,C},Ch.determinant=function(C){var H=C[3],te=C[4],le=C[5],ce=C[6],he=C[7],ue=C[8];return C[0]*(ue*te-le*he)+C[1]*(-ue*H+le*ce)+C[2]*(he*H-te*ce)},Ch.multiply=wc,Ch.translate=function(C,H,te){var le=H[0],ce=H[1],he=H[2],ue=H[3],de=H[4],_e=H[5],ye=H[6],ve=H[7],Me=H[8],Se=te[0],Ae=te[1];return C[0]=le,C[1]=ce,C[2]=he,C[3]=ue,C[4]=de,C[5]=_e,C[6]=Se*le+Ae*ue+ye,C[7]=Se*ce+Ae*de+ve,C[8]=Se*he+Ae*_e+Me,C},Ch.rotate=function(C,H,te){var le=H[0],ce=H[1],he=H[2],ue=H[3],de=H[4],_e=H[5],ye=H[6],ve=H[7],Me=H[8],Se=Math.sin(te),Ae=Math.cos(te);return C[0]=Ae*le+Se*ue,C[1]=Ae*ce+Se*de,C[2]=Ae*he+Se*_e,C[3]=Ae*ue-Se*le,C[4]=Ae*de-Se*ce,C[5]=Ae*_e-Se*he,C[6]=ye,C[7]=ve,C[8]=Me,C},Ch.scale=function(C,H,te){var le=te[0],ce=te[1];return C[0]=le*H[0],C[1]=le*H[1],C[2]=le*H[2],C[3]=ce*H[3],C[4]=ce*H[4],C[5]=ce*H[5],C[6]=H[6],C[7]=H[7],C[8]=H[8],C},Ch.fromTranslation=function(C,H){return C[0]=1,C[1]=0,C[2]=0,C[3]=0,C[4]=1,C[5]=0,C[6]=H[0],C[7]=H[1],C[8]=1,C},Ch.fromRotation=function(C,H){var te=Math.sin(H),le=Math.cos(H);return C[0]=le,C[1]=te,C[2]=0,C[3]=-te,C[4]=le,C[5]=0,C[6]=0,C[7]=0,C[8]=1,C},Ch.fromScaling=function(C,H){return C[0]=H[0],C[1]=0,C[2]=0,C[3]=0,C[4]=H[1],C[5]=0,C[6]=0,C[7]=0,C[8]=1,C},Ch.fromMat2d=function(C,H){return C[0]=H[0],C[1]=H[1],C[2]=0,C[3]=H[2],C[4]=H[3],C[5]=0,C[6]=H[4],C[7]=H[5],C[8]=1,C},Ch.fromQuat=function(C,H){var te=H[0],le=H[1],ce=H[2],he=H[3],ue=te+te,de=le+le,_e=ce+ce,ye=te*ue,ve=le*ue,Me=le*de,Se=ce*ue,Ae=ce*de,Ce=ce*_e,Oe=he*ue,Ne=he*de,je=he*_e;return C[0]=1-Me-Ce,C[3]=ve-je,C[6]=Se+Ne,C[1]=ve+je,C[4]=1-ye-Ce,C[7]=Ae-Oe,C[2]=Se-Ne,C[5]=Ae+Oe,C[8]=1-ye-Me,C},Ch.normalFromMat4=function(C,H){var te=H[0],le=H[1],ce=H[2],he=H[3],ue=H[4],de=H[5],_e=H[6],ye=H[7],ve=H[8],Me=H[9],Se=H[10],Ae=H[11],Ce=H[12],Oe=H[13],Ne=H[14],je=H[15],Ge=te*de-le*ue,Ze=te*_e-ce*ue,qe=te*ye-he*ue,$e=le*_e-ce*de,We=le*ye-he*de,He=ce*ye-he*_e,Xe=ve*Oe-Me*Ce,Ye=ve*Ne-Se*Ce,Je=ve*je-Ae*Ce,Qe=Me*Ne-Se*Oe,tt=Me*je-Ae*Oe,rt=Se*je-Ae*Ne,ot=Ge*rt-Ze*tt+qe*Qe+$e*Je-We*Ye+He*Xe;return ot?(C[0]=(de*rt-_e*tt+ye*Qe)*(ot=1/ot),C[1]=(_e*Je-ue*rt-ye*Ye)*ot,C[2]=(ue*tt-de*Je+ye*Xe)*ot,C[3]=(ce*tt-le*rt-he*Qe)*ot,C[4]=(te*rt-ce*Je+he*Ye)*ot,C[5]=(le*Je-te*tt-he*Xe)*ot,C[6]=(Oe*He-Ne*We+je*$e)*ot,C[7]=(Ne*qe-Ce*He-je*Ze)*ot,C[8]=(Ce*We-Oe*qe+je*Ge)*ot,C):null},Ch.projection=function(C,H,te){return C[0]=2/H,C[1]=0,C[2]=0,C[3]=0,C[4]=-2/te,C[5]=0,C[6]=-1,C[7]=1,C[8]=1,C},Ch.str=function(C){return"mat3("+C[0]+", "+C[1]+", "+C[2]+", "+C[3]+", "+C[4]+", "+C[5]+", "+C[6]+", "+C[7]+", "+C[8]+")"},Ch.frob=function(C){return Math.hypot(C[0],C[1],C[2],C[3],C[4],C[5],C[6],C[7],C[8])},Ch.add=function(C,H,te){return C[0]=H[0]+te[0],C[1]=H[1]+te[1],C[2]=H[2]+te[2],C[3]=H[3]+te[3],C[4]=H[4]+te[4],C[5]=H[5]+te[5],C[6]=H[6]+te[6],C[7]=H[7]+te[7],C[8]=H[8]+te[8],C},Ch.subtract=Tc,Ch.multiplyScalar=function(C,H,te){return C[0]=H[0]*te,C[1]=H[1]*te,C[2]=H[2]*te,C[3]=H[3]*te,C[4]=H[4]*te,C[5]=H[5]*te,C[6]=H[6]*te,C[7]=H[7]*te,C[8]=H[8]*te,C},Ch.multiplyScalarAndAdd=function(C,H,te,le){return C[0]=H[0]+te[0]*le,C[1]=H[1]+te[1]*le,C[2]=H[2]+te[2]*le,C[3]=H[3]+te[3]*le,C[4]=H[4]+te[4]*le,C[5]=H[5]+te[5]*le,C[6]=H[6]+te[6]*le,C[7]=H[7]+te[7]*le,C[8]=H[8]+te[8]*le,C},Ch.exactEquals=function(C,H){return C[0]===H[0]&&C[1]===H[1]&&C[2]===H[2]&&C[3]===H[3]&&C[4]===H[4]&&C[5]===H[5]&&C[6]===H[6]&&C[7]===H[7]&&C[8]===H[8]},Ch.equals=function(C,H){var te=C[0],le=C[1],ce=C[2],he=C[3],ue=C[4],de=C[5],_e=C[6],ye=C[7],ve=C[8],Me=H[0],Se=H[1],Ae=H[2],Ce=H[3],Oe=H[4],Ne=H[5],je=H[6],Ge=H[7],Ze=H[8];return Math.abs(te-Me)<=zh.EPSILON*Math.max(1,Math.abs(te),Math.abs(Me))&&Math.abs(le-Se)<=zh.EPSILON*Math.max(1,Math.abs(le),Math.abs(Se))&&Math.abs(ce-Ae)<=zh.EPSILON*Math.max(1,Math.abs(ce),Math.abs(Ae))&&Math.abs(he-Ce)<=zh.EPSILON*Math.max(1,Math.abs(he),Math.abs(Ce))&&Math.abs(ue-Oe)<=zh.EPSILON*Math.max(1,Math.abs(ue),Math.abs(Oe))&&Math.abs(de-Ne)<=zh.EPSILON*Math.max(1,Math.abs(de),Math.abs(Ne))&&Math.abs(_e-je)<=zh.EPSILON*Math.max(1,Math.abs(_e),Math.abs(je))&&Math.abs(ye-Ge)<=zh.EPSILON*Math.max(1,Math.abs(ye),Math.abs(Ge))&&Math.abs(ve-Ze)<=zh.EPSILON*Math.max(1,Math.abs(ve),Math.abs(Ze))},Ch.sub=Ch.mul=void 0;var zh=function(C,H){if(C&&C.__esModule)return C;if(null===C||"object"!==xc(C)&&"function"!=typeof C)return{default:C};var te=bc(void 0);if(te&&te.has(C))return te.get(C);var le={},ce=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var he in C)if("default"!==he&&Object.prototype.hasOwnProperty.call(C,he)){var ue=ce?Object.getOwnPropertyDescriptor(C,he):null;ue&&(ue.get||ue.set)?Object.defineProperty(le,he,ue):le[he]=C[he]}return le.default=C,te&&te.set(C,le),le}(uh);function bc(C){if("function"!=typeof WeakMap)return null;var H=new WeakMap,te=new WeakMap;return(bc=function(C){return C?te:H})(C)}function wc(C,H,te){var le=H[0],ce=H[1],he=H[2],ue=H[3],de=H[4],_e=H[5],ye=H[6],ve=H[7],Me=H[8],Se=te[0],Ae=te[1],Ce=te[2],Oe=te[3],Ne=te[4],je=te[5],Ge=te[6],Ze=te[7],qe=te[8];return C[0]=Se*le+Ae*ue+Ce*ye,C[1]=Se*ce+Ae*de+Ce*ve,C[2]=Se*he+Ae*_e+Ce*Me,C[3]=Oe*le+Ne*ue+je*ye,C[4]=Oe*ce+Ne*de+je*ve,C[5]=Oe*he+Ne*_e+je*Me,C[6]=Ge*le+Ze*ue+qe*ye,C[7]=Ge*ce+Ze*de+qe*ve,C[8]=Ge*he+Ze*_e+qe*Me,C}function Tc(C,H,te){return C[0]=H[0]-te[0],C[1]=H[1]-te[1],C[2]=H[2]-te[2],C[3]=H[3]-te[3],C[4]=H[4]-te[4],C[5]=H[5]-te[5],C[6]=H[6]-te[6],C[7]=H[7]-te[7],C[8]=H[8]-te[8],C}Ch.mul=wc,Ch.sub=Tc;var Dh={};function Mc(C){return Mc="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(C){return typeof C}:function(C){return C&&"function"==typeof Symbol&&C.constructor===Symbol&&C!==Symbol.prototype?"symbol":typeof C},Mc(C)}Object.defineProperty(Dh,"__esModule",{value:!0}),Dh.create=function(){var C=new Ph.ARRAY_TYPE(16);return Ph.ARRAY_TYPE!=Float32Array&&(C[1]=0,C[2]=0,C[3]=0,C[4]=0,C[6]=0,C[7]=0,C[8]=0,C[9]=0,C[11]=0,C[12]=0,C[13]=0,C[14]=0),C[0]=1,C[5]=1,C[10]=1,C[15]=1,C},Dh.clone=function(C){var H=new Ph.ARRAY_TYPE(16);return H[0]=C[0],H[1]=C[1],H[2]=C[2],H[3]=C[3],H[4]=C[4],H[5]=C[5],H[6]=C[6],H[7]=C[7],H[8]=C[8],H[9]=C[9],H[10]=C[10],H[11]=C[11],H[12]=C[12],H[13]=C[13],H[14]=C[14],H[15]=C[15],H},Dh.copy=function(C,H){return C[0]=H[0],C[1]=H[1],C[2]=H[2],C[3]=H[3],C[4]=H[4],C[5]=H[5],C[6]=H[6],C[7]=H[7],C[8]=H[8],C[9]=H[9],C[10]=H[10],C[11]=H[11],C[12]=H[12],C[13]=H[13],C[14]=H[14],C[15]=H[15],C},Dh.fromValues=function(C,H,te,le,ce,he,ue,de,_e,ye,ve,Me,Se,Ae,Ce,Oe){var Ne=new Ph.ARRAY_TYPE(16);return Ne[0]=C,Ne[1]=H,Ne[2]=te,Ne[3]=le,Ne[4]=ce,Ne[5]=he,Ne[6]=ue,Ne[7]=de,Ne[8]=_e,Ne[9]=ye,Ne[10]=ve,Ne[11]=Me,Ne[12]=Se,Ne[13]=Ae,Ne[14]=Ce,Ne[15]=Oe,Ne},Dh.set=function(C,H,te,le,ce,he,ue,de,_e,ye,ve,Me,Se,Ae,Ce,Oe,Ne){return C[0]=H,C[1]=te,C[2]=le,C[3]=ce,C[4]=he,C[5]=ue,C[6]=de,C[7]=_e,C[8]=ye,C[9]=ve,C[10]=Me,C[11]=Se,C[12]=Ae,C[13]=Ce,C[14]=Oe,C[15]=Ne,C},Dh.identity=Ic,Dh.transpose=function(C,H){if(C===H){var te=H[1],le=H[2],ce=H[3],he=H[6],ue=H[7],de=H[11];C[1]=H[4],C[2]=H[8],C[3]=H[12],C[4]=te,C[6]=H[9],C[7]=H[13],C[8]=le,C[9]=he,C[11]=H[14],C[12]=ce,C[13]=ue,C[14]=de}else C[0]=H[0],C[1]=H[4],C[2]=H[8],C[3]=H[12],C[4]=H[1],C[5]=H[5],C[6]=H[9],C[7]=H[13],C[8]=H[2],C[9]=H[6],C[10]=H[10],C[11]=H[14],C[12]=H[3],C[13]=H[7],C[14]=H[11],C[15]=H[15];return C},Dh.invert=function(C,H){var te=H[0],le=H[1],ce=H[2],he=H[3],ue=H[4],de=H[5],_e=H[6],ye=H[7],ve=H[8],Me=H[9],Se=H[10],Ae=H[11],Ce=H[12],Oe=H[13],Ne=H[14],je=H[15],Ge=te*de-le*ue,Ze=te*_e-ce*ue,qe=te*ye-he*ue,$e=le*_e-ce*de,We=le*ye-he*de,He=ce*ye-he*_e,Xe=ve*Oe-Me*Ce,Ye=ve*Ne-Se*Ce,Je=ve*je-Ae*Ce,Qe=Me*Ne-Se*Oe,tt=Me*je-Ae*Oe,rt=Se*je-Ae*Ne,ot=Ge*rt-Ze*tt+qe*Qe+$e*Je-We*Ye+He*Xe;return ot?(C[0]=(de*rt-_e*tt+ye*Qe)*(ot=1/ot),C[1]=(ce*tt-le*rt-he*Qe)*ot,C[2]=(Oe*He-Ne*We+je*$e)*ot,C[3]=(Se*We-Me*He-Ae*$e)*ot,C[4]=(_e*Je-ue*rt-ye*Ye)*ot,C[5]=(te*rt-ce*Je+he*Ye)*ot,C[6]=(Ne*qe-Ce*He-je*Ze)*ot,C[7]=(ve*He-Se*qe+Ae*Ze)*ot,C[8]=(ue*tt-de*Je+ye*Xe)*ot,C[9]=(le*Je-te*tt-he*Xe)*ot,C[10]=(Ce*We-Oe*qe+je*Ge)*ot,C[11]=(Me*qe-ve*We-Ae*Ge)*ot,C[12]=(de*Ye-ue*Qe-_e*Xe)*ot,C[13]=(te*Qe-le*Ye+ce*Xe)*ot,C[14]=(Oe*Ze-Ce*$e-Ne*Ge)*ot,C[15]=(ve*$e-Me*Ze+Se*Ge)*ot,C):null},Dh.adjoint=function(C,H){var te=H[0],le=H[1],ce=H[2],he=H[3],ue=H[4],de=H[5],_e=H[6],ye=H[7],ve=H[8],Me=H[9],Se=H[10],Ae=H[11],Ce=H[12],Oe=H[13],Ne=H[14],je=H[15];return C[0]=de*(Se*je-Ae*Ne)-Me*(_e*je-ye*Ne)+Oe*(_e*Ae-ye*Se),C[1]=-(le*(Se*je-Ae*Ne)-Me*(ce*je-he*Ne)+Oe*(ce*Ae-he*Se)),C[2]=le*(_e*je-ye*Ne)-de*(ce*je-he*Ne)+Oe*(ce*ye-he*_e),C[3]=-(le*(_e*Ae-ye*Se)-de*(ce*Ae-he*Se)+Me*(ce*ye-he*_e)),C[4]=-(ue*(Se*je-Ae*Ne)-ve*(_e*je-ye*Ne)+Ce*(_e*Ae-ye*Se)),C[5]=te*(Se*je-Ae*Ne)-ve*(ce*je-he*Ne)+Ce*(ce*Ae-he*Se),C[6]=-(te*(_e*je-ye*Ne)-ue*(ce*je-he*Ne)+Ce*(ce*ye-he*_e)),C[7]=te*(_e*Ae-ye*Se)-ue*(ce*Ae-he*Se)+ve*(ce*ye-he*_e),C[8]=ue*(Me*je-Ae*Oe)-ve*(de*je-ye*Oe)+Ce*(de*Ae-ye*Me),C[9]=-(te*(Me*je-Ae*Oe)-ve*(le*je-he*Oe)+Ce*(le*Ae-he*Me)),C[10]=te*(de*je-ye*Oe)-ue*(le*je-he*Oe)+Ce*(le*ye-he*de),C[11]=-(te*(de*Ae-ye*Me)-ue*(le*Ae-he*Me)+ve*(le*ye-he*de)),C[12]=-(ue*(Me*Ne-Se*Oe)-ve*(de*Ne-_e*Oe)+Ce*(de*Se-_e*Me)),C[13]=te*(Me*Ne-Se*Oe)-ve*(le*Ne-ce*Oe)+Ce*(le*Se-ce*Me),C[14]=-(te*(de*Ne-_e*Oe)-ue*(le*Ne-ce*Oe)+Ce*(le*_e-ce*de)),C[15]=te*(de*Se-_e*Me)-ue*(le*Se-ce*Me)+ve*(le*_e-ce*de),C},Dh.determinant=function(C){var H=C[0],te=C[1],le=C[2],ce=C[3],he=C[4],ue=C[5],de=C[6],_e=C[7],ye=C[8],ve=C[9],Me=C[10],Se=C[11],Ae=C[12],Ce=C[13],Oe=C[14],Ne=C[15];return(H*ue-te*he)*(Me*Ne-Se*Oe)-(H*de-le*he)*(ve*Ne-Se*Ce)+(H*_e-ce*he)*(ve*Oe-Me*Ce)+(te*de-le*ue)*(ye*Ne-Se*Ae)-(te*_e-ce*ue)*(ye*Oe-Me*Ae)+(le*_e-ce*de)*(ye*Ce-ve*Ae)},Dh.multiply=Cc,Dh.translate=function(C,H,te){var le,ce,he,ue,de,_e,ye,ve,Me,Se,Ae,Ce,Oe=te[0],Ne=te[1],je=te[2];return H===C?(C[12]=H[0]*Oe+H[4]*Ne+H[8]*je+H[12],C[13]=H[1]*Oe+H[5]*Ne+H[9]*je+H[13],C[14]=H[2]*Oe+H[6]*Ne+H[10]*je+H[14],C[15]=H[3]*Oe+H[7]*Ne+H[11]*je+H[15]):(ce=H[1],he=H[2],ue=H[3],de=H[4],_e=H[5],ye=H[6],ve=H[7],Me=H[8],Se=H[9],Ae=H[10],Ce=H[11],C[0]=le=H[0],C[1]=ce,C[2]=he,C[3]=ue,C[4]=de,C[5]=_e,C[6]=ye,C[7]=ve,C[8]=Me,C[9]=Se,C[10]=Ae,C[11]=Ce,C[12]=le*Oe+de*Ne+Me*je+H[12],C[13]=ce*Oe+_e*Ne+Se*je+H[13],C[14]=he*Oe+ye*Ne+Ae*je+H[14],C[15]=ue*Oe+ve*Ne+Ce*je+H[15]),C},Dh.scale=function(C,H,te){var le=te[0],ce=te[1],he=te[2];return C[0]=H[0]*le,C[1]=H[1]*le,C[2]=H[2]*le,C[3]=H[3]*le,C[4]=H[4]*ce,C[5]=H[5]*ce,C[6]=H[6]*ce,C[7]=H[7]*ce,C[8]=H[8]*he,C[9]=H[9]*he,C[10]=H[10]*he,C[11]=H[11]*he,C[12]=H[12],C[13]=H[13],C[14]=H[14],C[15]=H[15],C},Dh.rotate=function(C,H,te,le){var ce,he,ue,de,_e,ye,ve,Me,Se,Ae,Ce,Oe,Ne,je,Ge,Ze,qe,$e,We,He,Xe,Ye,Je,Qe,tt=le[0],rt=le[1],ot=le[2],st=Math.hypot(tt,rt,ot);return st<Ph.EPSILON?null:(tt*=st=1/st,rt*=st,ot*=st,ce=Math.sin(te),he=Math.cos(te),_e=H[1],ye=H[2],ve=H[3],Se=H[5],Ae=H[6],Ce=H[7],Ne=H[9],je=H[10],Ge=H[11],We=tt*rt*(ue=1-he)-ot*ce,He=rt*rt*ue+he,Xe=ot*rt*ue+tt*ce,Ye=tt*ot*ue+rt*ce,Je=rt*ot*ue-tt*ce,Qe=ot*ot*ue+he,C[0]=(de=H[0])*(Ze=tt*tt*ue+he)+(Me=H[4])*(qe=rt*tt*ue+ot*ce)+(Oe=H[8])*($e=ot*tt*ue-rt*ce),C[1]=_e*Ze+Se*qe+Ne*$e,C[2]=ye*Ze+Ae*qe+je*$e,C[3]=ve*Ze+Ce*qe+Ge*$e,C[4]=de*We+Me*He+Oe*Xe,C[5]=_e*We+Se*He+Ne*Xe,C[6]=ye*We+Ae*He+je*Xe,C[7]=ve*We+Ce*He+Ge*Xe,C[8]=de*Ye+Me*Je+Oe*Qe,C[9]=_e*Ye+Se*Je+Ne*Qe,C[10]=ye*Ye+Ae*Je+je*Qe,C[11]=ve*Ye+Ce*Je+Ge*Qe,H!==C&&(C[12]=H[12],C[13]=H[13],C[14]=H[14],C[15]=H[15]),C)},Dh.rotateX=function(C,H,te){var le=Math.sin(te),ce=Math.cos(te),he=H[4],ue=H[5],de=H[6],_e=H[7],ye=H[8],ve=H[9],Me=H[10],Se=H[11];return H!==C&&(C[0]=H[0],C[1]=H[1],C[2]=H[2],C[3]=H[3],C[12]=H[12],C[13]=H[13],C[14]=H[14],C[15]=H[15]),C[4]=he*ce+ye*le,C[5]=ue*ce+ve*le,C[6]=de*ce+Me*le,C[7]=_e*ce+Se*le,C[8]=ye*ce-he*le,C[9]=ve*ce-ue*le,C[10]=Me*ce-de*le,C[11]=Se*ce-_e*le,C},Dh.rotateY=function(C,H,te){var le=Math.sin(te),ce=Math.cos(te),he=H[0],ue=H[1],de=H[2],_e=H[3],ye=H[8],ve=H[9],Me=H[10],Se=H[11];return H!==C&&(C[4]=H[4],C[5]=H[5],C[6]=H[6],C[7]=H[7],C[12]=H[12],C[13]=H[13],C[14]=H[14],C[15]=H[15]),C[0]=he*ce-ye*le,C[1]=ue*ce-ve*le,C[2]=de*ce-Me*le,C[3]=_e*ce-Se*le,C[8]=he*le+ye*ce,C[9]=ue*le+ve*ce,C[10]=de*le+Me*ce,C[11]=_e*le+Se*ce,C},Dh.rotateZ=function(C,H,te){var le=Math.sin(te),ce=Math.cos(te),he=H[0],ue=H[1],de=H[2],_e=H[3],ye=H[4],ve=H[5],Me=H[6],Se=H[7];return H!==C&&(C[8]=H[8],C[9]=H[9],C[10]=H[10],C[11]=H[11],C[12]=H[12],C[13]=H[13],C[14]=H[14],C[15]=H[15]),C[0]=he*ce+ye*le,C[1]=ue*ce+ve*le,C[2]=de*ce+Me*le,C[3]=_e*ce+Se*le,C[4]=ye*ce-he*le,C[5]=ve*ce-ue*le,C[6]=Me*ce-de*le,C[7]=Se*ce-_e*le,C},Dh.fromTranslation=function(C,H){return C[0]=1,C[1]=0,C[2]=0,C[3]=0,C[4]=0,C[5]=1,C[6]=0,C[7]=0,C[8]=0,C[9]=0,C[10]=1,C[11]=0,C[12]=H[0],C[13]=H[1],C[14]=H[2],C[15]=1,C},Dh.fromScaling=function(C,H){return C[0]=H[0],C[1]=0,C[2]=0,C[3]=0,C[4]=0,C[5]=H[1],C[6]=0,C[7]=0,C[8]=0,C[9]=0,C[10]=H[2],C[11]=0,C[12]=0,C[13]=0,C[14]=0,C[15]=1,C},Dh.fromRotation=function(C,H,te){var le,ce,he,ue=te[0],de=te[1],_e=te[2],ye=Math.hypot(ue,de,_e);return ye<Ph.EPSILON?null:(ue*=ye=1/ye,de*=ye,_e*=ye,le=Math.sin(H),ce=Math.cos(H),C[0]=ue*ue*(he=1-ce)+ce,C[1]=de*ue*he+_e*le,C[2]=_e*ue*he-de*le,C[3]=0,C[4]=ue*de*he-_e*le,C[5]=de*de*he+ce,C[6]=_e*de*he+ue*le,C[7]=0,C[8]=ue*_e*he+de*le,C[9]=de*_e*he-ue*le,C[10]=_e*_e*he+ce,C[11]=0,C[12]=0,C[13]=0,C[14]=0,C[15]=1,C)},Dh.fromXRotation=function(C,H){var te=Math.sin(H),le=Math.cos(H);return C[0]=1,C[1]=0,C[2]=0,C[3]=0,C[4]=0,C[5]=le,C[6]=te,C[7]=0,C[8]=0,C[9]=-te,C[10]=le,C[11]=0,C[12]=0,C[13]=0,C[14]=0,C[15]=1,C},Dh.fromYRotation=function(C,H){var te=Math.sin(H),le=Math.cos(H);return C[0]=le,C[1]=0,C[2]=-te,C[3]=0,C[4]=0,C[5]=1,C[6]=0,C[7]=0,C[8]=te,C[9]=0,C[10]=le,C[11]=0,C[12]=0,C[13]=0,C[14]=0,C[15]=1,C},Dh.fromZRotation=function(C,H){var te=Math.sin(H),le=Math.cos(H);return C[0]=le,C[1]=te,C[2]=0,C[3]=0,C[4]=-te,C[5]=le,C[6]=0,C[7]=0,C[8]=0,C[9]=0,C[10]=1,C[11]=0,C[12]=0,C[13]=0,C[14]=0,C[15]=1,C},Dh.fromRotationTranslation=zc,Dh.fromQuat2=function(C,H){var te=new Ph.ARRAY_TYPE(3),le=-H[0],ce=-H[1],he=-H[2],ue=H[3],de=H[4],_e=H[5],ye=H[6],ve=H[7],Me=le*le+ce*ce+he*he+ue*ue;return Me>0?(te[0]=2*(de*ue+ve*le+_e*he-ye*ce)/Me,te[1]=2*(_e*ue+ve*ce+ye*le-de*he)/Me,te[2]=2*(ye*ue+ve*he+de*ce-_e*le)/Me):(te[0]=2*(de*ue+ve*le+_e*he-ye*ce),te[1]=2*(_e*ue+ve*ce+ye*le-de*he),te[2]=2*(ye*ue+ve*he+de*ce-_e*le)),zc(C,H,te),C},Dh.getTranslation=function(C,H){return C[0]=H[12],C[1]=H[13],C[2]=H[14],C},Dh.getScaling=Dc,Dh.getRotation=function(C,H){var te=new Ph.ARRAY_TYPE(3);Dc(te,H);var le=1/te[0],ce=1/te[1],he=1/te[2],ue=H[0]*le,de=H[1]*ce,_e=H[2]*he,ye=H[4]*le,ve=H[5]*ce,Me=H[6]*he,Se=H[8]*le,Ae=H[9]*ce,Ce=H[10]*he,Oe=ue+ve+Ce,Ne=0;return Oe>0?(Ne=2*Math.sqrt(Oe+1),C[3]=.25*Ne,C[0]=(Me-Ae)/Ne,C[1]=(Se-_e)/Ne,C[2]=(de-ye)/Ne):ue>ve&&ue>Ce?(Ne=2*Math.sqrt(1+ue-ve-Ce),C[3]=(Me-Ae)/Ne,C[0]=.25*Ne,C[1]=(de+ye)/Ne,C[2]=(Se+_e)/Ne):ve>Ce?(Ne=2*Math.sqrt(1+ve-ue-Ce),C[3]=(Se-_e)/Ne,C[0]=(de+ye)/Ne,C[1]=.25*Ne,C[2]=(Me+Ae)/Ne):(Ne=2*Math.sqrt(1+Ce-ue-ve),C[3]=(de-ye)/Ne,C[0]=(Se+_e)/Ne,C[1]=(Me+Ae)/Ne,C[2]=.25*Ne),C},Dh.fromRotationTranslationScale=function(C,H,te,le){var ce=H[0],he=H[1],ue=H[2],de=H[3],_e=ce+ce,ye=he+he,ve=ue+ue,Me=ce*_e,Se=ce*ye,Ae=ce*ve,Ce=he*ye,Oe=he*ve,Ne=ue*ve,je=de*_e,Ge=de*ye,Ze=de*ve,qe=le[0],$e=le[1],We=le[2];return C[0]=(1-(Ce+Ne))*qe,C[1]=(Se+Ze)*qe,C[2]=(Ae-Ge)*qe,C[3]=0,C[4]=(Se-Ze)*$e,C[5]=(1-(Me+Ne))*$e,C[6]=(Oe+je)*$e,C[7]=0,C[8]=(Ae+Ge)*We,C[9]=(Oe-je)*We,C[10]=(1-(Me+Ce))*We,C[11]=0,C[12]=te[0],C[13]=te[1],C[14]=te[2],C[15]=1,C},Dh.fromRotationTranslationScaleOrigin=function(C,H,te,le,ce){var he=H[0],ue=H[1],de=H[2],_e=H[3],ye=he+he,ve=ue+ue,Me=de+de,Se=he*ye,Ae=he*ve,Ce=he*Me,Oe=ue*ve,Ne=ue*Me,je=de*Me,Ge=_e*ye,Ze=_e*ve,qe=_e*Me,$e=le[0],We=le[1],He=le[2],Xe=ce[0],Ye=ce[1],Je=ce[2],Qe=(1-(Oe+je))*$e,tt=(Ae+qe)*$e,rt=(Ce-Ze)*$e,ot=(Ae-qe)*We,st=(1-(Se+je))*We,at=(Ne+Ge)*We,lt=(Ce+Ze)*He,ct=(Ne-Ge)*He,ht=(1-(Se+Oe))*He;return C[0]=Qe,C[1]=tt,C[2]=rt,C[3]=0,C[4]=ot,C[5]=st,C[6]=at,C[7]=0,C[8]=lt,C[9]=ct,C[10]=ht,C[11]=0,C[12]=te[0]+Xe-(Qe*Xe+ot*Ye+lt*Je),C[13]=te[1]+Ye-(tt*Xe+st*Ye+ct*Je),C[14]=te[2]+Je-(rt*Xe+at*Ye+ht*Je),C[15]=1,C},Dh.fromQuat=function(C,H){var te=H[0],le=H[1],ce=H[2],he=H[3],ue=te+te,de=le+le,_e=ce+ce,ye=te*ue,ve=le*ue,Me=le*de,Se=ce*ue,Ae=ce*de,Ce=ce*_e,Oe=he*ue,Ne=he*de,je=he*_e;return C[0]=1-Me-Ce,C[1]=ve+je,C[2]=Se-Ne,C[3]=0,C[4]=ve-je,C[5]=1-ye-Ce,C[6]=Ae+Oe,C[7]=0,C[8]=Se+Ne,C[9]=Ae-Oe,C[10]=1-ye-Me,C[11]=0,C[12]=0,C[13]=0,C[14]=0,C[15]=1,C},Dh.frustum=function(C,H,te,le,ce,he,ue){var de=1/(te-H),_e=1/(ce-le),ye=1/(he-ue);return C[0]=2*he*de,C[1]=0,C[2]=0,C[3]=0,C[4]=0,C[5]=2*he*_e,C[6]=0,C[7]=0,C[8]=(te+H)*de,C[9]=(ce+le)*_e,C[10]=(ue+he)*ye,C[11]=-1,C[12]=0,C[13]=0,C[14]=ue*he*2*ye,C[15]=0,C},Dh.perspectiveNO=Pc,Dh.perspectiveZO=function(C,H,te,le,ce){var he,ue=1/Math.tan(H/2);return C[0]=ue/te,C[1]=0,C[2]=0,C[3]=0,C[4]=0,C[5]=ue,C[6]=0,C[7]=0,C[8]=0,C[9]=0,C[11]=-1,C[12]=0,C[13]=0,C[15]=0,null!=ce&&ce!==1/0?(C[10]=ce*(he=1/(le-ce)),C[14]=ce*le*he):(C[10]=-1,C[14]=-le),C},Dh.perspectiveFromFieldOfView=function(C,H,te,le){var ce=Math.tan(H.upDegrees*Math.PI/180),he=Math.tan(H.downDegrees*Math.PI/180),ue=Math.tan(H.leftDegrees*Math.PI/180),de=Math.tan(H.rightDegrees*Math.PI/180),_e=2/(ue+de),ye=2/(ce+he);return C[0]=_e,C[1]=0,C[2]=0,C[3]=0,C[4]=0,C[5]=ye,C[6]=0,C[7]=0,C[8]=-(ue-de)*_e*.5,C[9]=(ce-he)*ye*.5,C[10]=le/(te-le),C[11]=-1,C[12]=0,C[13]=0,C[14]=le*te/(te-le),C[15]=0,C},Dh.orthoNO=Rc,Dh.orthoZO=function(C,H,te,le,ce,he,ue){var de=1/(H-te),_e=1/(le-ce),ye=1/(he-ue);return C[0]=-2*de,C[1]=0,C[2]=0,C[3]=0,C[4]=0,C[5]=-2*_e,C[6]=0,C[7]=0,C[8]=0,C[9]=0,C[10]=ye,C[11]=0,C[12]=(H+te)*de,C[13]=(ce+le)*_e,C[14]=he*ye,C[15]=1,C},Dh.lookAt=function(C,H,te,le){var ce,he,ue,de,_e,ye,ve,Me,Se,Ae,Ce=H[0],Oe=H[1],Ne=H[2],je=le[0],Ge=le[1],Ze=le[2],qe=te[0],$e=te[1],We=te[2];return Math.abs(Ce-qe)<Ph.EPSILON&&Math.abs(Oe-$e)<Ph.EPSILON&&Math.abs(Ne-We)<Ph.EPSILON?Ic(C):(ve=Ce-qe,Me=Oe-$e,Se=Ne-We,ce=Ge*(Se*=Ae=1/Math.hypot(ve,Me,Se))-Ze*(Me*=Ae),he=Ze*(ve*=Ae)-je*Se,ue=je*Me-Ge*ve,(Ae=Math.hypot(ce,he,ue))?(ce*=Ae=1/Ae,he*=Ae,ue*=Ae):(ce=0,he=0,ue=0),de=Me*ue-Se*he,_e=Se*ce-ve*ue,ye=ve*he-Me*ce,(Ae=Math.hypot(de,_e,ye))?(de*=Ae=1/Ae,_e*=Ae,ye*=Ae):(de=0,_e=0,ye=0),C[0]=ce,C[1]=de,C[2]=ve,C[3]=0,C[4]=he,C[5]=_e,C[6]=Me,C[7]=0,C[8]=ue,C[9]=ye,C[10]=Se,C[11]=0,C[12]=-(ce*Ce+he*Oe+ue*Ne),C[13]=-(de*Ce+_e*Oe+ye*Ne),C[14]=-(ve*Ce+Me*Oe+Se*Ne),C[15]=1,C)},Dh.targetTo=function(C,H,te,le){var ce=H[0],he=H[1],ue=H[2],de=le[0],_e=le[1],ye=le[2],ve=ce-te[0],Me=he-te[1],Se=ue-te[2],Ae=ve*ve+Me*Me+Se*Se;Ae>0&&(ve*=Ae=1/Math.sqrt(Ae),Me*=Ae,Se*=Ae);var Ce=_e*Se-ye*Me,Oe=ye*ve-de*Se,Ne=de*Me-_e*ve;return(Ae=Ce*Ce+Oe*Oe+Ne*Ne)>0&&(Ce*=Ae=1/Math.sqrt(Ae),Oe*=Ae,Ne*=Ae),C[0]=Ce,C[1]=Oe,C[2]=Ne,C[3]=0,C[4]=Me*Ne-Se*Oe,C[5]=Se*Ce-ve*Ne,C[6]=ve*Oe-Me*Ce,C[7]=0,C[8]=ve,C[9]=Me,C[10]=Se,C[11]=0,C[12]=ce,C[13]=he,C[14]=ue,C[15]=1,C},Dh.str=function(C){return"mat4("+C[0]+", "+C[1]+", "+C[2]+", "+C[3]+", "+C[4]+", "+C[5]+", "+C[6]+", "+C[7]+", "+C[8]+", "+C[9]+", "+C[10]+", "+C[11]+", "+C[12]+", "+C[13]+", "+C[14]+", "+C[15]+")"},Dh.frob=function(C){return Math.hypot(C[0],C[1],C[2],C[3],C[4],C[5],C[6],C[7],C[8],C[9],C[10],C[11],C[12],C[13],C[14],C[15])},Dh.add=function(C,H,te){return C[0]=H[0]+te[0],C[1]=H[1]+te[1],C[2]=H[2]+te[2],C[3]=H[3]+te[3],C[4]=H[4]+te[4],C[5]=H[5]+te[5],C[6]=H[6]+te[6],C[7]=H[7]+te[7],C[8]=H[8]+te[8],C[9]=H[9]+te[9],C[10]=H[10]+te[10],C[11]=H[11]+te[11],C[12]=H[12]+te[12],C[13]=H[13]+te[13],C[14]=H[14]+te[14],C[15]=H[15]+te[15],C},Dh.subtract=Lc,Dh.multiplyScalar=function(C,H,te){return C[0]=H[0]*te,C[1]=H[1]*te,C[2]=H[2]*te,C[3]=H[3]*te,C[4]=H[4]*te,C[5]=H[5]*te,C[6]=H[6]*te,C[7]=H[7]*te,C[8]=H[8]*te,C[9]=H[9]*te,C[10]=H[10]*te,C[11]=H[11]*te,C[12]=H[12]*te,C[13]=H[13]*te,C[14]=H[14]*te,C[15]=H[15]*te,C},Dh.multiplyScalarAndAdd=function(C,H,te,le){return C[0]=H[0]+te[0]*le,C[1]=H[1]+te[1]*le,C[2]=H[2]+te[2]*le,C[3]=H[3]+te[3]*le,C[4]=H[4]+te[4]*le,C[5]=H[5]+te[5]*le,C[6]=H[6]+te[6]*le,C[7]=H[7]+te[7]*le,C[8]=H[8]+te[8]*le,C[9]=H[9]+te[9]*le,C[10]=H[10]+te[10]*le,C[11]=H[11]+te[11]*le,C[12]=H[12]+te[12]*le,C[13]=H[13]+te[13]*le,C[14]=H[14]+te[14]*le,C[15]=H[15]+te[15]*le,C},Dh.exactEquals=function(C,H){return C[0]===H[0]&&C[1]===H[1]&&C[2]===H[2]&&C[3]===H[3]&&C[4]===H[4]&&C[5]===H[5]&&C[6]===H[6]&&C[7]===H[7]&&C[8]===H[8]&&C[9]===H[9]&&C[10]===H[10]&&C[11]===H[11]&&C[12]===H[12]&&C[13]===H[13]&&C[14]===H[14]&&C[15]===H[15]},Dh.equals=function(C,H){var te=C[0],le=C[1],ce=C[2],he=C[3],ue=C[4],de=C[5],_e=C[6],ye=C[7],ve=C[8],Me=C[9],Se=C[10],Ae=C[11],Ce=C[12],Oe=C[13],Ne=C[14],je=C[15],Ge=H[0],Ze=H[1],qe=H[2],$e=H[3],We=H[4],He=H[5],Xe=H[6],Ye=H[7],Je=H[8],Qe=H[9],tt=H[10],rt=H[11],ot=H[12],st=H[13],at=H[14],lt=H[15];return Math.abs(te-Ge)<=Ph.EPSILON*Math.max(1,Math.abs(te),Math.abs(Ge))&&Math.abs(le-Ze)<=Ph.EPSILON*Math.max(1,Math.abs(le),Math.abs(Ze))&&Math.abs(ce-qe)<=Ph.EPSILON*Math.max(1,Math.abs(ce),Math.abs(qe))&&Math.abs(he-$e)<=Ph.EPSILON*Math.max(1,Math.abs(he),Math.abs($e))&&Math.abs(ue-We)<=Ph.EPSILON*Math.max(1,Math.abs(ue),Math.abs(We))&&Math.abs(de-He)<=Ph.EPSILON*Math.max(1,Math.abs(de),Math.abs(He))&&Math.abs(_e-Xe)<=Ph.EPSILON*Math.max(1,Math.abs(_e),Math.abs(Xe))&&Math.abs(ye-Ye)<=Ph.EPSILON*Math.max(1,Math.abs(ye),Math.abs(Ye))&&Math.abs(ve-Je)<=Ph.EPSILON*Math.max(1,Math.abs(ve),Math.abs(Je))&&Math.abs(Me-Qe)<=Ph.EPSILON*Math.max(1,Math.abs(Me),Math.abs(Qe))&&Math.abs(Se-tt)<=Ph.EPSILON*Math.max(1,Math.abs(Se),Math.abs(tt))&&Math.abs(Ae-rt)<=Ph.EPSILON*Math.max(1,Math.abs(Ae),Math.abs(rt))&&Math.abs(Ce-ot)<=Ph.EPSILON*Math.max(1,Math.abs(Ce),Math.abs(ot))&&Math.abs(Oe-st)<=Ph.EPSILON*Math.max(1,Math.abs(Oe),Math.abs(st))&&Math.abs(Ne-at)<=Ph.EPSILON*Math.max(1,Math.abs(Ne),Math.abs(at))&&Math.abs(je-lt)<=Ph.EPSILON*Math.max(1,Math.abs(je),Math.abs(lt))},Dh.sub=Dh.mul=Dh.ortho=Dh.perspective=void 0;var Ph=function(C,H){if(C&&C.__esModule)return C;if(null===C||"object"!==Mc(C)&&"function"!=typeof C)return{default:C};var te=Sc(void 0);if(te&&te.has(C))return te.get(C);var le={},ce=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var he in C)if("default"!==he&&Object.prototype.hasOwnProperty.call(C,he)){var ue=ce?Object.getOwnPropertyDescriptor(C,he):null;ue&&(ue.get||ue.set)?Object.defineProperty(le,he,ue):le[he]=C[he]}return le.default=C,te&&te.set(C,le),le}(uh);function Sc(C){if("function"!=typeof WeakMap)return null;var H=new WeakMap,te=new WeakMap;return(Sc=function(C){return C?te:H})(C)}function Ic(C){return C[0]=1,C[1]=0,C[2]=0,C[3]=0,C[4]=0,C[5]=1,C[6]=0,C[7]=0,C[8]=0,C[9]=0,C[10]=1,C[11]=0,C[12]=0,C[13]=0,C[14]=0,C[15]=1,C}function Cc(C,H,te){var le=H[0],ce=H[1],he=H[2],ue=H[3],de=H[4],_e=H[5],ye=H[6],ve=H[7],Me=H[8],Se=H[9],Ae=H[10],Ce=H[11],Oe=H[12],Ne=H[13],je=H[14],Ge=H[15],Ze=te[0],qe=te[1],$e=te[2],We=te[3];return C[0]=Ze*le+qe*de+$e*Me+We*Oe,C[1]=Ze*ce+qe*_e+$e*Se+We*Ne,C[2]=Ze*he+qe*ye+$e*Ae+We*je,C[3]=Ze*ue+qe*ve+$e*Ce+We*Ge,C[4]=(Ze=te[4])*le+(qe=te[5])*de+($e=te[6])*Me+(We=te[7])*Oe,C[5]=Ze*ce+qe*_e+$e*Se+We*Ne,C[6]=Ze*he+qe*ye+$e*Ae+We*je,C[7]=Ze*ue+qe*ve+$e*Ce+We*Ge,C[8]=(Ze=te[8])*le+(qe=te[9])*de+($e=te[10])*Me+(We=te[11])*Oe,C[9]=Ze*ce+qe*_e+$e*Se+We*Ne,C[10]=Ze*he+qe*ye+$e*Ae+We*je,C[11]=Ze*ue+qe*ve+$e*Ce+We*Ge,C[12]=(Ze=te[12])*le+(qe=te[13])*de+($e=te[14])*Me+(We=te[15])*Oe,C[13]=Ze*ce+qe*_e+$e*Se+We*Ne,C[14]=Ze*he+qe*ye+$e*Ae+We*je,C[15]=Ze*ue+qe*ve+$e*Ce+We*Ge,C}function zc(C,H,te){var le=H[0],ce=H[1],he=H[2],ue=H[3],de=le+le,_e=ce+ce,ye=he+he,ve=le*de,Me=le*_e,Se=le*ye,Ae=ce*_e,Ce=ce*ye,Oe=he*ye,Ne=ue*de,je=ue*_e,Ge=ue*ye;return C[0]=1-(Ae+Oe),C[1]=Me+Ge,C[2]=Se-je,C[3]=0,C[4]=Me-Ge,C[5]=1-(ve+Oe),C[6]=Ce+Ne,C[7]=0,C[8]=Se+je,C[9]=Ce-Ne,C[10]=1-(ve+Ae),C[11]=0,C[12]=te[0],C[13]=te[1],C[14]=te[2],C[15]=1,C}function Dc(C,H){var te=H[4],le=H[5],ce=H[6],he=H[8],ue=H[9],de=H[10];return C[0]=Math.hypot(H[0],H[1],H[2]),C[1]=Math.hypot(te,le,ce),C[2]=Math.hypot(he,ue,de),C}function Pc(C,H,te,le,ce){var he,ue=1/Math.tan(H/2);return C[0]=ue/te,C[1]=0,C[2]=0,C[3]=0,C[4]=0,C[5]=ue,C[6]=0,C[7]=0,C[8]=0,C[9]=0,C[11]=-1,C[12]=0,C[13]=0,C[15]=0,null!=ce&&ce!==1/0?(C[10]=(ce+le)*(he=1/(le-ce)),C[14]=2*ce*le*he):(C[10]=-1,C[14]=-2*le),C}function Rc(C,H,te,le,ce,he,ue){var de=1/(H-te),_e=1/(le-ce),ye=1/(he-ue);return C[0]=-2*de,C[1]=0,C[2]=0,C[3]=0,C[4]=0,C[5]=-2*_e,C[6]=0,C[7]=0,C[8]=0,C[9]=0,C[10]=2*ye,C[11]=0,C[12]=(H+te)*de,C[13]=(ce+le)*_e,C[14]=(ue+he)*ye,C[15]=1,C}function Lc(C,H,te){return C[0]=H[0]-te[0],C[1]=H[1]-te[1],C[2]=H[2]-te[2],C[3]=H[3]-te[3],C[4]=H[4]-te[4],C[5]=H[5]-te[5],C[6]=H[6]-te[6],C[7]=H[7]-te[7],C[8]=H[8]-te[8],C[9]=H[9]-te[9],C[10]=H[10]-te[10],C[11]=H[11]-te[11],C[12]=H[12]-te[12],C[13]=H[13]-te[13],C[14]=H[14]-te[14],C[15]=H[15]-te[15],C}Dh.perspective=Pc,Dh.ortho=Rc,Dh.mul=Cc,Dh.sub=Lc;var kh={},Rh={};function Bc(C){return Bc="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(C){return typeof C}:function(C){return C&&"function"==typeof Symbol&&C.constructor===Symbol&&C!==Symbol.prototype?"symbol":typeof C},Bc(C)}Object.defineProperty(Rh,"__esModule",{value:!0}),Rh.create=Uc,Rh.clone=function(C){var H=new Lh.ARRAY_TYPE(3);return H[0]=C[0],H[1]=C[1],H[2]=C[2],H},Rh.length=Vc,Rh.fromValues=function(C,H,te){var le=new Lh.ARRAY_TYPE(3);return le[0]=C,le[1]=H,le[2]=te,le},Rh.copy=function(C,H){return C[0]=H[0],C[1]=H[1],C[2]=H[2],C},Rh.set=function(C,H,te,le){return C[0]=H,C[1]=te,C[2]=le,C},Rh.add=function(C,H,te){return C[0]=H[0]+te[0],C[1]=H[1]+te[1],C[2]=H[2]+te[2],C},Rh.subtract=jc,Rh.multiply=Gc,Rh.divide=qc,Rh.ceil=function(C,H){return C[0]=Math.ceil(H[0]),C[1]=Math.ceil(H[1]),C[2]=Math.ceil(H[2]),C},Rh.floor=function(C,H){return C[0]=Math.floor(H[0]),C[1]=Math.floor(H[1]),C[2]=Math.floor(H[2]),C},Rh.min=function(C,H,te){return C[0]=Math.min(H[0],te[0]),C[1]=Math.min(H[1],te[1]),C[2]=Math.min(H[2],te[2]),C},Rh.max=function(C,H,te){return C[0]=Math.max(H[0],te[0]),C[1]=Math.max(H[1],te[1]),C[2]=Math.max(H[2],te[2]),C},Rh.round=function(C,H){return C[0]=Math.round(H[0]),C[1]=Math.round(H[1]),C[2]=Math.round(H[2]),C},Rh.scale=function(C,H,te){return C[0]=H[0]*te,C[1]=H[1]*te,C[2]=H[2]*te,C},Rh.scaleAndAdd=function(C,H,te,le){return C[0]=H[0]+te[0]*le,C[1]=H[1]+te[1]*le,C[2]=H[2]+te[2]*le,C},Rh.distance=Zc,Rh.squaredDistance=$c,Rh.squaredLength=Hc,Rh.negate=function(C,H){return C[0]=-H[0],C[1]=-H[1],C[2]=-H[2],C},Rh.inverse=function(C,H){return C[0]=1/H[0],C[1]=1/H[1],C[2]=1/H[2],C},Rh.normalize=function(C,H){var te=H[0],le=H[1],ce=H[2],he=te*te+le*le+ce*ce;return he>0&&(he=1/Math.sqrt(he)),C[0]=H[0]*he,C[1]=H[1]*he,C[2]=H[2]*he,C},Rh.dot=Wc,Rh.cross=function(C,H,te){var le=H[0],ce=H[1],he=H[2],ue=te[0],de=te[1],_e=te[2];return C[0]=ce*_e-he*de,C[1]=he*ue-le*_e,C[2]=le*de-ce*ue,C},Rh.lerp=function(C,H,te,le){var ce=H[0],he=H[1],ue=H[2];return C[0]=ce+le*(te[0]-ce),C[1]=he+le*(te[1]-he),C[2]=ue+le*(te[2]-ue),C},Rh.hermite=function(C,H,te,le,ce,he){var ue=he*he,de=ue*(2*he-3)+1,_e=ue*(he-2)+he,ye=ue*(he-1),ve=ue*(3-2*he);return C[0]=H[0]*de+te[0]*_e+le[0]*ye+ce[0]*ve,C[1]=H[1]*de+te[1]*_e+le[1]*ye+ce[1]*ve,C[2]=H[2]*de+te[2]*_e+le[2]*ye+ce[2]*ve,C},Rh.bezier=function(C,H,te,le,ce,he){var ue=1-he,de=ue*ue,_e=he*he,ye=de*ue,ve=3*he*de,Me=3*_e*ue,Se=_e*he;return C[0]=H[0]*ye+te[0]*ve+le[0]*Me+ce[0]*Se,C[1]=H[1]*ye+te[1]*ve+le[1]*Me+ce[1]*Se,C[2]=H[2]*ye+te[2]*ve+le[2]*Me+ce[2]*Se,C},Rh.random=function(C,H){H=H||1;var te=2*Lh.RANDOM()*Math.PI,le=2*Lh.RANDOM()-1,ce=Math.sqrt(1-le*le)*H;return C[0]=Math.cos(te)*ce,C[1]=Math.sin(te)*ce,C[2]=le*H,C},Rh.transformMat4=function(C,H,te){var le=H[0],ce=H[1],he=H[2],ue=te[3]*le+te[7]*ce+te[11]*he+te[15];return C[0]=(te[0]*le+te[4]*ce+te[8]*he+te[12])/(ue=ue||1),C[1]=(te[1]*le+te[5]*ce+te[9]*he+te[13])/ue,C[2]=(te[2]*le+te[6]*ce+te[10]*he+te[14])/ue,C},Rh.transformMat3=function(C,H,te){var le=H[0],ce=H[1],he=H[2];return C[0]=le*te[0]+ce*te[3]+he*te[6],C[1]=le*te[1]+ce*te[4]+he*te[7],C[2]=le*te[2]+ce*te[5]+he*te[8],C},Rh.transformQuat=function(C,H,te){var le=te[0],ce=te[1],he=te[2],ue=H[0],de=H[1],_e=H[2],ye=ce*_e-he*de,ve=he*ue-le*_e,Me=le*de-ce*ue,Se=ce*Me-he*ve,Ae=he*ye-le*Me,Ce=le*ve-ce*ye,Oe=2*te[3];return ve*=Oe,Me*=Oe,Ae*=2,Ce*=2,C[0]=ue+(ye*=Oe)+(Se*=2),C[1]=de+ve+Ae,C[2]=_e+Me+Ce,C},Rh.rotateX=function(C,H,te,le){var ce=[],he=[];return ce[0]=H[0]-te[0],ce[1]=H[1]-te[1],ce[2]=H[2]-te[2],he[0]=ce[0],he[1]=ce[1]*Math.cos(le)-ce[2]*Math.sin(le),he[2]=ce[1]*Math.sin(le)+ce[2]*Math.cos(le),C[0]=he[0]+te[0],C[1]=he[1]+te[1],C[2]=he[2]+te[2],C},Rh.rotateY=function(C,H,te,le){var ce=[],he=[];return ce[0]=H[0]-te[0],ce[1]=H[1]-te[1],ce[2]=H[2]-te[2],he[0]=ce[2]*Math.sin(le)+ce[0]*Math.cos(le),he[1]=ce[1],he[2]=ce[2]*Math.cos(le)-ce[0]*Math.sin(le),C[0]=he[0]+te[0],C[1]=he[1]+te[1],C[2]=he[2]+te[2],C},Rh.rotateZ=function(C,H,te,le){var ce=[],he=[];return ce[0]=H[0]-te[0],ce[1]=H[1]-te[1],ce[2]=H[2]-te[2],he[0]=ce[0]*Math.cos(le)-ce[1]*Math.sin(le),he[1]=ce[0]*Math.sin(le)+ce[1]*Math.cos(le),he[2]=ce[2],C[0]=he[0]+te[0],C[1]=he[1]+te[1],C[2]=he[2]+te[2],C},Rh.angle=function(C,H){var te=C[0],le=C[1],ce=C[2],he=H[0],ue=H[1],de=H[2],_e=Math.sqrt(te*te+le*le+ce*ce)*Math.sqrt(he*he+ue*ue+de*de),ye=_e&&Wc(C,H)/_e;return Math.acos(Math.min(Math.max(ye,-1),1))},Rh.zero=function(C){return C[0]=0,C[1]=0,C[2]=0,C},Rh.str=function(C){return"vec3("+C[0]+", "+C[1]+", "+C[2]+")"},Rh.exactEquals=function(C,H){return C[0]===H[0]&&C[1]===H[1]&&C[2]===H[2]},Rh.equals=function(C,H){var te=C[0],le=C[1],ce=C[2],he=H[0],ue=H[1],de=H[2];return Math.abs(te-he)<=Lh.EPSILON*Math.max(1,Math.abs(te),Math.abs(he))&&Math.abs(le-ue)<=Lh.EPSILON*Math.max(1,Math.abs(le),Math.abs(ue))&&Math.abs(ce-de)<=Lh.EPSILON*Math.max(1,Math.abs(ce),Math.abs(de))},Rh.forEach=Rh.sqrLen=Rh.len=Rh.sqrDist=Rh.dist=Rh.div=Rh.mul=Rh.sub=void 0;var Lh=function(C,H){if(C&&C.__esModule)return C;if(null===C||"object"!==Bc(C)&&"function"!=typeof C)return{default:C};var te=Nc(void 0);if(te&&te.has(C))return te.get(C);var le={},ce=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var he in C)if("default"!==he&&Object.prototype.hasOwnProperty.call(C,he)){var ue=ce?Object.getOwnPropertyDescriptor(C,he):null;ue&&(ue.get||ue.set)?Object.defineProperty(le,he,ue):le[he]=C[he]}return le.default=C,te&&te.set(C,le),le}(uh);function Nc(C){if("function"!=typeof WeakMap)return null;var H=new WeakMap,te=new WeakMap;return(Nc=function(C){return C?te:H})(C)}function Uc(){var C=new Lh.ARRAY_TYPE(3);return Lh.ARRAY_TYPE!=Float32Array&&(C[0]=0,C[1]=0,C[2]=0),C}function Vc(C){return Math.hypot(C[0],C[1],C[2])}function jc(C,H,te){return C[0]=H[0]-te[0],C[1]=H[1]-te[1],C[2]=H[2]-te[2],C}function Gc(C,H,te){return C[0]=H[0]*te[0],C[1]=H[1]*te[1],C[2]=H[2]*te[2],C}function qc(C,H,te){return C[0]=H[0]/te[0],C[1]=H[1]/te[1],C[2]=H[2]/te[2],C}function Zc(C,H){return Math.hypot(H[0]-C[0],H[1]-C[1],H[2]-C[2])}function $c(C,H){var te=H[0]-C[0],le=H[1]-C[1],ce=H[2]-C[2];return te*te+le*le+ce*ce}function Hc(C){var H=C[0],te=C[1],le=C[2];return H*H+te*te+le*le}function Wc(C,H){return C[0]*H[0]+C[1]*H[1]+C[2]*H[2]}Rh.sub=jc,Rh.mul=Gc,Rh.div=qc,Rh.dist=Zc,Rh.sqrDist=$c,Rh.len=Vc,Rh.sqrLen=Hc;var Bh,Oh=(Bh=Uc(),function(C,H,te,le,ce,he){var ue,de;for(H||(H=3),te||(te=0),de=le?Math.min(le*H+te,C.length):C.length,ue=te;ue<de;ue+=H)Bh[0]=C[ue],Bh[1]=C[ue+1],Bh[2]=C[ue+2],ce(Bh,Bh,he),C[ue]=Bh[0],C[ue+1]=Bh[1],C[ue+2]=Bh[2];return C});Rh.forEach=Oh;var Fh={};function Jc(C){return Jc="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(C){return typeof C}:function(C){return C&&"function"==typeof Symbol&&C.constructor===Symbol&&C!==Symbol.prototype?"symbol":typeof C},Jc(C)}Object.defineProperty(Fh,"__esModule",{value:!0}),Fh.create=th,Fh.clone=function(C){var H=new Uh.ARRAY_TYPE(4);return H[0]=C[0],H[1]=C[1],H[2]=C[2],H[3]=C[3],H},Fh.fromValues=function(C,H,te,le){var ce=new Uh.ARRAY_TYPE(4);return ce[0]=C,ce[1]=H,ce[2]=te,ce[3]=le,ce},Fh.copy=function(C,H){return C[0]=H[0],C[1]=H[1],C[2]=H[2],C[3]=H[3],C},Fh.set=function(C,H,te,le,ce){return C[0]=H,C[1]=te,C[2]=le,C[3]=ce,C},Fh.add=function(C,H,te){return C[0]=H[0]+te[0],C[1]=H[1]+te[1],C[2]=H[2]+te[2],C[3]=H[3]+te[3],C},Fh.subtract=ih,Fh.multiply=rh,Fh.divide=nh,Fh.ceil=function(C,H){return C[0]=Math.ceil(H[0]),C[1]=Math.ceil(H[1]),C[2]=Math.ceil(H[2]),C[3]=Math.ceil(H[3]),C},Fh.floor=function(C,H){return C[0]=Math.floor(H[0]),C[1]=Math.floor(H[1]),C[2]=Math.floor(H[2]),C[3]=Math.floor(H[3]),C},Fh.min=function(C,H,te){return C[0]=Math.min(H[0],te[0]),C[1]=Math.min(H[1],te[1]),C[2]=Math.min(H[2],te[2]),C[3]=Math.min(H[3],te[3]),C},Fh.max=function(C,H,te){return C[0]=Math.max(H[0],te[0]),C[1]=Math.max(H[1],te[1]),C[2]=Math.max(H[2],te[2]),C[3]=Math.max(H[3],te[3]),C},Fh.round=function(C,H){return C[0]=Math.round(H[0]),C[1]=Math.round(H[1]),C[2]=Math.round(H[2]),C[3]=Math.round(H[3]),C},Fh.scale=function(C,H,te){return C[0]=H[0]*te,C[1]=H[1]*te,C[2]=H[2]*te,C[3]=H[3]*te,C},Fh.scaleAndAdd=function(C,H,te,le){return C[0]=H[0]+te[0]*le,C[1]=H[1]+te[1]*le,C[2]=H[2]+te[2]*le,C[3]=H[3]+te[3]*le,C},Fh.distance=oh,Fh.squaredDistance=sh,Fh.length=ah,Fh.squaredLength=lh,Fh.negate=function(C,H){return C[0]=-H[0],C[1]=-H[1],C[2]=-H[2],C[3]=-H[3],C},Fh.inverse=function(C,H){return C[0]=1/H[0],C[1]=1/H[1],C[2]=1/H[2],C[3]=1/H[3],C},Fh.normalize=function(C,H){var te=H[0],le=H[1],ce=H[2],he=H[3],ue=te*te+le*le+ce*ce+he*he;return ue>0&&(ue=1/Math.sqrt(ue)),C[0]=te*ue,C[1]=le*ue,C[2]=ce*ue,C[3]=he*ue,C},Fh.dot=function(C,H){return C[0]*H[0]+C[1]*H[1]+C[2]*H[2]+C[3]*H[3]},Fh.cross=function(C,H,te,le){var ce=te[0]*le[1]-te[1]*le[0],he=te[0]*le[2]-te[2]*le[0],ue=te[0]*le[3]-te[3]*le[0],de=te[1]*le[2]-te[2]*le[1],_e=te[1]*le[3]-te[3]*le[1],ye=te[2]*le[3]-te[3]*le[2],ve=H[0],Me=H[1],Se=H[2],Ae=H[3];return C[0]=Me*ye-Se*_e+Ae*de,C[1]=-ve*ye+Se*ue-Ae*he,C[2]=ve*_e-Me*ue+Ae*ce,C[3]=-ve*de+Me*he-Se*ce,C},Fh.lerp=function(C,H,te,le){var ce=H[0],he=H[1],ue=H[2],de=H[3];return C[0]=ce+le*(te[0]-ce),C[1]=he+le*(te[1]-he),C[2]=ue+le*(te[2]-ue),C[3]=de+le*(te[3]-de),C},Fh.random=function(C,H){var te,le,ce,he,ue,de;H=H||1;do{ue=(te=2*Uh.RANDOM()-1)*te+(le=2*Uh.RANDOM()-1)*le}while(ue>=1);do{de=(ce=2*Uh.RANDOM()-1)*ce+(he=2*Uh.RANDOM()-1)*he}while(de>=1);var _e=Math.sqrt((1-ue)/de);return C[0]=H*te,C[1]=H*le,C[2]=H*ce*_e,C[3]=H*he*_e,C},Fh.transformMat4=function(C,H,te){var le=H[0],ce=H[1],he=H[2],ue=H[3];return C[0]=te[0]*le+te[4]*ce+te[8]*he+te[12]*ue,C[1]=te[1]*le+te[5]*ce+te[9]*he+te[13]*ue,C[2]=te[2]*le+te[6]*ce+te[10]*he+te[14]*ue,C[3]=te[3]*le+te[7]*ce+te[11]*he+te[15]*ue,C},Fh.transformQuat=function(C,H,te){var le=H[0],ce=H[1],he=H[2],ue=te[0],de=te[1],_e=te[2],ye=te[3],ve=ye*le+de*he-_e*ce,Me=ye*ce+_e*le-ue*he,Se=ye*he+ue*ce-de*le,Ae=-ue*le-de*ce-_e*he;return C[0]=ve*ye+Ae*-ue+Me*-_e-Se*-de,C[1]=Me*ye+Ae*-de+Se*-ue-ve*-_e,C[2]=Se*ye+Ae*-_e+ve*-de-Me*-ue,C[3]=H[3],C},Fh.zero=function(C){return C[0]=0,C[1]=0,C[2]=0,C[3]=0,C},Fh.str=function(C){return"vec4("+C[0]+", "+C[1]+", "+C[2]+", "+C[3]+")"},Fh.exactEquals=function(C,H){return C[0]===H[0]&&C[1]===H[1]&&C[2]===H[2]&&C[3]===H[3]},Fh.equals=function(C,H){var te=C[0],le=C[1],ce=C[2],he=C[3],ue=H[0],de=H[1],_e=H[2],ye=H[3];return Math.abs(te-ue)<=Uh.EPSILON*Math.max(1,Math.abs(te),Math.abs(ue))&&Math.abs(le-de)<=Uh.EPSILON*Math.max(1,Math.abs(le),Math.abs(de))&&Math.abs(ce-_e)<=Uh.EPSILON*Math.max(1,Math.abs(ce),Math.abs(_e))&&Math.abs(he-ye)<=Uh.EPSILON*Math.max(1,Math.abs(he),Math.abs(ye))},Fh.forEach=Fh.sqrLen=Fh.len=Fh.sqrDist=Fh.dist=Fh.div=Fh.mul=Fh.sub=void 0;var Uh=function(C,H){if(C&&C.__esModule)return C;if(null===C||"object"!==Jc(C)&&"function"!=typeof C)return{default:C};var te=eh(void 0);if(te&&te.has(C))return te.get(C);var le={},ce=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var he in C)if("default"!==he&&Object.prototype.hasOwnProperty.call(C,he)){var ue=ce?Object.getOwnPropertyDescriptor(C,he):null;ue&&(ue.get||ue.set)?Object.defineProperty(le,he,ue):le[he]=C[he]}return le.default=C,te&&te.set(C,le),le}(uh);function eh(C){if("function"!=typeof WeakMap)return null;var H=new WeakMap,te=new WeakMap;return(eh=function(C){return C?te:H})(C)}function th(){var C=new Uh.ARRAY_TYPE(4);return Uh.ARRAY_TYPE!=Float32Array&&(C[0]=0,C[1]=0,C[2]=0,C[3]=0),C}function ih(C,H,te){return C[0]=H[0]-te[0],C[1]=H[1]-te[1],C[2]=H[2]-te[2],C[3]=H[3]-te[3],C}function rh(C,H,te){return C[0]=H[0]*te[0],C[1]=H[1]*te[1],C[2]=H[2]*te[2],C[3]=H[3]*te[3],C}function nh(C,H,te){return C[0]=H[0]/te[0],C[1]=H[1]/te[1],C[2]=H[2]/te[2],C[3]=H[3]/te[3],C}function oh(C,H){return Math.hypot(H[0]-C[0],H[1]-C[1],H[2]-C[2],H[3]-C[3])}function sh(C,H){var te=H[0]-C[0],le=H[1]-C[1],ce=H[2]-C[2],he=H[3]-C[3];return te*te+le*le+ce*ce+he*he}function ah(C){return Math.hypot(C[0],C[1],C[2],C[3])}function lh(C){var H=C[0],te=C[1],le=C[2],ce=C[3];return H*H+te*te+le*le+ce*ce}Fh.sub=ih,Fh.mul=rh,Fh.div=nh,Fh.dist=oh,Fh.sqrDist=sh,Fh.len=ah,Fh.sqrLen=lh;var Vh=function(){var C=th();return function(H,te,le,ce,he,ue){var de,_e;for(te||(te=4),le||(le=0),_e=ce?Math.min(ce*te+le,H.length):H.length,de=le;de<_e;de+=te)C[0]=H[de],C[1]=H[de+1],C[2]=H[de+2],C[3]=H[de+3],he(C,C,ue),H[de]=C[0],H[de+1]=C[1],H[de+2]=C[2],H[de+3]=C[3];return H}}();function hh(C){return hh="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(C){return typeof C}:function(C){return C&&"function"==typeof Symbol&&C.constructor===Symbol&&C!==Symbol.prototype?"symbol":typeof C},hh(C)}Fh.forEach=Vh,Object.defineProperty(kh,"__esModule",{value:!0}),kh.create=gh,kh.identity=function(C){return C[0]=0,C[1]=0,C[2]=0,C[3]=1,C},kh.setAxisAngle=yh,kh.getAxisAngle=function(C,H){var te=2*Math.acos(H[3]),le=Math.sin(te/2);return le>jh.EPSILON?(C[0]=H[0]/le,C[1]=H[1]/le,C[2]=H[2]/le):(C[0]=1,C[1]=0,C[2]=0),te},kh.getAngle=function(C,H){var te=Qh(C,H);return Math.acos(2*te*te-1)},kh.multiply=xh,kh.rotateX=function(C,H,te){te*=.5;var le=H[0],ce=H[1],he=H[2],ue=H[3],de=Math.sin(te),_e=Math.cos(te);return C[0]=le*_e+ue*de,C[1]=ce*_e+he*de,C[2]=he*_e-ce*de,C[3]=ue*_e-le*de,C},kh.rotateY=function(C,H,te){te*=.5;var le=H[0],ce=H[1],he=H[2],ue=H[3],de=Math.sin(te),_e=Math.cos(te);return C[0]=le*_e-he*de,C[1]=ce*_e+ue*de,C[2]=he*_e+le*de,C[3]=ue*_e-ce*de,C},kh.rotateZ=function(C,H,te){te*=.5;var le=H[0],ce=H[1],he=H[2],ue=H[3],de=Math.sin(te),_e=Math.cos(te);return C[0]=le*_e+ce*de,C[1]=ce*_e-le*de,C[2]=he*_e+ue*de,C[3]=ue*_e-he*de,C},kh.calculateW=function(C,H){var te=H[0],le=H[1],ce=H[2];return C[0]=te,C[1]=le,C[2]=ce,C[3]=Math.sqrt(Math.abs(1-te*te-le*le-ce*ce)),C},kh.exp=vh,kh.ln=bh,kh.pow=function(C,H,te){return bh(C,H),Kh(C,C,te),vh(C,C),C},kh.slerp=wh,kh.random=function(C){var H=jh.RANDOM(),te=jh.RANDOM(),le=jh.RANDOM(),ce=Math.sqrt(1-H),he=Math.sqrt(H);return C[0]=ce*Math.sin(2*Math.PI*te),C[1]=ce*Math.cos(2*Math.PI*te),C[2]=he*Math.sin(2*Math.PI*le),C[3]=he*Math.cos(2*Math.PI*le),C},kh.invert=function(C,H){var te=H[0],le=H[1],ce=H[2],he=H[3],ue=te*te+le*le+ce*ce+he*he,de=ue?1/ue:0;return C[0]=-te*de,C[1]=-le*de,C[2]=-ce*de,C[3]=he*de,C},kh.conjugate=function(C,H){return C[0]=-H[0],C[1]=-H[1],C[2]=-H[2],C[3]=H[3],C},kh.fromMat3=Th,kh.fromEuler=function(C,H,te,le){var ce=.5*Math.PI/180;H*=ce,te*=ce,le*=ce;var he=Math.sin(H),ue=Math.cos(H),de=Math.sin(te),_e=Math.cos(te),ye=Math.sin(le),ve=Math.cos(le);return C[0]=he*_e*ve-ue*de*ye,C[1]=ue*de*ve+he*_e*ye,C[2]=ue*_e*ye-he*de*ve,C[3]=ue*_e*ve+he*de*ye,C},kh.str=function(C){return"quat("+C[0]+", "+C[1]+", "+C[2]+", "+C[3]+")"},kh.setAxes=kh.sqlerp=kh.rotationTo=kh.equals=kh.exactEquals=kh.normalize=kh.sqrLen=kh.squaredLength=kh.len=kh.length=kh.lerp=kh.dot=kh.scale=kh.mul=kh.add=kh.set=kh.copy=kh.fromValues=kh.clone=void 0;var jh=_h(uh),Wh=_h(Ch),Xh=_h(Rh),Yh=_h(Fh);function mh(C){if("function"!=typeof WeakMap)return null;var H=new WeakMap,te=new WeakMap;return(mh=function(C){return C?te:H})(C)}function _h(C,H){if(!H&&C&&C.__esModule)return C;if(null===C||"object"!==hh(C)&&"function"!=typeof C)return{default:C};var te=mh(H);if(te&&te.has(C))return te.get(C);var le={},ce=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var he in C)if("default"!==he&&Object.prototype.hasOwnProperty.call(C,he)){var ue=ce?Object.getOwnPropertyDescriptor(C,he):null;ue&&(ue.get||ue.set)?Object.defineProperty(le,he,ue):le[he]=C[he]}return le.default=C,te&&te.set(C,le),le}function gh(){var C=new jh.ARRAY_TYPE(4);return jh.ARRAY_TYPE!=Float32Array&&(C[0]=0,C[1]=0,C[2]=0),C[3]=1,C}function yh(C,H,te){te*=.5;var le=Math.sin(te);return C[0]=le*H[0],C[1]=le*H[1],C[2]=le*H[2],C[3]=Math.cos(te),C}function xh(C,H,te){var le=H[0],ce=H[1],he=H[2],ue=H[3],de=te[0],_e=te[1],ye=te[2],ve=te[3];return C[0]=le*ve+ue*de+ce*ye-he*_e,C[1]=ce*ve+ue*_e+he*de-le*ye,C[2]=he*ve+ue*ye+le*_e-ce*de,C[3]=ue*ve-le*de-ce*_e-he*ye,C}function vh(C,H){var te=H[0],le=H[1],ce=H[2],he=H[3],ue=Math.sqrt(te*te+le*le+ce*ce),de=Math.exp(he),_e=ue>0?de*Math.sin(ue)/ue:0;return C[0]=te*_e,C[1]=le*_e,C[2]=ce*_e,C[3]=de*Math.cos(ue),C}function bh(C,H){var te=H[0],le=H[1],ce=H[2],he=H[3],ue=Math.sqrt(te*te+le*le+ce*ce),de=ue>0?Math.atan2(ue,he)/ue:0;return C[0]=te*de,C[1]=le*de,C[2]=ce*de,C[3]=.5*Math.log(te*te+le*le+ce*ce+he*he),C}function wh(C,H,te,le){var ce,he,ue,de,_e,ye=H[0],ve=H[1],Me=H[2],Se=H[3],Ae=te[0],Ce=te[1],Oe=te[2],Ne=te[3];return(he=ye*Ae+ve*Ce+Me*Oe+Se*Ne)<0&&(he=-he,Ae=-Ae,Ce=-Ce,Oe=-Oe,Ne=-Ne),1-he>jh.EPSILON?(ce=Math.acos(he),ue=Math.sin(ce),de=Math.sin((1-le)*ce)/ue,_e=Math.sin(le*ce)/ue):(de=1-le,_e=le),C[0]=de*ye+_e*Ae,C[1]=de*ve+_e*Ce,C[2]=de*Me+_e*Oe,C[3]=de*Se+_e*Ne,C}function Th(C,H){var te,le=H[0]+H[4]+H[8];if(le>0)te=Math.sqrt(le+1),C[3]=.5*te,C[0]=(H[5]-H[7])*(te=.5/te),C[1]=(H[6]-H[2])*te,C[2]=(H[1]-H[3])*te;else{var ce=0;H[4]>H[0]&&(ce=1),H[8]>H[3*ce+ce]&&(ce=2);var he=(ce+1)%3,ue=(ce+2)%3;te=Math.sqrt(H[3*ce+ce]-H[3*he+he]-H[3*ue+ue]+1),C[ce]=.5*te,C[3]=(H[3*he+ue]-H[3*ue+he])*(te=.5/te),C[he]=(H[3*he+ce]+H[3*ce+he])*te,C[ue]=(H[3*ue+ce]+H[3*ce+ue])*te}return C}kh.clone=Yh.clone,kh.fromValues=Yh.fromValues,kh.copy=Yh.copy,kh.set=Yh.set,kh.add=Yh.add,kh.mul=xh;var Kh=Yh.scale;kh.scale=Kh;var Qh=Yh.dot;kh.dot=Qh,kh.lerp=Yh.lerp;var cu=Yh.length;kh.length=cu,kh.len=cu;var uu=Yh.squaredLength;kh.squaredLength=uu,kh.sqrLen=uu;var du=Yh.normalize;kh.normalize=du,kh.exactEquals=Yh.exactEquals,kh.equals=Yh.equals;var pu,fu,mu,_u=(pu=Xh.create(),fu=Xh.fromValues(1,0,0),mu=Xh.fromValues(0,1,0),function(C,H,te){var le=Xh.dot(H,te);return le<-.999999?(Xh.cross(pu,fu,H),Xh.len(pu)<1e-6&&Xh.cross(pu,mu,H),Xh.normalize(pu,pu),yh(C,pu,Math.PI),C):le>.999999?(C[0]=0,C[1]=0,C[2]=0,C[3]=1,C):(Xh.cross(pu,H,te),C[0]=pu[0],C[1]=pu[1],C[2]=pu[2],C[3]=1+le,du(C,C))});kh.rotationTo=_u;var gu,yu,xu=(gu=gh(),yu=gh(),function(C,H,te,le,ce,he){return wh(gu,H,ce,he),wh(yu,te,le,he),wh(C,gu,yu,2*he*(1-he)),C});kh.sqlerp=xu;var vu,bu=(vu=Wh.create(),function(C,H,te,le){return vu[0]=te[0],vu[3]=te[1],vu[6]=te[2],vu[1]=le[0],vu[4]=le[1],vu[7]=le[2],vu[2]=-H[0],vu[5]=-H[1],vu[8]=-H[2],du(C,Th(C,vu))});kh.setAxes=bu;var wu={};function Nh(C){return Nh="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(C){return typeof C}:function(C){return C&&"function"==typeof Symbol&&C.constructor===Symbol&&C!==Symbol.prototype?"symbol":typeof C},Nh(C)}Object.defineProperty(wu,"__esModule",{value:!0}),wu.create=function(){var C=new Tu.ARRAY_TYPE(8);return Tu.ARRAY_TYPE!=Float32Array&&(C[0]=0,C[1]=0,C[2]=0,C[4]=0,C[5]=0,C[6]=0,C[7]=0),C[3]=1,C},wu.clone=function(C){var H=new Tu.ARRAY_TYPE(8);return H[0]=C[0],H[1]=C[1],H[2]=C[2],H[3]=C[3],H[4]=C[4],H[5]=C[5],H[6]=C[6],H[7]=C[7],H},wu.fromValues=function(C,H,te,le,ce,he,ue,de){var _e=new Tu.ARRAY_TYPE(8);return _e[0]=C,_e[1]=H,_e[2]=te,_e[3]=le,_e[4]=ce,_e[5]=he,_e[6]=ue,_e[7]=de,_e},wu.fromRotationTranslationValues=function(C,H,te,le,ce,he,ue){var de=new Tu.ARRAY_TYPE(8);de[0]=C,de[1]=H,de[2]=te,de[3]=le;var _e=.5*ce,ye=.5*he,ve=.5*ue;return de[4]=_e*le+ye*te-ve*H,de[5]=ye*le+ve*C-_e*te,de[6]=ve*le+_e*H-ye*C,de[7]=-_e*C-ye*H-ve*te,de},wu.fromRotationTranslation=Zh,wu.fromTranslation=function(C,H){return C[0]=0,C[1]=0,C[2]=0,C[3]=1,C[4]=.5*H[0],C[5]=.5*H[1],C[6]=.5*H[2],C[7]=0,C},wu.fromRotation=function(C,H){return C[0]=H[0],C[1]=H[1],C[2]=H[2],C[3]=H[3],C[4]=0,C[5]=0,C[6]=0,C[7]=0,C},wu.fromMat4=function(C,H){var te=Eu.create();Mu.getRotation(te,H);var le=new Tu.ARRAY_TYPE(3);return Mu.getTranslation(le,H),Zh(C,te,le),C},wu.copy=$h,wu.identity=function(C){return C[0]=0,C[1]=0,C[2]=0,C[3]=1,C[4]=0,C[5]=0,C[6]=0,C[7]=0,C},wu.set=function(C,H,te,le,ce,he,ue,de,_e){return C[0]=H,C[1]=te,C[2]=le,C[3]=ce,C[4]=he,C[5]=ue,C[6]=de,C[7]=_e,C},wu.getDual=function(C,H){return C[0]=H[4],C[1]=H[5],C[2]=H[6],C[3]=H[7],C},wu.setDual=function(C,H){return C[4]=H[0],C[5]=H[1],C[6]=H[2],C[7]=H[3],C},wu.getTranslation=function(C,H){var te=H[4],le=H[5],ce=H[6],he=H[7],ue=-H[0],de=-H[1],_e=-H[2],ye=H[3];return C[0]=2*(te*ye+he*ue+le*_e-ce*de),C[1]=2*(le*ye+he*de+ce*ue-te*_e),C[2]=2*(ce*ye+he*_e+te*de-le*ue),C},wu.translate=function(C,H,te){var le=H[0],ce=H[1],he=H[2],ue=H[3],de=.5*te[0],_e=.5*te[1],ye=.5*te[2],ve=H[4],Me=H[5],Se=H[6],Ae=H[7];return C[0]=le,C[1]=ce,C[2]=he,C[3]=ue,C[4]=ue*de+ce*ye-he*_e+ve,C[5]=ue*_e+he*de-le*ye+Me,C[6]=ue*ye+le*_e-ce*de+Se,C[7]=-le*de-ce*_e-he*ye+Ae,C},wu.rotateX=function(C,H,te){var le=-H[0],ce=-H[1],he=-H[2],ue=H[3],de=H[4],_e=H[5],ye=H[6],ve=H[7],Me=de*ue+ve*le+_e*he-ye*ce,Se=_e*ue+ve*ce+ye*le-de*he,Ae=ye*ue+ve*he+de*ce-_e*le,Ce=ve*ue-de*le-_e*ce-ye*he;return Eu.rotateX(C,H,te),C[4]=Me*(ue=C[3])+Ce*(le=C[0])+Se*(he=C[2])-Ae*(ce=C[1]),C[5]=Se*ue+Ce*ce+Ae*le-Me*he,C[6]=Ae*ue+Ce*he+Me*ce-Se*le,C[7]=Ce*ue-Me*le-Se*ce-Ae*he,C},wu.rotateY=function(C,H,te){var le=-H[0],ce=-H[1],he=-H[2],ue=H[3],de=H[4],_e=H[5],ye=H[6],ve=H[7],Me=de*ue+ve*le+_e*he-ye*ce,Se=_e*ue+ve*ce+ye*le-de*he,Ae=ye*ue+ve*he+de*ce-_e*le,Ce=ve*ue-de*le-_e*ce-ye*he;return Eu.rotateY(C,H,te),C[4]=Me*(ue=C[3])+Ce*(le=C[0])+Se*(he=C[2])-Ae*(ce=C[1]),C[5]=Se*ue+Ce*ce+Ae*le-Me*he,C[6]=Ae*ue+Ce*he+Me*ce-Se*le,C[7]=Ce*ue-Me*le-Se*ce-Ae*he,C},wu.rotateZ=function(C,H,te){var le=-H[0],ce=-H[1],he=-H[2],ue=H[3],de=H[4],_e=H[5],ye=H[6],ve=H[7],Me=de*ue+ve*le+_e*he-ye*ce,Se=_e*ue+ve*ce+ye*le-de*he,Ae=ye*ue+ve*he+de*ce-_e*le,Ce=ve*ue-de*le-_e*ce-ye*he;return Eu.rotateZ(C,H,te),C[4]=Me*(ue=C[3])+Ce*(le=C[0])+Se*(he=C[2])-Ae*(ce=C[1]),C[5]=Se*ue+Ce*ce+Ae*le-Me*he,C[6]=Ae*ue+Ce*he+Me*ce-Se*le,C[7]=Ce*ue-Me*le-Se*ce-Ae*he,C},wu.rotateByQuatAppend=function(C,H,te){var le=te[0],ce=te[1],he=te[2],ue=te[3],de=H[0],_e=H[1],ye=H[2],ve=H[3];return C[0]=de*ue+ve*le+_e*he-ye*ce,C[1]=_e*ue+ve*ce+ye*le-de*he,C[2]=ye*ue+ve*he+de*ce-_e*le,C[3]=ve*ue-de*le-_e*ce-ye*he,C[4]=(de=H[4])*ue+(ve=H[7])*le+(_e=H[5])*he-(ye=H[6])*ce,C[5]=_e*ue+ve*ce+ye*le-de*he,C[6]=ye*ue+ve*he+de*ce-_e*le,C[7]=ve*ue-de*le-_e*ce-ye*he,C},wu.rotateByQuatPrepend=function(C,H,te){var le=H[0],ce=H[1],he=H[2],ue=H[3],de=te[0],_e=te[1],ye=te[2],ve=te[3];return C[0]=le*ve+ue*de+ce*ye-he*_e,C[1]=ce*ve+ue*_e+he*de-le*ye,C[2]=he*ve+ue*ye+le*_e-ce*de,C[3]=ue*ve-le*de-ce*_e-he*ye,C[4]=le*(ve=te[7])+ue*(de=te[4])+ce*(ye=te[6])-he*(_e=te[5]),C[5]=ce*ve+ue*_e+he*de-le*ye,C[6]=he*ve+ue*ye+le*_e-ce*de,C[7]=ue*ve-le*de-ce*_e-he*ye,C},wu.rotateAroundAxis=function(C,H,te,le){if(Math.abs(le)<Tu.EPSILON)return $h(C,H);var ce=Math.hypot(te[0],te[1],te[2]);le*=.5;var he=Math.sin(le),ue=he*te[0]/ce,de=he*te[1]/ce,_e=he*te[2]/ce,ye=Math.cos(le),ve=H[0],Me=H[1],Se=H[2],Ae=H[3];C[0]=ve*ye+Ae*ue+Me*_e-Se*de,C[1]=Me*ye+Ae*de+Se*ue-ve*_e,C[2]=Se*ye+Ae*_e+ve*de-Me*ue,C[3]=Ae*ye-ve*ue-Me*de-Se*_e;var Ce=H[4],Oe=H[5],Ne=H[6],je=H[7];return C[4]=Ce*ye+je*ue+Oe*_e-Ne*de,C[5]=Oe*ye+je*de+Ne*ue-Ce*_e,C[6]=Ne*ye+je*_e+Ce*de-Oe*ue,C[7]=je*ye-Ce*ue-Oe*de-Ne*_e,C},wu.add=function(C,H,te){return C[0]=H[0]+te[0],C[1]=H[1]+te[1],C[2]=H[2]+te[2],C[3]=H[3]+te[3],C[4]=H[4]+te[4],C[5]=H[5]+te[5],C[6]=H[6]+te[6],C[7]=H[7]+te[7],C},wu.multiply=Hh,wu.scale=function(C,H,te){return C[0]=H[0]*te,C[1]=H[1]*te,C[2]=H[2]*te,C[3]=H[3]*te,C[4]=H[4]*te,C[5]=H[5]*te,C[6]=H[6]*te,C[7]=H[7]*te,C},wu.lerp=function(C,H,te,le){var ce=1-le;return Au(H,te)<0&&(le=-le),C[0]=H[0]*ce+te[0]*le,C[1]=H[1]*ce+te[1]*le,C[2]=H[2]*ce+te[2]*le,C[3]=H[3]*ce+te[3]*le,C[4]=H[4]*ce+te[4]*le,C[5]=H[5]*ce+te[5]*le,C[6]=H[6]*ce+te[6]*le,C[7]=H[7]*ce+te[7]*le,C},wu.invert=function(C,H){var te=zu(H);return C[0]=-H[0]/te,C[1]=-H[1]/te,C[2]=-H[2]/te,C[3]=H[3]/te,C[4]=-H[4]/te,C[5]=-H[5]/te,C[6]=-H[6]/te,C[7]=H[7]/te,C},wu.conjugate=function(C,H){return C[0]=-H[0],C[1]=-H[1],C[2]=-H[2],C[3]=H[3],C[4]=-H[4],C[5]=-H[5],C[6]=-H[6],C[7]=H[7],C},wu.normalize=function(C,H){var te=zu(H);if(te>0){te=Math.sqrt(te);var le=H[0]/te,ce=H[1]/te,he=H[2]/te,ue=H[3]/te,de=H[4],_e=H[5],ye=H[6],ve=H[7],Me=le*de+ce*_e+he*ye+ue*ve;C[0]=le,C[1]=ce,C[2]=he,C[3]=ue,C[4]=(de-le*Me)/te,C[5]=(_e-ce*Me)/te,C[6]=(ye-he*Me)/te,C[7]=(ve-ue*Me)/te}return C},wu.str=function(C){return"quat2("+C[0]+", "+C[1]+", "+C[2]+", "+C[3]+", "+C[4]+", "+C[5]+", "+C[6]+", "+C[7]+")"},wu.exactEquals=function(C,H){return C[0]===H[0]&&C[1]===H[1]&&C[2]===H[2]&&C[3]===H[3]&&C[4]===H[4]&&C[5]===H[5]&&C[6]===H[6]&&C[7]===H[7]},wu.equals=function(C,H){var te=C[0],le=C[1],ce=C[2],he=C[3],ue=C[4],de=C[5],_e=C[6],ye=C[7],ve=H[0],Me=H[1],Se=H[2],Ae=H[3],Ce=H[4],Oe=H[5],Ne=H[6],je=H[7];return Math.abs(te-ve)<=Tu.EPSILON*Math.max(1,Math.abs(te),Math.abs(ve))&&Math.abs(le-Me)<=Tu.EPSILON*Math.max(1,Math.abs(le),Math.abs(Me))&&Math.abs(ce-Se)<=Tu.EPSILON*Math.max(1,Math.abs(ce),Math.abs(Se))&&Math.abs(he-Ae)<=Tu.EPSILON*Math.max(1,Math.abs(he),Math.abs(Ae))&&Math.abs(ue-Ce)<=Tu.EPSILON*Math.max(1,Math.abs(ue),Math.abs(Ce))&&Math.abs(de-Oe)<=Tu.EPSILON*Math.max(1,Math.abs(de),Math.abs(Oe))&&Math.abs(_e-Ne)<=Tu.EPSILON*Math.max(1,Math.abs(_e),Math.abs(Ne))&&Math.abs(ye-je)<=Tu.EPSILON*Math.max(1,Math.abs(ye),Math.abs(je))},wu.sqrLen=wu.squaredLength=wu.len=wu.length=wu.dot=wu.mul=wu.setReal=wu.getReal=void 0;var Tu=qh(uh),Eu=qh(kh),Mu=qh(Dh);function Gh(C){if("function"!=typeof WeakMap)return null;var H=new WeakMap,te=new WeakMap;return(Gh=function(C){return C?te:H})(C)}function qh(C,H){if(!H&&C&&C.__esModule)return C;if(null===C||"object"!==Nh(C)&&"function"!=typeof C)return{default:C};var te=Gh(H);if(te&&te.has(C))return te.get(C);var le={},ce=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var he in C)if("default"!==he&&Object.prototype.hasOwnProperty.call(C,he)){var ue=ce?Object.getOwnPropertyDescriptor(C,he):null;ue&&(ue.get||ue.set)?Object.defineProperty(le,he,ue):le[he]=C[he]}return le.default=C,te&&te.set(C,le),le}function Zh(C,H,te){var le=.5*te[0],ce=.5*te[1],he=.5*te[2],ue=H[0],de=H[1],_e=H[2],ye=H[3];return C[0]=ue,C[1]=de,C[2]=_e,C[3]=ye,C[4]=le*ye+ce*_e-he*de,C[5]=ce*ye+he*ue-le*_e,C[6]=he*ye+le*de-ce*ue,C[7]=-le*ue-ce*de-he*_e,C}function $h(C,H){return C[0]=H[0],C[1]=H[1],C[2]=H[2],C[3]=H[3],C[4]=H[4],C[5]=H[5],C[6]=H[6],C[7]=H[7],C}function Hh(C,H,te){var le=H[0],ce=H[1],he=H[2],ue=H[3],de=te[4],_e=te[5],ye=te[6],ve=te[7],Me=H[4],Se=H[5],Ae=H[6],Ce=H[7],Oe=te[0],Ne=te[1],je=te[2],Ge=te[3];return C[0]=le*Ge+ue*Oe+ce*je-he*Ne,C[1]=ce*Ge+ue*Ne+he*Oe-le*je,C[2]=he*Ge+ue*je+le*Ne-ce*Oe,C[3]=ue*Ge-le*Oe-ce*Ne-he*je,C[4]=le*ve+ue*de+ce*ye-he*_e+Me*Ge+Ce*Oe+Se*je-Ae*Ne,C[5]=ce*ve+ue*_e+he*de-le*ye+Se*Ge+Ce*Ne+Ae*Oe-Me*je,C[6]=he*ve+ue*ye+le*_e-ce*de+Ae*Ge+Ce*je+Me*Ne-Se*Oe,C[7]=ue*ve-le*de-ce*_e-he*ye+Ce*Ge-Me*Oe-Se*Ne-Ae*je,C}wu.getReal=Eu.copy,wu.setReal=Eu.copy,wu.mul=Hh;var Au=Eu.dot;wu.dot=Au;var Cu=Eu.length;wu.length=Cu,wu.len=Cu;var zu=Eu.squaredLength;wu.squaredLength=zu,wu.sqrLen=zu;var Du={};function Jh(C){return Jh="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(C){return typeof C}:function(C){return C&&"function"==typeof Symbol&&C.constructor===Symbol&&C!==Symbol.prototype?"symbol":typeof C},Jh(C)}Object.defineProperty(Du,"__esModule",{value:!0}),Du.create=tu,Du.clone=function(C){var H=new Pu.ARRAY_TYPE(2);return H[0]=C[0],H[1]=C[1],H},Du.fromValues=function(C,H){var te=new Pu.ARRAY_TYPE(2);return te[0]=C,te[1]=H,te},Du.copy=function(C,H){return C[0]=H[0],C[1]=H[1],C},Du.set=function(C,H,te){return C[0]=H,C[1]=te,C},Du.add=function(C,H,te){return C[0]=H[0]+te[0],C[1]=H[1]+te[1],C},Du.subtract=iu,Du.multiply=ru,Du.divide=nu,Du.ceil=function(C,H){return C[0]=Math.ceil(H[0]),C[1]=Math.ceil(H[1]),C},Du.floor=function(C,H){return C[0]=Math.floor(H[0]),C[1]=Math.floor(H[1]),C},Du.min=function(C,H,te){return C[0]=Math.min(H[0],te[0]),C[1]=Math.min(H[1],te[1]),C},Du.max=function(C,H,te){return C[0]=Math.max(H[0],te[0]),C[1]=Math.max(H[1],te[1]),C},Du.round=function(C,H){return C[0]=Math.round(H[0]),C[1]=Math.round(H[1]),C},Du.scale=function(C,H,te){return C[0]=H[0]*te,C[1]=H[1]*te,C},Du.scaleAndAdd=function(C,H,te,le){return C[0]=H[0]+te[0]*le,C[1]=H[1]+te[1]*le,C},Du.distance=ou,Du.squaredDistance=su,Du.length=au,Du.squaredLength=lu,Du.negate=function(C,H){return C[0]=-H[0],C[1]=-H[1],C},Du.inverse=function(C,H){return C[0]=1/H[0],C[1]=1/H[1],C},Du.normalize=function(C,H){var te=H[0],le=H[1],ce=te*te+le*le;return ce>0&&(ce=1/Math.sqrt(ce)),C[0]=H[0]*ce,C[1]=H[1]*ce,C},Du.dot=function(C,H){return C[0]*H[0]+C[1]*H[1]},Du.cross=function(C,H,te){var le=H[0]*te[1]-H[1]*te[0];return C[0]=C[1]=0,C[2]=le,C},Du.lerp=function(C,H,te,le){var ce=H[0],he=H[1];return C[0]=ce+le*(te[0]-ce),C[1]=he+le*(te[1]-he),C},Du.random=function(C,H){H=H||1;var te=2*Pu.RANDOM()*Math.PI;return C[0]=Math.cos(te)*H,C[1]=Math.sin(te)*H,C},Du.transformMat2=function(C,H,te){var le=H[0],ce=H[1];return C[0]=te[0]*le+te[2]*ce,C[1]=te[1]*le+te[3]*ce,C},Du.transformMat2d=function(C,H,te){var le=H[0],ce=H[1];return C[0]=te[0]*le+te[2]*ce+te[4],C[1]=te[1]*le+te[3]*ce+te[5],C},Du.transformMat3=function(C,H,te){var le=H[0],ce=H[1];return C[0]=te[0]*le+te[3]*ce+te[6],C[1]=te[1]*le+te[4]*ce+te[7],C},Du.transformMat4=function(C,H,te){var le=H[0],ce=H[1];return C[0]=te[0]*le+te[4]*ce+te[12],C[1]=te[1]*le+te[5]*ce+te[13],C},Du.rotate=function(C,H,te,le){var ce=H[0]-te[0],he=H[1]-te[1],ue=Math.sin(le),de=Math.cos(le);return C[0]=ce*de-he*ue+te[0],C[1]=ce*ue+he*de+te[1],C},Du.angle=function(C,H){var te=C[0],le=C[1],ce=H[0],he=H[1],ue=Math.sqrt(te*te+le*le)*Math.sqrt(ce*ce+he*he);return Math.acos(Math.min(Math.max(ue&&(te*ce+le*he)/ue,-1),1))},Du.zero=function(C){return C[0]=0,C[1]=0,C},Du.str=function(C){return"vec2("+C[0]+", "+C[1]+")"},Du.exactEquals=function(C,H){return C[0]===H[0]&&C[1]===H[1]},Du.equals=function(C,H){var te=C[0],le=C[1],ce=H[0],he=H[1];return Math.abs(te-ce)<=Pu.EPSILON*Math.max(1,Math.abs(te),Math.abs(ce))&&Math.abs(le-he)<=Pu.EPSILON*Math.max(1,Math.abs(le),Math.abs(he))},Du.forEach=Du.sqrLen=Du.sqrDist=Du.dist=Du.div=Du.mul=Du.sub=Du.len=void 0;var Pu=function(C,H){if(C&&C.__esModule)return C;if(null===C||"object"!==Jh(C)&&"function"!=typeof C)return{default:C};var te=eu(void 0);if(te&&te.has(C))return te.get(C);var le={},ce=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var he in C)if("default"!==he&&Object.prototype.hasOwnProperty.call(C,he)){var ue=ce?Object.getOwnPropertyDescriptor(C,he):null;ue&&(ue.get||ue.set)?Object.defineProperty(le,he,ue):le[he]=C[he]}return le.default=C,te&&te.set(C,le),le}(uh);function eu(C){if("function"!=typeof WeakMap)return null;var H=new WeakMap,te=new WeakMap;return(eu=function(C){return C?te:H})(C)}function tu(){var C=new Pu.ARRAY_TYPE(2);return Pu.ARRAY_TYPE!=Float32Array&&(C[0]=0,C[1]=0),C}function iu(C,H,te){return C[0]=H[0]-te[0],C[1]=H[1]-te[1],C}function ru(C,H,te){return C[0]=H[0]*te[0],C[1]=H[1]*te[1],C}function nu(C,H,te){return C[0]=H[0]/te[0],C[1]=H[1]/te[1],C}function ou(C,H){return Math.hypot(H[0]-C[0],H[1]-C[1])}function su(C,H){var te=H[0]-C[0],le=H[1]-C[1];return te*te+le*le}function au(C){return Math.hypot(C[0],C[1])}function lu(C){var H=C[0],te=C[1];return H*H+te*te}Du.len=au,Du.sub=iu,Du.mul=ru,Du.div=nu,Du.dist=ou,Du.sqrDist=su,Du.sqrLen=lu;var Ru=function(){var C=tu();return function(H,te,le,ce,he,ue){var de,_e;for(te||(te=2),le||(le=0),_e=ce?Math.min(ce*te+le,H.length):H.length,de=le;de<_e;de+=te)C[0]=H[de],C[1]=H[de+1],he(C,C,ue),H[de]=C[0],H[de+1]=C[1];return H}}();function hu(C){return hu="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(C){return typeof C}:function(C){return C&&"function"==typeof Symbol&&C.constructor===Symbol&&C!==Symbol.prototype?"symbol":typeof C},hu(C)}Du.forEach=Ru,Object.defineProperty(ch,"__esModule",{value:!0});var Lu=ch.vec4=Ld=ch.vec3=ch.vec2=ch.quat2=id=ch.quat=ed=ch.mat4=Ju=ch.mat3=ch.mat2d=Xu=ch.mat2=ch.glMatrix=void 0,Nu=Iu(uh);ch.glMatrix=Nu;var Wu=Iu(Mh),Xu=ch.mat2=Wu,Yu=Iu(Ah);ch.mat2d=Yu;var Ku=Iu(Ch),Ju=ch.mat3=Ku,Qu=Iu(Dh),ed=ch.mat4=Qu,td=Iu(kh),id=ch.quat=td,yd=Iu(wu);ch.quat2=yd;var Pd=Iu(Du);ch.vec2=Pd;var Rd=Iu(Rh),Ld=ch.vec3=Rd,Bd=Iu(Fh);function Su(C){if("function"!=typeof WeakMap)return null;var H=new WeakMap,te=new WeakMap;return(Su=function(C){return C?te:H})(C)}function Iu(C,H){if(!H&&C&&C.__esModule)return C;if(null===C||"object"!==hu(C)&&"function"!=typeof C)return{default:C};var te=Su(H);if(te&&te.has(C))return te.get(C);var le={},ce=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var he in C)if("default"!==he&&Object.prototype.hasOwnProperty.call(C,he)){var ue=ce?Object.getOwnPropertyDescriptor(C,he):null;ue&&(ue.get||ue.set)?Object.defineProperty(le,he,ue):le[he]=C[he]}return le.default=C,te&&te.set(C,le),le}Lu=ch.vec4=Bd;const Od=ba([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:Nd}=Od,Ud=ba([{name:"a_pos_3",components:3,type:"Int16"}]);var Vd=ba([{name:"a_pos",type:"Int16",components:2}]),Xd={};!function(C,H){!function(C){function t(C,H,te){var le=i(256*C,256*(H=Math.pow(2,te)-H-1),te),ce=i(256*(C+1),256*(H+1),te);return le[0]+","+le[1]+","+ce[0]+","+ce[1]}function i(C,H,te){var le=2*Math.PI*6378137/256/Math.pow(2,te);return[C*le-2*Math.PI*6378137/2,H*le-2*Math.PI*6378137/2]}C.getURL=function(C,H,te,le,ce,he){return he=he||{},C+"?"+["bbox="+t(te,le,ce),"format="+(he.format||"image/png"),"service="+(he.service||"WMS"),"version="+(he.version||"1.1.1"),"request="+(he.request||"GetMap"),"srs="+(he.srs||"EPSG:3857"),"width="+(he.width||256),"height="+(he.height||256),"layers="+H].join("&")},C.getTileBBox=t,C.getMercCoords=i,Object.defineProperty(C,"__esModule",{value:!0})}(H)}(0,Xd);var op=Xd;class ku{constructor(C,H,te){this.z=C,this.x=H,this.y=te,this.key=Fu(0,C,C,H,te)}equals(C){return this.z===C.z&&this.x===C.x&&this.y===C.y}url(C,H){const te=op.getTileBBox(this.x,this.y,this.z),le=function(C,H,te){let le,ce="";for(let he=C;he>0;he--)le=1<<he-1,ce+=(H&le?1:0)+(te&le?2:0);return ce}(this.z,this.x,this.y);return C[(this.x+this.y)%C.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String("tms"===H?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",le).replace("{bbox-epsg-3857}",te)}toString(){return`${this.z}/${this.x}/${this.y}`}}class Ou{constructor(C,H){this.wrap=C,this.canonical=H,this.key=Fu(C,H.z,H.z,H.x,H.y)}}class Bu{constructor(C,H,te,le,ce){this.overscaledZ=C,this.wrap=H,this.canonical=new ku(te,+le,+ce),this.key=0===H&&C===te?this.canonical.key:Fu(H,C,te,le,ce)}equals(C){return this.overscaledZ===C.overscaledZ&&this.wrap===C.wrap&&this.canonical.equals(C.canonical)}scaledTo(C){const H=this.canonical.z-C;return C>this.canonical.z?new Bu(C,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new Bu(C,this.wrap,C,this.canonical.x>>H,this.canonical.y>>H)}calculateScaledKey(C,H=!0){if(this.overscaledZ===C&&H)return this.key;if(C>this.canonical.z)return Fu(this.wrap*+H,C,this.canonical.z,this.canonical.x,this.canonical.y);{const te=this.canonical.z-C;return Fu(this.wrap*+H,C,C,this.canonical.x>>te,this.canonical.y>>te)}}isChildOf(C){if(C.wrap!==this.wrap)return!1;const H=this.canonical.z-C.canonical.z;return 0===C.overscaledZ||C.overscaledZ<this.overscaledZ&&C.canonical.z<this.canonical.z&&C.canonical.x===this.canonical.x>>H&&C.canonical.y===this.canonical.y>>H}children(C){if(this.overscaledZ>=C)return[new Bu(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const H=this.canonical.z+1,te=2*this.canonical.x,le=2*this.canonical.y;return[new Bu(H,this.wrap,H,te,le),new Bu(H,this.wrap,H,te+1,le),new Bu(H,this.wrap,H,te,le+1),new Bu(H,this.wrap,H,te+1,le+1)]}isLessThan(C){return this.wrap<C.wrap||!(this.wrap>C.wrap)&&(this.overscaledZ<C.overscaledZ||!(this.overscaledZ>C.overscaledZ)&&(this.canonical.x<C.canonical.x||!(this.canonical.x>C.canonical.x)&&this.canonical.y<C.canonical.y))}wrapped(){return new Bu(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(C){return new Bu(this.overscaledZ,C,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new Ou(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function Fu(C,H,te,le,ce){const he=1<<Math.min(te,22);let ue=he*(ce%he)+le%he;return C&&te<22&&(ue+=he*he*((C<0?-2*C-1:2*C)%(1<<2*(22-te)))),16*(32*ue+te)+(H-te)}const sp=[C=>{let H=C.canonical.x-1,te=C.wrap;return H<0&&(H=(1<<C.canonical.z)-1,te--),new Bu(C.overscaledZ,te,C.canonical.z,H,C.canonical.y)},C=>{let H=C.canonical.x+1,te=C.wrap;return H===1<<C.canonical.z&&(H=0,te++),new Bu(C.overscaledZ,te,C.canonical.z,H,C.canonical.y)},C=>new Bu(C.overscaledZ,C.wrap,C.canonical.z,C.canonical.x,(0===C.canonical.y?1<<C.canonical.z:C.canonical.y)-1),C=>new Bu(C.overscaledZ,C.wrap,C.canonical.z,C.canonical.x,C.canonical.y===(1<<C.canonical.z)-1?0:C.canonical.y+1)];Is(ku,"CanonicalTileID"),Is(Bu,"OverscaledTileID",{omit:["projMatrix"]});class Uu{constructor(C,H){this.pos=C,this.dir=H}intersectsPlane(C,H,te){const le=Ld.dot(H,this.dir);if(Math.abs(le)<1e-6)return!1;const ce=((C[0]-this.pos[0])*H[0]+(C[1]-this.pos[1])*H[1]+(C[2]-this.pos[2])*H[2])/le;return te[0]=this.pos[0]+this.dir[0]*ce,te[1]=this.pos[1]+this.dir[1]*ce,te[2]=this.pos[2]+this.dir[2]*ce,!0}closestPointOnSphere(C,H,te){if(Ld.equals(this.pos,C)||0===H)return te[0]=te[1]=te[2]=0,!1;const[le,ce,he]=this.dir,ue=this.pos[0]-C[0],de=this.pos[1]-C[1],_e=this.pos[2]-C[2],ye=le*le+ce*ce+he*he,ve=2*(ue*le+de*ce+_e*he),Me=ve*ve-4*ye*(ue*ue+de*de+_e*_e-H*H);if(Me<0){const C=Math.max(-ve/2,0),ye=ue+le*C,Me=de+ce*C,Se=_e+he*C,Ae=Math.hypot(ye,Me,Se);return te[0]=ye*H/Ae,te[1]=Me*H/Ae,te[2]=Se*H/Ae,!1}{const C=(-ve-Math.sqrt(Me))/(2*ye);if(C<0){const C=Math.hypot(ue,de,_e);return te[0]=ue*H/C,te[1]=de*H/C,te[2]=_e*H/C,!1}return te[0]=ue+le*C,te[1]=de+ce*C,te[2]=_e+he*C,!0}}}class Vu{constructor(C,H,te,le,ce){this.TL=C,this.TR=H,this.BR=te,this.BL=le,this.horizon=ce}static fromInvProjectionMatrix(C,H,te){const le=[-1,1,1],ce=[1,1,1],he=[1,-1,1],ue=[-1,-1,1],de=Ld.transformMat4(le,le,C),_e=Ld.transformMat4(ce,ce,C),ye=Ld.transformMat4(he,he,C),ve=Ld.transformMat4(ue,ue,C);return new Vu(de,_e,ye,ve,H/te)}}function ju(C,H,te){let le=1/0,ce=-1/0;const he=[];for(const ue of C){Ld.sub(he,ue,H);const C=Ld.dot(he,te);le=Math.min(le,C),ce=Math.max(ce,C)}return[le,ce]}function Gu(C,H){let te=!0;for(let le=0;le<C.planes.length;le++){const ce=C.planes[le];let he=0;for(let C=0;C<H.length;C++)he+=Ld.dot(ce,H[C])+ce[3]>=0;if(0===he)return 0;he!==H.length&&(te=!1)}return te?2:1}function qu(C,H){for(const te of C.projections){const le=ju(H,C.points[0],te.axis);if(te.projection[1]<le[0]||te.projection[0]>le[1])return 0}return 1}function Zu(C,H){let te=0;const le=[0,0,0,0];for(let ce=0;ce<C.length;ce++)le[0]=C[ce][0],le[1]=C[ce][1],le[2]=C[ce][2],le[3]=1,Lu.dot(le,H)>=0&&te++;return te}class $u{constructor(C,H){this.points=C||new Array(8).fill([0,0,0]),this.planes=H||new Array(6).fill([0,0,0,0]),this.bounds=Hu.fromPoints(this.points),this.projections=[],this.frustumEdges=[Ld.sub([],this.points[2],this.points[3]),Ld.sub([],this.points[0],this.points[3]),Ld.sub([],this.points[4],this.points[0]),Ld.sub([],this.points[5],this.points[1]),Ld.sub([],this.points[6],this.points[2]),Ld.sub([],this.points[7],this.points[3])];for(const C of this.frustumEdges){const H=[0,-C[2],C[1]],te=[C[2],0,-C[0]];this.projections.push({axis:H,projection:ju(this.points,this.points[0],H)}),this.projections.push({axis:te,projection:ju(this.points,this.points[0],te)})}}static fromInvProjectionMatrix(C,H,te,le){const ce=Math.pow(2,te),he=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map((te=>{const he=Lu.transformMat4([],te,C),ue=1/he[3]/H*ce;return Lu.mul(he,he,[ue,ue,le?1/he[3]:ue,ue])})),ue=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map((C=>{const H=Ld.sub([],he[C[0]],he[C[1]]),te=Ld.sub([],he[C[2]],he[C[1]]),le=Ld.normalize([],Ld.cross([],H,te)),ce=-Ld.dot(le,he[C[1]]);return le.concat(ce)})),de=[];for(let C=0;C<he.length;C++)de.push([he[C][0],he[C][1],he[C][2]]);return new $u(de,ue)}intersectsPrecise(C,H,te){for(let te=0;te<H.length;te++)if(!Zu(C,H[te]))return 0;for(let H=0;H<this.planes.length;H++)if(!Zu(C,this.planes[H]))return 0;for(const H of te)for(const te of this.frustumEdges){const le=Ld.cross([],H,te),ce=Ld.length(le);if(0===ce)continue;Ld.scale(le,le,1/ce);const he=ju(this.points,this.points[0],le),ue=ju(C,this.points[0],le);if(he[0]>ue[1]||ue[0]>he[1])return 0}return 1}}class Hu{static fromPoints(C){const H=[1/0,1/0,1/0],te=[-1/0,-1/0,-1/0];for(const le of C)Ld.min(H,H,le),Ld.max(te,te,le);return new Hu(H,te)}static fromTileIdAndHeight(C,H,te){const le=1<<C.canonical.z,ce=C.canonical.x,he=C.canonical.y;return new Hu([ce/le,he/le,H],[(ce+1)/le,(he+1)/le,te])}static applyTransform(C,H){const te=C.getCorners();for(let C=0;C<te.length;++C)Ld.transformMat4(te[C],te[C],H);return Hu.fromPoints(te)}static projectAabbCorners(C,H){const te=C.getCorners();for(let C=0;C<te.length;++C)Ld.transformMat4(te[C],te[C],H);return te}constructor(C,H){this.min=C,this.max=H,this.center=Ld.scale([],Ld.add([],this.min,this.max),.5)}quadrant(C){const H=[C%2==0,C<2],te=Ld.clone(this.min),le=Ld.clone(this.max);for(let C=0;C<H.length;C++)te[C]=H[C]?this.min[C]:this.center[C],le[C]=H[C]?this.center[C]:this.max[C];return le[2]=this.max[2],new Hu(te,le)}distanceX(C){return Math.max(Math.min(this.max[0],C[0]),this.min[0])-C[0]}distanceY(C){return Math.max(Math.min(this.max[1],C[1]),this.min[1])-C[1]}distanceZ(C){return Math.max(Math.min(this.max[2],C[2]),this.min[2])-C[2]}getCorners(){const C=this.min,H=this.max;return[[C[0],C[1],C[2]],[H[0],C[1],C[2]],[H[0],H[1],C[2]],[C[0],H[1],C[2]],[C[0],C[1],H[2]],[H[0],C[1],H[2]],[H[0],H[1],H[2]],[C[0],H[1],H[2]]]}intersects(C){return this.intersectsAabb(C.bounds)?Gu(C,this.getCorners()):0}intersectsFlat(C){return this.intersectsAabb(C.bounds)?Gu(C,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(C,H){return H||this.intersects(C)?qu(C,this.getCorners()):0}intersectsPreciseFlat(C,H){return H||this.intersectsFlat(C)?qu(C,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(C){for(let H=0;H<3;++H)if(this.min[H]>C.max[H]||C.min[H]>this.max[H])return!1;return!0}intersectsAabbXY(C){return!(this.min[0]>C.max[0]||C.min[0]>this.max[0]||this.min[1]>C.max[1]||C.min[1]>this.max[1])}encapsulate(C){for(let H=0;H<3;H++)this.min[H]=Math.min(this.min[H],C.min[H]),this.max[H]=Math.max(this.max[H],C.max[H])}encapsulatePoint(C){for(let H=0;H<3;H++)this.min[H]=Math.min(this.min[H],C[H]),this.max[H]=Math.max(this.max[H],C[H])}closestPoint(C){return[Math.max(Math.min(this.max[0],C[0]),this.min[0]),Math.max(Math.min(this.max[1],C[1]),this.min[1]),Math.max(Math.min(this.max[2],C[2]),this.min[2])]}}Is(Hu,"Aabb");const Dp=5,Pp=6,Rp=wn/Math.PI/2,Fp=16383,Np=64,Wp=[Np,32,16],Xp=-Rp,Kp=Rp,Jp=[new Hu([Xp,Xp,Xp],[Kp,Kp,Kp]),new Hu([Xp,Xp,Xp],[0,0,Kp]),new Hu([0,Xp,Xp],[Kp,0,Kp]),new Hu([Xp,0,Xp],[0,Kp,Kp]),new Hu([0,0,Xp],[Kp,Kp,Kp])];function rd(C){return C*Rp/kf}function nd(C,H,te,le=!0){const ce=Ld.scale([],C._camera.position,C.worldSize),he=[H,te,1,1];Lu.transformMat4(he,he,C.pixelMatrixInverse),Lu.scale(he,he,1/he[3]);const ue=Ld.sub([],he,ce),de=Ld.normalize([],ue),_e=C.globeMatrix,ye=[_e[12],_e[13],_e[14]],ve=Ld.sub([],ye,ce),Me=Ld.length(ve),Se=Ld.normalize([],ve),Ae=C.worldSize/(2*Math.PI),Ce=Ld.dot(Se,de),Oe=Math.asin(Ae/Me);if(Oe<Math.acos(Ce)){if(!le)return null;const C=[],H=[];Ld.scale(C,de,Me/Ce),Ld.normalize(H,Ld.sub(H,C,ve)),Ld.normalize(de,Ld.add(de,ve,Ld.scale(de,H,Math.tan(Oe)*Me)))}const Ne=[];new Uu(ce,de).closestPointOnSphere(ye,Ae,Ne);const je=Ld.normalize([],ne(_e,0)),Ge=Ld.normalize([],ne(_e,1)),Ze=Ld.normalize([],ne(_e,2)),qe=Ld.dot(je,Ne),$e=Ld.dot(Ge,Ne),We=Ld.dot(Ze,Ne),He=T(Math.asin(-$e/Ae));let Xe=T(Math.atan2(qe,We));Xe=C.center.lng+function(C,H){const te=(H-C+180)%360-180;return te<-180?te+360:te}(C.center.lng,Xe);const Ye=Gd(Xe),Je=z(qd(He),0,1);return new ep(Ye,Je)}class od{constructor(C,H,te){this.a=Ld.sub([],C,te),this.b=Ld.sub([],H,te),this.center=te;const le=Ld.normalize([],this.a),ce=Ld.normalize([],this.b);this.angle=Math.acos(Ld.dot(le,ce))}}function sd(C,H){if(0===C.angle)return null;let te;return te=0===C.a[H]?1/C.angle*.5*Math.PI:1/C.angle*Math.atan(C.b[H]/C.a[H]/Math.sin(C.angle)-1/Math.tan(C.angle)),te<0||te>1?null:function(C,H,te,le){const ce=Math.sin(te);return C*(Math.sin((1-le)*te)/ce)+H*(Math.sin(le*te)/ce)}(C.a[H],C.b[H],C.angle,z(te,0,1))+C.center[H]}function ad(C){if(C.z<=1)return Jp[C.z+2*C.y+C.x];const H=pd(dd(C));return Hu.fromPoints(H)}function ld(C,H,te){return Ld.scale(C,C,1-te),Ld.scaleAndAdd(C,C,H,te)}function cd(C,H){const te=Ed(H.zoom);if(0===te)return ad(C);const le=dd(C),ce=pd(le),he=Gd(le.getWest())*H.worldSize,ue=Gd(le.getEast())*H.worldSize,de=qd(le.getNorth())*H.worldSize,_e=qd(le.getSouth())*H.worldSize,ye=[he,de,0],ve=[ue,de,0],Me=[he,_e,0],Se=[ue,_e,0],Ae=ed.invert([],H.globeMatrix);return Ld.transformMat4(ye,ye,Ae),Ld.transformMat4(ve,ve,Ae),Ld.transformMat4(Me,Me,Ae),Ld.transformMat4(Se,Se,Ae),ce[0]=ld(ce[0],Me,te),ce[1]=ld(ce[1],Se,te),ce[2]=ld(ce[2],ve,te),ce[3]=ld(ce[3],ye,te),Hu.fromPoints(ce)}function hd(C,H,te){for(const le of C)Ld.transformMat4(le,le,H),Ld.scale(le,le,te)}function ud(C,H,te,le){const ce=H/C.worldSize,he=C.globeMatrix;if(te.z<=1){const C=ad(te).getCorners();return hd(C,he,ce),Hu.fromPoints(C)}const ue=dd(te,le),de=pd(ue);hd(de,he,ce);const _e=Number.MAX_VALUE,ye=[-_e,-_e,-_e],ve=[_e,_e,_e];if(ue.contains(C.center)){for(const C of de)Ld.min(ve,ve,C),Ld.max(ye,ye,C);ye[2]=0;const H=C.point,te=[H.x*ce,H.y*ce,0];return Ld.min(ve,ve,te),Ld.max(ye,ye,te),new Hu(ve,ye)}const Me=[he[12]*ce,he[13]*ce,he[14]*ce],Se=ue.getCenter(),Ae=z(C.center.lat,-Uf,Uf),Ce=z(Se.lat,-Uf,Uf),Oe=Gd(C.center.lng),Ne=qd(Ae);let je=Oe-Gd(Se.lng);const Ge=Ne-qd(Ce);je>.5?je-=1:je<-.5&&(je+=1);let Ze=0;if(Math.abs(je)>Math.abs(Ge))Ze=je>=0?1:3;else{Ze=Ge>=0?0:2;const C=[he[4]*ce,he[5]*ce,he[6]*ce],H=-Math.sin(w(Ge>=0?ue.getSouth():ue.getNorth()))*Rp;Ld.scaleAndAdd(Me,Me,C,H)}const qe=de[Ze],$e=de[(Ze+1)%4],We=new od(qe,$e,Me),He=[sd(We,0)||qe[0],sd(We,1)||qe[1],sd(We,2)||qe[2]],Xe=Ed(C.zoom);if(Xe>0){const le=function({x:C,y:H,z:te},le,ce,he,ue){const de=1/(1<<te);let _e=C*de,ye=_e+de,ve=H*de,Me=ve+de,Se=0;const Ae=(_e+ye)/2-he;return Ae>.5?Se=-1:Ae<-.5&&(Se=1),_e=((_e+Se)*le-(he*=le))*ce+he,ye=((ye+Se)*le-he)*ce+he,ve=(ve*le-(ue*=le))*ce+ue,Me=(Me*le-ue)*ce+ue,[[_e,Me,0],[ye,Me,0],[ye,ve,0],[_e,ve,0]]}(te,H,C._pixelsPerMercatorPixel,Oe,Ne);for(let C=0;C<de.length;C++)ld(de[C],le[C],Xe);const ce=Ld.add([],le[Ze],le[(Ze+1)%4]);Ld.scale(ce,ce,.5),ld(He,ce,Xe)}for(const C of de)Ld.min(ve,ve,C),Ld.max(ye,ye,C);return ve[2]=Math.min(qe[2],$e[2]),Ld.min(ve,ve,He),Ld.max(ye,ye,He),new Hu(ve,ye)}function dd({x:C,y:H,z:te},le=!1){const ce=1/(1<<te),he=new Of($d(C*ce),H===(1<<te)-1&&le?-90:Hd((H+1)*ce)),ue=new Of($d((C+1)*ce),0===H&&le?90:Hd(H*ce));return new Ql(he,ue)}function pd(C){const H=w(C.getNorth()),te=w(C.getSouth()),le=Math.cos(H),ce=Math.cos(te),he=Math.sin(H),ue=Math.sin(te),de=C.getWest(),_e=C.getEast();return[fd(ce,ue,de),fd(ce,ue,_e),fd(le,he,_e),fd(le,he,de)]}function fd(C,H,te,le=Rp){return te=w(te),[C*Math.sin(te)*le,-H*le,C*Math.cos(te)*le]}function md(C,H,te){return fd(Math.cos(w(C)),Math.sin(w(C)),H,te)}function _d(C,H,te,le){const ce=1<<te.z,he=(C/wn+te.x)/ce;return md(Hd((H/wn+te.y)/ce),$d(he),le)}function gd({min:C,max:H}){return Fp/Math.max(H[0]-C[0],H[1]-C[1],H[2]-C[2])}const Qp=new Float64Array(16);function xd(C){const H=gd(C),te=ed.fromScaling(Qp,[H,H,H]);return ed.translate(te,te,Ld.negate([],C.min))}function vd(C){const H=ed.fromTranslation(Qp,C.min),te=1/gd(C);return ed.scale(H,H,[te,te,te])}function bd(C){const H=wn/(2*Math.PI);return C/(2*Math.PI)/H}function wd(C,H){return wn/(512*Math.pow(2,C))*gd(ad(H))}function Td(C,H,te,le,ce){const he=bd(te),ue=[C,H,-te/(2*Math.PI)],de=ed.identity(new Float64Array(16));return ed.translate(de,de,ue),ed.scale(de,de,[he,he,he]),ed.rotateX(de,de,w(-ce)),ed.rotateY(de,de,w(-le)),de}function Ed(C){return D(Dp,Pp,C)}function Md(C,H,te){const le=ed.identity(new Float64Array(16)),ce=(H/(1<<C)-.5)*Math.PI*2;return ed.rotateY(le,te.globeMatrix,ce),Float32Array.from(le)}function Ad(C,H,te){const le=Ed(te.zoom),ce=C.style.map._antialias,he=H.extStandardDerivativesForceOff||C.terrain&&C.terrain.exaggeration()>0;return 0===le&&!ce&&!he}function Sd(C,H,te,le){const ce=H.getNorth(),he=H.getSouth(),ue=H.getWest(),de=H.getEast(),_e=1<<C.z,ye=de-ue,ve=ce-he,Me=ye/Np,Se=-ve/Wp[te],Ae=[0,Me,0,Se,0,0,ce,ue,0];if(C.z>0){const C=180/le;Ju.multiply(Ae,Ae,[C/ye+1,0,0,0,C/ve+1,0,-.5*C/Me,.5*C/Se,1])}return Ae[2]=_e,Ae[5]=C.x,Ae[8]=C.y,Ae}function Id(C){const H=Uf-5;C=z(C,-H,H)/H*90;const te=Math.pow(Math.abs(Math.sin(w(C))),3);return Math.round(te*(Wp.length-1))}function Cd(C){const H=[0,0,0],te=ed.identity(new Float64Array(16));return ed.multiply(te,C.pixelMatrix,C.globeMatrix),Ld.transformMat4(H,H,te),new Ne(H[0],H[1])}function zd(C,H){const te=md(H.lat,H.lng),le=function(C){const H=md(C._center.lat,C._center.lng),te=Ld.fromValues(0,1,0);let le=Ld.cross([],te,H);const ce=ed.fromRotation([],-C.angle,H);le=Ld.transformMat4(le,le,ce),ed.fromRotation(ce,-C._pitch,le);const he=Ld.normalize([],H);return Ld.scale(he,he,rd(C.cameraToCenterDistance/C.pixelsPerMeter)),Ld.transformMat4(he,he,ce),Ld.add([],H,he)}(C),ce=Ld.subtract([],le,te);return Ld.angle(ce,te)}function Dd(C,H){return zd(C,H)>Math.PI/2*1.01}const ef=w(85),tf=Math.cos(ef),Cf=Math.sin(ef);class kd{constructor(C){this._createGrid(C),this._createPoles(C)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const C of this._poleSegments)C.destroy();for(const C of this._gridSegments)C.withSkirts.destroy(),C.withoutSkirts.destroy()}_fillGridMeshWithLods(C,H){const te=new Ta,le=new Va,ce=[],he=C+1+2,ue=H[0]+1,de=H[0]+1+(1+H.length),l=(C,H,te)=>{let le=C===he-1?C-2:0===C?C:C-1;return le+=te?24575:0,[le,H]};for(let C=0;C<he;++C)te.emplaceBack(...l(C,0,!0));for(let C=0;C<ue;++C)for(let H=0;H<he;++H)te.emplaceBack(...l(H,C,(0===H||H===he-1)&&!0));for(let C=0;C<H.length;++C){const le=H[C];for(let C=0;C<he;++C)te.emplaceBack(...l(C,le,!0))}for(let C=0;C<H.length;++C){const ue=le.length,_e=H[C]+1+2,ye=new Va;for(let te=0;te<_e-1;te++){const ce=te===_e-2,ue=ce?he*(de-H.length+C-te):he;for(let C=0;C<he-1;C++){const H=te*he+C;0===te||ce||0===C||C===he-2?(ye.emplaceBack(H+1,H,H+ue),ye.emplaceBack(H+ue,H+ue+1,H+1)):(le.emplaceBack(H+1,H,H+ue),le.emplaceBack(H+ue,H+ue+1,H+1))}}const ve=dl.simpleSegment(0,ue,te.length,le.length-ue);for(let C=0;C<ye.uint16.length;C+=3)le.emplaceBack(ye.uint16[C],ye.uint16[C+1],ye.uint16[C+2]);const Me=dl.simpleSegment(0,ue,te.length,le.length-ue);ce.push({withoutSkirts:ve,withSkirts:Me})}return{vertices:te,indices:le,segments:ce}}_createGrid(C){const H=this._fillGridMeshWithLods(Np,Wp);this._gridSegments=H.segments,this._gridBuffer=C.createVertexBuffer(H.vertices,Vd.members),this._gridIndexBuffer=C.createIndexBuffer(H.indices,!0)}_createPoles(C){const H=new Va;for(let C=0;C<=Np;C++)H.emplaceBack(0,C+1,C+2);this._poleIndexBuffer=C.createIndexBuffer(H,!0);const te=new Za,le=new Za,ce=new Za,he=new Za;this._poleSegments=[];for(let C=0,H=0;C<Dp;C++){const ue=360/(1<<C);te.emplaceBack(0,-Rp,0,.5,0),le.emplaceBack(0,-Rp,0,.5,1),ce.emplaceBack(0,-Rp,0,.5,.5),he.emplaceBack(0,-Rp,0,.5,.5);for(let C=0;C<=Np;C++){let H=C/Np,de=0;const _e=Wr(0,ue,H),[ye,ve,Me]=fd(tf,Cf,_e,Rp);te.emplaceBack(ye,ve,Me,H,de),le.emplaceBack(ye,ve,Me,H,1-de);const Se=w(_e);H=.5+.5*Math.sin(Se),de=.5+.5*Math.cos(Se),ce.emplaceBack(ye,ve,Me,H,de),he.emplaceBack(ye,ve,Me,H,1-de)}this._poleSegments.push(dl.simpleSegment(H,0,66,64)),H+=66}this._poleNorthVertexBuffer=C.createVertexBuffer(te,Nd,!1),this._poleSouthVertexBuffer=C.createVertexBuffer(le,Nd,!1),this._texturedPoleNorthVertexBuffer=C.createVertexBuffer(ce,Nd,!1),this._texturedPoleSouthVertexBuffer=C.createVertexBuffer(he,Nd,!1)}getGridBuffers(C,H){return[this._gridBuffer,this._gridIndexBuffer,H?this._gridSegments[C].withSkirts:this._gridSegments[C].withoutSkirts]}getPoleBuffers(C,H){return[H?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,H?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[C]]}}const kf=6371008.8,Bf=2*Math.PI*kf;class Fd{constructor(C,H){if(isNaN(C)||isNaN(H))throw new Error(`Invalid LngLat object: (${C}, ${H})`);if(this.lng=+C,this.lat=+H,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new Fd(P(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(C){const H=Math.PI/180,te=this.lat*H,le=C.lat*H,ce=Math.sin(te)*Math.sin(le)+Math.cos(te)*Math.cos(le)*Math.cos((C.lng-this.lng)*H);return kf*Math.acos(Math.min(ce,1))}toBounds(C=0){const H=360*C/40075017,te=H/Math.cos(Math.PI/180*this.lat);return new Ql(new Fd(this.lng-te,this.lat-H),new Fd(this.lng+te,this.lat+H))}toEcef(C){const H=rd(C);return md(this.lat,this.lng,Rp+H)}static convert(C){if(C instanceof Fd)return C;if(Array.isArray(C)&&(2===C.length||3===C.length))return new Fd(Number(C[0]),Number(C[1]));if(!Array.isArray(C)&&"object"==typeof C&&null!==C)return new Fd(Number("lng"in C?C.lng:C.lon),Number(C.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}var Of=Fd;const Ff=0,Nf=25.5;function jd(C){return Bf*Math.cos(C*Math.PI/180)}function Gd(C){return(180+C)/360}function qd(C){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+C*Math.PI/360)))/360}function Zd(C,H){return C/jd(H)}function $d(C){return 360*C-180}function Hd(C){return 360/Math.PI*Math.atan(Math.exp((180-360*C)*Math.PI/180))-90}function Wd(C,H){return C*jd(Hd(H))}const Uf=85.051129;function Yd(C){return Math.cos(w(z(C,-Uf,Uf)))}function Kd(C,H){const te=z(H,Ff,Nf),le=Math.pow(2,te);return Yd(C)*Bf/(512*le)}function Jd(C){return 1/Math.cos(C*Math.PI/180)}function Qd(C,H=0){const te=Math.exp(Math.PI*(1-(C.y+H/wn)/(1<<C.z)*2));return 80150034*te/(te*te+1)/wn/(1<<C.z)}class ep{constructor(C,H,te=0){this.x=+C,this.y=+H,this.z=+te}static fromLngLat(C,H=0){const te=Of.convert(C);return new ep(Gd(te.lng),qd(te.lat),Zd(H,te.lat))}toLngLat(){return new Of($d(this.x),Hd(this.y))}toAltitude(){return Wd(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/Bf*Jd(Hd(this.y))}}function tp(C,H,te,le,ce,he,ue,de,_e){const ye=(H+le)/2,ve=(te+ce)/2,Me=new Ne(ye,ve);de(Me),function(C,H,te,le,ce,he){const ue=te-ce,de=le-he;return Math.abs((le-H)*ue-(te-C)*de)/Math.hypot(ue,de)}(Me.x,Me.y,he.x,he.y,ue.x,ue.y)>=_e?(tp(C,H,te,ye,ve,he,Me,de,_e),tp(C,ye,ve,le,ce,Me,ue,de,_e)):C.push(ue)}function ip(C,H,te){let le=C[0],ce=le.x,he=le.y;H(le);const ue=[le];for(let de=1;de<C.length;de++){const _e=C[de],{x:ye,y:ve}=_e;H(_e),tp(ue,ce,he,ye,ve,le,_e,H,te),ce=ye,he=ve,le=_e}return ue}function rp(C,H,te,le){if(le(H,te)){const ce=H.add(te)._mult(.5);rp(C,H,ce,le),rp(C,ce,te,le)}else C.push(te)}function np(C,H){let te=C[0];const le=[te];for(let ce=1;ce<C.length;ce++){const he=C[ce];rp(le,te,he,H),te=he}return le}const Vf=Math.pow(2,14)-1,jf=-Vf-1;function ap(C,H){const te=Math.round(C.x*H),le=Math.round(C.y*H);return C.x=z(te,jf,Vf),C.y=z(le,jf,Vf),(te<C.x||te>C.x+1||le<C.y||le>C.y+1)&&W("Geometry exceeds allowed extent, reduce your vector tile buffer size"),C}function lp(C,H,te){const le=C.loadGeometry(),ce=C.extent,he=wn/ce;if(H&&te&&te.projection.isReprojectedInTileSpace){const he=1<<H.z,{scale:ue,x:de,y:_e,projection:ye}=te,h=C=>{const te=$d((H.x+C.x/ce)/he),le=Hd((H.y+C.y/ce)/he),ve=ye.project(te,le);C.x=(ve.x*ue-de)*ce,C.y=(ve.y*ue-_e)*ce};for(let H=0;H<le.length;H++)if(1!==C.type)le[H]=ip(le[H],h,1);else{const C=[];for(const te of le[H])te.x<0||te.x>=ce||te.y<0||te.y>=ce||(h(te),C.push(te));le[H]=C}}for(const C of le)for(const H of C)ap(H,he);return le}function cp(C,H){return{type:C.type,id:C.id,properties:C.properties,geometry:H?lp(C):[]}}function hp(C,H,te,le,ce){C.emplaceBack(2*H+(le+1)/2,2*te+(ce+1)/2)}function up(C,H,te){const le=16384;C.emplaceBack(H.x,H.y,H.z,te[0]*le,te[1]*le,te[2]*le)}class dp{constructor(C){this.zoom=C.zoom,this.overscaling=C.overscaling,this.layers=C.layers,this.layerIds=this.layers.map((C=>C.fqid)),this.index=C.index,this.hasPattern=!1,this.projection=C.projection,this.layoutVertexArray=new Ta,this.indexArray=new Va,this.segments=new dl,this.programConfigurations=new Hl(C.layers,C.zoom),this.stateDependentLayerIds=this.layers.filter((C=>C.isStateDependent())).map((C=>C.id))}populate(C,H,te,le){const ce=this.layers[0],he=[];let ue=null;"circle"===ce.type&&(ue=ce.layout.get("circle-sort-key"));for(const{feature:H,id:ce,index:de,sourceLayerIndex:_e}of C){const C=this.layers[0]._featureFilter.needGeometry,ye=cp(H,C);if(!this.layers[0]._featureFilter.filter(new ea(this.zoom),ye,te))continue;const ve=ue?ue.evaluate(ye,{},te):void 0,Me={id:ce,properties:H.properties,type:H.type,sourceLayerIndex:_e,index:de,geometry:C?ye.geometry:lp(H,te,le),patterns:{},sortKey:ve};he.push(Me)}ue&&he.sort(((C,H)=>C.sortKey-H.sortKey));let de=null;"globe"===le.projection.name&&(this.globeExtVertexArray=new Da,de=le.projection);for(const le of he){const{geometry:ce,index:he,sourceLayerIndex:ue}=le,_e=C[he].feature;this.addFeature(le,ce,he,H.availableImages,te,de,H.brightness),H.featureIndex.insert(_e,ce,he,ue,this.index)}}update(C,H,te,le,ce){const he=0!==Object.keys(C).length;he&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(C,H,he?this.stateDependentLayers:this.layers,te,le,ce)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(C){this.uploaded||(this.layoutVertexBuffer=C.createVertexBuffer(this.layoutVertexArray,nc.members),this.indexBuffer=C.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=C.createVertexBuffer(this.globeExtVertexArray,oc.members))),this.programConfigurations.upload(C),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}addFeature(C,H,te,le,ce,he,ue){for(const te of H)for(const H of te){const te=H.x,le=H.y;if(te<0||te>=wn||le<0||le>=wn)continue;if(he){const C=he.projectTilePoint(te,le,ce),H=he.upVector(ce,te,le),ue=this.globeExtVertexArray;up(ue,C,H),up(ue,C,H),up(ue,C,H),up(ue,C,H)}const ue=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,C.sortKey),de=ue.vertexLength;hp(this.layoutVertexArray,te,le,-1,-1),hp(this.layoutVertexArray,te,le,1,-1),hp(this.layoutVertexArray,te,le,1,1),hp(this.layoutVertexArray,te,le,-1,1),this.indexArray.emplaceBack(de,de+1,de+2),this.indexArray.emplaceBack(de,de+2,de+3),ue.vertexLength+=4,ue.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,C,te,{},le,ce,ue)}}function pp(C,H){for(let te=0;te<C.length;te++)if(wp(H,C[te]))return!0;for(let te=0;te<H.length;te++)if(wp(C,H[te]))return!0;return!!gp(C,H)}function fp(C,H,te){return!!wp(C,H)||!!xp(H,C,te)}function mp(C,H){if(1===C.length)return bp(H,C[0]);for(let te=0;te<H.length;te++){const le=H[te];for(let H=0;H<le.length;H++)if(wp(C,le[H]))return!0}for(let te=0;te<C.length;te++)if(bp(H,C[te]))return!0;for(let te=0;te<H.length;te++)if(gp(C,H[te]))return!0;return!1}function _p(C,H,te){if(C.length>1){if(gp(C,H))return!0;for(let le=0;le<H.length;le++)if(xp(H[le],C,te))return!0}for(let le=0;le<C.length;le++)if(xp(C[le],H,te))return!0;return!1}function gp(C,H){if(0===C.length||0===H.length)return!1;for(let te=0;te<C.length-1;te++){const le=C[te],ce=C[te+1];for(let C=0;C<H.length-1;C++)if(yp(le,ce,H[C],H[C+1]))return!0}return!1}function yp(C,H,te,le){return X(C,te,le)!==X(H,te,le)&&X(C,H,te)!==X(C,H,le)}function xp(C,H,te){const le=te*te;if(1===H.length)return C.distSqr(H[0])<le;for(let te=1;te<H.length;te++)if(vp(C,H[te-1],H[te])<le)return!0;return!1}function vp(C,H,te){const le=H.distSqr(te);if(0===le)return C.distSqr(H);const ce=((C.x-H.x)*(te.x-H.x)+(C.y-H.y)*(te.y-H.y))/le;return C.distSqr(ce<0?H:ce>1?te:te.sub(H)._mult(ce)._add(H))}function bp(C,H){let te,le,ce,he=!1;for(let ue=0;ue<C.length;ue++){te=C[ue];for(let C=0,ue=te.length-1;C<te.length;ue=C++)le=te[C],ce=te[ue],le.y>H.y!=ce.y>H.y&&H.x<(ce.x-le.x)*(H.y-le.y)/(ce.y-le.y)+le.x&&(he=!he)}return he}function wp(C,H){let te=!1;for(let le=0,ce=C.length-1;le<C.length;ce=le++){const he=C[le],ue=C[ce];he.y>H.y!=ue.y>H.y&&H.x<(ue.x-he.x)*(H.y-he.y)/(ue.y-he.y)+he.x&&(te=!te)}return te}function Tp(C,H,te,le,ce){for(const he of C)if(H<=he.x&&te<=he.y&&le>=he.x&&ce>=he.y)return!0;const he=[new Ne(H,te),new Ne(H,ce),new Ne(le,ce),new Ne(le,te)];if(C.length>2)for(const H of he)if(wp(C,H))return!0;for(let H=0;H<C.length-1;H++)if(Ep(C[H],C[H+1],he))return!0;return!1}function Ep(C,H,te){const le=te[0],ce=te[2];if(C.x<le.x&&H.x<le.x||C.x>ce.x&&H.x>ce.x||C.y<le.y&&H.y<le.y||C.y>ce.y&&H.y>ce.y)return!1;const he=X(C,H,te[0]);return he!==X(C,H,te[1])||he!==X(C,H,te[2])||he!==X(C,H,te[3])}function Mp(C,H,te,le,ce,he){let ue=H.y-C.y,de=C.x-H.x;if(he=he||0){const C=ue*ue+de*de;if(0===C)return!0;const H=Math.sqrt(C);ue/=H,de/=H}return!((te.x-C.x)*ue+(te.y-C.y)*de-he<0||(le.x-C.x)*ue+(le.y-C.y)*de-he<0||(ce.x-C.x)*ue+(ce.y-C.y)*de-he<0)}function Ap(C,H,te,le,ce,he,ue){return!(Mp(C,H,le,ce,he,ue)||Mp(H,te,le,ce,he,ue)||Mp(te,C,le,ce,he,ue)||Mp(le,ce,C,H,te,ue)||Mp(ce,he,C,H,te,ue)||Mp(he,le,C,H,te,ue))}function Sp(C,H,te){const le=H.paint.get(C).value;return"constant"===le.kind?le.value:te.programConfigurations.get(H.id).getMaxValue(C)}function Ip(C){return Math.sqrt(C[0]*C[0]+C[1]*C[1])}function Cp(C,H,te,le,ce){if(!H[0]&&!H[1])return C;const he=Ne.convert(H)._mult(ce);"viewport"===te&&he._rotate(-le);const ue=[];for(let H=0;H<C.length;H++)ue.push(C[H].sub(he));return ue}function zp(C,H,te,le){const ce=Ne.convert(C)._mult(le);return"viewport"===H&&ce._rotate(-te),ce}Is(dp,"CircleBucket",{omit:["layers"]});const Gf=new da({"circle-sort-key":new ha(Ai.layout_circle["circle-sort-key"]),visibility:new ca(Ai.layout_circle.visibility)});var Zf={paint:new da({"circle-radius":new ha(Ai.paint_circle["circle-radius"]),"circle-color":new ha(Ai.paint_circle["circle-color"]),"circle-blur":new ha(Ai.paint_circle["circle-blur"]),"circle-opacity":new ha(Ai.paint_circle["circle-opacity"]),"circle-translate":new ca(Ai.paint_circle["circle-translate"]),"circle-translate-anchor":new ca(Ai.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new ca(Ai.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new ca(Ai.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new ha(Ai.paint_circle["circle-stroke-width"]),"circle-stroke-color":new ha(Ai.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new ha(Ai.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new ca(Ai.paint_circle["circle-emissive-strength"])}),layout:Gf};const qf=ed.create(),Lp=(C,H,te,le,ce,he)=>{const ue=C.transform,de="globe"===ue.projection.name;let _e;if("map"===he.paint.get("circle-pitch-alignment"))if(de){const C=wd(ue.zoom,H.canonical)*ue._pixelsPerMercatorPixel;_e=Float32Array.from([C,0,0,C])}else _e=ue.calculatePixelsToTileUnitsMatrix(te);else _e=new Float32Array([ue.pixelsToGLUnits[0],0,0,ue.pixelsToGLUnits[1]]);const ye={u_camera_to_center_distance:C.transform.getCameraToCenterDistance(ue.projection),u_matrix:C.translatePosMatrix(H.projMatrix,te,he.paint.get("circle-translate"),he.paint.get("circle-translate-anchor")),u_device_pixel_ratio:yi.devicePixelRatio,u_extrude_scale:_e,u_inv_rot_matrix:qf,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:he.paint.get("circle-emissive-strength")};if(de){ye.u_inv_rot_matrix=le,ye.u_merc_center=ce,ye.u_tile_id=[H.canonical.x,H.canonical.y,1<<H.canonical.z],ye.u_zoom_transition=Ed(ue.zoom);const C=ce[0]*wn,te=ce[1]*wn;ye.u_up_dir=ue.projection.upVector(new ku(0,0,0),C,te)}return ye},kp=C=>{const H=[];return"map"===C.paint.get("circle-pitch-alignment")&&H.push("PITCH_WITH_MAP"),"map"===C.paint.get("circle-pitch-scale")&&H.push("SCALE_WITH_MAP"),H};function Op(C,H,te,le,ce,he,ue,de,_e){if(he&&C.queryGeometry.isAboveHorizon)return!1;he&&(_e*=C.pixelToTileUnitsFactor);const ye=C.tileID.canonical,ve=te.projection.upVectorScale(ye,te.center.lat,te.worldSize).metersToTile;for(const Me of H)for(const H of Me){const Me=H.add(de),Se=ce&&te.elevation?te.elevation.exaggeration()*ce.getElevationAt(Me.x,Me.y,!0):0,Ae=te.projection.projectTilePoint(Me.x,Me.y,ye);if(Se>0){const C=te.projection.upVector(ye,Me.x,Me.y);Ae.x+=C[0]*ve*Se,Ae.y+=C[1]*ve*Se,Ae.z+=C[2]*ve*Se}const Ce=he?Me:Bp(Ae.x,Ae.y,Ae.z,le),Oe=he?C.tilespaceRays.map((C=>Up(C,Se))):C.queryGeometry.screenGeometry,Ne=Lu.transformMat4([],[Ae.x,Ae.y,Ae.z,1],le);if(!ue&&he?_e*=Ne[3]/te.cameraToCenterDistance:ue&&!he&&(_e*=te.cameraToCenterDistance/Ne[3]),he){const C=Hd((H.y/wn+ye.y)/(1<<ye.z));_e/=te.projection.pixelsPerMeter(C,1)/Zd(1,C)}if(fp(Oe,Ce,_e))return!0}return!1}function Bp(C,H,te,le){const ce=Lu.transformMat4([],[C,H,te,1],le);return new Ne(ce[0]/ce[3],ce[1]/ce[3])}const Xf=Ld.fromValues(0,0,0),Yf=Ld.fromValues(0,0,1);function Up(C,H){const te=Ld.create();return Xf[2]=H,C.intersectsPlane(Xf,Yf,te),new Ne(te[0],te[1])}class Vp extends dp{}function jp(C,{width:H,height:te},le,ce){if(ce){if(ce instanceof Uint8ClampedArray)ce=new Uint8Array(ce.buffer);else if(ce.length!==H*te*le)throw new RangeError("mismatched image size")}else ce=new Uint8Array(H*te*le);return C.width=H,C.height=te,C.data=ce,C}function Gp(C,H,te){const{width:le,height:ce}=H;le===C.width&&ce===C.height||(qp(C,H,{x:0,y:0},{x:0,y:0},{width:Math.min(C.width,le),height:Math.min(C.height,ce)},te),C.width=le,C.height=ce,C.data=H.data)}function qp(C,H,te,le,ce,he){if(0===ce.width||0===ce.height)return H;if(ce.width>C.width||ce.height>C.height||te.x>C.width-ce.width||te.y>C.height-ce.height)throw new RangeError("out of range source coordinates for image copy");if(ce.width>H.width||ce.height>H.height||le.x>H.width-ce.width||le.y>H.height-ce.height)throw new RangeError("out of range destination coordinates for image copy");const ue=C.data,de=H.data;for(let _e=0;_e<ce.height;_e++){const ye=((te.y+_e)*C.width+te.x)*he,ve=((le.y+_e)*H.width+le.x)*he;for(let C=0;C<ce.width*he;C++)de[ve+C]=ue[ye+C]}return H}Is(Vp,"HeatmapBucket",{omit:["layers"]});class Zp{constructor(C,H){jp(this,C,1,H)}resize(C){Gp(this,new Zp(C),1)}clone(){return new Zp({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(C,H,te,le,ce){qp(C,H,te,le,ce,1)}}class $p{constructor(C,H){jp(this,C,4,H)}resize(C){Gp(this,new $p(C),4)}replace(C,H){H?this.data.set(C):this.data=C instanceof Uint8ClampedArray?new Uint8Array(C.buffer):C}clone(){return new $p({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(C,H,te,le,ce){qp(C,H,te,le,ce,4)}}class Hp{constructor(C,H){this.width=C.width,this.height=C.height,this.data=H instanceof Uint8Array?new Float32Array(H.buffer):H}}Is(Zp,"AlphaImage"),Is($p,"RGBAImage");const Qf=new da({visibility:new ca(Ai.layout_heatmap.visibility)});var tm={paint:new da({"heatmap-radius":new ha(Ai.paint_heatmap["heatmap-radius"]),"heatmap-weight":new ha(Ai.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new ca(Ai.paint_heatmap["heatmap-intensity"]),"heatmap-color":new ua(Ai.paint_heatmap["heatmap-color"]),"heatmap-opacity":new ca(Ai.paint_heatmap["heatmap-opacity"])}),layout:Qf};function Yp(C){const H={},te=C.resolution||256,le=C.clips?C.clips.length:1,ce=C.image||new $p({width:te,height:le}),o=(te,le,he)=>{H[C.evaluationKey]=he;const ue=C.expression.evaluate(H);ue&&(ce.data[te+le+0]=Math.floor(255*ue.r/ue.a),ce.data[te+le+1]=Math.floor(255*ue.g/ue.a),ce.data[te+le+2]=Math.floor(255*ue.b/ue.a),ce.data[te+le+3]=Math.floor(255*ue.a))};if(C.clips)for(let H=0,ce=0;H<le;++H,ce+=4*te)for(let le=0,he=0;le<te;le++,he+=4){const ue=le/(te-1),{start:de,end:_e}=C.clips[H];o(ce,he,de*(1-ue)+_e*ue)}else for(let C=0,H=0;C<te;C++,H+=4)o(0,H,C/(te-1));return ce}const im=new da({visibility:new ca(Ai.layout_hillshade.visibility)});var om={paint:new da({"hillshade-illumination-direction":new ca(Ai.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new ca(Ai.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new ca(Ai.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new ca(Ai.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new ca(Ai.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new ca(Ai.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new ca(Ai.paint_hillshade["hillshade-emissive-strength"])}),layout:im};const sm=ba([{name:"a_pos",components:2,type:"Int16"}],4),{members:am}=sm;var cm={exports:{}};function rf(C,H,te){te=te||2;var le,ce,he,ue,de,_e,ye,ve=H&&H.length,Me=ve?H[0]*te:C.length,Se=nf(C,0,Me,te,!0),Ae=[];if(!Se||Se.next===Se.prev)return Ae;if(ve&&(Se=function(C,H,te,le){var ce,he,ue,de=[];for(ce=0,he=H.length;ce<he;ce++)(ue=nf(C,H[ce]*le,ce<he-1?H[ce+1]*le:C.length,le,!1))===ue.next&&(ue.steiner=!0),de.push(mf(ue));for(de.sort(uf),ce=0;ce<de.length;ce++)te=df(de[ce],te);return te}(C,H,Se,te)),C.length>80*te){le=he=C[0],ce=ue=C[1];for(var Ce=te;Ce<Me;Ce+=te)(de=C[Ce])<le&&(le=de),(_e=C[Ce+1])<ce&&(ce=_e),de>he&&(he=de),_e>ue&&(ue=_e);ye=0!==(ye=Math.max(he-le,ue-ce))?32767/ye:0}return sf(Se,Ae,te,le,ce,ye,0),Ae}function nf(C,H,te,le,ce){var he,ue;if(ce===If(C,H,te,le)>0)for(he=H;he<te;he+=le)ue=Mf(he,C[he],C[he+1],ue);else for(he=te-le;he>=H;he-=le)ue=Mf(he,C[he],C[he+1],ue);return ue&&xf(ue,ue.next)&&(Af(ue),ue=ue.next),ue}function of(C,H){if(!C)return C;H||(H=C);var te,le=C;do{if(te=!1,le.steiner||!xf(le,le.next)&&0!==yf(le.prev,le,le.next))le=le.next;else{if(Af(le),(le=H=le.prev)===le.next)break;te=!0}}while(te||le!==H);return H}function sf(C,H,te,le,ce,he,ue){if(C){!ue&&he&&function(C,H,te,le){var ce=C;do{0===ce.z&&(ce.z=ff(ce.x,ce.y,H,te,le)),ce.prevZ=ce.prev,ce.nextZ=ce.next,ce=ce.next}while(ce!==C);ce.prevZ.nextZ=null,ce.prevZ=null,function(C){var H,te,le,ce,he,ue,de,_e,ye=1;do{for(te=C,C=null,he=null,ue=0;te;){for(ue++,le=te,de=0,H=0;H<ye&&(de++,le=le.nextZ);H++);for(_e=ye;de>0||_e>0&&le;)0!==de&&(0===_e||!le||te.z<=le.z)?(ce=te,te=te.nextZ,de--):(ce=le,le=le.nextZ,_e--),he?he.nextZ=ce:C=ce,ce.prevZ=he,he=ce;te=le}he.nextZ=null,ye*=2}while(ue>1)}(ce)}(C,le,ce,he);for(var de,_e,ye=C;C.prev!==C.next;)if(de=C.prev,_e=C.next,he?lf(C,le,ce,he):af(C))H.push(de.i/te|0),H.push(C.i/te|0),H.push(_e.i/te|0),Af(C),C=_e.next,ye=_e.next;else if((C=_e)===ye){ue?1===ue?sf(C=cf(of(C),H,te),H,te,le,ce,he,2):2===ue&&hf(C,H,te,le,ce,he):sf(of(C),H,te,le,ce,he,1);break}}}function af(C){var H=C.prev,te=C,le=C.next;if(yf(H,te,le)>=0)return!1;for(var ce=H.x,he=te.x,ue=le.x,de=H.y,_e=te.y,ye=le.y,ve=ce<he?ce<ue?ce:ue:he<ue?he:ue,Me=de<_e?de<ye?de:ye:_e<ye?_e:ye,Se=ce>he?ce>ue?ce:ue:he>ue?he:ue,Ae=de>_e?de>ye?de:ye:_e>ye?_e:ye,Ce=le.next;Ce!==H;){if(Ce.x>=ve&&Ce.x<=Se&&Ce.y>=Me&&Ce.y<=Ae&&_f(ce,de,he,_e,ue,ye,Ce.x,Ce.y)&&yf(Ce.prev,Ce,Ce.next)>=0)return!1;Ce=Ce.next}return!0}function lf(C,H,te,le){var ce=C.prev,he=C,ue=C.next;if(yf(ce,he,ue)>=0)return!1;for(var de=ce.x,_e=he.x,ye=ue.x,ve=ce.y,Me=he.y,Se=ue.y,Ae=de<_e?de<ye?de:ye:_e<ye?_e:ye,Ce=ve<Me?ve<Se?ve:Se:Me<Se?Me:Se,Oe=de>_e?de>ye?de:ye:_e>ye?_e:ye,Ne=ve>Me?ve>Se?ve:Se:Me>Se?Me:Se,je=ff(Ae,Ce,H,te,le),Ge=ff(Oe,Ne,H,te,le),Ze=C.prevZ,qe=C.nextZ;Ze&&Ze.z>=je&&qe&&qe.z<=Ge;){if(Ze.x>=Ae&&Ze.x<=Oe&&Ze.y>=Ce&&Ze.y<=Ne&&Ze!==ce&&Ze!==ue&&_f(de,ve,_e,Me,ye,Se,Ze.x,Ze.y)&&yf(Ze.prev,Ze,Ze.next)>=0)return!1;if(Ze=Ze.prevZ,qe.x>=Ae&&qe.x<=Oe&&qe.y>=Ce&&qe.y<=Ne&&qe!==ce&&qe!==ue&&_f(de,ve,_e,Me,ye,Se,qe.x,qe.y)&&yf(qe.prev,qe,qe.next)>=0)return!1;qe=qe.nextZ}for(;Ze&&Ze.z>=je;){if(Ze.x>=Ae&&Ze.x<=Oe&&Ze.y>=Ce&&Ze.y<=Ne&&Ze!==ce&&Ze!==ue&&_f(de,ve,_e,Me,ye,Se,Ze.x,Ze.y)&&yf(Ze.prev,Ze,Ze.next)>=0)return!1;Ze=Ze.prevZ}for(;qe&&qe.z<=Ge;){if(qe.x>=Ae&&qe.x<=Oe&&qe.y>=Ce&&qe.y<=Ne&&qe!==ce&&qe!==ue&&_f(de,ve,_e,Me,ye,Se,qe.x,qe.y)&&yf(qe.prev,qe,qe.next)>=0)return!1;qe=qe.nextZ}return!0}function cf(C,H,te){var le=C;do{var ce=le.prev,he=le.next.next;!xf(ce,he)&&vf(ce,le,le.next,he)&&Tf(ce,he)&&Tf(he,ce)&&(H.push(ce.i/te|0),H.push(le.i/te|0),H.push(he.i/te|0),Af(le),Af(le.next),le=C=he),le=le.next}while(le!==C);return of(le)}function hf(C,H,te,le,ce,he){var ue=C;do{for(var de=ue.next.next;de!==ue.prev;){if(ue.i!==de.i&&gf(ue,de)){var _e=Ef(ue,de);return ue=of(ue,ue.next),_e=of(_e,_e.next),sf(ue,H,te,le,ce,he,0),void sf(_e,H,te,le,ce,he,0)}de=de.next}ue=ue.next}while(ue!==C)}function uf(C,H){return C.x-H.x}function df(C,H){var te=function(C,H){var te,le=H,ce=C.x,he=C.y,ue=-1/0;do{if(he<=le.y&&he>=le.next.y&&le.next.y!==le.y){var de=le.x+(he-le.y)*(le.next.x-le.x)/(le.next.y-le.y);if(de<=ce&&de>ue&&(ue=de,te=le.x<le.next.x?le:le.next,de===ce))return te}le=le.next}while(le!==H);if(!te)return null;var _e,ye=te,ve=te.x,Me=te.y,Se=1/0;le=te;do{ce>=le.x&&le.x>=ve&&ce!==le.x&&_f(he<Me?ce:ue,he,ve,Me,he<Me?ue:ce,he,le.x,le.y)&&(_e=Math.abs(he-le.y)/(ce-le.x),Tf(le,C)&&(_e<Se||_e===Se&&(le.x>te.x||le.x===te.x&&pf(te,le)))&&(te=le,Se=_e)),le=le.next}while(le!==ye);return te}(C,H);if(!te)return H;var le=Ef(te,C);return of(le,le.next),of(te,te.next)}function pf(C,H){return yf(C.prev,C,H.prev)<0&&yf(H.next,C,C.next)<0}function ff(C,H,te,le,ce){return(C=1431655765&((C=858993459&((C=252645135&((C=16711935&((C=(C-te)*ce|0)|C<<8))|C<<4))|C<<2))|C<<1))|(H=1431655765&((H=858993459&((H=252645135&((H=16711935&((H=(H-le)*ce|0)|H<<8))|H<<4))|H<<2))|H<<1))<<1}function mf(C){var H=C,te=C;do{(H.x<te.x||H.x===te.x&&H.y<te.y)&&(te=H),H=H.next}while(H!==C);return te}function _f(C,H,te,le,ce,he,ue,de){return(ce-ue)*(H-de)>=(C-ue)*(he-de)&&(C-ue)*(le-de)>=(te-ue)*(H-de)&&(te-ue)*(he-de)>=(ce-ue)*(le-de)}function gf(C,H){return C.next.i!==H.i&&C.prev.i!==H.i&&!function(C,H){var te=C;do{if(te.i!==C.i&&te.next.i!==C.i&&te.i!==H.i&&te.next.i!==H.i&&vf(te,te.next,C,H))return!0;te=te.next}while(te!==C);return!1}(C,H)&&(Tf(C,H)&&Tf(H,C)&&function(C,H){var te=C,le=!1,ce=(C.x+H.x)/2,he=(C.y+H.y)/2;do{te.y>he!=te.next.y>he&&te.next.y!==te.y&&ce<(te.next.x-te.x)*(he-te.y)/(te.next.y-te.y)+te.x&&(le=!le),te=te.next}while(te!==C);return le}(C,H)&&(yf(C.prev,C,H.prev)||yf(C,H.prev,H))||xf(C,H)&&yf(C.prev,C,C.next)>0&&yf(H.prev,H,H.next)>0)}function yf(C,H,te){return(H.y-C.y)*(te.x-H.x)-(H.x-C.x)*(te.y-H.y)}function xf(C,H){return C.x===H.x&&C.y===H.y}function vf(C,H,te,le){var ce=wf(yf(C,H,te)),he=wf(yf(C,H,le)),ue=wf(yf(te,le,C)),de=wf(yf(te,le,H));return ce!==he&&ue!==de||!(0!==ce||!bf(C,te,H))||!(0!==he||!bf(C,le,H))||!(0!==ue||!bf(te,C,le))||!(0!==de||!bf(te,H,le))}function bf(C,H,te){return H.x<=Math.max(C.x,te.x)&&H.x>=Math.min(C.x,te.x)&&H.y<=Math.max(C.y,te.y)&&H.y>=Math.min(C.y,te.y)}function wf(C){return C>0?1:C<0?-1:0}function Tf(C,H){return yf(C.prev,C,C.next)<0?yf(C,H,C.next)>=0&&yf(C,C.prev,H)>=0:yf(C,H,C.prev)<0||yf(C,C.next,H)<0}function Ef(C,H){var te=new Sf(C.i,C.x,C.y),le=new Sf(H.i,H.x,H.y),ce=C.next,he=H.prev;return C.next=H,H.prev=C,te.next=ce,ce.prev=te,le.next=te,te.prev=le,he.next=le,le.prev=he,le}function Mf(C,H,te,le){var ce=new Sf(C,H,te);return le?(ce.next=le.next,ce.prev=le,le.next.prev=ce,le.next=ce):(ce.prev=ce,ce.next=ce),ce}function Af(C){C.next.prev=C.prev,C.prev.next=C.next,C.prevZ&&(C.prevZ.nextZ=C.nextZ),C.nextZ&&(C.nextZ.prevZ=C.prevZ)}function Sf(C,te,le){(this||H).i=C,(this||H).x=te,(this||H).y=le,(this||H).prev=null,(this||H).next=null,(this||H).z=0,(this||H).prevZ=null,(this||H).nextZ=null,(this||H).steiner=!1}function If(C,H,te,le){for(var ce=0,he=H,ue=te-le;he<te;he+=le)ce+=(C[ue]-C[he])*(C[he+1]+C[ue+1]),ue=he;return ce}cm.exports=rf,cm.exports.default=rf,rf.deviation=function(C,H,te,le){var ce=H&&H.length,he=Math.abs(If(C,0,ce?H[0]*te:C.length,te));if(ce)for(var ue=0,de=H.length;ue<de;ue++)he-=Math.abs(If(C,H[ue]*te,ue<de-1?H[ue+1]*te:C.length,te));var _e=0;for(ue=0;ue<le.length;ue+=3){var ye=le[ue]*te,ve=le[ue+1]*te,Me=le[ue+2]*te;_e+=Math.abs((C[ye]-C[Me])*(C[ve+1]-C[ye+1])-(C[ye]-C[ve])*(C[Me+1]-C[ye+1]))}return 0===he&&0===_e?0:Math.abs((_e-he)/he)},rf.flatten=function(C){for(var H=C[0][0].length,te={vertices:[],holes:[],dimensions:H},le=0,ce=0;ce<C.length;ce++){for(var he=0;he<C[ce].length;he++)for(var ue=0;ue<H;ue++)te.vertices.push(C[ce][he][ue]);ce>0&&te.holes.push(le+=C[ce-1].length)}return te};var hm=d(cm.exports);function zf(C,H){const te=C.length;if(te<=1)return[C];const le=[];let ce,he;for(let H=0;H<te;H++){const te=Y(C[H]);0!==te&&(C[H].area=Math.abs(te),void 0===he&&(he=te<0),he===te<0?(ce&&le.push(ce),ce=[C[H]]):ce.push(C[H]))}if(ce&&le.push(ce),H>1)for(let C=0;C<le.length;C++)le[C].length<=H||(nn(le[C],H,1,le[C].length-1,Df),le[C]=le[C].slice(0,H));return le}function Df(C,H){return H.area-C.area}function Pf(C,H,te){const le=te.patternDependencies;let ce=!1;for(const te of H){const H=te.paint.get(`${C}-pattern`);H.isConstant()||(ce=!0);const he=H.constantOr(null);he&&(ce=!0,le[he]=!0)}return ce}function Rf(C,H,te,le,ce){const he=ce.patternDependencies;for(const ue of H){const H=ue.paint.get(`${C}-pattern`).value;if("constant"!==H.kind){let C=H.evaluate({zoom:le},te,{},ce.availableImages);C=C&&C.name?C.name:C,he[C]=!0,te.patterns[ue.id]=C}}return te}class Lf{constructor(C){this.zoom=C.zoom,this.overscaling=C.overscaling,this.layers=C.layers,this.layerIds=this.layers.map((C=>C.fqid)),this.index=C.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new Ta,this.indexArray=new Va,this.indexArray2=new ka,this.programConfigurations=new Hl(C.layers,C.zoom),this.segments=new dl,this.segments2=new dl,this.stateDependentLayerIds=this.layers.filter((C=>C.isStateDependent())).map((C=>C.id)),this.projection=C.projection}populate(C,H,te,le){this.hasPattern=Pf("fill",this.layers,H);const ce=this.layers[0].layout.get("fill-sort-key"),he=[];for(const{feature:ue,id:de,index:_e,sourceLayerIndex:ye}of C){const C=this.layers[0]._featureFilter.needGeometry,ve=cp(ue,C);if(!this.layers[0]._featureFilter.filter(new ea(this.zoom),ve,te))continue;const Me=ce?ce.evaluate(ve,{},te,H.availableImages):void 0,Se={id:de,properties:ue.properties,type:ue.type,sourceLayerIndex:ye,index:_e,geometry:C?ve.geometry:lp(ue,te,le),patterns:{},sortKey:Me};he.push(Se)}ce&&he.sort(((C,H)=>C.sortKey-H.sortKey));for(const le of he){const{geometry:ce,index:he,sourceLayerIndex:ue}=le;if(this.hasPattern){const C=Rf("fill",this.layers,le,this.zoom,H);this.patternFeatures.push(C)}else this.addFeature(le,ce,he,te,{},H.availableImages,H.brightness);H.featureIndex.insert(C[he].feature,ce,he,ue,this.index)}}update(C,H,te,le,ce){const he=0!==Object.keys(C).length;he&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(C,H,he?this.stateDependentLayers:this.layers,te,le,ce)}addFeatures(C,H,te,le,ce,he){for(const C of this.patternFeatures)this.addFeature(C,C.geometry,C.index,H,te,le,he)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(C){this.uploaded||(this.layoutVertexBuffer=C.createVertexBuffer(this.layoutVertexArray,am),this.indexBuffer=C.createIndexBuffer(this.indexArray),this.indexBuffer2=C.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(C),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(C,H,te,le,ce,he=[],ue){for(const C of zf(H,500)){let H=0;for(const te of C)H+=te.length;const te=this.segments.prepareSegment(H,this.layoutVertexArray,this.indexArray),le=te.vertexLength,ce=[],he=[];for(const H of C){if(0===H.length)continue;H!==C[0]&&he.push(ce.length/2);const te=this.segments2.prepareSegment(H.length,this.layoutVertexArray,this.indexArray2),le=te.vertexLength;this.layoutVertexArray.emplaceBack(H[0].x,H[0].y),this.indexArray2.emplaceBack(le+H.length-1,le),ce.push(H[0].x),ce.push(H[0].y);for(let C=1;C<H.length;C++)this.layoutVertexArray.emplaceBack(H[C].x,H[C].y),this.indexArray2.emplaceBack(le+C-1,le+C),ce.push(H[C].x),ce.push(H[C].y);te.vertexLength+=H.length,te.primitiveLength+=H.length}const ue=hm(ce,he);for(let C=0;C<ue.length;C+=3)this.indexArray.emplaceBack(le+ue[C],le+ue[C+1],le+ue[C+2]);te.vertexLength+=H,te.primitiveLength+=ue.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,C,te,ce,he,le,ue)}}Is(Lf,"FillBucket",{omit:["layers","patternFeatures"]});const um=new da({"fill-sort-key":new ha(Ai.layout_fill["fill-sort-key"]),visibility:new ca(Ai.layout_fill.visibility)});var Sm={paint:new da({"fill-antialias":new ca(Ai.paint_fill["fill-antialias"]),"fill-opacity":new ha(Ai.paint_fill["fill-opacity"]),"fill-color":new ha(Ai.paint_fill["fill-color"]),"fill-outline-color":new ha(Ai.paint_fill["fill-outline-color"]),"fill-translate":new ca(Ai.paint_fill["fill-translate"]),"fill-translate-anchor":new ca(Ai.paint_fill["fill-translate-anchor"]),"fill-pattern":new ha(Ai.paint_fill["fill-pattern"]),"fill-emissive-strength":new ca(Ai.paint_fill["fill-emissive-strength"])}),layout:um};const Im=ba([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),Nm=ba([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),Wm=ba([{name:"a_centroid_pos",components:2,type:"Uint16"}]),Xm=ba([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),Ym=ba([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:Km}=Im;var Jm={},Qm=Oe,e_=$f;function $f(C,te,le,ce,he){(this||H).properties={},(this||H).extent=le,(this||H).type=0,(this||H)._pbf=C,(this||H)._geometry=-1,(this||H)._keys=ce,(this||H)._values=he,C.readFields(Hf,this||H,te)}function Hf(C,H,te){1==C?H.id=te.readVarint():2==C?function(C,H){for(var te=C.readVarint()+C.pos;C.pos<te;){var le=H._keys[C.readVarint()],ce=H._values[C.readVarint()];H.properties[le]=ce}}(te,H):3==C?H.type=te.readVarint():4==C&&(H._geometry=te.pos)}function Wf(C){for(var H,te,le=0,ce=0,he=C.length,ue=he-1;ce<he;ue=ce++)le+=((te=C[ue]).x-(H=C[ce]).x)*(H.y+te.y);return le}$f.types=["Unknown","Point","LineString","Polygon"],$f.prototype.loadGeometry=function(){var C=(this||H)._pbf;C.pos=(this||H)._geometry;for(var te,le=C.readVarint()+C.pos,ce=1,he=0,ue=0,de=0,_e=[];C.pos<le;){if(he<=0){var ye=C.readVarint();ce=7&ye,he=ye>>3}if(he--,1===ce||2===ce)ue+=C.readSVarint(),de+=C.readSVarint(),1===ce&&(te&&_e.push(te),te=[]),te.push(new Qm(ue,de));else{if(7!==ce)throw new Error("unknown command "+ce);te&&te.push(te[0].clone())}}return te&&_e.push(te),_e},$f.prototype.bbox=function(){var C=(this||H)._pbf;C.pos=(this||H)._geometry;for(var te=C.readVarint()+C.pos,le=1,ce=0,he=0,ue=0,de=1/0,_e=-1/0,ye=1/0,ve=-1/0;C.pos<te;){if(ce<=0){var Me=C.readVarint();le=7&Me,ce=Me>>3}if(ce--,1===le||2===le)(he+=C.readSVarint())<de&&(de=he),he>_e&&(_e=he),(ue+=C.readSVarint())<ye&&(ye=ue),ue>ve&&(ve=ue);else if(7!==le)throw new Error("unknown command "+le)}return[de,ye,_e,ve]},$f.prototype.toGeoJSON=function(C,te,le){var ce,he,ue=(this||H).extent*Math.pow(2,le),de=(this||H).extent*C,_e=(this||H).extent*te,ye=this.loadGeometry(),ve=$f.types[(this||H).type];function h(C){for(var H=0;H<C.length;H++){var te=C[H];C[H]=[360*(te.x+de)/ue-180,360/Math.PI*Math.atan(Math.exp((180-360*(te.y+_e)/ue)*Math.PI/180))-90]}}switch((this||H).type){case 1:var Me=[];for(ce=0;ce<ye.length;ce++)Me[ce]=ye[ce][0];h(ye=Me);break;case 2:for(ce=0;ce<ye.length;ce++)h(ye[ce]);break;case 3:for(ye=function(C){var H=C.length;if(H<=1)return[C];for(var te,le,ce=[],he=0;he<H;he++){var ue=Wf(C[he]);0!==ue&&(void 0===le&&(le=ue<0),le===ue<0?(te&&ce.push(te),te=[C[he]]):te.push(C[he]))}return te&&ce.push(te),ce}(ye),ce=0;ce<ye.length;ce++)for(he=0;he<ye[ce].length;he++)h(ye[ce][he])}1===ye.length?ye=ye[0]:ve="Multi"+ve;var Se={type:"Feature",geometry:{type:ve,coordinates:ye},properties:(this||H).properties};return"id"in(this||H)&&(Se.id=(this||H).id),Se};var t_=e_,i_=Kf;function Kf(C,te){(this||H).version=1,(this||H).name=null,(this||H).extent=4096,(this||H).length=0,(this||H)._pbf=C,(this||H)._keys=[],(this||H)._values=[],(this||H)._features=[],C.readFields(Jf,this||H,te),(this||H).length=(this||H)._features.length}function Jf(C,H,te){15===C?H.version=te.readVarint():1===C?H.name=te.readString():5===C?H.extent=te.readVarint():2===C?H._features.push(te.pos):3===C?H._keys.push(te.readString()):4===C&&H._values.push(function(C){for(var H=null,te=C.readVarint()+C.pos;C.pos<te;){var le=C.readVarint()>>3;H=1===le?C.readString():2===le?C.readFloat():3===le?C.readDouble():4===le?C.readVarint64():5===le?C.readVarint():6===le?C.readSVarint():7===le?C.readBoolean():null}return H}(te))}Kf.prototype.feature=function(C){if(C<0||C>=(this||H)._features.length)throw new Error("feature index out of bounds");(this||H)._pbf.pos=(this||H)._features[C];var te=(this||H)._pbf.readVarint()+(this||H)._pbf.pos;return new t_((this||H)._pbf,te,(this||H).extent,(this||H)._keys,(this||H)._values)};var r_=i_;function em(C,H,te){if(3===C){var le=new r_(te,te.readVarint()+te.pos);le.length&&(H[le.name]=le)}}var n_=Jm.VectorTile=function(C,te){(this||H).layers=C.readFields(em,{},te)},l_=Jm.VectorTileFeature=e_;function rm(C,H,te,le){const ce=[],he=0===le?(C,H,te,le,ce,he)=>{C.push(new Ne(he,te+(he-H)/(le-H)*(ce-te)))}:(C,H,te,le,ce,he)=>{C.push(new Ne(H+(he-te)/(ce-te)*(le-H),he))};for(const ue of C){const C=[];for(const ce of ue){if(ce.length<=2)continue;const ue=[];for(let C=0;C<ce.length-1;C++){const de=ce[C].x,_e=ce[C].y,ye=ce[C+1].x,ve=ce[C+1].y,Me=0===le?de:_e,Se=0===le?ye:ve;Me<H?Se>H&&he(ue,de,_e,ye,ve,H):Me>te?Se<te&&he(ue,de,_e,ye,ve,te):ue.push(ce[C]),Se<H&&Me>=H&&he(ue,de,_e,ye,ve,H),Se>te&&Me<=te&&he(ue,de,_e,ye,ve,te)}let de=ce[ce.length-1];const _e=0===le?de.x:de.y;_e>=H&&_e<=te&&ue.push(de),ue.length&&(de=ue[ue.length-1],ue[0].x===de.x&&ue[0].y===de.y||ue.push(ue[0]),C.push(ue))}C.length&&ce.push(C)}return ce}Jm.VectorTileLayer=i_;class nm{constructor(C){this._stringToNumber={},this._numberToString=[];for(let H=0;H<C.length;H++){const te=C[H];this._stringToNumber[te]=H,this._numberToString[H]=te}}encode(C){return this._stringToNumber[C]}decode(C){return this._numberToString[C]}}var h_={read:function(C,H,te,le,ce){var he,ue,de=8*ce-le-1,_e=(1<<de)-1,ye=_e>>1,ve=-7,Me=te?ce-1:0,Se=te?-1:1,Ae=C[H+Me];for(Me+=Se,he=Ae&(1<<-ve)-1,Ae>>=-ve,ve+=de;ve>0;he=256*he+C[H+Me],Me+=Se,ve-=8);for(ue=he&(1<<-ve)-1,he>>=-ve,ve+=le;ve>0;ue=256*ue+C[H+Me],Me+=Se,ve-=8);if(0===he)he=1-ye;else{if(he===_e)return ue?NaN:1/0*(Ae?-1:1);ue+=Math.pow(2,le),he-=ye}return(Ae?-1:1)*ue*Math.pow(2,he-le)},write:function(C,H,te,le,ce,he){var ue,de,_e,ye=8*he-ce-1,ve=(1<<ye)-1,Me=ve>>1,Se=23===ce?Math.pow(2,-24)-Math.pow(2,-77):0,Ae=le?0:he-1,Ce=le?1:-1,Oe=H<0||0===H&&1/H<0?1:0;for(H=Math.abs(H),isNaN(H)||H===1/0?(de=isNaN(H)?1:0,ue=ve):(ue=Math.floor(Math.log(H)/Math.LN2),H*(_e=Math.pow(2,-ue))<1&&(ue--,_e*=2),(H+=ue+Me>=1?Se/_e:Se*Math.pow(2,1-Me))*_e>=2&&(ue++,_e/=2),ue+Me>=ve?(de=0,ue=ve):ue+Me>=1?(de=(H*_e-1)*Math.pow(2,ce),ue+=Me):(de=H*Math.pow(2,Me-1)*Math.pow(2,ce),ue=0));ce>=8;C[te+Ae]=255&de,Ae+=Ce,de/=256,ce-=8);for(ue=ue<<ce|de,ye+=ce;ye>0;C[te+Ae]=255&ue,Ae+=Ce,ue/=256,ye-=8);C[te+Ae-Ce]|=128*Oe}},p_=lm,g_=h_;function lm(C){(this||H).buf=ArrayBuffer.isView&&ArrayBuffer.isView(C)?C:new Uint8Array(C||0),(this||H).pos=0,(this||H).type=0,(this||H).length=(this||H).buf.length}lm.Varint=0,lm.Fixed64=1,lm.Bytes=2,lm.Fixed32=5;var x_=4294967296,w_=1/x_,T_="undefined"==typeof TextDecoder?null:new TextDecoder("utf8");function dm(C){return C.type===lm.Bytes?C.readVarint()+C.pos:C.pos+1}function pm(C,H,te){return te?4294967296*H+(C>>>0):4294967296*(H>>>0)+(C>>>0)}function fm(C,H,te){var le=H<=16383?1:H<=2097151?2:H<=268435455?3:Math.floor(Math.log(H)/(7*Math.LN2));te.realloc(le);for(var ce=te.pos-1;ce>=C;ce--)te.buf[ce+le]=te.buf[ce]}function mm(C,H){for(var te=0;te<C.length;te++)H.writeVarint(C[te])}function _m(C,H){for(var te=0;te<C.length;te++)H.writeSVarint(C[te])}function gm(C,H){for(var te=0;te<C.length;te++)H.writeFloat(C[te])}function ym(C,H){for(var te=0;te<C.length;te++)H.writeDouble(C[te])}function xm(C,H){for(var te=0;te<C.length;te++)H.writeBoolean(C[te])}function vm(C,H){for(var te=0;te<C.length;te++)H.writeFixed32(C[te])}function bm(C,H){for(var te=0;te<C.length;te++)H.writeSFixed32(C[te])}function wm(C,H){for(var te=0;te<C.length;te++)H.writeFixed64(C[te])}function Tm(C,H){for(var te=0;te<C.length;te++)H.writeSFixed64(C[te])}function Em(C,H){return(C[H]|C[H+1]<<8|C[H+2]<<16)+16777216*C[H+3]}function Mm(C,H,te){C[te]=H,C[te+1]=H>>>8,C[te+2]=H>>>16,C[te+3]=H>>>24}function Am(C,H){return(C[H]|C[H+1]<<8|C[H+2]<<16)+(C[H+3]<<24)}lm.prototype={destroy:function(){(this||H).buf=null},readFields:function(C,te,le){for(le=le||(this||H).length;(this||H).pos<le;){var ce=this.readVarint(),he=ce>>3,ue=(this||H).pos;(this||H).type=7&ce,C(he,te,this||H),(this||H).pos===ue&&this.skip(ce)}return te},readMessage:function(C,te){return this.readFields(C,te,this.readVarint()+(this||H).pos)},readFixed32:function(){var C=Em((this||H).buf,(this||H).pos);return(this||H).pos+=4,C},readSFixed32:function(){var C=Am((this||H).buf,(this||H).pos);return(this||H).pos+=4,C},readFixed64:function(){var C=Em((this||H).buf,(this||H).pos)+Em((this||H).buf,(this||H).pos+4)*x_;return(this||H).pos+=8,C},readSFixed64:function(){var C=Em((this||H).buf,(this||H).pos)+Am((this||H).buf,(this||H).pos+4)*x_;return(this||H).pos+=8,C},readFloat:function(){var C=g_.read((this||H).buf,(this||H).pos,!0,23,4);return(this||H).pos+=4,C},readDouble:function(){var C=g_.read((this||H).buf,(this||H).pos,!0,52,8);return(this||H).pos+=8,C},readVarint:function(C){var te,le,ce=(this||H).buf;return te=127&(le=ce[(this||H).pos++]),le<128?te:(te|=(127&(le=ce[(this||H).pos++]))<<7,le<128?te:(te|=(127&(le=ce[(this||H).pos++]))<<14,le<128?te:(te|=(127&(le=ce[(this||H).pos++]))<<21,le<128?te:function(C,H,te){var le,ce,he=te.buf;if(le=(112&(ce=he[te.pos++]))>>4,ce<128)return pm(C,le,H);if(le|=(127&(ce=he[te.pos++]))<<3,ce<128)return pm(C,le,H);if(le|=(127&(ce=he[te.pos++]))<<10,ce<128)return pm(C,le,H);if(le|=(127&(ce=he[te.pos++]))<<17,ce<128)return pm(C,le,H);if(le|=(127&(ce=he[te.pos++]))<<24,ce<128)return pm(C,le,H);if(le|=(1&(ce=he[te.pos++]))<<31,ce<128)return pm(C,le,H);throw new Error("Expected varint not more than 10 bytes")}(te|=(15&(le=ce[(this||H).pos]))<<28,C,this||H))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var C=this.readVarint();return C%2==1?(C+1)/-2:C/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var C=this.readVarint()+(this||H).pos,te=(this||H).pos;return(this||H).pos=C,C-te>=12&&T_?function(C,H,te){return T_.decode(C.subarray(H,te))}((this||H).buf,te,C):function(C,H,te){for(var le="",ce=H;ce<te;){var he,ue,de,_e=C[ce],ye=null,ve=_e>239?4:_e>223?3:_e>191?2:1;if(ce+ve>te)break;1===ve?_e<128&&(ye=_e):2===ve?128==(192&(he=C[ce+1]))&&(ye=(31&_e)<<6|63&he)<=127&&(ye=null):3===ve?(ue=C[ce+2],128==(192&(he=C[ce+1]))&&128==(192&ue)&&((ye=(15&_e)<<12|(63&he)<<6|63&ue)<=2047||ye>=55296&&ye<=57343)&&(ye=null)):4===ve&&(ue=C[ce+2],de=C[ce+3],128==(192&(he=C[ce+1]))&&128==(192&ue)&&128==(192&de)&&((ye=(15&_e)<<18|(63&he)<<12|(63&ue)<<6|63&de)<=65535||ye>=1114112)&&(ye=null)),null===ye?(ye=65533,ve=1):ye>65535&&(ye-=65536,le+=String.fromCharCode(ye>>>10&1023|55296),ye=56320|1023&ye),le+=String.fromCharCode(ye),ce+=ve}return le}((this||H).buf,te,C)},readBytes:function(){var C=this.readVarint()+(this||H).pos,te=(this||H).buf.subarray((this||H).pos,C);return(this||H).pos=C,te},readPackedVarint:function(C,te){if((this||H).type!==lm.Bytes)return C.push(this.readVarint(te));var le=dm(this||H);for(C=C||[];(this||H).pos<le;)C.push(this.readVarint(te));return C},readPackedSVarint:function(C){if((this||H).type!==lm.Bytes)return C.push(this.readSVarint());var te=dm(this||H);for(C=C||[];(this||H).pos<te;)C.push(this.readSVarint());return C},readPackedBoolean:function(C){if((this||H).type!==lm.Bytes)return C.push(this.readBoolean());var te=dm(this||H);for(C=C||[];(this||H).pos<te;)C.push(this.readBoolean());return C},readPackedFloat:function(C){if((this||H).type!==lm.Bytes)return C.push(this.readFloat());var te=dm(this||H);for(C=C||[];(this||H).pos<te;)C.push(this.readFloat());return C},readPackedDouble:function(C){if((this||H).type!==lm.Bytes)return C.push(this.readDouble());var te=dm(this||H);for(C=C||[];(this||H).pos<te;)C.push(this.readDouble());return C},readPackedFixed32:function(C){if((this||H).type!==lm.Bytes)return C.push(this.readFixed32());var te=dm(this||H);for(C=C||[];(this||H).pos<te;)C.push(this.readFixed32());return C},readPackedSFixed32:function(C){if((this||H).type!==lm.Bytes)return C.push(this.readSFixed32());var te=dm(this||H);for(C=C||[];(this||H).pos<te;)C.push(this.readSFixed32());return C},readPackedFixed64:function(C){if((this||H).type!==lm.Bytes)return C.push(this.readFixed64());var te=dm(this||H);for(C=C||[];(this||H).pos<te;)C.push(this.readFixed64());return C},readPackedSFixed64:function(C){if((this||H).type!==lm.Bytes)return C.push(this.readSFixed64());var te=dm(this||H);for(C=C||[];(this||H).pos<te;)C.push(this.readSFixed64());return C},skip:function(C){var te=7&C;if(te===lm.Varint)for(;(this||H).buf[(this||H).pos++]>127;);else if(te===lm.Bytes)(this||H).pos=this.readVarint()+(this||H).pos;else if(te===lm.Fixed32)(this||H).pos+=4;else{if(te!==lm.Fixed64)throw new Error("Unimplemented type: "+te);(this||H).pos+=8}},writeTag:function(C,H){this.writeVarint(C<<3|H)},realloc:function(C){for(var te=(this||H).length||16;te<(this||H).pos+C;)te*=2;if(te!==(this||H).length){var le=new Uint8Array(te);le.set((this||H).buf),(this||H).buf=le,(this||H).length=te}},finish:function(){return(this||H).length=(this||H).pos,(this||H).pos=0,(this||H).buf.subarray(0,(this||H).length)},writeFixed32:function(C){this.realloc(4),Mm((this||H).buf,C,(this||H).pos),(this||H).pos+=4},writeSFixed32:function(C){this.realloc(4),Mm((this||H).buf,C,(this||H).pos),(this||H).pos+=4},writeFixed64:function(C){this.realloc(8),Mm((this||H).buf,-1&C,(this||H).pos),Mm((this||H).buf,Math.floor(C*w_),(this||H).pos+4),(this||H).pos+=8},writeSFixed64:function(C){this.realloc(8),Mm((this||H).buf,-1&C,(this||H).pos),Mm((this||H).buf,Math.floor(C*w_),(this||H).pos+4),(this||H).pos+=8},writeVarint:function(C){(C=+C||0)>268435455||C<0?function(C,H){var te,le;if(C>=0?(te=C%4294967296|0,le=C/4294967296|0):(le=~(-C/4294967296),4294967295^(te=~(-C%4294967296))?te=te+1|0:(te=0,le=le+1|0)),C>=0x10000000000000000||C<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");H.realloc(10),function(C,H,te){te.buf[te.pos++]=127&C|128,C>>>=7,te.buf[te.pos++]=127&C|128,C>>>=7,te.buf[te.pos++]=127&C|128,C>>>=7,te.buf[te.pos++]=127&C|128,te.buf[te.pos]=127&(C>>>=7)}(te,0,H),function(C,H){var te=(7&C)<<4;H.buf[H.pos++]|=te|((C>>>=3)?128:0),C&&(H.buf[H.pos++]=127&C|((C>>>=7)?128:0),C&&(H.buf[H.pos++]=127&C|((C>>>=7)?128:0),C&&(H.buf[H.pos++]=127&C|((C>>>=7)?128:0),C&&(H.buf[H.pos++]=127&C|((C>>>=7)?128:0),C&&(H.buf[H.pos++]=127&C)))))}(le,H)}(C,this||H):(this.realloc(4),(this||H).buf[(this||H).pos++]=127&C|(C>127?128:0),C<=127||((this||H).buf[(this||H).pos++]=127&(C>>>=7)|(C>127?128:0),C<=127||((this||H).buf[(this||H).pos++]=127&(C>>>=7)|(C>127?128:0),C<=127||((this||H).buf[(this||H).pos++]=C>>>7&127))))},writeSVarint:function(C){this.writeVarint(C<0?2*-C-1:2*C)},writeBoolean:function(C){this.writeVarint(Boolean(C))},writeString:function(C){C=String(C),this.realloc(4*C.length),(this||H).pos++;var te=(this||H).pos;(this||H).pos=function(C,H,te){for(var le,ce,he=0;he<H.length;he++){if((le=H.charCodeAt(he))>55295&&le<57344){if(!ce){le>56319||he+1===H.length?(C[te++]=239,C[te++]=191,C[te++]=189):ce=le;continue}if(le<56320){C[te++]=239,C[te++]=191,C[te++]=189,ce=le;continue}le=ce-55296<<10|le-56320|65536,ce=null}else ce&&(C[te++]=239,C[te++]=191,C[te++]=189,ce=null);le<128?C[te++]=le:(le<2048?C[te++]=le>>6|192:(le<65536?C[te++]=le>>12|224:(C[te++]=le>>18|240,C[te++]=le>>12&63|128),C[te++]=le>>6&63|128),C[te++]=63&le|128)}return te}((this||H).buf,C,(this||H).pos);var le=(this||H).pos-te;le>=128&&fm(te,le,this||H),(this||H).pos=te-1,this.writeVarint(le),(this||H).pos+=le},writeFloat:function(C){this.realloc(4),g_.write((this||H).buf,C,(this||H).pos,!0,23,4),(this||H).pos+=4},writeDouble:function(C){this.realloc(8),g_.write((this||H).buf,C,(this||H).pos,!0,52,8),(this||H).pos+=8},writeBytes:function(C){var te=C.length;this.writeVarint(te),this.realloc(te);for(var le=0;le<te;le++)(this||H).buf[(this||H).pos++]=C[le]},writeRawMessage:function(C,te){(this||H).pos++;var le=(this||H).pos;C(te,this||H);var ce=(this||H).pos-le;ce>=128&&fm(le,ce,this||H),(this||H).pos=le-1,this.writeVarint(ce),(this||H).pos+=ce},writeMessage:function(C,H,te){this.writeTag(C,lm.Bytes),this.writeRawMessage(H,te)},writePackedVarint:function(C,H){H.length&&this.writeMessage(C,mm,H)},writePackedSVarint:function(C,H){H.length&&this.writeMessage(C,_m,H)},writePackedBoolean:function(C,H){H.length&&this.writeMessage(C,xm,H)},writePackedFloat:function(C,H){H.length&&this.writeMessage(C,gm,H)},writePackedDouble:function(C,H){H.length&&this.writeMessage(C,ym,H)},writePackedFixed32:function(C,H){H.length&&this.writeMessage(C,vm,H)},writePackedSFixed32:function(C,H){H.length&&this.writeMessage(C,bm,H)},writePackedFixed64:function(C,H){H.length&&this.writeMessage(C,wm,H)},writePackedSFixed64:function(C,H){H.length&&this.writeMessage(C,Tm,H)},writeBytesField:function(C,H){this.writeTag(C,lm.Bytes),this.writeBytes(H)},writeFixed32Field:function(C,H){this.writeTag(C,lm.Fixed32),this.writeFixed32(H)},writeSFixed32Field:function(C,H){this.writeTag(C,lm.Fixed32),this.writeSFixed32(H)},writeFixed64Field:function(C,H){this.writeTag(C,lm.Fixed64),this.writeFixed64(H)},writeSFixed64Field:function(C,H){this.writeTag(C,lm.Fixed64),this.writeSFixed64(H)},writeVarintField:function(C,H){this.writeTag(C,lm.Varint),this.writeVarint(H)},writeSVarintField:function(C,H){this.writeTag(C,lm.Varint),this.writeSVarint(H)},writeStringField:function(C,H){this.writeTag(C,lm.Bytes),this.writeString(H)},writeFloatField:function(C,H){this.writeTag(C,lm.Fixed32),this.writeFloat(H)},writeDoubleField:function(C,H){this.writeTag(C,lm.Fixed64),this.writeDouble(H)},writeBooleanField:function(C,H){this.writeVarintField(C,Boolean(H))}};var S_=d(p_);const I_=["tile","layer","source","sourceLayer","state"];class Cm{constructor(C,H,te,le,ce){this.type="Feature",this._vectorTileFeature=C,this._z=H,this._x=te,this._y=le,this.properties=C.properties,this.id=ce}get geometry(){return void 0===this._geometry&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(C){this._geometry=C}toJSON(){const C={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};void 0!==this.id&&(C.id=this.id);for(const H of I_)void 0!==this[H]&&(C[H]=this[H]);return C}}class zm{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(C,H,te){const le=String(H);if(this.stateChanges[C]=this.stateChanges[C]||{},this.stateChanges[C][le]=this.stateChanges[C][le]||{},k(this.stateChanges[C][le],te),null===this.deletedStates[C]){this.deletedStates[C]={};for(const H in this.state[C])H!==le&&(this.deletedStates[C][H]=null)}else if(this.deletedStates[C]&&null===this.deletedStates[C][le]){this.deletedStates[C][le]={};for(const H in this.state[C][le])te[H]||(this.deletedStates[C][le][H]=null)}else for(const H in te)this.deletedStates[C]&&this.deletedStates[C][le]&&null===this.deletedStates[C][le][H]&&delete this.deletedStates[C][le][H]}removeFeatureState(C,H,te){if(null===this.deletedStates[C])return;const le=String(H);if(this.deletedStates[C]=this.deletedStates[C]||{},te&&void 0!==H)null!==this.deletedStates[C][le]&&(this.deletedStates[C][le]=this.deletedStates[C][le]||{},this.deletedStates[C][le][te]=null);else if(void 0!==H)if(this.stateChanges[C]&&this.stateChanges[C][le])for(te in this.deletedStates[C][le]={},this.stateChanges[C][le])this.deletedStates[C][le][te]=null;else this.deletedStates[C][le]=null;else this.deletedStates[C]=null}getState(C,H){const te=String(H),le=k({},(this.state[C]||{})[te],(this.stateChanges[C]||{})[te]);if(null===this.deletedStates[C])return{};if(this.deletedStates[C]){const te=this.deletedStates[C][H];if(null===te)return{};for(const C in te)delete le[C]}return le}initializeTileState(C,H){C.setFeatureState(this.state,H)}coalesceChanges(C,H){const te={};for(const C in this.stateChanges){this.state[C]=this.state[C]||{};const H={};for(const te in this.stateChanges[C])this.state[C][te]||(this.state[C][te]={}),k(this.state[C][te],this.stateChanges[C][te]),H[te]=this.state[C][te];te[C]=H}for(const C in this.deletedStates){this.state[C]=this.state[C]||{};const H={};if(null===this.deletedStates[C])for(const te in this.state[C])H[te]={},this.state[C][te]={};else for(const te in this.deletedStates[C]){if(null===this.deletedStates[C][te])this.state[C][te]={};else if(this.state[C][te])for(const H of Object.keys(this.deletedStates[C][te]))delete this.state[C][te][H];H[te]=this.state[C][te]}te[C]=te[C]||{},k(te[C],H)}if(this.stateChanges={},this.deletedStates={},0!==Object.keys(te).length)for(const le in C)C[le].setFeatureState(te,H)}}class Dm{constructor(C){this.size=C,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(C,H){const te=this.toIdx(C,H);return{min:this.minimums[te],max:this.maximums[te]}}isLeaf(C,H){return this.leaves[this.toIdx(C,H)]}toIdx(C,H){return H*this.size+C}}function Pm(C,H,te,le){let ce=0,he=Number.MAX_VALUE;for(let ue=0;ue<3;ue++)if(Math.abs(le[ue])<1e-15){if(te[ue]<C[ue]||te[ue]>H[ue])return null}else{const de=1/le[ue];let _e=(C[ue]-te[ue])*de,ye=(H[ue]-te[ue])*de;if(_e>ye){const C=_e;_e=ye,ye=C}if(_e>ce&&(ce=_e),ye<he&&(he=ye),ce>he)return null}return ce}function Rm(C,H,te,le,ce,he,ue,de,_e,ye,ve){const Me=le-C,Se=ce-H,Ae=he-te,Ce=ue-C,Oe=de-H,Ne=_e-te,je=ve[1]*Ne-ve[2]*Oe,Ge=ve[2]*Ce-ve[0]*Ne,Ze=ve[0]*Oe-ve[1]*Ce,qe=Me*je+Se*Ge+Ae*Ze;if(Math.abs(qe)<1e-15)return null;const $e=1/qe,We=ye[0]-C,He=ye[1]-H,Xe=ye[2]-te,Ye=(We*je+He*Ge+Xe*Ze)*$e;if(Ye<0||Ye>1)return null;const Je=He*Ae-Xe*Se,Qe=Xe*Me-We*Ae,tt=We*Se-He*Me,rt=(ve[0]*Je+ve[1]*Qe+ve[2]*tt)*$e;return rt<0||Ye+rt>1?null:(Ce*Je+Oe*Qe+Ne*tt)*$e}function Lm(C,H,te){return(C-H)/(te-H)}function km(C,H,te,le,ce,he,ue,de,_e){const ye=1<<te,ve=he-le,Me=ue-ce,Se=(C+1)/ye*ve+le,Ae=(H+0)/ye*Me+ce,Ce=(H+1)/ye*Me+ce;de[0]=(C+0)/ye*ve+le,de[1]=Ae,_e[0]=Se,_e[1]=Ce}class Om{constructor(C){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=C,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const H=function(C){const H=Math.ceil(Math.log2(C.dim/8)),te=[];let le=Math.ceil(Math.pow(2,H));const ce=1/le,o=(C,H,te,le,ce)=>{const he=le?1:0,ue=(C+1)*te-he,de=H*te,_e=(H+1)*te-he;ce[0]=C*te,ce[1]=de,ce[2]=ue,ce[3]=_e};let he=new Dm(le);const ue=[];for(let H=0;H<le*le;H++){o(H%le,Math.floor(H/le),ce,!1,ue);const te=Fm(ue[0],ue[1],C),de=Fm(ue[2],ue[1],C),_e=Fm(ue[2],ue[3],C),ye=Fm(ue[0],ue[3],C);he.minimums.push(Math.min(te,de,_e,ye)),he.maximums.push(Math.max(te,de,_e,ye)),he.leaves.push(1)}for(te.push(he),le/=2;le>=1;le/=2){const C=te[te.length-1];he=new Dm(le);for(let H=0;H<le*le;H++){o(H%le,Math.floor(H/le),2,!0,ue);const te=C.getElevation(ue[0],ue[1]),ce=C.getElevation(ue[2],ue[1]),de=C.getElevation(ue[2],ue[3]),_e=C.getElevation(ue[0],ue[3]),ye=C.isLeaf(ue[0],ue[1]),ve=C.isLeaf(ue[2],ue[1]),Me=C.isLeaf(ue[2],ue[3]),Se=C.isLeaf(ue[0],ue[3]),Ae=Math.min(te.min,ce.min,de.min,_e.min),Ce=Math.max(te.max,ce.max,de.max,_e.max),Oe=ye&&ve&&Me&&Se;he.maximums.push(Ce),he.minimums.push(Ae),he.leaves.push(Ce-Ae<=5&&Oe?1:0)}te.push(he)}return te}(this.dem),te=H.length-1,le=H[te];this._addNode(le.minimums[0],le.maximums[0],le.leaves[0]),this._construct(H,0,0,te,0)}raycastRoot(C,H,te,le,ce,he,ue=1){return Pm([C,H,-100],[te,le,this.maximums[0]*ue],ce,he)}raycast(C,H,te,le,ce,he,ue=1){if(!this.nodeCount)return null;const de=this.raycastRoot(C,H,te,le,ce,he,ue);if(null==de)return null;const _e=[],ye=[],ve=[],Me=[],Se=[{idx:0,t:de,nodex:0,nodey:0,depth:0}];for(;Se.length>0;){const{idx:de,t:Ae,nodex:Ce,nodey:Oe,depth:Ne}=Se.pop();if(this.leaves[de]){km(Ce,Oe,Ne,C,H,te,le,ve,Me);const de=1<<Ne,_e=(Ce+0)/de,ye=(Ce+1)/de,Se=(Oe+0)/de,je=(Oe+1)/de,Ge=Fm(_e,Se,this.dem)*ue,Ze=Fm(ye,Se,this.dem)*ue,qe=Fm(ye,je,this.dem)*ue,$e=Fm(_e,je,this.dem)*ue,We=Rm(ve[0],ve[1],Ge,Me[0],ve[1],Ze,Me[0],Me[1],qe,ce,he),He=Rm(Me[0],Me[1],qe,ve[0],Me[1],$e,ve[0],ve[1],Ge,ce,he),Xe=Math.min(null!==We?We:Number.MAX_VALUE,null!==He?He:Number.MAX_VALUE);if(Xe!==Number.MAX_VALUE)return Xe;{const C=Ld.scaleAndAdd([],ce,he,Ae);if(Bm(Ge,Ze,$e,qe,Lm(C[0],ve[0],Me[0]),Lm(C[1],ve[1],Me[1]))>=C[2])return Ae}continue}let je=0;for(let Se=0;Se<this._siblingOffset.length;Se++){km((Ce<<1)+this._siblingOffset[Se][0],(Oe<<1)+this._siblingOffset[Se][1],Ne+1,C,H,te,le,ve,Me),ve[2]=-100,Me[2]=this.maximums[this.childOffsets[de]+Se]*ue;const Ae=Pm(ve,Me,ce,he);if(null!=Ae){const C=Ae;_e[Se]=C;let H=!1;for(let te=0;te<je&&!H;te++)C>=_e[ye[te]]&&(ye.splice(te,0,Se),H=!0);H||(ye[je]=Se),je++}}for(let C=0;C<je;C++){const H=ye[C];Se.push({idx:this.childOffsets[de]+H,t:_e[H],nodex:(Ce<<1)+this._siblingOffset[H][0],nodey:(Oe<<1)+this._siblingOffset[H][1],depth:Ne+1})}}return null}_addNode(C,H,te){return this.minimums.push(C),this.maximums.push(H),this.leaves.push(te),this.childOffsets.push(0),this.nodeCount++}_construct(C,H,te,le,ce){if(1===C[le].isLeaf(H,te))return;this.childOffsets[ce]||(this.childOffsets[ce]=this.nodeCount);const he=le-1,ue=C[he];let de=0,_e=0;for(let C=0;C<this._siblingOffset.length;C++){const le=2*H+this._siblingOffset[C][0],ce=2*te+this._siblingOffset[C][1],he=ue.getElevation(le,ce),ye=ue.isLeaf(le,ce),ve=this._addNode(he.min,he.max,ye);ye&&(de|=1<<C),_e||(_e=ve)}for(let le=0;le<this._siblingOffset.length;le++)de&1<<le||this._construct(C,2*H+this._siblingOffset[le][0],2*te+this._siblingOffset[le][1],he,_e+le)}}function Bm(C,H,te,le,ce,he){return Wr(Wr(C,te,he),Wr(H,le,he),ce)}function Fm(C,H,te){const le=te.dim,ce=z(C*le-.5,0,le-1),he=z(H*le-.5,0,le-1),ue=Math.floor(ce),de=Math.floor(he),_e=Math.min(ue+1,le-1),ye=Math.min(de+1,le-1);return Bm(te.get(ue,de),te.get(_e,de),te.get(ue,ye),te.get(_e,ye),ce-ue,he-de)}const H_={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768],float:[1,1,1,1]};function Um(C,H,te){return(256*C*256+256*H+te)/10-1e4}function Vm(C,H,te){return 256*C+H+te/256-32768}class jm{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(C,H,te,le,ce=!1){if(this.uid=C,H.height!==H.width)throw new RangeError("DEM tiles must be square");if(te&&"mapbox"!==te&&"terrarium"!==te)return W(`"${te}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=H.height;const he=this.dim=H.height-2,ue=new Uint32Array(H.data.buffer);if(this.pixels=new Uint8Array(H.data.buffer),this.encoding=te||"mapbox",this.borderReady=ce,this._modifiedForSources={},!ce){for(let C=0;C<he;C++)ue[this._idx(-1,C)]=ue[this._idx(0,C)],ue[this._idx(he,C)]=ue[this._idx(he-1,C)],ue[this._idx(C,-1)]=ue[this._idx(C,0)],ue[this._idx(C,he)]=ue[this._idx(C,he-1)];ue[this._idx(-1,-1)]=ue[this._idx(0,0)],ue[this._idx(he,-1)]=ue[this._idx(he-1,0)],ue[this._idx(-1,he)]=ue[this._idx(0,he-1)],ue[this._idx(he,he)]=ue[this._idx(he-1,he-1)]}if(le){const C=new Float32Array(H.data.buffer),te="terrarium"===this.encoding?Vm:Um;for(let H=0;H<ue.length;++H){const le=4*H;C[H]=te(this.pixels[le],this.pixels[le+1],this.pixels[le+2])}this.encoding="float"}this._timestamp=yi.now()}_buildQuadTree(){this._tree=new Om(this)}get(C,H,te=!1){te&&(C=z(C,-1,this.dim),H=z(H,-1,this.dim));const le=this._idx(C,H);if("float"===this.encoding)return this.floatView||(this.floatView=new Float32Array(this.pixels.buffer)),this.floatView[le];const ce=4*le;return("terrarium"===this.encoding?Vm:Um)(this.pixels[ce],this.pixels[ce+1],this.pixels[ce+2])}set(C,H,te){const le=this._idx(C,H);if("float"===this.encoding){this.floatView||(this.floatView=new Float32Array(this.pixels.buffer));const C=this.floatView[le];return this.floatView[le]=te,te-C}const ce=4*le,he=("terrarium"===this.encoding?Vm:Um)(this.pixels[ce],this.pixels[ce+1],this.pixels[ce+2]),ue=jm.pack(te,"terrarium"===this.encoding?"terrarium":"mapbox");return this.pixels[ce]=ue[0],this.pixels[ce+1]=ue[1],this.pixels[ce+2]=ue[2],te-he}static getUnpackVector(C){return H_[C]}get unpackVector(){return H_[this.encoding]}_idx(C,H){if(C<-1||C>=this.dim+1||H<-1||H>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(H+1)*this.stride+(C+1)}static pack(C,H){const te=[0,0,0,0],le=jm.getUnpackVector(H);let ce=Math.floor((C+le[3])/le[2]);return te[2]=ce%256,ce=Math.floor(ce/256),te[1]=ce%256,ce=Math.floor(ce/256),te[0]=ce,te}getPixels(){return"float"===this.encoding?new Hp({width:this.stride,height:this.stride},this.pixels):new $p({width:this.stride,height:this.stride},this.pixels)}backfillBorder(C,H,te){if(this.dim!==C.dim)throw new Error("dem dimension mismatch");let le=H*this.dim,ce=H*this.dim+this.dim,he=te*this.dim,ue=te*this.dim+this.dim;switch(H){case-1:le=ce-1;break;case 1:ce=le+1}switch(te){case-1:he=ue-1;break;case 1:ue=he+1}const de=-H*this.dim,_e=-te*this.dim;for(let H=he;H<ue;H++)for(let te=le;te<ce;te++){const le=4*this._idx(te,H),ce=4*this._idx(te+de,H+_e);this.pixels[le+0]=C.pixels[ce+0],this.pixels[le+1]=C.pixels[ce+1],this.pixels[le+2]=C.pixels[ce+2],this.pixels[le+3]=C.pixels[ce+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}Is(jm,"DEMData"),Is(Om,"DemMinMaxQuadTree",{omit:["dem"]});class Gm{isDataAvailableAtPoint(C){const H=this._source();if(this.isUsingMockSource()||!H||C.y<0||C.y>1)return!1;const te=H.getSource().maxzoom,le=1<<te,ce=Math.floor(C.x),he=Math.floor((C.x-ce)*le),ue=Math.floor(C.y*le),de=this.findDEMTileFor(new Bu(te,ce,te,he,ue));return!(!de||!de.dem)}getAtPointOrZero(C,H=0){return this.getAtPoint(C,H)||0}getAtPoint(C,H,te=!0){if(this.isUsingMockSource())return null;null==H&&(H=null);const le=this._source();if(!le)return H;if(C.y<0||C.y>1)return H;const ce=le.getSource().maxzoom,he=1<<ce,ue=Math.floor(C.x),de=C.x-ue,_e=new Bu(ce,ue,ce,Math.floor(de*he),Math.floor(C.y*he)),ye=this.findDEMTileFor(_e);if(!ye||!ye.dem)return H;const ve=ye.dem,Me=1<<ye.tileID.canonical.z,Se=(de*Me-ye.tileID.canonical.x)*ve.dim,Ae=(C.y*Me-ye.tileID.canonical.y)*ve.dim,Ce=Math.floor(Se),Oe=Math.floor(Ae);return(te?this.exaggeration():1)*Wr(Wr(ve.get(Ce,Oe),ve.get(Ce,Oe+1),Ae-Oe),Wr(ve.get(Ce+1,Oe),ve.get(Ce+1,Oe+1),Ae-Oe),Se-Ce)}getAtTileOffset(C,H,te){const le=1<<C.canonical.z;return this.getAtPointOrZero(new ep(C.wrap+(C.canonical.x+H/wn)/le,(C.canonical.y+te/wn)/le))}getAtTileOffsetFunc(C,H,te,le){return ce=>{const he=this.getAtTileOffset(C,ce.x,ce.y),ue=le.upVector(C.canonical,ce.x,ce.y),de=le.upVectorScale(C.canonical,H,te).metersToTile;return Ld.scale(ue,ue,he*de),ue}}getForTilePoints(C,H,te,le){if(this.isUsingMockSource())return!1;const ce=qm.create(this,C,le);return!!ce&&(H.forEach((C=>{C[2]=this.exaggeration()*ce.getElevationAt(C[0],C[1],te)})),!0)}getMinMaxForTile(C){if(this.isUsingMockSource())return null;const H=this.findDEMTileFor(C);if(!H||!H.dem)return null;const te=H.dem.tree,le=H.tileID,ce=1<<C.canonical.z-le.canonical.z;let he=C.canonical.x/ce-le.canonical.x,ue=C.canonical.y/ce-le.canonical.y,de=0;for(let H=0;H<C.canonical.z-le.canonical.z&&!te.leaves[de];H++){he*=2,ue*=2;const C=2*Math.floor(ue)+Math.floor(he);de=te.childOffsets[de]+C,he%=1,ue%=1}return{min:this.exaggeration()*te.minimums[de],max:this.exaggeration()*te.maximums[de]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(C,H,te){throw new Error("Pure virtual method called.")}pointCoordinate(C){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(C){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}}class qm{constructor(C,H,te){this._demTile=C,this._dem=this._demTile.dem,this._scale=H,this._offset=te}static create(C,H,te){const le=te||C.findDEMTileFor(H);if(!le||!le.dem)return;const ce=le.dem,he=le.tileID,ue=1<<H.canonical.z-he.canonical.z;return new qm(le,ce.dim/wn/ue,[(H.canonical.x/ue-he.canonical.x)*ce.dim,(H.canonical.y/ue-he.canonical.y)*ce.dim])}tileCoordToPixel(C,H){const te=H*this._scale+this._offset[1],le=Math.floor(C*this._scale+this._offset[0]),ce=Math.floor(te);return new Ne(le,ce)}getElevationAt(C,H,te,le){const ce=C*this._scale+this._offset[0],he=H*this._scale+this._offset[1],ue=Math.floor(ce),de=Math.floor(he),_e=this._dem;return le=!!le,te?Wr(Wr(_e.get(ue,de,le),_e.get(ue,de+1,le),he-de),Wr(_e.get(ue+1,de,le),_e.get(ue+1,de+1,le),he-de),ce-ue):_e.get(ue,de,le)}getElevationAtPixel(C,H,te){return this._dem.get(C,H,!!te)}getMeterToDEM(C){return(1<<this._demTile.tileID.canonical.z)*Zd(1,C)*this._dem.stride}}class Zm{constructor(C,H){this.tileID=C,this.x=C.canonical.x,this.y=C.canonical.y,this.z=C.canonical.z,this.grid=new vl(wn,16,0),this.featureIndexArray=new ll,this.promoteId=H}insert(C,H,te,le,ce,he=0){const ue=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(te,le,ce,he);const de=this.grid;for(let C=0;C<H.length;C++){const te=H[C],le=[1/0,1/0,-1/0,-1/0];for(let C=0;C<te.length;C++){const H=te[C];le[0]=Math.min(le[0],H.x),le[1]=Math.min(le[1],H.y),le[2]=Math.max(le[2],H.x),le[3]=Math.max(le[3],H.y)}le[0]<wn&&le[1]<wn&&le[2]>=0&&le[3]>=0&&de.insert(ue,le[0],le[1],le[2],le[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new n_(new S_(this.rawTileData)).layers,this.sourceLayerCoder=new nm(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const C in this.vtLayers)this.vtFeatures[C]=[]}return this.vtLayers}query(C,H,te,le){this.loadVTLayers();const ce=C.params||{},he=Ro(ce.filter),ue=C.tileResult,de=C.transform,_e=ue.bufferedTilespaceBounds,ye=this.grid.query(_e.min.x,_e.min.y,_e.max.x,_e.max.y,((C,H,te,le)=>Tp(ue.bufferedTilespaceGeometry,C,H,te,le)));ye.sort(Hm);let ve=null;de.elevation&&ye.length>0&&(ve=qm.create(de.elevation,this.tileID));const Me={};let Se;for(let de=0;de<ye.length;de++){const _e=ye[de];if(_e===Se)continue;Se=_e;const Ae=this.featureIndexArray.get(_e);let Ce=null;this.loadMatchingFeature(Me,Ae,he,ce.layers,ce.availableImages,H,te,le,((H,te,le,ce=0)=>(Ce||(Ce=lp(H,this.tileID.canonical,C.tileTransform)),te.queryIntersectsFeature(ue,H,le,Ce,this.z,C.transform,C.pixelPosMatrix,ve,ce))))}return Me}loadMatchingFeature(C,H,te,le,ce,he,ue,de,_e){const{featureIndex:ye,bucketIndex:ve,sourceLayerIndex:Me,layoutVertexArrayOffset:Se}=H,Ae=this.bucketLayerIDs[ve];if(le&&!function(C,H){for(let te=0;te<C.length;te++)if(H.indexOf(C[te])>=0)return!0;return!1}(le,Ae))return;const Ce=this.sourceLayerCoder.decode(Me),Oe=this.vtLayers[Ce].feature(ye);if(te.needGeometry){const C=cp(Oe,!0);if(!te.filter(new ea(this.tileID.overscaledZ),C,this.tileID.canonical))return}else if(!te.filter(new ea(this.tileID.overscaledZ),Oe))return;const Ne=this.getId(Oe,Ce);for(let H=0;H<Ae.length;H++){const te=Ae[H];if(le&&le.indexOf(te)<0)continue;const ve=he[te];if(!ve)continue;let Me={};void 0!==Ne&&de&&(Me=de.getState(ve.sourceLayer||"_geojsonTileLayer",Ne));const Ce=k({},ue[te]);Ce.paint=$m(Ce.paint,ve.paint,Oe,Me,ce),Ce.layout=$m(Ce.layout,ve.layout,Oe,Me,ce);const je=!_e||_e(Oe,ve,Me,Se);if(!je)continue;const Ge=new Cm(Oe,this.z,this.x,this.y,Ne);Ge.layer=Ce;let Ze=C[te];void 0===Ze&&(Ze=C[te]=[]),Ze.push({featureIndex:ye,feature:Ge,intersectionZ:je})}}lookupSymbolFeatures(C,H,te,le,ce,he,ue,de){const _e={};this.loadVTLayers();const ye=Ro(ce);for(const ce of C)this.loadMatchingFeature(_e,{bucketIndex:te,sourceLayerIndex:le,featureIndex:ce,layoutVertexArrayOffset:0},ye,he,ue,de,H);return _e}loadFeature(C){const{featureIndex:H,sourceLayerIndex:te}=C;this.loadVTLayers();const le=this.sourceLayerCoder.decode(te),ce=this.vtFeatures[le];if(ce[H])return ce[H];const he=this.vtLayers[le].feature(H);return ce[H]=he,he}hasLayer(C){for(const H of this.bucketLayerIDs)for(const te of H)if(C===te)return!0;return!1}getId(C,H){let te=C.id;if(this.promoteId){const le="string"==typeof this.promoteId?this.promoteId:this.promoteId[H];null!=le&&(te=C.properties[le]),"boolean"==typeof te&&(te=Number(te))}return te}}function $m(C,H,te,le,ce){return q(C,((C,he)=>{const ue=H instanceof la?H.get(he):null;return ue&&ue.evaluate?ue.evaluate(te,le,ce):ue}))}function Hm(C,H){return H-C}Is(Zm,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});const Y_=ba([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),J_=ba([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),lg=ba([{name:"a_projected_pos",components:4,type:"Float32"}],4);ba([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const cg=ba([{name:"a_z_offset",components:1,type:"Float32"}],4),hg=ba([{name:"a_texb",components:2,type:"Uint16"}]),mg=ba([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"}]),_g=ba([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"}]);ba([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const Sg=ba([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),zg=ba([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);ba([{name:"triangle",components:3,type:"Uint16"}]),ba([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),ba([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"}]),ba([{type:"Float32",name:"offsetX"}]),ba([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var Dg=24;const Pg=128;function o_(C,H){const{expression:te}=H;if("constant"===te.kind)return{kind:"constant",layoutSize:te.evaluate(new ea(C+1))};if("source"===te.kind)return{kind:"source"};{const{zoomStops:H,interpolationType:le}=te;let ce=0;for(;ce<H.length&&H[ce]<=C;)ce++;ce=Math.max(0,ce-1);let he=ce;for(;he<H.length&&H[he]<C+1;)he++;he=Math.min(H.length-1,he);const ue=H[ce],de=H[he];return"composite"===te.kind?{kind:"composite",minZoom:ue,maxZoom:de,interpolationType:le}:{kind:"camera",minZoom:ue,maxZoom:de,minSize:te.evaluate(new ea(ue)),maxSize:te.evaluate(new ea(de)),interpolationType:le}}}function s_(C,{uSize:H,uSizeT:te},{lowerSize:le,upperSize:ce}){return"source"===C.kind?le/Pg:"composite"===C.kind?Wr(le/Pg,ce/Pg,te):H}function a_(C,H){let te=0,le=0;if("constant"===C.kind)le=C.layoutSize;else if("source"!==C.kind){const{interpolationType:ce,minZoom:he,maxZoom:ue}=C,de=ce?z(Es.interpolationFactor(ce,H,he,ue),0,1):0;"camera"===C.kind?le=Wr(C.minSize,C.maxSize,de):te=de}return{uSizeT:te,uSize:le}}var Rg=Object.freeze({__proto__:null,SIZE_PACK_FACTOR:Pg,evaluateSizeForFeature:s_,evaluateSizeForZoom:a_,getSizeData:o_});function c_(C,H,te){return C.sections.forEach((C=>{C.text=function(C,H,te){const le=H.layout.get("text-transform").evaluate(te,{});return"uppercase"===le?C=C.toLocaleUpperCase():"lowercase"===le&&(C=C.toLocaleLowerCase()),tc.applyArabicShaping&&(C=tc.applyArabicShaping(C)),C}(C.text,H,te)})),C}const Lg={"!":"︕","#":"＃",$:"＄","%":"％","&":"＆","(":"︵",")":"︶","*":"＊","+":"＋",",":"︐","-":"︲",".":"・","/":"／",":":"︓",";":"︔","<":"︿","=":"＝",">":"﹀","?":"︖","@":"＠","[":"﹇","\\":"＼","]":"﹈","^":"＾",_:"︳","`":"｀","{":"︷","|":"―","}":"︸","~":"～","¢":"￠","£":"￡","¥":"￥","¦":"￤","¬":"￢","¯":"￣","–":"︲","—":"︱","‘":"﹃","’":"﹄","“":"﹁","”":"﹂","…":"︙","‧":"・","₩":"￦","、":"︑","。":"︒","〈":"︿","〉":"﹀","《":"︽","》":"︾","「":"﹁","」":"﹂","『":"﹃","』":"﹄","【":"︻","】":"︼","〔":"︹","〕":"︺","〖":"︗","〗":"︘","！":"︕","（":"︵","）":"︶","，":"︐","－":"︲","．":"・","：":"︓","；":"︔","＜":"︿","＞":"﹀","？":"︖","［":"﹇","］":"﹈","＿":"︳","｛":"︷","｜":"―","｝":"︸","｟":"︵","｠":"︶","｡":"︒","｢":"﹁","｣":"﹂","←":"↑","→":"↓"};function u_(C){return"︶"===C||"﹈"===C||"︸"===C||"﹄"===C||"﹂"===C||"︾"===C||"︼"===C||"︺"===C||"︘"===C||"﹀"===C||"︐"===C||"︓"===C||"︔"===C||"｀"===C||"￣"===C||"︑"===C||"︒"===C}function d_(C){return"︵"===C||"﹇"===C||"︷"===C||"﹃"===C||"﹁"===C||"︽"===C||"︻"===C||"︹"===C||"︗"===C||"︿"===C}const Bg=3;function f_(C,H,te){H.glyphs=[],1===C&&te.readMessage(m_,H)}function m_(C,H,te){if(3===C){const{id:C,bitmap:le,width:ce,height:he,left:ue,top:de,advance:_e}=te.readMessage(__,{});H.glyphs.push({id:C,bitmap:new Zp({width:ce+2*Bg,height:he+2*Bg},le),metrics:{width:ce,height:he,left:ue,top:de,advance:_e}})}else 4===C?H.ascender=te.readSVarint():5===C&&(H.descender=te.readSVarint())}function __(C,H,te){1===C?H.id=te.readVarint():2===C?H.bitmap=te.readBytes():3===C?H.width=te.readVarint():4===C?H.height=te.readVarint():5===C?H.left=te.readSVarint():6===C?H.top=te.readSVarint():7===C&&(H.advance=te.readVarint())}const Vg=Bg;function y_(C){let H=0,te=0;for(const le of C)H+=le.w*le.h,te=Math.max(te,le.w);C.sort(((C,H)=>H.h-C.h));const le=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(H/.95)),te),h:1/0}];let ce=0,he=0;for(const H of C)for(let C=le.length-1;C>=0;C--){const te=le[C];if(!(H.w>te.w||H.h>te.h)){if(H.x=te.x,H.y=te.y,he=Math.max(he,H.y+H.h),ce=Math.max(ce,H.x+H.w),H.w===te.w&&H.h===te.h){const H=le.pop();C<le.length&&(le[C]=H)}else H.h===te.h?(te.x+=H.w,te.w-=H.w):H.w===te.w?(te.y+=H.h,te.h-=H.h):(le.push({x:te.x+H.w,y:te.y,w:te.w-H.w,h:H.h}),te.y+=H.h,te.h-=H.h);break}}return{w:ce,h:he,fill:H/(ce*he)||0}}const Gg=1;class v_{constructor(C,{pixelRatio:H,version:te,stretchX:le,stretchY:ce,content:he}){this.paddedRect=C,this.pixelRatio=H,this.stretchX=le,this.stretchY=ce,this.content=he,this.version=te}get tl(){return[this.paddedRect.x+Gg,this.paddedRect.y+Gg]}get br(){return[this.paddedRect.x+this.paddedRect.w-Gg,this.paddedRect.y+this.paddedRect.h-Gg]}get displaySize(){return[(this.paddedRect.w-2*Gg)/this.pixelRatio,(this.paddedRect.h-2*Gg)/this.pixelRatio]}}class b_{constructor(C,H){const te={},le={};this.haveRenderCallbacks=[];const ce=[];this.addImages(C,te,ce),this.addImages(H,le,ce);const{w:he,h:ue}=y_(ce),de=new $p({width:he||1,height:ue||1});for(const H in C){const le=C[H],ce=te[H].paddedRect;$p.copy(le.data,de,{x:0,y:0},{x:ce.x+Gg,y:ce.y+Gg},le.data)}for(const C in H){const te=H[C],ce=le[C].paddedRect,he=ce.x+Gg,ue=ce.y+Gg,_e=te.data.width,ye=te.data.height;$p.copy(te.data,de,{x:0,y:0},{x:he,y:ue},te.data),$p.copy(te.data,de,{x:0,y:ye-1},{x:he,y:ue-1},{width:_e,height:1}),$p.copy(te.data,de,{x:0,y:0},{x:he,y:ue+ye},{width:_e,height:1}),$p.copy(te.data,de,{x:_e-1,y:0},{x:he-1,y:ue},{width:1,height:ye}),$p.copy(te.data,de,{x:0,y:0},{x:he+_e,y:ue},{width:1,height:ye})}this.image=de,this.iconPositions=te,this.patternPositions=le}addImages(C,H,te){for(const le in C){const ce=C[le],he={x:0,y:0,w:ce.data.width+2*Gg,h:ce.data.height+2*Gg};te.push(he),H[le]=new v_(he,ce),ce.hasRenderCallback&&this.haveRenderCallbacks.push(le)}}patchUpdatedImages(C,H,te){this.haveRenderCallbacks=this.haveRenderCallbacks.filter((H=>C.hasImage(H,te))),C.dispatchRenderCallbacks(this.haveRenderCallbacks,te);for(const le in C.getUpdatedImages(te))this.patchUpdatedImage(this.iconPositions[le],C.getImage(le,te),H),this.patchUpdatedImage(this.patternPositions[le],C.getImage(le,te),H)}patchUpdatedImage(C,H,te){if(!C||!H)return;if(C.version===H.version)return;C.version=H.version;const[le,ce]=C.tl;te.update(H.data,void 0,{x:le,y:ce})}}Is(v_,"ImagePosition"),Is(b_,"ImageAtlas");const Wg={horizontal:1,vertical:2,horizontalOnly:3},Xg=-17;class E_{constructor(){this.scale=1,this.fontStack="",this.imageName=null}static forText(C,H){const te=new E_;return te.scale=C||1,te.fontStack=H,te}static forImage(C){const H=new E_;return H.imageName=C,H}}class M_{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(C,H){const te=new M_;for(let le=0;le<C.sections.length;le++){const ce=C.sections[le];ce.image?te.addImageSection(ce):te.addTextSection(ce,H)}return te}length(){return this.text.length}getSection(C){return this.sections[this.sectionIndex[C]]}getSections(){return this.sections}getSectionIndex(C){return this.sectionIndex[C]}getCodePoint(C){return this.text.codePointAt(C)}verticalizePunctuation(C){this.text=function(C,H){let te="";for(let le=0;le<C.length;le++){const ce=C.charCodeAt(le+1)||null,he=C.charCodeAt(le-1)||null;te+=!H&&(ce&&Fs(ce)&&!Lg[C[le+1]]||he&&Fs(he)&&!Lg[C[le-1]])||!Lg[C[le]]?C[le]:Lg[C[le]]}return te}(this.text,C)}trim(){let C=0;for(let H=0;H<this.text.length&&Jg[this.text.charCodeAt(H)];H++)C++;let H=this.text.length;for(let te=this.text.length-1;te>=0&&te>=C&&Jg[this.text.charCodeAt(te)];te--)H--;this.text=this.text.substring(C,H),this.sectionIndex=this.sectionIndex.slice(C,H)}substring(C,H){const te=new M_;return te.text=this.text.substring(C,H),te.sectionIndex=this.sectionIndex.slice(C,H),te.sections=this.sections,te}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce(((C,H)=>Math.max(C,this.sections[H].scale)),0)}addTextSection(C,H){this.text+=C.text,this.sections.push(E_.forText(C.scale,C.fontStack||H));const te=this.sections.length-1;for(let H=0;H<C.text.length;++H)this.sectionIndex.push(te)}addImageSection(C){const H=C.image?C.image.namePrimary:"";if(0===H.length)return void W("Can't add FormattedSection with an empty image.");const te=this.getNextImageSectionCharCode();te?(this.text+=String.fromCodePoint(te),this.sections.push(E_.forImage(H)),this.sectionIndex.push(this.sections.length-1)):W("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function A_(C,H,te,le,ce,he,ue,de,_e,ye,ve,Me,Se,Ae,Ce){const Oe=M_.fromFeature(C,ce);Me===Wg.vertical&&Oe.verticalizePunctuation(Se);let Ne=[];const je=function(C,H,te,le,ce,he){if(!C)return[];const ue=[],de=function(C,H,te,le,ce,he){let ue=0;for(let te=0;te<C.length();te++){const de=C.getSection(te);ue+=C_(C.getCodePoint(te),de,le,ce,H,he)}return ue/Math.max(1,Math.ceil(ue/te))}(C,H,te,le,ce,he),_e=C.text.indexOf("​")>=0;let ye=0;for(let te=0;te<C.length();te++){const Me=C.getSection(te),Se=C.getCodePoint(te);if(Jg[Se]||(ye+=C_(Se,Me,le,ce,H,he)),te<C.length()-1){const H=!((ve=Se)<11904||!(wl["Bopomofo Extended"](ve)||wl.Bopomofo(ve)||wl["CJK Compatibility Forms"](ve)||wl["CJK Compatibility Ideographs"](ve)||wl["CJK Compatibility"](ve)||wl["CJK Radicals Supplement"](ve)||wl["CJK Strokes"](ve)||wl["CJK Symbols and Punctuation"](ve)||wl["CJK Unified Ideographs Extension A"](ve)||wl["CJK Unified Ideographs"](ve)||wl["Enclosed CJK Letters and Months"](ve)||wl["Halfwidth and Fullwidth Forms"](ve)||wl.Hiragana(ve)||wl["Ideographic Description Characters"](ve)||wl["Kangxi Radicals"](ve)||wl["Katakana Phonetic Extensions"](ve)||wl.Katakana(ve)||wl["Vertical Forms"](ve)||wl["Yi Radicals"](ve)||wl["Yi Syllables"](ve)));(Qg[Se]||H||Me.imageName)&&ue.push(P_(te+1,ye,de,ue,D_(Se,C.getCodePoint(te+1),H&&_e),!1))}}var ve;return R_(P_(C.length(),ye,de,ue,0,!0))}(Oe,ye,he,H,le,Ae),{processBidirectionalText:Ge,processStyledBidirectionalText:Ze}=tc;if(Ge&&1===Oe.sections.length){const C=Ge(Oe.toString(),je);for(const H of C){const C=new M_;C.text=H,C.sections=Oe.sections;for(let te=0;te<H.length;te++)C.sectionIndex.push(0);Ne.push(C)}}else if(Ze){const C=Ze(Oe.text,Oe.sectionIndex,je);for(const H of C){const C=new M_;C.text=H[0],C.sectionIndex=H[1],C.sections=Oe.sections,Ne.push(C)}}else Ne=function(C,H){const te=[],le=C.text;let ce=0;for(const le of H)te.push(C.substring(ce,le)),ce=le;return ce<le.length&&te.push(C.substring(ce,le.length)),te}(Oe,je);const qe=[],$e={positionedLines:qe,text:Oe.toString(),top:ve[1],bottom:ve[1],left:ve[0],right:ve[0],writingMode:Me,iconsInText:!1,verticalizable:!1,hasBaseline:!1};return function(C,H,te,le,ce,he,ue,de,_e,ye,ve,Me){let Se=0,Ae=0,Ce=0;const Oe="right"===de?1:"left"===de?0:.5;let Ne=!1;for(const C of ce){const te=C.getSections();for(const C of te){if(C.imageName)continue;const te=H[C.fontStack];if(te&&(Ne=void 0!==te.ascender&&void 0!==te.descender,!Ne))break}if(!Ne)break}let je=0;for(const ue of ce){ue.trim();const ce=ue.getMaxScale(),de=(ce-1)*Dg,Ze={positionedGlyphs:[],lineOffset:0};C.positionedLines[je]=Ze;const qe=Ze.positionedGlyphs;let $e=0;if(!ue.length()){Ae+=he,++je;continue}let We=0,He=0;for(let he=0;he<ue.length();he++){const de=ue.getSection(he),Ce=ue.getSectionIndex(he),Oe=ue.getCodePoint(he);let je=de.scale,Ze=null,Xe=null,Ye=null,Je=Dg,Qe=0;const tt=!(_e===Wg.horizontal||!ve&&!Bs(Oe)||ve&&(Jg[Oe]||(Ge=Oe,wl.Arabic(Ge)||wl["Arabic Supplement"](Ge)||wl["Arabic Extended-A"](Ge)||wl["Arabic Presentation Forms-A"](Ge)||wl["Arabic Presentation Forms-B"](Ge))));if(de.imageName){const H=le[de.imageName];if(!H)continue;Ye=de.imageName,C.iconsInText=C.iconsInText||!0,Xe=H.paddedRect;const te=H.displaySize;je=je*Dg/Me,Ze={width:te[0],height:te[1],left:Gg,top:-Vg,advance:tt?te[1]:te[0],localGlyph:!1},Qe=Ne?-Ze.height*je:Xg+ce*Dg-te[1]*je,Je=Ze.advance;const he=(tt?te[0]:te[1])*je-Dg*ce;he>0&&he>$e&&($e=he)}else{const C=te[de.fontStack];if(!C)continue;C[Oe]&&(Xe=C[Oe]);const le=H[de.fontStack];if(!le)continue;const he=le.glyphs[Oe];if(!he)continue;if(Ze=he.metrics,Je=8203!==Oe?Dg:0,Ne){const C=void 0!==le.ascender?Math.abs(le.ascender):0,H=void 0!==le.descender?Math.abs(le.descender):0,te=(C+H)*je;We<te&&(We=te,He=(C-H)/2*je),Qe=-C*je}else Qe=Xg+(ce-je)*Dg}tt?(C.verticalizable=!0,qe.push({glyph:Oe,imageName:Ye,x:Se,y:Ae+Qe,vertical:tt,scale:je,localGlyph:Ze.localGlyph,fontStack:de.fontStack,sectionIndex:Ce,metrics:Ze,rect:Xe}),Se+=Je*je+ye):(qe.push({glyph:Oe,imageName:Ye,x:Se,y:Ae+Qe,vertical:tt,scale:je,localGlyph:Ze.localGlyph,fontStack:de.fontStack,sectionIndex:Ce,metrics:Ze,rect:Xe}),Se+=Ze.advance*je+ye)}0!==qe.length&&(Ce=Math.max(Se-ye,Ce),Ne?k_(qe,Oe,$e,He,he*ce/2):k_(qe,Oe,$e,0,he/2)),Se=0;const Xe=he*ce+$e;Ze.lineOffset=Math.max($e,de),Ae+=Xe,++je}var Ge;const Ze=Ae,{horizontalAlign:qe,verticalAlign:$e}=L_(ue);(function(C,H,te,le,ce,he){const ue=(H-te)*ce,de=-he*le;for(const H of C)for(const C of H.positionedGlyphs)C.x+=ue,C.y+=de})(C.positionedLines,Oe,qe,$e,Ce,Ze),C.top+=-$e*Ze,C.bottom=C.top+Ze,C.left+=-qe*Ce,C.right=C.left+Ce,C.hasBaseline=Ne}($e,H,te,le,Ne,ue,de,_e,Me,ye,Se,Ce),!function(C){for(const H of C)if(0!==H.positionedGlyphs.length)return!1;return!0}(qe)&&$e}const Jg={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},Qg={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function C_(C,H,te,le,ce,he){if(H.imageName){const C=le[H.imageName];return C?C.displaySize[0]*H.scale*Dg/he+ce:0}{const le=te[H.fontStack],he=le&&le.glyphs[C];return he?he.metrics.advance*H.scale+ce:0}}function z_(C,H,te,le){const ce=Math.pow(C-H,2);return le?C<H?ce/2:2*ce:ce+Math.abs(te)*te}function D_(C,H,te){let le=0;return 10===C&&(le-=1e4),te&&(le+=150),40!==C&&65288!==C||(le+=50),41!==H&&65289!==H||(le+=50),le}function P_(C,H,te,le,ce,he){let ue=null,de=z_(H,te,ce,he);for(const C of le){const le=z_(H-C.x,te,ce,he)+C.badness;le<=de&&(ue=C,de=le)}return{index:C,x:H,priorBreak:ue,badness:de}}function R_(C){return C?R_(C.priorBreak).concat(C.index):[]}function L_(C){let H=.5,te=.5;switch(C){case"right":case"top-right":case"bottom-right":H=1;break;case"left":case"top-left":case"bottom-left":H=0}switch(C){case"bottom":case"bottom-right":case"bottom-left":te=1;break;case"top":case"top-right":case"top-left":te=0}return{horizontalAlign:H,verticalAlign:te}}function k_(C,H,te,le,ce){if(!(H||te||le||ce))return;const he=C.length-1,ue=C[he],de=(ue.x+ue.metrics.advance*ue.scale)*H;for(let H=0;H<=he;H++)C[H].x-=de,C[H].y+=te+le+ce}function O_(C,H,te,le){const{horizontalAlign:ce,verticalAlign:he}=L_(le),ue=te[0]-C.displaySize[0]*ce,de=te[1]-C.displaySize[1]*he;return{imagePrimary:C,imageSecondary:H,top:de,bottom:de+C.displaySize[1],left:ue,right:ue+C.displaySize[0]}}function B_(C,H,te,le,ce,he){const ue=C.imagePrimary;let de;if(ue.content){const C=ue.content,H=ue.pixelRatio||1;de=[C[0]/H,C[1]/H,ue.displaySize[0]-C[2]/H,ue.displaySize[1]-C[3]/H]}const _e=H.left*he,ye=H.right*he;let ve,Me,Se,Ae;"width"===te||"both"===te?(Ae=ce[0]+_e-le[3],Me=ce[0]+ye+le[1]):(Ae=ce[0]+(_e+ye-ue.displaySize[0])/2,Me=Ae+ue.displaySize[0]);const Ce=H.top*he,Oe=H.bottom*he;return"height"===te||"both"===te?(ve=ce[1]+Ce-le[0],Se=ce[1]+Oe+le[2]):(ve=ce[1]+(Ce+Oe-ue.displaySize[1])/2,Se=ve+ue.displaySize[1]),{imagePrimary:ue,imageSecondary:void 0,top:ve,right:Me,bottom:Se,left:Ae,collisionPadding:de}}class F_ extends Ne{constructor(C,H,te,le,ce){super(C,H),this.angle=le,this.z=te,void 0!==ce&&(this.segment=ce)}clone(){return new F_(this.x,this.y,this.z,this.angle,this.segment)}}function N_(C,H,te,le,ce){if(void 0===H.segment)return!0;let he=H,ue=H.segment+1,de=0;for(;de>-te/2;){if(ue--,ue<0)return!1;de-=C[ue].dist(he),he=C[ue]}de+=C[ue].dist(C[ue+1]),ue++;const _e=[];let ye=0;for(;de<te/2;){const H=C[ue],te=C[ue+1];if(!te)return!1;let he=C[ue-1].angleTo(H)-H.angleTo(te);for(he=Math.abs((he+3*Math.PI)%(2*Math.PI)-Math.PI),_e.push({distance:de,angleDelta:he}),ye+=he;de-_e[0].distance>le;)ye-=_e.shift().angleDelta;if(ye>ce)return!1;ue++,de+=H.dist(te)}return!0}function U_(C){let H=0;for(let te=0;te<C.length-1;te++)H+=C[te].dist(C[te+1]);return H}function V_(C,H,te){return C?.6*H*te:0}function j_(C,H){return Math.max(C?C.right-C.left:0,H?H.right-H.left:0)}function G_(C,H,te,le,ce,he){const ue=V_(te,ce,he),de=j_(te,le)*he;let _e=0;const ye=U_(C)/2;for(let te=0;te<C.length-1;te++){const le=C[te],ce=C[te+1],he=le.dist(ce);if(_e+he>ye){const ve=(ye-_e)/he,Me=Wr(le.x,ce.x,ve),Se=Wr(le.y,ce.y,ve),Ae=new F_(Me,Se,0,ce.angleTo(le),te);return!ue||N_(C,Ae,de,ue,H)?Ae:void 0}_e+=he}}function q_(C,H,te,le,ce,he,ue,de,_e){const ye=V_(le,he,ue),ve=j_(le,ce),Me=ve*ue,Se=0===C[0].x||C[0].x===_e||0===C[0].y||C[0].y===_e;return H-Me<H/4&&(H=Me+H/4),Z_(C,Se?H/2*de%H:(ve/2+2*he)*ue*de%H,H,ye,te,Me,Se,!1,_e)}function Z_(C,H,te,le,ce,he,ue,de,_e){const ye=he/2,ve=U_(C);let Me=0,Se=H-te,Ae=[];for(let H=0;H<C.length-1;H++){const ue=C[H],de=C[H+1],Ce=ue.dist(de),Oe=de.angleTo(ue);for(;Se+te<Me+Ce;){Se+=te;const Ne=(Se-Me)/Ce,je=Wr(ue.x,de.x,Ne),Ge=Wr(ue.y,de.y,Ne);if(je>=0&&je<_e&&Ge>=0&&Ge<_e&&Se-ye>=0&&Se+ye<=ve){const te=new F_(je,Ge,0,Oe,H);le&&!N_(C,te,he,le,ce)||Ae.push(te)}}Me+=Ce}return de||Ae.length||ue||(Ae=Z_(C,Me/2,te,le,ce,he,ue,!0,_e)),Ae}function $_(C,H,te,le,ce){const he=[];for(let ue=0;ue<C.length;ue++){const de=C[ue];let _e;for(let C=0;C<de.length-1;C++){let ue=de[C],ye=de[C+1];ue.x<H&&ye.x<H||(ue.x<H?ue=new Ne(H,ue.y+(H-ue.x)/(ye.x-ue.x)*(ye.y-ue.y))._round():ye.x<H&&(ye=new Ne(H,ue.y+(H-ue.x)/(ye.x-ue.x)*(ye.y-ue.y))._round()),ue.y<te&&ye.y<te||(ue.y<te?ue=new Ne(ue.x+(te-ue.y)/(ye.y-ue.y)*(ye.x-ue.x),te)._round():ye.y<te&&(ye=new Ne(ue.x+(te-ue.y)/(ye.y-ue.y)*(ye.x-ue.x),te)._round()),ue.x>=le&&ye.x>=le||(ue.x>=le?ue=new Ne(le,ue.y+(le-ue.x)/(ye.x-ue.x)*(ye.y-ue.y))._round():ye.x>=le&&(ye=new Ne(le,ue.y+(le-ue.x)/(ye.x-ue.x)*(ye.y-ue.y))._round()),ue.y>=ce&&ye.y>=ce||(ue.y>=ce?ue=new Ne(ue.x+(ce-ue.y)/(ye.y-ue.y)*(ye.x-ue.x),ce)._round():ye.y>=ce&&(ye=new Ne(ue.x+(ce-ue.y)/(ye.y-ue.y)*(ye.x-ue.x),ce)._round()),_e&&ue.equals(_e[_e.length-1])||(_e=[ue],he.push(_e)),_e.push(ye)))))}}return he}Is(F_,"Anchor");const cy=1e20;function W_(C,H,te,le,ce,he,ue,de,_e){for(let ye=H;ye<H+le;ye++)X_(C,te*he+ye,he,ce,ue,de,_e);for(let ye=te;ye<te+ce;ye++)X_(C,ye*he+H,1,le,ue,de,_e)}function X_(C,H,te,le,ce,he,ue){he[0]=0,ue[0]=-cy,ue[1]=cy,ce[0]=C[H];for(let de=1,_e=0,ye=0;de<le;de++){ce[de]=C[H+de*te];const le=de*de;do{const C=he[_e];ye=(ce[de]-ce[C]+le-C*C)/(de-C)/2}while(ye<=ue[_e]&&--_e>-1);_e++,he[_e]=de,ue[_e]=ye,ue[_e+1]=cy}for(let de=0,_e=0;de<le;de++){for(;ue[_e+1]<de;)_e++;const le=he[_e],ye=de-le;C[H+de*te]=ce[le]+ye*ye}}const hy=2;class K_{constructor(C,H,te){this.requestManager=C,this.localGlyphMode=H,this.localFontFamily=te,this.urls={},this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(C,H){this.urls[H]=C}getGlyphs(C,H,te){const le=[],ce=this.urls[H]||ue.GLYPHS_URL;for(const H in C)for(const te of C[H])le.push({stack:H,id:te});R(le,(({stack:C,id:H},te)=>{let le=this.entries[C];le||(le=this.entries[C]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let he=le.glyphs[H];if(void 0!==he)return void te(null,{stack:C,id:H,glyph:he});if(he=this._tinySDF(le,C,H),he)return le.glyphs[H]=he,void te(null,{stack:C,id:H,glyph:he});const ue=Math.floor(H/256);if(256*ue>65535)return void te(new Error("glyphs > 65535 not supported"));if(le.ranges[ue])return void te(null,{stack:C,id:H,glyph:he});let de=le.requests[ue];de||(de=le.requests[ue]=[],K_.loadGlyphRange(C,ue,ce,this.requestManager,((C,H)=>{if(H){le.ascender=H.ascender,le.descender=H.descender;for(const C in H.glyphs)this._doesCharSupportLocalGlyph(+C)||(le.glyphs[+C]=H.glyphs[+C]);le.ranges[ue]=!0}for(const te of de)te(C,H);delete le.requests[ue]}))),de.push(((le,ce)=>{le?te(le):ce&&te(null,{stack:C,id:H,glyph:ce.glyphs[H]||null})}))}),((C,H)=>{if(C)te(C);else if(H){const C={};for(const{stack:te,id:le,glyph:ce}of H)void 0===C[te]&&(C[te]={}),void 0===C[te].glyphs&&(C[te].glyphs={}),C[te].glyphs[le]=ce&&{id:ce.id,bitmap:ce.bitmap.clone(),metrics:ce.metrics},C[te].ascender=this.entries[te].ascender,C[te].descender=this.entries[te].descender;te(null,C)}}))}_doesCharSupportLocalGlyph(C){return 0!==this.localGlyphMode&&(2===this.localGlyphMode?!!this.localFontFamily:!!this.localFontFamily&&(wl["CJK Unified Ideographs"](C)||wl["Hangul Syllables"](C)||wl.Hiragana(C)||wl.Katakana(C)||wl["CJK Symbols and Punctuation"](C)||wl["CJK Unified Ideographs Extension A"](C)||wl["CJK Unified Ideographs Extension B"](C)))}_tinySDF(C,H,te){const le=this.localFontFamily;if(!le||!this._doesCharSupportLocalGlyph(te))return;let ce=C.tinySDF;if(!ce){let te="400";/bold/i.test(H)?te="900":/medium/i.test(H)?te="500":/light/i.test(H)&&(te="200"),ce=C.tinySDF=new K_.TinySDF({fontFamily:le,fontWeight:te,fontSize:24*hy,buffer:3*hy,radius:8*hy}),ce.fontWeight=te}if(this.localGlyphs[ce.fontWeight][te])return this.localGlyphs[ce.fontWeight][te];const he=String.fromCodePoint(te),{data:ue,width:de,height:_e,glyphWidth:ye,glyphHeight:ve,glyphLeft:Me,glyphTop:Se,glyphAdvance:Ae}=ce.draw(he);return this.localGlyphs[ce.fontWeight][te]={id:te,bitmap:new Zp({width:de,height:_e},ue),metrics:{width:ye/hy,height:ve/hy,left:Me/hy,top:Se/hy-27,advance:Ae/hy,localGlyph:!0}}}}K_.loadGlyphRange=function(C,H,te,le,ce){const he=256*H,ue=he+255,de=le.transformRequest(le.normalizeGlyphsURL(te).replace("{fontstack}",C).replace("{range}",`${he}-${ue}`),ot.Glyphs);Te(de,((C,H)=>{if(C)ce(C);else if(H){const C={},te=function(C){return new S_(C).readFields(f_,{})}(H);for(const H of te.glyphs)C[H.id]=H;ce(null,{glyphs:C,ascender:te.ascender,descender:te.descender})}}))},K_.TinySDF=class{constructor({fontSize:C=24,buffer:H=3,radius:te=8,cutoff:le=.25,fontFamily:ce="sans-serif",fontWeight:he="normal",fontStyle:ue="normal"}={}){this.buffer=H,this.cutoff=le,this.radius=te;const de=this.size=C+4*H,_e=this._createCanvas(de),ye=this.ctx=_e.getContext("2d",{willReadFrequently:!0});ye.font=`${ue} ${he} ${C}px ${ce}`,ye.textBaseline="alphabetic",ye.textAlign="left",ye.fillStyle="black",this.gridOuter=new Float64Array(de*de),this.gridInner=new Float64Array(de*de),this.f=new Float64Array(de),this.z=new Float64Array(de+1),this.v=new Uint16Array(de)}_createCanvas(C){const H=document.createElement("canvas");return H.width=H.height=C,H}draw(C){const{width:H,actualBoundingBoxAscent:te,actualBoundingBoxDescent:le,actualBoundingBoxLeft:ce,actualBoundingBoxRight:he}=this.ctx.measureText(C),ue=Math.ceil(te),de=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(he-ce))),_e=Math.min(this.size-this.buffer,ue+Math.ceil(le)),ye=de+2*this.buffer,ve=_e+2*this.buffer,Me=Math.max(ye*ve,0),Se=new Uint8ClampedArray(Me),Ae={data:Se,width:ye,height:ve,glyphWidth:de,glyphHeight:_e,glyphTop:ue,glyphLeft:0,glyphAdvance:H};if(0===de||0===_e)return Ae;const{ctx:Ce,buffer:Oe,gridInner:Ne,gridOuter:je}=this;Ce.clearRect(Oe,Oe,de,_e),Ce.fillText(C,Oe,Oe+ue);const Ge=Ce.getImageData(Oe,Oe,de,_e);je.fill(cy,0,Me),Ne.fill(0,0,Me);for(let C=0;C<_e;C++)for(let H=0;H<de;H++){const te=Ge.data[4*(C*de+H)+3]/255;if(0===te)continue;const le=(C+Oe)*ye+H+Oe;if(1===te)je[le]=0,Ne[le]=cy;else{const C=.5-te;je[le]=C>0?C*C:0,Ne[le]=C<0?C*C:0}}W_(je,0,0,ye,ve,ye,this.f,this.v,this.z),W_(Ne,Oe,Oe,de,_e,ye,this.f,this.v,this.z);for(let C=0;C<Me;C++){const H=Math.sqrt(je[C])-Math.sqrt(Ne[C]);Se[C]=Math.round(255-255*(H/this.radius+this.cutoff))}return Ae}};const uy=Gg;function Q_(C,H,te,le){const ce=[],he=C.imagePrimary,ue=he.pixelRatio,de=he.paddedRect.w-2*uy,_e=he.paddedRect.h-2*uy,ye=C.right-C.left,ve=C.bottom-C.top,Me=he.stretchX||[[0,de]],Se=he.stretchY||[[0,_e]],p=(C,H)=>C+H[1]-H[0],Ae=Me.reduce(p,0),Ce=Se.reduce(p,0),Oe=de-Ae,je=_e-Ce;let Ge=0,Ze=Ae,qe=0,$e=Ce,We=0,He=Oe,Xe=0,Ye=je;if(he.content&&le){const C=he.content;Ge=eg(Me,0,C[0]),qe=eg(Se,0,C[1]),Ze=eg(Me,C[0],C[2]),$e=eg(Se,C[1],C[3]),We=C[0]-Ge,Xe=C[1]-qe,He=C[2]-C[0]-Ze,Ye=C[3]-C[1]-$e}const S=(le,ce,de,_e)=>{const Me=ig(le.stretch-Ge,Ze,ye,C.left),Se=rg(le.fixed-We,He,le.stretch,Ae),Oe=ig(ce.stretch-qe,$e,ve,C.top),je=rg(ce.fixed-Xe,Ye,ce.stretch,Ce),Je=ig(de.stretch-Ge,Ze,ye,C.left),Qe=rg(de.fixed-We,He,de.stretch,Ae),tt=ig(_e.stretch-qe,$e,ve,C.top),rt=rg(_e.fixed-Xe,Ye,_e.stretch,Ce),ot=new Ne(Me,Oe),st=new Ne(Je,Oe),at=new Ne(Je,tt),lt=new Ne(Me,tt),ct=new Ne(Se/ue,je/ue),ht=new Ne(Qe/ue,rt/ue),pt=H*Math.PI/180;if(pt){const C=Math.sin(pt),H=Math.cos(pt),te=[H,-C,C,H];ot._matMult(te),st._matMult(te),lt._matMult(te),at._matMult(te)}const ft=le.stretch+le.fixed,mt=de.stretch+de.fixed,Ct=ce.stretch+ce.fixed,Ot=_e.stretch+_e.fixed,Ft=C.imageSecondary;return{tl:ot,tr:st,bl:lt,br:at,texPrimary:{x:he.paddedRect.x+uy+ft,y:he.paddedRect.y+uy+Ct,w:mt-ft,h:Ot-Ct},texSecondary:Ft?{x:Ft.paddedRect.x+uy+ft,y:Ft.paddedRect.y+uy+Ct,w:mt-ft,h:Ot-Ct}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:ct,pixelOffsetBR:ht,minFontScaleX:He/ue/ye,minFontScaleY:Ye/ue/ve,isSDF:te}};if(le&&(he.stretchX||he.stretchY)){const C=tg(Me,Oe,Ae),H=tg(Se,je,Ce);for(let te=0;te<C.length-1;te++){const le=C[te],he=C[te+1];for(let C=0;C<H.length-1;C++)ce.push(S(le,H[C],he,H[C+1]))}}else ce.push(S({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:de+1},{fixed:0,stretch:_e+1}));return ce}function eg(C,H,te){let le=0;for(const ce of C)le+=Math.max(H,Math.min(te,ce[1]))-Math.max(H,Math.min(te,ce[0]));return le}function tg(C,H,te){const le=[{fixed:-uy,stretch:0}];for(const[H,te]of C){const C=le[le.length-1];le.push({fixed:H-C.stretch,stretch:C.stretch}),le.push({fixed:H-C.stretch,stretch:C.stretch+(te-H)})}return le.push({fixed:H+uy,stretch:te}),le}function ig(C,H,te,le){return C/H*te+le}function rg(C,H,te,le){return C-H*te/le}function ng(C,H,te,le){const ce=H+C.positionedLines[le].lineOffset;return 0===le?te+ce/2:te+(ce+(H+C.positionedLines[le-1].lineOffset))/2}function og(C,H=1,te=!1){let le=1/0,ce=1/0,he=-1/0,ue=-1/0;const de=C[0];for(let C=0;C<de.length;C++){const H=de[C];(!C||H.x<le)&&(le=H.x),(!C||H.y<ce)&&(ce=H.y),(!C||H.x>he)&&(he=H.x),(!C||H.y>ue)&&(ue=H.y)}const _e=Math.min(he-le,ue-ce);let ye=_e/2;const ve=new vn([],sg);if(0===_e)return new Ne(le,ce);for(let H=le;H<he;H+=_e)for(let te=ce;te<ue;te+=_e)ve.push(new ag(H+ye,te+ye,ye,C));let Me=function(C){let H=0,te=0,le=0;const ce=C[0];for(let C=0,he=ce.length,ue=he-1;C<he;ue=C++){const he=ce[C],de=ce[ue],_e=he.x*de.y-de.x*he.y;te+=(he.x+de.x)*_e,le+=(he.y+de.y)*_e,H+=3*_e}return new ag(te/H,le/H,0,C)}(C),Se=ve.length;for(;ve.length;){const le=ve.pop();(le.d>Me.d||!Me.d)&&(Me=le,te&&console.log("found best %d after %d probes",Math.round(1e4*le.d)/1e4,Se)),le.max-Me.d<=H||(ye=le.h/2,ve.push(new ag(le.p.x-ye,le.p.y-ye,ye,C)),ve.push(new ag(le.p.x+ye,le.p.y-ye,ye,C)),ve.push(new ag(le.p.x-ye,le.p.y+ye,ye,C)),ve.push(new ag(le.p.x+ye,le.p.y+ye,ye,C)),Se+=4)}return te&&(console.log(`num probes: ${Se}`),console.log(`best distance: ${Me.d}`)),Me.p}function sg(C,H){return H.max-C.max}class ag{constructor(C,H,te,le){this.p=new Ne(C,H),this.h=te,this.d=function(C,H){let te=!1,le=1/0;for(let ce=0;ce<H.length;ce++){const he=H[ce];for(let H=0,ce=he.length,ue=ce-1;H<ce;ue=H++){const ce=he[H],de=he[ue];ce.y>C.y!=de.y>C.y&&C.x<(de.x-ce.x)*(C.y-ce.y)/(de.y-ce.y)+ce.x&&(te=!te),le=Math.min(le,vp(C,ce,de))}}return(te?1:-1)*Math.sqrt(le)}(this.p,le),this.max=this.d+this.h*Math.SQRT2}}const dy=7,py=Number.POSITIVE_INFINITY,fy=Math.sqrt(2);function ug(C,[H,te]){let le=0,ce=0;if(te===py){H<0&&(H=0);const te=H/fy;switch(C){case"top-right":case"top-left":ce=te-dy;break;case"bottom-right":case"bottom-left":ce=-te+dy;break;case"bottom":ce=-H+dy;break;case"top":ce=H-dy}switch(C){case"top-right":case"bottom-right":le=-te;break;case"top-left":case"bottom-left":le=te;break;case"left":le=H;break;case"right":le=-H}}else{switch(H=Math.abs(H),te=Math.abs(te),C){case"top-right":case"top-left":case"top":ce=te-dy;break;case"bottom-right":case"bottom-left":case"bottom":ce=-te+dy}switch(C){case"top-right":case"bottom-right":case"right":le=-H;break;case"top-left":case"bottom-left":case"left":le=H}}return[le,ce]}function dg(C,H,te,le,ce,he,ue,de,_e,ye,ve){C.createArrays(),C.tilePixelRatio=wn/(512*C.overscaling),C.compareText={},C.iconsNeedLinear=!1;const Me=C.layers[0].layout,Se=C.layers[0]._unevaluatedLayout._values,Ae={};if("composite"===C.textSizeData.kind){const{minZoom:H,maxZoom:te}=C.textSizeData;Ae.compositeTextSizes=[Se["text-size"].possiblyEvaluate(new ea(H),de),Se["text-size"].possiblyEvaluate(new ea(te),de)]}if("composite"===C.iconSizeData.kind){const{minZoom:H,maxZoom:te}=C.iconSizeData;Ae.compositeIconSizes=[Se["icon-size"].possiblyEvaluate(new ea(H),de),Se["icon-size"].possiblyEvaluate(new ea(te),de)]}Ae.layoutTextSize=Se["text-size"].possiblyEvaluate(new ea(_e+1),de),Ae.layoutIconSize=Se["icon-size"].possiblyEvaluate(new ea(_e+1),de),Ae.textMaxSize=Se["text-size"].possiblyEvaluate(new ea(18),de);const Ce="map"===Me.get("text-rotation-alignment")&&"point"!==Me.get("symbol-placement"),Oe=Me.get("text-size");let Ne=!1;for(const H of C.features)if(H.icon&&H.icon.nameSecondary){Ne=!0;break}for(const he of C.features){const _e=Me.get("text-font").evaluate(he,{},de).join(","),Se=Oe.evaluate(he,{},de),je=Ae.layoutTextSize.evaluate(he,{},de),Ge=(Ae.layoutIconSize.evaluate(he,{},de),{horizontal:{},vertical:void 0}),Ze=he.text;let qe,$e=[0,0];if(Ze){const le=Ze.toString(),ue=Me.get("text-letter-spacing").evaluate(he,{},de)*Dg,ye=Me.get("text-line-height").evaluate(he,{},de)*Dg,ve=ks(le)?ue:0,Ae=Me.get("text-anchor").evaluate(he,{},de),Oe=Me.get("text-variable-anchor");if(!Oe){const C=Me.get("text-radial-offset").evaluate(he,{},de);$e=C?ug(Ae,[C*Dg,py]):Me.get("text-offset").evaluate(he,{},de).map((C=>C*Dg))}let Ne=Ce?"center":Me.get("text-justify").evaluate(he,{},de);const qe="point"===Me.get("symbol-placement"),We=qe?Me.get("text-max-width").evaluate(he,{},de)*Dg:1/0,T=he=>{C.allowVerticalPlacement&&Ls(le)&&(Ge.vertical=A_(Ze,H,te,ce,_e,We,ye,Ae,he,ve,$e,Wg.vertical,!0,je,Se))};if(!Ce&&Oe){const C="auto"===Ne?Oe.map((C=>pg(C))):[Ne];let le=!1;for(let he=0;he<C.length;he++){const ue=C[he];if(!Ge.horizontal[ue])if(le)Ge.horizontal[ue]=Ge.horizontal[0];else{const C=A_(Ze,H,te,ce,_e,We,ye,"center",ue,ve,$e,Wg.horizontal,!1,je,Se);C&&(Ge.horizontal[ue]=C,le=1===C.positionedLines.length)}}T("left")}else{if("auto"===Ne&&(Ne=pg(Ae)),qe||Me.get("text-writing-mode").indexOf("horizontal")>=0||!Ls(le)){const C=A_(Ze,H,te,ce,_e,We,ye,Ae,Ne,ve,$e,Wg.horizontal,!1,je,Se);C&&(Ge.horizontal[Ne]=C)}T(qe?"left":Ne)}}let We=!1;if(he.icon&&he.icon.namePrimary){const H=le[he.icon.namePrimary];H&&(qe=O_(ce[he.icon.namePrimary],he.icon.nameSecondary?ce[he.icon.nameSecondary]:void 0,Me.get("icon-offset").evaluate(he,{},de),Me.get("icon-anchor").evaluate(he,{},de)),We=H.sdf,void 0===C.sdfIcons?C.sdfIcons=H.sdf:C.sdfIcons!==H.sdf&&W("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(H.pixelRatio!==C.pixelRatio||0!==Me.get("icon-rotate").constantOr(1))&&(C.iconsNeedLinear=!0))}const He=yg(Ge.horizontal)||Ge.vertical;C.iconsInText||(C.iconsInText=!!He&&He.iconsInText),(He||qe)&&fg(C,he,Ge,qe,le,Ae,je,0,$e,We,ue,de,ye,ve,Ne)}he&&C.generateCollisionDebugBuffers(_e,C.collisionBoxArray)}function pg(C){switch(C){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function fg(C,H,te,le,ce,he,ue,de,_e,ye,ve,Me,Se,Ae,Ce){let Oe=he.textMaxSize.evaluate(H,{},Me);void 0===Oe&&(Oe=ue);const Ne=C.layers[0].layout,je=Ne.get("icon-offset").evaluate(H,{},Me),Ge=yg(te.horizontal)||te.vertical,Ze="globe"===Se.name,qe=Dg,$e=ue/qe,We=C.tilePixelRatio*Oe/qe,He=(st=C.overscaling,C.zoom>18&&st>2&&(st>>=1),Math.max(wn/(512*st),1)*Ne.get("symbol-spacing")),Xe=Ne.get("text-padding")*C.tilePixelRatio,Ye=Ne.get("icon-padding")*C.tilePixelRatio,Je=w(Ne.get("text-max-angle")),Qe="map"===Ne.get("text-rotation-alignment")&&"point"!==Ne.get("symbol-placement"),tt="map"===Ne.get("icon-rotation-alignment")&&"point"!==Ne.get("symbol-placement"),rt=Ne.get("symbol-placement"),ot=He/2;var st;const at=Ne.get("icon-text-fit").evaluate(H,{},Me),lt=Ne.get("icon-text-fit-padding").evaluate(H,{},Me),ct="none"!==at;let ht;!1===C.hasAnyIconTextFit&&ct&&(C.hasAnyIconTextFit=!0),le&&ct&&(C.allowVerticalPlacement&&te.vertical&&(ht=B_(le,te.vertical,at,lt,je,$e)),Ge&&(le=B_(le,Ge,at,lt,je,$e)));const B=(ue,de,Oe)=>{if(de.x<0||de.x>=wn||de.y<0||de.y>=wn)return;let Ne=null;if(Ze){const{x:C,y:H,z:te}=Se.projectTilePoint(de.x,de.y,Oe);Ne={anchor:new F_(C,H,te,0,void 0),up:Se.upVector(Oe,de.x,de.y)}}!function(C,H,te,le,ce,he,ue,de,_e,ye,ve,Me,Se,Ae,Ce,Oe,Ne,je,Ge,Ze,qe,$e,We,He,Xe,Ye,Je){const Qe=C.addToLineVertexArray(H,le);let tt,rt,ot,st,at,lt,ct,ht=0,pt=0,ft=0,mt=0,Ct=-1,Ot=-1;const Ft={};let Nt=kc("");const Ut=te?te.anchor:H,Vt="none"!==_e.layout.get("icon-text-fit").evaluate(qe,{},Xe);let jt=0,Gt=0;if(void 0===_e._unevaluatedLayout.getValue("text-radial-offset")?[jt,Gt]=_e.layout.get("text-offset").evaluate(qe,{},Xe).map((C=>C*Dg)):(jt=_e.layout.get("text-radial-offset").evaluate(qe,{},Xe)*Dg,Gt=py),C.allowVerticalPlacement&&ce.vertical){const C=ce.vertical;if(Ce)lt=vg(C),de&&(ct=vg(de));else{const te=_e.layout.get("text-rotate").evaluate(qe,{},Xe)+90;ot=xg(ye,Ut,H,ve,Me,Se,C,Ae,te,Oe),de&&(st=xg(ye,Ut,H,ve,Me,Se,de,je,te))}}if(he){const le=_e.layout.get("icon-rotate").evaluate(qe,{},Xe),ce=Q_(he,le,We,Vt),ue=de?Q_(de,le,We,Vt):void 0;rt=xg(ye,Ut,H,ve,Me,Se,he,je,le),ht=4*ce.length;const Ae=C.iconSizeData;let Ce=null;"source"===Ae.kind?(Ce=[Pg*_e.layout.get("icon-size").evaluate(qe,{},Xe)],Ce[0]>xy&&W(`${C.layerIds[0]}: Value for "icon-size" is >= ${my}. Reduce your "icon-size".`)):"composite"===Ae.kind&&(Ce=[Pg*$e.compositeIconSizes[0].evaluate(qe,{},Xe),Pg*$e.compositeIconSizes[1].evaluate(qe,{},Xe)],(Ce[0]>xy||Ce[1]>xy)&&W(`${C.layerIds[0]}: Value for "icon-size" is >= ${my}. Reduce your "icon-size".`)),C.addSymbols(C.icon,ce,Ce,Ze,Ge,qe,!1,te,H,Qe.lineStartIndex,Qe.lineLength,-1,He,Xe,Ye,Je),Ct=C.icon.placedSymbolArray.length-1,ue&&(pt=4*ue.length,C.addSymbols(C.icon,ue,Ce,Ze,Ge,qe,Wg.vertical,te,H,Qe.lineStartIndex,Qe.lineLength,-1,He,Xe,Ye,Je),Ot=C.icon.placedSymbolArray.length-1)}for(const le in ce.horizontal){const he=ce.horizontal[le];tt||(Nt=kc(he.text),Ce?at=vg(he):tt=xg(ye,Ut,H,ve,Me,Se,he,Ae,_e.layout.get("text-rotate").evaluate(qe,{},Xe),Oe));const de=1===he.positionedLines.length;if(ft+=gg(C,te,H,he,ue,_e,Ce,qe,Oe,Qe,ce.vertical?Wg.horizontal:Wg.horizontalOnly,de?Object.keys(ce.horizontal):[le],Ft,Ct,$e,He,Xe,Ye),de)break}ce.vertical&&(mt+=gg(C,te,H,ce.vertical,ue,_e,Ce,qe,Oe,Qe,Wg.vertical,["vertical"],Ft,Ot,$e,He,Xe,Ye));let Zt=-1;const X=(C,H)=>C?Math.max(C,H):H;Zt=X(at,Zt),Zt=X(lt,Zt),Zt=X(ct,Zt);const qt=Zt>-1?1:0;C.glyphOffsetArray.length>=zx.MAX_GLYPHS&&W("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),void 0!==qe.sortKey&&C.addToSortKeyRanges(C.symbolInstances.length,qe.sortKey),C.symbolInstances.emplaceBack(H.x,H.y,Ut.x,Ut.y,Ut.z,Ft.right>=0?Ft.right:-1,Ft.center>=0?Ft.center:-1,Ft.left>=0?Ft.left:-1,Ft.vertical>=0?Ft.vertical:-1,Ct,Ot,Nt,void 0!==tt?tt:C.collisionBoxArray.length,void 0!==tt?tt+1:C.collisionBoxArray.length,void 0!==ot?ot:C.collisionBoxArray.length,void 0!==ot?ot+1:C.collisionBoxArray.length,void 0!==rt?rt:C.collisionBoxArray.length,void 0!==rt?rt+1:C.collisionBoxArray.length,st||C.collisionBoxArray.length,st?st+1:C.collisionBoxArray.length,ve,ft,mt,ht,pt,qt,0,jt,Gt,Zt,0,Vt?1:0)}(C,de,Ne,ue,te,le,ce,ht,C.layers[0],C.collisionBoxArray,H.index,H.sourceLayerIndex,C.index,Xe,Qe,_e,0,Ye,tt,je,H,he,ye,ve,Me,Ae,Ce)};if("line"===rt)for(const ce of $_(H.geometry,0,0,wn,wn)){const H=q_(ce,He,Je,te.vertical||Ge,le,qe,We,C.overscaling,wn);for(const te of H)Ge&&bg(C,Ge.text,ot,te)||B(ce,te,Me)}else if("line-center"===rt){for(const C of H.geometry)if(C.length>1){const H=G_(C,Je,te.vertical||Ge,le,qe,We);H&&B(C,H,Me)}}else if("Polygon"===H.type)for(const C of zf(H.geometry,0)){const H=og(C,16);B(C[0],new F_(H.x,H.y,0,0,void 0),Me)}else if("LineString"===H.type)for(const C of H.geometry)B(C,new F_(C[0].x,C[0].y,0,0,void 0),Me);else if("Point"===H.type)for(const C of H.geometry)for(const H of C)B([H],new F_(H.x,H.y,0,0,void 0),Me)}const my=255,xy=my*Pg;function gg(C,H,te,le,ce,he,ue,de,_e,ye,ve,Me,Se,Ae,Ce,Oe,je,Ge){const Ze=function(C,H,te,le,ce,he,ue,de){const _e=[];if(0===H.positionedLines.length)return _e;const ye=le.layout.get("text-rotate").evaluate(he,{})*Math.PI/180,ve=function(C){const H=C[0],te=C[1],le=H*te;return le>0?[H,-te]:le<0?[-H,te]:0===H?[te,H]:[te,-H]}(te);let Me=Math.abs(H.top-H.bottom);for(const C of H.positionedLines)Me-=C.lineOffset;const Se=H.positionedLines.length,Ae=Me/Se;let Ce=H.top-te[1];for(let C=0;C<Se;++C){const le=H.positionedLines[C];Ce=ng(H,Ae,Ce,C);for(const C of le.positionedGlyphs){if(!C.rect)continue;const le=C.rect||{};let he=Vg+1,Me=!0,Se=1,Ae=0;if(C.imageName){const H=ue[C.imageName];if(!H)continue;if(H.sdf){W("SDF images are not supported in formatted text and will be ignored.");continue}Me=!1,Se=H.pixelRatio,he=Gg/Se}const Oe=(ce||de)&&C.vertical,je=C.metrics.advance*C.scale/2,Ge=C.metrics,Ze=C.rect;if(null===Ze)continue;de&&H.verticalizable&&(Ae=C.imageName?je-C.metrics.width*C.scale/2:0);const qe=ce?[C.x+je,C.y]:[0,0];let $e=[0,0],We=[0,0],He=!1;ce||(Oe?(We=[C.x+je+ve[0],C.y+ve[1]-Ae],He=!0):$e=[C.x+je+te[0],C.y+te[1]-Ae]);const Xe=Ze.w*C.scale/(Se*(C.localGlyph?hy:1)),Ye=Ze.h*C.scale/(Se*(C.localGlyph?hy:1));let Je,Qe,tt,rt;if(Oe){const H=C.y-Ce,te=new Ne(-je,je-H),le=-Math.PI/2,ce=new Ne(...We);Je=new Ne(-je+$e[0],$e[1]),Je._rotateAround(le,te)._add(ce),Je.x+=-H+je,Je.y-=(Ge.left-he)*C.scale;const ue=C.imageName?Ge.advance*C.scale:Dg*C.scale,de=String.fromCodePoint(C.glyph);u_(de)?Je.x+=(1-he)*C.scale:d_(de)?Je.x+=ue-Ge.height*C.scale+(-he-1)*C.scale:Je.x+=C.imageName||Ge.width+2*he===Ze.w&&Ge.height+2*he===Ze.h?(ue-Ye)/2:(ue-(Ge.height+2*he)*C.scale)/2,Qe=new Ne(Je.x,Je.y-Xe),tt=new Ne(Je.x+Ye,Je.y),rt=new Ne(Je.x+Ye,Je.y-Xe)}else{const H=(Ge.left-he)*C.scale-je+$e[0],te=(-Ge.top-he)*C.scale+$e[1],le=H+Xe,ce=te+Ye;Je=new Ne(H,te),Qe=new Ne(le,te),tt=new Ne(H,ce),rt=new Ne(le,ce)}if(ye){let C;C=ce?new Ne(0,0):He?new Ne(ve[0],ve[1]):new Ne(te[0],te[1]),Je._rotateAround(ye,C),Qe._rotateAround(ye,C),tt._rotateAround(ye,C),rt._rotateAround(ye,C)}const ot=new Ne(0,0),st=new Ne(0,0);_e.push({tl:Je,tr:Qe,bl:tt,br:rt,texPrimary:le,texSecondary:void 0,writingMode:H.writingMode,glyphOffset:qe,sectionIndex:C.sectionIndex,isSDF:Me,pixelOffsetTL:ot,pixelOffsetBR:st,minFontScaleX:0,minFontScaleY:0})}}return _e}(0,le,_e,he,ue,de,ce,C.allowVerticalPlacement),qe=C.textSizeData;let $e=null;"source"===qe.kind?($e=[Pg*he.layout.get("text-size").evaluate(de,{},je)],$e[0]>xy&&W(`${C.layerIds[0]}: Value for "text-size" is >= ${my}. Reduce your "text-size".`)):"composite"===qe.kind&&($e=[Pg*Ce.compositeTextSizes[0].evaluate(de,{},je),Pg*Ce.compositeTextSizes[1].evaluate(de,{},je)],($e[0]>xy||$e[1]>xy)&&W(`${C.layerIds[0]}: Value for "text-size" is >= ${my}. Reduce your "text-size".`)),C.addSymbols(C.text,Ze,$e,_e,ue,de,ve,H,te,ye.lineStartIndex,ye.lineLength,Ae,Oe,je,Ge,!1);for(const H of Me)Se[H]=C.text.placedSymbolArray.length-1;return 4*Ze.length}function yg(C){for(const H in C)return C[H];return null}function xg(C,H,te,le,ce,he,ue,de,_e,ye){let ve=ue.top,Me=ue.bottom,Se=ue.left,Ae=ue.right;const Ce=ue.collisionPadding;if(Ce&&(Se-=Ce[0],ve-=Ce[1],Ae+=Ce[2],Me+=Ce[3]),_e){const C=new Ne(Se,ve),H=new Ne(Ae,ve),te=new Ne(Se,Me),le=new Ne(Ae,Me),ce=w(_e);let he=new Ne(0,0);ye&&(he=new Ne(ye[0],ye[1])),C._rotateAround(ce,he),H._rotateAround(ce,he),te._rotateAround(ce,he),le._rotateAround(ce,he),Se=Math.min(C.x,H.x,te.x,le.x),Ae=Math.max(C.x,H.x,te.x,le.x),ve=Math.min(C.y,H.y,te.y,le.y),Me=Math.max(C.y,H.y,te.y,le.y)}return C.emplaceBack(H.x,H.y,H.z,te.x,te.y,Se,ve,Ae,Me,de,le,ce,he),C.length-1}function vg(C){C.collisionPadding&&(C.top-=C.collisionPadding[1],C.bottom+=C.collisionPadding[3]);const H=C.bottom-C.top;return H>0?Math.max(10,H):null}function bg(C,H,te,le){const ce=C.compareText;if(H in ce){const C=ce[H];for(let H=C.length-1;H>=0;H--)if(le.dist(C[H])<te)return!0}else ce[H]=[];return ce[H].push(le),!1}function wg(C,H){const te=C.fovAboveCenter,le=C.elevation?C.elevation.getMinElevationBelowMSL()*H:0,ce=(C._camera.position[2]*C.worldSize-le)/Math.cos(C._pitch),he=Math.sin(te)*ce/Math.sin(Math.max(Math.PI/2-C._pitch-te,.01)),ue=Math.sin(C._pitch)*he+ce;return Math.min(1.01*ue,ce*(1/C._horizonShift))}function Tg(C,H){if(!H.isReprojectedInTileSpace)return{scale:1<<C.z,x:C.x,y:C.y,x2:C.x+1,y2:C.y+1,projection:H};const te=Math.pow(2,-C.z),le=C.x*te,ce=(C.x+1)*te,he=C.y*te,ue=(C.y+1)*te,de=$d(le),_e=$d(ce),ye=Hd(he),ve=Hd(ue),Me=H.project(de,ye),Se=H.project(_e,ye),Ae=H.project(_e,ve),Ce=H.project(de,ve);let Oe=Math.min(Me.x,Se.x,Ae.x,Ce.x),Ne=Math.min(Me.y,Se.y,Ae.y,Ce.y),je=Math.max(Me.x,Se.x,Ae.x,Ce.x),Ge=Math.max(Me.y,Se.y,Ae.y,Ce.y);const Ze=te/16;function v(C,te,le,ce,he,ue){const de=(le+he)/2,_e=(ce+ue)/2,ye=H.project($d(de),Hd(_e)),ve=Math.max(0,Oe-ye.x,Ne-ye.y,ye.x-je,ye.y-Ge);Oe=Math.min(Oe,ye.x),je=Math.max(je,ye.x),Ne=Math.min(Ne,ye.y),Ge=Math.max(Ge,ye.y),ve>Ze&&(v(C,ye,le,ce,de,_e),v(ye,te,de,_e,he,ue))}v(Me,Se,le,he,ce,he),v(Se,Ae,ce,he,ce,ue),v(Ae,Ce,ce,ue,le,ue),v(Ce,Me,le,ue,le,he),Oe-=Ze,Ne-=Ze,je+=Ze,Ge+=Ze;const qe=1/Math.max(je-Oe,Ge-Ne);return{scale:qe,x:Oe*qe,y:Ne*qe,x2:je*qe,y2:Ge*qe,projection:H}}function Eg(C,H,te,le,ce,he,ue,de,_e){if("globe"===_e.name)return ud(C,H,new ku(te,le,ce),!1);const ye=Tg({z:te,x:le,y:ce},_e);return new Hu([(he+ye.x/ye.scale)*H,H*(ye.y/ye.scale),ue],[(he+ye.x2/ye.scale)*H,H*(ye.y2/ye.scale),de])}function Mg(C,{x:H,y:te},le=0){return new Ne(((H-le)*C.scale-C.x)*wn,(te*C.scale-C.y)*wn)}function Ag(C,H,te=0){return Ld.fromValues(((H.x-te)*C.scale-C.x)*wn,(H.y*C.scale-C.y)*wn,Wd(H.z,H.y))}const vy=ed.identity(new Float32Array(16));class Ig{constructor(C){this.spec=C,this.name=C.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(C,H){return{x:0,y:0,z:0}}unproject(C,H){return new Of(0,0)}projectTilePoint(C,H,te){return{x:C,y:H,z:0}}locationPoint(C,H,te=!0){return C._coordinatePoint(C.locationCoordinate(H),te)}pixelsPerMeter(C,H){return Zd(1,C)*H}pixelSpaceConversion(C,H,te){return 1}farthestPixelDistance(C){return wg(C,C.pixelsPerMeter)}pointCoordinate(C,H,te,le){const ce=C.horizonLineFromTop(!1),he=new Ne(H,Math.max(ce,te));return C.rayIntersectionCoordinate(C.pointRayIntersection(he,le))}pointCoordinate3D(C,H,te){const le=new Ne(H,te);if(C.elevation)return C.elevation.pointCoordinate(le);{const H=this.pointCoordinate(C,le.x,le.y,0);return[H.x,H.y,H.z]}}isPointAboveHorizon(C,H){if(C.elevation)return!this.pointCoordinate3D(C,H.x,H.y);const te=C.horizonLineFromTop();return H.y<te}createInversionMatrix(C,H){return vy}createTileMatrix(C,H,te){let le,ce,he;const ue=te.canonical,de=ed.identity(new Float64Array(16));if(this.isReprojectedInTileSpace){const _e=Tg(ue,this);le=1,ce=_e.x+te.wrap*_e.scale,he=_e.y,ed.scale(de,de,[le/_e.scale,le/_e.scale,C.pixelsPerMeter/H])}else le=H/C.zoomScale(ue.z),ce=(ue.x+Math.pow(2,ue.z)*te.wrap)*le,he=ue.y*le;return ed.translate(de,de,[ce,he,0]),ed.scale(de,de,[le/wn,le/wn,1]),de}upVector(C,H,te){return[0,0,1]}upVectorScale(C,H,te){return{metersToTile:1}}}class Cg extends Ig{constructor(C){super(C),this.range=[4,7],this.center=C.center||[-96,37.5];const[H,te]=this.parallels=C.parallels||[29.5,45.5],le=Math.sin(w(H));this.n=(le+Math.sin(w(te)))/2,this.c=1+le*(2*this.n-le),this.r0=Math.sqrt(this.c)/this.n}project(C,H){const{n:te,c:le,r0:ce}=this,he=w(C-this.center[0]),ue=w(H),de=Math.sqrt(le-2*te*Math.sin(ue))/te;return{x:de*Math.sin(he*te),y:de*Math.cos(he*te)-ce,z:0}}unproject(C,H){const{n:te,c:le,r0:ce}=this,he=ce+H;let ue=Math.atan2(C,Math.abs(he))*Math.sign(he);he*te<0&&(ue-=Math.PI*Math.sign(C)*Math.sign(he));const de=w(this.center[0])*te;ue=P(ue,-Math.PI-de,Math.PI-de);const _e=z(T(ue/te)+this.center[0],-180,180),ye=Math.asin(z((le-(C*C+he*he)*te*te)/(2*te),-1,1)),ve=z(T(ye),-Uf,Uf);return new Of(_e,ve)}}const by=1.340264,wy=-.081106,Ty=893e-6,Ey=.003796,Sy=Math.sqrt(3)/2;class kg extends Ig{project(C,H){H=H/180*Math.PI,C=C/180*Math.PI;const te=Math.asin(Sy*Math.sin(H)),le=te*te,ce=le*le*le;return{x:.5*(C*Math.cos(te)/(Sy*(by+3*wy*le+ce*(7*Ty+9*Ey*le)))/Math.PI+.5),y:1-.5*(te*(by+wy*le+ce*(Ty+Ey*le))/Math.PI+1),z:0}}unproject(C,H){C=(2*C-.5)*Math.PI;let te=H=(2*(1-H)-1)*Math.PI,le=te*te,ce=le*le*le;for(let C,he,ue,de=0;de<12&&(he=te*(by+wy*le+ce*(Ty+Ey*le))-H,ue=by+3*wy*le+ce*(7*Ty+9*Ey*le),C=he/ue,te=z(te-C,-Math.PI/3,Math.PI/3),le=te*te,ce=le*le*le,!(Math.abs(C)<1e-12));++de);const he=Sy*C*(by+3*wy*le+ce*(7*Ty+9*Ey*le))/Math.cos(te),ue=Math.asin(Math.sin(te)/Sy),de=z(180*he/Math.PI,-180,180),_e=z(180*ue/Math.PI,-Uf,Uf);return new Of(de,_e)}}class Og extends Ig{constructor(C){super(C),this.wrap=!0,this.supportsWorldCopies=!0}project(C,H){return{x:.5+C/360,y:.5-H/360,z:0}}unproject(C,H){const te=360*(C-.5),le=z(360*(.5-H),-Uf,Uf);return new Of(te,le)}}const Ay=Math.PI/2;function Fg(C){return Math.tan((Ay+C)/2)}class Ng extends Ig{constructor(C){super(C),this.center=C.center||[0,30];const[H,te]=this.parallels=C.parallels||[30,30];let le=w(H),ce=w(te);this.southernCenter=le+ce<0,this.southernCenter&&(le=-le,ce=-ce);const he=Math.cos(le),ue=Fg(le);this.n=le===ce?Math.sin(le):Math.log(he/Math.cos(ce))/Math.log(Fg(ce)/ue),this.f=he*Math.pow(Fg(le),this.n)/this.n}project(C,H){H=w(H),this.southernCenter&&(H=-H),C=w(C-this.center[0]);const te=1e-6,{n:le,f:ce}=this;ce>0?H<-Ay+te&&(H=-Ay+te):H>Ay-te&&(H=Ay-te);const he=ce/Math.pow(Fg(H),le);let ue=he*Math.sin(le*C),de=ce-he*Math.cos(le*C);return ue=.5*(ue/Math.PI+.5),de=.5*(de/Math.PI+.5),{x:ue,y:this.southernCenter?de:1-de,z:0}}unproject(C,H){C=(2*C-.5)*Math.PI,this.southernCenter&&(H=1-H),H=(2*(1-H)-.5)*Math.PI;const{n:te,f:le}=this,ce=le-H,he=Math.sign(ce),ue=Math.sign(te)*Math.sqrt(C*C+ce*ce);let de=Math.atan2(C,Math.abs(ce))*he;ce*te<0&&(de-=Math.PI*Math.sign(C)*he);const _e=z(T(de/te)+this.center[0],-180,180),ye=z(T(2*Math.atan(Math.pow(le/ue,1/te))-Ay),-Uf,Uf);return new Of(_e,this.southernCenter?-ye:ye)}}class Ug extends Ig{constructor(C){super(C),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(C,H){return{x:Gd(C),y:qd(H),z:0}}unproject(C,H){const te=$d(C),le=Hd(H);return new Of(te,le)}}const Dy=w(Uf);class jg extends Ig{project(C,H){const te=(H=w(H))*H,le=te*te;return{x:.5*((C=w(C))*(.8707-.131979*te+le*(le*(.003971*te-.001529*le)-.013791))/Math.PI+.5),y:1-.5*(H*(1.007226+te*(.015085+le*(.028874*te-.044475-.005916*le)))/Math.PI+1),z:0}}unproject(C,H){C=(2*C-.5)*Math.PI;let te=H=(2*(1-H)-1)*Math.PI,le=25,ce=0,he=te*te;do{he=te*te;const C=he*he;ce=(te*(1.007226+he*(.015085+C*(.028874*he-.044475-.005916*C)))-H)/(1.007226+he*(.045255+C*(.259866*he-.311325-.005916*11*C))),te=z(te-ce,-Dy,Dy)}while(Math.abs(ce)>1e-6&&--le>0);he=te*te;const ue=z(T(C/(.8707+he*(he*(he*he*he*(.003971-.001529*he)-.013791)-.131979))),-180,180),de=T(te);return new Of(ue,de)}}const Qy=w(Uf);class qg extends Ig{project(C,H){H=w(H),C=w(C);const te=Math.cos(H),le=2/Math.PI,ce=Math.acos(te*Math.cos(C/2)),he=Math.sin(ce)/ce,ue=.5*(C*le+2*te*Math.sin(C/2)/he)||0,de=.5*(H+Math.sin(H)/he)||0;return{x:.5*(ue/Math.PI+.5),y:1-.5*(de/Math.PI+1),z:0}}unproject(C,H){let te=C=(2*C-.5)*Math.PI,le=H=(2*(1-H)-1)*Math.PI,ce=25;const he=1e-6;let ue=0,de=0;do{const ce=Math.cos(le),he=Math.sin(le),_e=2*he*ce,ye=he*he,ve=ce*ce,Me=Math.cos(te/2),Se=Math.sin(te/2),Ae=2*Me*Se,Ce=Se*Se,Oe=1-ve*Me*Me,Ne=Oe?1/Oe:0,je=Oe?Math.acos(ce*Me)*Math.sqrt(1/Oe):0,Ge=.5*(2*je*ce*Se+2*te/Math.PI)-C,Ze=.5*(je*he+le)-H,qe=.5*Ne*(ve*Ce+je*ce*Me*ye)+1/Math.PI,$e=Ne*(Ae*_e/4-je*he*Se),We=.125*Ne*(_e*Se-je*he*ve*Ae),He=.5*Ne*(ye*Me+je*Ce*ce)+.5,Xe=$e*We-He*qe;ue=(Ze*$e-Ge*He)/Xe,de=(Ge*We-Ze*qe)/Xe,te=z(te-ue,-Math.PI,Math.PI),le=z(le-de,-Qy,Qy)}while((Math.abs(ue)>he||Math.abs(de)>he)&&--ce>0);return new Of(T(te),T(le))}}class Zg extends Ig{constructor(C){super(C),this.center=C.center||[0,0],this.parallels=C.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(w(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(C,H){const{scale:te,cosPhi:le}=this;return{x:w(C)*le*te+.5,y:-Math.sin(w(H))/le*te+.5,z:0}}unproject(C,H){const{scale:te,cosPhi:le}=this,ce=-(H-.5)/te,he=z(T((C-.5)/te)/le,-180,180),ue=Math.asin(z(ce*le,-1,1)),de=z(T(ue),-Uf,Uf);return new Of(he,de)}}class $g extends Ug{constructor(C){super(C),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(C,H,te){const le=_d(C,H,te),ce=xd(ad(te));return Ld.transformMat4(le,le,ce),{x:le[0],y:le[1],z:le[2]}}locationPoint(C,H){const te=md(H.lat,H.lng),le=Ld.normalize([],te),ce=C.elevation?C.elevation.getAtPointOrZero(C.locationCoordinate(H),C._centerAltitude):C._centerAltitude,he=Zd(1,0)*wn*ce;Ld.scaleAndAdd(te,te,le,he);const ue=ed.identity(new Float64Array(16));return ed.multiply(ue,C.pixelMatrix,C.globeMatrix),Ld.transformMat4(te,te,ue),new Ne(te[0],te[1])}pixelsPerMeter(C,H){return Zd(1,0)*H}pixelSpaceConversion(C,H,te){const le=Zd(1,C)*H,ce=Wr(Zd(1,45)*H,le,te);return this.pixelsPerMeter(C,H)/ce}createTileMatrix(C,H,te){const le=vd(ad(te.canonical));return ed.multiply(new Float64Array(16),C.globeMatrix,le)}createInversionMatrix(C,H){const{center:te}=C,le=xd(ad(H));return ed.rotateY(le,le,w(te.lng)),ed.rotateX(le,le,w(te.lat)),ed.scale(le,le,[C._pixelsPerMercatorPixel,C._pixelsPerMercatorPixel,1]),Float32Array.from(le)}pointCoordinate(C,H,te,le){return nd(C,H,te,!0)||new ep(0,0)}pointCoordinate3D(C,H,te){const le=this.pointCoordinate(C,H,te,0);return[le.x,le.y,le.z]}isPointAboveHorizon(C,H){return!nd(C,H.x,H.y,!1)}farthestPixelDistance(C){const H=function(C,H){const te=C.cameraToCenterDistance,le=C._centerAltitude*H,ce=C._camera,he=C._camera.forward(),ue=Ld.add([],Ld.scale([],he,-te),[0,0,le]),de=C.worldSize/(2*Math.PI),_e=[0,0,-de],ye=C.width/C.height,ve=Math.tan(C.fovAboveCenter),Me=Ld.scale([],ce.up(),ve),Se=Ld.scale([],ce.right(),ve*ye),Ae=Ld.normalize([],Ld.add([],Ld.add([],he,Me),Se)),Ce=[];let Oe;if(new Uu(ue,Ae).closestPointOnSphere(_e,de,Ce)){const H=Ld.add([],Ce,_e),te=Ld.sub([],H,ue);Oe=Math.cos(C.fovAboveCenter)*Ld.length(te)}else{const C=Ld.sub([],ue,_e),H=Ld.sub([],_e,ue);Ld.normalize(H,H);const te=Ld.length(C)-de;Oe=Math.sqrt(te*(te+2*de));const le=Math.acos(Oe/(de+te))-Math.acos(Ld.dot(he,H));Oe*=Math.cos(le)}return 1.01*Oe}(C,this.pixelsPerMeter(C.center.lat,C.worldSize)),te=Ed(C.zoom);if(te>0){const le=wg(C,Zd(1,C.center.lat)*C.worldSize),ce=C.worldSize/(2*Math.PI),he=Math.max(C.width,C.height)/C.worldSize*Math.PI;return Wr(H,le+ce*(1-Math.cos(he)),Math.pow(te,10))}return H}upVector(C,H,te){return _d(H,te,C,1)}upVectorScale(C){return{metersToTile:rd(gd(ad(C)))}}}function Hg(C){const H=C.parallels,te=!!H&&Math.abs(H[0]+H[1])<.01;switch(C.name){case"mercator":return new Ug(C);case"equirectangular":return new Og(C);case"naturalEarth":return new jg(C);case"equalEarth":return new kg(C);case"winkelTripel":return new qg(C);case"albers":return te?new Zg(C):new Cg(C);case"lambertConformalConic":return te?new Zg(C):new Ng(C);case"globe":return new $g(C)}throw new Error(`Invalid projection name: ${C.name}`)}const yx=new da({"symbol-placement":new ca(Ai.layout_symbol["symbol-placement"]),"symbol-spacing":new ca(Ai.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new ca(Ai.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new ha(Ai.layout_symbol["symbol-sort-key"]),"symbol-z-order":new ca(Ai.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new ca(Ai.layout_symbol["symbol-z-elevate"]),"icon-allow-overlap":new ca(Ai.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new ca(Ai.layout_symbol["icon-ignore-placement"]),"icon-optional":new ca(Ai.layout_symbol["icon-optional"]),"icon-rotation-alignment":new ca(Ai.layout_symbol["icon-rotation-alignment"]),"icon-size":new ha(Ai.layout_symbol["icon-size"]),"icon-text-fit":new ha(Ai.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new ha(Ai.layout_symbol["icon-text-fit-padding"]),"icon-image":new ha(Ai.layout_symbol["icon-image"]),"icon-rotate":new ha(Ai.layout_symbol["icon-rotate"]),"icon-padding":new ca(Ai.layout_symbol["icon-padding"]),"icon-keep-upright":new ca(Ai.layout_symbol["icon-keep-upright"]),"icon-offset":new ha(Ai.layout_symbol["icon-offset"]),"icon-anchor":new ha(Ai.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new ca(Ai.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new ca(Ai.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new ca(Ai.layout_symbol["text-rotation-alignment"]),"text-field":new ha(Ai.layout_symbol["text-field"]),"text-font":new ha(Ai.layout_symbol["text-font"]),"text-size":new ha(Ai.layout_symbol["text-size"]),"text-max-width":new ha(Ai.layout_symbol["text-max-width"]),"text-line-height":new ha(Ai.layout_symbol["text-line-height"]),"text-letter-spacing":new ha(Ai.layout_symbol["text-letter-spacing"]),"text-justify":new ha(Ai.layout_symbol["text-justify"]),"text-radial-offset":new ha(Ai.layout_symbol["text-radial-offset"]),"text-variable-anchor":new ca(Ai.layout_symbol["text-variable-anchor"]),"text-anchor":new ha(Ai.layout_symbol["text-anchor"]),"text-max-angle":new ca(Ai.layout_symbol["text-max-angle"]),"text-writing-mode":new ca(Ai.layout_symbol["text-writing-mode"]),"text-rotate":new ha(Ai.layout_symbol["text-rotate"]),"text-padding":new ca(Ai.layout_symbol["text-padding"]),"text-keep-upright":new ca(Ai.layout_symbol["text-keep-upright"]),"text-transform":new ha(Ai.layout_symbol["text-transform"]),"text-offset":new ha(Ai.layout_symbol["text-offset"]),"text-allow-overlap":new ca(Ai.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new ca(Ai.layout_symbol["text-ignore-placement"]),"text-optional":new ca(Ai.layout_symbol["text-optional"]),visibility:new ca(Ai.layout_symbol.visibility)});var vx={paint:new da({"icon-opacity":new ha(Ai.paint_symbol["icon-opacity"]),"icon-emissive-strength":new ha(Ai.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new ha(Ai.paint_symbol["text-emissive-strength"]),"icon-color":new ha(Ai.paint_symbol["icon-color"]),"icon-halo-color":new ha(Ai.paint_symbol["icon-halo-color"]),"icon-halo-width":new ha(Ai.paint_symbol["icon-halo-width"]),"icon-halo-blur":new ha(Ai.paint_symbol["icon-halo-blur"]),"icon-translate":new ca(Ai.paint_symbol["icon-translate"]),"icon-translate-anchor":new ca(Ai.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new ha(Ai.paint_symbol["icon-image-cross-fade"]),"text-opacity":new ha(Ai.paint_symbol["text-opacity"]),"text-color":new ha(Ai.paint_symbol["text-color"],{runtimeType:Gi,getOverride:C=>C.textColor,hasOverride:C=>!!C.textColor}),"text-halo-color":new ha(Ai.paint_symbol["text-halo-color"]),"text-halo-width":new ha(Ai.paint_symbol["text-halo-width"]),"text-halo-blur":new ha(Ai.paint_symbol["text-halo-blur"]),"text-translate":new ca(Ai.paint_symbol["text-translate"]),"text-translate-anchor":new ca(Ai.paint_symbol["text-translate-anchor"])}),layout:yx};class Yg{constructor(C){this.type=C.property.overrides?C.property.overrides.runtimeType:zi,this.defaultValue=C}evaluate(C){if(C.formattedSection){const H=this.defaultValue.property.overrides;if(H&&H.hasOverride(C.formattedSection))return H.getOverride(C.formattedSection)}return C.feature&&C.featureState?this.defaultValue.evaluate(C.feature,C.featureState):this.defaultValue.property.specification.default}eachChild(C){this.defaultValue.isConstant()||C(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}Is(Yg,"FormatSectionOverride",{omit:["defaultValue"]});class Kg extends _a{constructor(C,H){super(C,vx,H)}recalculate(C,H){super.recalculate(C,H),"auto"===this.layout.get("icon-rotation-alignment")&&(this.layout._values["icon-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-rotation-alignment")&&(this.layout._values["text-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-pitch-alignment")&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),"auto"===this.layout.get("icon-pitch-alignment")&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const te=this.layout.get("text-writing-mode");if(te){const C=[];for(const H of te)C.indexOf(H)<0&&C.push(H);this.layout._values["text-writing-mode"]=C}else this.layout._values["text-writing-mode"]="point"===this.layout.get("symbol-placement")?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getValueAndResolveTokens(C,H,te,le){const ce=this.layout.get(C).evaluate(H,{},te,le),he=this._unevaluatedLayout._values[C];return he.isDataDriven()||yo(he.value)||!ce?ce:function(C,H){return H.replace(/{([^{}]+)}/g,((H,te)=>te in C?String(C[te]):""))}(H.properties,ce)}createBucket(C){return new zx(C)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const C of vx.paint.overridableProperties){if(!Kg.hasPaintOverride(this.layout,C))continue;const H=this.paint.get(C),te=new Yg(H),le=new go(te,H.property.specification);let ce=null;ce="constant"===H.value.kind||"source"===H.value.kind?new vo("source",le):new bo("composite",le,H.value.zoomStops,H.value._interpolationType),this.paint._values[C]=new aa(H.property,ce,H.parameters)}}_handleOverridablePaintPropertyUpdate(C,H,te){return!(!this.layout||H.isDataDriven()||te.isDataDriven())&&Kg.hasPaintOverride(this.layout,C)}static hasPaintOverride(C,H){const te=C.get("text-field"),le=vx.paint.properties[H];let ce=!1;const o=C=>{for(const H of C)if(le.overrides&&le.overrides.hasOverride(H))return void(ce=!0)};if("constant"===te.value.kind&&te.value.value instanceof ui)o(te.value.value.sections);else if("source"===te.value.kind){const e=C=>{ce||(C instanceof Vr&&mi(C.value)===nr?o(C.value.sections):C instanceof Ti?o(C.sections):C.eachChild(e))},C=te.value;C._styleExpression&&e(C._styleExpression.expression)}return ce}getProgramIds(){const C=0!==this.paint.get("icon-opacity").constantOr(1),H=0!==this.paint.get("text-opacity").constantOr(1),te=[];return C&&te.push("symbolIcon"),H&&te.push("symbolSDF"),te}getDefaultProgramParams(C,H){return{config:new $l(this,H),overrideFog:!1}}}const wx=l_.types,Tx=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function ey(C,H,te,le,ce,he,ue,de,_e,ye,ve,Me,Se){const Ae=de?Math.min(xy,Math.round(de[0])):0,Ce=de?Math.min(xy,Math.round(de[1])):0;C.emplaceBack(H,te,Math.round(32*le),Math.round(32*ce),he,ue,(Ae<<1)+(_e?1:0),Ce,16*ye,16*ve,256*Me,256*Se)}function ty(C,H,te){C.emplaceBack(H,te)}function iy(C,H,te,le,ce,he,ue){C.emplaceBack(H,te,le,ce,he,ue)}function ry(C,H,te,le,ce){const he=5*H+2;C.float32[he+0]=te,C.float32[he+1]=le,C.float32[he+2]=ce}function ny(C,H,te,le,ce){C.emplaceBack(H,te,le,ce),C.emplaceBack(H,te,le,ce),C.emplaceBack(H,te,le,ce),C.emplaceBack(H,te,le,ce)}function oy(C){for(const H of C.sections)if(Vs(H.text))return!0;return!1}class sy{constructor(C){this.layoutVertexArray=new Pa,this.indexArray=new Va,this.programConfigurations=C,this.segments=new dl,this.dynamicLayoutVertexArray=new Ia,this.opacityVertexArray=new La,this.placedSymbolArray=new il,this.iconTransitioningVertexArray=new ka,this.globeExtVertexArray=new Ra,this.zOffsetVertexArray=new qa}isEmpty(){return 0===this.layoutVertexArray.length&&0===this.indexArray.length&&0===this.dynamicLayoutVertexArray.length&&0===this.opacityVertexArray.length&&0===this.iconTransitioningVertexArray.length}upload(C,H,te,le,ce){this.isEmpty()||(te&&(this.layoutVertexBuffer=C.createVertexBuffer(this.layoutVertexArray,Y_.members),this.indexBuffer=C.createIndexBuffer(this.indexArray,H),this.dynamicLayoutVertexBuffer=C.createVertexBuffer(this.dynamicLayoutVertexArray,lg.members,!0),this.opacityVertexBuffer=C.createVertexBuffer(this.opacityVertexArray,Tx,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=C.createVertexBuffer(this.iconTransitioningVertexArray,hg.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=C.createVertexBuffer(this.globeExtVertexArray,J_.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||ce)&&(this.zOffsetVertexBuffer=C.createVertexBuffer(this.zOffsetVertexArray,cg.members,!0)),this.opacityVertexBuffer.itemSize=1),(te||le)&&this.programConfigurations.upload(C))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy())}}Is(sy,"SymbolBuffers");class ay{constructor(C,H,te){this.layoutVertexArray=new C,this.layoutAttributes=H,this.indexArray=new te,this.segments=new dl,this.collisionVertexArray=new Na,this.collisionVertexArrayExt=new Ua}upload(C){this.layoutVertexBuffer=C.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=C.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=C.createVertexBuffer(this.collisionVertexArray,mg.members,!0),this.collisionVertexBufferExt=C.createVertexBuffer(this.collisionVertexArrayExt,_g.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}Is(ay,"CollisionBuffers");class ly{constructor(C){this.collisionBoxArray=C.collisionBoxArray,this.zoom=C.zoom,this.overscaling=C.overscaling,this.layers=C.layers,this.layerIds=this.layers.map((C=>C.fqid)),this.index=C.index,this.pixelRatio=C.pixelRatio,this.sourceLayerIndex=C.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=ed.identity([]),this.placementViewportMatrix=ed.identity([]);const H=this.layers[0]._unevaluatedLayout._values;this.textSizeData=o_(this.zoom,H["text-size"]),this.iconSizeData=o_(this.zoom,H["icon-size"]);const te=this.layers[0].layout,le=te.get("symbol-sort-key"),ce=te.get("symbol-z-order");this.canOverlap=te.get("text-allow-overlap")||te.get("icon-allow-overlap")||te.get("text-ignore-placement")||te.get("icon-ignore-placement"),this.sortFeaturesByKey="viewport-y"!==ce&&void 0!==le.constantOr(1),this.sortFeaturesByY=("viewport-y"===ce||"auto"===ce&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=te.get("text-writing-mode").map((C=>Wg[C])),this.stateDependentLayerIds=this.layers.filter((C=>C.isStateDependent())).map((C=>C.id)),this.sourceID=C.sourceID,this.projection=C.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=te.get("symbol-z-elevate")}createArrays(){this.text=new sy(new Hl(this.layers,this.zoom,(C=>/^text/.test(C)))),this.icon=new sy(new Hl(this.layers,this.zoom,(C=>/^icon/.test(C)))),this.glyphOffsetArray=new ol,this.lineVertexArray=new sl,this.symbolInstances=new nl}calculateGlyphDependencies(C,H,te,le,ce){for(let te=0;te<C.length;te++){const he=C.codePointAt(te);if(void 0===he)break;if(H[he]=!0,le&&ce&&he<=65535){const le=Lg[C.charAt(te)];le&&(H[le.charCodeAt(0)]=!0)}}}populate(C,H,te,le){const ce=this.layers[0],he=ce.layout,ue="globe"===this.projection.name,de=he.get("text-font"),_e=he.get("text-field"),ye=he.get("icon-image"),ve=("constant"!==_e.value.kind||_e.value.value instanceof ui&&!_e.value.value.isEmpty()||_e.value.value.toString().length>0)&&("constant"!==de.value.kind||de.value.value.length>0),Me="constant"!==ye.value.kind||!!ye.value.value||Object.keys(ye.parameters).length>0,Se=he.get("symbol-sort-key");if(this.features=[],!ve&&!Me)return;const Ae=H.iconDependencies,Ce=H.glyphDependencies,Oe=H.availableImages,Ne=new ea(this.zoom);for(const{feature:H,id:_e,index:ye,sourceLayerIndex:je}of C){const C=ce._featureFilter.needGeometry,Ge=cp(H,C);if(!ce._featureFilter.filter(Ne,Ge,te))continue;if(C||(Ge.geometry=lp(H,te,le)),ue&&1!==H.type&&te.z<=5){const C=Ge.geometry,H=.98078528056,r=(C,le)=>{const ce=_d(C.x,C.y,te,1),he=_d(le.x,le.y,te,1);return Ld.dot(ce,he)<H};for(let H=0;H<C.length;H++)C[H]=np(C[H],r)}let Ze,qe;if(ve){const C=ce.getValueAndResolveTokens("text-field",Ge,te,Oe),H=ui.factory(C);oy(H)&&(this.hasRTLText=!0),(!this.hasRTLText||"unavailable"===Ks()||this.hasRTLText&&tc.isParsed())&&(Ze=c_(H,ce,Ge))}if(Me){const C=ce.getValueAndResolveTokens("icon-image",Ge,te,Oe);qe=C instanceof di?C:di.fromString(C)}if(!Ze&&!qe)continue;const $e=this.sortFeaturesByKey?Se.evaluate(Ge,{},te):void 0;if(this.features.push({id:_e,text:Ze,icon:qe,index:ye,sourceLayerIndex:je,geometry:Ge.geometry,properties:H.properties,type:wx[H.type],sortKey:$e}),qe&&(Ae[qe.namePrimary]=!0,qe.nameSecondary&&(Ae[qe.nameSecondary]=!0)),Ze){const C=de.evaluate(Ge,{},te).join(","),H="map"===he.get("text-rotation-alignment")&&"point"!==he.get("symbol-placement");this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(Wg.vertical)>=0;for(const te of Ze.sections)if(te.image)Ae[te.image.namePrimary]=!0;else{const le=Ls(Ze.toString()),ce=te.fontStack||C,he=Ce[ce]=Ce[ce]||{};this.calculateGlyphDependencies(te.text,he,H,this.allowVerticalPlacement,le)}}}"line"===he.get("symbol-placement")&&(this.features=function(C){const H={},te={},le=[];let ce=0;function o(H){le.push(C[H]),ce++}function s(C,H,ce){const he=te[C];return delete te[C],te[H]=he,le[he].geometry[0].pop(),le[he].geometry[0]=le[he].geometry[0].concat(ce[0]),he}function a(C,te,ce){const he=H[te];return delete H[te],H[C]=he,le[he].geometry[0].shift(),le[he].geometry[0]=ce[0].concat(le[he].geometry[0]),he}function l(C,H,te){const le=te?H[0][H[0].length-1]:H[0][0];return`${C}:${le.x}:${le.y}`}for(let he=0;he<C.length;he++){const ue=C[he],de=ue.geometry,_e=ue.text?ue.text.toString():null;if(!_e){o(he);continue}const ye=l(_e,de),ve=l(_e,de,!0);if(ye in te&&ve in H&&te[ye]!==H[ve]){const C=a(ye,ve,de),ce=s(ye,ve,le[C].geometry);delete H[ye],delete te[ve],te[l(_e,le[ce].geometry,!0)]=ce,le[C].geometry=null}else ye in te?s(ye,ve,de):ve in H?a(ye,ve,de):(o(he),H[ye]=ce-1,te[ve]=ce-1)}return le.filter((C=>C.geometry))}(this.features)),this.sortFeaturesByKey&&this.features.sort(((C,H)=>C.sortKey-H.sortKey))}update(C,H,te,le,ce){const he=0!==Object.keys(C).length;if(he&&!this.stateDependentLayers.length)return;const ue=he?this.stateDependentLayers:this.layers;this.text.programConfigurations.updatePaintArrays(C,H,ue,te,le,ce),this.icon.programConfigurations.updatePaintArrays(C,H,ue,te,le,ce)}updateZOffset(){const e=(H,te,le)=>{C+=te,C>H.length&&H.resize(C);for(let ce=-te;ce<0;ce++)H.emplace(ce+C,le)},t=(C,te,le)=>{H+=te,H>C.length&&C.resize(H);for(let ce=-te;ce<0;ce++)C.emplace(ce+H,le)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let C=0,H=0;for(let C=0;C<this.symbolInstances.length;C++){const H=this.symbolInstances.get(C),{numHorizontalGlyphVertices:te,numVerticalGlyphVertices:le,numIconVertices:ce}=H,he=H.zOffset,ue=ce>0;if((te>0||le>0)&&(e(this.text.zOffsetVertexArray,te,he),e(this.text.zOffsetVertexArray,le,he)),ue){const{placedIconSymbolIndex:C,verticalPlacedIconSymbolIndex:te}=H;C>=0&&t(this.icon.zOffsetVertexArray,ce,he),te>=0&&t(this.icon.zOffsetVertexArray,H.numVerticalIconVertices,he)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return 0===this.symbolInstances.length&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(C){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(C),this.iconCollisionBox.upload(C)),this.text.upload(C,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.icon.upload(C,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=Hg(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(C,H){const te=this.lineVertexArray.length;if(void 0!==C.segment)for(const{x:C,y:te}of H)this.lineVertexArray.emplaceBack(C,te);return{lineStartIndex:te,lineLength:this.lineVertexArray.length-te}}addSymbols(C,H,te,le,ce,he,ue,de,_e,ye,ve,Me,Se,Ae,Ce,Oe){const Ne=C.indexArray,je=C.layoutVertexArray,Ge=C.globeExtVertexArray,Ze=C.segments.prepareSegment(4*H.length,je,Ne,this.canOverlap?he.sortKey:void 0),qe=this.glyphOffsetArray.length,$e=Ze.vertexLength,We=this.allowVerticalPlacement&&ue===Wg.vertical?Math.PI/2:0,He=he.text&&he.text.sections;for(let le=0;le<H.length;le++){const{tl:ce,tr:ue,bl:ye,br:ve,texPrimary:Me,texSecondary:qe,pixelOffsetTL:$e,pixelOffsetBR:Xe,minFontScaleX:Ye,minFontScaleY:Je,glyphOffset:Qe,isSDF:tt,sectionIndex:rt}=H[le],ot=Ze.vertexLength,st=Qe[1];if(ey(je,_e.x,_e.y,ce.x,st+ce.y,Me.x,Me.y,te,tt,$e.x,$e.y,Ye,Je),ey(je,_e.x,_e.y,ue.x,st+ue.y,Me.x+Me.w,Me.y,te,tt,Xe.x,$e.y,Ye,Je),ey(je,_e.x,_e.y,ye.x,st+ye.y,Me.x,Me.y+Me.h,te,tt,$e.x,Xe.y,Ye,Je),ey(je,_e.x,_e.y,ve.x,st+ve.y,Me.x+Me.w,Me.y+Me.h,te,tt,Xe.x,Xe.y,Ye,Je),de){const{x:H,y:te,z:le}=de.anchor,[ce,he,ue]=de.up;iy(Ge,H,te,le,ce,he,ue),iy(Ge,H,te,le,ce,he,ue),iy(Ge,H,te,le,ce,he,ue),iy(Ge,H,te,le,ce,he,ue),ny(C.dynamicLayoutVertexArray,H,te,le,We)}else ny(C.dynamicLayoutVertexArray,_e.x,_e.y,_e.z,We);if(Oe){const H=qe||Me;ty(C.iconTransitioningVertexArray,H.x,H.y),ty(C.iconTransitioningVertexArray,H.x+H.w,H.y),ty(C.iconTransitioningVertexArray,H.x,H.y+H.h),ty(C.iconTransitioningVertexArray,H.x+H.w,H.y+H.h)}Ne.emplaceBack(ot,ot+1,ot+2),Ne.emplaceBack(ot+1,ot+2,ot+3),Ze.vertexLength+=4,Ze.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(Qe[0]),le!==H.length-1&&rt===H[le+1].sectionIndex||C.programConfigurations.populatePaintArrays(je.length,he,he.index,{},Se,Ae,Ce,He&&He[rt])}const Xe=de?de.anchor:_e;C.placedSymbolArray.emplaceBack(Xe.x,Xe.y,Xe.z,_e.x,_e.y,qe,this.glyphOffsetArray.length-qe,$e,ye,ve,_e.segment,te?te[0]:0,te?te[1]:0,le[0],le[1],ue,0,!1,0,Me,0)}_commitLayoutVertex(C,H,te,le,ce,he,ue){C.emplaceBack(H,te,le,ce,he,Math.round(ue.x),Math.round(ue.y))}_addCollisionDebugVertices(C,H,te,le,ce,he,ue){const de=te.segments.prepareSegment(4,te.layoutVertexArray,te.indexArray),_e=de.vertexLength,ye=ue.tileAnchorX,ve=ue.tileAnchorY;for(let C=0;C<4;C++)te.collisionVertexArray.emplaceBack(0,0,0,0);te.collisionVertexArrayExt.emplaceBack(H,-C.padding,-C.padding),te.collisionVertexArrayExt.emplaceBack(H,C.padding,-C.padding),te.collisionVertexArrayExt.emplaceBack(H,C.padding,C.padding),te.collisionVertexArrayExt.emplaceBack(H,-C.padding,C.padding),this._commitLayoutVertex(te.layoutVertexArray,le,ce,he,ye,ve,new Ne(C.x1,C.y1)),this._commitLayoutVertex(te.layoutVertexArray,le,ce,he,ye,ve,new Ne(C.x2,C.y1)),this._commitLayoutVertex(te.layoutVertexArray,le,ce,he,ye,ve,new Ne(C.x2,C.y2)),this._commitLayoutVertex(te.layoutVertexArray,le,ce,he,ye,ve,new Ne(C.x1,C.y2)),de.vertexLength+=4;const Me=te.indexArray;Me.emplaceBack(_e,_e+1),Me.emplaceBack(_e+1,_e+2),Me.emplaceBack(_e+2,_e+3),Me.emplaceBack(_e+3,_e),de.primitiveLength+=4}_addTextDebugCollisionBoxes(C,H,te,le,ce,he){for(let ue=le;ue<ce;ue++){const le=te.get(ue),ce=this.getSymbolInstanceTextSize(C,he,H,ue);this._addCollisionDebugVertices(le,ce,this.textCollisionBox,le.projectedAnchorX,le.projectedAnchorY,le.projectedAnchorZ,he)}}_addIconDebugCollisionBoxes(C,H,te,le,ce,he){for(let ue=le;ue<ce;ue++){const le=te.get(ue),ce=this.getSymbolInstanceIconSize(C,H,he.placedIconSymbolIndex);this._addCollisionDebugVertices(le,ce,this.iconCollisionBox,le.projectedAnchorX,le.projectedAnchorY,le.projectedAnchorZ,he)}}generateCollisionDebugBuffers(C,H){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new ay(Ba,Sg.members,ka),this.iconCollisionBox=new ay(Ba,Sg.members,ka);const te=a_(this.iconSizeData,C),le=a_(this.textSizeData,C);for(let ce=0;ce<this.symbolInstances.length;ce++){const he=this.symbolInstances.get(ce);this._addTextDebugCollisionBoxes(le,C,H,he.textBoxStartIndex,he.textBoxEndIndex,he),this._addTextDebugCollisionBoxes(le,C,H,he.verticalTextBoxStartIndex,he.verticalTextBoxEndIndex,he),this._addIconDebugCollisionBoxes(te,C,H,he.iconBoxStartIndex,he.iconBoxEndIndex,he),this._addIconDebugCollisionBoxes(te,C,H,he.verticalIconBoxStartIndex,he.verticalIconBoxEndIndex,he)}}getSymbolInstanceTextSize(C,H,te,le){const ce=this.text.placedSymbolArray.get(H.rightJustifiedTextSymbolIndex>=0?H.rightJustifiedTextSymbolIndex:H.centerJustifiedTextSymbolIndex>=0?H.centerJustifiedTextSymbolIndex:H.leftJustifiedTextSymbolIndex>=0?H.leftJustifiedTextSymbolIndex:H.verticalPlacedTextSymbolIndex>=0?H.verticalPlacedTextSymbolIndex:le),he=s_(this.textSizeData,C,ce)/Dg;return this.tilePixelRatio*he}getSymbolInstanceIconSize(C,H,te){const le=this.icon.placedSymbolArray.get(te),ce=s_(this.iconSizeData,C,le);return this.tilePixelRatio*ce}_commitDebugCollisionVertexUpdate(C,H,te){C.emplaceBack(H,-te,-te),C.emplaceBack(H,te,-te),C.emplaceBack(H,te,te),C.emplaceBack(H,-te,te)}_updateTextDebugCollisionBoxes(C,H,te,le,ce,he){for(let ue=le;ue<ce;ue++){const le=te.get(ue),ce=this.getSymbolInstanceTextSize(C,he,H,ue);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,ce,le.padding)}}_updateIconDebugCollisionBoxes(C,H,te,le,ce,he){for(let ue=le;ue<ce;ue++){const le=te.get(ue),ce=this.getSymbolInstanceIconSize(C,H,he);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,ce,le.padding)}}updateCollisionDebugBuffers(C,H){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const te=a_(this.iconSizeData,C),le=a_(this.textSizeData,C);for(let ce=0;ce<this.symbolInstances.length;ce++){const he=this.symbolInstances.get(ce);this._updateTextDebugCollisionBoxes(le,C,H,he.textBoxStartIndex,he.textBoxEndIndex,he),this._updateTextDebugCollisionBoxes(le,C,H,he.verticalTextBoxStartIndex,he.verticalTextBoxEndIndex,he),this._updateIconDebugCollisionBoxes(te,C,H,he.iconBoxStartIndex,he.iconBoxEndIndex,he.placedIconSymbolIndex),this._updateIconDebugCollisionBoxes(te,C,H,he.verticalIconBoxStartIndex,he.verticalIconBoxEndIndex,he.placedIconSymbolIndex)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(C,H,te,le,ce,he,ue,de,_e){const ye={};if(H<te){const{x1:te,y1:le,x2:ce,y2:he,padding:ue,projectedAnchorX:de,projectedAnchorY:_e,projectedAnchorZ:ve,tileAnchorX:Me,tileAnchorY:Se,featureIndex:Ae}=C.get(H);ye.textBox={x1:te,y1:le,x2:ce,y2:he,padding:ue,projectedAnchorX:de,projectedAnchorY:_e,projectedAnchorZ:ve,tileAnchorX:Me,tileAnchorY:Se},ye.textFeatureIndex=Ae}if(le<ce){const{x1:H,y1:te,x2:ce,y2:he,padding:ue,projectedAnchorX:de,projectedAnchorY:_e,projectedAnchorZ:ve,tileAnchorX:Me,tileAnchorY:Se,featureIndex:Ae}=C.get(le);ye.verticalTextBox={x1:H,y1:te,x2:ce,y2:he,padding:ue,projectedAnchorX:de,projectedAnchorY:_e,projectedAnchorZ:ve,tileAnchorX:Me,tileAnchorY:Se},ye.verticalTextFeatureIndex=Ae}if(he<ue){const{x1:H,y1:te,x2:le,y2:ce,padding:ue,projectedAnchorX:de,projectedAnchorY:_e,projectedAnchorZ:ve,tileAnchorX:Me,tileAnchorY:Se,featureIndex:Ae}=C.get(he);ye.iconBox={x1:H,y1:te,x2:le,y2:ce,padding:ue,projectedAnchorX:de,projectedAnchorY:_e,projectedAnchorZ:ve,tileAnchorX:Me,tileAnchorY:Se},ye.iconFeatureIndex=Ae}if(de<_e){const{x1:H,y1:te,x2:le,y2:ce,padding:he,projectedAnchorX:ue,projectedAnchorY:_e,projectedAnchorZ:ve,tileAnchorX:Me,tileAnchorY:Se,featureIndex:Ae}=C.get(de);ye.verticalIconBox={x1:H,y1:te,x2:le,y2:ce,padding:he,projectedAnchorX:ue,projectedAnchorY:_e,projectedAnchorZ:ve,tileAnchorX:Me,tileAnchorY:Se},ye.verticalIconFeatureIndex=Ae}return ye}deserializeCollisionBoxes(C){this.collisionArrays=[];for(let H=0;H<this.symbolInstances.length;H++){const te=this.symbolInstances.get(H);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(C,te.textBoxStartIndex,te.textBoxEndIndex,te.verticalTextBoxStartIndex,te.verticalTextBoxEndIndex,te.iconBoxStartIndex,te.iconBoxEndIndex,te.verticalIconBoxStartIndex,te.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(C,H){const te=C.placedSymbolArray.get(H),le=te.vertexStartIndex+4*te.numGlyphs;for(let H=te.vertexStartIndex;H<le;H+=4)C.indexArray.emplaceBack(H,H+1,H+2),C.indexArray.emplaceBack(H+1,H+2,H+3)}getSortedSymbolIndexes(C){if(this.sortedAngle===C&&void 0!==this.symbolInstanceIndexes)return this.symbolInstanceIndexes;const H=Math.sin(C),te=Math.cos(C),le=[],ce=[],he=[];for(let C=0;C<this.symbolInstances.length;++C){he.push(C);const ue=this.symbolInstances.get(C);le.push(0|Math.round(H*ue.tileAnchorX+te*ue.tileAnchorY)),ce.push(ue.featureIndex)}return he.sort(((C,H)=>le[C]-le[H]||ce[H]-ce[C])),he}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let C=0;C<this.symbolInstances.length;++C)this.symbolInstanceIndexesSortedZOffset.push(C)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort(((C,H)=>this.symbolInstances.get(H).zOffset-this.symbolInstances.get(C).zOffset))}addToSortKeyRanges(C,H){const te=this.sortKeyRanges[this.sortKeyRanges.length-1];te&&te.sortKey===H?te.symbolInstanceEnd=C+1:this.sortKeyRanges.push({sortKey:H,symbolInstanceStart:C,symbolInstanceEnd:C+1})}sortFeatures(C){if(this.sortFeaturesByY&&this.sortedAngle!==C&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(C),this.sortedAngle=C,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const C of this.symbolInstanceIndexes){const H=this.symbolInstances.get(C);this.featureSortOrder.push(H.featureIndex);const{rightJustifiedTextSymbolIndex:te,centerJustifiedTextSymbolIndex:le,leftJustifiedTextSymbolIndex:ce,verticalPlacedTextSymbolIndex:he,placedIconSymbolIndex:ue,verticalPlacedIconSymbolIndex:de}=H;te>=0&&this.addIndicesForPlacedSymbol(this.text,te),le>=0&&le!==te&&this.addIndicesForPlacedSymbol(this.text,le),ce>=0&&ce!==le&&ce!==te&&this.addIndicesForPlacedSymbol(this.text,ce),he>=0&&this.addIndicesForPlacedSymbol(this.text,he),ue>=0&&this.addIndicesForPlacedSymbol(this.icon,ue),de>=0&&this.addIndicesForPlacedSymbol(this.icon,de)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}Is(ly,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),ly.MAX_GLYPHS=65535,ly.addDynamicAttributes=ny;var zx=ly;const Dx=ba([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),{members:Px}=Dx,kx=ba([{name:"a_packed",components:4,type:"Float32"}]),{members:Rx}=kx,Lx=l_.types,Ox=Math.cos(Math.PI/180*37.5);class _y{constructor(C){this.zoom=C.zoom,this.overscaling=C.overscaling,this.layers=C.layers,this.layerIds=this.layers.map((C=>C.fqid)),this.index=C.index,this.projection=C.projection,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach((C=>{this.gradients[C.id]={}})),this.layoutVertexArray=new Sa,this.layoutVertexArray2=new Ia,this.indexArray=new Va,this.programConfigurations=new Hl(C.layers,C.zoom),this.segments=new dl,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter((C=>C.isStateDependent())).map((C=>C.id))}populate(C,H,te,le){this.hasPattern=Pf("line",this.layers,H);const ce=this.layers[0].layout.get("line-sort-key"),he=[];for(const{feature:H,id:ue,index:de,sourceLayerIndex:_e}of C){const C=this.layers[0]._featureFilter.needGeometry,ye=cp(H,C);if(!this.layers[0]._featureFilter.filter(new ea(this.zoom),ye,te))continue;const ve=ce?ce.evaluate(ye,{},te):void 0,Me={id:ue,properties:H.properties,type:H.type,sourceLayerIndex:_e,index:de,geometry:C?ye.geometry:lp(H,te,le),patterns:{},sortKey:ve};he.push(Me)}ce&&he.sort(((C,H)=>C.sortKey-H.sortKey));const{lineAtlas:ue,featureIndex:de}=H,_e=this.addConstantDashes(ue);for(const le of he){const{geometry:ce,index:he,sourceLayerIndex:ye}=le;if(_e&&this.addFeatureDashes(le,ue),this.hasPattern){const C=Rf("line",this.layers,le,this.zoom,H);this.patternFeatures.push(C)}else this.addFeature(le,ce,he,te,ue.positions,H.availableImages,H.brightness);de.insert(C[he].feature,ce,he,ye,this.index)}}addConstantDashes(C){let H=!1;for(const te of this.layers){const le=te.paint.get("line-dasharray").value,ce=te.layout.get("line-cap").value;if("constant"!==le.kind||"constant"!==ce.kind)H=!0;else{const H=ce.value,te=le.value;if(!te)continue;C.addDash(te,H)}}return H}addFeatureDashes(C,H){const te=this.zoom;for(const le of this.layers){const ce=le.paint.get("line-dasharray").value,he=le.layout.get("line-cap").value;if("constant"===ce.kind&&"constant"===he.kind)continue;let ue,de;if("constant"===ce.kind){if(ue=ce.value,!ue)continue}else ue=ce.evaluate({zoom:te},C);de="constant"===he.kind?he.value:he.evaluate({zoom:te},C),H.addDash(ue,de),C.patterns[le.id]=H.getKey(ue,de)}}update(C,H,te,le,ce){const he=0!==Object.keys(C).length;he&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(C,H,he?this.stateDependentLayers:this.layers,te,le,ce)}addFeatures(C,H,te,le,ce,he){for(const C of this.patternFeatures)this.addFeature(C,C.geometry,C.index,H,te,le,he)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(C){this.uploaded||(0!==this.layoutVertexArray2.length&&(this.layoutVertexBuffer2=C.createVertexBuffer(this.layoutVertexArray2,Rx)),this.layoutVertexBuffer=C.createVertexBuffer(this.layoutVertexArray,Px),this.indexBuffer=C.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(C),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(C){if(C.properties&&C.properties.hasOwnProperty("mapbox_clip_start")&&C.properties.hasOwnProperty("mapbox_clip_end"))return{start:+C.properties.mapbox_clip_start,end:+C.properties.mapbox_clip_end}}addFeature(C,H,te,le,ce,he,ue){const de=this.layers[0].layout,_e=de.get("line-join").evaluate(C,{}),ye=de.get("line-cap").evaluate(C,{}),ve=de.get("line-miter-limit"),Me=de.get("line-round-limit");this.lineClips=this.lineFeatureClips(C);for(const te of H)this.addLine(te,C,_e,ye,ve,Me);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,C,te,ce,he,le,ue)}addLine(C,H,te,le,ce,he){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.lineSoFar=0,this.lineClips){this.lineClipsArray.push(this.lineClips);for(let H=0;H<C.length-1;H++)this.totalDistance+=C[H].dist(C[H+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const ue="Polygon"===Lx[H.type];let de=C.length;for(;de>=2&&C[de-1].equals(C[de-2]);)de--;let _e=0;for(;_e<de-1&&C[_e].equals(C[_e+1]);)_e++;if(de<(ue?3:2))return;"bevel"===te&&(ce=1.05);const ye=this.overscaling<=16?15*wn/(512*this.overscaling):0,ve=this.segments.prepareSegment(10*de,this.layoutVertexArray,this.indexArray);let Me,Se,Ae,Ce,Oe;this.e1=this.e2=-1,ue&&(Me=C[de-2],Oe=C[_e].sub(Me)._unit()._perp());for(let H=_e;H<de;H++){if(Ae=H===de-1?ue?C[_e+1]:void 0:C[H+1],Ae&&C[H].equals(Ae))continue;Oe&&(Ce=Oe),Me&&(Se=Me),Me=C[H],Oe=Ae?Ae.sub(Me)._unit()._perp():Ce,Ce=Ce||Oe;let Ne=Ce.add(Oe);0===Ne.x&&0===Ne.y||Ne._unit();const je=Ce.x*Oe.x+Ce.y*Oe.y,Ge=Ne.x*Oe.x+Ne.y*Oe.y,Ze=0!==Ge?1/Ge:1/0,qe=2*Math.sqrt(2-2*Ge),$e=Ge<Ox&&Se&&Ae,We=Ce.x*Oe.y-Ce.y*Oe.x>0;if($e&&H>_e){const C=Me.dist(Se);if(C>2*ye){const H=Me.sub(Me.sub(Se)._mult(ye/C)._round());this.updateDistance(Se,H),this.addCurrentVertex(H,Ce,0,0,ve),Se=H}}const He=Se&&Ae;let Xe=He?te:ue?"butt":le;if(He&&"round"===Xe&&(Ze<he?Xe="miter":Ze<=2&&(Xe="fakeround")),"miter"===Xe&&Ze>ce&&(Xe="bevel"),"bevel"===Xe&&(Ze>2&&(Xe="flipbevel"),Ze<ce&&(Xe="miter")),Se&&this.updateDistance(Se,Me),"miter"===Xe)Ne._mult(Ze),this.addCurrentVertex(Me,Ne,0,0,ve);else if("flipbevel"===Xe){if(Ze>100)Ne=Oe.mult(-1);else{const C=Ze*Ce.add(Oe).mag()/Ce.sub(Oe).mag();Ne._perp()._mult(C*(We?-1:1))}this.addCurrentVertex(Me,Ne,0,0,ve),this.addCurrentVertex(Me,Ne.mult(-1),0,0,ve)}else if("bevel"===Xe||"fakeround"===Xe){const C=-Math.sqrt(Ze*Ze-1),H=We?C:0,te=We?0:C;if(Se&&this.addCurrentVertex(Me,Ce,H,te,ve),"fakeround"===Xe){const C=Math.round(180*qe/Math.PI/20);for(let H=1;H<C;H++){let te=H/C;if(.5!==te){const C=te-.5;te+=te*C*(te-1)*((1.0904+je*(je*(3.55645-1.43519*je)-3.2452))*C*C+(.848013+je*(.215638*je-1.06021)))}const le=Oe.sub(Ce)._mult(te)._add(Ce)._unit()._mult(We?-1:1);this.addHalfVertex(Me,le.x,le.y,!1,We,0,ve)}}Ae&&this.addCurrentVertex(Me,Oe,-H,-te,ve)}else if("butt"===Xe)this.addCurrentVertex(Me,Ne,0,0,ve);else if("square"===Xe){const C=Se?1:-1;Se||this.addCurrentVertex(Me,Ne,C,C,ve),this.addCurrentVertex(Me,Ne,0,0,ve),Se&&this.addCurrentVertex(Me,Ne,C,C,ve)}else"round"===Xe&&(Se&&(this.addCurrentVertex(Me,Ce,0,0,ve),this.addCurrentVertex(Me,Ce,1,1,ve,!0)),Ae&&(this.addCurrentVertex(Me,Oe,-1,-1,ve,!0),this.addCurrentVertex(Me,Oe,0,0,ve)));if($e&&H<de-1){const C=Me.dist(Ae);if(C>2*ye){const H=Me.add(Ae.sub(Me)._mult(ye/C)._round());this.updateDistance(Me,H),this.addCurrentVertex(H,Oe,0,0,ve),Me=H}}}}addCurrentVertex(C,H,te,le,ce,he=!1){const ue=H.y*le-H.x,de=-H.y-H.x*le;this.addHalfVertex(C,H.x+H.y*te,H.y-H.x*te,he,!1,te,ce),this.addHalfVertex(C,ue,de,he,!0,-le,ce)}addHalfVertex({x:C,y:H},te,le,ce,he,ue,de){this.layoutVertexArray.emplaceBack((C<<1)+(ce?1:0),(H<<1)+(he?1:0),Math.round(63*te)+128,Math.round(63*le)+128,1+(0===ue?0:ue<0?-1:1),0,this.lineSoFar),this.lineClips&&this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,this.lineClips.start,this.lineClips.end);const _e=de.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,_e),de.primitiveLength++),he?this.e2=_e:this.e1=_e}updateScaledDistance(){if(this.lineClips){const C=this.totalDistance/(this.lineClips.end-this.lineClips.start);this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=C*this.lineClips.start+this.distance}else this.lineSoFar=this.distance}updateDistance(C,H){this.distance+=C.dist(H),this.updateScaledDistance()}}Is(_y,"LineBucket",{omit:["layers","patternFeatures"]});class gy{constructor(C,H,te,le){this.context=C,this.format=te,this.texture=C.gl.createTexture(),this.update(H,le)}update(C,H,le){const{width:ce,height:he}=C,{context:ue}=this,{gl:de}=ue,{HTMLImageElement:_e,HTMLCanvasElement:ye,HTMLVideoElement:ve,ImageData:Me,ImageBitmap:Se}=te;if(de.bindTexture(de.TEXTURE_2D,this.texture),ue.pixelStoreUnpackFlipY.set(!1),ue.pixelStoreUnpack.set(1),ue.pixelStoreUnpackPremultiplyAlpha.set(this.format===de.RGBA&&(!H||!1!==H.premultiply)),le||this.size&&this.size[0]===ce&&this.size[1]===he){const{x:H,y:te}=le||{x:0,y:0};if(C instanceof _e||C instanceof ye||C instanceof ve||C instanceof Me||Se&&C instanceof Se)de.texSubImage2D(de.TEXTURE_2D,0,H,te,de.RGBA,de.UNSIGNED_BYTE,C);else{let le=this.format,ue=de.UNSIGNED_BYTE;this.format===de.R32F&&(le=de.RED,ue=de.FLOAT),de.texSubImage2D(de.TEXTURE_2D,0,H,te,ce,he,le,ue,C.data)}}else if(this.size=[ce,he],C instanceof _e||C instanceof ye||C instanceof ve||C instanceof Me||Se&&C instanceof Se){let H=this.format;this.format===de.R8&&(H=de.RED),de.texImage2D(de.TEXTURE_2D,0,this.format,H,de.UNSIGNED_BYTE,C)}else{let H=this.format,te=this.format,le=de.UNSIGNED_BYTE;this.format===de.DEPTH_COMPONENT&&(H=de.DEPTH_COMPONENT16,le=de.UNSIGNED_SHORT),this.format===de.R32F&&(le=de.FLOAT,te=de.RED),de.texImage2D(de.TEXTURE_2D,0,H,ce,he,0,te,le,C.data)}this.useMipmap=Boolean(H&&H.useMipmap),this.useMipmap&&de.generateMipmap(de.TEXTURE_2D)}bind(C,H){const{context:te}=this,{gl:le}=te;le.bindTexture(le.TEXTURE_2D,this.texture),C!==this.minFilter&&(le.texParameteri(le.TEXTURE_2D,le.TEXTURE_MAG_FILTER,C),le.texParameteri(le.TEXTURE_2D,le.TEXTURE_MIN_FILTER,this.useMipmap?C===le.NEAREST?le.NEAREST_MIPMAP_NEAREST:le.LINEAR_MIPMAP_NEAREST:C),this.minFilter=C),H!==this.wrapS&&(le.texParameteri(le.TEXTURE_2D,le.TEXTURE_WRAP_S,H),le.texParameteri(le.TEXTURE_2D,le.TEXTURE_WRAP_T,H),this.wrapS=H)}bindExtraParam(C,H,te,le){const{context:ce}=this,{gl:he}=ce;he.bindTexture(he.TEXTURE_2D,this.texture),H!==this.magFilter&&(he.texParameteri(he.TEXTURE_2D,he.TEXTURE_MAG_FILTER,H),this.magFilter=H),C!==this.minFilter&&(he.texParameteri(he.TEXTURE_2D,he.TEXTURE_MIN_FILTER,this.useMipmap?C===he.NEAREST?he.NEAREST_MIPMAP_NEAREST:he.LINEAR_MIPMAP_NEAREST:C),this.minFilter=C),te!==this.wrapS&&(he.texParameteri(he.TEXTURE_2D,he.TEXTURE_WRAP_S,te),this.wrapS=te),le!==this.wrapT&&(he.texParameteri(he.TEXTURE_2D,he.TEXTURE_WRAP_T,le),this.wrapT=le)}destroy(){const{gl:C}=this.context;C.deleteTexture(this.texture),this.texture=null}}class yy{constructor(C,H){this.context=C,this.texture=H}bind(C,H){const{context:te}=this,{gl:le}=te;le.bindTexture(le.TEXTURE_2D,this.texture),C!==this.minFilter&&(le.texParameteri(le.TEXTURE_2D,le.TEXTURE_MAG_FILTER,C),le.texParameteri(le.TEXTURE_2D,le.TEXTURE_MIN_FILTER,C),this.minFilter=C),H!==this.wrapS&&(le.texParameteri(le.TEXTURE_2D,le.TEXTURE_WRAP_S,H),le.texParameteri(le.TEXTURE_2D,le.TEXTURE_WRAP_T,H),this.wrapS=H)}}const $x=32,Yx=33,Kx=new Uint16Array(8184);for(let C=0;C<2046;C++){let H=C+2,te=0,le=0,ce=0,he=0,ue=0,de=0;for(1&H?ce=he=ue=$x:te=le=de=$x;(H>>=1)>1;){const C=te+ce>>1,_e=le+he>>1;1&H?(ce=te,he=le,te=ue,le=de):(te=ce,le=he,ce=ue,he=de),ue=C,de=_e}const _e=4*C;Kx[_e+0]=te,Kx[_e+1]=le,Kx[_e+2]=ce,Kx[_e+3]=he}const xv=new Uint16Array(2178),vv=new Uint8Array(1089),zv=new Uint16Array(1089);function My(C){return 0===C?-.03125:32===C?.03125:0}var Dv=ba([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);const Pv={type:2,extent:wn,loadGeometry:()=>[[new Ne(0,0),new Ne(wn+1,0),new Ne(wn+1,wn+1),new Ne(0,wn+1),new Ne(0,0)]]};class Iy{constructor(C,H,te,le,ce){this.tileID=C,this.uid=F(),this.uses=0,this.tileSize=H,this.tileZoom=te,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=ce,le&&le.style&&(this._lastUpdatedBrightness=le.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",le&&le.transform&&(this.projection=le.transform.projection)}registerFadeDuration(C){const H=C+this.timeAdded;H<yi.now()||this.fadeEndTime&&H<this.fadeEndTime||(this.fadeEndTime=H)}wasRequested(){return"errored"===this.state||"loaded"===this.state||"reloading"===this.state}get tileTransform(){return this._tileTransform||(this._tileTransform=Tg(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(C,H,te){if(this.unloadVectorData(),this.state="loaded",C){C.featureIndex&&(this.latestFeatureIndex=C.featureIndex,C.rawTileData?(this.latestRawTileData=C.rawTileData,this.latestFeatureIndex.rawTileData=C.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=C.collisionBoxArray,this.buckets=function(C,H){const te={};if(!H)return te;for(const le of C){const C=le.layerIds.map((C=>H.getLayer(C))).filter(Boolean);if(0!==C.length){le.layers=C,le.stateDependentLayerIds&&(le.stateDependentLayers=le.stateDependentLayerIds.map((H=>C.filter((C=>C.id===H))[0])));for(const H of C)te[H.fqid]=le}}return te}(C.buckets,H.style),this.hasSymbolBuckets=!1;for(const C in this.buckets){const H=this.buckets[C];if(H instanceof zx){if(this.hasSymbolBuckets=!0,!te)break;H.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const C in this.buckets){const H=this.buckets[C];if(H instanceof zx&&H.hasRTLText){this.hasRTLText=!0,tc.isLoading()||tc.isLoaded()||"deferred"!==Ks()||Js();break}}this.queryPadding=0;for(const C in this.buckets){const te=this.buckets[C],le=H.style.getOwnLayer(C);if(!le)continue;const ce=le.queryRadius(te);this.queryPadding=Math.max(this.queryPadding,ce)}C.imageAtlas&&(this.imageAtlas=C.imageAtlas),C.glyphAtlasImage&&(this.glyphAtlasImage=C.glyphAtlasImage),C.lineAtlas&&(this.lineAtlas=C.lineAtlas),this._lastUpdatedBrightness=C.brightness}else this.collisionBoxArray=new el}unloadVectorData(){if(this.hasData()){for(const C in this.buckets)this.buckets[C].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}getBucket(C){return this.buckets[C.fqid]}upload(C){for(const H in this.buckets){const te=this.buckets[H];te.uploadPending()&&te.upload(C)}const H=C.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new gy(C,this.imageAtlas.image,H.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new gy(C,this.glyphAtlasImage,H.ALPHA),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new gy(C,this.lineAtlas.image,H.ALPHA),this.lineAtlas.uploaded=!0)}prepare(C,H,te){if(this.imageAtlas&&this.imageAtlas.patchUpdatedImages(C,this.imageAtlasTexture,te),!H||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;const le=H.style.getBrightness();(this._lastUpdatedBrightness||le)&&(this._lastUpdatedBrightness&&le&&Math.abs(this._lastUpdatedBrightness-le)<.001||(this._lastUpdatedBrightness=le,this.updateBuckets(void 0,H)))}queryRenderedFeatures(C,H,te,le,ce,he,ue,de){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({tileResult:le,pixelPosMatrix:ue,transform:he,params:ce,tileTransform:this.tileTransform},C,H,te):{}}querySourceFeatures(C,H){const te=this.latestFeatureIndex;if(!te||!te.rawTileData)return;const le=te.loadVTLayers(),ce=H?H.sourceLayer:"",he=le._geojsonTileLayer||le[ce];if(!he)return;const ue=Ro(H&&H.filter),{z:de,x:_e,y:ye}=this.tileID.canonical,ve={z:de,x:_e,y:ye};for(let H=0;H<he.length;H++){const le=he.feature(H);if(ue.needGeometry){const C=cp(le,!0);if(!ue.filter(new ea(this.tileID.overscaledZ),C,this.tileID.canonical))continue}else if(!ue.filter(new ea(this.tileID.overscaledZ),le))continue;const Me=te.getId(le,ce),Se=new Cm(le,de,_e,ye,Me);Se.tile=ve,C.push(Se)}}hasData(){return"loaded"===this.state||"reloading"===this.state||"expired"===this.state}bucketsLoaded(){for(const C in this.buckets)if(this.buckets[C].uploadPending())return!1;return!0}patternsLoaded(){return!!this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(C){const H=this.expirationTime;if(C.cacheControl){const H=ee(C.cacheControl);H["max-age"]&&(this.expirationTime=Date.now()+1e3*H["max-age"])}else C.expires&&(this.expirationTime=new Date(C.expires).getTime());if(this.expirationTime){const C=Date.now();let te=!1;if(this.expirationTime>C)te=!1;else if(H)if(this.expirationTime<H)te=!0;else{const le=this.expirationTime-H;le?this.expirationTime=C+Math.max(le,3e4):te=!0}else te=!0;te?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-(new Date).getTime(),Math.pow(2,31)-1)}setFeatureState(C,H){this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData&&0!==Object.keys(C).length&&H&&this.updateBuckets(C,H)}updateBuckets(C,H){if(!this.latestFeatureIndex)return;const te=this.latestFeatureIndex.loadVTLayers(),le=H.style.listImages(),ce=H.style.getBrightness();for(const he in this.buckets){if(!H.style.hasLayer(he))continue;const ue=this.buckets[he],de=ue.layers[0].sourceLayer||"_geojsonTileLayer",_e=te[de];let ye={};if(C&&(ye=C[de],!_e||!ye||0===Object.keys(ye).length))continue;if(ue.update(ye,_e,le,this.imageAtlas&&this.imageAtlas.patternPositions||{},ce),ue instanceof _y||ue instanceof Lf){const C=H.style.getOwnSourceCache(ue.layers[0].source);H._terrain&&H._terrain.enabled&&C&&ue.programConfigurations.needsUpload&&H._terrain._clearRenderCacheForTile(C.id,this.tileID)}const ve=H&&H.style&&H.style.getOwnLayer(he);ve&&(this.queryPadding=Math.max(this.queryPadding,ve.queryRadius(ue)))}}holdingForFade(){return void 0!==this.symbolFadeHoldUntil}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<yi.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(C){this.symbolFadeHoldUntil=yi.now()+C}setTexture(C,H){const te=H.context,le=te.gl;this.texture=this.texture||H.getTileTexture(C.width),this.texture?this.texture.update(C,{useMipmap:!0}):(this.texture=new gy(te,C,le.RGBA,{useMipmap:!0}),this.texture.bind(le.LINEAR,le.CLAMP_TO_EDGE))}setDependencies(C,H){const te={};for(const C of H)te[C]=!0;this.dependencies[C]=te}hasDependency(C,H){for(const te of C){const C=this.dependencies[te];if(C)for(const te of H)if(C[te])return!0}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(C,H){if(!H||"mercator"===H.name||this._tileDebugBuffer)return;const te=lp(Pv,this.tileID.canonical,this.tileTransform)[0],le=new Ta,ce=new Wa;for(let C=0;C<te.length;C++){const{x:H,y:he}=te[C];le.emplaceBack(H,he),ce.emplaceBack(C)}ce.emplaceBack(0),this._tileDebugIndexBuffer=C.createIndexBuffer(ce),this._tileDebugBuffer=C.createVertexBuffer(le,Vd.members),this._tileDebugSegments=dl.simpleSegment(0,0,le.length,ce.length)}_makeTileBoundsBuffers(C,H){if(this._tileBoundsBuffer||!H||"mercator"===H.name)return;const te=lp(Pv,this.tileID.canonical,this.tileTransform)[0];let le,ce;if(this.isRaster){const C=function(C,H){const te=Tg(C,H),le=Math.pow(2,C.z);for(let ce=0;ce<Yx;ce++)for(let he=0;he<Yx;he++){const ue=$d((C.x+(he+My(he))/$x)/le),de=Hd((C.y+(ce+My(ce))/$x)/le),_e=H.project(ue,de),ye=ce*Yx+he;xv[2*ye+0]=Math.round((_e.x*te.scale-te.x)*wn),xv[2*ye+1]=Math.round((_e.y*te.scale-te.y)*wn)}vv.fill(0),zv.fill(0);for(let C=2045;C>=0;C--){const H=4*C,te=Kx[H+0],le=Kx[H+1],ce=Kx[H+2],he=Kx[H+3],ue=te+ce>>1,de=le+he>>1,_e=ue+de-le,ye=de+te-ue,ve=le*Yx+te,Me=he*Yx+ce,Se=de*Yx+ue,Ae=Math.hypot((xv[2*ve+0]+xv[2*Me+0])/2-xv[2*Se+0],(xv[2*ve+1]+xv[2*Me+1])/2-xv[2*Se+1])>=16;vv[Se]=vv[Se]||(Ae?1:0),C<1022&&(vv[Se]=vv[Se]||vv[(le+ye>>1)*Yx+(te+_e>>1)]||vv[(he+ye>>1)*Yx+(ce+_e>>1)])}const ce=new Ma,he=new Va;let ue=0;function a(C,H){const te=H*Yx+C;return 0===zv[te]&&(ce.emplaceBack(xv[2*te+0],xv[2*te+1],C*wn/$x,H*wn/$x),zv[te]=++ue),zv[te]-1}function l(C,H,te,le,ce,ue){const de=C+te>>1,_e=H+le>>1;if(Math.abs(C-ce)+Math.abs(H-ue)>1&&vv[_e*Yx+de])l(ce,ue,C,H,de,_e),l(te,le,ce,ue,de,_e);else{const de=a(C,H),_e=a(te,le),ye=a(ce,ue);he.emplaceBack(de,_e,ye)}}return l(0,0,$x,$x,$x,0),l($x,$x,0,0,0,$x),{vertices:ce,indices:he}}(this.tileID.canonical,H);le=C.vertices,ce=C.indices}else{le=new Ma,ce=new Va;for(const{x:C,y:H}of te)le.emplaceBack(C,H,0,0);const C=hm(le.int16,void 0,4);for(let H=0;H<C.length;H+=3)ce.emplaceBack(C[H],C[H+1],C[H+2])}this._tileBoundsBuffer=C.createVertexBuffer(le,Dv.members),this._tileBoundsIndexBuffer=C.createIndexBuffer(ce),this._tileBoundsSegments=dl.simpleSegment(0,0,le.length,ce.length)}_makeGlobeTileDebugBuffers(C,H){const te=H.projection;if(!te||"globe"!==te.name||H.freezeTileCoverage)return;const le=this.tileID.canonical,ce=xd(cd(le,H)),he=Ed(H.zoom);let ue;he>0&&(ue=ed.invert(new Float64Array(16),H.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(C,le,H,ce,ue,he),this._makeGlobeTileDebugTextBuffer(C,le,H,ce,ue,he)}_globePoint(C,H,te,le,ce,he,ue){let de=_d(C,H,te);if(he){const ce=1<<te.z,_e=Gd(le.center.lng),ye=qd(le.center.lat),ve=(te.x+.5)/ce-_e;let Me=0;ve>.5?Me=-1:ve<-.5&&(Me=1);let Se=(C/wn+te.x)/ce+Me,Ae=(H/wn+te.y)/ce;Se=(Se-_e)*le._pixelsPerMercatorPixel+_e,Ae=(Ae-ye)*le._pixelsPerMercatorPixel+ye;const Ce=[Se*le.worldSize,Ae*le.worldSize,0];Ld.transformMat4(Ce,Ce,he),de=ld(de,Ce,ue)}return Ld.transformMat4(de,de,ce)}_makeGlobeTileDebugBorderBuffer(C,H,te,le,ce,he){const ue=new Ta,de=new Wa,_e=new Ea,c=(C,ye,ve,Me,Se)=>{const Ae=(ve-C)/(Se-1),Ce=(Me-ye)/(Se-1),Oe=ue.length;for(let ve=0;ve<Se;ve++){const Me=C+ve*Ae,Se=ye+ve*Ce;ue.emplaceBack(Me,Se);const Ne=this._globePoint(Me,Se,H,te,le,ce,he);_e.emplaceBack(Ne[0],Ne[1],Ne[2]),de.emplaceBack(Oe+ve)}},ye=wn;c(0,0,ye,0,16),c(ye,0,ye,ye,16),c(ye,ye,0,ye,16),c(0,ye,0,0,16),this._tileDebugIndexBuffer=C.createIndexBuffer(de),this._tileDebugBuffer=C.createVertexBuffer(ue,Vd.members),this._globeTileDebugBorderBuffer=C.createVertexBuffer(_e,Ud.members),this._tileDebugSegments=dl.simpleSegment(0,0,ue.length,de.length)}_makeGlobeTileDebugTextBuffer(C,H,te,le,ce,he){const ue=wn/4,de=new Ta,_e=new Va,ye=new Ea,ve=25;_e.reserve(32),de.reserve(ve),ye.reserve(ve);const u=(C,H)=>ve*C+H;for(let C=0;C<ve;C++){const _e=C*ue;for(let C=0;C<ve;C++){const ve=C*ue;de.emplaceBack(ve,_e);const Me=this._globePoint(ve,_e,H,te,le,ce,he);ye.emplaceBack(Me[0],Me[1],Me[2])}}for(let C=0;C<4;C++)for(let H=0;H<4;H++){const te=u(C,H),le=u(C,H+1),ce=u(C+1,H),he=u(C+1,H+1);_e.emplaceBack(te,le,ce),_e.emplaceBack(ce,le,he)}this._tileDebugTextIndexBuffer=C.createIndexBuffer(_e),this._tileDebugTextBuffer=C.createVertexBuffer(de,Vd.members),this._globeTileDebugTextBuffer=C.createVertexBuffer(ye,Ud.members),this._tileDebugTextSegments=dl.simpleSegment(0,0,ve,32)}}class Cy{constructor(C,H){this.max=C,this.onRemove=H,this.reset()}reset(){for(const C in this.data)for(const H of this.data[C])H.timeout&&clearTimeout(H.timeout),this.onRemove(H.value);return this.data={},this.order=[],this}add(C,H,te){const le=C.wrapped().key;void 0===this.data[le]&&(this.data[le]=[]);const ce={value:H,timeout:void 0};if(void 0!==te&&(ce.timeout=setTimeout((()=>{this.remove(C,ce)}),te)),this.data[le].push(ce),this.order.push(le),this.order.length>this.max){const C=this._getAndRemoveByKey(this.order[0]);C&&this.onRemove(C)}return this}has(C){return C.wrapped().key in this.data}getAndRemove(C){return this.has(C)?this._getAndRemoveByKey(C.wrapped().key):null}_getAndRemoveByKey(C){const H=this.data[C].shift();return H.timeout&&clearTimeout(H.timeout),0===this.data[C].length&&delete this.data[C],this.order.splice(this.order.indexOf(C),1),H.value}getByKey(C){const H=this.data[C];return H?H[0].value:null}get(C){return this.has(C)?this.data[C.wrapped().key][0].value:null}remove(C,H){if(!this.has(C))return this;const te=C.wrapped().key,le=void 0===H?0:this.data[te].indexOf(H),ce=this.data[te][le];return this.data[te].splice(le,1),ce.timeout&&clearTimeout(ce.timeout),0===this.data[te].length&&delete this.data[te],this.onRemove(ce.value),this.order.splice(this.order.indexOf(te),1),this}setMaxSize(C){for(this.max=C;this.order.length>this.max;){const C=this._getAndRemoveByKey(this.order[0]);C&&this.onRemove(C)}return this}filter(C){const H=[];for(const te in this.data)for(const le of this.data[te])C(le.value)||H.push(le);for(const C of H)this.remove(C.value.tileID,C)}}class zy{constructor(C,H,te,le){this.id=zy.uniqueIdxCounter,zy.uniqueIdxCounter++,this.context=C;const ce=C.gl;this.buffer=ce.createBuffer(),this.dynamicDraw=Boolean(te),this.context.unbindVAO(),C.bindElementBuffer.set(this.buffer),ce.bufferData(ce.ELEMENT_ARRAY_BUFFER,H.arrayBuffer,this.dynamicDraw?ce.DYNAMIC_DRAW:ce.STATIC_DRAW),this.dynamicDraw||le||H.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(C){this.id=zy.uniqueIdxCounter,zy.uniqueIdxCounter++;const H=this.context.gl;this.context.unbindVAO(),this.bind(),H.bufferSubData(H.ELEMENT_ARRAY_BUFFER,0,C.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}zy.uniqueIdxCounter=0;const kv={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class Py{constructor(C,H,te,le,ce,he){this.length=H.length,this.attributes=te,this.itemSize=H.bytesPerElement,this.dynamicDraw=le,this.instanceCount=he,this.context=C;const ue=C.gl;this.buffer=ue.createBuffer(),C.bindVertexBuffer.set(this.buffer),ue.bufferData(ue.ARRAY_BUFFER,H.arrayBuffer,this.dynamicDraw?ue.DYNAMIC_DRAW:ue.STATIC_DRAW),this.dynamicDraw||ce||H.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(C){const H=this.context.gl;this.bind(),H.bufferSubData(H.ARRAY_BUFFER,0,C.arrayBuffer)}enableAttributes(C,H){for(let te=0;te<this.attributes.length;te++){const le=H.attributes[this.attributes[te].name];void 0!==le&&C.enableVertexAttribArray(le)}}setVertexAttribPointers(C,H,te){for(let le=0;le<this.attributes.length;le++){const ce=this.attributes[le],he=H.attributes[ce.name];void 0!==he&&C.vertexAttribPointer(he,ce.components,C[kv[ce.type]],!1,this.itemSize,ce.offset+this.itemSize*(te||0))}}setVertexAttribDivisor(C,H,te){for(let le=0;le<this.attributes.length;le++){const ce=H.attributes[this.attributes[le].name];void 0!==ce&&this.instanceCount&&this.instanceCount>0&&C.vertexAttribDivisor(ce,te)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class Ry{constructor(C){this.gl=C.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(C){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class Ly extends Ry{getDefault(){return kr.transparent}set(C){const H=this.current;(C.r!==H.r||C.g!==H.g||C.b!==H.b||C.a!==H.a||this.dirty)&&(this.gl.clearColor(C.r,C.g,C.b,C.a),this.current=C,this.dirty=!1)}}class ky extends Ry{getDefault(){return 1}set(C){(C!==this.current||this.dirty)&&(this.gl.clearDepth(C),this.current=C,this.dirty=!1)}}class Oy extends Ry{getDefault(){return 0}set(C){(C!==this.current||this.dirty)&&(this.gl.clearStencil(C),this.current=C,this.dirty=!1)}}class By extends Ry{getDefault(){return[!0,!0,!0,!0]}set(C){const H=this.current;(C[0]!==H[0]||C[1]!==H[1]||C[2]!==H[2]||C[3]!==H[3]||this.dirty)&&(this.gl.colorMask(C[0],C[1],C[2],C[3]),this.current=C,this.dirty=!1)}}class Fy extends Ry{getDefault(){return!0}set(C){(C!==this.current||this.dirty)&&(this.gl.depthMask(C),this.current=C,this.dirty=!1)}}class Ny extends Ry{getDefault(){return 255}set(C){(C!==this.current||this.dirty)&&(this.gl.stencilMask(C),this.current=C,this.dirty=!1)}}class Uy extends Ry{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(C){const H=this.current;(C.func!==H.func||C.ref!==H.ref||C.mask!==H.mask||this.dirty)&&(this.gl.stencilFunc(C.func,C.ref,C.mask),this.current=C,this.dirty=!1)}}class Vy extends Ry{getDefault(){const C=this.gl;return[C.KEEP,C.KEEP,C.KEEP]}set(C){const H=this.current;(C[0]!==H[0]||C[1]!==H[1]||C[2]!==H[2]||this.dirty)&&(this.gl.stencilOp(C[0],C[1],C[2]),this.current=C,this.dirty=!1)}}class jy extends Ry{getDefault(){return!1}set(C){if(C===this.current&&!this.dirty)return;const H=this.gl;C?H.enable(H.STENCIL_TEST):H.disable(H.STENCIL_TEST),this.current=C,this.dirty=!1}}class Gy extends Ry{getDefault(){return[0,1]}set(C){const H=this.current;(C[0]!==H[0]||C[1]!==H[1]||this.dirty)&&(this.gl.depthRange(C[0],C[1]),this.current=C,this.dirty=!1)}}class qy extends Ry{getDefault(){return!1}set(C){if(C===this.current&&!this.dirty)return;const H=this.gl;C?H.enable(H.DEPTH_TEST):H.disable(H.DEPTH_TEST),this.current=C,this.dirty=!1}}class Zy extends Ry{getDefault(){return this.gl.LESS}set(C){(C!==this.current||this.dirty)&&(this.gl.depthFunc(C),this.current=C,this.dirty=!1)}}class $y extends Ry{getDefault(){return!1}set(C){if(C===this.current&&!this.dirty)return;const H=this.gl;C?H.enable(H.BLEND):H.disable(H.BLEND),this.current=C,this.dirty=!1}}class Hy extends Ry{getDefault(){const C=this.gl;return[C.ONE,C.ZERO,C.ONE,C.ZERO]}set(C){const H=this.current;(C[0]!==H[0]||C[1]!==H[1]||C[2]!==H[2]||C[3]!==H[3]||this.dirty)&&(this.gl.blendFuncSeparate(C[0],C[1],C[2],C[3]),this.current=C,this.dirty=!1)}}class Wy extends Ry{getDefault(){return kr.transparent}set(C){const H=this.current;(C.r!==H.r||C.g!==H.g||C.b!==H.b||C.a!==H.a||this.dirty)&&(this.gl.blendColor(C.r,C.g,C.b,C.a),this.current=C,this.dirty=!1)}}class Xy extends Ry{getDefault(){return this.gl.FUNC_ADD}set(C){(C!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(C,C),this.current=C,this.dirty=!1)}}class Yy extends Ry{getDefault(){return!1}set(C){if(C===this.current&&!this.dirty)return;const H=this.gl;C?H.enable(H.CULL_FACE):H.disable(H.CULL_FACE),this.current=C,this.dirty=!1}}class Ky extends Ry{getDefault(){return this.gl.BACK}set(C){(C!==this.current||this.dirty)&&(this.gl.cullFace(C),this.current=C,this.dirty=!1)}}class Jy extends Ry{getDefault(){return this.gl.CCW}set(C){(C!==this.current||this.dirty)&&(this.gl.frontFace(C),this.current=C,this.dirty=!1)}}let Rv=class extends Ry{getDefault(){return null}set(C){(C!==this.current||this.dirty)&&(this.gl.useProgram(C),this.current=C,this.dirty=!1)}};class ex extends Ry{getDefault(){return this.gl.TEXTURE0}set(C){(C!==this.current||this.dirty)&&(this.gl.activeTexture(C),this.current=C,this.dirty=!1)}}class tx extends Ry{getDefault(){const C=this.gl;return[0,0,C.drawingBufferWidth,C.drawingBufferHeight]}set(C){const H=this.current;(C[0]!==H[0]||C[1]!==H[1]||C[2]!==H[2]||C[3]!==H[3]||this.dirty)&&(this.gl.viewport(C[0],C[1],C[2],C[3]),this.current=C,this.dirty=!1)}}class ix extends Ry{getDefault(){return null}set(C){if(C===this.current&&!this.dirty)return;const H=this.gl;H.bindFramebuffer(H.FRAMEBUFFER,C),this.current=C,this.dirty=!1}}class rx extends Ry{getDefault(){return null}set(C){if(C===this.current&&!this.dirty)return;const H=this.gl;H.bindRenderbuffer(H.RENDERBUFFER,C),this.current=C,this.dirty=!1}}class nx extends Ry{getDefault(){return null}set(C){if(C===this.current&&!this.dirty)return;const H=this.gl;H.bindTexture(H.TEXTURE_2D,C),this.current=C,this.dirty=!1}}class ox extends Ry{getDefault(){return null}set(C){if(C===this.current&&!this.dirty)return;const H=this.gl;H.bindBuffer(H.ARRAY_BUFFER,C),this.current=C,this.dirty=!1}}class sx extends Ry{getDefault(){return null}set(C){const H=this.gl;H.bindBuffer(H.ELEMENT_ARRAY_BUFFER,C),this.current=C,this.dirty=!1}}class ax extends Ry{getDefault(){return null}set(C){this.gl&&(C!==this.current||this.dirty)&&(this.gl.bindVertexArray(C),this.current=C,this.dirty=!1)}}class lx extends Ry{getDefault(){return 4}set(C){if(C===this.current&&!this.dirty)return;const H=this.gl;H.pixelStorei(H.UNPACK_ALIGNMENT,C),this.current=C,this.dirty=!1}}class cx extends Ry{getDefault(){return!1}set(C){if(C===this.current&&!this.dirty)return;const H=this.gl;H.pixelStorei(H.UNPACK_PREMULTIPLY_ALPHA_WEBGL,C),this.current=C,this.dirty=!1}}class hx extends Ry{getDefault(){return!1}set(C){if(C===this.current&&!this.dirty)return;const H=this.gl;H.pixelStorei(H.UNPACK_FLIP_Y_WEBGL,C),this.current=C,this.dirty=!1}}class ux extends Ry{constructor(C,H){super(C),this.context=C,this.parent=H}getDefault(){return null}}class dx extends ux{setDirty(){this.dirty=!0}set(C){if(C===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const H=this.gl;H.framebufferTexture2D(H.FRAMEBUFFER,H.COLOR_ATTACHMENT0,H.TEXTURE_2D,C,0),this.current=C,this.dirty=!1}}class px extends ux{attachment(){return this.gl.DEPTH_ATTACHMENT}set(C){if(C===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const H=this.gl;H.framebufferRenderbuffer(H.FRAMEBUFFER,this.attachment(),H.RENDERBUFFER,C),this.current=C,this.dirty=!1}}class fx extends ux{attachment(){return this.gl.DEPTH_ATTACHMENT}set(C){if(C===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const H=this.gl;H.framebufferTexture2D(H.FRAMEBUFFER,this.attachment(),H.TEXTURE_2D,C,0),this.current=C,this.dirty=!1}}class mx extends px{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}class _x{constructor(C,H,te,le,ce){this.context=C,this.width=H,this.height=te;const he=this.framebuffer=C.gl.createFramebuffer();le&&(this.colorAttachment=new dx(C,he)),ce&&(this.depthAttachmentType=ce,this.depthAttachment="renderbuffer"===ce?new px(C,he):new fx(C,he))}destroy(){const C=this.context.gl;if(this.colorAttachment){const H=this.colorAttachment.get();H&&C.deleteTexture(H)}if(this.depthAttachment&&this.depthAttachmentType)if("renderbuffer"===this.depthAttachmentType){const H=this.depthAttachment.get();H&&C.deleteRenderbuffer(H)}else{const H=this.depthAttachment.get();H&&C.deleteTexture(H)}C.deleteFramebuffer(this.framebuffer)}}class gx{constructor(C,H,te){this.func=C,this.mask=H,this.range=te}}gx.ReadOnly=!1,gx.ReadWrite=!0,gx.disabled=new gx(519,gx.ReadOnly,[0,1]);const Xv=7680;class xx{constructor(C,H,te,le,ce,he){this.test=C,this.ref=H,this.mask=te,this.fail=le,this.depthFail=ce,this.pass=he}}xx.disabled=new xx({func:519,mask:0},0,0,Xv,Xv,Xv);const Yv=771;class bx{constructor(C,H,te,le){this.blendFunction=C,this.blendColor=H,this.mask=te,this.blendEquation=le}}bx.Replace=[1,0,1,0],bx.disabled=new bx(bx.Replace,kr.transparent,[!1,!1,!1,!1]),bx.unblended=new bx(bx.Replace,kr.transparent,[!0,!0,!0,!0]),bx.alphaBlended=new bx([1,Yv,1,Yv],kr.transparent,[!0,!0,!0,!0]),bx.multiply=new bx([774,0,774,0],kr.transparent,[!0,!0,!0,!0]);const Kv=1029,Jv=2305;class Ex{constructor(C,H,te){this.enable=C,this.mode=H,this.frontFace=te}}Ex.disabled=new Ex(!1,Kv,Jv),Ex.backCCW=new Ex(!0,Kv,Jv),Ex.backCW=new Ex(!0,Kv,2304),Ex.frontCW=new Ex(!0,1028,2304),Ex.frontCCW=new Ex(!0,1028,Jv);class Mx{constructor(C){this.gl=C,this.clearColor=new Ly(this),this.clearDepth=new ky(this),this.clearStencil=new Oy(this),this.colorMask=new By(this),this.depthMask=new Fy(this),this.stencilMask=new Ny(this),this.stencilFunc=new Uy(this),this.stencilOp=new Vy(this),this.stencilTest=new jy(this),this.depthRange=new Gy(this),this.depthTest=new qy(this),this.depthFunc=new Zy(this),this.blend=new $y(this),this.blendFunc=new Hy(this),this.blendColor=new Wy(this),this.blendEquation=new Xy(this),this.cullFace=new Yy(this),this.cullFaceSide=new Ky(this),this.frontFace=new Jy(this),this.program=new Rv(this),this.activeTexture=new ex(this),this.viewport=new tx(this),this.bindFramebuffer=new ix(this),this.bindRenderbuffer=new rx(this),this.bindTexture=new nx(this),this.bindVertexBuffer=new ox(this),this.bindElementBuffer=new sx(this),this.bindVertexArrayOES=new ax(this),this.pixelStoreUnpack=new lx(this),this.pixelStoreUnpackPremultiplyAlpha=new cx(this),this.pixelStoreUnpackFlipY=new hx(this),this.extTextureFilterAnisotropic=C.getExtension("EXT_texture_filter_anisotropic")||C.getExtension("MOZ_EXT_texture_filter_anisotropic")||C.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=C.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.extTextureFilterAnisotropicForceOff=!1,this.extStandardDerivativesForceOff=!1,this.extDebugRendererInfo=C.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=C.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=C.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.extTextureFloatLinear=C.getExtension("OES_texture_float_linear"),this.extRenderToTextureHalfFloat=C.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=C.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=C.getParameter(C.MAX_TEXTURE_SIZE)}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(C,H,te){return new zy(this,C,H,te)}createVertexBuffer(C,H,te,le,ce){return new Py(this,C,H,te,le,ce)}createRenderbuffer(C,H,te){const le=this.gl,ce=le.createRenderbuffer();return this.bindRenderbuffer.set(ce),le.renderbufferStorage(le.RENDERBUFFER,C,H,te),this.bindRenderbuffer.set(null),ce}createFramebuffer(C,H,te,le){return new _x(this,C,H,te,le)}clear({color:C,depth:H,stencil:te,colorMask:le}){const ce=this.gl;let he=0;C&&(he|=ce.COLOR_BUFFER_BIT,this.clearColor.set(C),this.colorMask.set(le||[!0,!0,!0,!0])),void 0!==H&&(he|=ce.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(H),this.depthMask.set(!0)),void 0!==te&&(he|=ce.STENCIL_BUFFER_BIT,this.clearStencil.set(te),this.stencilMask.set(255)),ce.clear(he)}setCullFace(C){!1===C.enable?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(C.mode),this.frontFace.set(C.frontFace))}setDepthMode(C){C.func!==this.gl.ALWAYS||C.mask?(this.depthTest.set(!0),this.depthFunc.set(C.func),this.depthMask.set(C.mask),this.depthRange.set(C.range)):this.depthTest.set(!1)}setStencilMode(C){C.test.func!==this.gl.ALWAYS||C.mask?(this.stencilTest.set(!0),this.stencilMask.set(C.mask),this.stencilOp.set([C.fail,C.depthFail,C.pass]),this.stencilFunc.set({func:C.test.func,ref:C.ref,mask:C.test.mask})):this.stencilTest.set(!1)}setColorMode(C){x(C.blendFunction,bx.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(C.blendFunction),this.blendColor.set(C.blendColor),C.blendEquation?this.blendEquation.set(C.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(C.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}class Ax extends It{constructor(C,H,te){super(),this.id=C,this._onlySymbols=te,H.on("data",(C=>{"source"===C.dataType&&"metadata"===C.sourceDataType&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&"source"===C.dataType&&"content"===C.sourceDataType&&(this.reload(),this.transform&&this.update(this.transform))})),H.on("error",(()=>{this._sourceErrored=!0})),this._source=H,this._tiles={},this._cache=new Cy(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=H.minTileCacheSize,this._maxTileCacheSize=H.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this._coveredTiles={},this._shadowCasterTiles={},this._state=new zm,this._isRaster="raster"===this._source.type||"raster-dem"===this._source.type||"custom"===this._source.type&&"raster"===this._source._dataType}onAdd(C){this.map=C,this._minTileCacheSize=void 0===this._minTileCacheSize&&C?C._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=void 0===this._maxTileCacheSize&&C?C._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded)return!1;if(!this._source.loaded())return!1;for(const C in this._tiles){const H=this._tiles[C];if("errored"!==H.state&&("loaded"!==H.state||!H.bucketsLoaded()))return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const C=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,C&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(C,H){return C.isSymbolTile=this._onlySymbols,C.isExtraShadowCaster=this._shadowCasterTiles[C.tileID.key],this._source.loadTile(C,H)}_unloadTile(C){if(this._source.unloadTile)return this._source.unloadTile(C,(()=>{}))}_abortTile(C){if(this._source.abortTile)return this._source.abortTile(C,(()=>{}))}serialize(){return this._source.serialize()}prepare(C){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const H in this._tiles){const te=this._tiles[H];te.upload(C),te.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return L(this._tiles).map((C=>C.tileID)).sort(Sx).map((C=>C.key))}getRenderableIds(C,H){const te=[];for(const le in this._tiles)this._isIdRenderable(+le,C,H)&&te.push(this._tiles[le]);return C?te.sort(((C,H)=>{const te=C.tileID,le=H.tileID,ce=new Ne(te.canonical.x,te.canonical.y)._rotate(this.transform.angle),he=new Ne(le.canonical.x,le.canonical.y)._rotate(this.transform.angle);return te.overscaledZ-le.overscaledZ||he.y-ce.y||he.x-ce.x})).map((C=>C.tileID.key)):te.map((C=>C.tileID)).sort(Sx).map((C=>C.key))}hasRenderableParent(C){const H=this.findLoadedParent(C,0);return!!H&&this._isIdRenderable(H.tileID.key)}_isIdRenderable(C,H,te){return this._tiles[C]&&this._tiles[C].hasData()&&!this._coveredTiles[C]&&(H||!this._tiles[C].holdingForFade())&&(te||!this._shadowCasterTiles[C])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const C in this._tiles)"errored"!==this._tiles[C].state&&this._reloadTile(+C,"reloading")}}_reloadTile(C,H){const te=this._tiles[C];te&&("loading"!==te.state&&(te.state=H),this._loadTile(te,this._tileLoaded.bind(this,te,C,H)))}_tileLoaded(C,H,te,le){if(le)if(C.state="errored",404!==le.status)this._source.fire(new St(le,{tile:C}));else if("raster-dem"===this._source.type&&this.usedForTerrain&&this.map.painter.terrain){const C=this.map.painter.terrain;this.update(this.transform,C.getScaledDemTileSize(),!0),C.resetTileLookupCache(this.id)}else this.update(this.transform);else C.timeAdded=yi.now(),"expired"===te&&(C.refreshedUponExpiration=!0),this._setTileReloadTimer(H,C),"raster-dem"===this._source.type&&C.dem&&this._backfillDEM(C),this._state.initializeTileState(C,this.map?this.map.painter:null),this._source.fire(new At("data",{dataType:"source",tile:C,coord:C.tileID,sourceCacheId:this.id}))}_backfillDEM(C){const H=this.getRenderableIds();for(let te=0;te<H.length;te++){const le=H[te];if(C.neighboringTiles&&C.neighboringTiles[le]){const H=this.getTileByID(le);i(C,H),i(H,C)}}function i(C,H){if(!C.dem||C.dem.borderReady)return;C.needsHillshadePrepare=!0,C.needsDEMTextureUpload=!0;let te=H.tileID.canonical.x-C.tileID.canonical.x;const le=H.tileID.canonical.y-C.tileID.canonical.y,ce=Math.pow(2,C.tileID.canonical.z),he=H.tileID.key;0===te&&0===le||Math.abs(le)>1||(Math.abs(te)>1&&(1===Math.abs(te+ce)?te+=ce:1===Math.abs(te-ce)&&(te-=ce)),H.dem&&C.dem&&(C.dem.backfillBorder(H.dem,te,le),C.neighboringTiles&&C.neighboringTiles[he]&&(C.neighboringTiles[he].backfilled=!0)))}}getTile(C){return this.getTileByID(C.key)}getTileByID(C){return this._tiles[C]}_retainLoadedChildren(C,H,te,le){for(const ce in this._tiles){let he=this._tiles[ce];if(le[ce]||!he.hasData()||he.tileID.overscaledZ<=H||he.tileID.overscaledZ>te)continue;let ue=he.tileID;for(;he&&he.tileID.overscaledZ>H+1;){const C=he.tileID.scaledTo(he.tileID.overscaledZ-1);he=this._tiles[C.key],he&&he.hasData()&&(ue=C)}let de=ue;for(;de.overscaledZ>H;)if(de=de.scaledTo(de.overscaledZ-1),C[de.key]){le[ue.key]=ue;break}}}findLoadedParent(C,H){if(C.key in this._loadedParentTiles){const te=this._loadedParentTiles[C.key];return te&&te.tileID.overscaledZ>=H?te:null}for(let te=C.overscaledZ-1;te>=H;te--){const H=C.scaledTo(te),le=this._getLoadedTile(H);if(le)return le}}_getLoadedTile(C){const H=this._tiles[C.key];return H&&H.hasData()?H:this._cache.getByKey(this._source.reparseOverscaled?C.wrapped().key:C.canonical.key)}updateCacheSize(C,H){H=H||this._source.tileSize;const te=Math.ceil(C.width/H)+1,le=Math.ceil(C.height/H)+1,ce=Math.floor(te*le*5),he="number"==typeof this._minTileCacheSize?Math.max(this._minTileCacheSize,ce):ce,ue="number"==typeof this._maxTileCacheSize?Math.min(this._maxTileCacheSize,he):he;this._cache.setMaxSize(ue)}handleWrapJump(C){const H=Math.round((C-(void 0===this._prevLng?C:this._prevLng))/360);if(this._prevLng=C,H){const C={};for(const te in this._tiles){const le=this._tiles[te];le.tileID=le.tileID.unwrapTo(le.tileID.wrap+H),C[le.tileID.key]=le}this._tiles=C;for(const C in this._timers)clearTimeout(this._timers[C]),delete this._timers[C];for(const C in this._tiles)this._setTileReloadTimer(+C,this._tiles[C])}}update(C,H,te,le){if(this.transform=C,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage)return;if(this.usedForTerrain&&!te)return;let ce;if(this.updateCacheSize(C,H),"globe"!==this.transform.projection.name&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={},this.used||this.usedForTerrain?this._source.tileID?ce=C.getVisibleUnwrappedCoordinates(this._source.tileID).map((C=>new Bu(C.canonical.z,C.wrap,C.canonical.z,C.canonical.x,C.canonical.y))):(ce=C.coveringTiles({tileSize:H||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!te,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain}),this._source.hasTile&&(ce=ce.filter((C=>this._source.hasTile(C))))):ce=[],ce.length>0&&this.castsShadows&&le&&"globe"!==this.transform.projection.name&&!this.usedForTerrain&&!Ix(this._source.type)){const he=C.coveringZoomLevel({tileSize:H||this._source.tileSize,roundZoom:this._source.roundZoom&&!te}),ue=Math.min(he,this._source.maxzoom),de=C.extendTileCoverForShadows(ce,le,ue);for(const C of de)this._shadowCasterTiles[C.key]=!0,ce.push(C)}const he=this._updateRetainedTiles(ce);if(Ix(this._source.type)&&0!==ce.length){const C={},H={},te=Object.keys(he);for(const le of te){const te=he[le],ce=this._tiles[le];if(!ce||ce.fadeEndTime&&ce.fadeEndTime<=yi.now())continue;const ue=this.findLoadedParent(te,Math.max(te.overscaledZ-Ax.maxOverzooming,this._source.minzoom));ue&&(this._addTile(ue.tileID),C[ue.tileID.key]=ue.tileID),H[le]=te}const le=ce[ce.length-1].overscaledZ;for(const C in this._tiles){const te=this._tiles[C];if(he[C]||!te.hasData())continue;let ce=te.tileID;for(;ce.overscaledZ>le;){ce=ce.scaledTo(ce.overscaledZ-1);const le=this._tiles[ce.key];if(le&&le.hasData()&&H[ce.key]){he[C]=te.tileID;break}}}for(const H in C)he[H]||(this._coveredTiles[H]=!0,he[H]=C[H])}for(const C in he)this._tiles[C].clearFadeHold();const ue=function(C,H){const te=[];for(const le in C)le in H||te.push(le);return te}(this._tiles,he);for(const C of ue){const H=this._tiles[C];H.hasSymbolBuckets&&!H.holdingForFade()?H.setHoldDuration(this.map._fadeDuration):H.hasSymbolBuckets&&!H.symbolFadeFinished()||this._removeTile(+C)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const C in this._tiles)this._tiles[C].holdingForFade()&&this._removeTile(+C)}_updateRetainedTiles(C){const H={};if(0===C.length)return H;const te={},le=C.reduce(((C,H)=>Math.min(C,H.overscaledZ)),1/0),ce=C[0].overscaledZ,he=Math.max(ce-Ax.maxOverzooming,this._source.minzoom),ue=Math.max(ce+Ax.maxUnderzooming,this._source.minzoom),de={};for(const te of C){const C=this._addTile(te);H[te.key]=te,C.hasData()||le<this._source.maxzoom&&(de[te.key]=te)}this._retainLoadedChildren(de,le,ue,H);for(const le of C){let C=this._tiles[le.key];if(C.hasData())continue;if(le.canonical.z>=this._source.maxzoom){const C=le.children(this._source.maxzoom)[0],te=this.getTile(C);if(te&&te.hasData()){H[C.key]=C;continue}}else{const C=le.children(this._source.maxzoom);if(H[C[0].key]&&H[C[1].key]&&H[C[2].key]&&H[C[3].key])continue}let ce=C.wasRequested();for(let ue=le.overscaledZ-1;ue>=he;--ue){const he=le.scaledTo(ue);if(te[he.key])break;if(te[he.key]=!0,C=this.getTile(he),!C&&ce&&(C=this._addTile(he)),C&&(H[he.key]=he,ce=C.wasRequested(),C.hasData()))break}}return H}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const C in this._tiles){const H=[];let te,le=this._tiles[C].tileID;for(;le.overscaledZ>0;){if(le.key in this._loadedParentTiles){te=this._loadedParentTiles[le.key];break}H.push(le.key);const C=le.scaledTo(le.overscaledZ-1);if(te=this._getLoadedTile(C),te)break;le=C}for(const C of H)this._loadedParentTiles[C]=te}}_addTile(C){let H=this._tiles[C.key];if(H)return!0!==H.isExtraShadowCaster||!!this._shadowCasterTiles[C.key]||this._reloadTile(C.key,"reloading"),H;H=this._cache.getAndRemove(C),H&&(this._setTileReloadTimer(C.key,H),H.tileID=C,this._state.initializeTileState(H,this.map?this.map.painter:null),this._cacheTimers[C.key]&&(clearTimeout(this._cacheTimers[C.key]),delete this._cacheTimers[C.key],this._setTileReloadTimer(C.key,H)));const te=Boolean(H);if(!te){const te=this.map?this.map.painter:null;H=new Iy(C,this._source.tileSize*C.overscaleFactor(),this.transform.tileZoom,te,this._isRaster),this._loadTile(H,this._tileLoaded.bind(this,H,C.key,H.state))}return H?(H.uses++,this._tiles[C.key]=H,te||this._source.fire(new At("dataloading",{tile:H,coord:H.tileID,dataType:"source"})),H):null}_setTileReloadTimer(C,H){C in this._timers&&(clearTimeout(this._timers[C]),delete this._timers[C]);const te=H.getExpiryTimeout();te&&(this._timers[C]=setTimeout((()=>{this._reloadTile(C,"expired"),delete this._timers[C]}),te))}_removeTile(C){const H=this._tiles[C];H&&(H.uses--,delete this._tiles[C],this._timers[C]&&(clearTimeout(this._timers[C]),delete this._timers[C]),H.uses>0||(H.hasData()&&"reloading"!==H.state?this._cache.add(H.tileID,H,H.getExpiryTimeout()):(H.aborted=!0,this._abortTile(H),this._unloadTile(H))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const C in this._tiles)this._removeTile(+C);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(C,H,te){const le=[],ce=this.transform;if(!ce)return le;const he="globe"===ce.projection.name,ue=Gd(ce.center.lng);for(const de in this._tiles){const _e=this._tiles[de];if(te&&_e.clearQueryDebugViz(),_e.holdingForFade())continue;let ye;if(he){const C=_e.tileID.canonical;if(0===C.z){const H=[Math.abs(z(ue,...Cx(C,-1))-ue),Math.abs(z(ue,...Cx(C,1))-ue)];ye=[0,2*H.indexOf(Math.min(...H))-1]}else{const H=[Math.abs(z(ue,...Cx(C,-1))-ue),Math.abs(z(ue,...Cx(C,0))-ue),Math.abs(z(ue,...Cx(C,1))-ue)];ye=[H.indexOf(Math.min(...H))-1]}}else ye=[0];for(const te of ye){const he=C.containsTile(_e,ce,H,te);he&&le.push(he)}}return le}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(C){return this._getRenderableCoordinates(C)}_getRenderableCoordinates(C,H){const te=this.getRenderableIds(C,H).map((C=>this._tiles[C].tileID));for(const C of te)C.projMatrix=this.transform.calculateProjMatrix(C.toUnwrapped());return te}sortCoordinatesByDistance(C){const H=C.slice(),te=this.transform._camera.position,le=this.transform._camera.forward(),ce={};for(const C of H){const H=1/(1<<C.canonical.z);ce[C.key]=((C.canonical.x+.5)*H+C.wrap-te[0])*le[0]+((C.canonical.y+.5)*H-te[1])*le[1]-te[2]*le[2]}return H.sort(((C,H)=>ce[C.key]-ce[H.key])),H}hasTransition(){if(this._source.hasTransition())return!0;if(Ix(this._source.type))for(const C in this._tiles){const H=this._tiles[C];if(void 0!==H.fadeEndTime&&H.fadeEndTime>=yi.now())return!0}return!1}setFeatureState(C,H,te){this._state.updateState(C=C||"_geojsonTileLayer",H,te)}removeFeatureState(C,H,te){this._state.removeFeatureState(C=C||"_geojsonTileLayer",H,te)}getFeatureState(C,H){return this._state.getState(C=C||"_geojsonTileLayer",H)}setDependencies(C,H,te){const le=this._tiles[C];le&&le.setDependencies(H,te)}reloadTilesForDependencies(C,H){for(const te in this._tiles)this._tiles[te].hasDependency(C,H)&&this._reloadTile(+te,"reloading");this._cache.filter((te=>!te.hasDependency(C,H)))}_preloadTiles(C,H){if(!this._sourceLoaded){const i=()=>{this._sourceLoaded&&(this._source.off("data",i),this._preloadTiles(C,H))};return void this._source.on("data",i)}const te=new Map,le=Array.isArray(C)?C:[C],ce=this.map.painter.terrain,he=this.usedForTerrain&&ce?ce.getScaledDemTileSize():this._source.tileSize;for(const C of le){const H=C.coveringTiles({tileSize:he,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const C of H)te.set(C.key,C);this.usedForTerrain&&C.updateElevation(!1)}R(Array.from(te.values()),((C,H)=>{const te=new Iy(C,this._source.tileSize*C.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster);this._loadTile(te,(C=>{"raster-dem"===this._source.type&&te.dem&&this._backfillDEM(te),H(C,te)}))}),H)}}function Sx(C,H){const te=Math.abs(2*C.wrap)-+(C.wrap<0),le=Math.abs(2*H.wrap)-+(H.wrap<0);return C.overscaledZ-H.overscaledZ||le-te||H.canonical.y-C.canonical.y||H.canonical.x-C.canonical.x}function Ix(C){return"raster"===C||"image"===C||"video"===C||"custom"===C}function Cx(C,H){const te=1<<C.z;return[C.x/te+H,(C.x+1)/te+H]}Ax.maxOverzooming=10,Ax.maxUnderzooming=3;const Qv=ba([{name:"a_pos_3f",components:3,type:"Float32"}]),eb=ba([{name:"a_color_3f",components:3,type:"Float32"}]),tb=ba([{name:"a_color_4f",components:4,type:"Float32"}]),cb=ba([{name:"a_uv_2f",components:2,type:"Float32"}]),Tb=ba([{name:"a_normal_3f",components:3,type:"Float32"}]),Eb=ba([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),Cb=ba([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]);class Bx{constructor(C=0,H=0,te=0,le=0){if(isNaN(C)||C<0||isNaN(H)||H<0||isNaN(te)||te<0||isNaN(le)||le<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=C,this.bottom=H,this.left=te,this.right=le}interpolate(C,H,te){return null!=H.top&&null!=C.top&&(this.top=Wr(C.top,H.top,te)),null!=H.bottom&&null!=C.bottom&&(this.bottom=Wr(C.bottom,H.bottom,te)),null!=H.left&&null!=C.left&&(this.left=Wr(C.left,H.left,te)),null!=H.right&&null!=C.right&&(this.right=Wr(C.right,H.right,te)),this}getCenter(C,H){const te=z((this.left+C-this.right)/2,0,C),le=z((this.top+H-this.bottom)/2,0,H);return new Ne(te,le)}equals(C){return this.top===C.top&&this.bottom===C.bottom&&this.left===C.left&&this.right===C.right}clone(){return new Bx(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}function Fx(C,H){const te=ne(C,3);ed.fromQuat(C,H),oe(C,3,te)}function Nx(C,H){const te=id.identity([]);return id.rotateZ(te,te,-H),id.rotateX(te,te,-C),te}function Ux(C,H){const te=[C[0],C[1],0],le=[H[0],H[1],0];if(Ld.length(te)>=1e-15){const C=Ld.normalize([],te);Ld.scale(le,C,Ld.dot(le,C)),H[0]=le[0],H[1]=le[1]}const ce=Ld.cross([],H,C);if(Ld.len(ce)<1e-15)return null;const he=Math.atan2(-ce[1],ce[0]);return Nx(Math.atan2(Math.sqrt(C[0]*C[0]+C[1]*C[1]),-C[2]),he)}class Vx{constructor(C,H){this.position=C,this.orientation=H}get position(){return this._position}set position(C){if(C){const H=C instanceof ep?C:new ep(C[0],C[1],C[2]);this._renderWorldCopies&&(H.x=P(H.x,0,1)),this._position=H}else this._position=null}lookAtPoint(C,H){if(this.orientation=null,!this.position)return;const te=this.position,le=this._elevation?this._elevation.getAtPointOrZero(ep.fromLngLat(C)):0,ce=ep.fromLngLat(C,le),he=[ce.x-te.x,ce.y-te.y,ce.z-te.z];H||(H=[0,0,1]),H[2]=Math.abs(H[2]),this.orientation=Ux(he,H)}setPitchBearing(C,H){this.orientation=Nx(w(C),w(-H))}}class jx{constructor(C,H){this._transform=ed.identity([]),this.orientation=H,this.position=C}get mercatorPosition(){const C=this.position;return new ep(C[0],C[1],C[2])}get position(){const C=ne(this._transform,3);return[C[0],C[1],C[2]]}set position(C){var H;C&&oe(this._transform,3,[(H=C)[0],H[1],H[2],1])}get orientation(){return this._orientation}set orientation(C){this._orientation=C||id.identity([]),C&&Fx(this._transform,this._orientation)}getPitchBearing(){const C=this.forward(),H=this.right();return{bearing:Math.atan2(-H[1],H[0]),pitch:Math.atan2(Math.sqrt(C[0]*C[0]+C[1]*C[1]),-C[2])}}setPitchBearing(C,H){this._orientation=Nx(C,H),Fx(this._transform,this._orientation)}forward(){const C=ne(this._transform,2);return[-C[0],-C[1],-C[2]]}up(){const C=ne(this._transform,1);return[-C[0],-C[1],-C[2]]}right(){const C=ne(this._transform,0);return[C[0],C[1],C[2]]}getCameraToWorld(C,H){const te=new Float64Array(16);return ed.invert(te,this.getWorldToCamera(C,H)),te}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(C,H,te){const le=this.position;Ld.scale(le,le,-C);const ce=new Float64Array(16);return ed.fromScaling(ce,[te,te,te]),ed.translate(ce,ce,le),ce[10]*=H,ce}getWorldToCamera(C,H){const te=new Float64Array(16),le=new Float64Array(4),ce=this.position;return id.conjugate(le,this._orientation),Ld.scale(ce,ce,-C),ed.fromQuat(te,le),ed.translate(te,te,ce),te[1]*=-1,te[5]*=-1,te[9]*=-1,te[13]*=-1,te[8]*=H,te[9]*=H,te[10]*=H,te[11]*=H,te}getCameraToClipPerspective(C,H,te,le){const ce=new Float64Array(16);return ed.perspective(ce,C,H,te,le),ce}getCameraToClipOrthographic(C,H,te,le,ce,he){const ue=new Float64Array(16);return ed.ortho(ue,C,H,te,le,ce,he),ue}getDistanceToElevation(C,H=!1){const te=0===C?0:Zd(C,H?Hd(this.position[1]):this.position[1]),le=this.forward();return(te-this.position[2])/le[2]}clone(){return new jx([...this.position],[...this.orientation])}}function Gx(C,H){const te=Zx(C.projection,C.zoom,C.width,C.height),le=function(C,H,te,le,ce){const he=new Of(te.lng-180*zb,te.lat),ue=new Of(te.lng+180*zb,te.lat),de=C.project(he.lng,he.lat),_e=C.project(ue.lng,ue.lat),ye=-Math.atan2(_e.y-de.y,_e.x-de.x),ve=ep.fromLngLat(te);ve.y=z(ve.y,-1+zb,1-zb);const Me=ve.toLngLat(),Se=C.project(Me.lng,Me.lat),Ae=ep.fromLngLat(Me);Ae.x+=zb;const Ce=Ae.toLngLat(),Oe=C.project(Ce.lng,Ce.lat),Ne=Wx(Oe.x-Se.x,Oe.y-Se.y,ye),je=ep.fromLngLat(Me);je.y+=zb;const Ge=je.toLngLat(),Ze=C.project(Ge.lng,Ge.lat),qe=Wx(Ze.x-Se.x,Ze.y-Se.y,ye),$e=Math.abs(Ne.x)/Math.abs(qe.y),We=ed.identity([]);ed.rotateZ(We,We,-ye*(1-(ce?0:le)));const He=ed.identity([]);return ed.scale(He,He,[1,1-(1-$e)*le,1]),He[4]=-qe.x/qe.y*le,ed.rotateZ(He,He,ye),ed.multiply(He,We,He),He}(C.projection,0,C.center,te,H),ce=qx(C);return ed.scale(le,le,[ce,ce,1]),le}function qx(C){const H=C.projection,te=Zx(C.projection,C.zoom,C.width,C.height),le=Hx(H,C.center),ce=Hx(H,Of.convert(H.center));return Math.pow(2,le*te+(1-te)*ce)}function Zx(C,H,te,le,ce=1/0){const he=C.range;if(!he)return 0;const ue=Math.min(ce,Math.max(te,le)),de=Math.log(ue/1024)/Math.LN2;return D(he[0]+de,he[1]+de,H)}const zb=1/4e4;function Hx(C,H){const te=z(H.lat,-Uf,Uf),le=new Of(H.lng-180*zb,te),ce=new Of(H.lng+180*zb,te),he=C.project(le.lng,te),ue=C.project(ce.lng,te),de=ep.fromLngLat(le),_e=ep.fromLngLat(ce),ye=ue.x-he.x,ve=ue.y-he.y,Me=_e.x-de.x,Se=_e.y-de.y,Ae=Math.sqrt((Me*Me+Se*Se)/(ye*ye+ve*ve));return Math.log(Ae)/Math.LN2}function Wx(C,H,te){const le=Math.cos(te),ce=Math.sin(te);return{x:C*le-H*ce,y:C*ce+H*le}}function Xx(C,H,te){return H*(wn/(C.tileSize*Math.pow(2,te-C.tileID.overscaledZ)))}const Bb={unknown:0,flipRequired:1,flipNotRequired:2},Nb=Math.tan(85*Math.PI/180);function Jx(C,H,te,le,ce,he,ue){const de=ed.create();if(te)if("globe"===he.name){const C=function(C,H){const{x:te,y:le}=C.point,ce=Td(te,le,C.worldSize/C._pixelsPerMercatorPixel,0,0);return ed.multiply(ce,ce,vd(ad(H)))}(ce,H);ed.multiply(de,de,C)}else{const C=Xu.invert([],ue);de[0]=C[0],de[1]=C[1],de[4]=C[2],de[5]=C[3],le||ed.rotateZ(de,de,ce.angle)}else ed.multiply(de,ce.labelPlaneMatrix,C);return de}function Qx(C,H,te,le,ce,he,ue){const de=Jx(C,H,te,le,ce,he,ue);return"globe"===he.name&&te||(de[2]=de[6]=de[10]=de[14]=0),de}function ev(C,H,te,le,ce,he,ue){if(te){if("globe"===he.name){const de=Jx(C,H,te,le,ce,he,ue);return ed.invert(de,de),ed.multiply(de,C,de),de}{const H=ed.clone(C),te=ed.identity([]);return te[0]=ue[0],te[1]=ue[1],te[4]=ue[2],te[5]=ue[3],ed.multiply(H,H,te),le||ed.rotateZ(H,H,-ce.angle),H}}return ce.glCoordMatrix}function tv(C,H,te,le){const ce=[C,H,te,1];te?Lu.transformMat4(ce,ce,le):dv(ce,ce,le);const he=ce[3];return ce[0]/=he,ce[1]/=he,ce[2]/=he,ce}function iv(C,H){return Math.min(.5+C/H*.5,1.5)}function rv(C,H){const te=C[0]/C[3],le=C[1]/C[3];return te>=-H[0]&&te<=H[0]&&le>=-H[1]&&le<=H[1]}function nv(C,H,te,le,ce,he,ue,de,_e,ye){const ve=te.transform,Me=le?C.textSizeData:C.iconSizeData,Se=a_(Me,te.transform.zoom),Ae="globe"===ve.projection.name,Ce=[256/te.width*2+1,256/te.height*2+1],Oe=le?C.text.dynamicLayoutVertexArray:C.icon.dynamicLayoutVertexArray;Oe.clear();let je=null;Ae&&(je=le?C.text.globeExtVertexArray:C.icon.globeExtVertexArray);const Ge=C.lineVertexArray,Ze=le?C.text.placedSymbolArray:C.icon.placedSymbolArray,qe=te.transform.width/te.transform.height;let $e,We=!1;for(let le=0;le<Ze.length;le++){const Ae=Ze.get(le),{numGlyphs:He,writingMode:Xe}=Ae;if(Xe!==Wg.vertical||We||$e===Wg.horizontal||(We=!0),$e=Xe,(Ae.hidden||Xe===Wg.vertical)&&!We){uv(He,Oe);continue}We=!1;const Ye=new Ne(Ae.tileAnchorX,Ae.tileAnchorY);let{x:Je,y:Qe,z:tt}=ve.projection.projectTilePoint(Ye.x,Ye.y,ye.canonical);if(_e){const[C,H,te]=_e(Ye);Je+=C,Qe+=H,tt+=te}const rt=[Je,Qe,tt,1];if(Lu.transformMat4(rt,rt,H),!rv(rt,Ce)){uv(He,Oe);continue}const ot=rt[3],st=iv(te.transform.getCameraToCenterDistance(ve.projection),ot),at=s_(Me,Se,Ae),lt=ue?at/st:at*st,ct=tv(Je,Qe,tt,ce);if(ct[3]<=0){uv(He,Oe);continue}let ht={};const pt=ue?null:_e,ft=av(Ae,lt,!1,de,H,ce,he,C.glyphOffsetArray,Ge,Oe,je,ct,Ye,ht,qe,pt,ve.projection,ye,ue);We=ft.useVertical,pt&&ft.needsFlipping&&(ht={}),(ft.notEnoughRoom||We||ft.needsFlipping&&av(Ae,lt,!0,de,H,ce,he,C.glyphOffsetArray,Ge,Oe,je,ct,Ye,ht,qe,pt,ve.projection,ye,ue).notEnoughRoom)&&uv(He,Oe)}le?(C.text.dynamicLayoutVertexBuffer.updateData(Oe),je&&C.text.globeExtVertexBuffer&&C.text.globeExtVertexBuffer.updateData(je)):(C.icon.dynamicLayoutVertexBuffer.updateData(Oe),je&&C.icon.globeExtVertexBuffer&&C.icon.globeExtVertexBuffer.updateData(je))}function ov(C,H,te,le,ce,he,ue,de,_e,ye,ve,Me,Se,Ae,Ce,Oe){const{lineStartIndex:Ne,glyphStartIndex:je,segment:Ge}=de,Ze=je+de.numGlyphs,qe=Ne+de.lineLength,$e=H.getoffsetX(je),We=H.getoffsetX(Ze-1),He=hv(C*$e,te,le,ce,he,ue,Ge,Ne,qe,_e,ye,ve,Me,Se,!0,Ae,Ce,Oe);if(!He)return null;const Xe=hv(C*We,te,le,ce,he,ue,Ge,Ne,qe,_e,ye,ve,Me,Se,!0,Ae,Ce,Oe);return Xe?{first:He,last:Xe}:null}function sv(C,H,te,le){return C===Wg.horizontal&&Math.abs(le)>Math.abs(te)?{useVertical:!0}:C===Wg.vertical?le>0?{needsFlipping:!0}:null:H!==Bb.unknown&&function(C,H){return 0===C||Math.abs(H/C)>Nb}(te,le)?H===Bb.flipRequired?{needsFlipping:!0}:null:te<0?{needsFlipping:!0}:null}function av(C,H,te,le,ce,he,ue,de,_e,ye,ve,Me,Se,Ae,Ce,Oe,je,Ge,Ze){const qe=H/24,$e=C.lineOffsetX*qe,We=C.lineOffsetY*qe,{lineStartIndex:He,glyphStartIndex:Xe,numGlyphs:Ye,segment:Je,writingMode:Qe,flipState:tt}=C,rt=He+C.lineLength,z=C=>{if(ve){const[H,te,le]=C.up,ce=ye.length;ry(ve,ce+0,H,te,le),ry(ve,ce+1,H,te,le),ry(ve,ce+2,H,te,le),ry(ve,ce+3,H,te,le)}const[H,te,le]=C.point;ny(ye,H,te,le,C.angle)};if(Ye>1){const H=ov(qe,de,$e,We,te,Me,Se,C,_e,he,Ae,Oe,!1,je,Ge,Ze);if(!H)return{notEnoughRoom:!0};if(le&&!te){let[te,le,ce]=H.first.point,[he,de,_e]=H.last.point;[te,le]=tv(te,le,ce,ue),[he,de]=tv(he,de,_e,ue);const ye=sv(Qe,tt,(he-te)*Ce,de-le);if(C.flipState=ye&&ye.needsFlipping?Bb.flipRequired:Bb.flipNotRequired,ye)return ye}z(H.first);for(let C=Xe+1;C<Xe+Ye-1;C++){const H=hv(qe*de.getoffsetX(C),$e,We,te,Me,Se,Je,He,rt,_e,he,Ae,Oe,!1,!1,je,Ge,Ze);if(!H)return ye.length-=4*(C-Xe),{notEnoughRoom:!0};z(H)}z(H.last)}else{if(le&&!te){const H=tv(Se.x,Se.y,0,ce),te=He+Je+1,le=new Ne(_e.getx(te),_e.gety(te)),he=tv(le.x,le.y,0,ce),ue=he[3]>0?he:cv(Se,le,H,1,ce,void 0,je,Ge.canonical),de=sv(Qe,tt,(ue[0]-H[0])*Ce,ue[1]-H[1]);if(C.flipState=de&&de.needsFlipping?Bb.flipRequired:Bb.flipNotRequired,de)return de}const H=hv(qe*de.getoffsetX(Xe),$e,We,te,Me,Se,Je,He,rt,_e,he,Ae,Oe,!1,!1,je,Ge,Ze);if(!H)return{notEnoughRoom:!0};z(H)}return{}}function lv(C,H,te,le,ce){const{x:he,y:ue,z:de}=le.projectTilePoint(C.x,C.y,H);if(!ce)return tv(he,ue,de,te);const[_e,ye,ve]=ce(C);return tv(he+_e,ue+ye,de+ve,te)}function cv(C,H,te,le,ce,he,ue,de){const _e=lv(C.sub(H)._unit()._add(C),de,ce,ue,he);return Ld.sub(_e,te,_e),Ld.normalize(_e,_e),Ld.scaleAndAdd(_e,te,_e,le)}function hv(C,H,te,le,ce,he,ue,de,_e,ye,ve,Me,Se,Ae,Ce,Oe,je,Ge){const Ze=le?C-H:C+H;let qe=Ze>0?1:-1,$e=0;le&&(qe*=-1,$e=Math.PI),qe<0&&($e+=Math.PI);let We=de+ue+(qe>0?0:1)|0,He=ce,Xe=ce,Ye=0,Je=0;const Qe=Math.abs(Ze),tt=[],rt=[];let ot=he,st=ot;const P=()=>cv(st,ot,Xe,Qe-Ye+1,ve,Se,Oe,je.canonical);for(;Ye+Je<=Qe;){if(We+=qe,We<de||We>=_e)return null;if(Xe=He,st=ot,tt.push(Xe),Ae&&rt.push(st),ot=new Ne(ye.getx(We),ye.gety(We)),He=Me[We],!He){const C=lv(ot,je.canonical,ve,Oe,Se);He=C[3]>0?Me[We]=C:P()}Ye+=Je,Je=Ld.distance(Xe,He)}Ce&&Se&&(Me[We]&&(He=P(),Je=Ld.distance(Xe,He)),Me[We]=He);const at=(Qe-Ye)/Je,lt=ot.sub(st)._mult(at)._add(st),ct=Ld.sub([],He,Xe),ht=Ld.scaleAndAdd([],Xe,ct,at);let pt=[0,0,1],ft=ct[0],mt=ct[1];if(Ge&&(pt=Oe.upVector(je.canonical,lt.x,lt.y),0!==pt[0]||0!==pt[1]||1!==pt[2])){const C=[pt[2],0,-pt[0]],H=Ld.cross([],pt,C);Ld.normalize(C,C),Ld.normalize(H,H),ft=Ld.dot(ct,C),mt=Ld.dot(ct,H)}if(te){const C=Ld.cross([],pt,ct);Ld.normalize(C,C),Ld.scaleAndAdd(ht,ht,C,te*qe)}const Ct=$e+Math.atan2(mt,ft);return tt.push(ht),Ae&&rt.push(lt),{point:ht,angle:Ct,path:tt,tilePath:rt,up:pt}}function uv(C,H){const te=H.length,le=te+4*C;H.resize(le),H.float32.fill(-1/0,4*te,4*le)}function dv(C,H,te){const le=H[0],ce=H[1];return C[0]=te[0]*le+te[4]*ce+te[12],C[1]=te[1]*le+te[5]*ce+te[13],C[3]=te[3]*le+te[7]*ce+te[15],C}const pv=(C,H,te)=>(1-te)*C+te*H,fv=C=>C*C*C*C*C;class mv{constructor(C,H,te,le,ce,he,ue){this.tileSize=512,this._renderWorldCopies=void 0===ce||ce,this._minZoom=C||0,this._maxZoom=H||22,this._minPitch=null==te?0:te,this._maxPitch=null==le?60:le,this.setProjection(he),this.setMaxBounds(ue),this.width=0,this.height=0,this._center=new Of(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new Bx,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._distanceTileDataCache={},this._camera=new jx,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1}clone(){const C=new mv(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection());return C._elevation=this._elevation,C._centerAltitude=this._centerAltitude,C._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,C.tileSize=this.tileSize,C.mercatorFromTransition=this.mercatorFromTransition,C.width=this.width,C.height=this.height,C.cameraElevationReference=this.cameraElevationReference,C._center=this._center,C._setZoom(this.zoom),C._seaLevelZoom=this._seaLevelZoom,C.angle=this.angle,C._fov=this._fov,C._pitch=this._pitch,C._nearZ=this._nearZ,C._farZ=this._farZ,C._averageElevation=this._averageElevation,C._unmodified=this._unmodified,C._edgeInsets=this._edgeInsets.clone(),C._camera=this._camera.clone(),C._calcMatrices(),C.freezeTileCoverage=this.freezeTileCoverage,C.frustumCorners=this.frustumCorners,C}get isOrthographic(){return"globe"!==this.projection.name&&this._orthographicProjectionAtLowPitch&&this.pitch<15}get elevation(){return this._elevation}set elevation(C){this._elevation!==C&&(this._elevation=C,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return"globe"!==this.projection.name&&!this.isOrthographic}updateElevation(C,H=!1){const te=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(null==this._seaLevelZoom||te)&&this._updateCameraOnTerrain(),(C||te)&&this._constrainCamera(H),this._calcMatrices()}getProjection(){return O(this.projection,["name","center","parallels"])}setProjection(C){this.projectionOptions=C||{name:"mercator"};const H=this.projection?this.getProjection():void 0;this.projection=Hg(this.projectionOptions);const te=!x(H,this.getProjection());return te&&this._calcMatrices(),this.mercatorFromTransition=!1,te}setOrthographicProjectionAtLowPitch(C){return this._orthographicProjectionAtLowPitch!==C&&(this._orthographicProjectionAtLowPitch=C,this._calcMatrices(),!0)}setMercatorFromTransition(){const C=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=Hg({name:"mercator"});const H=C!==this.projection.name;return H&&this._calcMatrices(),H}get minZoom(){return this._minZoom}set minZoom(C){this._minZoom!==C&&(this._minZoom=C,this.zoom=Math.max(this.zoom,C))}get maxZoom(){return this._maxZoom}set maxZoom(C){this._maxZoom!==C&&(this._maxZoom=C,this.zoom=Math.min(this.zoom,C))}get minPitch(){return this._minPitch}set minPitch(C){this._minPitch!==C&&(this._minPitch=C,this.pitch=Math.max(this.pitch,C))}get maxPitch(){return this._maxPitch}set maxPitch(C){this._maxPitch!==C&&(this._maxPitch=C,this.pitch=Math.min(this.pitch,C))}get renderWorldCopies(){return this._renderWorldCopies&&!0===this.projection.supportsWorldCopies}set renderWorldCopies(C){void 0===C?C=!0:null===C&&(C=!1),this._renderWorldCopies=C}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const C=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(C))}get cameraWorldSize(){const C=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(C))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return Zd(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new Ne(this.width,this.height)}get bearing(){return P(this.rotation,-180,180)}set bearing(C){this.rotation=C}get rotation(){return-this.angle/Math.PI*180}set rotation(C){const H=-C*Math.PI/180;this.angle!==H&&(this._unmodified=!1,this.angle=H,this._calcMatrices(),this.rotationMatrix=Xu.create(),Xu.rotate(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(C){const H=z(C,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==H&&(this._unmodified=!1,this._pitch=H,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}get fovX(){return this._fov}get fovY(){const C=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/C)}set fov(C){C=Math.max(.01,Math.min(60,C)),this._fov!==C&&(this._unmodified=!1,this._fov=w(C),this._calcMatrices())}get averageElevation(){return this._averageElevation}set averageElevation(C){this._averageElevation=C,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(C){const H=Math.min(Math.max(C,this.minZoom),this.maxZoom);this._zoom!==H&&(this._unmodified=!1,this._setZoom(H),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(C){this._zoom=C,this.scale=this.zoomScale(C),this.tileZoom=Math.floor(C),this.zoomFraction=C-this.tileZoom}_updateCameraOnTerrain(){const C=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,H=this.elevation&&C===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||C===Number.NEGATIVE_INFINITY&&(!H||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const te=this._elevation;H||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&te.exaggeration()&&this._centerAltitudeValidForExaggeration!==te.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*te.exaggeration(),this._centerAltitudeValidForExaggeration=te.exaggeration()):(this._centerAltitude=C||0,this._centerAltitudeValidForExaggeration=te.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){void 0!==this._centerAltitudeValidForExaggeration&&(this._seaLevelZoom=this._zoomFromMercatorZ((this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize))}sampleAverageElevation(){if(!this._elevation)return 0;const C=this._elevation,H=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],te=this.horizonLineFromTop();let le=0,ce=0;for(let he=0;he<H.length;he++){const ue=new Ne(H[he][0]*this.width,te+H[he][1]*(this.height-te)),de=C.pointCoordinate(ue);if(!de)continue;const _e=1/Math.hypot(de[0]-this._camera.position[0],de[1]-this._camera.position[1]);le+=de[3]*_e,ce+=_e}return 0===ce?NaN:le/ce}get center(){return this._center}set center(C){C.lat===this._center.lat&&C.lng===this._center.lng||(this._unmodified=!1,this._center=C,this._terrainEnabled()&&("ground"===this.cameraElevationReference?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(null==this._seaLevelZoom||!this._elevation)return;const C=this._seaLevelZoom,H=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),te=this.pixelsPerMeter/this.worldSize*H,le=this._mercatorZfromZoom(C),ce=this._mercatorZfromZoom(this._maxZoom),he=Math.max(le-te,ce);this._setZoom(this._zoomFromMercatorZ(he))}get padding(){return this._edgeInsets.toJSON()}set padding(C){this._edgeInsets.equals(C)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,C,1),this._calcMatrices())}computeZoomRelativeTo(C){const H=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,C.toAltitude()));let te;te=C.z<this._camera.position[2]?[H.x,H.y,H.z]:[C.x,C.y,C.z];const le=Ld.length(Ld.sub([],this._camera.position,te));return z(this._zoomFromMercatorZ(le),this._minZoom,this._maxZoom)}setFreeCameraOptions(C){if(!this.height)return;if(!C.position&&!C.orientation)return;this._updateCameraState();let H=!1;if(C.orientation&&!id.exactEquals(C.orientation,this._camera.orientation)&&(H=this._setCameraOrientation(C.orientation)),C.position){const te=[C.position.x,C.position.y,C.position.z];Ld.exactEquals(te,this._camera.position)||(this._setCameraPosition(te),H=!0)}H&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const C=this._camera.position,H=new Vx;return H.position=new ep(C[0],C[1],C[2]),H.orientation=this._camera.orientation,H._elevation=this.elevation,H._renderWorldCopies=this.renderWorldCopies,H}_setCameraOrientation(C){if(!id.length(C))return!1;id.normalize(C,C);const H=Ld.transformQuat([],[0,0,-1],C),te=Ld.transformQuat([],[0,-1,0],C);if(te[2]<0)return!1;const le=Ux(H,te);return!!le&&(this._camera.orientation=le,!0)}_setCameraPosition(C){const H=this.zoomScale(this.minZoom)*this.tileSize,te=this.zoomScale(this.maxZoom)*this.tileSize,le=this.cameraToCenterDistance;C[2]=z(C[2],le/te,le/H),this._camera.position=C}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(C){return this._edgeInsets.equals(C)}interpolatePadding(C,H,te){this._unmodified=!1,this._edgeInsets.interpolate(C,H,te),this._constrain(),this._calcMatrices()}coveringZoomLevel(C){const H=(C.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/C.tileSize));return Math.max(0,H)}getVisibleUnwrappedCoordinates(C){const H=[new Ou(0,C)];if(this.renderWorldCopies){const te=this.pointCoordinate(new Ne(0,0)),le=this.pointCoordinate(new Ne(this.width,0)),ce=this.pointCoordinate(new Ne(this.width,this.height)),he=this.pointCoordinate(new Ne(0,this.height)),ue=Math.floor(Math.min(te.x,le.x,ce.x,he.x)),de=Math.floor(Math.max(te.x,le.x,ce.x,he.x)),_e=1;for(let te=ue-_e;te<=de+_e;te++)0!==te&&H.push(new Ou(te,C))}return H}isLODDisabled(C){return(!C||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCoverForShadows(C,H,te){let le=[];if(0===H[0]&&0===H[1])return le;for(const te of C){const C=te.canonical,ce=te.overscaledZ,he=te.wrap,ue=1<<C.z,de=C.x+1<ue,_e=C.x>0,ye=C.y+1<ue,ve=C.y>0,Me=te.wrap-(_e?0:1),Se=te.wrap+(de?0:1),Ae=_e?C.x-1:ue-1,Ce=de?C.x+1:0;H[0]<0?(le.push(new Bu(ce,Se,C.z,Ce,C.y)),H[1]<0&&ye&&(le.push(new Bu(ce,he,C.z,C.x,C.y+1)),le.push(new Bu(ce,Se,C.z,Ce,C.y+1))),H[1]>0&&ve&&(le.push(new Bu(ce,he,C.z,C.x,C.y-1)),le.push(new Bu(ce,Se,C.z,Ce,C.y-1)))):H[0]>0?(le.push(new Bu(ce,Me,C.z,Ae,C.y)),H[1]<0&&ye&&(le.push(new Bu(ce,he,C.z,C.x,C.y+1)),le.push(new Bu(ce,Me,C.z,Ae,C.y+1))),H[1]>0&&ve&&(le.push(new Bu(ce,he,C.z,C.x,C.y-1)),le.push(new Bu(ce,Me,C.z,Ae,C.y-1)))):H[1]<0&&ye?le.push(new Bu(ce,he,C.z,C.x,C.y+1)):ve&&le.push(new Bu(ce,he,C.z,C.x,C.y-1))}if(le.length>1){le.sort(((C,H)=>C.overscaledZ-H.overscaledZ||C.wrap-H.wrap||C.canonical.z-H.canonical.z||C.canonical.x-H.canonical.x||C.canonical.y-H.canonical.y));let C=0,H=0;for(;H<le.length;)le[H].equals(le[C])?++H:le[++C]=le[H++];le.length=C+1}const ce=[];for(const C of le)le.some((H=>C.isChildOf(H)))||ce.push(C);return le=ce.filter((H=>!C.some((C=>!!(H.overscaledZ<te&&C.isChildOf(H))||H.equals(C)||H.isChildOf(C))))),le}coveringTiles(C){let H=this.coveringZoomLevel(C);const te=H,le=this.elevation&&this.elevation.exaggeration(),ce=le&&!C.isTerrainDEM,he="mercator"===this.projection.name;if(void 0!==C.minzoom&&H<C.minzoom)return[];void 0!==C.maxzoom&&H>C.maxzoom&&(H=C.maxzoom);const ue=this.locationCoordinate(this.center),de=this.center.lat,_e=1<<H,ye=[_e*ue.x,_e*ue.y,0],ve="globe"===this.projection.name,Me=!ve,Se=$u.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,H,Me),Ae=ve?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),Ce=_e*Zd(1,this.center.lat),Oe=this._camera.position[2]/Zd(1,this.center.lat),Ne=[_e*Ae.x,_e*Ae.y,Oe*(Me?1:Ce)],je=ve||le,Ge=this.cameraToCenterDistance/C.tileSize*(C.roundZoom?1:.502),qe=this.isLODDisabled(!0)?H:0,$e=C.isTerrainDEM&&this._elevation?1e4*this._elevation.exaggeration():this._centerAltitude,We=C.isTerrainDEM?-$e:this._elevation?this._elevation.getMinElevationBelowMSL():0,He=this.projection.isReprojectedInTileSpace?qx(this):1,T=C=>{const H=1/4e4,te=new ep(C.x+H,C.y,C.z),le=new ep(C.x,C.y+H,C.z),ce=C.toLngLat(),he=te.toLngLat(),ue=le.toLngLat(),de=this.locationCoordinate(ce),_e=this.locationCoordinate(he),ye=this.locationCoordinate(ue),ve=Math.hypot(_e.x-de.x,_e.y-de.y),Me=Math.hypot(ye.x-de.x,ye.y-de.y);return Math.sqrt(ve*Me)*He/H},M=C=>{const H=$e,te=We;return{aabb:Eg(this,_e,0,0,0,C,te,H,this.projection),zoom:0,x:0,y:0,minZ:te,maxZ:H,wrap:C,fullyVisible:!1}},Xe=[];let Ye=[];const Je=H,Qe=C.reparseOverscaled?te:H,z=C=>C*C,tt=z((Oe-this._centerAltitude)*Ce),P=C=>{if(!this._elevation||!C.tileID||!he)return;const H=this._elevation.getMinMaxForTile(C.tileID),te=C.aabb;H?(te.min[2]=H.min,te.max[2]=H.max,te.center[2]=(te.min[2]+te.max[2])/2):(C.shouldSplit=R(C),C.shouldSplit||(te.min[2]=te.max[2]=te.center[2]=this._centerAltitude))},R=C=>{if(C.zoom<qe)return!0;if(C.zoom===Je)return!1;if(null!=C.shouldSplit)return C.shouldSplit;const H=C.aabb.distanceX(Ne),le=C.aabb.distanceY(Ne);let he=tt,ue=1;if(ve){he=z(C.aabb.distanceZ(Ne));const H=Math.pow(2,C.zoom),te=Hd((C.y+1)/H),le=Hd(C.y/H),ce=Math.min(Math.max(de,te),le),_e=jd(ce)/jd(de);if(ue=ce===de?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,_e/this._mercatorScaleRatio),this.zoom<=Dp&&C.zoom===Je-1&&_e>=.9)return!0}else if(ce&&(he=z(C.aabb.distanceZ(Ne)*Ce)),this.projection.isReprojectedInTileSpace&&te<=5){const H=Math.pow(2,C.zoom),te=T(new ep((C.x+.5)/H,(C.y+.5)/H));ue=te>.85?1:te}const _e=H*H+le*le+he,ye=z((1<<Je-C.zoom)*Ge*ue*((C,H)=>{if(H*z(.707)<C)return 1;const te=Math.sqrt(H/C);return te/(1.4144271570014144+(Math.pow(1.1,te-1.4144271570014144+1)-1)/(1.1-1)-1)})(Math.max(he,tt),_e));return _e<ye};if(this.renderWorldCopies)for(let C=1;C<=3;C++)Xe.push(M(-C)),Xe.push(M(C));for(Xe.push(M(0));Xe.length>0;){const te=Xe.pop(),le=te.x,ue=te.y;let de=te.fullyVisible;const u=()=>"globe"===this.projection.name&&(0===te.y||te.y===(1<<te.zoom)-1);if(!de){let C=je?te.aabb.intersects(Se):te.aabb.intersectsFlat(Se);if(0===C&&u()){const H=new ku(te.zoom,le,ue);C=ud(this,_e,H,!0).intersects(Se)}if(0===C)continue;de=2===C}if(te.zoom!==Je&&R(te))for(let C=0;C<4;C++){const H=(le<<1)+C%2,ye=(ue<<1)+(C>>1),Me={aabb:he?te.aabb.quadrant(C):Eg(this,_e,te.zoom+1,H,ye,te.wrap,te.minZ,te.maxZ,this.projection),zoom:te.zoom+1,x:H,y:ye,wrap:te.wrap,fullyVisible:de,tileID:void 0,shouldSplit:void 0,minZ:te.minZ,maxZ:te.maxZ};ce&&!ve&&(Me.tileID=new Bu(te.zoom+1===Je?Qe:te.zoom+1,te.wrap,te.zoom+1,H,ye),P(Me)),Xe.push(Me)}else{const ce=te.zoom===Je?Qe:te.zoom;if(C.minzoom&&C.minzoom>ce)continue;if(!de){let C=je?te.aabb.intersectsPrecise(Se):te.aabb.intersectsPreciseFlat(Se);if(0===C&&u()){const H=new ku(te.zoom,le,ue);C=ud(this,_e,H,!0).intersectsPrecise(Se)}if(0===C)continue}const he=ye[0]-(.5+le+(te.wrap<<te.zoom))*(1<<H-te.zoom),ve=ye[1]-.5-ue,Me=te.tileID?te.tileID:new Bu(ce,te.wrap,te.zoom,le,ue);Ye.push({tileID:Me,distanceSq:he*he+ve*ve})}}if(this.fogCullDistSq){const H=this.fogCullDistSq,te=this.horizonLineFromTop();Ye=Ye.filter((le=>{const ce=[0,0,0,1],he=[wn,wn,0,1],ue=this.calculateFogTileMatrix(le.tileID.toUnwrapped());Lu.transformMat4(ce,ce,ue),Lu.transformMat4(he,he,ue);const de=function(C,H,te){let le=0;for(let te=0;te<2;++te){const ce=0;C[te]>ce&&(le+=(C[te]-ce)*(C[te]-ce)),H[te]<ce&&(le+=(ce-H[te])*(ce-H[te]))}return le}(Lu.min([],ce,he),Lu.max([],ce,he));if(0===de)return!0;let _e=!1;const ye=this._elevation;if(ye&&de>H&&0!==te){const H=this.calculateProjMatrix(le.tileID.toUnwrapped());let ce;C.isTerrainDEM||(ce=ye.getMinMaxForTile(le.tileID)),ce||(ce={min:We,max:$e});const he=function(C){const H=Math.round((C+45+360)%360/90)%4;return Ze[H]}(this.rotation),ue=[he[0]*wn,he[1]*wn,ce.max];Ld.transformMat4(ue,ue,H),_e=(1-ue[1])*this.height*.5<te}return de<H||_e}))}return Ye.sort(((C,H)=>C.distanceSq-H.distanceSq)).map((C=>C.tileID))}resize(C,H){this.width=C,this.height=H,this.pixelsToGLUnits=[2/C,-2/H],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(C){return Math.pow(2,C)}scaleZoom(C){return Math.log(C)/Math.LN2}project(C){const H=z(C.lat,-Uf,Uf),te=this.projection.project(C.lng,H);return new Ne(te.x*this.worldSize,te.y*this.worldSize)}unproject(C){return this.projection.unproject(C.x/this.worldSize,C.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/Zd(1,this.center.lat)/this.worldSize}setLocationAtPoint(C,H){let te,le;const ce=this.centerPoint;if("globe"===this.projection.name){const C=this.worldSize;te=(H.x-ce.x)/C,le=(H.y-ce.y)/C}else{const C=this.pointCoordinate(H),he=this.pointCoordinate(ce);te=C.x-he.x,le=C.y-he.y}const he=this.locationCoordinate(C);this.setLocation(new ep(he.x-te,he.y-le))}setLocation(C){this.center=this.coordinateLocation(C),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(C){return this.projection.locationPoint(this,C)}locationPoint3D(C){return this.projection.locationPoint(this,C,!0)}pointLocation(C){return this.coordinateLocation(this.pointCoordinate(C))}pointLocation3D(C){return this.coordinateLocation(this.pointCoordinate3D(C))}locationCoordinate(C,H){const te=H?Zd(H,C.lat):void 0,le=this.projection.project(C.lng,C.lat);return new ep(le.x,le.y,te)}coordinateLocation(C){return this.projection.unproject(C.x,C.y)}pointRayIntersection(C,H){const te=null!=H?H:this._centerAltitude,le=[C.x,C.y,0,1],ce=[C.x,C.y,1,1];Lu.transformMat4(le,le,this.pixelMatrixInverse),Lu.transformMat4(ce,ce,this.pixelMatrixInverse);const he=ce[3];Lu.scale(le,le,1/le[3]),Lu.scale(ce,ce,1/he);const ue=le[2],de=ce[2];return{p0:le,p1:ce,t:ue===de?0:(te-ue)/(de-ue)}}screenPointToMercatorRay(C){const H=[C.x,C.y,0,1],te=[C.x,C.y,1,1];return Lu.transformMat4(H,H,this.pixelMatrixInverse),Lu.transformMat4(te,te,this.pixelMatrixInverse),Lu.scale(H,H,1/H[3]),Lu.scale(te,te,1/te[3]),H[2]=Zd(H[2],this._center.lat)*this.worldSize,te[2]=Zd(te[2],this._center.lat)*this.worldSize,Lu.scale(H,H,1/this.worldSize),Lu.scale(te,te,1/this.worldSize),new Uu([H[0],H[1],H[2]],Ld.normalize([],Ld.sub([],te,H)))}rayIntersectionCoordinate(C){const{p0:H,p1:te,t:le}=C,ce=Zd(H[2],this._center.lat),he=Zd(te[2],this._center.lat);return new ep(Wr(H[0],te[0],le)/this.worldSize,Wr(H[1],te[1],le)/this.worldSize,Wr(ce,he,le))}pointCoordinate(C,H=this._centerAltitude){return this.projection.pointCoordinate(this,C.x,C.y,H)}pointCoordinate3D(C){if(!this.elevation)return this.pointCoordinate(C);let H=this.projection.pointCoordinate3D(this,C.x,C.y);if(H)return new ep(H[0],H[1],H[2]);let te=0,le=this.horizonLineFromTop();if(C.y>le)return this.pointCoordinate(C);const ce=.02*le,he=C.clone();for(let C=0;C<10&&le-te>ce;C++){he.y=Wr(te,le,.66);const C=this.projection.pointCoordinate3D(this,he.x,he.y);C?(le=he.y,H=C):te=he.y}return H?new ep(H[0],H[1],H[2]):this.pointCoordinate(C)}isPointAboveHorizon(C){return this.projection.isPointAboveHorizon(this,C)}isPointOnSurface(C){if(C.y<0||C.y>this.height||C.x<0||C.x>this.width)return!1;if(this.elevation||this.zoom>=Pp)return!this.isPointAboveHorizon(C);const H=this.pointCoordinate(C);return H.y>=0&&H.y<=1}_coordinatePoint(C,H){const te=H&&this.elevation?this.elevation.getAtPointOrZero(C,this._centerAltitude):this._centerAltitude,le=[C.x*this.worldSize,C.y*this.worldSize,te+C.toAltitude(),1];return Lu.transformMat4(le,le,this.pixelMatrix),le[3]>0?new Ne(le[0]/le[3],le[1]/le[3]):new Ne(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:C,left:H}=this._edgeInsets,te=this.height-this._edgeInsets.bottom,le=this.width-this._edgeInsets.right,ce=this.pointLocation3D(new Ne(H,C)),he=this.pointLocation3D(new Ne(le,C)),ue=this.pointLocation3D(new Ne(le,te)),de=this.pointLocation3D(new Ne(H,te));let _e=Math.min(ce.lng,he.lng,ue.lng,de.lng),ye=Math.max(ce.lng,he.lng,ue.lng,de.lng),ve=Math.min(ce.lat,he.lat,ue.lat,de.lat),Me=Math.max(ce.lat,he.lat,ue.lat,de.lat);const Se=Math.pow(2,-this.zoom)/16*270,Ae="globe"===this.projection.name?1:4,f=(C,H,te,le,ce)=>{const he=(C+te)/2,ue=(H+le)/2,de=new Ne(he,ue),{lng:Ce,lat:Oe}=this.pointLocation3D(de),je=Math.max(0,_e-Ce,ve-Oe,Ce-ye,Oe-Me);_e=Math.min(_e,Ce),ye=Math.max(ye,Ce),ve=Math.min(ve,Oe),Me=Math.max(Me,Oe),(ce<Ae||je>Se)&&(f(C,H,he,ue,ce+1),f(he,ue,te,le,ce+1))};if(f(H,C,le,C,1),f(le,C,le,te,1),f(le,te,H,te,1),f(H,te,H,C,1),"globe"===this.projection.name){const[C,H]=function(C){const H=ed.identity(new Float64Array(16));ed.multiply(H,C.pixelMatrix,C.globeMatrix);const te=[0,Xp,0],le=[0,Kp,0];return Ld.transformMat4(te,te,H),Ld.transformMat4(le,le,H),[te[0]>0&&te[0]<=C.width&&te[1]>0&&te[1]<=C.height&&!Dd(C,new Of(C.center.lat,90)),le[0]>0&&le[0]<=C.width&&le[1]>0&&le[1]<=C.height&&!Dd(C,new Of(C.center.lat,-90))]}(this);C?(Me=90,ye=180,_e=-180):H&&(ve=-90,ye=180,_e=-180)}return new Ql(new Of(_e,ve),new Of(ye,Me))}_getBoundsRectangular(C,H){const{top:te,left:le}=this._edgeInsets,ce=this.height-this._edgeInsets.bottom,he=this.width-this._edgeInsets.right,ue=new Ne(le,te),de=new Ne(he,te),_e=new Ne(he,ce),ye=new Ne(le,ce);let ve=this.pointCoordinate(ue,C),Me=this.pointCoordinate(de,C);const Se=this.pointCoordinate(_e,H),Ae=this.pointCoordinate(ye,H),f=(C,H)=>(H.y-C.y)/(H.x-C.x);return ve.y>1&&Me.y>=0?ve=new ep((1-Ae.y)/f(Ae,ve)+Ae.x,1):ve.y<0&&Me.y<=1&&(ve=new ep(-Ae.y/f(Ae,ve)+Ae.x,0)),Me.y>1&&ve.y>=0?Me=new ep((1-Se.y)/f(Se,Me)+Se.x,1):Me.y<0&&ve.y<=1&&(Me=new ep(-Se.y/f(Se,Me)+Se.x,0)),(new Ql).extend(this.coordinateLocation(ve)).extend(this.coordinateLocation(Me)).extend(this.coordinateLocation(Ae)).extend(this.coordinateLocation(Se))}_getBoundsRectangularTerrain(){const C=this.elevation;if(!C.visibleDemTiles.length||C.isUsingMockSource())return this._getBoundsRectangular(0,0);const H=C.visibleDemTiles.reduce(((C,H)=>{if(H.dem){const te=H.dem.tree;C.min=Math.min(C.min,te.minimums[0]),C.max=Math.max(C.max,te.maximums[0])}return C}),{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(H.min*C.exaggeration(),H.max*C.exaggeration())}getBounds(){return"mercator"===this.projection.name||"equirectangular"===this.projection.name?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(C=!0){const H=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,te=this.height/2-H*(1-this._horizonShift);return C?Math.max(0,te):te}getMaxBounds(){return this.maxBounds}setMaxBounds(C){this.maxBounds=C,this.minLat=-Uf,this.maxLat=Uf,this.minLng=-180,this.maxLng=180,C&&(this.minLat=C.getSouth(),this.maxLat=C.getNorth(),this.minLng=C.getWest(),this.maxLng=C.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=Gd(this.minLng)*this.tileSize,this.worldMaxX=Gd(this.maxLng)*this.tileSize,this.worldMinY=qd(this.maxLat)*this.tileSize,this.worldMaxY=qd(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(C,H){return this.projection.createTileMatrix(this,H,C)}calculateDistanceTileData(C){const H=C.key,te=this._distanceTileDataCache;if(te[H])return te[H];const le=C.canonical,ce=1/this.height,he=this.cameraWorldSize,ue=he/this.zoomScale(le.z),de=(le.x+Math.pow(2,le.z)*C.wrap)*ue,_e=le.y*ue,ye=this.point;ye.x*=he/this.worldSize,ye.y*=he/this.worldSize;const ve=this.angle,Me=Math.sin(-ve),Se=-Math.cos(-ve);return te[H]={bearing:[Me,Se],center:[(ye.x-de)*ce,(ye.y-_e)*ce],scale:ue/wn*ce},te[H]}calculateFogTileMatrix(C){const H=C.key,te=this._fogTileMatrixCache;if(te[H])return te[H];const le=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,C);return ed.multiply(le,this.worldToFogMatrix,le),te[H]=new Float32Array(le),te[H]}calculateProjMatrix(C,H=!1){const te=C.key,le=H?this._alignedProjMatrixCache:this._projMatrixCache;if(le[te])return le[te];const ce=this.calculatePosMatrix(C,this.worldSize);return ed.multiply(ce,this.projection.isReprojectedInTileSpace?this.mercatorMatrix:H?this.alignedProjMatrix:this.projMatrix,ce),le[te]=new Float32Array(ce),le[te]}calculatePixelsToTileUnitsMatrix(C){const H=C.tileID.key,te=this._pixelsToTileUnitsCache;if(te[H])return te[H];const le=function(C,H){const{scale:te}=C.tileTransform,le=te*wn/(C.tileSize*Math.pow(2,H.zoom-C.tileID.overscaledZ+C.tileID.canonical.z));return Xu.scale(new Float32Array(4),H.inverseAdjustmentMatrix,[le,le])}(C,this);return te[H]=le,te[H]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if("globe"===this.projection.name){const C=1/this.worldSize,H=ed.fromScaling([],[C,C,C]);return ed.multiply(H,H,this.globeMatrix),H}}recenterOnTerrain(){if(!this._elevation||"globe"===this.projection.name)return;const C=this._elevation;this._updateCameraState();const H=Zd(1,this._center.lat)*this.worldSize,te=this._computeCameraPosition(H),le=this._camera.forward(),ce=Zd(1,this._center.lat);te[2]/=ce,le[2]/=ce,Ld.normalize(le,le);const he=C.raycast(te,le,C.exaggeration());if(he){const C=Ld.scaleAndAdd([],te,le,he),H=new ep(C[0],C[1],Zd(C[2],Hd(C[1]))),ue=(H.z+Ld.length([H.x-te[0],H.y-te[1],H.z-te[2]*ce]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(ue),this._centerAltitude=H.toAltitude(),this._center=this.coordinateLocation(H),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(C=!1){if(!this._elevation)return;const H=this._elevation,te=Zd(1,this._center.lat)*this.worldSize,le=this._computeCameraPosition(te),ce=H.getAtPointOrZero(new ep(...le)),he=this.pixelsPerMeter/this.worldSize*ce,ue=this._minimumHeightOverTerrain(),de=le[2]-he;if(de<=ue)if(de<0||C){const C=this.locationCoordinate(this._center,this._centerAltitude),H=[le[0],le[1],C.z-le[2]],te=Ld.length(H);H[2]-=(ue-de)/this._pixelsPerMercatorPixel;const ce=Ld.length(H);if(0===ce)return;Ld.scale(H,H,te/ce*this._pixelsPerMercatorPixel),this._camera.position=[le[0],le[1],C.z*this._pixelsPerMercatorPixel-H[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const C="globe"===this.projection.name||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||C){const H=this.center;return H.lat=z(H.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!C)&&(H.lng=z(H.lng,this.minLng,this.maxLng)),this.center=H,void(this._constraining=!1)}const H=this._unmodified,{x:te,y:le}=this.point;let ce=0,he=te,ue=le;const de=this.width/2,_e=this.height/2,ye=this.worldMinY*this.scale,ve=this.worldMaxY*this.scale;if(le-_e<ye&&(ue=ye+_e),le+_e>ve&&(ue=ve-_e),ve-ye<this.height&&(ce=Math.max(ce,this.height/(ve-ye)),ue=(ve+ye)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const C=this.worldMinX*this.scale,H=this.worldMaxX*this.scale,le=this.worldSize/2-(C+H)/2;he=(te+le+this.worldSize)%this.worldSize-le,he-de<C&&(he=C+de),he+de>H&&(he=H-de),H-C<this.width&&(ce=Math.max(ce,this.width/(H-C)),he=(H+C)/2)}he===te&&ue===le||(this.center=this.unproject(new Ne(he,ue))),ce&&(this.zoom+=this.scaleZoom(ce)),this._constrainCamera(),this._unmodified=H,this._constraining=!1}_minZoomForBounds(){let C=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(C=Math.max(C,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),C}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const C=this.centerOffset,H="globe"===this.projection.name,te=this.pixelsPerMeter;"globe"===this.projection.name&&(this._mercatorScaleRatio=Zd(1,this.center.lat)/Zd(1,45));const le=Zx(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,le),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const ce="meters"===this.projection.zAxisUnit?te:1,he=this._camera.getWorldToCamera(this.worldSize,ce);let ue;const de=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(de[8]=2*-C.x/this.width,de[9]=2*C.y/this.height,this.isOrthographic){let H=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),te=H*this.aspect,le=-te,ce=-H;te-=C.x,le-=C.x,H+=C.y,ce+=C.y,ue=this._camera.getCameraToClipOrthographic(le,te,ce,H,this._nearZ,this._farZ),((C,H,te,le)=>{for(let ce=0;ce<16;ce++)C[ce]=pv(H[ce],te[ce],le)})(ue,ue,de,fv(this.pitch>=15?1:this.pitch/15))}else ue=de;const _e=ed.mul([],de,he);let ye=ed.mul([],ue,he);if(this.projection.isReprojectedInTileSpace){const C=this.locationCoordinate(this.center),H=ed.identity([]);ed.translate(H,H,[C.x*this.worldSize,C.y*this.worldSize,0]),ed.multiply(H,H,Gx(this)),ed.translate(H,H,[-C.x*this.worldSize,-C.y*this.worldSize,0]),ed.multiply(ye,ye,H),ed.multiply(_e,_e,H),this.inverseAdjustmentMatrix=function(C){const H=Gx(C,!0);return Xu.invert([],[H[0],H[1],H[4],H[5]])}(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];this.mercatorMatrix=ed.scale([],ye,[this.worldSize,this.worldSize,this.worldSize/ce,1]),this.projMatrix=ye,this.invProjMatrix=ed.invert(new Float64Array(16),this.projMatrix);const ve=ed.invert([],ue);this.frustumCorners=Vu.fromInvProjectionMatrix(ve,this.horizonLineFromTop(),this.height),this.cameraFrustum=$u.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!H);const Me=new Float32Array(16);ed.identity(Me),ed.scale(Me,Me,[1,-1,1]),ed.rotateX(Me,Me,this._pitch),ed.rotateZ(Me,Me,this.angle);const Se=ed.perspective(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=ed.clone(Se);const Ae=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;Se[8]=2*-C.x/this.width,Se[9]=2*(C.y+Ae)/this.height,this.skyboxMatrix=ed.multiply(Me,Se,Me);const Ce=this.point,Oe=Ce.x,Ne=Ce.y,je=this.width%2/2,Ge=this.height%2/2,Ze=Math.cos(this.angle),qe=Math.sin(this.angle),$e=Oe-Math.round(Oe)+Ze*je+qe*Ge,We=Ne-Math.round(Ne)+Ze*Ge+qe*je,He=new Float64Array(ye);if(ed.translate(He,He,[$e>.5?$e-1:$e,We>.5?We-1:We,0]),this.alignedProjMatrix=He,ye=ed.create(),ed.scale(ye,ye,[this.width/2,-this.height/2,1]),ed.translate(ye,ye,[1,-1,0]),this.labelPlaneMatrix=ye,ye=ed.create(),ed.scale(ye,ye,[1,-1,1]),ed.translate(ye,ye,[-1,-1,0]),ed.scale(ye,ye,[2/this.width,2/this.height,1]),this.glCoordMatrix=ye,this.pixelMatrix=ed.multiply(new Float64Array(16),this.labelPlaneMatrix,_e),this._calcFogMatrices(),this._distanceTileDataCache={},ye=ed.invert(new Float64Array(16),this.pixelMatrix),!ye)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=ye,"globe"===this.projection.name||this.mercatorFromTransition){this.globeMatrix=function(C){const{x:H,y:te}=C.point,{lng:le,lat:ce}=C._center;return Td(H,te,C.worldSize,le,ce)}(this);const C=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=Ld.transformMat4(C,C,he),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=ye;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const C=this.cameraWorldSizeForFog,H=this.cameraPixelsPerMeter,te=this._camera.position,le=1/this.height/this._pixelsPerMercatorPixel,ce=[C,C,H];Ld.scale(ce,ce,le),Ld.scale(te,te,-1),Ld.multiply(te,te,ce);const he=ed.create();ed.translate(he,he,te),ed.scale(he,he,ce),this.mercatorFogMatrix=he,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(C,H,le)}_computeCameraPosition(C){const H=(C=C||this.pixelsPerMeter)/this.pixelsPerMeter,te=this._camera.forward(),le=this.point,ce=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*H-C/this.worldSize*this._centerAltitude;return[le.x/this.worldSize-te[0]*ce,le.y/this.worldSize-te[1]*ce,C/this.worldSize*this._centerAltitude-te[2]*ce]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(C){const H=this._maxCameraBoundsDistance()*Math.cos(this._pitch),te=this._camera.position[2],le=C[2];let ce=1;this.projection.wrap&&(this.center=this.center.wrap()),le>0&&(ce=Math.min((H-te)/le,1)),this._camera.position=Ld.scaleAndAdd([],this._camera.position,C,ce),this._updateStateFromCamera()}_updateStateFromCamera(){const C=this._camera.position,H=this._camera.forward(),{pitch:te,bearing:le}=this._camera.getPitchBearing(),ce=Zd(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,he=this._mercatorZfromZoom(this._maxZoom)*Math.cos(w(this._maxPitch)),ue=Math.max((C[2]-ce)/Math.cos(te),he),de=this._zoomFromMercatorZ(ue);Ld.scaleAndAdd(C,C,H,ue),this._pitch=z(te,w(this.minPitch),w(this.maxPitch)),this.angle=P(le,-Math.PI,Math.PI),this._setZoom(z(de,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new ep(C[0],C[1],C[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(C){return Math.pow(2,C)*this.tileSize}_mercatorZfromZoom(C){return this.cameraToCenterDistance/this._worldSizeFromZoom(C)}_minimumHeightOverTerrain(){const C=Math.min((null!=this._seaLevelZoom?this._seaLevelZoom:this._zoom)+4,this._maxZoom);return this._mercatorZfromZoom(C)}_zoomFromMercatorZ(C){return this.scaleZoom(this.cameraToCenterDistance/(C*this.tileSize))}zoomFromMercatorZAdjusted(C){let H=0,te=Pp,le=0,ce=1/0;for(;te-H>1e-6&&te>H;){const he=H+.5*(te-H),ue=this.tileSize*Math.pow(2,he),de=this.getCameraToCenterDistance(this.projection,he,ue),_e=this.scaleZoom(de/(C*this.tileSize)),ye=Math.abs(he-_e);ye<ce&&(ce=ye,le=he),he<_e?H=he:te=he}return le}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(W("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(C,H){const te=Math.min(C.x,H.x),le=Math.max(C.x,H.x),ce=Math.min(C.y,H.y),he=Math.max(C.y,H.y);if(ce<this.horizonLineFromTop(!1))return!0;if("mercator"!==this.projection.name)return!1;const ue=[new Ne(te,ce),new Ne(le,he),new Ne(te,he),new Ne(le,ce)],de=this.renderWorldCopies?-3:0,_e=this.renderWorldCopies?4:1;for(const C of ue){const H=this.pointRayIntersection(C);if(H.t<0)return!0;const te=this.rayIntersectionCoordinate(H);if(te.x<de||te.y<0||te.x>_e||te.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+T(this.fovAboveCenter)>88||this.anyCornerOffEdge(new Ne(0,0),new Ne(this.width,this.height))}zoomDeltaToMovement(C,H){const te=Ld.length(Ld.sub([],this._camera.position,C)),le=this._zoomFromMercatorZ(te)+H;return te-this._mercatorZfromZoom(le)}getCameraPoint(){if("globe"===this.projection.name){const C=function([C,H,te],le){const ce=[C,H,te,1];Lu.transformMat4(ce,ce,le);const he=ce[3]=Math.max(ce[3],1e-6);return ce[0]/=he,ce[1]/=he,ce[2]/=he,ce}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new Ne(C[0],C[1])}{const C=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new Ne(0,C))}}getCameraToCenterDistance(C,H=this.zoom,te=this.worldSize){const le=Zx(C,H,this.width,this.height,1024),ce=C.pixelSpaceConversion(this.center.lat,te,le);let he=.5/Math.tan(.5*this._fov)*this.height*ce;return this.isOrthographic&&(he=pv(1,he,fv(this.pitch>=15?1:this.pitch/15))),he}getWorldToCameraMatrix(){const C=this._camera.getWorldToCamera(this.worldSize,"meters"===this.projection.zAxisUnit?this.pixelsPerMeter:1);return"globe"===this.projection.name&&ed.multiply(C,C,this.globeMatrix),C}getFrustum(C){return $u.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,C,"meters"===this.projection.zAxisUnit)}}function _v(C,H,te){ed.identity(C),ed.rotateZ(C,C,w(H[2])),ed.rotateX(C,C,w(H[0])),ed.rotateY(C,C,w(H[1])),ed.scale(C,C,te),ed.multiply(C,C,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function gv(C,H,te,le,ce,he,ue,de){const _e=[te[0]-H[0],te[1]-H[1],0],ye=[le[0]-H[0],le[1]-H[1],0];if(Ld.length(_e)<1e-12||Ld.length(ye)<1e-12)return id.identity(C);const ve=Ld.cross([],_e,ye);Ld.normalize(ve,ve),Ld.subtract(ye,le,H),_e[2]=(he-ce)*de,ye[2]=(ue-ce)*de;const Me=_e;return Ld.cross(Me,_e,ye),Ld.normalize(Me,Me),id.rotationTo(C,ve,Me)}function yv(C,H,te=!1){const le=Ed(H.zoom),ce=function(C,H,te){const le=H.worldSize,ce=[C[12],C[13],C[14]],he=Hd(ce[1]/le),ue=$d(ce[0]/le),de=ed.identity([]),_e=Zd(1,he)*le,ye=Zd(1,0)*le*Kd(he,H.zoom),ve=1/bd(le);let Me=ye*ve;if(te){const C=Zx(H.projection,H.zoom,H.width,H.height,1024);Me=ve*H.projection.pixelSpaceConversion(H.center.lat,le,C)}const Se=md(he,ue);Ld.add(Se,Se,Ld.scale([],Ld.normalize([],Se),_e*Me*ce[2]));const Ae=function(C){const H=[C[0],C[1],C[2]];let te=[0,1,0];const le=Ld.cross([],te,H);return Ld.cross(te,H,le),0===Ld.squaredLength(te)&&(te=[0,1,0],Ld.cross(le,H,te)),Ld.normalize(le,le),Ld.normalize(te,te),Ld.normalize(H,H),[le[0],le[1],le[2],0,te[0],te[1],te[2],0,H[0],H[1],H[2],0,C[0],C[1],C[2],1]}(Se);ed.scale(de,de,[Me,Me,Me*_e]),ed.translate(de,de,[-ce[0],-ce[1],-ce[2]]);const Ce=ed.multiply([],H.globeMatrix,Ae);return ed.multiply(Ce,Ce,de),ed.multiply(Ce,Ce,C),Ce}(C,H,te);if(le>0){const te=function(C,H){const te=H.worldSize,le=Zd(1,0)*te*Kd(H.center.lat,H.zoom)/bd(te),ce=Zd(1,H.center.lat)*te,he=ed.identity([]);return ed.rotateY(he,he,w(H.center.lng)),ed.rotateX(he,he,w(H.center.lat)),ed.translate(he,he,[0,0,Rp]),ed.scale(he,he,[le,le,le*ce]),ed.translate(he,he,[H.point.x-.5*te,H.point.y-.5*te,0]),ed.multiply(he,he,C),ed.multiply(he,H.globeMatrix,he)}(C,H);return function(C,H,te){const r=(C,H,te)=>{const le=Ld.length(C),ce=Ld.length(H),he=ld(C,H,te);return Ld.scale(he,he,1/Ld.length(he)*Wr(le,ce,te))},le=r([C[0],C[1],C[2]],[H[0],H[1],H[2]],te),ce=r([C[4],C[5],C[6]],[H[4],H[5],H[6]],te),he=r([C[8],C[9],C[10]],[H[8],H[9],H[10]],te),ue=ld([C[12],C[13],C[14]],[H[12],H[13],H[14]],te);return[le[0],le[1],le[2],0,ce[0],ce[1],ce[2],0,he[0],he[1],he[2],0,ue[0],ue[1],ue[2],1]}(ce,te,le)}return ce}const Ub=64,Vb=[1,1,1];class bv{constructor(C,H,te,le){this.id=C,this.position=null!=H?new Of(H[0],H[1]):new Of(0,0),this.orientation=null!=te?te:[0,0,0],this.nodes=le,this.uploaded=!1,this.aabb=new Hu([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(C,H){if(ed.multiply(C.matrix,H,C.matrix),C.meshes)for(const H of C.meshes){const te=Hu.applyTransform(H.aabb,C.matrix);this.aabb.encapsulate(te)}if(C.children)for(const H of C.children)this._applyTransformations(H,C.matrix)}computeBoundsAndApplyParent(){const C=ed.identity([]);for(const H of this.nodes)this._applyTransformations(H,C)}_positionModelOnTerrain(C,H){const te=C.elevation;if(!te)return 0;const le=Hu.projectAabbCorners(this.aabb,this.matrix),ce=Zd(1,this.position.lat)*C.worldSize,he=function(C,H){const te=[0,0,1],le=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(const ce of le){const le=C[ce.corners[0]],he=C[ce.corners[1]],ue=C[ce.corners[2]],de=[he[0]-le[0],he[1]-le[1],H*(he[2]-le[2])],_e=Ld.cross(de,de,[ue[0]-le[0],ue[1]-le[1],H*(ue[2]-le[2])]);Ld.normalize(_e,_e),ce.dotProductWithUp=Ld.dot(_e,te)}return le.sort(((C,H)=>C.dotProductWithUp-H.dotProductWithUp)),le[0].corners}(le,ce),ue=le[he[0]],de=le[he[1]],_e=le[he[2]],ye=le[he[3]],ve=te.getAtPointOrZero(new ep(ue[0]/C.worldSize,ue[1]/C.worldSize),0),Me=te.getAtPointOrZero(new ep(de[0]/C.worldSize,de[1]/C.worldSize),0),Se=te.getAtPointOrZero(new ep(_e[0]/C.worldSize,_e[1]/C.worldSize),0),Ae=te.getAtPointOrZero(new ep(ye[0]/C.worldSize,ye[1]/C.worldSize),0),Ce=(ve+Ae)/2,Oe=(Me+Se)/2;return Ce>Oe?Me<Se?gv(H,de,ye,ue,Me,Ae,ve,ce):gv(H,_e,ue,ye,Se,ve,Ae,ce):ve<Ae?gv(H,ue,de,_e,ve,Me,Se,ce):gv(H,ye,_e,de,Ae,Se,Me,ce),Math.max(Ce,Oe)}computeModelMatrix(C,H,te,le,ce,he,ue=!1){const de=C.transform,_e=de.zoom,ye=de.project(this.position),ve=Kd(this.position.lat,_e),Me=1/ve;ed.identity(this.matrix),ed.translate(this.matrix,this.matrix,[ye.x+le[0]*Me,ye.y+le[1]*Me,le[2]]);let Se=1,Ae=1;const Ce=de.worldSize;if(ue){if("mercator"===de.projection.name){let C=0;de.elevation&&(C=de.elevation.getAtPointOrZero(new ep(ye.x/Ce,ye.y/Ce),0));const H=Lu.transformMat4([],[ye.x,ye.y,C,1],de.projMatrix)[3]/de.cameraToCenterDistance;Se=H,Ae=H*Kd(de.center.lat,_e)}else if("globe"===de.projection.name){const C=yv(this.matrix,de),H=ed.multiply([],de.projMatrix,C),te=[0,0,0,1];Lu.transformMat4(te,te,H);const le=te[3]/de.cameraToCenterDistance,ce=Ed(_e),he=de.projection.pixelsPerMeter(this.position.lat,Ce)*Kd(this.position.lat,_e),ue=de.projection.pixelsPerMeter(de.center.lat,Ce)*Kd(de.center.lat,_e);Se=le/Wr(he,Yd(de.center.lat),ce),Ae=le*ve/he,Se*=ue,Ae*=ue}}else Se=Me;ed.scale(this.matrix,this.matrix,[Se,Se,Ae]);const Oe=[...this.matrix],Ne=this.orientation,je=[];if(_v(je,[Ne[0]+H[0],Ne[1]+H[1],Ne[2]+H[2]],te),ed.multiply(this.matrix,Oe,je),ce&&de.elevation){let C=0;const H=[];if(he&&de.elevation){C=this._positionModelOnTerrain(de,H);const te=ed.fromQuat([],H),le=ed.multiply([],te,je);ed.multiply(this.matrix,Oe,le)}else C=de.elevation.getAtPointOrZero(new ep(ye.x/Ce,ye.y/Ce),0);0!==C&&(this.matrix[14]+=C)}}upload(C){if(!this.uploaded){for(const H of this.nodes)Ev(H,C);for(const C of this.nodes)Mv(C);this.uploaded=!0}}destroy(){for(const C of this.nodes)Av(C)}}function wv(C,H,te=!1){C.uploaded||(C.gfxTexture=new gy(H,C.image,te?H.gl.R8:H.gl.RGBA,{useMipmap:C.sampler.minFilter>=H.gl.NEAREST_MIPMAP_NEAREST}),C.uploaded=!0,C.image=null)}function Tv(C,H,te){C.indexBuffer=H.createIndexBuffer(C.indexArray,!1,!0),C.vertexBuffer=H.createVertexBuffer(C.vertexArray,Qv.members,!1,!0),C.normalArray&&(C.normalBuffer=H.createVertexBuffer(C.normalArray,Tb.members,!1,!0)),C.texcoordArray&&(C.texcoordBuffer=H.createVertexBuffer(C.texcoordArray,cb.members,!1,!0)),C.colorArray&&(C.colorBuffer=H.createVertexBuffer(C.colorArray,(12===C.colorArray.bytesPerElement?eb:tb).members,!1,!0)),C.featureArray&&(C.pbrBuffer=H.createVertexBuffer(C.featureArray,Cb.members,!0)),C.segments=dl.simpleSegment(0,0,C.vertexArray.length,C.indexArray.length);const le=C.material;le.pbrMetallicRoughness.baseColorTexture&&wv(le.pbrMetallicRoughness.baseColorTexture,H),le.pbrMetallicRoughness.metallicRoughnessTexture&&wv(le.pbrMetallicRoughness.metallicRoughnessTexture,H),le.normalTexture&&wv(le.normalTexture,H),le.occlusionTexture&&wv(le.occlusionTexture,H,te),le.emissionTexture&&wv(le.emissionTexture,H)}function Ev(C,H,te){if(C.meshes)for(const le of C.meshes)Tv(le,H,te);if(C.children)for(const le of C.children)Ev(le,H,te)}function Mv(C){if(C.meshes)for(const H of C.meshes)H.indexArray.destroy(),H.vertexArray.destroy(),H.colorArray&&H.colorArray.destroy(),H.normalArray&&H.normalArray.destroy(),H.texcoordArray&&H.texcoordArray.destroy(),H.featureArray&&H.featureArray.destroy();if(C.children)for(const H of C.children)Mv(H)}function Av(C){if(C.meshes)for(const te of C.meshes)te.vertexBuffer&&(te.vertexBuffer.destroy(),te.indexBuffer.destroy(),te.normalBuffer&&te.normalBuffer.destroy(),te.texcoordBuffer&&te.texcoordBuffer.destroy(),te.colorBuffer&&te.colorBuffer.destroy(),te.pbrBuffer&&te.pbrBuffer.destroy(),te.segments.destroy(),te.material&&((H=te.material).pbrMetallicRoughness.baseColorTexture&&H.pbrMetallicRoughness.baseColorTexture.gfxTexture&&H.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),H.pbrMetallicRoughness.metallicRoughnessTexture&&H.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&H.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),H.normalTexture&&H.normalTexture.gfxTexture&&H.normalTexture.gfxTexture.destroy(),H.emissionTexture&&H.emissionTexture.gfxTexture&&H.emissionTexture.gfxTexture.destroy(),H.occlusionTexture&&H.occlusionTexture.gfxTexture&&H.occlusionTexture.gfxTexture.destroy()));var H;if(C.children)for(const H of C.children)Av(H)}class Sv{constructor(C,H){this.feature=C,this.instancedDataOffset=H,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class Iv{constructor(){this.instancedDataArray=new Ya,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}}class Cv{constructor(C){this.zoom=C.zoom,this.canonical=C.canonical,this.layers=C.layers,this.layerIds=this.layers.map((C=>C.fqid)),this.projection=C.projection,this.index=C.index,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter((C=>C.isStateDependent())).map((C=>C.id)),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0}}populate(C,H,te,le){this.tileToMeter=Qd(te);const ce=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(const{feature:he,id:ue,index:de,sourceLayerIndex:_e}of C){const C=cp(he,ce);if(!this.layers[0]._featureFilter.filter(new ea(this.zoom),C,te))continue;const ye={id:ue,sourceLayerIndex:_e,index:de,geometry:ce?C.geometry:lp(he,te,le),properties:he.properties,type:he.type,patterns:{}},ve=this.addFeature(ye,ye.geometry,C);ve&&H.featureIndex.insert(he,ye.geometry,de,_e,this.index,this.instancesPerModel[ve].instancedDataArray.length)}this.lookup=null}update(C,H,te,le){for(const H in this.instancesPerModel){const te=this.instancesPerModel[H];for(const H in C)te.idToFeaturesIndex.hasOwnProperty(H)&&this.evaluate(te.features[te.idToFeaturesIndex[H]],C[H],te,!0)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let C=!1;for(const H in this.instancesPerModel){const te=this.instancesPerModel[H];for(const H of te.features){const le=this.layers[0],ce=H.feature,he=this.canonical,ue=le.paint.get("model-rotation").evaluate(ce,{},he),de=le.paint.get("model-scale").evaluate(ce,{},he),_e=le.paint.get("model-translation").evaluate(ce,{},he);Ld.exactEquals(H.rotation,ue)&&Ld.exactEquals(H.scale,de)&&Ld.exactEquals(H.translation,_e)||(this.evaluate(H,H.featureStates,te,!0),C=!0)}}return C}isEmpty(){for(const C in this.instancesPerModel)if(0!==this.instancesPerModel[C].instancedDataArray.length)return!1;return!0}uploadPending(){return!this.uploaded}upload(C){if(!this.uploaded)for(const H in this.instancesPerModel){const te=this.instancesPerModel[H];te.instancedDataArray.length<0||0===te.instancedDataArray.length||(te.instancedDataBuffer?te.instancedDataBuffer.updateData(te.instancedDataArray):te.instancedDataBuffer=C.createVertexBuffer(te.instancedDataArray,Eb.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(const C in this.instancesPerModel){const H=this.instancesPerModel[C];0!==H.instancedDataArray.length&&H.instancedDataBuffer&&H.instancedDataBuffer.destroy()}}addFeature(C,H,te){const le=this.layers[0],ce=le.layout.get("model-id").evaluate(te,{},this.canonical);if(!ce)return W(`modelId is not evaluated for layer ${le.id} and it is not going to get rendered.`),ce;this.instancesPerModel[ce]||(this.instancesPerModel[ce]=new Iv);const he=this.instancesPerModel[ce],ue=he.instancedDataArray,de=new Sv(te,ue.length);for(const C of H)for(const H of C){if(H.x<0||H.x>=wn||H.y<0||H.y>=wn)continue;const C=(this.lookupDim-1)/wn,te=this.lookupDim*(H.y*C|0)+H.x*C|0;if(this.lookup){if(0!==this.lookup[te])continue;this.lookup[te]=1}this.instanceCount++;const le=ue.length;ue.resize(le+1),he.instancesEvaluatedElevation.push(0),ue.float32[16*le]=H.x,ue.float32[16*le+1]=H.y}return de.instancedDataCount=he.instancedDataArray.length-de.instancedDataOffset,de.instancedDataCount>0&&(C.id&&(he.idToFeaturesIndex[C.id]=he.features.length),he.features.push(de),this.evaluate(de,{},he,!1)),ce}evaluate(C,H,te,le){const ce=this.layers[0],he=C.feature,ue=this.canonical,de=C.rotation=ce.paint.get("model-rotation").evaluate(he,H,ue),_e=C.scale=ce.paint.get("model-scale").evaluate(he,H,ue),ye=C.translation=ce.paint.get("model-translation").evaluate(he,H,ue),ve=ce.paint.get("model-color").evaluate(he,H,ue);ve.a=ce.paint.get("model-color-mix-intensity").evaluate(he,H,ue);const Me=[];this.maxVerticalOffset<ye[2]&&(this.maxVerticalOffset=ye[2]),this.maxScale=Math.max(Math.max(this.maxScale,_e[0]),Math.max(_e[1],_e[2])),_v(Me,de,_e);const Se=Math.round(100*ve.a)+ve.b/1.05;for(let H=0;H<C.instancedDataCount;++H){const ce=C.instancedDataOffset+H,he=16*ce,de=te.instancedDataArray.float32;let _e=0;le&&(_e=de[he+6]-te.instancesEvaluatedElevation[ce]);const Ae=0|de[he+1];de[he]=(0|de[he])+ve.r/1.05,de[he+1]=Ae+ve.g/1.05,de[he+2]=Se,de[he+3]=1/(ue.z>10?this.tileToMeter:Qd(ue,Ae)),de[he+4]=ye[0],de[he+5]=ye[1],de[he+6]=ye[2]+_e,de[he+7]=Me[0],de[he+8]=Me[1],de[he+9]=Me[2],de[he+10]=Me[4],de[he+11]=Me[5],de[he+12]=Me[6],de[he+13]=Me[8],de[he+14]=Me[9],de[he+15]=Me[10],te.instancesEvaluatedElevation[ce]=ye[2]}}}Is(Cv,"ModelBucket",{omit:["layers"]}),Is(Iv,"PerModelAttributes"),Is(Sv,"ModelFeature");const jb=new da({visibility:new ca(Ai.layout_model.visibility),"model-id":new ha(Ai.layout_model["model-id"])});var $b={paint:new da({"model-opacity":new ca(Ai.paint_model["model-opacity"]),"model-rotation":new ha(Ai.paint_model["model-rotation"]),"model-scale":new ha(Ai.paint_model["model-scale"]),"model-translation":new ha(Ai.paint_model["model-translation"]),"model-color":new ha(Ai.paint_model["model-color"]),"model-color-mix-intensity":new ha(Ai.paint_model["model-color-mix-intensity"]),"model-type":new ca(Ai.paint_model["model-type"]),"model-cast-shadows":new ca(Ai.paint_model["model-cast-shadows"]),"model-receive-shadows":new ca(Ai.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new ca(Ai.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new ha(Ai.paint_model["model-emissive-strength"]),"model-roughness":new ha(Ai.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new ha(Ai.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new ca(Ai.paint_model["model-cutoff-fade-range"])}),layout:jb};const Hb=new Float32Array(262144),Xb=new Uint8Array(262144);function Lv(C){let H=0;if(C.meshes)for(const te of C.meshes)H=Math.max(H,te.aabb.max[2]);if(C.children)for(const te of C.children)H=Math.max(H,Lv(te));return H}const Yb=["","wall","door","roof","window","lamp","logo"];class Ov{constructor(C){this.node=C,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.feature={type:"Point",id:C.id,geometry:[],properties:{height:Lv(C)}}}}class Bv{constructor(C,H,te,le){this.nodes=C,this.id=H,this.modelTraits|=1,this.uploaded=!1,this.hasPattern=!1,te&&(this.modelTraits|=4),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=le,this.dirty=!0,this.needsUpload=!1}update(){console.log("Update 3D model bucket")}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(C){if(!this.needsUpload)return;const H=this.getNodesInfo();for(const te of H){const H=te.node;this.uploaded?this.updatePbrBuffer(H):Ev(H,C,!0)}for(const C of H)Mv(C.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(C){let H=!1;if(!C.meshes)return H;for(const te of C.meshes)te.pbrBuffer&&(te.pbrBuffer.updateData(te.featureArray),H=!0);return H}needsReEvaluation(C,H,te){const le=C.transform.projectionOptions,ce=C.style.getBrightness(),he=this.brightness!==ce;return!!(!this.uploaded||this.dirty||le.name!==this.projection.name||Fv(te.paint.get("model-color").value,he)||Fv(te.paint.get("model-color-mix-intensity").value,he)||Fv(te.paint.get("model-roughness").value,he)||Fv(te.paint.get("model-emissive-strength").value,he)||Fv(te.paint.get("model-height-based-emissive-strength-multiplier").value,he))&&(this.projection=le,this.brightness=ce,!0)}evaluateScale(C,H){if(C.transform.zoom===this.zoom)return;this.zoom=C.transform.zoom;const te=this.getNodesInfo(),le=this.id.canonical;for(const C of te){const te=C.feature;C.evaluatedScale=H.paint.get("model-scale").evaluate(te,{},le)}}evaluate(C){const H=this.getNodesInfo();for(const te of H){if(!te.node.meshes)continue;const H=te.feature,le=te.node.meshes&&te.node.meshes[0].featureData,ce=te.evaluatedColor[2],he=te.evaluatedRMEA[2],ue=this.id.canonical;if(te.hasTranslucentParts=!1,le){for(let le=0;le<Yb.length;le++){const ce=Yb[le];ce.length&&(H.properties.part=ce);const he=C.paint.get("model-color").evaluate(H,{},ue),de=C.paint.get("model-color-mix-intensity").evaluate(H,{},ue);te.evaluatedColor[le]=[he.r,he.g,he.b,de],te.evaluatedRMEA[le][0]=C.paint.get("model-roughness").evaluate(H,{},ue),te.evaluatedRMEA[le][2]=C.paint.get("model-emissive-strength").evaluate(H,{},ue),te.evaluatedRMEA[le][3]=he.a,te.emissionHeightBasedParams[le]=C.paint.get("model-height-based-emissive-strength-multiplier").evaluate(H,{},ue),!te.hasTranslucentParts&&he.a<1&&(te.hasTranslucentParts=!0)}delete H.properties.part,Uv(te,ce!==te.evaluatedColor[2]||he!==te.evaluatedRMEA[2])}te.evaluatedScale=C.paint.get("model-scale").evaluate(H,{},ue),this.updatePbrBuffer(te.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(C,H,te,le){const ce=C.findDEMTileFor(te);if(ce&&(ce.tileID.canonical!==this.terrainTile||H!==this.terrainExaggeration)){if(ce.dem&&ce.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=ce.tileID.overscaledZ;const H=qm.create(C,te,ce);if(!H)return;4&this.modelTraits&&this.updateDEM(C,H,te,le);for(const C of this.getNodesInfo()){const te=C.node;if(!te.footprint||!te.footprint.vertices||!te.footprint.vertices.length)continue;const le=te.footprint.vertices;let ce=H.getElevationAt(le[0].x,le[0].y,!0,!0);for(let C=1;C<le.length;C++)ce=Math.min(ce,H.getElevationAt(le[C].x,le[C].y,!0,!0));te.elevation=ce}}this.terrainTile=ce.tileID.canonical,this.terrainExaggeration=H}}updateDEM(C,H,te,le){let ce=H._dem._modifiedForSources[le];if(void 0===ce&&(H._dem._modifiedForSources[le]=[],ce=H._dem._modifiedForSources[le]),ce.includes(te.canonical))return;const he=H._dem.dim;ce.push(te.canonical);let ue=!1;for(const C of this.getNodesInfo()){const te=C.node;if(!te.footprint||!te.footprint.grid)continue;const le=te.footprint.grid,ce=H.tileCoordToPixel(le.min.x,le.min.y),de=H.tileCoordToPixel(le.max.x,le.max.y),_e=Math.min(Math.min(he-de.y,ce.x),Math.min(ce.y,he-de.x));if(_e<0)continue;const ye=z(_e,2,5);let ve=Math.max(0,ce.x-ye),Me=Math.max(0,ce.y-ye),Se=Math.min(de.x+ye,he-1),Ae=Math.min(de.y+ye,he-1);for(let C=Me;C<=Ae;++C)for(let H=ve;H<=Se;++H)Xb[C*he+H]=255;let Ce=0,Oe=0;for(let C=0;C<le.cellsY;++C)for(let te=0;te<le.cellsX;++te){if(!le.cells[C*le.cellsX+te])continue;const ce=H.tileCoordToPixel(le.min.x+te/le.xScale,le.min.y+C/le.yScale),ue=H.tileCoordToPixel(le.min.x+(te+1)/le.xScale,le.min.y+(C+1)/le.yScale);for(let C=ce.y;C<=Math.min(ue.y+1,he-1);++C)for(let te=ce.x;te<=Math.min(ue.x+1,he-1);++te)255===Xb[C*he+te]&&(Xb[C*he+te]=0,Ce+=H.getElevationAtPixel(te,C),Oe++)}const Ne=Ce/Oe;ve=Math.max(1,ce.x-ye),Me=Math.max(1,ce.y-ye),Se=Math.min(de.x+ye,he-2),Ae=Math.min(de.y+ye,he-2),ue=!0;for(let C=Me;C<=Ae;++C)for(let te=ve;te<=Se;++te)0===Xb[C*he+te]&&(Hb[C*he+te]=H._dem.set(te,C,Ne));for(let C=1;C<ye;++C){ve=Math.max(1,ce.x-C),Me=Math.max(1,ce.y-C),Se=Math.min(de.x+C,he-2),Ae=Math.min(de.y+C,he-2);for(let te=Me;te<=Ae;++te)for(let le=ve;le<=Se;++le){const ce=te*he+le;if(255===Xb[ce]){let ue=0,de=0,_e=-1,ve=-1;for(let H=-1;H<=1;++H)for(let ce=-1;ce<=1;++ce){const ye=(te+H)*he+le+ce;if(Xb[ye]>=C)continue;const Me=Hb[ye],Se=Math.abs(Me);Se>de&&(ue=Me,de=Se,_e=ce,ve=H)}if(de>.1){const he=1-(C+.5*Math.abs(_e*ve))/ye;let de=H._dem.get(le,te)+ue*he;const Me=H._dem.get(le+_e,te+ve),Se=H._dem.get(le-_e,te-ve,!0);(de-Me)*(de-Se)>0&&(de=(Me+Se)/2),Hb[ce]=H._dem.set(le,te,de),Xb[ce]=C}}}}}ue&&(H._demTile.needsDEMTextureUpload=!0,H._dem._timestamp=yi.now())}getNodesInfo(){if(!this.nodesInfo){this.nodesInfo=[];for(const C of this.nodes)this.nodesInfo.push(new Ov(C));this.freeNodes()}return this.nodesInfo}freeNodes(){if(this.nodes){for(const C of this.nodes)Av(C);this.nodes.splice(0,this.nodes.length)}}destroy(){this.freeNodes();const C=this.getNodesInfo();for(const H of C)Mv(H.node),Av(H.node)}isEmpty(){return!this.nodes.length}updateReplacement(C,H){if(H.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=H.updateTime;const te=H.getReplacementRegionsForTile(C.toUnwrapped()),le=this.getNodesInfo();for(let C=0;C<this.nodesInfo.length;C++){const H=le[C].node;le[C].hiddenByReplacement=!!H.footprint&&!te.find((C=>C.footprint===H.footprint))}}getHeightAtTileCoord(C,H){const te=this.getNodesInfo(),le=[];for(let ce=0;ce<this.nodesInfo.length;ce++){const he=te[ce],ue=he.node.meshes[0];if(C<ue.aabb.min[0]||H<ue.aabb.min[1]||C>ue.aabb.max[0]||H>ue.aabb.max[1])continue;const de=(C-ue.aabb.min[0])/(ue.aabb.max[0]-ue.aabb.min[0])*Ub|0,_e=Math.min(63,(H-ue.aabb.min[1])/(ue.aabb.max[1]-ue.aabb.min[1])*Ub|0)*Ub+Math.min(63,de);if(!(ue.heightmap[_e]<0&&he.node.footprint)){if(he.hiddenByReplacement)return;return{height:ue.heightmap[_e],maxHeight:he.feature.properties.height,hidden:!1,verticalScale:he.evaluatedScale[2]}}if(he.node.footprint.grid.query(new Ne(C,H),new Ne(C,H),le),le.length>0)return{height:void 0,maxHeight:he.feature.properties.height,hidden:he.hiddenByReplacement,verticalScale:he.evaluatedScale[2]}}}}function Fv(C,H){return!C.isLightConstant&&H}function Nv(C,H,te,le,ce,he,ue,de){let _e=(61440&H|(61440&H)>>4)>>8,ye=(3840&H|(3840&H)>>4)>>4,ve=240&H|(240&H)>>4;te[3]>0&&(_e=Wr(_e,255*te[0],te[3]),ye=Wr(ye,255*te[1],te[3]),ve=Wr(ve,255*te[2],te[3]));const Me=_e<<8|ye,Se=ve<<8|Math.floor(255*le[3]),Ae=function(C){const H=z(C,0,2);return Math.min(Math.round(.5*H*255),255)}(le[2])<<8|15*le[0]<<4|15*le[1],Ce=z(ce[0],0,1),Oe=z(ce[1],0,1),Ne=z(ce[2],0,1),je=z(ce[3],0,1);let Ge,Ze,qe,$e;if(Ce!==Oe&&ue!==he&&Oe!==Ce){const C=ue-he;Ze=1/(C*(Oe-Ce)),qe=-(he+C*Ce)/(C*(Oe-Ce));const H=z(ce[4],-1,1);$e=Math.pow(10,H),Ge=255*Ne<<8|255*je}else Ge=65535,Ze=0,qe=1,$e=1;if(C.emplaceBack(Me,Se,Ae,Ge,Ze,qe,$e),de){const C=de.length;de.clear();for(let H=0;H<C;H++)de.emplaceBack(Me,Se,Ae,Ge,Ze,qe,$e)}}function Uv(C,H){const te=C.node;let le=0;for(const ce of te.meshes){if(te.lights&&te.lightMeshIndex===le)continue;if(!ce.featureData)continue;ce.featureArray=new Ka,ce.featureArray.reserve(ce.featureData.length);let he=H;for(const H of ce.featureData){let le;const ue=65535&H,de=(15&ue)<8?15&ue:0,_e=H>>16&65535,ye=C.evaluatedRMEA[de],ve=C.evaluatedColor[de],Me=C.emissionHeightBasedParams[de];if(he&&2===de&&te.lights&&(le=new Ka,le.resize(10*te.lights.length)),Nv(ce.featureArray,_e,ve,ye,Me,ce.aabb.min[2],ce.aabb.max[2],le),le&&he){he=!1;const C=te.meshes[te.lightMeshIndex];C.featureArray=le,C.featureArray._trim()}}ce.featureArray._trim(),le++}}Is(Bv,"Tiled3dModelBucket",{omit:["layers"]}),Is(Ov,"Tiled3dModelFeature");class Vv{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[]}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(C){const H=Zv(new Ne(0,0),new Ne(wn,wn),C),te=[];for(const le of this._activeRegions){if(le.hiddenByOverlap)continue;if(!qv(H,le))continue;const ce=$v(le.min,le.max,C);te.push({min:ce.min,max:ce.max,sourceId:this._sourceIds[le.priority],footprint:le.footprint,footprintTileId:le.tileId})}return te}setSources(C){this._setSources(C.map((C=>({getSourceId:()=>C.cache.id,getFootprints:()=>{const H=[];for(const te of C.cache.getVisibleCoordinates()){const le=C.cache.getTile(te).buckets[C.layer];if(le)for(const C of le.getNodesInfo()){const le=C.node;le.footprint&&H.push({footprint:le.footprint,id:te.toUnwrapped()})}}return H}}))))}_addSource(C){const H=C.getFootprints();if(0!==H.length){for(const C of H){if(!C.footprint)continue;const H=Zv(C.footprint.min,C.footprint.max,C.id);this._activeRegions.push({min:H.min,max:H.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:C.id,footprint:C.footprint})}this._sourceIds.push(C.getSourceId())}}_computeReplacement(){this._activeRegions.sort(((C,H)=>C.priority-H.priority||jv(C.min,H.min)||jv(C.max,H.max)));let C=this._activeRegions.length!==this._prevRegions.length;if(!C){let H=0,te=0;for(;!C&&H!==this._activeRegions.length;){const le=this._activeRegions[H],ce=this._prevRegions[te];C=le.priority!==ce.priority||!Gv(le,ce),++H,++te}}if(C){++this._updateTime;const e=C=>{const H=this._activeRegions;if(C>=H.length)return C;const te=H[C].priority;for(;C<H.length&&H[C].priority===te;)++C;return C};if(this._sourceIds.length>1){let C=0,H=e(C);for(;C!==H;){let te=C;const le=C;for(;te!==H;){const C=this._activeRegions[te];C.hiddenByOverlap=!1;for(let H=0;H<le;H++){const te=this._activeRegions[H];if(!te.hiddenByOverlap&&qv(C,te)&&(C.hiddenByOverlap=Wv(C.footprint,C.tileId,te.footprint,te.tileId),C.hiddenByOverlap))break}++te}C=H,H=e(C)}}}}_setSources(C){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let H=C.length-1;H>=0;H--)this._addSource(C[H]);this._computeReplacement()}}function jv(C,H){return C.x-H.x||C.y-H.y}function Gv(C,H){return 0===jv(C.min,H.min)&&0===jv(C.max,H.max)}function qv(C,H){return!(C.min.x>H.max.x||C.max.x<H.min.x||C.min.y>H.max.y||C.max.y<H.min.y)}function Zv(C,H,te){const le=1/wn,ce=1/(1<<te.canonical.z),he=(H.x*le+te.canonical.x)*ce+te.wrap,ue=(H.y*le+te.canonical.y)*ce;return{min:new Ne((C.x*le+te.canonical.x)*ce+te.wrap,(C.y*le+te.canonical.y)*ce),max:new Ne(he,ue)}}function $v(C,H,te){const le=1<<te.canonical.z,ce=((H.x-te.wrap)*le-te.canonical.x)*wn,he=(H.y*le-te.canonical.y)*wn;return{min:new Ne(((C.x-te.wrap)*le-te.canonical.x)*wn,(C.y*le-te.canonical.y)*wn),max:new Ne(ce,he)}}function Hv(C,H,te,le,ce,he,ue){const de=C.indices,_e=C.vertices,ye=[];for(let ve=le;ve<le+ce;ve+=3){const le=H[te[ve+0]+he],ce=H[te[ve+1]+he],Me=H[te[ve+2]+he],Se=Math.min(le.x,ce.x,Me.x),Ae=Math.max(le.x,ce.x,Me.x),Ce=Math.min(le.y,ce.y,Me.y),Oe=Math.max(le.y,ce.y,Me.y);ye.length=0,C.grid.query(new Ne(Se,Ce),new Ne(Ae,Oe),ye);for(let C=0;C<ye.length;C++){const H=ye[C];if(Ap(_e[de[3*H+0]],_e[de[3*H+1]],_e[de[3*H+2]],le,ce,Me,ue))return!0}}return!1}function Wv(C,H,te,le){if(!C||!te)return!1;let ce=C.vertices;if(!H.canonical.equals(le.canonical)||H.wrap!==le.wrap){if(te.vertices.length<C.vertices.length)return Wv(te,le,C,H);const he=H.canonical,ue=le.canonical,de=Math.pow(2,ue.z-he.z);ce=C.vertices.map((C=>new Ne(C.x*he.x*wn*de-ue.x*wn,C.y*he.y*wn*de-ue.y*wn)))}return Hv(te,ce,C.indices,0,C.indices.length,0,0)}const ew=l_.types,iw=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius"],rw=["fill-extrusion-flood-light-ground-radius"],nw=Math.pow(2,13),ow=Math.pow(2,15)-1,sw=new Ne(0,1),uw=2147483648;function ib(C,H,te,le,ce,he,ue,de){C.emplaceBack((H<<1)+ue,(te<<1)+he,(Math.floor(le*nw)<<1)+ce,Math.round(de))}function rb(C,H,te,le,ce,he){C.emplaceBack(H.x,H.y,(te.x<<1)+le,(te.y<<1)+ce,he)}function nb(C,H,te){const le=16384;C.emplaceBack(H.x,H.y,H.z,te[0]*le,te[1]*le,te[2]*le)}class ob{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class sb{constructor(){this.centroidXY=new Ne(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.min=new Ne(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new Ne(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0}span(){return new Ne(this.max.x-this.min.x,this.max.y-this.min.y)}}class ab{constructor(){this.acc=new Ne(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(C,H){C.min.x===Number.MAX_VALUE&&(C.min.x=C.max.x=H.x,C.min.y=C.max.y=H.y)}appendEdge(C,H,te){this.accCount++,this.acc._add(H);let le=!!this.borders;H.x<C.min.x?(C.min.x=H.x,le=!0):H.x>C.max.x&&(C.max.x=H.x,le=!0),H.y<C.min.y?(C.min.y=H.y,le=!0):H.y>C.max.y&&(C.max.y=H.y,le=!0),((0===H.x||H.x===wn)&&H.x===te.x)!=((0===H.y||H.y===wn)&&H.y===te.y)&&this.processBorderOverlap(H,te),le&&this.checkBorderIntersection(H,te)}checkBorderIntersection(C,H){H.x<0!=C.x<0&&this.addBorderIntersection(0,Wr(H.y,C.y,(0-H.x)/(C.x-H.x))),H.x>wn!=C.x>wn&&this.addBorderIntersection(1,Wr(H.y,C.y,(wn-H.x)/(C.x-H.x))),H.y<0!=C.y<0&&this.addBorderIntersection(2,Wr(H.x,C.x,(0-H.y)/(C.y-H.y))),H.y>wn!=C.y>wn&&this.addBorderIntersection(3,Wr(H.x,C.x,(wn-H.y)/(C.y-H.y)))}addBorderIntersection(C,H){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const te=this.borders[C];H<te[0]&&(te[0]=H),H>te[1]&&(te[1]=H)}processBorderOverlap(C,H){if(C.x===H.x){if(C.y===H.y)return;const te=0===C.x?0:1;this.addBorderIntersection(te,H.y),this.addBorderIntersection(te,C.y)}else{const te=0===C.y?2:3;this.addBorderIntersection(te,H.x),this.addBorderIntersection(te,C.x)}}centroid(){return 0===this.accCount?new Ne(0,0):new Ne(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce(((C,H)=>C+ +(H[0]!==Number.MAX_VALUE)),0):0}}function lb(C,H){const te=C.add(H)._unit(),le=z(C.x*te.x+C.y*te.y,-1,1);var ce,he,ue;return ce=Math.acos(le),Math.min(4,Math.max(-4,Math.tan(ce)))/4*ow*((he=C).x*(ue=H).y-he.y*ue.x<0?-1:1)}const yw=[C=>C.x<0,C=>C.x>wn,C=>C.y<0,C=>C.y>wn];function hb(C,H,te,le){const ce=[4];if(0===le)return ce;te._mult(le);const he=C.sub(te),ue=H.sub(te),de=[C,H,he,ue];for(let C=0;C<4;C++)for(const H of de)if(yw[C](H)){ce.push(C);break}return ce}class ub{constructor(C){this.vertexArray=new Aa,this.indexArray=new Va,this.programConfigurations=new Hl(C.layers,C.zoom,(C=>rw.includes(C))),this._segments=new dl,this.hiddenByLandmarkVertexArray=new Ja,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new dl}getDefaultSegment(){return this.regionSegments[4]}hasData(){return 0!==this.vertexArray.length}addData(C,H,te,le=!1){const ce=C.length;if(ce>2){let he=Math.max(0,this._segments.get().length-1);const ue=this._segments._prepareSegment(4*ce,this.vertexArray.length,2*this._segmentToGroundQuads[he].length);let de;he!==this._segments.get().length-1&&(he++,this._segmentToGroundQuads[he]=[],this._segmentToRegionTriCounts[he]=[0,0,0,0,0]);{const H=C[0],te=C[1];de=lb(H.sub(C[ce-1])._perp()._unit(),te.sub(H)._perp()._unit())}for(let _e=0;_e<ce;_e++){const ye=_e===ce-1?0:_e+1,ve=C[_e],Me=C[ye],Se=C[ye===ce-1?0:ye+1],Ae=Me.sub(ve)._perp()._unit(),Ce=lb(Ae,Se.sub(Me)._perp()._unit()),Oe=de,Ne=Ce;if(_b(ve,Me,H)||le&&gb(ve,H)&&gb(Me,H)){de=Ce;continue}const je=ue.vertexLength;rb(this.vertexArray,ve,Me,1,1,Oe),rb(this.vertexArray,ve,Me,1,0,Oe),rb(this.vertexArray,ve,Me,0,1,Ne),rb(this.vertexArray,ve,Me,0,0,Ne),ue.vertexLength+=4;const Ge=hb(ve,Me,Ae,te);for(const C of Ge)this._segmentToGroundQuads[he].push({id:je,region:C}),this._segmentToRegionTriCounts[he][C]+=2,ue.primitiveLength+=2;de=Ce}}}prepareBorderSegments(){if(!this.hasData())return;const C=this._segments.get(),H=C.length;for(let C=0;C<H;C++)this._segmentToGroundQuads[C].sort(((C,H)=>C.region-H.region));for(let te=0;te<H;te++){const H=this._segmentToGroundQuads[te],le=C[te],ce=this._segmentToRegionTriCounts[te];ce.reduce(((C,H)=>C+H),0);let he=0;for(let C=0;C<=4;C++){const H=ce[C];if(0!==H){let te=this.regionSegments[C];te||(te=this.regionSegments[C]=new dl);const ce={vertexOffset:le.vertexOffset,primitiveOffset:le.primitiveOffset+he,vertexLength:le.vertexLength,primitiveLength:H};te.get().push(ce)}he+=H}for(let C=0;C<H.length;C++){const te=H[C].id;this.indexArray.emplaceBack(te,te+1,te+3),this.indexArray.emplaceBack(te,te+3,te+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(C,H,te,le,ce,he){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,C,H,te,le,ce,he)}upload(C){this.hasData()&&(this.vertexBuffer=C.createVertexBuffer(this.vertexArray,Nm.members),this.indexBuffer=C.createIndexBuffer(this.indexArray))}uploadPaintProperties(C){this.hasData()&&this.programConfigurations.upload(C)}update(C,H,te,le,ce,he){this.hasData()&&this.programConfigurations.updatePaintArrays(C,H,te,le,ce,he)}updateHiddenByLandmark(C){if(!this.hasData())return;const H=C.groundVertexCount+C.groundVertexArrayOffset;if(0===C.groundVertexCount)return;const te=C.flags&uw?1:0;for(let le=C.groundVertexArrayOffset;le<H;++le)this.hiddenByLandmarkVertexArray.emplace(le,te);this._needsHiddenByLandmarkUpdate=!0}uploadHiddenByLandmark(C){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=C.createVertexBuffer(this.hiddenByLandmarkVertexArray,Xm.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let C=0;C<=4;C++){const H=this.regionSegments[C];H&&H.destroy()}}}}class db{constructor(C){this.zoom=C.zoom,this.canonical=C.canonical,this.overscaling=C.overscaling,this.layers=C.layers,this.layerIds=this.layers.map((C=>C.fqid)),this.index=C.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=C.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new Va,this.footprintVertices=new Ta,this.footprintSegments=[],this.layoutVertexArray=new Ma,this.centroidVertexArray=new cl,this.indexArray=new Va,this.programConfigurations=new Hl(C.layers,C.zoom,(C=>iw.includes(C))),this.segments=new dl,this.stateDependentLayerIds=this.layers.filter((C=>C.isStateDependent())).map((C=>C.id)),this.groundEffect=new ub(C),this.maxHeight=0,this.partLookup={}}populate(C,H,te,le){this.features=[],this.hasPattern=Pf("fill-extrusion",this.layers,H),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.tileToMeter=Qd(te),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter;for(const{feature:ce,id:he,index:ue,sourceLayerIndex:de}of C){const C=this.layers[0]._featureFilter.needGeometry,_e=cp(ce,C);if(!this.layers[0]._featureFilter.filter(new ea(this.zoom),_e,te))continue;const ye={id:he,sourceLayerIndex:de,index:ue,geometry:C?_e.geometry:lp(ce,te,le),properties:ce.properties,type:ce.type,patterns:{}},ve=this.layoutVertexArray.length;this.hasPattern?this.features.push(Rf("fill-extrusion",this.layers,ye,this.zoom,H)):this.addFeature(ye,ye.geometry,ue,te,{},H.availableImages,le,H.brightness),H.featureIndex.insert(ce,ye.geometry,ue,de,this.index,ve)}this.sortBorders(),this.groundEffect.prepareBorderSegments()}addFeatures(C,H,te,le,ce,he){for(const C of this.features){const{geometry:ue}=C;this.addFeature(C,ue,C.index,H,te,le,ce,he)}this.sortBorders()}update(C,H,te,le,ce){const he=0!==Object.keys(C).length;if(he&&!this.stateDependentLayers.length)return;const ue=he?this.stateDependentLayers:this.layers;this.programConfigurations.updatePaintArrays(C,H,ue,te,le,ce),this.groundEffect.update(C,H,ue,te,le,ce)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(C){this.uploaded||(this.layoutVertexBuffer=C.createVertexBuffer(this.layoutVertexArray,Km),this.indexBuffer=C.createIndexBuffer(this.indexArray),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=C.createVertexBuffer(this.layoutVertexExtArray,Ym.members,!0)),this.groundEffect.upload(C)),this.groundEffect.uploadPaintProperties(C),this.programConfigurations.upload(C),this.uploaded=!0}uploadCentroid(C){this.groundEffect.uploadHiddenByLandmark(C),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=C.createVertexBuffer(this.centroidVertexArray,Wm.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(C,H,te,le,ce,he,ue,de){const _e=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(C,{})/this.tileToMeter,ye=[new Ne(0,0),new Ne(wn,wn)],ve=ue.projection,Me="globe"===ve.name,Se="Polygon"===ew[C.type],Ae=new ab;Ae.centroidDataIndex=this.centroidData.length;const Ce=new sb,Oe=this.layers[0].paint.get("fill-extrusion-base").evaluate(C,{},le)<=0,je=this.layers[0].paint.get("fill-extrusion-height").evaluate(C,{},le);Ce.height=je,Ce.vertexArrayOffset=this.layoutVertexArray.length,Ce.groundVertexArrayOffset=this.groundEffect.vertexArray.length,Me&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new Da);const Ge=zf(H,500);for(let C=Ge.length-1;C>=0;C--){const H=Ge[C];(0===H.length||(Ze=H[0]).every((C=>C.x<=0))||Ze.every((C=>C.x>=wn))||Ze.every((C=>C.y<=0))||Ze.every((C=>C.y>=wn)))&&Ge.splice(C,1)}var Ze;let qe;if(Me)qe=bb(Ge,ye,le);else{qe=[];for(const C of Ge)qe.push({polygon:C,bounds:ye})}const $e=Se?this.edgeRadius:0,We=$e>0&&this.zoom<17,T=(C,H)=>{if(0===C.length)return!1;const te=C[C.length-1];return H.x===te.x&&H.y===te.y};for(const{polygon:C,bounds:H}of qe){let te=0,ce=0;for(const H of C)Se&&!H[0].equals(H[H.length-1])&&H.push(H[0]),ce+=Se?H.length-1:H.length;const he=this.segments.prepareSegment((Se?5:4)*ce,this.layoutVertexArray,this.indexArray);Ce.footprintSegIdx<0&&(Ce.footprintSegIdx=this.footprintSegments.length);const ue=new ob;if(ue.vertexOffset=this.footprintVertices.length,ue.indexOffset=3*this.footprintIndices.length,ue.ringIndices=[],Se){const ce=[],de=[];te=he.vertexLength;for(let te=0;te<C.length;te++){const ye=C[te];ye.length&&0!==te&&de.push(ce.length/2);const Se=[];let Ae,Ce;Ae=ye[1].sub(ye[0])._perp()._unit(),ue.ringIndices.push(ye.length-1);for(let C=1;C<ye.length;C++){const H=ye[C],te=ye[C===ye.length-1?1:C+1],ue=H.clone();if($e){Ce=te.sub(H)._perp()._unit();const C=Ae.add(Ce)._unit(),le=$e*Math.min(4,1/(Ae.x*C.x+Ae.y*C.y));ue.x+=le*C.x,ue.y+=le*C.y,ue.x=Math.round(ue.x),ue.y=Math.round(ue.y),Ae=Ce}!Oe||0!==$e&&!We||T(Se,ue)||Se.push(ue),ib(this.layoutVertexArray,ue.x,ue.y,0,0,1,1,0),he.vertexLength++,this.footprintVertices.emplaceBack(H.x,H.y),ce.push(H.x,H.y),Me&&nb(this.layoutVertexExtArray,ve.projectTilePoint(ue.x,ue.y,le),ve.upVector(le,ue.x,ue.y))}Oe&&(0===$e||We)&&(0!==Se.length&&T(Se,Se[0])&&Se.pop(),this.groundEffect.addData(Se,H,_e))}const ye=hm(ce,de);for(let C=0;C<ye.length;C+=3)this.footprintIndices.emplaceBack(ue.vertexOffset+ye[C+0],ue.vertexOffset+ye[C+1],ue.vertexOffset+ye[C+2]),this.indexArray.emplaceBack(te+ye[C],te+ye[C+2],te+ye[C+1]),he.primitiveLength++;ue.indexCount+=ye.length,ue.vertexCount+=this.footprintVertices.length-ue.vertexOffset}for(let ce=0;ce<C.length;ce++){const ue=C[ce];Ae.startRing(Ce,ue[0]);let de=ue.length>4&&yb(ue[ue.length-2],ue[0],ue[1]),ye=$e?fb(ue[ue.length-2],ue[0],ue[1],$e):0;const Ne=[];let je,Ge,Ze;Ge=ue[1].sub(ue[0])._perp()._unit();let qe=!0;for(let C=1,ce=0;C<ue.length;C++){let _e=ue[C-1],Se=ue[C];const We=ue[C===ue.length-1?1:C+1];if(Ae.appendEdge(Ce,Se,_e),_b(Se,_e,H)){$e&&(Ge=We.sub(Se)._perp()._unit(),qe=!qe);continue}const He=Se.sub(_e)._perp(),Xe=He.x/(Math.abs(He.x)+Math.abs(He.y)),Ye=He.y>0?1:0,Je=_e.dist(Se);if(ce+Je>32768&&(ce=0),$e){Ze=We.sub(Se)._perp()._unit();let C=mb(_e,Se,We,pb(Ge,Ze),$e);isNaN(C)&&(C=0);const H=Se.sub(_e)._unit();_e=_e.add(H.mult(ye))._round(),Se=Se.add(H.mult(-C))._round(),ye=C,Ge=Ze,Oe&&this.zoom>=17&&(T(Ne,_e)||Ne.push(_e),T(Ne,Se)||Ne.push(Se))}const Qe=he.vertexLength,tt=ue.length>4&&yb(_e,Se,We);let rt=xb(ce,de,qe);if(ib(this.layoutVertexArray,_e.x,_e.y,Xe,Ye,0,0,rt),ib(this.layoutVertexArray,_e.x,_e.y,Xe,Ye,0,1,rt),ce+=Je,rt=xb(ce,tt,!qe),de=tt,ib(this.layoutVertexArray,Se.x,Se.y,Xe,Ye,0,0,rt),ib(this.layoutVertexArray,Se.x,Se.y,Xe,Ye,0,1,rt),he.vertexLength+=4,this.indexArray.emplaceBack(Qe+0,Qe+1,Qe+2),this.indexArray.emplaceBack(Qe+1,Qe+3,Qe+2),he.primitiveLength+=2,$e){const le=te+(1===C?ue.length-2:C-2),ce=1===C?te:le+1;if(this.indexArray.emplaceBack(Qe+1,le,Qe+3),this.indexArray.emplaceBack(le,ce,Qe+3),he.primitiveLength+=2,void 0===je&&(je=Qe),!_b(We,ue[C],H)){const H=C===ue.length-1?je:he.vertexLength;this.indexArray.emplaceBack(Qe+2,Qe+3,H),this.indexArray.emplaceBack(Qe+3,H+1,H),this.indexArray.emplaceBack(Qe+3,ce,H+1),he.primitiveLength+=3}qe=!qe}if(Me){const C=this.layoutVertexExtArray,H=ve.projectTilePoint(_e.x,_e.y,le),te=ve.projectTilePoint(Se.x,Se.y,le),ce=ve.upVector(le,_e.x,_e.y),he=ve.upVector(le,Se.x,Se.y);nb(C,H,ce),nb(C,H,ce),nb(C,te,he),nb(C,te,he)}}Se&&(te+=ue.length-1),Oe&&$e&&this.zoom>=17&&(0!==Ne.length&&T(Ne,Ne[0])&&Ne.pop(),this.groundEffect.addData(Ne,H,_e,$e>0))}this.footprintSegments.push(ue),++Ce.footprintSegLen}if(Ce.vertexCount=this.layoutVertexArray.length-Ce.vertexArrayOffset,Ce.groundVertexCount=this.groundEffect.vertexArray.length-Ce.groundVertexArrayOffset,0!==Ce.vertexCount){if(Ce.centroidXY=Ae.borders?sw:this.encodeCentroid(Ae,Ce),this.centroidData.push(Ce),Ae.borders){this.featuresOnBorder.push(Ae);const C=this.featuresOnBorder.length-1;for(let H=0;H<Ae.borders.length;H++)Ae.borders[H][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[H].push(C)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,C,te,ce,he,le,de),this.groundEffect.addPaintPropertiesData(C,te,ce,he,le,de),this.maxHeight=Math.max(this.maxHeight,je)}}sortBorders(){for(let C=0;C<this.borderFeatureIndices.length;C++)this.borderFeatureIndices[C].sort(((H,te)=>this.featuresOnBorder[H].borders[C][0]-this.featuresOnBorder[te].borders[C][0]))}encodeCentroid(C,H){const te=C.centroid(),le=H.span(),ce=Math.min(7,Math.round(le.x*this.tileToMeter/10)),he=Math.min(7,Math.round(le.y*this.tileToMeter/10));return new Ne(z(te.x,1,wn-1)<<3|ce,z(te.y,1,wn-1)<<3|he)}showCentroid(C){const H=this.centroidData[C.centroidDataIndex];H.flags&=uw,H.centroidXY.x=0,H.centroidXY.y=0,this.writeCentroidToBuffer(H)}writeCentroidToBuffer(C){this.groundEffect.updateHiddenByLandmark(C);const H=C.vertexArrayOffset,te=C.vertexCount+C.vertexArrayOffset,le=C.flags&uw?sw:C.centroidXY,ce=this.centroidVertexArray.geta_centroid_pos0(H);if(this.centroidVertexArray.geta_centroid_pos1(H)!==le.y||ce!==le.x){for(let C=H;C<te;++C)this.centroidVertexArray.emplace(C,le.x,le.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const C of this.centroidData)this.writeCentroidToBuffer(C)}updateReplacement(C,H){if(H.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=H.updateTime;const te=H.getReplacementRegionsForTile(C.toUnwrapped());if(function(C,H){if(C.length!==H.length)return!1;for(let te=0;te<C.length;te++)if(C[te].sourceId!==H[te].sourceId||!Gv(C[te],H[te]))return!1;return!0}(this.activeReplacements,te))return;if(this.activeReplacements=te,0===this.centroidVertexArray.length)this.createCentroidsBuffer();else for(const C of this.centroidData)C.flags&=2147483647;const le=[];for(const H of this.activeReplacements){const te=Math.pow(2,H.footprintTileId.canonical.z-C.canonical.z);for(const ce of this.centroidData)if(!(ce.flags&uw||H.min.x>ce.max.x||ce.min.x>H.max.x||H.min.y>ce.max.y||ce.min.y>H.max.y))for(let he=0;he<ce.footprintSegLen;he++){const ue=this.footprintSegments[ce.footprintSegIdx+he];if(le.length=0,wb(this.footprintVertices,ue.vertexOffset,ue.vertexCount,H.footprintTileId.canonical,C.canonical,le),Hv(H.footprint,le,this.footprintIndices.uint16,ue.indexOffset,ue.indexCount,-ue.vertexOffset,-te)){ce.flags|=uw;break}}}for(const C of this.centroidData)this.writeCentroidToBuffer(C);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(C,H,te){let le=!1;for(let ce=0;ce<te.footprintSegLen;ce++){const he=this.footprintSegments[te.footprintSegIdx+ce];let ue=0;for(const te of he.ringIndices){for(let ce=ue,de=te+ue-1;ce<te+ue;de=ce++){const te=this.footprintVertices.int16[2*(ce+he.vertexOffset)+0],ue=this.footprintVertices.int16[2*(ce+he.vertexOffset)+1],_e=this.footprintVertices.int16[2*(de+he.vertexOffset)+1];ue>H!=_e>H&&C<(this.footprintVertices.int16[2*(de+he.vertexOffset)+0]-te)*(H-ue)/(_e-ue)+te&&(le=!le)}ue=te}}return le}getHeightAtTileCoord(C,H){let te=Number.NEGATIVE_INFINITY,le=!0;const ce=4*(C+wn)*wn+(H+wn);if(this.partLookup.hasOwnProperty(ce)){const C=this.partLookup[ce];return C?{height:C.height,hidden:!!(C.flags&uw)}:void 0}for(const he of this.centroidData)C>he.max.x||he.min.x>C||H>he.max.y||he.min.y>H||this.footprintContainsPoint(C,H,he)&&he&&he.height>te&&(te=he.height,this.partLookup[ce]=he,le=!!(he.flags&uw));if(te!==Number.NEGATIVE_INFINITY)return{height:te,hidden:le};this.partLookup[ce]=void 0}}function pb(C,H){const te=C.add(H)._unit();return C.x*te.x+C.y*te.y}function fb(C,H,te,le){const ce=H.sub(C)._perp()._unit(),he=te.sub(H)._perp()._unit();return mb(C,H,te,pb(ce,he),le)}function mb(C,H,te,le,ce){const he=Math.sqrt(1-le*le);return Math.min(C.dist(H)/3,H.dist(te)/3,ce*he/le)}function _b(C,H,te){return C.x<te[0].x&&H.x<te[0].x||C.x>te[1].x&&H.x>te[1].x||C.y<te[0].y&&H.y<te[0].y||C.y>te[1].y&&H.y>te[1].y}function gb(C,H){return C.x<H[0].x||C.x>H[1].x||C.y<H[0].y||C.y>H[1].y}function yb(C,H,te){if(C.x<0||C.x>=wn||H.x<0||H.x>=wn||te.x<0||te.x>=wn)return!1;const le=te.sub(H),ce=le.perp(),he=C.sub(H);return(le.x*he.x+le.y*he.y)/Math.sqrt((le.x*le.x+le.y*le.y)*(he.x*he.x+he.y*he.y))>-.866&&ce.x*he.x+ce.y*he.y<0}function xb(C,H,te){const le=H?2|C:-3&C;return te?1|le:-2&le}function vb(){const C=Math.PI/32,H=Math.tan(C),te=kf;return te*Math.sqrt(1+2*H*H)-te}function bb(C,H,te){const le=1<<te.z,ce=$d(te.x/le),he=$d((te.x+1)/le),ue=Hd(te.y/le),de=Hd((te.y+1)/le);return function(C,H,te,le,ce=0,he){const ue=[];if(!C.length||!te||!le)return ue;const a=(C,H)=>{for(const te of C)ue.push({polygon:te,bounds:H})},de=Math.ceil(Math.log2(te)),_e=Math.ceil(Math.log2(le)),ye=de-_e,ve=[];for(let C=0;C<Math.abs(ye);C++)ve.push(ye>0?0:1);for(let C=0;C<Math.min(de,_e);C++)ve.push(0),ve.push(1);let Me=C;if(Me=rm(Me,H[0].y-ce,H[1].y+ce,1),Me=rm(Me,H[0].x-ce,H[1].x+ce,0),!Me.length)return ue;const Se=[];for(ve.length?Se.push({polygons:Me,bounds:H,depth:0}):a(Me,H);Se.length;){const C=Se.pop(),H=C.depth,te=ve[H],le=C.bounds[0],ue=C.bounds[1],de=0===te?le.x:le.y,_e=0===te?ue.x:ue.y,ye=he?he(te,de,_e):.5*(de+_e),Me=rm(C.polygons,de-ce,ye+ce,te),Ae=rm(C.polygons,ye-ce,_e+ce,te);if(Me.length){const C=[le,new Ne(0===te?ye:ue.x,1===te?ye:ue.y)];ve.length>H+1?Se.push({polygons:Me,bounds:C,depth:H+1}):a(Me,C)}if(Ae.length){const C=[new Ne(0===te?ye:le.x,1===te?ye:le.y),ue];ve.length>H+1?Se.push({polygons:Ae,bounds:C,depth:H+1}):a(Ae,C)}}return ue}(C,H,Math.ceil((he-ce)/11.25),Math.ceil((ue-de)/11.25),1,((C,H,ce)=>{if(0===C)return.5*(H+ce);{const C=Hd((te.y+H/wn)/le);return(qd(.5*(Hd((te.y+ce/wn)/le)+C))*le-te.y)*wn}}))}function wb(C,H,te,le,ce,he){const ue=Math.pow(2,le.z-ce.z);for(let de=0;de<te;de++){let te=C.int16[2*(de+H)+0],_e=C.int16[2*(de+H)+1];te=(te+ce.x*wn)*ue-le.x*wn,_e=(_e+ce.y*wn)*ue-le.y*wn,he.push(new Ne(te,_e))}}Is(db,"FillExtrusionBucket",{omit:["layers","features"]}),Is(sb,"PartData"),Is(ob,"FootprintSegment"),Is(ab,"BorderCentroidData"),Is(ub,"GroundEffect");const xw=new da({visibility:new ca(Ai["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new ca(Ai["layout_fill-extrusion"]["fill-extrusion-edge-radius"])});var Sw={paint:new da({"fill-extrusion-opacity":new ca(Ai["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new ha(Ai["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new ca(Ai["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new ca(Ai["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new ha(Ai["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new ha(Ai["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new ha(Ai["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new ca(Ai["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new ca(Ai["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new ca(Ai["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new ca(Ai["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new ca(Ai["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new ca(Ai["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new ca(Ai["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new ca(Ai["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new ha(Ai["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new ha(Ai["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new ca(Ai["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new ca(Ai["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new ca(Ai["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new ca(Ai["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"])}),layout:xw};class Mb extends Ne{constructor(C,H,te){super(C,H),this.z=te}}function Ab(C,H){return C.x*H.x+C.y*H.y}function Sb(C,H){if(1===C.length){let te=0;const le=H[te++];let ce;for(;!ce||le.equals(ce);)if(ce=H[te++],!ce)return 1/0;for(;te<H.length;te++){const he=H[te],ue=C[0],de=ce.sub(le),_e=he.sub(le),ye=ue.sub(le),ve=Ab(de,de),Me=Ab(de,_e),Se=Ab(_e,_e),Ae=Ab(ye,de),Ce=Ab(ye,_e),Oe=ve*Se-Me*Me,Ne=(Se*Ae-Me*Ce)/Oe,je=(ve*Ce-Me*Ae)/Oe,Ge=le.z*(1-Ne-je)+ce.z*Ne+he.z*je;if(isFinite(Ge))return Ge}return 1/0}{let C=1/0;for(const te of H)C=Math.min(C,te.z);return C}}function Ib(C,H,te,le,ce,he,ue,de){const _e=ue*ce.getElevationAt(C,H,!0,!0),ye=0!==he[0],ve=ye?0===he[1]?ue*(he[0]/7-450):ue*function(C,H,te){const le=Math.floor(H[0]/8),ce=Math.floor(H[1]/8),he=10*(H[0]-8*le),ue=10*(H[1]-8*ce),de=C.getElevationAt(le,ce,!0,!0),_e=C.getMeterToDEM(te),ye=Math.floor(.5*(he*_e-1)),ve=Math.floor(.5*(ue*_e-1)),Me=C.tileCoordToPixel(le,ce),Se=2*ye+1,Ae=2*ve+1,Ce=function(C,H,te,le,ce){return[C.getElevationAtPixel(H,te,!0),C.getElevationAtPixel(H+ce,te,!0),C.getElevationAtPixel(H,te+ce,!0),C.getElevationAtPixel(H+le,te+ce,!0)]}(C,Me.x-ye,Me.y-ve,Se,Ae),Oe=Math.abs(Ce[0]-Ce[1]),Ne=Math.abs(Ce[2]-Ce[3]),je=Math.abs(Ce[0]-Ce[2])+Math.abs(Ce[1]-Ce[3]),Ge=Math.min(.25,.5*_e*(Oe+Ne)/Se),Ze=Math.min(.25,.5*_e*je/Ae);return de+Math.max(Ge*he,Ze*ue)}(ce,he,de):_e;return{base:_e+(0===te)?-1:te,top:ye?Math.max(ve+le,_e+te+2):_e+le}}const kw=new da({"line-cap":new ha(Ai.layout_line["line-cap"]),"line-join":new ha(Ai.layout_line["line-join"]),"line-miter-limit":new ca(Ai.layout_line["line-miter-limit"]),"line-round-limit":new ca(Ai.layout_line["line-round-limit"]),"line-sort-key":new ha(Ai.layout_line["line-sort-key"]),visibility:new ca(Ai.layout_line.visibility)});var Bw={paint:new da({"line-opacity":new ha(Ai.paint_line["line-opacity"]),"line-color":new ha(Ai.paint_line["line-color"]),"line-translate":new ca(Ai.paint_line["line-translate"]),"line-translate-anchor":new ca(Ai.paint_line["line-translate-anchor"]),"line-width":new ha(Ai.paint_line["line-width"]),"line-gap-width":new ha(Ai.paint_line["line-gap-width"]),"line-offset":new ha(Ai.paint_line["line-offset"]),"line-blur":new ha(Ai.paint_line["line-blur"]),"line-dasharray":new ha(Ai.paint_line["line-dasharray"]),"line-pattern":new ha(Ai.paint_line["line-pattern"]),"line-gradient":new ua(Ai.paint_line["line-gradient"]),"line-trim-offset":new ca(Ai.paint_line["line-trim-offset"]),"line-emissive-strength":new ca(Ai.paint_line["line-emissive-strength"]),"line-border-width":new ha(Ai.paint_line["line-border-width"]),"line-border-color":new ha(Ai.paint_line["line-border-color"])}),layout:kw};const Db=(C,H,te,le,ce,he,ue)=>{const de=C.transform,_e=de.calculatePixelsToTileUnitsMatrix(H);return{u_matrix:Lb(C,H,te,le),u_pixels_to_tile_units:_e,u_device_pixel_ratio:he,u_units_to_pixels:[1/de.pixelsToGLUnits[0],1/de.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:ce,u_texsize:Ob(te)?H.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:Rb(H,C.transform),u_alpha_discard_threshold:0,u_trim_offset:ue,u_emissive_strength:te.paint.get("line-emissive-strength")}},Pb=(C,H,te,le,ce)=>{const he=C.transform;return{u_matrix:Lb(C,H,te,le),u_texsize:H.imageAtlasTexture.size,u_pixels_to_tile_units:he.calculatePixelsToTileUnitsMatrix(H),u_device_pixel_ratio:ce,u_image:0,u_tile_units_to_pixels:Rb(H,he),u_units_to_pixels:[1/he.pixelsToGLUnits[0],1/he.pixelsToGLUnits[1]],u_alpha_discard_threshold:0}};function Rb(C,H){return 1/Xx(C,1,H.tileZoom)}function Lb(C,H,te,le){return C.translatePosMatrix(le||H.tileID.projMatrix,H,te.paint.get("line-translate"),te.paint.get("line-translate-anchor"))}const kb=C=>{const H=[];Ob(C)&&H.push("RENDER_LINE_DASH"),C.paint.get("line-gradient")&&H.push("RENDER_LINE_GRADIENT");const te=C.paint.get("line-trim-offset");return 0===te[0]&&0===te[1]||H.push("RENDER_LINE_TRIM_OFFSET"),0!==C.paint.get("line-border-width").constantOr(1)&&H.push("RENDER_LINE_BORDER"),H};function Ob(C){const H=C.paint.get("line-dasharray").value;return H.value||"constant"!==H.kind}const Nw=new class extends ha{possiblyEvaluate(C,H){return H=new ea(Math.floor(H.zoom),{now:H.now,fadeDuration:H.fadeDuration,transition:H.transition}),super.possiblyEvaluate(C,H)}evaluate(C,H,te,le){return H=k({},H,{zoom:Math.floor(H.zoom)}),super.evaluate(C,H,te,le)}}(Bw.paint.properties["line-width"].specification);function Fb(C,H){return H>0?H+2*C:C}Nw.useIntegerZoom=!0;const Vw=new da({visibility:new ca(Ai.layout_background.visibility)});var jw={paint:new da({"background-color":new ca(Ai.paint_background["background-color"]),"background-pattern":new ca(Ai.paint_background["background-pattern"]),"background-opacity":new ca(Ai.paint_background["background-opacity"]),"background-emissive-strength":new ca(Ai.paint_background["background-emissive-strength"])}),layout:Vw};const Gw=new da({visibility:new ca(Ai.layout_raster.visibility)});var qw={paint:new da({"raster-opacity":new ca(Ai.paint_raster["raster-opacity"]),"raster-color":new ua(Ai.paint_raster["raster-color"]),"raster-color-mix":new ca(Ai.paint_raster["raster-color-mix"]),"raster-color-range":new ca(Ai.paint_raster["raster-color-range"]),"raster-hue-rotate":new ca(Ai.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new ca(Ai.paint_raster["raster-brightness-min"]),"raster-brightness-max":new ca(Ai.paint_raster["raster-brightness-max"]),"raster-saturation":new ca(Ai.paint_raster["raster-saturation"]),"raster-contrast":new ca(Ai.paint_raster["raster-contrast"]),"raster-resampling":new ca(Ai.paint_raster["raster-resampling"]),"raster-fade-duration":new ca(Ai.paint_raster["raster-fade-duration"])}),layout:Gw};function Gb(C,H,te,le,ce,he,ue,de){const _e=[C,te,ce,H,le,he,1,1,1],ye=[ue,de,1],ve=Ju.adjoint([],_e),[Me,Se,Ae]=Ld.transformMat3(ye,ye,Ju.transpose(ve,ve));return Ju.multiply(_e,[Me,0,0,0,Se,0,0,0,Ae],_e)}class qb extends It{constructor(C,H,te,le){super(),this.id=C,this.dispatcher=te,this.coordinates=H.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(le),this.options=H,this._dirty=!1}load(C,H){if(this._loaded=H||!1,this.fire(new At("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return C&&(this.coordinates=C),this._loaded=!0,void this._finishLoading();this._imageRequest=Ie(this.map._requestManager.transformRequest(this.url,ot.Image),((H,le)=>{if(this._imageRequest=null,this._loaded=!0,H)this.fire(new St(H));else if(le){const{HTMLImageElement:H}=te;this.image=le instanceof H?yi.getImageData(le):le,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,C&&(this.coordinates=C),this._finishLoading()}}))}loaded(){return this._loaded}updateImage(C){return this.image&&C.url?(this._imageRequest&&C.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=C.url,this.load(C.coordinates,this._loaded),this):this}setTexture(C){if(!(C.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new yy(this.map.painter.context,C.handle),this.width=C.dimensions[0],this.height=C.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new At("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(C){this.map=C,this.load()}onRemove(){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof yy||this.texture.destroy()}setCoordinates(C){if(this.coordinates=C,this._boundsArray=void 0,!C.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let H=C[0][1],te=C[0][1];for(const le of C)le[1]>te&&(te=le[1]),le[1]<H&&(H=le[1]);const le=(te+H)/2;if(le>Uf?this.onNorthPole=!0:le<-Uf&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){const H=C.map(ep.fromLngLat);this.tileID=function(C){let H=1/0,te=1/0,le=-1/0,ce=-1/0;for(const he of C)H=Math.min(H,he.x),te=Math.min(te,he.y),le=Math.max(le,he.x),ce=Math.max(ce,he.y);const he=Math.max(le-H,ce-te),ue=Math.max(0,Math.floor(-Math.log(he)/Math.LN2)),de=Math.pow(2,ue);return new ku(ue,Math.floor((H+le)/2*de),Math.floor((te+ce)/2*de))}(H),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new At("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){this._boundsArray=void 0}_prepareData(C){for(const C in this.tiles){const H=this.tiles[C];"loaded"!==H.state&&(H.state="loaded",H.texture=this.texture)}if(this._boundsArray)return;const H=Tg(this.tileID,this.map.transform.projection),[te,le,ce,he]=this.coordinates.map((C=>{const te=H.projection.project(C[0],C[1]);return Mg(H,te)._round()}));this.perspectiveTransform=function(C,H,te,le,ce,he,ue,de,_e,ye){const ve=Gb(0,0,C,0,0,H,C,H),Me=Gb(te,le,ce,he,ue,de,_e,ye);return Ju.multiply(Me,Ju.adjoint(ve,ve),Me),[Me[6]/Me[8]*C/wn,Me[7]/Me[8]*H/wn]}(this.width,this.height,te.x,te.y,le.x,le.y,he.x,he.y,ce.x,ce.y);const ue=this._boundsArray=new Ma;ue.emplaceBack(te.x,te.y,0,0),ue.emplaceBack(le.x,le.y,wn,0),ue.emplaceBack(he.x,he.y,0,wn),ue.emplaceBack(ce.x,ce.y,wn,wn),this.boundsBuffer&&this.boundsBuffer.destroy(),this.boundsBuffer=C.createVertexBuffer(ue,Dv.members),this.boundsSegments=dl.simpleSegment(0,0,4,2)}prepare(){const C=0!==Object.keys(this.tiles).length;if(this.tileID&&!C)return;const H=this.map.painter.context,te=H.gl;!this._dirty||this.texture instanceof yy||(this.texture?this.texture.update(this.image):(this.texture=new gy(H,this.image,te.RGBA),this.texture.bind(te.LINEAR,te.CLAMP_TO_EDGE)),this._dirty=!1),C&&this._prepareData(H)}loadTile(C,H){this.tileID&&this.tileID.equals(C.tileID.canonical)?(this.tiles[String(C.tileID.wrap)]=C,C.buckets={},H(null)):(C.state="errored",H(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}}class Zb extends _a{constructor(C){super(C,{}),this.implementation=C,C.slot&&(this.slot=C.slot)}is3D(){return"3d"===this.implementation.renderingMode}hasOffscreenPass(){return void 0!==this.implementation.prerender}isLayerDraped(C){return void 0!==this.implementation.renderToTile}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(C){this.implementation.onAdd&&this.implementation.onAdd(C,C.painter.context.gl)}onRemove(C){this.implementation.onRemove&&this.implementation.onRemove(C,C.painter.context.gl)}}const $w=new da({visibility:new ca(Ai.layout_sky.visibility)});var Ww={paint:new da({"sky-type":new ca(Ai.paint_sky["sky-type"]),"sky-atmosphere-sun":new ca(Ai.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new ca(Ai.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new ca(Ai.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new ca(Ai.paint_sky["sky-gradient-radius"]),"sky-gradient":new ua(Ai.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new ca(Ai.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new ca(Ai.paint_sky["sky-atmosphere-color"]),"sky-opacity":new ca(Ai.paint_sky["sky-opacity"])}),layout:$w};function Wb(C,H,te){const le=[0,0,1],ce=id.identity([]);return id.rotateY(ce,ce,te?-w(C)+Math.PI:w(C)),id.rotateX(ce,ce,-w(H)),Ld.transformQuat(le,le,ce),Ld.normalize(le,le)}var Hw={paint:new da({})};const Xw={circle:class extends _a{constructor(C,H){super(C,Zf,H)}createBucket(C){return new dp(C)}queryRadius(C){const H=C;return Sp("circle-radius",this,H)+Sp("circle-stroke-width",this,H)+Ip(this.paint.get("circle-translate"))}queryIntersectsFeature(C,H,te,le,ce,he,ue,de){const _e=zp(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),he.angle,C.pixelToTileUnitsFactor),ye=this.paint.get("circle-radius").evaluate(H,te)+this.paint.get("circle-stroke-width").evaluate(H,te);return Op(C,le,he,ue,de,"map"===this.paint.get("circle-pitch-alignment"),"map"===this.paint.get("circle-pitch-scale"),_e,ye)}getProgramIds(){return["circle"]}getDefaultProgramParams(C,H){const te=kp(this);return{config:new $l(this,H),defines:te,overrideFog:!1}}},heatmap:class extends _a{createBucket(C){return new Vp(C)}constructor(C,H){super(C,tm,H),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(C){"heatmap-color"===C&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Yp({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(C){return Sp("heatmap-radius",this,C)}queryIntersectsFeature(C,H,te,le,ce,he,ue,de){const _e=this.paint.get("heatmap-radius").evaluate(H,te);return Op(C,le,he,ue,de,!0,!0,new Ne(0,0),_e)}hasOffscreenPass(){return 0!==this.paint.get("heatmap-opacity")&&"none"!==this.visibility}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(C,H){return"heatmap"===C?{config:new $l(this,H),overrideFog:!1}:{}}},hillshade:class extends _a{constructor(C,H){super(C,om,H)}hasOffscreenPass(){return 0!==this.paint.get("hillshade-exaggeration")&&"none"!==this.visibility}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(C,H){return{overrideFog:!1}}},fill:class extends _a{constructor(C,H){super(C,Sm,H)}getProgramIds(){const C=this.paint.get("fill-pattern"),H=C&&C.constantOr(1),te=[H?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&te.push(H&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),te}getDefaultProgramParams(C,H){return{config:new $l(this,H),overrideFog:!1}}recalculate(C,H){super.recalculate(C,H);const te=this.paint._values["fill-outline-color"];"constant"===te.value.kind&&void 0===te.value.value&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(C){return new Lf(C)}queryRadius(){return Ip(this.paint.get("fill-translate"))}queryIntersectsFeature(C,H,te,le,ce,he){return!C.queryGeometry.isAboveHorizon&&mp(Cp(C.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),he.angle,C.pixelToTileUnitsFactor),le)}isTileClipped(){return!0}},"fill-extrusion":class extends _a{constructor(C,H){super(C,Sw,H)}createBucket(C){return new db(C)}queryRadius(){return Ip(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}hasShadowPass(){return!0}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(C,H,te,le,ce,he,ue,de,_e){const ye=zp(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),he.angle,C.pixelToTileUnitsFactor),ve=this.paint.get("fill-extrusion-height").evaluate(H,te),Me=this.paint.get("fill-extrusion-base").evaluate(H,te),Se=[0,0],Ae=de&&he.elevation,Ce=he.elevation?he.elevation.exaggeration():1,Oe=C.tile.getBucket(this);if(Ae&&Oe instanceof db){const C=Oe.centroidVertexArray,H=_e+1;H<C.length&&(Se[0]=C.geta_centroid_pos0(H),Se[1]=C.geta_centroid_pos1(H))}if(0===Se[0]&&1===Se[1])return!1;"globe"===he.projection.name&&(le=bb([le],[new Ne(0,0),new Ne(wn,wn)],C.tileID.canonical).map((C=>C.polygon)).flat());const je=Ae?de:null,[Ge,Ze]=function(C,H,te,le,ce,he,ue,de,_e,ye,ve){return"globe"===C.projection.name?function(C,H,te,le,ce,he,ue,de,_e,ye,ve){const Me=[],Se=[],Ae=C.projection.upVectorScale(ve,C.center.lat,C.worldSize).metersToTile,Ce=[0,0,0,1],Oe=[0,0,0,1],_=(C,H,te,le)=>{C[0]=H,C[1]=te,C[2]=le,C[3]=1},Ne=vb();te>0&&(te+=Ne),le+=Ne;for(const Ne of H){const H=[],je=[];for(const Me of Ne){const Se=Me.x+ce.x,Ne=Me.y+ce.y,Ge=C.projection.projectTilePoint(Se,Ne,ve),Ze=C.projection.upVector(ve,Me.x,Me.y);let qe=te,$e=le;if(ue){const C=Ib(Se,Ne,te,le,ue,de,_e,ye);qe+=C.base,$e+=C.top}0!==te?_(Ce,Ge.x+Ze[0]*Ae*qe,Ge.y+Ze[1]*Ae*qe,Ge.z+Ze[2]*Ae*qe):_(Ce,Ge.x,Ge.y,Ge.z),_(Oe,Ge.x+Ze[0]*Ae*$e,Ge.y+Ze[1]*Ae*$e,Ge.z+Ze[2]*Ae*$e),Ld.transformMat4(Ce,Ce,he),Ld.transformMat4(Oe,Oe,he),H.push(new Mb(Ce[0],Ce[1],Ce[2])),je.push(new Mb(Oe[0],Oe[1],Oe[2]))}Me.push(H),Se.push(je)}return[Me,Se]}(C,H,te,le,ce,he,ue,de,_e,ye,ve):ue?function(C,H,te,le,ce,he,ue,de,_e){const ye=[],ve=[],Me=[0,0,0,1];for(const Se of C){const C=[],Ae=[];for(const ye of Se){const ve=ye.x+le.x,Se=ye.y+le.y,Ce=Ib(ve,Se,H,te,he,ue,de,_e);Me[0]=ve,Me[1]=Se,Me[2]=Ce.base,Me[3]=1,Lu.transformMat4(Me,Me,ce),Me[3]=Math.max(Me[3],1e-5);const Oe=new Mb(Me[0]/Me[3],Me[1]/Me[3],Me[2]/Me[3]);Me[0]=ve,Me[1]=Se,Me[2]=Ce.top,Me[3]=1,Lu.transformMat4(Me,Me,ce),Me[3]=Math.max(Me[3],1e-5);const Ne=new Mb(Me[0]/Me[3],Me[1]/Me[3],Me[2]/Me[3]);C.push(Oe),Ae.push(Ne)}ye.push(C),ve.push(Ae)}return[ye,ve]}(H,te,le,ce,he,ue,de,_e,ye):function(C,H,te,le,ce){const he=[],ue=[],de=ce[8]*H,_e=ce[9]*H,ye=ce[10]*H,ve=ce[11]*H,Me=ce[8]*te,Se=ce[9]*te,Ae=ce[10]*te,Ce=ce[11]*te;for(const H of C){const C=[],te=[];for(const he of H){const H=he.x+le.x,ue=he.y+le.y,Oe=ce[0]*H+ce[4]*ue+ce[12],Ne=ce[1]*H+ce[5]*ue+ce[13],je=ce[2]*H+ce[6]*ue+ce[14],Ge=ce[3]*H+ce[7]*ue+ce[15],Ze=Oe+de,qe=Ne+_e,$e=je+ye,We=Math.max(Ge+ve,1e-5),He=Oe+Me,Xe=Ne+Se,Ye=je+Ae,Je=Math.max(Ge+Ce,1e-5);C.push(new Mb(Ze/We,qe/We,$e/We)),te.push(new Mb(He/Je,Xe/Je,Ye/Je))}he.push(C),ue.push(te)}return[he,ue]}(H,te,le,ce,he)}(he,le,Me,ve,ye,ue,je,Se,Ce,he.center.lat,C.tileID.canonical),qe=C.queryGeometry;return function(C,H,te){let le=1/0;mp(te,H)&&(le=Sb(te,H[0]));for(let ce=0;ce<H.length;ce++){const he=H[ce],ue=C[ce];for(let C=0;C<he.length-1;C++){const H=he[C],ce=[H,he[C+1],ue[C+1],ue[C],H];pp(te,ce)&&(le=Math.min(le,Sb(te,ce)))}}return le!==1/0&&le}(Ge,Ze,qe.isPointQuery()?qe.screenBounds:qe.screenGeometry)}},line:class extends _a{constructor(C,H){super(C,Bw,H),this.gradientVersion=0}_handleSpecialPaintPropertyUpdate(C){if("line-gradient"===C){const C=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=C._styleExpression&&C._styleExpression.expression instanceof Ln,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(C,H){super.recalculate(C,H),this.paint._values["line-floorwidth"]=Nw.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,C)}createBucket(C){return new _y(C)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(C,H){const te=kb(this);return{config:new $l(this,H),defines:te,overrideFog:!1}}queryRadius(C){const H=C,te=Fb(Sp("line-width",this,H),Sp("line-gap-width",this,H)),le=Sp("line-offset",this,H);return te/2+Math.abs(le)+Ip(this.paint.get("line-translate"))}queryIntersectsFeature(C,H,te,le,ce,he){if(C.queryGeometry.isAboveHorizon)return!1;const ue=Cp(C.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),he.angle,C.pixelToTileUnitsFactor),de=C.pixelToTileUnitsFactor/2*Fb(this.paint.get("line-width").evaluate(H,te),this.paint.get("line-gap-width").evaluate(H,te)),_e=this.paint.get("line-offset").evaluate(H,te);return _e&&(le=function(C,H){const te=[],le=new Ne(0,0);for(let ce=0;ce<C.length;ce++){const he=C[ce],ue=[];for(let C=0;C<he.length;C++){const te=he[C],ce=he[C+1],de=0===C?le:te.sub(he[C-1])._unit()._perp(),_e=C===he.length-1?le:ce.sub(te)._unit()._perp(),ye=de._add(_e)._unit();ye._mult(1/(ye.x*_e.x+ye.y*_e.y)),ue.push(ye._mult(H)._add(te))}te.push(ue)}return te}(le,_e*C.pixelToTileUnitsFactor)),function(C,H,te){for(let le=0;le<H.length;le++){const ce=H[le];if(C.length>=3)for(let H=0;H<ce.length;H++)if(wp(C,ce[H]))return!0;if(_p(C,ce,te))return!0}return!1}(ue,le,de)}isTileClipped(){return!0}},symbol:Kg,background:class extends _a{constructor(C,H){super(C,jw,H)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(C,H){return{overrideFog:!1}}},raster:class extends _a{constructor(C,H){super(C,qw,H),this._updateColorRamp()}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}isLayerDraped(C){return!(C&&C._source instanceof qb&&(C._source.onNorthPole||C._source.onSouthPole))}_handleSpecialPaintPropertyUpdate(C){"raster-color"!==C&&"raster-color-range"!==C||this._updateColorRamp()}_updateColorRamp(){if(!this.hasColorMap())return;const C=this._transitionablePaint._values["raster-color"].value.expression,[H,te]=this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0});this.colorRamp=Yp({expression:C,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:H,end:te}],resolution:256}),this.colorRampTexture=null}},sky:class extends _a{constructor(C,H){super(C,Ww,H),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(C){"sky-gradient"===C?this._updateColorRamp():"sky-atmosphere-sun"!==C&&"sky-atmosphere-halo-color"!==C&&"sky-atmosphere-color"!==C&&"sky-atmosphere-sun-intensity"!==C||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=Yp({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(C){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const H=C.style.light.properties.get("position");return this._lightPosition.azimuthal!==H.azimuthal||this._lightPosition.polar!==H.polar}return!1}getCenter(C,H){if("atmosphere"===this.paint.get("sky-type")){const te=this.paint.get("sky-atmosphere-sun"),le=!te,ce=C.style.light,he=ce.properties.get("position");return le&&"viewport"===ce.properties.get("anchor")&&W("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),le?Wb(he.azimuthal,90-he.polar,H):Wb(te[0],90-te[1],H)}const te=this.paint.get("sky-gradient-center");return Wb(te[0],90-te[1],H)}isSky(){return!0}markSkyboxValid(C){this._skyboxInvalidated=!1,this._lightPosition=C.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const C=this.paint.get("sky-type");return"atmosphere"===C?["skyboxCapture","skybox"]:"gradient"===C?["skyboxGradient"]:null}},slot:class extends _a{constructor(C,H){super(C,Hw)}},model:class extends _a{constructor(C,H){super(C,$b,H)}createBucket(C){return new Cv(C)}getProgramIds(){return["model"]}is3D(){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(){return 0}queryIntersectsFeature(){return!1}_handleOverridablePaintPropertyUpdate(C,H,te){return!(!this.layout||H.isDataDriven()||te.isDataDriven()||"model-color"!==C&&"model-color-mix-intensity"!==C&&"model-rotation"!==C&&"model-scale"!==C&&"model-translation"!==C&&"model-emissive-strength"!==C)}_isPropertyZoomDependent(C){const H=this._transitionablePaint._values[C];return null!=H&&null!=H.value&&null!=H.value.expression&&H.value.expression instanceof bo}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}}};function Kb(C,H){return"custom"===C.type?new Zb(C):new Xw[C.type](C,H)}function Jb(C){const{userImage:H}=C;return!!(H&&H.render&&H.render())&&(C.data.replace(new Uint8Array(H.data.buffer)),!0)}class Qb extends It{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded={},this.requestors=[],this.patterns={},this.atlasImage={},this.atlasTexture={},this.dirty=!0}createScope(C){this.images[C]={},this.loaded[C]=!1,this.updatedImages[C]={},this.patterns[C]={},this.callbackDispatchedThisFrame[C]={},this.atlasImage[C]=new $p({width:1,height:1})}isLoaded(){for(const C in this.loaded)if(!this.loaded[C])return!1;return!0}setLoaded(C,H){if(this.loaded[H]!==C&&(this.loaded[H]=C,C)){for(const{ids:C,callback:te}of this.requestors)this._notify(C,H,te);this.requestors=[]}}hasImage(C,H){return!!this.getImage(C,H)}getImage(C,H){return this.images[H][C]}addImage(C,H,te){this._validate(C,te)&&(this.images[H][C]=te)}_validate(C,H){let te=!0;return this._validateStretch(H.stretchX,H.data&&H.data.width)||(this.fire(new St(new Error(`Image "${C}" has invalid "stretchX" value`))),te=!1),this._validateStretch(H.stretchY,H.data&&H.data.height)||(this.fire(new St(new Error(`Image "${C}" has invalid "stretchY" value`))),te=!1),this._validateContent(H.content,H)||(this.fire(new St(new Error(`Image "${C}" has invalid "content" value`))),te=!1),te}_validateStretch(C,H){if(!C)return!0;let te=0;for(const le of C){if(le[0]<te||le[1]<le[0]||H<le[1])return!1;te=le[1]}return!0}_validateContent(C,H){return!(C&&(4!==C.length||C[0]<0||H.data.width<C[0]||C[1]<0||H.data.height<C[1]||C[2]<0||H.data.width<C[2]||C[3]<0||H.data.height<C[3]||C[2]<C[0]||C[3]<C[1]))}updateImage(C,H,te){te.version=this.images[H][C].version+1,this.images[H][C]=te,this.updatedImages[H][C]=!0}removeImage(C,H){const te=this.images[H][C];delete this.images[H][C],delete this.patterns[H][C],te.userImage&&te.userImage.onRemove&&te.userImage.onRemove()}listImages(C){return Object.keys(this.images[C])}getImages(C,H,te){let le=!0;const ce=!!this.loaded[H];if(!ce)for(const te of C)this.images[H][te]||(le=!1);ce||le?this._notify(C,H,te):this.requestors.push({ids:C,scope:H,callback:te})}getUpdatedImages(C){return this.updatedImages[C]}_notify(C,H,te){const le={};for(const te of C){this.images[H][te]||this.fire(new At("styleimagemissing",{id:te}));const C=this.images[H][te];C?le[te]={data:C.data.clone(),pixelRatio:C.pixelRatio,sdf:C.sdf,version:C.version,stretchX:C.stretchX,stretchY:C.stretchY,content:C.content,hasRenderCallback:Boolean(C.userImage&&C.userImage.render)}:W(`Image "${te}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}te(null,le)}getPixelSize(C){const{width:H,height:te}=this.atlasImage[C];return{width:H,height:te}}getPattern(C,H){const te=this.patterns[H][C],le=this.getImage(C,H);if(!le)return null;if(te&&te.position.version===le.version)return te.position;if(te)te.position.version=le.version;else{const te={w:le.data.width+2,h:le.data.height+2,x:0,y:0},ce=new v_(te,le);this.patterns[H][C]={bin:te,position:ce}}return this._updatePatternAtlas(H),this.patterns[H][C].position}bind(C,H){const te=C.gl;let le=this.atlasTexture[H];le?this.dirty&&(le.update(this.atlasImage[H]),this.dirty=!1):(le=new gy(C,this.atlasImage[H],te.RGBA),this.atlasTexture[H]=le),le.bind(te.LINEAR,te.CLAMP_TO_EDGE)}_updatePatternAtlas(C){const H=[];for(const te in this.patterns[C])H.push(this.patterns[C][te].bin);const{w:te,h:le}=y_(H),ce=this.atlasImage[C];ce.resize({width:te||1,height:le||1});for(const H in this.patterns[C]){const{bin:te}=this.patterns[C][H],le=te.x+1,he=te.y+1,ue=this.images[C][H].data,de=ue.width,_e=ue.height;$p.copy(ue,ce,{x:0,y:0},{x:le,y:he},{width:de,height:_e}),$p.copy(ue,ce,{x:0,y:_e-1},{x:le,y:he-1},{width:de,height:1}),$p.copy(ue,ce,{x:0,y:0},{x:le,y:he+_e},{width:de,height:1}),$p.copy(ue,ce,{x:de-1,y:0},{x:le-1,y:he},{width:1,height:_e}),$p.copy(ue,ce,{x:0,y:0},{x:le+de,y:he},{width:1,height:_e})}this.dirty=!0}beginFrame(){for(const C in this.images)this.callbackDispatchedThisFrame[C]={}}dispatchRenderCallbacks(C,H){for(const te of C){if(this.callbackDispatchedThisFrame[H][te])continue;this.callbackDispatchedThisFrame[H][te]=!0;const C=this.images[H][te];Jb(C)&&this.updateImage(te,H,C)}}}const Yw=new da({anchor:new ca(Ai.light.anchor),position:new class{constructor(C){this.specification=C}possiblyEvaluate(C,H){return K(C.expression.evaluate(H))}interpolate(C,H,te){return{x:Wr(C.x,H.x,te),y:Wr(C.y,H.y,te),z:Wr(C.z,H.z,te),azimuthal:Wr(C.azimuthal,H.azimuthal,te),polar:Wr(C.polar,H.polar,te)}}}(Ai.light.position),color:new ca(Ai.light.color),intensity:new ca(Ai.light.intensity)});class tw extends It{constructor(C,H="flat"){super(),this._transitionable=new ra(Yw),this.setLight(C,H),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(C,H,te={}){this._validate(ds,C,te)||(this._transitionable.setTransitionOrValue(C),this.id=H)}updateTransitions(C){this._transitioning=this._transitionable.transitioned(C,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(C){this.properties=this._transitioning.possiblyEvaluate(C)}_validate(C,H,te){return(!te||!1!==te.validate)&&ws(this,C.call(hs,k({value:H,style:{glyphs:!0,sprite:!0},styleSpec:Ai})))}}const Jw=new da({source:new ca(Ai.terrain.source),exaggeration:new ca(Ai.terrain.exaggeration)});let eT=class extends It{constructor(C,H){super(),this._transitionable=new ra(Jw),this.set(C),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=H}setScope(C){this.scope=C}get(){return this._transitionable.serialize()}set(C){this._transitionable.setTransitionOrValue(C)}updateTransitions(C){this._transitioning=this._transitionable.transitioned(C,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(C){this.properties=this._transitioning.possiblyEvaluate(C)}getExaggeration(C){return this._transitioning.possiblyEvaluate(new ea(C)).get("exaggeration")}isZoomDependent(){const C=this._transitionable._values.exaggeration;return null!=C&&null!=C.value&&null!=C.value.expression&&C.value.expression instanceof bo}};const tT=45,xT=65,AT=.05;function aw(C,H,te,le){const ce=D(tT,xT,te),[he,ue]=lw(C,le);let de=1-Math.min(1,Math.exp((H-he)/(ue-he)*-6));return de*=de*de,de=Math.min(1,1.00747*de),de*ce*C.alpha}function lw(C,H){const te=.5/Math.tan(.5*H);return[C.range[0]+te,C.range[1]+te]}function cw(C,H,te,le,ce){const he=Ld.transformMat4([],[H,te,le],ce.mercatorFogMatrix);return aw(C,Ld.length(he),ce.pitch,ce._fov)}function hw(C,H,te,le,ce,he,ue){const de=[[te,le,0],[ce,le,0],[ce,he,0],[te,he,0]];let _e=Number.MAX_VALUE,ye=-Number.MAX_VALUE;for(const C of de){const te=Ld.transformMat4([],C,H),le=Ld.length(te);_e=Math.min(_e,le),ye=Math.max(ye,le)}return[aw(C,_e,ue.pitch,ue._fov),aw(C,ye,ue.pitch,ue._fov)]}const CT=new da({range:new ca(Ai.fog.range),color:new ca(Ai.fog.color),"high-color":new ca(Ai.fog["high-color"]),"space-color":new ca(Ai.fog["space-color"]),"horizon-blend":new ca(Ai.fog["horizon-blend"]),"star-intensity":new ca(Ai.fog["star-intensity"]),"vertical-range":new ca(Ai.fog["vertical-range"])});class dw extends It{constructor(C,H){super(),this._transitionable=new ra(CT),this.set(C),this._transitioning=this._transitionable.untransitioned(),this._transform=H}get state(){const C=this._transform,H="globe"===C.projection.name,te=Ed(C.zoom),le=this.properties.get("range"),ce=[.5,3];return{range:H?[Wr(ce[0],le[0],te),Wr(ce[1],le[1],te)]:le,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(C,H={}){if(this._validate(ms,C,H))return;const te=k({},C);for(const C of Object.keys(Ai.fog))void 0===te[C]&&(te[C]=Ai.fog[C].default);this._transitionable.setTransitionOrValue(te)}getOpacity(C){if(!this._transform.projection.supportsFog)return 0;const H=this.properties&&this.properties.get("color")||1;return("globe"===this._transform.projection.name?1:D(tT,xT,C))*H.a}getOpacityAtLatLng(C,H){return this._transform.projection.supportsFog?function(C,H,te){const le=ep.fromLngLat(H),ce=te.elevation?te.elevation.getAtPointOrZero(le):0;return cw(C,le.x,le.y,ce,te)}(this.state,C,H):0}getOpacityForTile(C){if(!this._transform.projection.supportsFog)return[1,1];const H=this._transform.calculateFogTileMatrix(C.toUnwrapped());return hw(this.state,H,0,0,wn,wn,this._transform)}getOpacityForBounds(C,H,te,le,ce){return this._transform.projection.supportsFog?hw(this.state,C,H,te,le,ce,this._transform):[1,1]}getFovAdjustedRange(C){return this._transform.projection.supportsFog?lw(this.state,C):[0,1]}isVisibleOnFrustum(C){if(!this._transform.projection.supportsFog)return!1;const H=[4,5,6,7];for(const te of H){const H=C.points[te];let le;if(H[2]>=0)le=H;else{const ce=C.points[te-4];le=Xr(ce,H,ce[2]/(ce[2]-H[2]))}if(cw(this.state,le[0],le[1],0,this._transform)>=AT)return!0}return!1}updateTransitions(C){this._transitioning=this._transitionable.transitioned(C,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(C){this.properties=this._transitioning.possiblyEvaluate(C)}_validate(C,H,te){return(!te||!1!==te.validate)&&ws(this,C.call(hs,k({value:H,style:{glyphs:!0,sprite:!0},styleSpec:Ai})))}}class pw{constructor(C){this._callback=C,this._triggered=!1,"undefined"!=typeof MessageChannel&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout((()=>{this._triggered=!1,this._callback()}),0))}remove(){this._channel=void 0,this._callback=()=>{}}}class fw{constructor(){this.tasks={},this.taskQueue=[],j(["process"],this),this.invoker=new pw(this.process),this.nextId=0}add(C,H){const te=this.nextId++,le=function({type:C,isSymbolTile:H,zoom:te}){return te=te||0,"message"===C?0:"maybePrepare"!==C||H?"parseTile"!==C||H?"parseTile"===C&&H?300-te:"maybePrepare"===C&&H?400-te:500:200-te:100-te}(H);if(0===le){Q();try{C()}finally{}return{cancel:()=>{}}}return this.tasks[te]={fn:C,metadata:H,priority:le,id:te},this.taskQueue.push(te),this.invoker.trigger(),{cancel:()=>{delete this.tasks[te]}}}process(){Q();try{if(this.taskQueue=this.taskQueue.filter((C=>!!this.tasks[C])),!this.taskQueue.length)return;const C=this.pick();if(null===C)return;const H=this.tasks[C];if(delete this.tasks[C],this.taskQueue.length&&this.invoker.trigger(),!H)return;H.fn()}finally{}}pick(){let C=null,H=1/0;for(let te=0;te<this.taskQueue.length;te++){const le=this.tasks[this.taskQueue[te]];le.priority<H&&(H=le.priority,C=te)}if(null===C)return null;const te=this.taskQueue[C];return this.taskQueue.splice(C,1),te}remove(){this.invoker.remove()}}class mw{constructor(C,H,te){this.target=C,this.parent=H,this.mapId=te,this.callbacks={},this.cancelCallbacks={},j(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new fw}send(C,H,te,le,ce=!1,he){const ue=Math.round(1e18*Math.random()).toString(36).substring(0,10);te&&(te.metadata=he,this.callbacks[ue]=te);const de=new Set;return this.target.postMessage({id:ue,type:C,hasCallback:!!te,targetMapId:le,mustQueue:ce,sourceMapId:this.mapId,data:Ds(H,de)},de),{cancel:()=>{te&&delete this.callbacks[ue],this.target.postMessage({id:ue,type:"<cancel>",targetMapId:le,sourceMapId:this.mapId})}}}receive(C){const H=C.data,te=H.id;if(te&&(!H.targetMapId||this.mapId===H.targetMapId))if("<cancel>"===H.type){const C=this.cancelCallbacks[te];delete this.cancelCallbacks[te],C&&C.cancel()}else if(H.mustQueue||Q()){const C=this.callbacks[te];this.cancelCallbacks[te]=this.scheduler.add((()=>this.processTask(te,H)),C&&C.metadata||{type:"message"})}else this.processTask(te,H)}processTask(C,H){if("<response>"===H.type){const te=this.callbacks[C];delete this.callbacks[C],te&&(H.error?te(Ps(H.error)):te(null,Ps(H.data)))}else{const te=new Set,le=H.hasCallback?(H,le)=>{delete this.cancelCallbacks[C],this.target.postMessage({id:C,type:"<response>",sourceMapId:this.mapId,error:H?Ds(H):null,data:Ds(le,te)},te)}:C=>{},ce=Ps(H.data);if(this.parent[H.type])this.parent[H.type](H.sourceMapId,ce,le);else if(this.parent.getWorkerSource){const C=H.type.split(".");this.parent.getWorkerSource(H.sourceMapId,C[0],ce.source,ce.scope)[C[1]](ce,le)}else le(new Error(`Could not find function ${H.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}class _w{constructor(C,H){this.workerPool=C,this.actors=[],this.currentActor=0,this.id=F();const te=this.workerPool.acquire(this.id);for(let C=0;C<te.length;C++){const le=new _w.Actor(te[C],H,this.id);le.name=`Worker ${C}`,this.actors.push(le)}this.ready=!1,this.broadcast("checkIfReady",null,(()=>{this.ready=!0}))}broadcast(C,H,te){R(this.actors,((te,le)=>{te.send(C,H,le)}),te=te||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach((C=>{C.remove()})),this.actors=[],this.workerPool.release(this.id)}}_w.Actor=mw;class gw extends It{constructor(C,H,te,le){super(),this.scope=te,this._options=C,this.properties=new la(H),this._transitionable=new ra(H,new Map(le)),this._transitionable.setTransitionOrValue(C.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(C){this._transitionable.setTransitionOrValue(this._options.properties,new Map(C))}updateTransitions(C){this._transitioning=this._transitionable.transitioned(C,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(C){this.properties=this._transitioning.possiblyEvaluate(C)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(C,H){this._options=C,this._transitionable.setTransitionOrValue(C.properties,H)}shadowsEnabled(){return!!this.properties&&!0===this.properties.get("cast-shadows")}}const NT=new da({color:new ca(Ai.properties_light_ambient.color),intensity:new ca(Ai.properties_light_ambient.intensity)}),eE=new da({direction:new class{constructor(C){this.specification=C}possiblyEvaluate(C,H){return function([C,H]){const te=K([1,C,H]);return{x:te.x,y:te.y,z:te.z}}(C.expression.evaluate(H))}interpolate(C,H,te){return{x:Wr(C.x,H.x,te),y:Wr(C.y,H.y,te),z:Wr(C.z,H.z,te)}}}(Ai.properties_light_directional.direction),color:new ca(Ai.properties_light_directional.color),intensity:new ca(Ai.properties_light_directional.intensity),"cast-shadows":new ca(Ai.properties_light_directional["cast-shadows"]),"shadow-intensity":new ca(Ai.properties_light_directional["shadow-intensity"])});class vw{constructor(C,H,te,le){this.screenBounds=C,this.cameraPoint=H,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=te,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,le)}static createFromScreenPoints(C,H){let te,le;if(C instanceof Ne||"number"==typeof C[0]){const ce=Ne.convert(C);te=[ce],le=H.isPointAboveHorizon(ce)}else{const ce=Ne.convert(C[0]),he=Ne.convert(C[1]);te=[ce,he],le=S(ce,he).every((C=>H.isPointAboveHorizon(C)))}return new vw(te,H.getCameraPoint(),le,H)}isPointQuery(){return 1===this.screenBounds.length}bufferedScreenGeometry(C){return S(this.screenBounds[0],1===this.screenBounds.length?this.screenBounds[0]:this.screenBounds[1],C)}bufferedCameraGeometry(C){const H=this.screenBounds[0],te=1===this.screenBounds.length?this.screenBounds[0].add(new Ne(1,1)):this.screenBounds[1],le=S(H,te,0,!1);return this.cameraPoint.y>te.y&&(this.cameraPoint.x>H.x&&this.cameraPoint.x<te.x?le.splice(3,0,this.cameraPoint):this.cameraPoint.x>=te.x?le[2]=this.cameraPoint:this.cameraPoint.x<=H.x&&(le[3]=this.cameraPoint)),function(C,H){const te=[];for(let le=0;le<C.length;le++){const ce=P(le-1,-1,C.length-1),he=P(le+1,-1,C.length-1),ue=C[le],de=C[he],_e=C[ce].sub(ue).unit(),ye=de.sub(ue).unit(),ve=ye.angleWithSep(_e.x,_e.y),Me=_e.add(ye).unit().mult(-1*H/Math.sin(ve/2));te.push(ue.add(Me))}return te}(le,C)}bufferedCameraGeometryGlobe(C){const H=this.screenBounds[0],te=1===this.screenBounds.length?this.screenBounds[0].add(new Ne(1,1)):this.screenBounds[1],le=S(H,te,C),ce=this.cameraPoint.clone();switch(3*((ce.y>H.y)+(ce.y>te.y))+((ce.x>H.x)+(ce.x>te.x))){case 0:le[0]=ce,le[4]=ce.clone();break;case 1:le.splice(1,0,ce);break;case 2:le[1]=ce;break;case 3:le.splice(4,0,ce);break;case 5:le.splice(2,0,ce);break;case 6:le[3]=ce;break;case 7:le.splice(3,0,ce);break;case 8:le[2]=ce}return le}containsTile(C,H,te,le=0){const ce=C.queryPadding/H._pixelsPerMercatorPixel+1,he=te?this._bufferedCameraMercator(ce,H):this._bufferedScreenMercator(ce,H);let ue=C.tileID.wrap+(he.unwrapped?le:0);const de=he.polygon.map((H=>Mg(C.tileTransform,H,ue)));if(!Tp(de,0,0,wn,wn))return;ue=C.tileID.wrap+(this.screenGeometryMercator.unwrapped?le:0);const _e=this.screenGeometryMercator.polygon.map((H=>Ag(C.tileTransform,H,ue))),ye=_e.map((C=>new Ne(C[0],C[1]))),ve=H.getFreeCameraOptions().position||new ep(0,0,0),Me=Ag(C.tileTransform,ve,ue),Se=_e.map((C=>{const H=Ld.sub(C,C,Me);return Ld.normalize(H,H),new Uu(Me,H)})),Ae=Xx(C,1,H.zoom)*H._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:ye,tilespaceRays:Se,bufferedTilespaceGeometry:de,bufferedTilespaceBounds:(Ce=A(de),Ce.min.x=z(Ce.min.x,0,wn),Ce.min.y=z(Ce.min.y,0,wn),Ce.max.x=z(Ce.max.x,0,wn),Ce.max.y=z(Ce.max.y,0,wn),Ce),tile:C,tileID:C.tileID,pixelToTileUnitsFactor:Ae};var Ce}_bufferedScreenMercator(C,H){const te=Tw(C);if(this._screenRaycastCache[te])return this._screenRaycastCache[te];{let le;return le="globe"===H.projection.name?this._projectAndResample(this.bufferedScreenGeometry(C),H):{polygon:this.bufferedScreenGeometry(C).map((C=>H.pointCoordinate3D(C))),unwrapped:!0},this._screenRaycastCache[te]=le,le}}_bufferedCameraMercator(C,H){const te=Tw(C);if(this._cameraRaycastCache[te])return this._cameraRaycastCache[te];{let le;return le="globe"===H.projection.name?this._projectAndResample(this.bufferedCameraGeometryGlobe(C),H):{polygon:this.bufferedCameraGeometry(C).map((C=>H.pointCoordinate3D(C))),unwrapped:!0},this._cameraRaycastCache[te]=le,le}}_projectAndResample(C,H){const te=function(C,H){const te=ed.multiply([],H.pixelMatrix,H.globeMatrix),le=[0,-Rp,0,1],ce=[0,Rp,0,1],he=[0,0,0,1];Lu.transformMat4(le,le,te),Lu.transformMat4(ce,ce,te),Lu.transformMat4(he,he,te);const ue=new Ne(le[0]/le[3],le[1]/le[3]),de=new Ne(ce[0]/ce[3],ce[1]/ce[3]),_e=wp(C,ue)&&le[3]<he[3],ye=wp(C,de)&&ce[3]<he[3];if(!_e&&!ye)return null;const ve=function(C,H,te){for(let le=1;le<C.length;le++){const ce=ww(H.pointCoordinate3D(C[le-1]).x),he=ww(H.pointCoordinate3D(C[le]).x);if(te<0){if(ce<he)return{idx:le,t:-ce/(he-1-ce)}}else if(he<ce)return{idx:le,t:(1-ce)/(he+1-ce)}}return null}(C,H,_e?-1:1);if(!ve)return null;const{idx:Me,t:Se}=ve;let Ae=Me>1?bw(C.slice(0,Me),H):[],Ce=Me<C.length?bw(C.slice(Me),H):[];Ae=Ae.map((C=>new Ne(ww(C.x),C.y))),Ce=Ce.map((C=>new Ne(ww(C.x),C.y)));const Oe=[...Ae];0===Oe.length&&Oe.push(Ce[Ce.length-1]);const je=Wr(Oe[Oe.length-1].y,(0===Ce.length?Ae[0]:Ce[0]).y,Se);let Ge;return Ge=_e?[new Ne(0,je),new Ne(0,0),new Ne(1,0),new Ne(1,je)]:[new Ne(1,je),new Ne(1,1),new Ne(0,1),new Ne(0,je)],Oe.push(...Ge),0===Ce.length?Oe.push(Ae[0]):Oe.push(...Ce),{polygon:Oe.map((C=>new ep(C.x,C.y))),unwrapped:!1}}(C,H);if(te)return te;const le=function(C,H){let te=!1,le=-1/0,ce=0;for(let H=0;H<C.length-1;H++)C[H].x>le&&(le=C[H].x,ce=H);for(let H=0;H<C.length-1;H++){const le=(ce+H)%(C.length-1),he=C[le],ue=C[le+1];Math.abs(he.x-ue.x)>.5&&(he.x<ue.x?(he.x+=1,0===le&&(C[C.length-1].x+=1)):(ue.x+=1,le+1===C.length-1&&(C[0].x+=1)),te=!0)}const he=Gd(H.center.lng);return te&&he<Math.abs(he-1)&&C.forEach((C=>{C.x-=1})),{polygon:C,unwrapped:te}}(bw(C,H).map((C=>new Ne(ww(C.x),C.y))),H);return{polygon:le.polygon.map((C=>new ep(C.x,C.y))),unwrapped:le.unwrapped}}}function bw(C,H){return ip(C,(C=>{const te=H.pointCoordinate3D(C);C.x=te.x,C.y=te.y}),1/256)}function ww(C){return C<0?1+C%1:C%1}function Tw(C){return 100*C|0}function Ew(C,H,te,le,ce){const o=function(te,le){if(te)return ce(te);if(le){C.url&&le.tiles&&C.tiles&&delete C.tiles;const te=O(k(le,C),["tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","scheme","tileSize","encoding"]);le.vector_layers&&(te.vectorLayers=le.vector_layers,te.vectorLayerIds=te.vectorLayers.map((C=>C.id))),te.tiles=H.canonicalizeTileset(te,C.url),ce(null,te)}};return C.url?we(H.transformRequest(H.normalizeSourceURL(C.url,null,te,le),ot.Source),o):yi.frame((()=>o(null,C)))}class Mw{constructor(C,H,te){this.bounds=Ql.convert(this.validateBounds(C)),this.minzoom=H||0,this.maxzoom=te||24}validateBounds(C){return Array.isArray(C)&&4===C.length?[Math.max(-180,C[0]),Math.max(-90,C[1]),Math.min(180,C[2]),Math.min(90,C[3])]:[-180,-90,180,90]}contains(C){const H=Math.pow(2,C.z),te=Math.floor(Gd(this.bounds.getWest())*H),le=Math.floor(qd(this.bounds.getNorth())*H),ce=Math.ceil(Gd(this.bounds.getEast())*H),he=Math.ceil(qd(this.bounds.getSouth())*H);return C.x>=te&&C.x<ce&&C.y>=le&&C.y<he}}class Aw{constructor(C,H){this.width=C,this.height=H,this.nextRow=0,this.image=new Zp({width:C,height:H}),this.positions={},this.uploaded=!1}getDash(C,H){const te=this.getKey(C,H);return this.positions[te]}trim(){const C=this.width,H=this.height=U(this.nextRow);this.image.resize({width:C,height:H})}getKey(C,H){return C.join(",")+H}getDashRanges(C,H,te){const le=[];let ce=C.length%2==1?-C[C.length-1]*te:0,he=C[0]*te,ue=!0;le.push({left:ce,right:he,isDash:ue,zeroLength:0===C[0]});let de=C[0];for(let H=1;H<C.length;H++){ue=!ue;const _e=C[H];ce=de*te,de+=_e,he=de*te,le.push({left:ce,right:he,isDash:ue,zeroLength:0===_e})}return le}addRoundDash(C,H,te){const le=H/2;for(let H=-te;H<=te;H++){const ce=this.width*(this.nextRow+te+H);let he=0,ue=C[he];for(let de=0;de<this.width;de++){de/ue.right>1&&(ue=C[++he]);const _e=Math.abs(de-ue.left),ye=Math.abs(de-ue.right),ve=Math.min(_e,ye);let Me;const Se=H/te*(le+1);if(ue.isDash){const C=le-Math.abs(Se);Me=Math.sqrt(ve*ve+C*C)}else Me=le-Math.sqrt(ve*ve+Se*Se);this.image.data[ce+de]=Math.max(0,Math.min(255,Me+128))}}}addRegularDash(C,H){for(let H=C.length-1;H>=0;--H){const te=C[H],le=C[H+1];te.zeroLength?C.splice(H,1):le&&le.isDash===te.isDash&&(le.left=te.left,C.splice(H,1))}const te=C[0],le=C[C.length-1];te.isDash===le.isDash&&(te.left=le.left-this.width,le.right=te.right+this.width);const ce=this.width*this.nextRow;let he=0,ue=C[he];for(let te=0;te<this.width;te++){te/ue.right>1&&(ue=C[++he]);const le=Math.abs(te-ue.left),de=Math.abs(te-ue.right),_e=Math.min(le,de);this.image.data[ce+te]=Math.max(0,Math.min(255,(ue.isDash?_e:-_e)+H+128))}}addDash(C,H){const te=this.getKey(C,H);if(this.positions[te])return this.positions[te];const le="round"===H,ce=le?7:0,he=2*ce+1;if(this.nextRow+he>this.height)return W("LineAtlas out of space"),null;0===C.length&&C.push(1);let ue=0;for(let H=0;H<C.length;H++)C[H]<0&&(W("Negative value is found in line dasharray, replacing values with 0"),C[H]=0),ue+=C[H];if(0!==ue){const te=this.width/ue,he=this.getDashRanges(C,this.width,te);le?this.addRoundDash(he,te,ce):this.addRegularDash(he,"square"===H?.5*te:0)}const de=this.nextRow+ce;this.nextRow+=he;const _e={tl:[de,ce],br:[ue,0]};return this.positions[te]=_e,_e}}Is(Aw,"LineAtlas");const tE=1*hy;class Iw{constructor(C){const H={},te=[];for(const le in C){const ce=C[le],he=H[le]={};for(const C in ce.glyphs){const H=ce.glyphs[+C];if(!H||0===H.bitmap.width||0===H.bitmap.height)continue;const le=H.metrics.localGlyph?tE:1,ue={x:0,y:0,w:H.bitmap.width+2*le,h:H.bitmap.height+2*le};te.push(ue),he[C]=ue}}const{w:le,h:ce}=y_(te),he=new Zp({width:le||1,height:ce||1});for(const te in C){const le=C[te];for(const C in le.glyphs){const ce=le.glyphs[+C];if(!ce||0===ce.bitmap.width||0===ce.bitmap.height)continue;const ue=H[te][C],de=ce.metrics.localGlyph?tE:1;Zp.copy(ce.bitmap,he,{x:0,y:0},{x:ue.x+de,y:ue.y+de},ce.bitmap)}}this.image=he,this.positions=H}}Is(Iw,"GlyphAtlas");class Cw{constructor(C){this.tileID=new Bu(C.tileID.overscaledZ,C.tileID.wrap,C.tileID.canonical.z,C.tileID.canonical.x,C.tileID.canonical.y),this.tileZoom=C.tileZoom,this.uid=C.uid,this.zoom=C.zoom,this.canonical=C.tileID.canonical,this.pixelRatio=C.pixelRatio,this.tileSize=C.tileSize,this.source=C.source,this.scope=C.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=C.showCollisionBoxes,this.collectResourceTiming=!!C.collectResourceTiming,this.promoteId=C.promoteId,this.isSymbolTile=C.isSymbolTile,this.tileTransform=Tg(C.tileID.canonical,C.projection),this.projection=C.projection,this.brightness=C.brightness,this.extraShadowCaster=!!C.extraShadowCaster}parse(C,H,te,le,ce){this.status="parsing",this.data=C,this.collisionBoxArray=new el;const he=new nm(Object.keys(C.layers).sort()),ue=new Zm(this.tileID,this.promoteId);ue.bucketLayerIDs=[];const de={},_e=new Aw(256,256),ye={featureIndex:ue,iconDependencies:{},patternDependencies:{},glyphDependencies:{},lineAtlas:_e,availableImages:te,brightness:this.brightness},ve=H.familiesBySource[this.source];for(const H in ve){const le=C.layers[H];if(!le)continue;let ce=!1,_e=!1,Me=!1;for(const C of ve[H])"symbol"===C[0].type?ce=!0:_e=!0,C[0].is3D()&&"model"!==C[0].type&&(Me=!0);if(this.extraShadowCaster&&!Me)continue;if(!0===this.isSymbolTile&&!ce)continue;if(!1===this.isSymbolTile&&!_e)continue;1===le.version&&W(`Vector tile source "${this.source}" layer "${H}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const Se=he.encode(H),Ae=[];for(let C=0;C<le.length;C++){const te=le.feature(C),ce=ue.getId(te,H);Ae.push({feature:te,id:ce,index:C,sourceLayerIndex:Se})}for(const C of ve[H]){const H=C[0];(!this.extraShadowCaster||H.is3D()&&"model"!==H.type)&&(void 0!==this.isSymbolTile&&"symbol"===H.type!==this.isSymbolTile||H.minzoom&&this.zoom<Math.floor(H.minzoom)||H.maxzoom&&this.zoom>=H.maxzoom||"none"!==H.visibility&&(zw(C,this.zoom,ye.brightness,te),(de[H.id]=H.createBucket({index:ue.bucketLayerIDs.length,layers:C,zoom:this.zoom,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:Se,sourceID:this.source,projection:this.projection.spec})).populate(Ae,ye,this.tileID.canonical,this.tileTransform),ue.bucketLayerIDs.push(C.map((C=>C.id)))))}}let Me,Se,Ae,Ce;_e.trim();const Oe={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},_=()=>{if(Me)return ce(Me);if(this.extraShadowCaster)this.status="done",ce(null,{buckets:L(de).filter((C=>!C.isEmpty())),featureIndex:ue,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:ye.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(Se&&Ae&&Ce){const C=new Iw(Se),H=new b_(Ae,Ce);for(const le in de){const ce=de[le];ce instanceof zx?(zw(ce.layers,this.zoom,ye.brightness,te),dg(ce,Se,C.positions,Ae,H.iconPositions,this.showCollisionBoxes,te,this.tileID.canonical,this.tileZoom,this.projection,this.brightness)):ce.hasPattern&&(ce instanceof _y||ce instanceof Lf||ce instanceof db)&&(zw(ce.layers,this.zoom,ye.brightness,te),ce.addFeatures(ye,this.tileID.canonical,H.patternPositions,te,this.tileTransform,this.brightness))}this.status="done",ce(null,{buckets:L(de).filter((C=>!C.isEmpty())),featureIndex:ue,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:C.image,lineAtlas:_e,imageAtlas:H,brightness:ye.brightness})}};if(!this.extraShadowCaster){const C=q(ye.glyphDependencies,(C=>Object.keys(C).map(Number)));Object.keys(C).length?le.send("getGlyphs",{uid:this.uid,stacks:C,scope:this.scope},((C,H)=>{Me||(Me=C,Se=H,_())}),void 0,!1,Oe):Se={};const H=Object.keys(ye.iconDependencies);H.length?le.send("getImages",{icons:H,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},((C,H)=>{Me||(Me=C,Ae=H,_())}),void 0,!1,Oe):Ae={};const te=Object.keys(ye.patternDependencies);te.length?le.send("getImages",{icons:te,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},((C,H)=>{Me||(Me=C,Ce=H,_())}),void 0,!1,Oe):Ce={}}_()}}function zw(C,H,te,le){const ce=new ea(H,{brightness:te});for(const H of C)H.recalculate(ce,le)}class Dw{constructor(C){this.entries={},this.scheduler=C}request(C,H,te,le){const ce=this.entries[C]=this.entries[C]||{callbacks:[]};if(ce.result){const[C,te]=ce.result;return this.scheduler?this.scheduler.add((()=>{le(C,te)}),H):le(C,te),()=>{}}return ce.callbacks.push(le),ce.cancel||(ce.cancel=te(((te,le)=>{ce.result=[te,le];for(const C of ce.callbacks)this.scheduler?this.scheduler.add((()=>{C(te,le)}),H):C(te,le);setTimeout((()=>delete this.entries[C]),3e3)}))),()=>{ce.result||(ce.callbacks=ce.callbacks.filter((C=>C!==le)),ce.callbacks.length||(ce.cancel(),delete this.entries[C]))}}}function Pw(C,te,le){const ce=JSON.stringify(C.request);return C.data&&((this||H).deduped.entries[ce]={result:[null,C.data]}),(this||H).deduped.request(ce,{type:"parseTile",isSymbolTile:C.isSymbolTile,zoom:C.tileZoom},(H=>{const te=Te(C.request,((C,te,ce,he)=>{C?H(C):te&&H(null,{vectorTile:le?void 0:new n_(new S_(te)),rawData:te,cacheControl:ce,expires:he})}));return()=>{te.cancel(),H()}}),te)}class Rw extends It{constructor(C,H,te,le){if(super(),this.id=C,this.dispatcher=te,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,k(this,O(H,["url","scheme","tileSize","promoteId"])),this._options=k({type:"vector"},H),this._collectResourceTiming=!!H.collectResourceTiming,512!==this.tileSize)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(le),this._tileWorkers={},this._deduped=new Dw}load(C){this._loaded=!1,this.fire(new At("dataloading",{dataType:"source"}));const H=Array.isArray(this.map._language)?this.map._language.join():this.map._language,te=this.map._worldview;this._tileJSONRequest=Ew(this._options,this.map._requestManager,H,te,((le,ce)=>{this._tileJSONRequest=null,this._loaded=!0,le?(H&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${H}`),te&&2!==te.length&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${te}`),this.fire(new St(le))):ce&&(k(this,ce),ce.bounds&&(this.tileBounds=new Mw(ce.bounds,this.minzoom,this.maxzoom)),Ct(ce.tiles,this.map._requestManager._customAccessToken),this.fire(new At("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new At("data",{dataType:"source",sourceDataType:"content"}))),C&&C(le)}))}loaded(){return this._loaded}hasTile(C){return!this.tileBounds||this.tileBounds.contains(C.canonical)}onAdd(C){this.map=C,this.load()}reload(){this.cancelTileJSONRequest();const C=pa(this.id,this.scope);this.load((()=>this.map.style.clearSource(C)))}setTiles(C){return this._options.tiles=C,this.reload(),this}setUrl(C){return this.url=C,this._options.url=C,this.reload(),this}onRemove(){this.cancelTileJSONRequest()}serialize(){return k({},this._options)}loadTile(C,H){const te=this.map._requestManager.normalizeTileURL(C.tileID.canonical.url(this.tiles,this.scheme)),le={request:this.map._requestManager.transformRequest(te,ot.Tile),data:void 0,uid:C.uid,tileID:C.tileID,tileZoom:C.tileZoom,zoom:C.tileID.overscaledZ,tileSize:this.tileSize*C.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:yi.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:C.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:C.isExtraShadowCaster};if(le.request.collectResourceTiming=this._collectResourceTiming,C.actor&&"expired"!==C.state)"loading"===C.state?C.reloadCallback=H:C.request=C.actor.send("reloadTile",le,n.bind(this));else if(C.actor=this._tileWorkers[te]=this._tileWorkers[te]||this.dispatcher.getActor(),this.dispatcher.ready)C.request=C.actor.send("loadTile",le,n.bind(this),void 0,!0);else{const H=Pw.call({deduped:this._deduped},le,((H,te)=>{H||!te?n.call(this,H):(le.data={cacheControl:te.cacheControl,expires:te.expires,rawData:te.rawData.slice(0)},C.actor&&C.actor.send("loadTile",le,n.bind(this),void 0,!0))}),!0);C.request={cancel:H}}function n(te,le){return delete C.request,C.aborted?H(null):te&&404!==te.status?H(te):(le&&le.resourceTiming&&(C.resourceTiming=le.resourceTiming),this.map._refreshExpiredTiles&&le&&C.setExpiryData(le),C.loadVectorData(le,this.map.painter),ge(this.dispatcher),H(null),void(C.reloadCallback&&(this.loadTile(C,C.reloadCallback),C.reloadCallback=null)))}}abortTile(C){C.request&&(C.request.cancel(),delete C.request),C.actor&&C.actor.send("abortTile",{uid:C.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(C){C.unloadVectorData(),C.actor&&C.actor.send("removeTile",{uid:C.uid,type:this.type,source:this.id,scope:this.scope})}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class Lw extends It{constructor(C,H,te,le){super(),this.id=C,this.dispatcher=te,this.setEventedParent(le),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=k({type:"raster"},H),k(this,O(H,["url","scheme","tileSize"]))}load(C){this._loaded=!1,this.fire(new At("dataloading",{dataType:"source"})),this._tileJSONRequest=Ew(this._options,this.map._requestManager,null,null,((H,te)=>{this._tileJSONRequest=null,this._loaded=!0,H?this.fire(new St(H)):te&&(k(this,te),te.bounds&&(this.tileBounds=new Mw(te.bounds,this.minzoom,this.maxzoom)),Ct(te.tiles),this.fire(new At("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new At("data",{dataType:"source",sourceDataType:"content"}))),C&&C(H)}))}loaded(){return this._loaded}onAdd(C){this.map=C,this.load()}reload(){this.cancelTileJSONRequest();const C=pa(this.id,this.scope);this.load((()=>this.map.style.clearSource(C)))}setTiles(C){return this._options.tiles=C,this.reload(),this}setUrl(C){return this.url=C,this._options.url=C,this.reload(),this}onRemove(){this.cancelTileJSONRequest()}serialize(){return k({},this._options)}hasTile(C){return!this.tileBounds||this.tileBounds.contains(C.canonical)}loadTile(C,H){const te=yi.devicePixelRatio>=2,le=this.map._requestManager.normalizeTileURL(C.tileID.canonical.url(this.tiles,this.scheme),te,this.tileSize);C.request=Ie(this.map._requestManager.transformRequest(le,ot.Tile),((te,le,ce,he)=>(delete C.request,C.aborted?(C.state="unloaded",H(null)):te?(C.state="errored",H(te)):le?(this.map._refreshExpiredTiles&&C.setExpiryData({cacheControl:ce,expires:he}),C.setTexture(le,this.map.painter),C.state="loaded",ge(this.dispatcher),void H(null)):H(null))))}static loadTileData(C,H,te){C.setTexture(H,te)}static unloadTileData(C,H){C.texture&&H.saveTileTexture(C.texture)}abortTile(C,H){C.request&&(C.request.cancel(),delete C.request),H()}unloadTile(C,H){C.texture&&this.map.painter.saveTileTexture(C.texture),H()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}let iE;function Ow(){return null!=zI.workerClass?new zI.workerClass:new te.Worker(zI.workerUrl)}const rE="mapboxgl_preloaded_worker_pool";class Fw{constructor(){this.active={}}acquire(C){if(!this.workers)for(this.workers=[];this.workers.length<Fw.workerCount;)this.workers.push(new Ow);return this.active[C]=!0,this.workers.slice()}release(C){delete this.active[C],this.workers&&0===this.numActive()&&(this.workers.forEach((C=>{C.terminate()})),this.workers=null)}isPreloaded(){return!!this.active[rE]}numActive(){return Object.keys(this.active).length}}let nE;function Uw(){return nE||(nE=new Fw),nE}Fw.workerCount=2;let oE,sE,lE,uE=null;function Zw(){return Q()&&self.worker&&self.worker.dracoUrl?self.worker.dracoUrl:sE||ue.DRACO_URL}const yE=5123,TE=5126,EE={5120:Int8Array,5121:Uint8Array,5122:Int16Array,[yE]:Uint16Array,5125:Uint32Array,[TE]:Float32Array},ME={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",[yE]:"DT_UINT16",5125:"DT_UINT32",[TE]:"DT_FLOAT32"},SE={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function Kw(C,H,te){const le=te.json.bufferViews.length,ce=te.buffers.length;H.bufferView=le,te.json.bufferViews[le]={buffer:ce,byteLength:C.byteLength},te.buffers[ce]=C}const AE="KHR_draco_mesh_compression";function Qw(C,H){const te=C.extensions&&C.extensions[AE];if(!te)return;const le=new lE.Decoder,ce=nT(H,te.bufferView),he=new lE.Mesh;if(!le.DecodeArrayToMesh(ce,ce.byteLength,he))throw new Error("Failed to decode Draco mesh");const ue=H.json.accessors[C.indices],de=EE[ue.componentType],_e=ue.count*de.BYTES_PER_ELEMENT,ye=lE._malloc(_e);de===Uint16Array?le.GetTrianglesUInt16Array(he,_e,ye):le.GetTrianglesUInt32Array(he,_e,ye),Kw(lE.memory.buffer.slice(ye,ye+_e),ue,H),lE._free(ye);for(const ce of Object.keys(te.attributes)){const ue=le.GetAttributeByUniqueId(he,te.attributes[ce]),de=H.json.accessors[C.attributes[ce]],_e=ME[de.componentType],ye=de.count*SE[de.type]*EE[de.componentType].BYTES_PER_ELEMENT,ve=lE._malloc(ye);le.GetAttributeDataArrayForAllPoints(he,ue,lE[_e],ye,ve),Kw(lE.memory.buffer.slice(ve,ve+ye),de,H),lE._free(ve)}le.destroy(),he.destroy(),delete C.extensions[AE]}const IE=1179937895,CE=new TextDecoder("utf8");function iT(C,H){return new URL(C,H).href}function rT(C,H,te,le){return fetch(iT(C.uri,le)).then((C=>C.arrayBuffer())).then((C=>{H.buffers[te]=C}))}function nT(C,H){const te=C.json.bufferViews[H];return new Uint8Array(C.buffers[te.buffer],te.byteOffset||0,te.byteLength)}function oT(C,H,le,ce){if(C.uri){const he=iT(C.uri,ce);return fetch(he).then((C=>C.blob())).then((C=>te.createImageBitmap(C))).then((C=>{H.images[le]=C}))}if(void 0!==C.bufferView){const ce=nT(H,C.bufferView),he=new te.Blob([ce],{type:C.mimeType});return te.createImageBitmap(he).then((C=>{H.images[le]=C}))}}function sT(C,H=0,te){const le={json:null,images:[],buffers:[]};if(new Uint32Array(C,H,1)[0]===IE){const te=new Uint32Array(C,H);let ce=2;const he=(te[ce++]>>2)-3,ue=te[ce++]>>2;if(ce++,le.json=JSON.parse(CE.decode(te.subarray(ce,ce+ue))),ce+=ue,ce<he){const he=te[ce++];ce++;const ue=H+(ce<<2);le.buffers[0]=C.slice(ue,ue+he)}}else le.json=JSON.parse(CE.decode(new Uint8Array(C,H)));const{buffers:ce,images:he,meshes:ue,extensionsUsed:de}=le.json;let _e=Promise.resolve();if(ce){const C=[];for(let H=0;H<ce.length;H++){const he=ce[H];he.uri?C.push(rT(he,le,H,te)):le.buffers[H]||(le.buffers[H]=null)}_e=Promise.all(C)}return _e.then((()=>{const C=[],H=de&&de.includes(AE);if(H&&C.push(function(){if(!lE)return oE||(oE=function(C){let H,te=null;function r(){H=new Uint8Array(te.buffer)}function n(){throw new Error("Unexpected Draco error.")}const le={a:{a:n,d:function(C,te,le){return H.copyWithin(C,te,te+le)},c:function(C){const le=H.length,ce=Math.max(C>>>0,Math.ceil(1.2*le)),he=Math.ceil((ce-le)/65536);try{return te.grow(he),r(),!0}catch(C){return!1}},b:n}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(C,le):C.then((C=>C.arrayBuffer())).then((C=>WebAssembly.instantiate(C,le)))).then((C=>{const{Rb:le,Qb:ce,P:he,T:ue,X:de,Ja:_e,La:ye,Qa:ve,Va:Me,Wa:Se,eb:Ae,jb:Ce,f:Oe,e:Ne,yb:je,zb:Ge,Ab:Ze,Bb:qe,Db:$e,Gb:We}=C.instance.exports;te=Ne;const He=(()=>{let C=0,te=0,he=0,ue=0;return de=>{he&&(le(ue),le(C),te+=he,he=C=0),C||(te+=128,C=ce(te));const _e=de.length+7&-8;let ye=C;_e>=te&&(he=_e,ye=ue=ce(_e));for(let C=0;C<de.length;C++)H[ye+C]=de[C];return ye}})();return r(),Oe(),{memory:Ne,_free:le,_malloc:ce,Mesh:class{constructor(){this.ptr=he()}destroy(){ue(this.ptr)}},Decoder:class{constructor(){this.ptr=_e()}destroy(){Ce(this.ptr)}DecodeArrayToMesh(C,H,te){const le=He(C),ce=ye(this.ptr,le,H,te.ptr);return!!de(ce)}GetAttributeByUniqueId(C,H){return{ptr:ve(this.ptr,C.ptr,H)}}GetTrianglesUInt16Array(C,H,te){Me(this.ptr,C.ptr,H,te)}GetTrianglesUInt32Array(C,H,te){Se(this.ptr,C.ptr,H,te)}GetAttributeDataArrayForAllPoints(C,H,te,le,ce){Ae(this.ptr,C.ptr,H.ptr,te,le,ce)}},DT_INT8:je(),DT_UINT8:Ge(),DT_INT16:Ze(),DT_UINT16:qe(),DT_UINT32:$e(),DT_FLOAT32:We()}}))}(fetch(Zw())),oE.then((C=>{lE=C,oE=void 0})))}()),he)for(let H=0;H<he.length;H++)C.push(oT(he[H],le,H,te));return(C.length?Promise.all(C):Promise.resolve()).then((()=>{if(H&&ue)for(const{primitives:C}of ue)for(const H of C)Qw(H,le);return le}))}))}function aT(C){return fetch(C).then((C=>C.arrayBuffer())).then((H=>sT(H,0,C)))}class lT{constructor(C,H,te){if(this.triangleCount=H.length/3,this.min=new Ne(0,0),this.max=new Ne(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],0===this.triangleCount||0===C.length||0===te)return;const le=C.map((C=>C.x)),ce=C.map((C=>C.y));this.min=new Ne(Math.min(...le),Math.min(...ce)),this.max=new Ne(Math.max(...le),Math.max(...ce));const he=this.max.sub(this.min);he.x=Math.max(he.x,1),he.y=Math.max(he.y,1);const ue=Math.max(he.x,he.y)/te;this.cellsX=Math.max(1,Math.ceil(he.x/ue)),this.cellsY=Math.max(1,Math.ceil(he.y/ue)),this.xScale=1/ue,this.yScale=1/ue;const de=[];for(let te=0;te<this.triangleCount;te++){const le=C[H[3*te+0]].sub(this.min),ce=C[H[3*te+1]].sub(this.min),he=C[H[3*te+2]].sub(this.min),_e=cT(Math.floor(Math.min(le.x,ce.x,he.x)),this.xScale,this.cellsX),ye=cT(Math.floor(Math.max(le.x,ce.x,he.x)),this.xScale,this.cellsX),ve=cT(Math.floor(Math.min(le.y,ce.y,he.y)),this.yScale,this.cellsY),Me=cT(Math.floor(Math.max(le.y,ce.y,he.y)),this.yScale,this.cellsY),Se=new Ne(0,0),Ae=new Ne(0,0),Ce=new Ne(0,0),Oe=new Ne(0,0);for(let C=ve;C<=Me;++C){Se.y=Ae.y=C*ue,Ce.y=Oe.y=(C+1)*ue;for(let H=_e;H<=ye;++H)Se.x=Ce.x=H*ue,Ae.x=Oe.x=(H+1)*ue,(Ap(le,ce,he,Se,Ae,Oe)||Ap(le,ce,he,Se,Oe,Ce))&&de.push({cellIdx:C*this.cellsX+H,triIdx:te})}}if(0===de.length)return;de.sort(((C,H)=>C.cellIdx-H.cellIdx||C.triIdx-H.triIdx));let _e=0;for(;_e<de.length;){const C=de[_e].cellIdx,H={start:this.payload.length,len:0};for(;_e<de.length&&de[_e].cellIdx===C;)++H.len,this.payload.push(de[_e++].triIdx);this.cells[C]=H}}query(C,H,te){if(0===this.triangleCount||0===this.cells.length)return;if(C.x>this.max.x||this.min.x>H.x)return;if(C.y>this.max.y||this.min.y>H.y)return;this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8)));for(let C=0;C<this.lookup.length;C++)this.lookup[C]=0;const le=cT(C.x-this.min.x,this.xScale,this.cellsX),ce=cT(H.x-this.min.x,this.xScale,this.cellsX),he=cT(C.y-this.min.y,this.yScale,this.cellsY),ue=cT(H.y-this.min.y,this.yScale,this.cellsY);for(let C=he;C<=ue;C++)for(let H=le;H<=ce;H++){const le=this.cells[C*this.cellsX+H];if(le)for(let C=0;C<le.len;C++){const H=this.payload[le.start+C],ce=Math.floor(H/8),he=1<<H%8;if(!(this.lookup[ce]&he)&&(this.lookup[ce]|=he,te.push(H),te.length===this.triangleCount))return}}}}function cT(C,H,te){return Math.max(0,Math.min(te-1,Math.floor(C*H)))}function hT(C,H){const te=C.json.bufferViews[H.bufferView];return new(0,EE[H.componentType])(C.buffers[te.buffer],(H.byteOffset||0)+(te.byteOffset||0),H.count*SE[H.type])}function uT(C,H,te){const le=C.indices,ce=C.attributes,he={};he.indexArray=new Va;const ue=H.json.accessors[le],de=ue.count/3;he.indexArray.reserve(de);const _e=hT(H,ue);for(let C=0;C<de;C++)he.indexArray.emplaceBack(_e[3*C],_e[3*C+1],_e[3*C+2]);he.indexArray._trim(),he.vertexArray=new Ua;const ye=H.json.accessors[ce.POSITION];he.vertexArray.reserve(ye.count);const ve=hT(H,ye);for(let C=0;C<ye.count;C++)he.vertexArray.emplaceBack(ve[3*C],ve[3*C+1],ve[3*C+2]);if(he.vertexArray._trim(),he.aabb=new Hu(ye.min,ye.max),he.centroid=function(C,H){const te=[0,0,0],le=C.length;if(le>0){for(let ce=0;ce<le;ce++){const le=3*C[ce];te[0]+=H[le],te[1]+=H[le+1],te[2]+=H[le+2]}te[0]/=le,te[1]/=le,te[2]/=le}return te}(_e,ve),void 0!==ce.COLOR_0){const C=H.json.accessors[ce.COLOR_0],te=SE[C.type];if(C.componentType===TE){he.colorArray=3===te?new Ua:new Ia,he.colorArray.reserve(C.count);const le=hT(H,C);if(3===te)for(let H=0;H<C.count;H++)he.colorArray.emplaceBack(le[3*H],le[3*H+1],le[3*H+2]);else for(let H=0;H<C.count;H++)he.colorArray.emplaceBack(le[4*H],le[4*H+1],le[4*H+2],le[4*H+3]);he.colorArray._trim()}else if(C.componentType===yE&&4===te){he.colorArray=new Ia,he.colorArray.resize(C.count);const te=hT(H,C),le=1/65535,ce=he.colorArray.float32;for(let C=0;C<4*te.length;++C)ce[C]=te[C]*le}else W(`glTF color buffer parsing for accessor ${JSON.stringify(C)} is not supported`)}if(void 0!==ce.NORMAL){he.normalArray=new Ua;const C=H.json.accessors[ce.NORMAL];he.normalArray.reserve(C.count);const te=hT(H,C);for(let H=0;H<C.count;H++)he.normalArray.emplaceBack(te[3*H],te[3*H+1],te[3*H+2]);he.normalArray._trim()}if(void 0!==ce.TEXCOORD_0&&te.length>0){he.texcoordArray=new Xa;const C=H.json.accessors[ce.TEXCOORD_0];he.texcoordArray.reserve(C.count);const te=hT(H,C);for(let H=0;H<C.count;H++)he.texcoordArray.emplaceBack(te[2*H],te[2*H+1]);he.texcoordArray._trim()}const Me=C.material;return he.material=function(C,H){const{emissiveFactor:te=[0,0,0],alphaMode:le="OPAQUE",alphaCutoff:ce=.5,normalTexture:he,occlusionTexture:ue,emissiveTexture:de,doubleSided:_e}=C,{baseColorFactor:ye=[1,1,1,1],metallicFactor:ve=1,roughnessFactor:Me=1,baseColorTexture:Se,metallicRoughnessTexture:Ae}=C.pbrMetallicRoughness||{};return{pbrMetallicRoughness:{baseColorFactor:new kr(...ye),metallicFactor:ve,roughnessFactor:Me,baseColorTexture:Se?H[Se.index]:void 0,metallicRoughnessTexture:Ae?H[Ae.index]:void 0},doubleSided:_e,emissiveFactor:te,alphaMode:le,alphaCutoff:ce,normalTexture:he?H[he.index]:void 0,occlusionTexture:ue?H[ue.index]:void 0,emissionTexture:de?H[de.index]:void 0,defined:void 0===C.defined}}(void 0!==Me?H.json.materials[Me]:{defined:!1},te),void 0!==ce._FEATURE_RGBA4444&&(he.featureData=new Uint32Array(hT(H,H.json.accessors[ce._FEATURE_RGBA4444]).buffer)),he}function dT(C,H,te){const{matrix:le,rotation:ce,translation:he,scale:ue,mesh:de,extras:_e,children:ye}=C,ve={};if(ve.matrix=le||ed.fromRotationTranslationScale([],ce||[0,0,0,1],he||[0,0,0],ue||[1,1,1]),void 0!==de){ve.meshes=te[de];const C=ve.anchor=[0,0];for(const H of ve.meshes){const{min:te,max:le}=H.aabb;C[0]+=te[0]+le[0],C[1]+=te[1]+le[1]}C[0]=Math.floor(C[0]/ve.meshes.length/2),C[1]=Math.floor(C[1]/ve.meshes.length/2)}if(_e&&(_e.id&&(ve.id=_e.id),_e.lights&&(ve.lights=function(C){if(!C.length)return[];const H=function(C){const H=atob(C),te=new Uint8Array(H.length);for(let C=0;C<H.length;C++)te[C]=H.codePointAt(C);return te}(C),te=[],le=H.length/24,ce=new Uint16Array(H.buffer),he=new Float32Array(H.buffer);for(let C=0;C<le;C++){const H=ce[2*C*6]/30,le=ce[2*C*6+1]/30,ue=ce[2*C*6+10]/100,de=he[6*C+1],_e=he[6*C+2],ye=he[6*C+3],ve=he[6*C+4],Me=ye-de,Se=ve-_e,Ae=Math.hypot(Me,Se);te.push({pos:[de+.5*Me,_e+.5*Se,le],normal:[Se/Ae,-Me/Ae,0],width:Ae,height:H,depth:ue,points:[de,_e,ye,ve]})}return te}(_e.lights))),ye){const C=[];for(const le of ye)C.push(dT(H.json.nodes[le],H,te));ve.children=C}return ve}function pT(C){if(0===C.vertices.length||0===C.indices.length)return null;const[H,te]=[C.vertices[0].clone(),C.vertices[0].clone()];for(let le=1;le<C.vertices.length;++le){const ce=C.vertices[le];H.x=Math.min(H.x,ce.x),H.y=Math.min(H.y,ce.y),te.x=Math.max(te.x,ce.x),te.y=Math.max(te.y,ce.y)}const le=Math.ceil(Math.max(te.x-H.x,te.y-H.y)/256),ce=Math.max(8,le),he=new lT(C.vertices,C.indices,ce);return{vertices:C.vertices,indices:C.indices,grid:he,min:H,max:te}}function fT(C){if(!C.extras||!C.extras.ground)return null;const H=C.extras.ground;if(!H||!Array.isArray(H)||0===H.length)return null;const te=H[0];if(!te||!Array.isArray(te)||0===te.length)return null;const le=[];for(const C of te){if(!Array.isArray(C)||2!==C.length)continue;const H=C[0],te=C[1];"number"==typeof H&&"number"==typeof te&&le.push(new Ne(H,te))}if(le.length<3)return null;le.length>1&&le[le.length-1].equals(le[0])&&le.pop();let ce=0;for(let C=0;C<le.length;C++){const H=le[C],te=le[(C+1)%le.length],he=le[(C+2)%le.length];ce+=(H.x-te.x)*(he.y-te.y)-(he.x-te.x)*(H.y-te.y)}ce>0&&le.reverse();const he=hm(le.flatMap((C=>[C.x,C.y])),[]);return 0===he.length?null:{vertices:le,indices:he}}function mT(C){const H=[],te=[];let le=0;for(const ce of C){le=H.length;const C=ce.vertexArray.float32,he=ce.indexArray.uint16;for(let te=0;te<ce.vertexArray.length;te++)H.push(new Ne(C[3*te+0],C[3*te+1]));for(let C=0;C<3*ce.indexArray.length;C++)te.push(he[C]+le)}if(te.length%3!=0)return null;for(let C=0;C<te.length;C+=3){const le=H[te[C+0]],ce=H[te[C+1]],he=H[te[C+2]];(le.x-ce.x)*(he.y-ce.y)-(he.x-ce.x)*(le.y-ce.y)>0&&([te[C+1],te[C+2]]=[te[C+2],te[C+1]])}return{vertices:H,indices:te}}function _T(C){const H=function(C,H){const le=[],ce=te.WebGL2RenderingContext;if(C.json.textures)for(const te of C.json.textures){const he={magFilter:ce.LINEAR,minFilter:ce.NEAREST,wrapS:ce.REPEAT,wrapT:ce.REPEAT};void 0!==te.sampler&&Object.assign(he,C.json.samplers[te.sampler]),le.push({image:H[te.source],sampler:he,uploaded:!1})}return le}(C,C.images),le=function(C,H){const te=[];for(const le of C.json.meshes){const ce=[];for(const te of le.primitives)ce.push(uT(te,C,H));te.push(ce)}return te}(C,H),{scenes:ce,scene:he,nodes:ue}=C.json,de=ce?ce[he||0].nodes:ue,_e=[];for(const H of de)_e.push(dT(ue[H],C,le));return function(C,H,te){const le={},ce=new Set;for(let he=0;he<C.length;he++){const C=te[H[he]];if(!C.extras)continue;const ue=C.extras["mapbox:footprint:version"],de=C.extras["mapbox:footprint:id"];(ue||de)&&ce.add(he),"1.0.0"===ue&&de&&(le[de]=he)}for(let he=0;he<C.length;he++){if(ce.has(he))continue;const ue=C[he],de=te[H[he]];if(!de.extras)continue;let _e=null;ue.id in le&&(_e=mT(C[le[ue.id]].meshes)),_e||(_e=fT(de)),_e&&(ue.footprint=pT(_e))}if(ce.size>0){const H=Array.from(ce.values()).sort(((C,H)=>C-H));for(let te=H.length-1;te>=0;te--)C.splice(H[te],1)}}(_e,de,C.json.nodes),_e}function gT(C){C.heightmap=new Float32Array(4096),C.heightmap.fill(-1);const H=C.vertexArray.float32,te=C.aabb.min[0]-1,le=C.aabb.min[1]-1,ce=Ub/(C.aabb.max[0]-te+2),he=Ub/(C.aabb.max[1]-le+2);for(let ue=0;ue<H.length;ue+=3){const de=H[ue+2],_e=(H[ue+0]-te)*ce|0,ye=(H[ue+1]-le)*he|0;de>C.heightmap[ye*Ub+_e]&&(C.heightmap[ye*Ub+_e]=de)}}function yT(C,H){const te={};te.indexArray=new Va,te.indexArray.reserve(4*C.length),te.vertexArray=new Ua,te.vertexArray.reserve(10*C.length),te.colorArray=new Ia,te.vertexArray.reserve(10*C.length);let le=0;for(const ce of C){const C=Math.min(10,Math.max(4,1.3*ce.height))*H,he=[-ce.normal[1],ce.normal[0],0],ue=Math.min(.29,.1*ce.width/ce.depth),de=ce.width-2*ce.depth*H*(ue+.01),_e=Ld.scaleAndAdd([],ce.pos,he,de/2),ye=Ld.scaleAndAdd([],ce.pos,he,-de/2),ve=[_e[0],_e[1],_e[2]+ce.height],Me=[ye[0],ye[1],ye[2]+ce.height],Se=Ld.scaleAndAdd([],ce.normal,he,ue);Ld.scale(Se,Se,C);const Ae=Ld.scaleAndAdd([],ce.normal,he,-ue);Ld.scale(Ae,Ae,C),Ld.add(Se,_e,Se),Ld.add(Ae,ye,Ae),_e[2]+=.1,ye[2]+=.1,te.vertexArray.emplaceBack(Se[0],Se[1],Se[2]),te.vertexArray.emplaceBack(Ae[0],Ae[1],Ae[2]),te.vertexArray.emplaceBack(_e[0],_e[1],_e[2]),te.vertexArray.emplaceBack(ye[0],ye[1],ye[2]),te.vertexArray.emplaceBack(ve[0],ve[1],ve[2]),te.vertexArray.emplaceBack(Me[0],Me[1],Me[2]),te.vertexArray.emplaceBack(_e[0],_e[1],_e[2]),te.vertexArray.emplaceBack(ye[0],ye[1],ye[2]),te.vertexArray.emplaceBack(Se[0],Se[1],Se[2]),te.vertexArray.emplaceBack(Ae[0],Ae[1],Ae[2]);const Ce=de/C/2;te.colorArray.emplaceBack(-Ce-ue,-1,Ce,.8),te.colorArray.emplaceBack(Ce+ue,-1,Ce,.8),te.colorArray.emplaceBack(-Ce,0,Ce,1.3),te.colorArray.emplaceBack(Ce,0,Ce,1.3),te.colorArray.emplaceBack(Ce+ue,-.8,Ce,.7),te.colorArray.emplaceBack(Ce+ue,-.8,Ce,.7),te.colorArray.emplaceBack(0,0,Ce,1.3),te.colorArray.emplaceBack(0,0,Ce,1.3),te.colorArray.emplaceBack(Ce+ue,-1.2,Ce,.8),te.colorArray.emplaceBack(Ce+ue,-1.2,Ce,.8),te.indexArray.emplaceBack(6+le,4+le,8+le),te.indexArray.emplaceBack(7+le,9+le,5+le),te.indexArray.emplaceBack(0+le,1+le,2+le),te.indexArray.emplaceBack(1+le,3+le,2+le),le+=10}const ce={defined:!0,emissiveFactor:[0,0,0]},he={};return he.baseColorFactor=kr.white,ce.pbrMetallicRoughness=he,te.material=ce,te.aabb=new Hu([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),te}Is(lT,"TriangleGridIndex");const zE={vector:Rw,raster:Lw,"raster-dem":class extends Lw{constructor(C,H,te,le){super(C,H,te,le),this.type="raster-dem",this.maxzoom=22,this._options=k({type:"raster-dem"},H),this.encoding=H.encoding||"mapbox"}loadTile(C,H){const le=this.map._requestManager.normalizeTileURL(C.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);C.request=Ie(this.map._requestManager.transformRequest(le,ot.Tile),function(le,he,ue,de){if(delete C.request,C.aborted)C.state="unloaded",H(null);else if(le)C.state="errored",H(le);else if(he){this.map._refreshExpiredTiles&&C.setExpiryData({cacheControl:ue,expires:de});const H=te.ImageBitmap&&he instanceof te.ImageBitmap&&(null==iE&&(iE=te.OffscreenCanvas&&new te.OffscreenCanvas(1,1).getContext("2d")&&"function"==typeof te.createImageBitmap),iE),le=1-(he.width-((_e=he.width)<=1?1:Math.pow(2,Math.floor(Math.log(_e)/Math.LN2))))/2;le<1||C.neighboringTiles||(C.neighboringTiles=this._getNeighboringTiles(C.tileID));const ye=H?he:yi.getImageData(he,le),ve={uid:C.uid,coord:C.tileID,source:this.id,scope:this.scope,rawImageData:ye,encoding:this.encoding,padding:le,convertToFloat:ce};C.actor&&"expired"!==C.state||(C.actor=this.dispatcher.getActor(),C.actor.send("loadDEMTile",ve,o.bind(this),void 0,!0))}var _e}.bind(this));const ce=this.map?.painter?.terrainUseFloatDEM();function o(te,le){te&&(C.state="errored",H(te)),le&&(C.dem=le,C.dem.onDeserialize(),C.needsHillshadePrepare=!0,C.needsDEMTextureUpload=!0,C.state="loaded",H(null))}}_getNeighboringTiles(C){const H=C.canonical,te=Math.pow(2,H.z),le=(H.x-1+te)%te,ce=0===H.x?C.wrap-1:C.wrap,he=(H.x+1+te)%te,ue=H.x+1===te?C.wrap+1:C.wrap,de={};return de[new Bu(C.overscaledZ,ce,H.z,le,H.y).key]={backfilled:!1},de[new Bu(C.overscaledZ,ue,H.z,he,H.y).key]={backfilled:!1},H.y>0&&(de[new Bu(C.overscaledZ,ce,H.z,le,H.y-1).key]={backfilled:!1},de[new Bu(C.overscaledZ,C.wrap,H.z,H.x,H.y-1).key]={backfilled:!1},de[new Bu(C.overscaledZ,ue,H.z,he,H.y-1).key]={backfilled:!1}),H.y+1<te&&(de[new Bu(C.overscaledZ,ce,H.z,le,H.y+1).key]={backfilled:!1},de[new Bu(C.overscaledZ,C.wrap,H.z,H.x,H.y+1).key]={backfilled:!1},de[new Bu(C.overscaledZ,ue,H.z,he,H.y+1).key]={backfilled:!1}),de}unloadTile(C){C.demTexture&&this.map.painter.saveTileTexture(C.demTexture),C.hillshadeFBO&&(C.hillshadeFBO.destroy(),delete C.hillshadeFBO),C.dem&&delete C.dem,delete C.neighboringTiles,C.state="unloaded"}},geojson:class extends It{constructor(C,H,te,le){super(),this.id=C,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=te.getActor(),this.setEventedParent(le),this._data=H.data,this._options=k({},H),this._collectResourceTiming=H.collectResourceTiming,void 0!==H.maxzoom&&(this.maxzoom=H.maxzoom),H.type&&(this.type=H.type),H.attribution&&(this.attribution=H.attribution),this.promoteId=H.promoteId;const ce=wn/this.tileSize;this.workerOptions=k({source:this.id,scope:this.scope,cluster:H.cluster||!1,geojsonVtOptions:{buffer:(void 0!==H.buffer?H.buffer:128)*ce,tolerance:(void 0!==H.tolerance?H.tolerance:.375)*ce,extent:wn,maxZoom:this.maxzoom,lineMetrics:H.lineMetrics||!1,generateId:H.generateId||!1},superclusterOptions:{maxZoom:void 0!==H.clusterMaxZoom?H.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,H.clusterMinPoints||2),extent:wn,radius:(void 0!==H.clusterRadius?H.clusterRadius:50)*ce,log:!1,generateId:H.generateId||!1},clusterProperties:H.clusterProperties,filter:H.filter},H.workerOptions)}onAdd(C){this.map=C,this.setData(this._data)}setData(C){return this._data=C,this._updateWorkerData(),this}getClusterExpansionZoom(C,H){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:C,source:this.id,scope:this.scope},H),this}getClusterChildren(C,H){return this.actor.send("geojson.getClusterChildren",{clusterId:C,source:this.id,scope:this.scope},H),this}getClusterLeaves(C,H,te,le){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:C,limit:H,offset:te},le),this}_updateWorkerData(){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new At("dataloading",{dataType:"source"})),this._loaded=!1;const C=k({},this.workerOptions);C.scope=this.scope;const H=this._data;"string"==typeof H?(C.request=this.map._requestManager.transformRequest(yi.resolveURL(H),ot.Source),C.request.collectResourceTiming=this._collectResourceTiming):C.data=JSON.stringify(H),this._pendingLoad=this.actor.send(`${this.type}.loadData`,C,((C,H)=>{if(this._loaded=!0,this._pendingLoad=null,C)this.fire(new St(C));else{const C={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&H&&H.resourceTiming&&H.resourceTiming[this.id]&&(C.resourceTiming=H.resourceTiming[this.id]),this.fire(new At("data",C)),this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(),this._coalesce=!1)}))}loaded(){return this._loaded}loadTile(C,H){const te=C.actor?"reloadTile":"loadTile";C.actor=this.actor;const le={type:this.type,uid:C.uid,tileID:C.tileID,tileZoom:C.tileZoom,zoom:C.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,scope:this.scope,pixelRatio:yi.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0};C.request=this.actor.send(te,le,((le,ce)=>(delete C.request,C.unloadVectorData(),C.aborted?H(null):le?H(le):(C.loadVectorData(ce,this.map.painter,"reloadTile"===te),H(null)))),void 0,"loadTile"===te)}abortTile(C){C.request&&(C.request.cancel(),delete C.request),C.aborted=!0}unloadTile(C){C.unloadVectorData(),this.actor.send("removeTile",{uid:C.uid,type:this.type,source:this.id,scope:this.scope})}onRemove(){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return k({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends qb{constructor(C,H,te,le){super(C,H,te,le),this.roundZoom=!0,this.type="video",this.options=H}load(){this._loaded=!1;const C=this.options;this.urls=[];for(const H of C.urls)this.urls.push(this.map._requestManager.transformRequest(H,ot.Source).url);!function(C,H){const le=te.document.createElement("video");le.muted=!0,le.onloadstart=function(){H(null,le)};for(let H=0;H<C.length;H++){const ce=te.document.createElement("source");Ee(C[H])||(le.crossOrigin="Anonymous"),ce.src=C[H],le.appendChild(ce)}}(this.urls,((C,H)=>{this._loaded=!0,C?this.fire(new St(C)):H&&(this.video=H,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",(()=>{this.map.triggerRepaint()})),this.map&&this.video.play(),this._finishLoading())}))}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(C){if(this.video){const H=this.video.seekable;C<H.start(0)||C>H.end(0)?this.fire(new St(new zt(`sources.${this.id}`,null,`Playback for this video can be set only between the ${H.start(0)} and ${H.end(0)}-second mark.`))):this.video.currentTime=C}}getVideo(){return this.video}onAdd(C){this.map||(this.map=C,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(0===Object.keys(this.tiles).length||this.video.readyState<2)return;const C=this.map.painter.context,H=C.gl;this.texture?this.video.paused||(this.texture.bind(H.LINEAR,H.CLAMP_TO_EDGE),H.texSubImage2D(H.TEXTURE_2D,0,0,0,H.RGBA,H.UNSIGNED_BYTE,this.video)):(this.texture=new gy(C,this.video,H.RGBA),this.texture.bind(H.LINEAR,H.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(C)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:qb,model:class extends It{constructor(C,H,te,le){super(),this.id=C,this.type="model",this.models=[],this._loaded=!1,this._options=H}load(){const C=[];for(const H in this._options.models){const te=this._options.models[H],le=aT(this.map._requestManager.transformRequest(te.uri,ot.Model).url).then((C=>{if(!C)return;const le=_T(C),ce=new bv(H,te.position,te.orientation,le);ce.computeBoundsAndApplyParent(),this.models.push(ce)})).catch((C=>{this.fire(new St(new Error(`Could not load model ${H} from ${te.uri}: ${C.message}`)))}));C.push(le)}return Promise.allSettled(C).then((()=>{this._loaded=!0,this.fire(new At("data",{dataType:"source",sourceDataType:"metadata"}))})).catch((C=>{this.fire(new St(new Error(`Could not load models: ${C.message}`)))}))}onAdd(C){this.map=C,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(C,H){}serialize(){return{type:"model"}}},"batched-model":class extends It{constructor(C,H,te,le){super(),this.type="batched-model",this.id=C,this.tileSize=512,this._options=H,this.tiles=this._options.tiles,this.maxzoom=H.maxzoom||19,this.minzoom=H.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=te,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(le)}onAdd(C){this.map=C,this.load()}load(C){this._loaded=!1,this.fire(new At("dataloading",{dataType:"source"}));const H=Array.isArray(this.map._language)?this.map._language.join():this.map._language,te=this.map._worldview;this._tileJSONRequest=Ew(this._options,this.map._requestManager,H,te,((le,ce)=>{this._tileJSONRequest=null,this._loaded=!0,le?(H&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${H}`),te&&2!==te.length&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${te}`),this.fire(new St(le))):ce&&(k(this,ce),ce.bounds&&(this.tileBounds=new Mw(ce.bounds,this.minzoom,this.maxzoom)),Ct(ce.tiles,this.map._requestManager._customAccessToken),this.fire(new At("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new At("data",{dataType:"source",sourceDataType:"content"}))),C&&C(le)}))}hasTransition(){return!1}hasTile(C){return!this.tileBounds||this.tileBounds.contains(C.canonical)}loaded(){return this._loaded}loadTile(C,H){const te=this.map._requestManager.normalizeTileURL(C.tileID.canonical.url(this.tiles,this.scheme)),le={request:this.map._requestManager.transformRequest(te,ot.Tile),data:void 0,uid:C.uid,tileID:C.tileID,tileZoom:C.tileZoom,zoom:C.tileID.overscaledZ,tileSize:this.tileSize*C.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:C.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0};if(C.actor&&"expired"!==C.state)if("loading"===C.state)C.reloadCallback=H;else{if(C.buckets){const H=Object.values(C.buckets);for(const C of H)C.dirty=!0;return void(C.state="loaded")}C.request=C.actor.send("reloadTile",le,n.bind(this))}else C.actor=this.dispatcher.getActor(),C.request=C.actor.send("loadTile",le,n.bind(this),void 0,!0);function n(te,le){return C.aborted?H(null):te&&404!==te.status?H(te):(le&&(le.resourceTiming&&(C.resourceTiming=le.resourceTiming),this.map._refreshExpiredTiles&&C.setExpiryData(le),C.buckets={...C.buckets,...le.buckets}),C.state="loaded",void H(null))}}serialize(){return k({},this._options)}},canvas:class extends qb{constructor(C,H,le,ce){super(C,H,le,ce),H.coordinates?Array.isArray(H.coordinates)&&4===H.coordinates.length&&!H.coordinates.some((C=>!Array.isArray(C)||2!==C.length||C.some((C=>"number"!=typeof C))))||this.fire(new St(new zt(`sources.${C}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new St(new zt(`sources.${C}`,null,'missing required property "coordinates"'))),H.animate&&"boolean"!=typeof H.animate&&this.fire(new St(new zt(`sources.${C}`,null,'optional "animate" property must be a boolean value'))),H.canvas?"string"==typeof H.canvas||H.canvas instanceof te.HTMLCanvasElement||this.fire(new St(new zt(`sources.${C}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new St(new zt(`sources.${C}`,null,'missing required property "canvas"'))),this.options=H,this.animate=void 0===H.animate||H.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof te.HTMLCanvasElement?this.options.canvas:te.document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new St(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(C){this.map=C,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let C=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,C=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,C=!0),this._hasInvalidDimensions())return;if(0===Object.keys(this.tiles).length)return;const H=this.map.painter.context;this.texture?!C&&!this._playing||this.texture instanceof yy||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new gy(H,this.canvas,H.gl.RGBA,{premultiply:!0}),this._prepareData(H)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const C of[this.canvas.width,this.canvas.height])if(isNaN(C)||C<=0)return!0;return!1}},custom:class extends It{constructor(C,H,te,le){super(),this.id=C,this.type="custom",this._dataType="raster",this._dispatcher=te,this._implementation=H,this.setEventedParent(le),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new St(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new St(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new Mw(this._implementation.bounds,this.minzoom,this.maxzoom)),H.update=this._update.bind(this),H.clearTiles=this._clearTiles.bind(this),H.coveringTiles=this._coveringTiles.bind(this),k(this,O(H,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return O(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new At("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new At("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(C){this._map=C,this._loaded=!1,this.fire(new At("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(C),this.load()}onRemove(C){this._implementation.onRemove&&this._implementation.onRemove(C)}hasTile(C){if(this._implementation.hasTile){const{x:H,y:te,z:le}=C.canonical;return this._implementation.hasTile({x:H,y:te,z:le})}return!this.tileBounds||this.tileBounds.contains(C.canonical)}loadTile(C,H){const{x:le,y:ce,z:he}=C.tileID.canonical,ue=new te.AbortController;C.request=Promise.resolve(this._implementation.loadTile({x:le,y:ce,z:he},{signal:ue.signal})).then(function(le){return delete C.request,C.aborted?(C.state="unloaded",H(null)):void 0===le?(C.state="errored",H(null)):null===le?(this.loadTileData(C,{width:this.tileSize,height:this.tileSize,data:null}),C.state="loaded",H(null)):function(C){return C instanceof te.ImageData||C instanceof te.HTMLCanvasElement||C instanceof te.ImageBitmap||C instanceof te.HTMLImageElement}(le)?(this.loadTileData(C,le),C.state="loaded",void H(null)):(C.state="errored",H(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}.bind(this)).catch((te=>{20!==te.code&&(C.state="errored",H(te))})),C.request.cancel=()=>ue.abort()}loadTileData(C,H){Lw.loadTileData(C,H,this._map.painter)}unloadTileData(C){Lw.unloadTileData(C,this._map.painter)}unloadTile(C,H){if(this.unloadTileData(C),this._implementation.unloadTile){const{x:H,y:te,z:le}=C.tileID.canonical;this._implementation.unloadTile({x:H,y:te,z:le})}H()}abortTile(C,H){C.request&&C.request.cancel&&(C.request.cancel(),delete C.request),H()}hasTransition(){return!1}_coveringTiles(){return this._map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map((C=>({x:C.canonical.x,y:C.canonical.y,z:C.canonical.z})))}_clearTiles(){const C=pa(this.id,this.scope);this._map.style.clearSource(C)}_update(){this.fire(new At("data",{dataType:"source",sourceDataType:"content"}))}}},vT=function(C,H,te,le){const ce=new zE[H.type](C,H,te,le);if(ce.id!==C)throw new Error(`Expected Source id to be ${C} instead of ${ce.id}`);return j(["load","abort","unload","serialize","prepare"],ce),ce};function bT(C,H){const te=ed.identity([]);return ed.scale(te,te,[.5*C.width,.5*-C.height,1]),ed.translate(te,te,[1,-1,0]),ed.multiply(te,te,C.calculateProjMatrix(H.toUnwrapped())),Float32Array.from(te)}function wT(C,H,te,le,ce,he,ue,de=!1){const _e=C.tilesIn(le,ue,de);_e.sort(ET);const ye=[];for(const le of _e)ye.push({wrappedTileID:le.tile.tileID.wrapped().key,queryResults:le.tile.queryRenderedFeatures(H,te,C._state,le,ce,he,bT(C.transform,le.tile.tileID),de)});const ve=function(C){const H={},te={};for(const le of C){const C=le.queryResults,ce=le.wrappedTileID,he=te[ce]=te[ce]||{};for(const te in C){const le=C[te],ce=he[te]=he[te]||{},ue=H[te]=H[te]||[];for(const C of le)ce[C.featureIndex]||(ce[C.featureIndex]=!0,ue.push(C))}}return H}(ye);for(const H in ve)ve[H].forEach((H=>{const te=H.feature,le=te.layer;le&&"background"!==le.type&&"sky"!==le.type&&"slot"!==le.type&&(te.source=le.source,le["source-layer"]&&(te.sourceLayer=le["source-layer"]),te.state=void 0!==te.id?C.getFeatureState(le["source-layer"],te.id):{})}));return ve}function TT(C,H){const te=C.getRenderableIds().map((H=>C.getTileByID(H))),le=[],ce={};for(let C=0;C<te.length;C++){const he=te[C],ue=he.tileID.canonical.key;ce[ue]||(ce[ue]=!0,he.querySourceFeatures(le,H))}return le}function ET(C,H){const te=C.tileID,le=H.tileID;return te.overscaledZ-le.overscaledZ||te.canonical.y-le.canonical.y||te.wrap-le.wrap||te.canonical.x-le.canonical.x}class MT{constructor(C){this.style=C}processLayersChanged(){this.layers=[];for(const C in this.style._mergedLayers){const H=this.style._mergedLayers[C];if("fill-extrusion"===H.type)this.layers.push(H);else if("model"===H.type){const C=this.style.getLayerSource(H);C&&"batched-model"===C.type&&this.layers.push(H)}}}updateZOffset(C,H){this.currentBuildingBuckets=[];for(let C=0;C<this.layers.length;++C){const te=this.layers[C],le=this.style.getLayerSourceCache(te);let ce=1;"fill-extrusion"===te.type&&(ce=te.paint.get("fill-extrusion-opacity")>0?te.paint.get("fill-extrusion-vertical-scale"):0);let he=le?le.getTile(H):null;if(!he&&le&&H.canonical.z>le.getSource().minzoom){let C=H.scaledTo(Math.min(le.getSource().maxzoom,H.overscaledZ-1));for(;C.overscaledZ>=le.getSource().minzoom&&(he=le.getTile(C),!he&&0!==C.overscaledZ);)C=C.scaledTo(C.overscaledZ-1)}this.currentBuildingBuckets.push({bucket:he?he.getBucket(te):null,tileID:he?he.tileID:H,verticalScale:ce})}C.hasAnyZOffset=!1;let te=!1;for(let le=0;le<C.symbolInstances.length;le++){const ce=C.symbolInstances.get(le),he=ce.zOffset,ue=this._getHeightAtTileOffset(H,ce.tileAnchorX,ce.tileAnchorY);ce.zOffset=-1!==ue?ue:he,te||he===ce.zOffset||(te=!0),C.hasAnyZOffset||0===ce.zOffset||(C.hasAnyZOffset=!0)}te&&(C.zOffsetBuffersNeedUpload=!0,C.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(C,H,te,le){let ce=H,he=te;if(C.canonical.z!==le.canonical.z){const ue=le.canonical,de=1/(1<<C.canonical.z-ue.z);ce=(H+C.canonical.x*wn)*de-ue.x*wn|0,he=(te+C.canonical.y*wn)*de-ue.y*wn|0}return{tileX:ce,tileY:he}}_getHeightAtTileOffset(C,H,te){let le;for(let ce=0;ce<this.layers.length;++ce){if("fill-extrusion"!==this.layers[ce].type)continue;const{bucket:he,tileID:ue,verticalScale:de}=this.currentBuildingBuckets[ce];if(!he)continue;const{tileX:_e,tileY:ye}=this._mapCoordToOverlappingTile(C,H,te,ue),ve=he.getHeightAtTileCoord(_e,ye);if(ve&&void 0!==ve.height){if(!ve.hidden)return ve.height*de;le=ve.height}}for(let ce=0;ce<this.layers.length;++ce){if("model"!==this.layers[ce].type)continue;const{bucket:he,tileID:ue}=this.currentBuildingBuckets[ce];if(!he)continue;const{tileX:de,tileY:_e}=this._mapCoordToOverlappingTile(C,H,te,ue),ye=he.getHeightAtTileCoord(de,_e);if(ye&&!ye.hidden)return void 0===ye.height&&void 0!==le?Math.min(ye.maxHeight,le)*ye.verticalScale:(ye.height||0)*ye.verticalScale}return-1}}var DE=["type","source","source-layer","minzoom","maxzoom","filter","layout"];function ST(C,H){const te={};for(const H in C)"ref"!==H&&(te[H]=C[H]);return DE.forEach((C=>{C in H&&(te[C]=H[C])})),te}function IT(C){C=C.slice();const H=Object.create(null);for(let te=0;te<C.length;te++)H[C[te].id]=C[te];for(let te=0;te<C.length;te++)"ref"in C[te]&&(C[te]=ST(C[te],H[C[te].ref]));return C}const PE={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",setImportUrl:"setImportUrl",setImportData:"setImportData",setImportConfig:"setImportConfig"};function zT(C,H,te){te.push({command:PE.addSource,args:[C,H[C]]})}function DT(C,H,te){H.push({command:PE.removeSource,args:[C]}),te[C]=!0}function PT(C,H,te,le){DT(C,te,le),zT(C,H,te)}function RT(C,H,te){let le;for(le in C[te])if(C[te].hasOwnProperty(le)&&"data"!==le&&!x(C[te][le],H[te][le]))return!1;for(le in H[te])if(H[te].hasOwnProperty(le)&&"data"!==le&&!x(C[te][le],H[te][le]))return!1;return!0}function LT(C,H,te,le,ce,he){let ue;for(ue in H=H||{},C=C||{})C.hasOwnProperty(ue)&&(x(C[ue],H[ue])||te.push({command:he,args:[le,ue,H[ue],ce]}));for(ue in H)H.hasOwnProperty(ue)&&!C.hasOwnProperty(ue)&&(x(C[ue],H[ue])||te.push({command:he,args:[le,ue,H[ue],ce]}))}function kT(C){return C.id}function OT(C,H){return C[H.id]=H,C}class BT{constructor(C,H){this.reset(C,H)}reset(C,H){this.points=C||[],this._distances=[0];for(let C=1;C<this.points.length;C++)this._distances[C]=this._distances[C-1]+this.points[C].dist(this.points[C-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(H||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(C){if(1===this.points.length)return this.points[0];C=z(C,0,1);let H=1,te=this._distances[H];const le=C*this.paddedLength+this.padding;for(;te<le&&H<this._distances.length;)te=this._distances[++H];const ce=H-1,he=this._distances[ce],ue=te-he,de=ue>0?(le-he)/ue:0;return this.points[ce].mult(1-de).add(this.points[H].mult(de))}}class FT{constructor(C,H,te){const le=this.boxCells=[],ce=this.circleCells=[];this.xCellCount=Math.ceil(C/te),this.yCellCount=Math.ceil(H/te);for(let C=0;C<this.xCellCount*this.yCellCount;C++)le.push([]),ce.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=C,this.height=H,this.xScale=this.xCellCount/C,this.yScale=this.yCellCount/H,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(C,H,te,le,ce){this._forEachCell(H,te,le,ce,this._insertBoxCell,this.boxUid++),this.boxKeys.push(C),this.bboxes.push(H),this.bboxes.push(te),this.bboxes.push(le),this.bboxes.push(ce)}insertCircle(C,H,te,le){this._forEachCell(H-le,te-le,H+le,te+le,this._insertCircleCell,this.circleUid++),this.circleKeys.push(C),this.circles.push(H),this.circles.push(te),this.circles.push(le)}_insertBoxCell(C,H,te,le,ce,he){this.boxCells[ce].push(he)}_insertCircleCell(C,H,te,le,ce,he){this.circleCells[ce].push(he)}_query(C,H,te,le,ce,he){if(te<0||C>this.width||le<0||H>this.height)return!ce&&[];const ue=[];if(C<=0&&H<=0&&this.width<=te&&this.height<=le){if(ce)return!0;for(let C=0;C<this.boxKeys.length;C++)ue.push({key:this.boxKeys[C],x1:this.bboxes[4*C],y1:this.bboxes[4*C+1],x2:this.bboxes[4*C+2],y2:this.bboxes[4*C+3]});for(let C=0;C<this.circleKeys.length;C++){const H=this.circles[3*C],te=this.circles[3*C+1],le=this.circles[3*C+2];ue.push({key:this.circleKeys[C],x1:H-le,y1:te-le,x2:H+le,y2:te+le})}return he?ue.filter(he):ue}return this._forEachCell(C,H,te,le,this._queryCell,ue,{hitTest:ce,seenUids:{box:{},circle:{}}},he),ce?ue.length>0:ue}_queryCircle(C,H,te,le,ce){const he=C-te,ue=C+te,de=H-te,_e=H+te;if(ue<0||he>this.width||_e<0||de>this.height)return!le&&[];const ye=[];return this._forEachCell(he,de,ue,_e,this._queryCellCircle,ye,{hitTest:le,circle:{x:C,y:H,radius:te},seenUids:{box:{},circle:{}}},ce),le?ye.length>0:ye}query(C,H,te,le,ce){return this._query(C,H,te,le,!1,ce)}hitTest(C,H,te,le,ce){return this._query(C,H,te,le,!0,ce)}hitTestCircle(C,H,te,le){return this._queryCircle(C,H,te,!0,le)}_queryCell(C,H,te,le,ce,he,ue,de){const _e=ue.seenUids,ye=this.boxCells[ce];if(null!==ye){const ce=this.bboxes;for(const ve of ye)if(!_e.box[ve]){_e.box[ve]=!0;const ye=4*ve;if(C<=ce[ye+2]&&H<=ce[ye+3]&&te>=ce[ye+0]&&le>=ce[ye+1]&&(!de||de(this.boxKeys[ve]))){if(ue.hitTest)return he.push(!0),!0;he.push({key:this.boxKeys[ve],x1:ce[ye],y1:ce[ye+1],x2:ce[ye+2],y2:ce[ye+3]})}}}const ve=this.circleCells[ce];if(null!==ve){const ce=this.circles;for(const ye of ve)if(!_e.circle[ye]){_e.circle[ye]=!0;const ve=3*ye;if(this._circleAndRectCollide(ce[ve],ce[ve+1],ce[ve+2],C,H,te,le)&&(!de||de(this.circleKeys[ye]))){if(ue.hitTest)return he.push(!0),!0;{const C=ce[ve],H=ce[ve+1],te=ce[ve+2];he.push({key:this.circleKeys[ye],x1:C-te,y1:H-te,x2:C+te,y2:H+te})}}}}}_queryCellCircle(C,H,te,le,ce,he,ue,de){const _e=ue.circle,ye=ue.seenUids,ve=this.boxCells[ce];if(null!==ve){const C=this.bboxes;for(const H of ve)if(!ye.box[H]){ye.box[H]=!0;const te=4*H;if(this._circleAndRectCollide(_e.x,_e.y,_e.radius,C[te+0],C[te+1],C[te+2],C[te+3])&&(!de||de(this.boxKeys[H])))return he.push(!0),!0}}const Me=this.circleCells[ce];if(null!==Me){const C=this.circles;for(const H of Me)if(!ye.circle[H]){ye.circle[H]=!0;const te=3*H;if(this._circlesCollide(C[te],C[te+1],C[te+2],_e.x,_e.y,_e.radius)&&(!de||de(this.circleKeys[H])))return he.push(!0),!0}}}_forEachCell(C,H,te,le,ce,he,ue,de){const _e=this._convertToXCellCoord(C),ye=this._convertToYCellCoord(H),ve=this._convertToXCellCoord(te),Me=this._convertToYCellCoord(le);for(let Se=_e;Se<=ve;Se++)for(let _e=ye;_e<=Me;_e++)if(ce.call(this,C,H,te,le,this.xCellCount*_e+Se,he,ue,de))return}_convertToXCellCoord(C){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(C*this.xScale)))}_convertToYCellCoord(C){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(C*this.yScale)))}_circlesCollide(C,H,te,le,ce,he){const ue=le-C,de=ce-H,_e=te+he;return _e*_e>ue*ue+de*de}_circleAndRectCollide(C,H,te,le,ce,he,ue){const de=(he-le)/2,_e=Math.abs(C-(le+de));if(_e>de+te)return!1;const ye=(ue-ce)/2,ve=Math.abs(H-(ce+ye));if(ve>ye+te)return!1;if(_e<=de||ve<=ye)return!0;const Me=_e-de,Se=ve-ye;return Me*Me+Se*Se<=te*te}}const kE=100;class UT{constructor(C,H,te=new FT(C.width+200,C.height+200,25),le=new FT(C.width+200,C.height+200,25)){this.transform=C,this.grid=te,this.ignoredGrid=le,this.pitchfactor=Math.cos(C._pitch)*C.cameraToCenterDistance,this.screenRightBoundary=C.width+kE,this.screenBottomBoundary=C.height+kE,this.gridRightBoundary=C.width+200,this.gridBottomBoundary=C.height+200,this.fogState=H}placeCollisionBox(C,H,te,le,ce,he,ue,de){let _e=te.projectedAnchorX,ye=te.projectedAnchorY,ve=te.projectedAnchorZ;const Me=te.elevation,Se=te.tileID,Ae=C.getProjection();if(Me&&Se){const[C,H,le]=Ae.upVector(Se.canonical,te.tileAnchorX,te.tileAnchorY),ce=Ae.upVectorScale(Se.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;_e+=C*Me*ce,ye+=H*Me*ce,ve+=le*Me*ce}const Ce=this.projectAndGetPerspectiveRatio(ue,_e,ye,ve,te.tileID,"globe"===Ae.name||!!Me||this.transform.pitch>0,Ae),Oe=he*Ce.perspectiveRatio,Ne=(te.x1*H+le.x-te.padding)*Oe+Ce.point.x,je=(te.y1*H+le.y-te.padding)*Oe+Ce.point.y,Ge=(te.x2*H+le.x+te.padding)*Oe+Ce.point.x,Ze=(te.y2*H+le.y+te.padding)*Oe+Ce.point.y,qe=Ce.perspectiveRatio<=.55||Ce.occluded;return!this.isInsideGrid(Ne,je,Ge,Ze)||!ce&&this.grid.hitTest(Ne,je,Ge,Ze,de)||qe?{box:[],offscreen:!1,occluded:Ce.occluded}:{box:[Ne,je,Ge,Ze],offscreen:this.isOffscreen(Ne,je,Ge,Ze),occluded:!1}}placeCollisionCircles(C,H,te,le,ce,he,ue,de,_e,ye,ve,Me,Se,Ae,Ce){const Oe=[],je=this.transform.elevation,Ge=C.getProjection(),Ze=je?je.getAtTileOffsetFunc(Ce,this.transform.center.lat,this.transform.worldSize,Ge):null,qe=new Ne(te.tileAnchorX,te.tileAnchorY);let{x:$e,y:We,z:He}=Ge.projectTilePoint(qe.x,qe.y,Ce.canonical);if(Ze){const[C,H,te]=Ze(qe);$e+=C,We+=H,He+=te}const Xe="globe"===Ge.name,Ye=this.projectAndGetPerspectiveRatio(ue,$e,We,He,Ce,Xe||!!je||this.transform.pitch>0,Ge),{perspectiveRatio:Je}=Ye,Qe=(ve?he/Je:he*Je)/Dg,tt=tv($e,We,He,de),rt=Ye.signedDistanceFromCamera>0?ov(Qe,ce,te.lineOffsetX*Qe,te.lineOffsetY*Qe,!1,tt,qe,te,le,de,{},je&&!ve?Ze:null,ve&&!!je,Ge,Ce,ve):null;let ot=!1,st=!1,at=!0;if(rt&&!Ye.occluded){const C=.5*Se*Je+Ae,te=new Ne(-100,-100),le=new Ne(this.screenRightBoundary,this.screenBottomBoundary),ce=new BT,{first:he,last:ue}=rt,de=he.path.length;let ve=[];for(let C=de-1;C>=1;C--)ve.push(he.path[C]);for(let C=1;C<ue.path.length;C++)ve.push(ue.path[C]);const Ce=2.5*C;_e&&(ve=ve.map((([C,H,te],le)=>(Ze&&!Xe&&(te=Ze(le<de-1?he.tilePath[de-1-le]:ue.tilePath[le-de+2])[2]),tv(C,H,te,_e)))),ve.some((C=>C[3]<=0))&&(ve=[]));let je=[];if(ve.length>0){let C=1/0,H=-1/0,ce=1/0,he=-1/0;for(const te of ve)C=Math.min(C,te[0]),ce=Math.min(ce,te[1]),H=Math.max(H,te[0]),he=Math.max(he,te[1]);H>=te.x&&C<=le.x&&he>=te.y&&ce<=le.y&&(je=[ve.map((C=>new Ne(C[0],C[1])))],(C<te.x||H>le.x||ce<te.y||he>le.y)&&(je=$_(je,te.x,te.y,le.x,le.y)))}for(const te of je){ce.reset(te,.25*C);let le=0;le=ce.length<=.5*C?1:Math.ceil(ce.paddedLength/Ce)+1;for(let te=0;te<le;te++){const he=te/Math.max(le-1,1),ue=ce.lerp(he),de=ue.x+kE,_e=ue.y+kE;Oe.push(de,_e,C,0);const ve=de-C,Se=_e-C,Ae=de+C,Ce=_e+C;if(at=at&&this.isOffscreen(ve,Se,Ae,Ce),st=st||this.isInsideGrid(ve,Se,Ae,Ce),!H&&this.grid.hitTestCircle(de,_e,C,Me)&&(ot=!0,!ye))return{circles:[],offscreen:!1,collisionDetected:ot,occluded:!1}}}}return{circles:!ye&&ot||!st?[]:Oe,offscreen:at,collisionDetected:ot,occluded:Ye.occluded}}queryRenderedSymbols(C){if(0===C.length||0===this.grid.keysLength()&&0===this.ignoredGrid.keysLength())return{};const H=[];let te=1/0,le=1/0,ce=-1/0,he=-1/0;for(const ue of C){const C=new Ne(ue.x+kE,ue.y+kE);te=Math.min(te,C.x),le=Math.min(le,C.y),ce=Math.max(ce,C.x),he=Math.max(he,C.y),H.push(C)}const ue=this.grid.query(te,le,ce,he).concat(this.ignoredGrid.query(te,le,ce,he)),de={},_e={};for(const C of ue){const te=C.key;void 0===de[te.bucketInstanceId]&&(de[te.bucketInstanceId]={}),de[te.bucketInstanceId][te.featureIndex]||pp(H,[new Ne(C.x1,C.y1),new Ne(C.x2,C.y1),new Ne(C.x2,C.y2),new Ne(C.x1,C.y2)])&&(de[te.bucketInstanceId][te.featureIndex]=!0,void 0===_e[te.bucketInstanceId]&&(_e[te.bucketInstanceId]=[]),_e[te.bucketInstanceId].push(te.featureIndex))}return _e}insertCollisionBox(C,H,te,le,ce){(H?this.ignoredGrid:this.grid).insert({bucketInstanceId:te,featureIndex:le,collisionGroupID:ce},C[0],C[1],C[2],C[3])}insertCollisionCircles(C,H,te,le,ce){const he=H?this.ignoredGrid:this.grid,ue={bucketInstanceId:te,featureIndex:le,collisionGroupID:ce};for(let H=0;H<C.length;H+=4)he.insertCircle(ue,C[H],C[H+1],C[H+2])}projectAndGetPerspectiveRatio(C,H,te,le,ce,he,ue){const de=[H,te,le,1];let _e=!1;if(le||this.transform.pitch>0){if(Lu.transformMat4(de,de,C),this.fogState&&ce&&"globe"!==ue.name){const C=function(C,H,te,le,ce,he){const ue=he.calculateFogTileMatrix(ce),de=[H,te,le];return Ld.transformMat4(de,de,ue),aw(C,Ld.length(de),he.pitch,he._fov)}(this.fogState,H,te,le,ce.toUnwrapped(),this.transform);_e=C>.9}}else dv(de,de,C);const ye=de[3];return{point:new Ne((de[0]/ye+1)/2*this.transform.width+kE,(-de[1]/ye+1)/2*this.transform.height+kE),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(ue)/ye*.5,1.5),signedDistanceFromCamera:ye,occluded:he&&de[2]>ye||_e}}isOffscreen(C,H,te,le){return te<kE||C>=this.screenRightBoundary||le<kE||H>this.screenBottomBoundary}isInsideGrid(C,H,te,le){return te>=0&&C<this.gridRightBoundary&&le>=0&&H<this.gridBottomBoundary}getViewportMatrix(){const C=ed.identity([]);return ed.translate(C,C,[-100,-100,0]),C}}function VT(C,H,te){const le=H.createTileMatrix(C,C.worldSize,te.toUnwrapped());return ed.multiply(new Float32Array(16),C.projMatrix,le)}function jT(C,H,te){if(H.projection.name===te.projection.name)return C.projMatrix;const le=te.clone();return le.setProjection(H.projection),VT(le,H.getProjection(),C)}function GT(C,H,te){return H.name===te.projection.name?C.projMatrix:VT(te,H,C)}class qT{constructor(C,H,te,le){this.opacity=C?Math.max(0,Math.min(1,C.opacity+(C.placed?H:-H))):le&&te?1:0,this.placed=te}isHidden(){return 0===this.opacity&&!this.placed}}class ZT{constructor(C,H,te,le,ce,he=!1){this.text=new qT(C?C.text:null,H,te,ce),this.icon=new qT(C?C.icon:null,H,le,ce),this.clipped=he}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class $T{constructor(C,H,te,le=!1){this.text=C,this.icon=H,this.skipFade=te,this.clipped=le}}class HT{constructor(){this.invProjMatrix=ed.create(),this.viewportMatrix=ed.create(),this.circles=[]}}class WT{constructor(C,H,te,le,ce){this.bucketInstanceId=C,this.featureIndex=H,this.sourceLayerIndex=te,this.bucketIndex=le,this.tileID=ce}}class XT{constructor(C){this.crossSourceCollisions=C,this.maxGroupID=0,this.collisionGroups={}}get(C){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[C]){const H=++this.maxGroupID;this.collisionGroups[C]={ID:H,predicate:C=>C.collisionGroupID===H}}return this.collisionGroups[C]}}function YT(C,H,te,le,ce){const{horizontalAlign:he,verticalAlign:ue}=L_(C),de=-(he-.5)*H,_e=-(ue-.5)*te,ye=ug(C,le);return new Ne(de+ye[0]*ce,_e+ye[1]*ce)}function KT(C,H,te,le,ce){const he=new Ne(C,H);return te&&he._rotate(le?ce:-ce),he}class JT{constructor(C,H,te,le,ce,he){this.transform=C.clone(),this.projection=C.projection.name,this.collisionIndex=new UT(this.transform,ce),this.buildingIndex=he,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=H,this.retainedQueryData={},this.collisionGroups=new XT(te),this.collisionCircleArrays={},this.prevPlacement=le,le&&(le.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(C,H,te,le){const ce=te.getBucket(H),he=te.latestFeatureIndex;if(!ce||!he||H.fqid!==ce.layerIds[0])return;const ue=ce.layers[0].layout,de=te.collisionBoxArray,_e=Math.pow(2,this.transform.zoom-te.tileID.overscaledZ),ye=te.tileSize/wn,ve=te.tileID.toUnwrapped();this.transform.setProjection(ce.projection);const Me=(Se=te.tileID,Ae=ce.getProjection(),Ce=this.transform,Ae.name===this.projection?Ce.calculateProjMatrix(Se.toUnwrapped()):VT(Ce,Ae,Se));var Se,Ae,Ce;const Oe="map"===ue.get("text-pitch-alignment"),Ne="map"===ue.get("text-rotation-alignment");H.compileFilter();const je=H.dynamicFilter(),Ge=H.dynamicFilterNeedsFeature(),Ze=this.transform.calculatePixelsToTileUnitsMatrix(te),qe=Qx(Me,te.tileID.canonical,Oe,Ne,this.transform,ce.getProjection(),Ze);let $e=null;if(Oe){const C=ev(Me,te.tileID.canonical,Oe,Ne,this.transform,ce.getProjection(),Ze);$e=ed.multiply([],this.transform.labelPlaneMatrix,C)}let We=null;je&&te.latestFeatureIndex&&(We={unwrappedTileID:ve,dynamicFilter:je,dynamicFilterNeedsFeature:Ge,featureIndex:te.latestFeatureIndex}),this.retainedQueryData[ce.bucketInstanceId]=new WT(ce.bucketInstanceId,he,ce.sourceLayerIndex,ce.index,te.tileID);const He={bucket:ce,layout:ue,posMatrix:Me,textLabelPlaneMatrix:qe,labelToScreenMatrix:$e,clippingData:We,scale:_e,textPixelRatio:ye,holdingForFade:te.holdingForFade(),collisionBoxArray:de,partiallyEvaluatedTextSize:a_(ce.textSizeData,this.transform.zoom),partiallyEvaluatedIconSize:a_(ce.iconSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(ce.sourceID)};if(le)for(const H of ce.sortKeyRanges){const{sortKey:te,symbolInstanceStart:le,symbolInstanceEnd:ce}=H;C.push({sortKey:te,symbolInstanceStart:le,symbolInstanceEnd:ce,parameters:He})}else C.push({symbolInstanceStart:0,symbolInstanceEnd:ce.symbolInstances.length,parameters:He})}attemptAnchorPlacement(C,H,te,le,ce,he,ue,de,_e,ye,ve,Me,Se,Ae,Ce,Oe,Ne,je){const{textOffset0:Ge,textOffset1:Ze,crossTileID:qe}=Me,$e=[Ge,Ze],We=YT(C,te,le,$e,ce),He=this.collisionIndex.placeCollisionBox(Ae,ce,H,KT(We.x,We.y,he,ue,this.transform.angle),ve,de,_e,ye.predicate);if(Oe){const C=Ae.getSymbolInstanceIconSize(je,this.transform.zoom,Me.placedIconSymbolIndex);if(0===this.collisionIndex.placeCollisionBox(Ae,C,Oe,KT(We.x,We.y,he,ue,this.transform.angle),ve,de,_e,ye.predicate).box.length)return}if(He.box.length>0){let H;return this.prevPlacement&&this.prevPlacement.variableOffsets[qe]&&this.prevPlacement.placements[qe]&&this.prevPlacement.placements[qe].text&&(H=this.prevPlacement.variableOffsets[qe].anchor),this.variableOffsets[qe]={textOffset:$e,width:te,height:le,anchor:C,textScale:ce,prevAnchor:H},this.markUsedJustification(Ae,C,Me,Ce),Ae.allowVerticalPlacement&&(this.markUsedOrientation(Ae,Ce,Me),this.placedOrientations[qe]=Ce),{shift:We,placedGlyphBoxes:He}}}placeLayerBucketPart(C,H,te,le){const{bucket:ce,layout:he,posMatrix:ue,textLabelPlaneMatrix:de,labelToScreenMatrix:_e,clippingData:ye,textPixelRatio:ve,holdingForFade:Me,collisionBoxArray:Se,partiallyEvaluatedTextSize:Ae,partiallyEvaluatedIconSize:Ce,collisionGroup:Oe}=C.parameters,je=he.get("text-optional"),Ge=he.get("icon-optional"),Ze=he.get("text-allow-overlap"),qe=he.get("icon-allow-overlap"),$e="map"===he.get("text-rotation-alignment"),We="map"===he.get("text-pitch-alignment"),He="viewport-y"===he.get("symbol-z-order"),Xe=he.get("symbol-z-elevate");this.transform.setProjection(ce.projection);let Ye=Ze&&(qe||!ce.hasIconData()||Ge),Je=qe&&(Ze||!ce.hasTextData()||je);!ce.collisionArrays&&Se&&ce.deserializeCollisionBoxes(Se),te&&le&&ce.updateCollisionDebugBuffers(this.transform.zoom,Se);const S=(C,le,Se)=>{const{crossTileID:He,numVerticalGlyphVertices:Xe}=C;if(ye){const te={zoom:this.transform.zoom,pitch:this.transform.pitch};let le=null;if(ye.dynamicFilterNeedsFeature){const H=this.retainedQueryData[ce.bucketInstanceId];le=ye.featureIndex.loadFeature({featureIndex:C.featureIndex,bucketIndex:H.bucketIndex,sourceLayerIndex:H.sourceLayerIndex,layoutVertexArrayOffset:0})}if(!(0,ye.dynamicFilter)(te,le,this.retainedQueryData[ce.bucketInstanceId].tileID.canonical,new Ne(C.tileAnchorX,C.tileAnchorY),this.transform.calculateDistanceTileData(ye.unwrappedTileID)))return this.placements[He]=new $T(!1,!1,!1,!0),void H.add(He)}if(H.has(He))return;if(Me)return void(this.placements[He]=new $T(!1,!1,!1));let Qe=!1,tt=!1,rt=!0,ot=!1,st=!1,at=null,lt={box:null,offscreen:null,occluded:null},ct={box:null,offscreen:null,occluded:null},ht=null,pt=null,ft=null,mt=0,Ct=0,Ot=0;Se.textFeatureIndex?mt=Se.textFeatureIndex:C.useRuntimeCollisionCircles&&(mt=C.featureIndex),Se.verticalTextFeatureIndex&&(Ct=Se.verticalTextFeatureIndex);const V=H=>{H.tileID=this.retainedQueryData[ce.bucketInstanceId].tileID;const te=this.transform.elevation;H.elevation=C.zOffset+(te?te.getAtTileOffset(H.tileID,H.tileAnchorX,H.tileAnchorY):0)},Ft=Se.textBox;if(Ft){V(Ft);const t=H=>{let te=Wg.horizontal;if(ce.allowVerticalPlacement&&!H&&this.prevPlacement){const H=this.prevPlacement.placedOrientations[He];H&&(this.placedOrientations[He]=H,te=H,this.markUsedOrientation(ce,te,C))}return te},i=(C,H)=>{if(ce.allowVerticalPlacement&&Xe>0&&Se.verticalTextBox){for(const te of ce.writingModes)if(te===Wg.vertical?(lt=H(),ct=lt):lt=C(),lt&&lt.box&&lt.box.length)break}else lt=C()};if(he.get("text-variable-anchor")){let H=he.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[He]){const C=this.prevPlacement.variableOffsets[He];H.indexOf(C.anchor)>0&&(H=H.filter((H=>H!==C.anchor)),H.unshift(C.anchor))}const l=(te,he,de)=>{const _e=ce.getSymbolInstanceTextSize(Ae,C,this.transform.zoom,le),ye=(te.x2-te.x1)*_e+2*te.padding,Me=(te.y2-te.y1)*_e+2*te.padding,Se=C.hasIconTextFit&&!qe?he:null;Se&&V(Se);let Ne={box:[],offscreen:!1,occluded:!1};const je=Ze?2*H.length:H.length;for(let he=0;he<je;++he){const je=this.attemptAnchorPlacement(H[he%H.length],te,ye,Me,_e,$e,We,ve,ue,Oe,he>=H.length,C,le,ce,de,Se,Ae,Ce);if(je&&(Ne=je.placedGlyphBoxes,Ne&&Ne.box&&Ne.box.length)){Qe=!0,at=je.shift;break}}return Ne};i((()=>l(Ft,Se.iconBox,Wg.horizontal)),(()=>{const C=Se.verticalTextBox;return C&&V(C),ce.allowVerticalPlacement&&!(lt&&lt.box&&lt.box.length)&&Xe>0&&C?l(C,Se.verticalIconBox,Wg.vertical):{box:null,offscreen:null,occluded:null}})),lt&&(Qe=lt.box,rt=lt.offscreen,ot=lt.occluded);const te=t(!(!lt||!lt.box));if(!Qe&&this.prevPlacement){const H=this.prevPlacement.variableOffsets[He];H&&(this.variableOffsets[He]=H,this.markUsedJustification(ce,H.anchor,C,te))}}else{const o=(H,te)=>{const he=ce.getSymbolInstanceTextSize(Ae,C,this.transform.zoom,le),de=this.collisionIndex.placeCollisionBox(ce,he,H,new Ne(0,0),Ze,ve,ue,Oe.predicate);return de&&de.box&&de.box.length&&(this.markUsedOrientation(ce,te,C),this.placedOrientations[He]=te),de};i((()=>o(Ft,Wg.horizontal)),(()=>{const C=Se.verticalTextBox;return ce.allowVerticalPlacement&&Xe>0&&C?(V(C),o(C,Wg.vertical)):{box:null,offscreen:null,occluded:null}})),t(!!(lt&&lt.box&&lt.box.length))}}if(ht=lt,Qe=ht&&ht.box&&ht.box.length>0,rt=ht&&ht.offscreen,ot=ht&&ht.occluded,C.useRuntimeCollisionCircles){const H=ce.text.placedSymbolArray.get(C.centerJustifiedTextSymbolIndex>=0?C.centerJustifiedTextSymbolIndex:C.verticalPlacedTextSymbolIndex),le=s_(ce.textSizeData,Ae,H),ye=he.get("text-padding");pt=this.collisionIndex.placeCollisionCircles(ce,Ze,H,ce.lineVertexArray,ce.glyphOffsetArray,le,ue,de,_e,te,We,Oe.predicate,C.collisionCircleDiameter*le/Dg,ye,this.retainedQueryData[ce.bucketInstanceId].tileID),Qe=Ze||pt.circles.length>0&&!pt.collisionDetected,rt=rt&&pt.offscreen,ot=pt.occluded}if(Se.iconFeatureIndex&&(Ot=Se.iconFeatureIndex),Se.iconBox){const t=H=>{V(H);const te=C.hasIconTextFit&&at?KT(at.x,at.y,$e,We,this.transform.angle):new Ne(0,0),le=ce.getSymbolInstanceIconSize(Ce,this.transform.zoom,C.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(ce,le,H,te,qe,ve,ue,Oe.predicate)};ct&&ct.box&&ct.box.length&&Se.verticalIconBox?(ft=t(Se.verticalIconBox),tt=ft.box.length>0):(ft=t(Se.iconBox),tt=ft.box.length>0),rt=rt&&ft.offscreen,st=ft.occluded}const Nt=je||0===C.numHorizontalGlyphVertices&&0===Xe,Ut=Ge||0===C.numIconVertices;if(Nt||Ut?Ut?Nt||(tt=tt&&Qe):Qe=tt&&Qe:tt=Qe=tt&&Qe,Qe&&ht&&ht.box&&this.collisionIndex.insertCollisionBox(ht.box,he.get("text-ignore-placement"),ce.bucketInstanceId,ct&&ct.box&&Ct?Ct:mt,Oe.ID),tt&&ft&&this.collisionIndex.insertCollisionBox(ft.box,he.get("icon-ignore-placement"),ce.bucketInstanceId,Ot,Oe.ID),pt&&(Qe&&this.collisionIndex.insertCollisionCircles(pt.circles,he.get("text-ignore-placement"),ce.bucketInstanceId,mt,Oe.ID),te)){const C=ce.bucketInstanceId;let H=this.collisionCircleArrays[C];void 0===H&&(H=this.collisionCircleArrays[C]=new HT);for(let C=0;C<pt.circles.length;C+=4)H.circles.push(pt.circles[C+0]),H.circles.push(pt.circles[C+1]),H.circles.push(pt.circles[C+2]),H.circles.push(pt.collisionDetected?1:0)}const Vt="globe"!==ce.projection.name;Ye=Ye&&(Vt||!ot),Je=Je&&(Vt||!st),this.placements[He]=new $T(Qe||Ye,tt||Je,rt||ce.justReloaded),H.add(He)};if(Xe&&this.buildingIndex&&(this.buildingIndex.updateZOffset(ce,this.retainedQueryData[ce.bucketInstanceId].tileID),ce.updateZOffset()),He){const C=ce.getSortedSymbolIndexes(this.transform.angle);for(let H=C.length-1;H>=0;--H){const te=C[H];S(ce.symbolInstances.get(te),te,ce.collisionArrays[te])}ce.hasAnyZOffset&&W(`${ce.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(ce.hasAnyZOffset){const C=ce.getSortedIndexesByZOffset();for(let H=0;H<C.length;++H){const te=C[H];S(ce.symbolInstances.get(te),te,ce.collisionArrays[te])}}else for(let H=C.symbolInstanceStart;H<C.symbolInstanceEnd;H++)S(ce.symbolInstances.get(H),H,ce.collisionArrays[H]);if(te&&ce.bucketInstanceId in this.collisionCircleArrays){const C=this.collisionCircleArrays[ce.bucketInstanceId];ed.invert(C.invProjMatrix,ue),C.viewportMatrix=this.collisionIndex.getViewportMatrix()}ce.justReloaded=!1}markUsedJustification(C,H,te,le){const{leftJustifiedTextSymbolIndex:ce,centerJustifiedTextSymbolIndex:he,rightJustifiedTextSymbolIndex:ue,verticalPlacedTextSymbolIndex:de,crossTileID:_e}=te,ye=pg(H),ve=le===Wg.vertical?de:"left"===ye?ce:"center"===ye?he:"right"===ye?ue:-1;ce>=0&&(C.text.placedSymbolArray.get(ce).crossTileID=ve>=0&&ce!==ve?0:_e),he>=0&&(C.text.placedSymbolArray.get(he).crossTileID=ve>=0&&he!==ve?0:_e),ue>=0&&(C.text.placedSymbolArray.get(ue).crossTileID=ve>=0&&ue!==ve?0:_e),de>=0&&(C.text.placedSymbolArray.get(de).crossTileID=ve>=0&&de!==ve?0:_e)}markUsedOrientation(C,H,te){const le=H===Wg.horizontal||H===Wg.horizontalOnly?H:0,ce=H===Wg.vertical?H:0,{leftJustifiedTextSymbolIndex:he,centerJustifiedTextSymbolIndex:ue,rightJustifiedTextSymbolIndex:de,verticalPlacedTextSymbolIndex:_e}=te,ye=C.text.placedSymbolArray;he>=0&&(ye.get(he).placedOrientation=le),ue>=0&&(ye.get(ue).placedOrientation=le),de>=0&&(ye.get(de).placedOrientation=le),_e>=0&&(ye.get(_e).placedOrientation=ce)}commit(C){this.commitTime=C,this.zoomAtLastRecencyCheck=this.transform.zoom;const H=this.prevPlacement;let te=!1;this.prevZoomAdjustment=H?H.zoomAdjustment(this.transform.zoom):0;const le=H?H.symbolFadeChange(C):1,ce=H?H.opacities:{},he=H?H.variableOffsets:{},ue=H?H.placedOrientations:{};for(const C in this.placements){const H=this.placements[C],he=ce[C];he?(this.opacities[C]=new ZT(he,le,H.text,H.icon,null,H.clipped),te=te||H.text!==he.text.placed||H.icon!==he.icon.placed):(this.opacities[C]=new ZT(null,le,H.text,H.icon,H.skipFade,H.clipped),te=te||H.text||H.icon)}for(const C in ce){const H=ce[C];if(!this.opacities[C]){const ce=new ZT(H,le,!1,!1);ce.isHidden()||(this.opacities[C]=ce,te=te||H.text.placed||H.icon.placed)}}for(const C in he)this.variableOffsets[C]||!this.opacities[C]||this.opacities[C].isHidden()||(this.variableOffsets[C]=he[C]);for(const C in ue)this.placedOrientations[C]||!this.opacities[C]||this.opacities[C].isHidden()||(this.placedOrientations[C]=ue[C]);te?this.lastPlacementChangeTime=C:"number"!=typeof this.lastPlacementChangeTime&&(this.lastPlacementChangeTime=H?H.lastPlacementChangeTime:C)}updateLayerOpacities(C,H){const te=new Set;for(const le of H){const H=le.getBucket(C);H&&le.latestFeatureIndex&&C.fqid===H.layerIds[0]&&(this.updateBucketOpacities(H,te,le.collisionBoxArray),H.layers[0].layout.get("symbol-z-elevate")&&this.buildingIndex&&(this.buildingIndex.updateZOffset(H,le.tileID),H.updateZOffset()))}}updateBucketOpacities(C,H,te){C.hasTextData()&&C.text.opacityVertexArray.clear(),C.hasIconData()&&C.icon.opacityVertexArray.clear(),C.hasIconCollisionBoxData()&&C.iconCollisionBox.collisionVertexArray.clear(),C.hasTextCollisionBoxData()&&C.textCollisionBox.collisionVertexArray.clear();const le=C.layers[0].layout,ce=!!C.layers[0].dynamicFilter(),he=new ZT(null,0,!1,!1,!0),ue=le.get("text-allow-overlap"),de=le.get("icon-allow-overlap"),_e=le.get("text-variable-anchor"),ye="map"===le.get("text-rotation-alignment"),ve="map"===le.get("text-pitch-alignment"),Me=new ZT(null,0,ue&&(de||!C.hasIconData()||le.get("icon-optional")),de&&(ue||!C.hasTextData()||le.get("text-optional")),!0);!C.collisionArrays&&te&&(C.hasIconCollisionBoxData()||C.hasTextCollisionBoxData())&&C.deserializeCollisionBoxes(te);const d=(C,H,te)=>{for(let le=0;le<H/4;le++)C.opacityVertexArray.emplaceBack(te)};let Se=0;for(let te=0;te<C.symbolInstances.length;te++){const le=C.symbolInstances.get(te),{numHorizontalGlyphVertices:ue,numVerticalGlyphVertices:de,crossTileID:Ae,numIconVertices:Ce}=le,Oe=H.has(Ae);let je=this.opacities[Ae];Oe?je=he:je||(je=Me,this.opacities[Ae]=je),H.add(Ae);const Ge=ue>0||de>0,Ze=Ce>0,qe=this.placedOrientations[Ae],$e=qe===Wg.vertical,We=qe===Wg.horizontal||qe===Wg.horizontalOnly;if(!Ge&&!Ze||je.isHidden()||Se++,Ge){const H=aE(je.text);d(C.text,ue,$e?xM:H),d(C.text,de,We?xM:H);const te=je.text.isHidden(),{leftJustifiedTextSymbolIndex:ce,centerJustifiedTextSymbolIndex:he,rightJustifiedTextSymbolIndex:_e,verticalPlacedTextSymbolIndex:ye}=le,ve=C.text.placedSymbolArray,Me=te||$e?1:0;ce>=0&&(ve.get(ce).hidden=Me),he>=0&&(ve.get(he).hidden=Me),_e>=0&&(ve.get(_e).hidden=Me),ye>=0&&(ve.get(ye).hidden=te||We?1:0);const Se=this.variableOffsets[Ae];Se&&this.markUsedJustification(C,Se.anchor,le,qe);const Ce=this.placedOrientations[Ae];Ce&&(this.markUsedJustification(C,"left",le,Ce),this.markUsedOrientation(C,Ce,le))}if(Ze){const H=aE(je.icon),{placedIconSymbolIndex:te,verticalPlacedIconSymbolIndex:ce}=le,he=C.icon.placedSymbolArray,ue=je.icon.isHidden()?1:0;te>=0&&(d(C.icon,Ce,$e?xM:H),he.get(te).hidden=ue),ce>=0&&(d(C.icon,le.numVerticalIconVertices,We?xM:H),he.get(ce).hidden=ue)}if(C.hasIconCollisionBoxData()||C.hasTextCollisionBoxData()){const H=C.collisionArrays[te];if(H){let te=new Ne(0,0),he=!0;if(H.textBox||H.verticalTextBox){if(_e){const C=this.variableOffsets[Ae];C?(te=YT(C.anchor,C.width,C.height,C.textOffset,C.textScale),ye&&te._rotate(ve?this.transform.angle:-this.transform.angle)):he=!1}ce&&(he=!je.clipped),H.textBox&&QT(C.textCollisionBox.collisionVertexArray,je.text.placed,!he||$e,te.x,te.y),H.verticalTextBox&&QT(C.textCollisionBox.collisionVertexArray,je.text.placed,!he||We,te.x,te.y)}const ue=he&&Boolean(!We&&H.verticalIconBox);H.iconBox&&QT(C.iconCollisionBox.collisionVertexArray,je.icon.placed,ue,le.hasIconTextFit?te.x:0,le.hasIconTextFit?te.y:0),H.verticalIconBox&&QT(C.iconCollisionBox.collisionVertexArray,je.icon.placed,!ue,le.hasIconTextFit?te.x:0,le.hasIconTextFit?te.y:0)}}}if(C.fullyClipped=0===Se,C.sortFeatures(this.transform.angle),this.retainedQueryData[C.bucketInstanceId]&&(this.retainedQueryData[C.bucketInstanceId].featureSortOrder=C.featureSortOrder),C.hasTextData()&&C.text.opacityVertexBuffer&&C.text.opacityVertexBuffer.updateData(C.text.opacityVertexArray),C.hasIconData()&&C.icon.opacityVertexBuffer&&C.icon.opacityVertexBuffer.updateData(C.icon.opacityVertexArray),C.hasIconCollisionBoxData()&&C.iconCollisionBox.collisionVertexBuffer&&C.iconCollisionBox.collisionVertexBuffer.updateData(C.iconCollisionBox.collisionVertexArray),C.hasTextCollisionBoxData()&&C.textCollisionBox.collisionVertexBuffer&&C.textCollisionBox.collisionVertexBuffer.updateData(C.textCollisionBox.collisionVertexArray),C.bucketInstanceId in this.collisionCircleArrays){const H=this.collisionCircleArrays[C.bucketInstanceId];C.placementInvProjMatrix=H.invProjMatrix,C.placementViewportMatrix=H.viewportMatrix,C.collisionCircleArray=H.circles,delete this.collisionCircleArrays[C.bucketInstanceId]}}symbolFadeChange(C){return 0===this.fadeDuration?1:(C-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(C){return Math.max(0,(this.transform.zoom-C)/1.5)}hasTransitions(C){return this.stale||C-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(C,H){const te=this.zoomAtLastRecencyCheck===H?1-this.zoomAdjustment(H):1;return this.zoomAtLastRecencyCheck=H,this.commitTime+this.fadeDuration*te>C}setStale(){this.stale=!0}}function QT(C,H,te,le,ce){C.emplaceBack(H?1:0,te?1:0,le||0,ce||0),C.emplaceBack(H?1:0,te?1:0,le||0,ce||0),C.emplaceBack(H?1:0,te?1:0,le||0,ce||0),C.emplaceBack(H?1:0,te?1:0,le||0,ce||0)}const RE=Math.pow(2,25),LE=Math.pow(2,24),WE=Math.pow(2,17),XE=Math.pow(2,16),oM=Math.pow(2,9),sM=Math.pow(2,8),cM=Math.pow(2,1);function aE(C){if(0===C.opacity&&!C.placed)return 0;if(1===C.opacity&&C.placed)return 4294967295;const H=C.placed?1:0,te=Math.floor(127*C.opacity);return te*RE+H*LE+te*WE+H*XE+te*oM+H*sM+te*cM+H}const xM=0;class cE{constructor(C){this._sortAcrossTiles="viewport-y"!==C.layout.get("symbol-z-order")&&void 0!==C.layout.get("symbol-sort-key").constantOr(1),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(C,H,te,le,ce){const he=this._bucketParts;for(;this._currentTileIndex<C.length;)if(H.getBucketParts(he,le,C[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,ce())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,he.sort(((C,H)=>C.sortKey-H.sortKey)));this._currentPartIndex<he.length;){const C=he[this._currentPartIndex];if(H.placeLayerBucketPart(C,this._seenCrossTileIDs,te,0===C.symbolInstanceStart),this._currentPartIndex++,ce())return!0}return!1}}class hE{constructor(C,H,te,le,ce,he,ue,de,_e){this.placement=new JT(C,ce,he,ue,de,_e),this._currentPlacementIndex=H.length-1,this._forceFullPlacement=te,this._showCollisionBoxes=le,this._done=!1}isDone(){return this._done}continuePlacement(C,H,te,le){const ce=yi.now(),o=()=>{const C=yi.now()-ce;return!this._forceFullPlacement&&C>2};for(;this._currentPlacementIndex>=0;){const ce=H[C[this._currentPlacementIndex]],he=this.placement.collisionIndex.transform.zoom;if("symbol"===ce.type&&(!ce.minzoom||ce.minzoom<=he)&&(!ce.maxzoom||ce.maxzoom>he)){const C=ce,H=C.layout.get("symbol-z-elevate"),he=this._inProgressLayer=this._inProgressLayer||new cE(C),ue=pa(ce.source,ce.scope);if(he.continuePlacement(H?le[ue]:te[ue],this.placement,this._showCollisionBoxes,ce,o))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(C){return this.placement.commit(C),this.placement}}const EM=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class dE{static from(C){if(!(C instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[H,te]=new Uint8Array(C,0,2);if(219!==H)throw new Error("Data does not appear to be in a KDBush format.");const le=te>>4;if(1!==le)throw new Error(`Got v${le} data when expected v1.`);const ce=EM[15&te];if(!ce)throw new Error("Unrecognized array type.");const[he]=new Uint16Array(C,2,1),[ue]=new Uint32Array(C,4,1);return new dE(ue,he,ce,C)}constructor(C,H=64,te=Float64Array,le){if(isNaN(C)||C<0)throw new Error(`Unpexpected numItems value: ${C}.`);this.numItems=+C,this.nodeSize=Math.min(Math.max(+H,2),65535),this.ArrayType=te,this.IndexArrayType=C<65536?Uint16Array:Uint32Array;const ce=EM.indexOf(this.ArrayType),he=2*C*this.ArrayType.BYTES_PER_ELEMENT,ue=C*this.IndexArrayType.BYTES_PER_ELEMENT,de=(8-ue%8)%8;if(ce<0)throw new Error(`Unexpected typed array class: ${te}.`);le&&le instanceof ArrayBuffer?(this.data=le,this.ids=new this.IndexArrayType(this.data,8,C),this.coords=new this.ArrayType(this.data,8+ue+de,2*C),this._pos=2*C,this._finished=!0):(this.data=new ArrayBuffer(8+he+ue+de),this.ids=new this.IndexArrayType(this.data,8,C),this.coords=new this.ArrayType(this.data,8+ue+de,2*C),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+ce]),new Uint16Array(this.data,2,1)[0]=H,new Uint32Array(this.data,4,1)[0]=C)}add(C,H){const te=this._pos>>1;return this.ids[te]=te,this.coords[this._pos++]=C,this.coords[this._pos++]=H,te}finish(){const C=this._pos>>1;if(C!==this.numItems)throw new Error(`Added ${C} items when expected ${this.numItems}.`);return pE(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(C,H,te,le){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:ce,coords:he,nodeSize:ue}=this,de=[0,ce.length-1,0],_e=[];for(;de.length;){const ye=de.pop()||0,ve=de.pop()||0,Me=de.pop()||0;if(ve-Me<=ue){for(let ue=Me;ue<=ve;ue++){const de=he[2*ue],ye=he[2*ue+1];de>=C&&de<=te&&ye>=H&&ye<=le&&_e.push(ce[ue])}continue}const Se=Me+ve>>1,Ae=he[2*Se],Ce=he[2*Se+1];Ae>=C&&Ae<=te&&Ce>=H&&Ce<=le&&_e.push(ce[Se]),(0===ye?C<=Ae:H<=Ce)&&(de.push(Me),de.push(Se-1),de.push(1-ye)),(0===ye?te>=Ae:le>=Ce)&&(de.push(Se+1),de.push(ve),de.push(1-ye))}return _e}within(C,H,te){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:le,coords:ce,nodeSize:he}=this,ue=[0,le.length-1,0],de=[],_e=te*te;for(;ue.length;){const ye=ue.pop()||0,ve=ue.pop()||0,Me=ue.pop()||0;if(ve-Me<=he){for(let te=Me;te<=ve;te++)gE(ce[2*te],ce[2*te+1],C,H)<=_e&&de.push(le[te]);continue}const Se=Me+ve>>1,Ae=ce[2*Se],Ce=ce[2*Se+1];gE(Ae,Ce,C,H)<=_e&&de.push(le[Se]),(0===ye?C-te<=Ae:H-te<=Ce)&&(ue.push(Me),ue.push(Se-1),ue.push(1-ye)),(0===ye?C+te>=Ae:H+te>=Ce)&&(ue.push(Se+1),ue.push(ve),ue.push(1-ye))}return de}}function pE(C,H,te,le,ce,he){if(ce-le<=te)return;const ue=le+ce>>1;fE(C,H,ue,le,ce,he),pE(C,H,te,le,ue-1,1-he),pE(C,H,te,ue+1,ce,1-he)}function fE(C,H,te,le,ce,he){for(;ce>le;){if(ce-le>600){const ue=ce-le+1,de=te-le+1,_e=Math.log(ue),ye=.5*Math.exp(2*_e/3),ve=.5*Math.sqrt(_e*ye*(ue-ye)/ue)*(de-ue/2<0?-1:1);fE(C,H,te,Math.max(le,Math.floor(te-de*ye/ue+ve)),Math.min(ce,Math.floor(te+(ue-de)*ye/ue+ve)),he)}const ue=H[2*te+he];let de=le,_e=ce;for(mE(C,H,le,te),H[2*ce+he]>ue&&mE(C,H,le,ce);de<_e;){for(mE(C,H,de,_e),de++,_e--;H[2*de+he]<ue;)de++;for(;H[2*_e+he]>ue;)_e--}H[2*le+he]===ue?mE(C,H,le,_e):(_e++,mE(C,H,_e,ce)),_e<=te&&(le=_e+1),te<=_e&&(ce=_e-1)}}function mE(C,H,te,le){_E(C,te,le),_E(H,2*te,2*le),_E(H,2*te+1,2*le+1)}function _E(C,H,te){const le=C[H];C[H]=C[te],C[te]=le}function gE(C,H,te,le){const ce=C-te,he=H-le;return ce*ce+he*he}const zM=512/wn/2;class xE{constructor(C,H,te){this.tileID=C,this.bucketInstanceId=te,this.index=new dE(H.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const le=C.canonical.x*wn,ce=C.canonical.y*wn;for(let C=0;C<H.length;C++){const{key:te,crossTileID:he,tileAnchorX:ue,tileAnchorY:de}=H.get(C),_e=Math.floor((le+ue)*zM),ye=Math.floor((ce+de)*zM);this.index.add(_e,ye),this.keys.push(te),this.crossTileIDs.push(he)}this.index.finish()}findMatches(C,H,te){const le=this.tileID.canonical.z<H.canonical.z?1:Math.pow(2,this.tileID.canonical.z-H.canonical.z),ce=zM/Math.pow(2,H.canonical.z-this.tileID.canonical.z),he=H.canonical.x*wn,ue=H.canonical.y*wn;for(let H=0;H<C.length;H++){const de=C.get(H);if(de.crossTileID)continue;const{key:_e,tileAnchorX:ye,tileAnchorY:ve}=de,Me=Math.floor((he+ye)*ce),Se=Math.floor((ue+ve)*ce),Ae=this.index.range(Me-le,Se-le,Me+le,Se+le);for(const C of Ae){const H=this.crossTileIDs[C];if(this.keys[C]===_e&&!te.has(H)){te.add(H),de.crossTileID=H;break}}}}}class vE{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class bE{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(C){const H=Math.round((C-this.lng)/360);if(0!==H)for(const C in this.indexes){const te=this.indexes[C],le={};for(const C in te){const ce=te[C];ce.tileID=ce.tileID.unwrapTo(ce.tileID.wrap+H),le[ce.tileID.key]=ce}this.indexes[C]=le}this.lng=C}addBucket(C,H,te){if(this.indexes[C.overscaledZ]&&this.indexes[C.overscaledZ][C.key]){if(this.indexes[C.overscaledZ][C.key].bucketInstanceId===H.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(C.overscaledZ,this.indexes[C.overscaledZ][C.key])}for(let C=0;C<H.symbolInstances.length;C++)H.symbolInstances.get(C).crossTileID=0;this.usedCrossTileIDs[C.overscaledZ]||(this.usedCrossTileIDs[C.overscaledZ]=new Set);const le=this.usedCrossTileIDs[C.overscaledZ];for(const te in this.indexes){const ce=this.indexes[te];if(Number(te)>C.overscaledZ)for(const te in ce){const he=ce[te];he.tileID.isChildOf(C)&&he.findMatches(H.symbolInstances,C,le)}else{const he=ce[C.scaledTo(Number(te)).key];he&&he.findMatches(H.symbolInstances,C,le)}}for(let C=0;C<H.symbolInstances.length;C++){const ce=H.symbolInstances.get(C);ce.crossTileID||(ce.crossTileID=te.generate(),le.add(ce.crossTileID))}return void 0===this.indexes[C.overscaledZ]&&(this.indexes[C.overscaledZ]={}),this.indexes[C.overscaledZ][C.key]=new xE(C,H.symbolInstances,H.bucketInstanceId),!0}removeBucketCrossTileIDs(C,H){for(const te of H.crossTileIDs)this.usedCrossTileIDs[C].delete(te)}removeStaleBuckets(C){let H=!1;for(const te in this.indexes){const le=this.indexes[te];for(const ce in le)C[le[ce].bucketInstanceId]||(this.removeBucketCrossTileIDs(te,le[ce]),delete le[ce],H=!0)}return H}}class wE{constructor(){this.layerIndexes={},this.crossTileIDs=new vE,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(C,H,te,le){let ce=this.layerIndexes[C.fqid];void 0===ce&&(ce=this.layerIndexes[C.fqid]=new bE);let he=!1;const ue={};"globe"!==le.name&&ce.handleWrapJump(te);for(const te of H){const H=te.getBucket(C);H&&C.fqid===H.layerIds[0]&&(H.bucketInstanceId||(H.bucketInstanceId=++this.maxBucketInstanceId),ce.addBucket(te.tileID,H,this.crossTileIDs)&&(he=!0),ue[H.bucketInstanceId]=!0)}return ce.removeStaleBuckets(ue)&&(he=!0),he}pruneUnusedLayers(C){const H={};C.forEach((C=>{H[C]=!0}));for(const C in this.layerIndexes)H[C]||delete this.layerIndexes[C]}}var PM="\n#define EPSILON 0.0000001\n#define PI 3.141592653589793\n#define EXTENT 8192.0\n#define HALF_PI PI/2.0\n#define QUARTER_PI PI/4.0\n#define RAD_TO_DEG 180.0/PI\n#define DEG_TO_RAD PI/180.0\n#define GLOBE_RADIUS EXTENT/PI/2.0\nvec3 linearTosRGB(vec3 color)\n{return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn)\n{return pow(srgbIn,vec3(2.2));}vec3 linearProduct(vec3 srgbIn,vec3 k)\n{return srgbIn*pow(k,vec3(1./2.2));}\n#if __VERSION__ >=300\n#define _HANDLE_WIREFRAME_DEPTH gl_FragDepth=gl_FragCoord.z-0.0001;\n#else\n#define _HANDLE_WIREFRAME_DEPTH\n#endif\n#ifdef DEBUG_WIREFRAME\n#define HANDLE_WIREFRAME_DEBUG \\\ngl_FragColor=vec4(0.7,0.0,0.0,0.7); \\\n_HANDLE_WIREFRAME_DEPTH;\n#else\n#define HANDLE_WIREFRAME_DEBUG\n#endif\n#ifdef RENDER_CUTOFF\nfloat cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w-0.0001;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}\n#endif",kM="attribute highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;varying highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",LM="\n#define ELEVATION_SCALE 7.0\n#define ELEVATION_OFFSET 450.0\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(\nmix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}\n#else\nvec3 elevationVector(vec2 pos) { return vec3(0,0,1); }\n#endif\nconst float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)\n{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}\n#ifdef TERRAIN\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nuniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;\n#else\nuniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;\n#endif\nuniform vec4 u_dem_unpack;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;uniform sampler2D u_depth;uniform vec2 u_depth_size_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float decodeElevation(vec4 v) {return dot(vec4(v.xyz*255.0,-1.0),u_dem_unpack);}float currentElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=decodeElevation(texture2D(u_dem,pos));float tr=decodeElevation(texture2D(u_dem,pos+vec2(dd,0.0)));float bl=decodeElevation(texture2D(u_dem,pos+vec2(0.0,dd)));float br=decodeElevation(texture2D(u_dem,pos+vec2(dd,dd)));return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}float prevElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=decodeElevation(texture2D(u_dem_prev,pos));float tr=decodeElevation(texture2D(u_dem_prev,pos+vec2(dd,0.0)));float bl=decodeElevation(texture2D(u_dem_prev,pos+vec2(0.0,dd)));float br=decodeElevation(texture2D(u_dem_prev,pos+vec2(dd,dd)));return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}\n#ifdef TERRAIN_VERTEX_MORPHING\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nfloat nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}\n#else\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nreturn currentElevation(apos);}\n#endif\nhighp float unpack_depth(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;float depth=unpack_depth(texture2D(u_depth,(coord.xy+1.0)*0.5));return coord.z > depth+0.0005;}float occlusionFade(vec4 frag) {vec3 coord=frag.xyz/frag.w;vec3 df=vec3(5.0*u_depth_size_inv,0.0);vec2 uv=0.5*coord.xy+0.5;vec4 depth=vec4(\nunpack_depth(texture2D(u_depth,uv-df.xz)),unpack_depth(texture2D(u_depth,uv+df.xz)),unpack_depth(texture2D(u_depth,uv-df.zy)),unpack_depth(texture2D(u_depth,uv+df.zy))\n);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z-0.001)-depth),0.0,1.0));}vec4 fourSample(vec2 pos,vec2 off) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nfloat tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;\n#else\nvec4 demtl=vec4(texture2D(u_dem,pos).xyz*255.0,-1.0);float tl=dot(demtl,u_dem_unpack);vec4 demtr=vec4(texture2D(u_dem,pos+vec2(off.x,0.0)).xyz*255.0,-1.0);float tr=dot(demtr,u_dem_unpack);vec4 dembl=vec4(texture2D(u_dem,pos+vec2(0.0,off.y)).xyz*255.0,-1.0);float bl=dot(dembl,u_dem_unpack);vec4 dembr=vec4(texture2D(u_dem,pos+off).xyz*255.0,-1.0);float br=dot(dembr,u_dem_unpack);\n#endif\nreturn vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}\n#else\nfloat elevation(vec2 pos) { return 0.0; }bool isOccluded(vec4 frag) { return false; }float occlusionFade(vec4 frag) { return 1.0; }\n#endif",BM="#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;varying vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}\n#endif",WM="#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;varying vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,opacity);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {\n#ifdef FOG_DITHERING\nvec2 dither_seed=gl_FragCoord.xy+u_fog_temporal_offset;return dither(color,dither_seed);\n#else\nreturn color;\n#endif\n}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}\n#endif",HM="#ifdef RENDER_SHADOWS\nuniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}\n#endif//RENDER_SHADOWS",XM="#ifdef RENDER_SHADOWS\n#if defined(NATIVE) && __VERSION__ >=300\n#define TEXTURE_GATHER\n#endif\n#ifdef DEPTH_TEXTURE\nuniform highp sampler2D u_shadowmap_0;uniform highp sampler2D u_shadowmap_1;\n#else\nuniform sampler2D u_shadowmap_0;uniform sampler2D u_shadowmap_1;\n#endif\nuniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;highp float shadow_sample_1(highp vec2 uv,highp float compare) {highp float shadow_depth;\n#ifdef DEPTH_TEXTURE\nshadow_depth=texture2D(u_shadowmap_1,uv).r;\n#else\nshadow_depth=unpack_depth(texture2D(u_shadowmap_1,uv))*0.5+0.5;\n#endif\nreturn step(shadow_depth,compare);}highp float shadow_sample_0(highp vec2 uv,highp float compare) {highp float shadow_depth;\n#ifdef DEPTH_TEXTURE\nshadow_depth=texture2D(u_shadowmap_0,uv).r;\n#else\nshadow_depth=unpack_depth(texture2D(u_shadowmap_0,uv))*0.5+0.5;\n#endif\nreturn step(shadow_depth,compare);}float shadow_occlusion_1(highp vec4 pos,highp float bias) {highp vec2 uv=pos.xy;return shadow_sample_1(uv,pos.z-bias);}float shadow_occlusion_0(highp vec4 pos,highp float bias) {highp float compare0=pos.z-bias;\n#ifdef TEXTURE_GATHER\nhighp vec2 uv=pos.xy;highp vec4 samples=textureGather(u_shadowmap_0,uv,0);lowp vec4 stepSamples=step(samples,vec4(compare0));\n#else\nhighp vec2 uv00=pos.xy-vec2(0.5*u_shadow_texel_size);highp vec2 uv10=uv00+vec2(u_shadow_texel_size,0.0);highp vec2 uv01=uv00+vec2(0.0,u_shadow_texel_size);highp vec2 uv11=uv01+vec2(u_shadow_texel_size,0.0);lowp vec4 stepSamples=vec4(\nshadow_sample_0(uv01,compare0),shadow_sample_0(uv11,compare0),shadow_sample_0(uv10,compare0),shadow_sample_0(uv00,compare0)\n);\n#endif\nvec2 f=fract(pos.xy*u_shadow_map_resolution-vec2(0.5));lowp vec2 lerpx=mix(stepSamples.wx,stepSamples.zy,f.xx);return mix(lerpx.x,lerpx.y,f.y);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {\n#ifdef SHADOWS_SINGLE_CASCADE\nlight_view_pos0.xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);\n#else\nlight_view_pos0.xyz/=light_view_pos0.w;light_view_pos1.xyz/=light_view_pos1.w;vec4 uv=vec4(light_view_pos0.xy,light_view_pos1.xy);vec4 abs_bounds=abs(uv);if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}light_view_pos1.xyz=light_view_pos1.xyz*0.5+0.5;float occlusion1=shadow_occlusion_1(light_view_pos1,bias);return mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth));\n#endif\n}highp float calculate_shadow_bias(float NDotL) {\n#ifdef NORMAL_OFFSET\nreturn 0.5*u_shadow_bias.x;\n#else\nreturn 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));\n#endif\n}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}\n#endif";const KM=[];OE(PM,KM);const JM={"_prelude_fog.vertex.glsl":BM,"_prelude_terrain.vertex.glsl":LM,"_prelude_shadow.vertex.glsl":HM,"_prelude_fog.fragment.glsl":WM,"_prelude_shadow.fragment.glsl":XM,"_prelude_lighting.glsl":"\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}\n#endif//LIGHTING_3D_MODE"},QM={};BE("",LM),BE(WM,BM),BE(XM,HM);const eS=BE("\n#if __VERSION__ >=300\n#define varying in\n#define gl_FragColor glFragColor\n#define texture2D texture\n#define textureCube texture\nout vec4 glFragColor;\n#endif\nhighp vec3 hash(highp vec2 p) {highp vec3 p3=fract(p.xyx*vec3(443.8975,397.2973,491.1871));p3+=dot(p3,p3.yxz+19.19);return fract((p3.xxy+p3.yzz)*p3.zyx);}vec3 dither(vec3 color,highp vec2 seed) {vec3 rnd=hash(seed)+hash(seed+0.59374)-0.5;return color+rnd/255.0;}highp float unpack_depth(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}\n#ifdef INDICATOR_CUTOUT\nuniform vec2 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;\n#endif\nvec4 applyCutout(vec4 color) {\n#ifdef INDICATOR_CUTOUT\nfloat holeMinOpacity=u_indicator_cutout_params.x;float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);\n#else\nreturn color;\n#endif\n}\n#ifdef RENDER_CUTOFF\nuniform highp vec4 u_cutoff_params;varying float v_cutoff_opacity;\n#endif","\n#if __VERSION__ >=300\n#define attribute in\n#define varying out\n#define texture2D texture\n#endif\nfloat wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {\n#ifndef PROJECTED_POS_ON_VIEWPORT\nfloat tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;\n#else\nreturn vec3(0.0);\n#endif\n}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}\n#endif\nvec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(\nunpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0\n);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}\n#ifdef RENDER_CUTOFF\nuniform vec4 u_cutoff_params;varying float v_cutoff_opacity;\n#endif\nconst vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);//Normalized device coordinate that is not rendered."),fS=PM;var IS={background:BE('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec4 u_color;uniform float u_opacity;\n#ifdef LIGHTING_3D_MODE\nvarying vec4 v_color;\n#endif\nvoid main() {vec4 out_color;\n#ifdef LIGHTING_3D_MODE\nout_color=v_color;\n#else\nout_color=u_color;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\ngl_FragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_lighting.glsl"\nattribute vec2 a_pos;uniform mat4 u_matrix;\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec4 u_color;varying vec4 v_color;uniform float u_emissive_strength;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0,1);\n#ifdef LIGHTING_3D_MODE\nv_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),backgroundPattern:BE('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;varying vec2 v_pos;void main() {vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=texture2D(u_image,pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\ngl_FragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;attribute vec2 a_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_tile_units_to_pixels,a_pos);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),circle:BE('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nvarying vec3 v_data;varying float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nuniform float u_emissive_strength;void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=v_data.xy;float extrude_length=length(extrude);lowp float antialiasblur=v_data.z;float antialiased_blur=-max(blur,antialiasblur);float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(\nantialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)\n);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_apply_premultiplied(out_color,v_fog_pos);\n#endif\ngl_FragColor=out_color*(v_visibility*opacity_t);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define NUM_VISIBILITY_RINGS 2\n#define INV_SQRT2 0.70710678\n#define ELEVATION_BIAS 0.0001\n#define NUM_SAMPLES_PER_RING 16\nuniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;attribute vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\nvarying vec3 v_data;varying float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nvec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {\n#if defined(TERRAIN)\nreturn elevation(pos)+ELEVATION_BIAS;\n#else\nreturn 0.0;\n#endif\n}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);\n#ifdef PITCH_WITH_MAP\n#ifdef PROJECTION_GLOBE_VIEW\nreturn u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );\n#else\nreturn u_matrix*( world_center+vec4(sample_offset,0,0) );\n#endif\n#else\nreturn projected_center+vec4(sample_offset,0,0);\n#endif\n}float get_sample_step() {\n#ifdef PITCH_WITH_MAP\nreturn 2.0*PI/float(NUM_SAMPLES_PER_RING);\n#else\nreturn PI/float(NUM_SAMPLES_PER_RING);\n#endif\n}void main(void) {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);\n#else \nsurface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);\n#endif\nvec4 projected_center=u_matrix*world_center;float view_scale=0.0;\n#ifdef PITCH_WITH_MAP\n#ifdef SCALE_WITH_MAP\nview_scale=1.0;\n#else\nview_scale=projected_center.w/u_camera_to_center_distance;\n#endif\n#else\n#ifdef SCALE_WITH_MAP\nview_scale=u_camera_to_center_distance;\n#else\nview_scale=projected_center.w;\n#endif\n#endif\ngl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;\n#ifdef TERRAIN\nfloat step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;\n#ifdef PITCH_WITH_MAP\nfloat cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;\n#else\nocclusion_world_center=world_center;occlusion_projected_center=projected_center;\n#endif\nfor(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);\n#else\nvisibility=1.0;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nvisibility=1.0;\n#endif\nv_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);\n#ifdef FOG\nv_fog_pos=fog_position(world_center.xyz);\n#endif\n}'),clippingMask:BE("void main() {gl_FragColor=vec4(1.0);}","attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:BE('#include "_prelude_fog.fragment.glsl"\nuniform highp float u_intensity;varying vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#define GAUSS_COEF 0.3989422804014327\nvoid main() {\n#pragma mapbox: initialize highp float weight\nfloat d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);gl_FragColor=vec4(val,1.0,1.0,1.0);\n#ifdef FOG\nif (u_is_globe==0) {gl_FragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}\n#endif\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;attribute vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\nvarying vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#pragma mapbox: define mediump float radius\nconst highp float ZERO=1.0/255.0/16.0;\n#define GAUSS_COEF 0.3989422804014327\nvoid main(void) {\n#pragma mapbox: initialize highp float weight\n#pragma mapbox: initialize mediump float radius\nvec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#else\npos=vec3(tilePos+extrude,elevation(tilePos));\n#endif\ngl_Position=u_matrix*vec4(pos,1);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),heatmapTexture:BE("uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;varying vec2 v_pos;void main() {float t=texture2D(u_image,v_pos).r;vec4 color=texture2D(u_color_ramp,vec2(t,0.5));gl_FragColor=color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(0.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}","attribute vec2 a_pos;varying vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:BE("varying float v_placed;varying float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);gl_FragColor =mix(red,blue,step(0.5,v_placed))*0.5;gl_FragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",'#include "_prelude_terrain.vertex.glsl"\nattribute vec3 a_pos;attribute vec2 a_anchor_pos;attribute vec2 a_extrude;attribute vec2 a_placed;attribute vec2 a_shift;attribute float a_size_scale;attribute vec2 a_padding;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;varying float v_placed;varying float v_notUsed;void main() {vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*elevation(a_anchor_pos),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}'),collisionCircle:BE("varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);gl_FragColor=color*alpha*opacity_t;}","attribute vec2 a_pos_2f;attribute float a_radius;attribute vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(\nmix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),debug:BE("uniform highp vec4 u_color;uniform sampler2D u_overlay;varying vec2 v_uv;void main() {vec4 overlay_color=texture2D(u_overlay,v_uv);gl_FragColor=mix(u_color,overlay_color,overlay_color.a);}",'#include "_prelude_terrain.vertex.glsl"\nattribute vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_pos_3;\n#endif\nvarying vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\ngl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);\n#else\ngl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);\n#endif\n}'),fill:BE('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nuniform float u_emissive_strength;void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\nvec4 out_color=color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\ngl_FragColor=out_color*opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nattribute vec2 a_pos;uniform mat4 u_matrix;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\ngl_Position=u_matrix*vec4(a_pos,0,1);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillOutline:BE('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nvarying vec2 v_pos;uniform float u_emissive_strength;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\ngl_FragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nattribute vec2 a_pos;uniform mat4 u_matrix;uniform vec2 u_world;varying vec2 v_pos;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\ngl_Position=u_matrix*vec4(a_pos,0,1);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillOutlinePattern:BE('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_emissive_strength;varying vec2 v_pos;varying vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=texture2D(u_image,pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\ngl_FragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;attribute vec2 a_pos;varying vec2 v_pos;varying vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;gl_Position=u_matrix*vec4(a_pos,0,1);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillPattern:BE('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;varying vec2 v_pos;uniform float u_emissive_strength;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec4 out_color=texture2D(u_image,pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\ngl_FragColor=out_color*opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;attribute vec2 a_pos;varying vec2 v_pos;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillExtrusion:BE('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nvarying vec4 v_color;\n#ifdef RENDER_SHADOWS\nvarying highp vec4 v_pos_light_view_0;varying highp vec4 v_pos_light_view_1;varying float v_depth;\n#endif\nuniform lowp float u_opacity;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;varying vec2 v_ao;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nvarying vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nvarying highp vec3 v_normal;\n#endif\nuniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nvarying float v_flood_radius;varying float v_has_floodlight;\n#endif\nvarying float v_height;void main() {\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nvec3 normal=normalize(v_normal);\n#endif\nfloat z;vec4 color=v_color;\n#ifdef ZERO_ROOF_RADIUS\nz=float(normal.z > 0.00001);\n#ifdef LIGHTING_3D_MODE\nnormal=mix(normal,vec3(0.0,0.0,1.0),z);\n#else\ncolor=mix(v_color,v_roof_color,z);\n#endif\n#endif\nfloat h=max(0.0,v_height);float ao_shade=1.0;\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;\n#ifdef ZERO_ROOF_RADIUS\nconcave*=(1.0-z);\n#endif\nfloat x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\ncolor.rgb*=mix(ao_shade,1.0,v_has_floodlight);\n#else\ncolor.rgb*=ao_shade;\n#endif\n#else\ncolor.rgb*=ao_shade;\n#endif\n#endif\n#ifdef LIGHTING_3D_MODE\nfloat flood_radiance=0.0;\n#ifdef FLOOD_LIGHT\nflood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;\n#endif\n#ifdef RENDER_SHADOWS\n#ifdef FLOOD_LIGHT\nfloat ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,v_depth);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);\n#else\nfloat shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);\n#endif\n#else\ncolor.rgb=apply_lighting(color.rgb,normal);\n#ifdef FLOOD_LIGHT\ncolor.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);\n#endif\n#endif\ncolor*=u_opacity;\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));\n#endif\n#ifdef RENDER_CUTOFF\ncolor*=v_cutoff_opacity;\n#endif\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color);\n#endif\ngl_FragColor=color;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_lighting.glsl"\n#if __VERSION__ >=300\n#ifdef RENDER_CUTOFF\ninvariant gl_Position;\n#endif\n#endif\nuniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;attribute vec4 a_pos_normal_ed;attribute vec2 a_centroid_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\nuniform highp float u_vertical_scale;varying vec4 v_color;\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;varying highp vec4 v_pos_light_view_0;varying highp vec4 v_pos_light_view_1;varying float v_depth;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nvarying vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nvarying highp vec3 v_normal;\n#endif\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;varying vec2 v_ao;\n#endif\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nvarying float v_flood_radius;varying float v_has_floodlight;\n#endif\nvarying float v_height;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define highp float flood_light_wall_radius\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize highp float flood_light_wall_radius\nbase*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nv_normal=normal;\n#endif\nbase=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=0.0;float c_ele;vec3 pos;\n#ifdef TERRAIN\nbool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);pos=vec3(pos_nx.xy,h);\n#else\nh=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\nfloat hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);h=h-ele;v_height=h;\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=pos;vec3 shd_pos1=pos;\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\nfloat NdotL=0.0;float colorvalue=0.0;\n#ifndef LIGHTING_3D_MODE\ncolorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#endif\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\nfloat is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;\n#endif\nv_color=vec4(color.rgb,1.0);\n#else\nv_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nfloat roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n}'),fillExtrusionDepth:BE("varying highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\ngl_FragColor=pack_depth(v_depth);\n#endif\n}",'#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_vertical_scale;attribute vec4 a_pos_normal_ed;attribute vec2 a_centroid_pos;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\nvarying highp float v_depth;void main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\nbase*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nvec3 pos;\n#ifdef TERRAIN\nbool flat_roof=centroid_pos.x !=0.0 && t > 0.0;float ele=elevation(pos_nx.xy);float c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;float h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base);pos=vec3(pos_nx.xy,h);\n#else\npos=vec3(pos_nx.xy,t > 0.0 ? height : base);\n#endif\nfloat hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}'),fillExtrusionPattern:BE('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;varying vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nvarying vec3 v_normal;\n#endif\nvarying vec2 v_pos;varying vec4 v_lighting;uniform lowp float u_opacity;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define highp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize highp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec4 out_color=texture2D(u_image,pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;\n#else\nout_color=out_color*v_lighting;\n#endif\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color);\n#endif\ngl_FragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_lighting.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;attribute vec4 a_pos_normal_ed;attribute vec2 a_centroid_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\nvarying vec2 v_pos;varying vec4 v_lighting;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;varying vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nvarying vec3 v_normal;\n#endif\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define highp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize highp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=z;vec3 p;float c_ele;\n#ifdef TERRAIN\nbool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);p=vec3(pos_nx.xy,h);\n#else\np=vec3(pos_nx.xy,z);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\nfloat hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0\n? pos_nx.xy\n: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;\n#ifdef LIGHTING_3D_MODE\nNdotL=calculate_NdotL(normal);\n#else\nNdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);\n#endif\nif (normal.y !=0.0) {float r=0.84;\n#ifndef LIGHTING_3D_MODE\nr=mix(0.7,0.98,1.0-u_lightintensity);\n#endif\nNdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\nv_normal=normal;\n#else\nv_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;\n#endif \n#ifdef FOG\nv_fog_pos=fog_position(p);\n#endif\n}'),groundShadow:BE('#include "_prelude_shadow.fragment.glsl"\n#ifdef GL_ES\nprecision highp float;\n#endif\nuniform vec3 u_ground_shadow_factor;varying vec4 v_pos_light_view_0;varying vec4 v_pos_light_view_1;varying float v_depth;\n#ifdef FOG\nvarying float v_fog_opacity;\n#endif\nvoid main() {float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);\n#ifdef RENDER_CUTOFF\nshadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,v_depth));\n#endif\n#ifdef FOG\nshadow=mix(shadow,vec3(1.0),v_fog_opacity);\n#endif\n#ifdef INDICATOR_CUTOUT\nshadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0)).r);\n#endif\ngl_FragColor=vec4(shadow,1.0);}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;attribute vec2 a_pos;varying vec4 v_pos_light_view_0;varying vec4 v_pos_light_view_1;varying float v_depth;\n#ifdef FOG\nvarying float v_fog_opacity;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);v_depth=gl_Position.w;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);\n#endif\n}'),fillExtrusionGroundEffect:BE("uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;\n#ifdef SDF_SUBPASS\nvarying highp vec2 v_pos;varying highp vec4 v_line_segment;varying highp float v_flood_light_radius_tile;varying highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}\n#ifdef FOG\nvarying highp float v_fog;\n#endif\n#endif\nvoid main() {\n#ifdef CLEAR_SUBPASS\nvec4 color=vec4(1.0);\n#ifdef CLEAR_FROM_TEXTURE\ncolor=texture2D(u_fb,gl_FragCoord.xy/vec2(u_fb_size));\n#endif\ngl_FragColor=color;\n#else\n#ifdef SDF_SUBPASS\nhighp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;\n#ifdef FOG\nfog=v_fog;\n#endif\n#ifdef RENDER_CUTOFF\nfog*=v_cutoff_opacity;\n#endif\ngl_FragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));\n#else\nvec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);\n#ifdef OVERDRAW_INSPECTOR\ncolor=vec4(1.0);\n#endif\ngl_FragColor=color;HANDLE_WIREFRAME_DEBUG;\n#endif\n#endif\n}",'#include "_prelude_fog.vertex.glsl"\nattribute highp vec4 a_pos_end;attribute highp float a_angular_offset_factor;attribute highp float a_hidden_by_landmark;\n#ifdef SDF_SUBPASS\nvarying highp vec2 v_pos;varying highp vec4 v_line_segment;varying highp float v_flood_light_radius_tile;varying highp vec2 v_ao;\n#ifdef FOG\nvarying highp float v_fog;\n#endif\n#endif\nuniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp vec2 u_ao;\n#pragma mapbox: define highp float flood_light_ground_radius\nconst float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {\n#pragma mapbox: initialize highp float flood_light_ground_radius\nvec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;\n#ifdef FORCE_ABS_FL_GROUND_RADIUS\nfl_ground_radius=abs(flood_light_ground_radius);\n#endif\nfloat flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(1.0,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;\n#ifdef SDF_SUBPASS\nv_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);\n#ifdef FOG\nv_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);\n#endif\n#endif\nfloat hidden_by_landmark=0.0;\n#ifdef HAS_CENTROID\nhidden_by_landmark=a_hidden_by_landmark;\n#endif\nfloat isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n}'),hillshadePrepare:BE("#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;uniform vec4 u_unpack;float getElevation(vec2 coord) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nreturn texture(u_image,coord).r/4.0;\n#else\nvec4 data=texture2D(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack)/4.0;\n#endif\n}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(\n(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)\n)/pow(2.0,exaggeration+(19.2562-u_zoom));gl_FragColor=clamp(vec4(\nderiv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}","uniform mat4 u_matrix;uniform vec2 u_dimension;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:BE('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture2D(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);gl_FragColor=accent_color*(1.0-shade_color.a)+shade_color;\n#ifdef LIGHTING_3D_MODE\ngl_FragColor=apply_lighting_with_emission_ground(gl_FragColor,u_emissive_strength);\n#endif\n#ifdef FOG\ngl_FragColor=fog_dither(fog_apply_premultiplied(gl_FragColor,v_fog_pos));\n#endif\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),line:BE('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform lowp float u_device_pixel_ratio;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;varying highp vec4 v_uv;\n#ifdef RENDER_LINE_DASH\nuniform sampler2D u_dash_image;varying vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform sampler2D u_gradient_image;\n#endif\nfloat luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nfloat linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);\n#ifdef RENDER_LINE_DASH\nfloat sdfdist=texture2D(u_dash_image,v_tex).a;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;alpha*=linearstep(0.5-sdfgamma/floorwidth,0.5+sdfgamma/floorwidth,sdfdist);\n#endif\nhighp vec4 out_color;\n#ifdef RENDER_LINE_GRADIENT\nout_color=texture2D(u_gradient_image,v_uv.xy);\n#else\nout_color=color;\n#endif\nfloat trimmed=1.0;\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float start=v_uv[2];highp float end=v_uv[3];highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=(start+(v_uv.x)*(end-start));if (trim_end > trim_start) {if (line_progress <=trim_end && line_progress >=trim_start) {out_color=vec4(0,0,0,0);trimmed=0.0;}}\n#endif\nif (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}\n#ifdef RENDER_LINE_BORDER\nfloat edgeBlur=(border_width+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {    \nfloat Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color.rgb=mix(border_color.rgb*border_color.a*trimmed,out_color.rgb,smoothAlpha);}}\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nout_color*=(alpha*opacity);\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color);\n#endif\ngl_FragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#define EXTRUDE_SCALE 0.015873016\nattribute vec2 a_pos_normal;attribute vec4 a_data;\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nattribute highp vec4 a_packed;\n#endif\n#ifdef RENDER_LINE_DASH\nattribute float a_linesofar;\n#endif\nuniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;varying highp vec4 v_uv;\n#ifdef RENDER_LINE_DASH\nuniform vec2 u_texsize;uniform float u_tile_units_to_pixels;varying vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform float u_image_height;\n#endif\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#else\nv_gamma_scale=1.0;\n#endif\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nfloat a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float a_clip_start=a_packed[2];highp float a_clip_end=a_packed[3];\n#ifdef RENDER_LINE_GRADIENT\nhighp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec4(a_uv_x,a_split_index*texel_height-half_texel_height,a_clip_start,a_clip_end);\n#else\nv_uv=vec4(a_uv_x,0.0,a_clip_start,a_clip_end);\n#endif\n#endif\n#ifdef RENDER_LINE_DASH\nfloat scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/floorwidth,(-normal.y*height+dash.x+0.5)/u_texsize.y);\n#endif\nv_width2=vec2(outset,inset);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),linePattern:BE('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;uniform sampler2D u_image;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;vec2 pattern_size=vec2(display_size.x/u_tile_units_to_pixels,display_size.y);float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x=mod(v_linesofar/pattern_size.x*aspect,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));vec4 color=texture2D(u_image,pos);\n#ifdef LIGHTING_3D_MODE\ncolor=apply_lighting_ground(color);\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ncolor*=(alpha*opacity);\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color);\n#endif\ngl_FragColor=color;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#define scale 0.015873016\nattribute vec2 a_pos_normal;attribute vec4 a_data;attribute float a_linesofar;uniform mat4 u_matrix;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#else\nv_gamma_scale=1.0;\n#endif\nv_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),raster:BE('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform float u_fade_t;uniform float u_opacity;uniform sampler2D u_image0;uniform sampler2D u_image1;varying vec2 v_pos0;varying vec2 v_pos1;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;\n#ifdef RASTER_COLOR\nuniform sampler2D u_color_ramp;uniform highp vec2 u_colorization_scale;uniform highp vec4 u_colorization_mix;highp vec4 colormap (highp float value) {highp float scaled_value=value*u_colorization_scale.y+u_colorization_scale.x;highp vec2 coords=vec2(scaled_value,0.5);return texture2D(u_color_ramp,coords);}\n#endif\nvoid main() {vec4 color0=texture2D(u_image0,v_pos0);vec4 color1=texture2D(u_image1,v_pos1);vec4 color;\n#ifdef RASTER_COLOR\nhighp vec4 fadedColor=mix(color0,color1,u_fade_t);color=colormap(dot(vec4(fadedColor.rgb,1),u_colorization_mix));color.a*=fadedColor.a;if (color.a > 0.0) {color.rgb/=color.a;}\n#else\nif (color0.a > 0.0) {color0.rgb/=color0.a;}if (color1.a > 0.0) {color1.rgb/=color1.a;}color=mix(color0,color1,u_fade_t);\n#endif\ncolor.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(\ndot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_ground(out_color);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply(out_color,v_fog_pos));\n#endif\ngl_FragColor=vec4(out_color*color.a,color.a);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_globe_pos;attribute vec2 a_uv;\n#else\nattribute vec2 a_pos;attribute vec2 a_texture_pos;\n#endif\nvarying vec2 v_pos0;varying vec2 v_pos1;void main() {vec2 uv;\n#ifdef PROJECTION_GLOBE_VIEW\ngl_Position=u_matrix*u_globe_matrix*vec4(a_globe_pos,1.0);uv=a_uv;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);\n#endif\n#else\nfloat w=1.0+dot(a_texture_pos,u_perspective_transform);gl_Position=u_matrix*vec4(a_pos*w,0,w);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\nuv=a_texture_pos/8192.0;\n#endif\nv_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}'),symbolIcon:BE('#include "_prelude_lighting.glsl"\nuniform sampler2D u_texture;\n#ifdef ICON_TRANSITION\nuniform float u_icon_transition;\n#endif\nvarying float v_fade_opacity;varying vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nvarying vec2 v_tex_b;\n#endif\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float emissive_strength\nlowp float alpha=opacity*v_fade_opacity;vec4 out_color;\n#ifdef ICON_TRANSITION\nvec4 a=texture2D(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture2D(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b)*alpha;\n#else\nout_color=texture2D(u_texture,v_tex_a)*alpha;\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,emissive_strength);\n#endif\ngl_FragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\nattribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_pixeloffset;attribute vec4 a_projected_pos;attribute float a_fade_opacity;\n#ifdef Z_OFFSET\nattribute float a_z_offset;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_globe_anchor;attribute vec3 a_globe_normal;\n#endif\n#ifdef ICON_TRANSITION\nattribute vec2 a_texb;\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;uniform vec3 u_up_vector;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\nvarying vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nvarying vec2 v_tex_b;\n#endif\nvarying float v_fade_opacity;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float emissive_strength\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);\n#ifdef Z_OFFSET\ne+=a_z_offset;\n#endif\nvec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjected_point;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetProjected_point=u_matrix*vec4(a_globe_anchor+displacement,1);\n#else\noffsetProjected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);\n#endif\nvec2 a=projected_point.xy/projected_point.w;vec2 b=offsetProjected_point.xy/offsetProjected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\nfloat occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;float projection_transition_fade=1.0;\n#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)\nprojection_transition_fade=1.0-step(EPSILON,u_zoom_transition);\n#endif\nvec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change))*projection_transition_fade;float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);\n#else\ngl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);\n#endif\nv_tex_a=a_tex/u_texsize;\n#ifdef ICON_TRANSITION\nv_tex_b=a_texb/u_texsize;\n#endif\nv_fade_opacity=out_fade_opacity;}'),symbolSDF:BE('#include "_prelude_lighting.glsl"\n#define SDF_PX 8.0\nuniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;\n#if __VERSION__ >=300\nflat varying float v_draw_halo;\n#endif\nvarying vec2 v_data0;varying vec3 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nfloat EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo;\n#if __VERSION__ >=300\ndraw_halo=v_draw_halo > 0.0;\n#else\ndraw_halo=u_is_halo;\n#endif\nif (draw_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);vec4 out_color=color*(alpha*opacity*fade_opacity);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,emissive_strength);\n#endif\ngl_FragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\nattribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_pixeloffset;attribute vec4 a_projected_pos;attribute float a_fade_opacity;\n#ifdef Z_OFFSET\nattribute float a_z_offset;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_globe_anchor;attribute vec3 a_globe_normal;\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform bool u_is_halo;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\n#if __VERSION__ >=300\nflat varying float v_draw_halo;\n#endif\nvarying vec2 v_data0;varying vec3 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);\n#ifdef Z_OFFSET\ne+=a_z_offset;\n#endif\nvec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);\n#else\noffsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);\n#endif\nvec2 a=projected_point.xy/projected_point.w;vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\nfloat occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;float projection_transition_fade=1.0;\n#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)\nprojection_transition_fade=1.0-step(EPSILON,u_zoom_transition);\n#endif\nvec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float out_fade_opacity=interpolated_fade_opacity*projection_transition_fade;float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);\n#else\ngl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);\n#endif\nfloat gamma_scale=gl_Position.w;\n#if __VERSION__ >=300\nv_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;\n#endif\nv_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,out_fade_opacity);}'),symbolTextAndIcon:BE('#include "_prelude_lighting.glsl"\n#define SDF_PX 8.0\n#define SDF 1.0\n#define ICON 0.0\nuniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_halo;\n#if __VERSION__ >=300\nflat varying float v_draw_halo;\n#endif\nvarying vec4 v_data0;varying vec4 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nfloat fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;gl_FragColor=texture2D(u_texture_icon,tex_icon)*alpha;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nreturn;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo;\n#if __VERSION__ >=300\ndraw_halo=v_draw_halo > 0.0;\n#else\ndraw_halo=u_is_halo;\n#endif\nif (draw_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);vec4 out_color=color*(alpha*opacity*fade_opacity);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,emissive_strength);\n#endif\ngl_FragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\nattribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_projected_pos;attribute float a_fade_opacity;\n#ifdef Z_OFFSET\nattribute float a_z_offset;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_globe_anchor;attribute vec3 a_globe_normal;\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\n#if __VERSION__ >=300\nflat varying float v_draw_halo;\n#endif\nvarying vec4 v_data0;varying vec4 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);\n#ifdef Z_OFFSET\ne+=a_z_offset;\n#endif\nvec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offset_projected_point=u_matrix*vec4(a_pos+vec2(1,0),0,1);vec2 a=projected_point.xy/projected_point.w;vec2 b=offset_projected_point.xy/offset_projected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*font_scale);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\nfloat occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float projection_transition_fade=1.0;\n#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)\nprojection_transition_fade=1.0-step(EPSILON,u_zoom_transition);\n#endif\nfloat out_fade_opacity=interpolated_fade_opacity*projection_transition_fade;float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);\n#else\ngl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);\n#endif\nfloat gamma_scale=gl_Position.w;\n#if __VERSION__ >=300\nv_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;\n#endif\nv_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,out_fade_opacity,is_sdf);}'),terrainRaster:BE('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;varying vec2 v_pos0;\n#ifdef FOG\nvarying float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nvarying vec4 v_pos_light_view_0;varying vec4 v_pos_light_view_1;varying float v_depth;\n#endif\nuniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture2D(u_image0,v_pos0);vec4 color;\n#ifdef LIGHTING_3D_MODE\nconst vec3 normal=vec3(0.0,0.0,1.0);\n#ifdef RENDER_SHADOWS\nfloat cutoffOpacity=1.0;\n#ifdef RENDER_CUTOFF\ncutoffOpacity=cutoff_opacity(u_cutoff_params,v_depth);\n#endif\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nvec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,v_depth,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;\n#else\nfloat lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));\n#endif\n#else\nfloat lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;\n#endif\n#endif\n#else\ncolor=image_color;\n#endif\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#else\ncolor=fog_dither(fog_apply_from_vert(color,v_fog_opacity));\n#endif\n#endif\ngl_FragColor=color;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_skirt_height;attribute vec2 a_pos;varying vec2 v_pos0;\n#ifdef FOG\nvarying float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;varying vec4 v_pos_light_view_0;varying vec4 v_pos_light_view_1;varying float v_depth;\n#endif\nvoid main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\nv_fog_pos=fog_position(decodedPos);\n#else\nv_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);v_depth=gl_Position.w;\n#endif\n}'),terrainDepth:BE("#ifdef GL_ES\nprecision highp float;\n#endif\nvarying float v_depth;void main() {gl_FragColor=pack_depth(v_depth);}",'#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;attribute vec2 a_pos;varying float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}'),skybox:BE('#include "_prelude_fog.fragment.glsl"\nvarying lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(\ncos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=textureCube(u_cubemap,uv).rgb;\n#ifdef FOG\nsky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);\n#endif\nsky_color.rgb=dither(sky_color.rgb,gl_FragCoord.xy+u_temporal_offset);sky_color+=0.1*sun_disk(v_uv,u_sun_direction);gl_FragColor=vec4(sky_color*u_opacity,u_opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}',kM),skyboxGradient:BE('#include "_prelude_fog.fragment.glsl"\nvarying highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture2D(u_color_ramp,vec2(progress,0.5));\n#ifdef FOG\ncolor.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;\n#endif\ncolor*=u_opacity;color.rgb=dither(color.rgb,gl_FragCoord.xy+u_temporal_offset);gl_FragColor=color;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}',kM),skyboxCapture:BE("\nvarying highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;\n#ifdef GL_ES\nprecision highp float;\n#endif\n#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)\n#define BETA_M                  vec3(21e-6,21e-6,21e-6)\n#define MIE_G                   0.76\n#define DENSITY_HEIGHT_SCALE_R  8000.0\n#define DENSITY_HEIGHT_SCALE_M  1200.0\n#define PLANET_RADIUS           6360e3\n#define ATMOSPHERE_RADIUS       6420e3\n#define SAMPLE_STEPS            10\n#define DENSITY_STEPS           4\nfloat ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;gl_FragColor=vec4(color,1.0);}","attribute highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;varying highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:BE('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;varying vec2 v_pos0;\n#ifndef FOG\nuniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;\n#endif\nvoid main() {vec4 color;\n#ifdef CUSTOM_ANTIALIASING\nvec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);vec3 dir=normalize(ray_dir);vec3 closest_point=dot(u_globe_pos,dir)*dir;float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture2D(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nraster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(raster.rgb*antialias,antialias);\n#else\nraster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=texture2D(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;\n#else\ncolor=apply_lighting_ground(color);\n#endif\n#endif\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ngl_FragColor=color;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;\n#ifdef GLOBE_POLES\nattribute vec3 a_globe_pos;attribute vec2 a_uv;\n#else\nattribute vec2 a_pos;\n#endif\nvarying vec2 v_pos0;float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(QUARTER_PI+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}void main() {\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;vec2 uv=a_uv;\n#else\nfloat tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);\n#endif\nv_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;\n#ifdef GLOBE_POLES\nvec3 up_vector=globe_derived_up_vector;\n#else\nvec3 up_vector=elevationVector(tile_pos);\n#endif\nfloat height=elevation(tile_pos);globe_pos+=up_vector*height;\n#ifndef GLOBE_POLES\nglobe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;\n#endif\n#ifdef GLOBE_POLES\nvec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);\n#else\nvec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);\n#endif\ngl_Position=u_proj_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n}'),globeAtmosphere:BE('#include "_prelude_fog.fragment.glsl"\nuniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;varying highp vec3 v_ray_dir;varying highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;\n#ifdef PROJECTION_GLOBE_VIEW\nglobe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {\n#ifdef ALPHA_PASS\ngl_FragColor=vec4(0,0,0,0);return;\n#else\n#ifdef NATIVE\ngl_FragColor=vec4(1,1,1,1);\n#else\ngl_FragColor=vec4(0,0,0,1);\n#endif\nreturn;\n#endif\n}\n#endif\nhighp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?\n0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;\n#ifdef PROJECTION_GLOBE_VIEW\nhighp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?\nPI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);\n#else\nhorizon_angle=horizon_angle_mercator;\n#endif\nhorizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;\n#ifdef ALPHA_PASS\nfloat a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);gl_FragColor=vec4(1.0,1.0,1.0,a);\n#else\nvec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;\n#ifndef NATIVE\nc=dither(c,gl_FragCoord.xy+u_temporal_offset);\n#endif\ngl_FragColor=vec4(c*t,t);\n#endif\n}',"attribute vec3 a_pos;attribute vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;varying highp vec3 v_ray_dir;varying highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(\nmix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}"),model:BE('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;varying highp vec4 v_position_height;varying lowp vec4 v_color_mix;\n#ifdef RENDER_SHADOWS\nvarying vec4 v_pos_light_view_0;varying vec4 v_pos_light_view_1;varying float v_depth_shadows;\n#endif\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#ifdef HAS_ATTRIBUTE_a_pbr\nvarying lowp vec4 v_roughness_metallic_emissive_alpha;varying mediump vec4 v_height_based_emission_params;\n#endif\n#ifdef HAS_TEXTURE_u_baseColorTexture\nuniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;\n#endif\n#ifdef HAS_TEXTURE_u_metallicRoughnessTexture\nuniform sampler2D u_metallicRoughnessTexture;\n#endif\n#ifdef HAS_TEXTURE_u_occlusionTexture\nuniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;\n#endif\n#ifdef HAS_TEXTURE_u_normalTexture\nuniform sampler2D u_normalTexture;\n#endif\n#ifdef HAS_TEXTURE_u_emissionTexture\nuniform sampler2D u_emissionTexture;\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nvarying highp float v_depth;uniform sampler2D u_depthTexture;uniform vec2 u_inv_depth_size;bool isOccluded() {vec2 coord=gl_FragCoord.xy*u_inv_depth_size;highp float depth=unpack_depth(texture2D(u_depthTexture,coord));return v_depth > depth+0.0005;}\n#endif\nconst float M_PI=3.141592653589793;\n#define saturate(_x) clamp(_x,0.,1.)\nfloat calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)\n{\n#ifdef LIGHTING_3D_MODE\nvec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));\n#endif\nreturn apply_lighting(albedo,transformed_normal,lighting_factor);\n#else\nvec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;\n#endif\n}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;\n#ifdef HAS_ATTRIBUTE_a_color_3f\nalbedo*=vec4(color_3f,1.0);\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#else\n#ifdef HAS_ATTRIBUTE_a_color_4f\nalbedo*=color_4f;\n#endif\n#endif\n#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)\nvec4 texColor=texture2D(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}\n#ifdef UNPREMULT_TEXTURE_IN_SHADER\nif(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;\n#endif\ntexColor.rgb=sRGBToLinear(texColor.rgb);if(u_baseTextureIsAlpha) {if (texColor.w < 0.5) {discard;}albedo*=mix(vec4(texColor.rgb,texColor.a),vec4(texColor.a),float(u_baseTextureIsAlpha));} else {albedo*=texColor;}\n#endif\nreturn vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {\n#ifdef HAS_TEXTURE_u_normalTexture\nhighp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;\n#else\nreturn mat3(1.0);\n#endif\n}highp vec3 getNormal(){highp vec3 n;\n#ifdef HAS_ATTRIBUTE_a_normal_3f\nn=normalize(normal_3f);\n#else\nhighp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));n=normalize(cross(fdx,fdy))*-1.0;\n#endif\n#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nvec3 nMap=texture2D( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);\n#endif\nreturn n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;\n#ifdef HAS_ATTRIBUTE_a_pbr\nmat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;\n#endif\n#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) \nvec4 mrSample=texture2D(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;\n#endif\nconst float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)\n{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)\n{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)\n{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)\n{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(M_PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)\n{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/M_PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)\n{\n#ifdef LIGHTING_3D_MODE\nreturn mat.diffuseColor;\n#else\nreturn mat.diffuseColor/M_PI;\n#endif\n}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)\n{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)\n{vec3 env_light=vec3(0.65,0.65,0.65);\n#ifdef LIGHTING_3D_MODE\nfloat ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;\n#endif\nvec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)\n{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=NdotL;\n#endif\nvec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;\n#if !defined(LIGHTING_3D_MODE)\nconst vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);\n#endif\ncolor*=intensityFactor;return color;}void main() {\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nif (isOccluded()) {discard;}\n#endif\nvec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;\n#ifdef LIGHTING_3D_MODE\nlightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;\n#endif\nvec4 finalColor;\n#ifdef DIFFUSE_SHADED\nvec3 N=getNormal();vec3 diffuse=getDiffuseShadedColor(getBaseColor().rgb,N,lightDir,lightColor);\n#ifdef HAS_TEXTURE_u_occlusionTexture\nfloat ao=(texture2D(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;\n#endif\nfinalColor=vec4(diffuse,1.0)*u_opacity;\n#else\nMaterial mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);\n#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nfloat ao=(texture2D(u_occlusionTexture,uv_2f).x-1.0)*u_aoIntensity+1.0;color*=ao;\n#endif\nvec4 emissive=u_emissiveFactor;\n#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nemissive.rgb*=sRGBToLinear(texture2D(u_emissionTexture,uv_2f).rgb);\n#endif\ncolor+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;\n#ifdef HAS_ATTRIBUTE_a_pbr\nfloat resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);color=mix(color,v_color_mix.rgb,min(1.0,resEmission));\n#ifdef HAS_ATTRIBUTE_a_color_4f\nfloat distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);\n#endif\n#endif\ncolor=mix(color,mat.baseColor.rgb,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);\n#endif\n#ifdef FOG\nfinalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));\n#endif\n#ifdef RENDER_CUTOFF\nfinalColor*=v_cutoff_opacity;\n#endif\n#ifdef INDICATOR_CUTOUT\nfinalColor=applyCutout(finalColor);\n#endif\ngl_FragColor=finalColor;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nattribute vec3 a_pos_3f;\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr\n#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength\nuniform mat4 u_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;\n#ifdef INSTANCED_ARRAYS\nattribute vec4 a_normal_matrix0;attribute vec4 a_normal_matrix1;attribute vec4 a_normal_matrix2;attribute vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_normal_matrix;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;varying vec4 v_pos_light_view_0;varying vec4 v_pos_light_view_1;varying float v_depth_shadows;\n#endif\nvarying vec4 v_position_height;varying lowp vec4 v_color_mix;\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nvarying highp float v_depth;\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\nvarying lowp vec4 v_roughness_metallic_emissive_alpha;varying mediump vec4 v_height_based_emission_params;\n#endif\nvoid main() {\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute-custom highp vec4 pbr\n#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength\nhighp mat4 normal_matrix;\n#ifdef INSTANCED_ARRAYS\nnormal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\nnormal_matrix=u_normal_matrix;\n#endif\nvec3 local_pos;mat3 rs;\n#ifdef MODEL_POSITION_ON_GPU\nvec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=u_matrix*pos;pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;\n#else\nlocal_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);\n#endif\nv_position_height.w=a_pos_3f.z;\n#ifdef HAS_ATTRIBUTE_a_pbr\nvec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(local_pos);\n#endif\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nv_depth=gl_Position.z/gl_Position.w;\n#endif\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nfloat x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);\n#else\nnormal_3f=vec3(normal_matrix*vec4(normal_3f,0));\n#endif\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#ifdef HAS_ATTRIBUTE_a_color_4f\nv_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec3 shadow_pos=local_pos;\n#ifdef NORMAL_OFFSET\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nvec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos+=offset*shadow_normal_offset_multiplier0();\n#else\nvec3 offset=shadow_normal_offset_model(normalize(normal_3f));shadow_pos+=offset*shadow_normal_offset_multiplier0();\n#endif\n#endif\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shadow_pos,1);v_pos_light_view_1=u_light_matrix_1*vec4(shadow_pos,1);v_depth_shadows=gl_Position.w;\n#endif\n}'),modelDepth:BE("varying highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\ngl_FragColor=pack_depth(v_depth);\n#endif\n}","attribute vec3 a_pos_3f;uniform mat4 u_matrix;varying highp float v_depth;\n#ifdef MODEL_POSITION_ON_GPU\n#ifdef INSTANCED_ARRAYS\nattribute vec4 a_normal_matrix0;attribute vec4 a_normal_matrix1;attribute vec4 a_normal_matrix2;attribute vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_instance;\n#endif\nuniform highp mat4 u_node_matrix;\n#endif\nvoid main() {\n#ifdef MODEL_POSITION_ON_GPU\nhighp mat4 instance;\n#ifdef INSTANCED_ARRAYS\ninstance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\ninstance=u_instance;\n#endif\nvec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=u_matrix*pos;\n#else\ngl_Position=u_matrix*vec4(a_pos_3f,1);\n#endif\nv_depth=gl_Position.z/gl_Position.w;}"),stars:BE("varying highp vec2 v_uv;varying mediump float v_intensity;float shapeCircle(in vec2 uv)\n{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;gl_FragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}","\nattribute vec3 a_pos_3f;attribute vec2 a_uv;attribute float a_size_scale;attribute float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;varying highp vec2 v_uv;varying mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}")};function OE(C,H){const te=C.replace(/\s*\/\/[^\n]*\n/g,"\n").split("\n");for(let C of te)if(C=C.trim(),"#"===C[0]&&C.includes("if")&&!C.includes("endif")){C=C.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();const te=C.split(" ");for(const C of te)H.includes(C)||H.push(C)}}function BE(C,H){const te=/#include\s+"([^"]+)"/g,le=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g;let ce=H.match(/attribute(\S*) (highp |mediump |lowp )?([\w]+) ([\w]+)/g);ce&&(ce=ce.filter(((C,H)=>ce.indexOf(C)===H)));const he={},ue=[],de=[];C=C.replace(te,((C,H)=>(de.push(H),""))),H=H.replace(te,((C,H)=>(ue.push(H),"")));let _e=[...KM];OE(C,_e),OE(H,_e);for(const C of[...ue,...de])JM[C]||console.error(`Undefined include: ${C}`),QM[C]||(QM[C]=[],OE(JM[C],QM[C])),_e=[..._e,...QM[C]];return{fragmentSource:C=C.replace(le,((C,H,te,le,ce)=>(he[ce]=!0,"define"===H?`\n#ifndef HAS_UNIFORM_u_${ce}\nvarying ${te} ${le} ${ce};\n#else\nuniform ${te} ${le} u_${ce};\n#endif\n`:"initialize"===H?`\n#ifdef HAS_UNIFORM_u_${ce}\n    ${te} ${le} ${ce} = u_${ce};\n#endif\n`:"define-attribute"===H?`\n#ifdef HAS_ATTRIBUTE_a_${ce}\n    varying ${te} ${le} ${ce};\n#endif\n`:"initialize-attribute"===H?"":void 0))),vertexSource:H=H.replace(le,((C,H,te,le,ce)=>{const ue="float"===le?"vec2":le,de=ce.match(/color/)?"color":ue;return"define-attribute-vertex-shader-only"===H?`\n#ifdef HAS_ATTRIBUTE_a_${ce}\nattribute ${te} ${le} a_${ce};\n#endif\n`:he[ce]?"define"===H?`\n#ifndef HAS_UNIFORM_u_${ce}\nuniform lowp float u_${ce}_t;\nattribute ${te} ${ue} a_${ce};\nvarying ${te} ${le} ${ce};\n#else\nuniform ${te} ${le} u_${ce};\n#endif\n`:"initialize"===H?"vec4"===de?`\n#ifndef HAS_UNIFORM_u_${ce}\n    ${ce} = a_${ce};\n#else\n    ${te} ${le} ${ce} = u_${ce};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${ce}\n    ${ce} = unpack_mix_${de}(a_${ce}, u_${ce}_t);\n#else\n    ${te} ${le} ${ce} = u_${ce};\n#endif\n`:"define-attribute"===H?`\n#ifdef HAS_ATTRIBUTE_a_${ce}\n    attribute ${te} ${le} a_${ce};\n    varying ${te} ${le} ${ce};\n#endif\n`:"initialize-attribute"===H?`\n#ifdef HAS_ATTRIBUTE_a_${ce}\n    ${ce} = a_${ce};\n#endif\n`:void 0:"define"===H?`\n#ifndef HAS_UNIFORM_u_${ce}\nuniform lowp float u_${ce}_t;\nattribute ${te} ${ue} a_${ce};\n#else\nuniform ${te} ${le} u_${ce};\n#endif\n`:"define-instanced"===H?"mat4"===de?`\n#ifdef INSTANCED_ARRAYS\nattribute vec4 a_${ce}0;\nattribute vec4 a_${ce}1;\nattribute vec4 a_${ce}2;\nattribute vec4 a_${ce}3;\n#else\nuniform ${te} ${le} u_${ce};\n#endif\n`:`\n#ifdef INSTANCED_ARRAYS\nattribute ${te} ${ue} a_${ce};\n#else\nuniform ${te} ${le} u_${ce};\n#endif\n`:"initialize-attribute-custom"===H?`\n#ifdef HAS_ATTRIBUTE_a_${ce}\n    ${te} ${le} ${ce} = a_${ce};\n#endif\n`:"vec4"===de?`\n#ifndef HAS_UNIFORM_u_${ce}\n    ${te} ${le} ${ce} = a_${ce};\n#else\n    ${te} ${le} ${ce} = u_${ce};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${ce}\n    ${te} ${le} ${ce} = unpack_mix_${de}(a_${ce}, u_${ce}_t);\n#else\n    ${te} ${le} ${ce} = u_${ce};\n#endif\n`})),staticAttributes:ce,usedDefines:_e,vertexIncludes:ue,fragmentIncludes:de}}class FE{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(C,H,te,le,ce,he,ue,de){this.context=C;let _e=this.boundPaintVertexBuffers.length!==le.length;for(let C=0;!_e&&C<le.length;C++)this.boundPaintVertexBuffers[C]!==le[C]&&(_e=!0);let ye=this.boundDynamicVertexBuffers.length!==ue.length;for(let C=0;!ye&&C<ue.length;C++)this.boundDynamicVertexBuffers[C]!==ue[C]&&(ye=!0);if(!this.vao||this.boundProgram!==H||this.boundLayoutVertexBuffer!==te||_e||ye||this.boundIndexBuffer!==ce||this.boundVertexOffset!==he)this.freshBind(H,te,le,ce,he,ue,de);else{C.bindVertexArrayOES.set(this.vao);for(const te of ue)te&&(te.bind(),de&&te.instanceCount&&te.setVertexAttribDivisor(C.gl,H,de));ce&&ce.dynamicDraw&&ce.bind()}}freshBind(C,H,te,le,ce,he,ue){const de=C.numAttributes,_e=this.context,ye=_e.gl;this.vao&&this.destroy(),this.vao=_e.gl.createVertexArray(),_e.bindVertexArrayOES.set(this.vao),this.boundProgram=C,this.boundLayoutVertexBuffer=H,this.boundPaintVertexBuffers=te,this.boundIndexBuffer=le,this.boundVertexOffset=ce,this.boundDynamicVertexBuffers=he,H.enableAttributes(ye,C),H.bind(),H.setVertexAttribPointers(ye,C,ce);for(const H of te)H.enableAttributes(ye,C),H.bind(),H.setVertexAttribPointers(ye,C,ce);for(const H of he)H&&(H.enableAttributes(ye,C),H.bind(),H.setVertexAttribPointers(ye,C,ce),ue&&H.instanceCount&&H.setVertexAttribDivisor(ye,C,ue));le&&le.bind(),_e.currentNumAttributes=de}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function NE(C,H){const te=Math.pow(2,H.canonical.z),le=H.canonical.y;return[new ep(0,le/te).toLngLat().lat,new ep(0,(le+1)/te).toLngLat().lat]}function UE(C,H,te,le,ce,he,ue){const de=C.context,_e=de.gl,ye=te.hillshadeFBO;if(!ye)return;C.prepareDrawTile();const ve=C.isTileAffectedByFog(H),Me=C.getOrCreateProgram("hillshade",{overrideFog:ve});de.activeTexture.set(_e.TEXTURE0),_e.bindTexture(_e.TEXTURE_2D,ye.colorAttachment.get());const Se=((C,H,te,le)=>{const ce=te.paint.get("hillshade-shadow-color"),he=te.paint.get("hillshade-highlight-color"),ue=te.paint.get("hillshade-accent-color"),de=te.paint.get("hillshade-emissive-strength");let _e=w(te.paint.get("hillshade-illumination-direction"));if("viewport"===te.paint.get("hillshade-illumination-anchor"))_e-=C.transform.angle;else if(C.style&&C.style.enable3dLights()&&C.style.directionalLight){const H=C.style.directionalLight.properties.get("direction");_e=w(J(H.x,H.y,H.z)[1])}const ye=!C.options.moving;return{u_matrix:le||C.transform.calculateProjMatrix(H.tileID.toUnwrapped(),ye),u_image:0,u_latrange:NE(0,H.tileID),u_light:[te.paint.get("hillshade-exaggeration"),_e],u_shadow:ce,u_highlight:he,u_emissive_strength:de,u_accent:ue}})(C,te,le,C.terrain?H.projMatrix:null);C.uploadCommonUniforms(de,Me,H.toUnwrapped());const{tileBoundsBuffer:Ae,tileBoundsIndexBuffer:Ce,tileBoundsSegments:Oe}=C.getTileBoundsBuffers(te);Me.draw(C,_e.TRIANGLES,ce,he,ue,Ex.disabled,Se,le.id,Ae,Ce,Oe)}function VE(C,H,te){if(!H.needsDEMTextureUpload)return;const le=C.context,ce=le.gl;le.pixelStoreUnpackPremultiplyAlpha.set(!1),H.demTexture=H.demTexture||C.getTileTexture(te.stride);const he=te.getPixels();H.demTexture?H.demTexture.update(he,{premultiply:!1}):H.demTexture=new gy(le,he,C.terrainUseFloatDEM()?ce.R32F:ce.RGBA,{premultiply:!1}),H.needsDEMTextureUpload=!1}function jE(C,H,te){const le=C.context,ce=le.gl;if(!H.dem)return;const he=H.dem;if(le.activeTexture.set(ce.TEXTURE1),VE(C,H,he),!H.demTexture)return;H.demTexture.bind(ce.NEAREST,ce.CLAMP_TO_EDGE);const ue=he.dim;le.activeTexture.set(ce.TEXTURE0);let de=H.hillshadeFBO;if(!de){const C=new gy(le,{width:ue,height:ue,data:null},ce.RGBA);C.bind(ce.LINEAR,ce.CLAMP_TO_EDGE),de=H.hillshadeFBO=le.createFramebuffer(ue,ue,!0,"renderbuffer"),de.colorAttachment.set(C.texture)}le.bindFramebuffer.set(de.framebuffer),le.viewport.set([0,0,ue,ue]);const{tileBoundsBuffer:_e,tileBoundsIndexBuffer:ye,tileBoundsSegments:ve}=C.getMercatorTileBoundsBuffers(),Me=[];C.terrainUseFloatDEM()&&Me.push("TERRAIN_DEM_FLOAT_FORMAT"),C.getOrCreateProgram("hillshadePrepare",{defines:Me}).draw(C,ce.TRIANGLES,gx.disabled,xx.disabled,bx.unblended,Ex.disabled,((C,H)=>{const te=H.stride,le=ed.create();return ed.ortho(le,0,wn,-wn,0,0,1),ed.translate(le,le,[0,-wn,0]),{u_matrix:le,u_image:1,u_dimension:[te,te],u_zoom:C.overscaledZ,u_unpack:H.unpackVector}})(H.tileID,he),te.id,_e,ye,ve),H.needsHillshadePrepare=!1}const GE=C=>({u_matrix:new kl(C),u_image0:new Il(C),u_skirt_height:new Cl(C),u_ground_shadow_factor:new Dl(C)}),qE=(C,H,te)=>({u_matrix:C,u_image0:0,u_skirt_height:H,u_ground_shadow_factor:te}),ZE=(C,H,te,le,ce,he,ue,de,_e,ye,ve,Me,Se,Ae,Ce)=>({u_proj_matrix:Float32Array.from(C),u_globe_matrix:H,u_normalize_matrix:Float32Array.from(le),u_merc_matrix:te,u_zoom_transition:ce,u_merc_center:he,u_image0:0,u_frustum_tl:ue,u_frustum_tr:de,u_frustum_br:_e,u_frustum_bl:ye,u_globe_pos:ve,u_globe_radius:Me,u_viewport:Se,u_grid_matrix:Ce?Float32Array.from(Ce):new Float32Array(9),u_skirt_height:Ae}),$E=(C,H)=>{if(H>0&&C.terrain&&W("Cutoff is currently disabled on terrain"),H<=0||C.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,0]}};const te=C.transform,le=Math.max(Math.abs(te._zoom-(C.minCutoffZoom-1)),1),ce=te.isLODDisabled(!1)?D(60,45,te.pitch):D(30,15,te.pitch),he=te._farZ-te._nearZ,ue=H*te.height,de=((1-(_e=ce))*(.75*te.cameraToCenterDistance)+_e*(te._farZ+ue))*le;var _e;return{shouldRenderCutoff:ce<1,uniformValues:{u_cutoff_params:[te._nearZ,te._farZ,(de-te._nearZ)/he,(de-ue-te._nearZ)/he]}}};function HE(C,H){return null!=C&&null!=H&&!(!C.hasData()||!H.hasData())&&null!=C.demTexture&&null!=H.demTexture&&C.tileID.key!==H.tileID.key}const DS=new class{constructor(){this.operations={}}newMorphing(C,H,te,le,ce){if(C in this.operations){const H=this.operations[C];H.to.tileID.key!==te.tileID.key&&(H.queued=te)}else this.operations[C]={startTime:le,phase:0,duration:ce,from:H,to:te,queued:null}}getMorphValuesForProxy(C){if(!(C in this.operations))return null;const H=this.operations[C];return{from:H.from,to:H.to,phase:H.phase}}update(C){for(const H in this.operations){const te=this.operations[H];for(te.phase=(C-te.startTime)/te.duration;te.phase>=1||!this._validOp(te);)if(!this._nextOp(te,C)){delete this.operations[H];break}}}_nextOp(C,H){return!!C.queued&&(C.from=C.to,C.to=C.queued,C.queued=null,C.phase=0,C.startTime=H,!0)}_validOp(C){return C.from.hasData()&&C.to.hasData()}},qS={0:null,1:"TERRAIN_VERTEX_MORPHING"};function YE(C,H,te){if(0===H)return 0;const le=H<1&&514===te?.25/H:1;return 6*Math.pow(1.5,22-C)*Math.max(H,1)*le}function KE(C,H){const te=1<<C.z;return!H&&(0===C.x||C.x===te-1)||0===C.y||C.y===te-1}const JE=C=>({u_matrix:C});function QE(C,H,te,le,ce){if(ce>0){const he=yi.now(),ue=(he-C.timeAdded)/ce,de=H?(he-H.timeAdded)/ce:-1,_e=te.getSource(),ye=le.coveringZoomLevel({tileSize:_e.tileSize,roundZoom:_e.roundZoom}),ve=!H||Math.abs(H.tileID.overscaledZ-ye)>Math.abs(C.tileID.overscaledZ-ye),Me=ve&&C.refreshedUponExpiration?1:z(ve?ue:1-de,0,1);return C.refreshedUponExpiration&&ue>=1&&(C.refreshedUponExpiration=!1),H?{opacity:1,mix:1-Me}:{opacity:Me,mix:0}}return{opacity:1,mix:0}}class eM extends Ax{constructor(C){const H={type:"raster-dem",maxzoom:C.transform.maxZoom},te=new _w(Uw(),null),le=vT("mock-dem",H,te,C.style);super("mock-dem",le,!1),le.setEventedParent(this),this._sourceLoaded=!0}_loadTile(C,H){C.state="loaded",H(null)}}class tM extends Ax{constructor(C){const H=vT("proxy",{type:"geojson",maxzoom:C.transform.maxZoom},new _w(Uw(),null),C.style);super("proxy",H,!1),H.setEventedParent(this),this.map=this.getSource().map=C,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(C,H,te){if(C.freezeTileCoverage)return;this.transform=C;const le=C.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce(((H,te)=>{if(H[te.key]="",!this._tiles[te.key]){const H=new Iy(te,this._source.tileSize*te.overscaleFactor(),C.tileZoom);H.state="loaded",this._tiles[te.key]=H}return H}),{});for(const C in this._tiles)C in le||(this.freeFBO(C),this._tiles[C].unloadVectorData(),delete this._tiles[C])}freeFBO(C){const H=this.proxyCachedFBO[C];if(void 0!==H){const te=Object.values(H);this.renderCachePool.push(...te),delete this.proxyCachedFBO[C]}}deallocRenderCache(){this.renderCache.forEach((C=>C.fb.destroy())),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class iM extends Bu{constructor(C,H,te){super(C.overscaledZ,C.wrap,C.canonical.z,C.canonical.x,C.canonical.y),this.proxyTileKey=H,this.projMatrix=te}}class rM extends Gm{constructor(C,H){super(),this.painter=C,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[te,le,ce]=function(C){const H=new Ta,te=new Va,le=131;H.reserve(17161),te.reserve(33800);const ce=wn/128,he=wn+ce/2,ue=he+ce;for(let C=-ce;C<ue;C+=ce)for(let te=-ce;te<ue;te+=ce){const le=te<0||te>he||C<0||C>he?24575:0,ce=z(Math.round(te),0,wn),ue=z(Math.round(C),0,wn);H.emplaceBack(ce+le,ue)}const a=(C,H)=>{const ce=H*le+C;te.emplaceBack(ce+1,ce,ce+le),te.emplaceBack(ce+le,ce+le+1,ce+1)};for(let C=1;C<129;C++)for(let H=1;H<129;H++)a(H,C);return[0,129].forEach((C=>{for(let H=0;H<130;H++)a(H,C),a(C,H)})),[H,te,32768]}(),he=C.context;this.gridBuffer=he.createVertexBuffer(te,Vd.members),this.gridIndexBuffer=he.createIndexBuffer(le),this.gridSegments=dl.simpleSegment(0,0,te.length,le.length),this.gridNoSkirtSegments=dl.simpleSegment(0,0,te.length,ce),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new tM(H.map),this.orthoMatrix=ed.create(),ed.ortho(this.orthoMatrix,"globe"===this.painter.transform.projection.name?.015:0,wn,0,wn,0,1);const ue=he.gl;this._overlapStencilMode=new xx({func:ue.GEQUAL,mask:255},0,255,ue.KEEP,ue.KEEP,ue.REPLACE),this._previousZoom=C.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=H,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new eM(H.map),this._pendingGroundEffectLayers=[]}set style(C){C.on("data",this._onStyleDataEvent.bind(this)),this._style=C,this._style.map.on("moveend",(()=>{this._clearLineLayersFromRenderCache()}))}update(C,H,te){if(C&&C.terrain){this._style!==C&&(this.style=C,this._evaluationZoom=void 0);const le=C.terrain.properties,ce=0===C.terrain.drapeRenderMode,he=C.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=yi.now();const ue=C.terrain&&C.terrain.scope,de=le.get("source"),_e=ce?this._mockSourceCache:C.getSourceCache(de,ue);if(!_e)return void W(`Couldn't find terrain source "${de}".`);if(this.sourceCache=_e,this._exaggeration=he?this.calculateExaggeration(H):le.get("exaggeration"),!H.projection.requiresDraping&&he&&0===this._exaggeration)return void this._disable();this.enabled=!0;const c=()=>{this.sourceCache.used&&W(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.\nThis leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const C=this.getScaledDemTileSize();this.sourceCache.update(H,C,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,c(),this._initializing=!0),c(),H.updateElevation(!0,te),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(H),this._emptyDEMTextureDirty=!0,this._previousZoom=H.zoom}else this._disable()}calculateExaggeration(C){const H=this._previousCameraAltitude,te=C.getFreeCameraOptions().position.z/C.pixelsPerMeter*C.worldSize;this._previousCameraAltitude=te;const le=null!=H?te-H:Number.MAX_VALUE;if(Math.abs(le)<2)return this._exaggeration;const ce=C.zoom,he=this._style.terrain;if(!this._previousUpdateTimestamp)return he.getExaggeration(ce);let ue=ce-this._previousZoom;const de=this._previousUpdateTimestamp;let _e=ce;null!=this._evaluationZoom&&(_e=this._evaluationZoom,Math.abs(ce-_e)>.5&&(ue=.5*(ce-_e+ue)),ue*le<0&&(_e+=ue)),this._evaluationZoom=_e;const ye=he.getExaggeration(_e),ve=ye===he.getExaggeration(Math.max(0,_e-.1));if(ve&&Math.abs(ye-this._exaggeration)<.01)return ye;let Me=Math.min(.1,.00375*(this._updateTimestamp-de));return(ve||ye<.1||Math.abs(ue)<1e-4)&&(Me=Math.min(.2,4*Me)),Wr(this._exaggeration,ye,Me)}resetTileLookupCache(C){this._findCoveringTileCache[C]={}}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(C){C.coord&&"source"===C.dataType?this._clearRenderCacheForTile(C.sourceCacheId,C.coord):"style"===C.dataType&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const C in this._style._mergedSourceCaches)this._style._mergedSourceCaches[C].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this._emptyDepthBufferTexture&&this._emptyDepthBufferTexture.destroy(),this.pool.forEach((C=>C.fb.destroy())),this.pool=[],this._depthFBO&&(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0),this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this._exaggeration}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const C=2*this.proxySourceCache.getSource().tileSize;return[C,C]}set useVertexMorphing(C){this._useVertexMorphing=C}updateTileBinding(C){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const H=this.proxySourceCache,te=this.painter.transform;this._initializing&&(this._initializing=0===te._centerAltitude&&-1===this.getAtPointOrZero(ep.fromLngLat(te.center),-1),this._emptyDEMTextureDirty=!this._initializing);const le=this.proxyCoords=H.getIds().map((C=>{const le=H.getTileByID(C).tileID;return le.projMatrix=te.calculateProjMatrix(le.toUnwrapped()),le}));!function(C,H){const te=H.transform.pointCoordinate(H.transform.getCameraPoint()),le=new Ne(te.x,te.y);C.sort(((C,H)=>{if(H.overscaledZ-C.overscaledZ)return H.overscaledZ-C.overscaledZ;const te=new Ne(C.canonical.x+(1<<C.canonical.z)*C.wrap,C.canonical.y),ce=new Ne(H.canonical.x+(1<<H.canonical.z)*H.wrap,H.canonical.y),he=le.mult(1<<C.canonical.z);return he.x-=.5,he.y-=.5,he.distSqr(te)-he.distSqr(ce)}))}(le,this.painter);const ce=this.proxyToSource||{};this.proxyToSource={},le.forEach((C=>{this.proxyToSource[C.key]={}})),this.terrainTileForTile={};const he=this._style._mergedSourceCaches;for(const H in he){const te=he[H];if(!te.used)continue;if(te!==this.sourceCache&&this.resetTileLookupCache(te.id),this._setupProxiedCoordsForOrtho(te,C[H],ce),te.usedForTerrain)continue;const le=C[H];te.getSource().reparseOverscaled&&this._assignTerrainTiles(le)}this.proxiedCoords[H.id]=le.map((C=>new iM(C,C.key,this.orthoMatrix))),this._assignTerrainTiles(le),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(ce),this.renderingToTexture=!1;const ue={};this._visibleDemTiles=[];for(const C of this.proxyCoords){const H=this.terrainTileForTile[C.key];if(!H)continue;const te=H.tileID.key;te in ue||(this._visibleDemTiles.push(H),ue[te]=te)}}_assignTerrainTiles(C){this._initializing||C.forEach((C=>{if(this.terrainTileForTile[C.key])return;const H=this._findTileCoveringTileID(C,this.sourceCache);H&&(this.terrainTileForTile[C.key]=H)}))}_prepareDEMTextures(){const C=this.painter.context,H=C.gl;for(const te in this.terrainTileForTile){const le=this.terrainTileForTile[te],ce=le.dem;!ce||le.demTexture&&!le.needsDEMTextureUpload||(C.activeTexture.set(H.TEXTURE1),VE(this.painter,le,ce))}}_prepareDemTileUniforms(C,H,te,le){if(!H||null==H.demTexture)return!1;const ce=C.tileID.canonical,he=Math.pow(2,H.tileID.canonical.z-ce.z),ue=le||"";return te[`u_dem_tl${ue}`]=[ce.x*he%1,ce.y*he%1],te[`u_dem_scale${ue}`]=he,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}get emptyDepthBufferTexture(){const C=this.painter.context,H=C.gl;if(!this._emptyDepthBufferTexture){const te=new $p({width:1,height:1},Uint8Array.of(255,255,255,255));this._emptyDepthBufferTexture=new gy(C,te,H.RGBA,{premultiply:!1})}return this._emptyDepthBufferTexture}_getLoadedAreaMinimum(){let C=0;const H=this._visibleDemTiles.reduce(((H,te)=>{if(!te.dem)return H;const le=te.dem.tree.minimums[0];return le>0&&C++,H+le}),0);return C?H/C:0}_updateEmptyDEMTexture(){const C=this.painter.context,H=C.gl;C.activeTexture.set(H.TEXTURE2);const te=this._getLoadedAreaMinimum(),[le,ce]=(()=>{if(this.painter.terrainUseFloatDEM()){const C=new Hp({width:1,height:1},new Float32Array([te]));return[H.R32F,C]}{const C=new $p({width:1,height:1},new Uint8Array(jm.pack(te,this.sourceCache.getSource().encoding)));return[H.RGBA,C]}})();this._emptyDEMTextureDirty=!1;let he=this._emptyDEMTexture;return he?he.update(ce,{premultiply:!1}):he=this._emptyDEMTexture=new gy(C,ce,le,{premultiply:!1}),he}setupElevationDraw(C,H,te){const le=this.painter.context,ce=le.gl,he=(ue=this.sourceCache.getSource().encoding,{u_dem:2,u_dem_prev:4,u_dem_unpack:jm.getUnpackVector(ue),u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_exaggeration:0});var ue;he.u_exaggeration=this.exaggeration();let de=null,_e=null,ye=1;if(te&&te.morphing&&this._useVertexMorphing){const H=te.morphing.srcDemTile,le=te.morphing.dstDemTile;ye=te.morphing.phase,H&&le&&(this._prepareDemTileUniforms(C,H,he,"_prev")&&(_e=H),this._prepareDemTileUniforms(C,le,he)&&(de=le))}const h=C=>C&&C.demTexture&&this.painter.terrainUseFloatDEM()?ce.LINEAR:ce.NEAREST,u=C=>{he.u_dem_size=1===C.size[0]?1:C.size[0]-2};if(_e&&de)le.activeTexture.set(ce.TEXTURE2),de.demTexture.bind(h(de),ce.CLAMP_TO_EDGE),le.activeTexture.set(ce.TEXTURE4),_e.demTexture.bind(h(_e),ce.CLAMP_TO_EDGE),de.demTexture&&u(de.demTexture),he.u_dem_lerp=ye;else{de=this.terrainTileForTile[C.tileID.key],le.activeTexture.set(ce.TEXTURE2);const H=this._prepareDemTileUniforms(C,de,he)?de.demTexture:this.emptyDEMTexture;H.bind(h(de),ce.CLAMP_TO_EDGE),u(H)}if(le.activeTexture.set(ce.TEXTURE3),te&&te.useDepthForOcclusion?(this._depthTexture&&this._depthTexture.bind(ce.NEAREST,ce.CLAMP_TO_EDGE),this._depthFBO&&(he.u_depth_size_inv=[1/this._depthFBO.width,1/this._depthFBO.height])):(this.emptyDepthBufferTexture.bind(ce.NEAREST,ce.CLAMP_TO_EDGE),he.u_depth_size_inv=[1,1]),te&&te.useMeterToDem&&de){const C=(1<<de.tileID.canonical.z)*Zd(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;he.u_meter_to_dem=C}if(te&&te.labelPlaneMatrixInv&&(he.u_label_plane_matrix_inv=te.labelPlaneMatrixInv),H.setTerrainUniformValues(le,he),"globe"===this.painter.transform.projection.name){const ce=this.globeUniformValues(this.painter.transform,C.tileID.canonical,te&&te.useDenormalizedUpVectorScale);H.setGlobeUniformValues(le,ce)}}globeUniformValues(C,H,te){const le=C.projection;return{u_tile_tl_up:le.upVector(H,0,0),u_tile_tr_up:le.upVector(H,wn,0),u_tile_br_up:le.upVector(H,wn,wn),u_tile_bl_up:le.upVector(H,0,wn),u_tile_up_scale:te?rd(1):le.upVectorScale(H,C.center.lat,C.worldSize).metersToTile}}renderToBackBuffer(C){const H=this.painter,te=this.painter.context;0!==C.length&&(te.bindFramebuffer.set(null),te.viewport.set([0,0,H.width,H.height]),H.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(C,H,te,le,ce){if("globe"===C.transform.projection.name)!function(C,H,te,le,ce){const he=C.context,ue=he.gl;let de,_e;const ye=C.transform,ve=Ad(C,he,ye),u=(H,te)=>{if(_e===te)return;const le=[qS[te],"PROJECTION_GLOBE_VIEW"];ve&&le.push("CUSTOM_ANTIALIASING");const ce=C.isTileAffectedByFog(H);de=C.getOrCreateProgram("globeRaster",{defines:le,overrideFog:ce}),_e=te},Me=C.colorModeForRenderPass(),Se=new gx(ue.LEQUAL,gx.ReadWrite,C.depthRangeFor3D);DS.update(ce);const Ae=function(C){const H=C.pixelsPerMeter,te=H/Zd(1,C.center.lat),le=ed.identity(new Float64Array(16));return ed.translate(le,le,[C.point.x,C.point.y,0]),ed.scale(le,le,[te,te,H]),Float32Array.from(le)}(ye),Ce=[Gd(ye.center.lng),qd(ye.center.lat)],Oe=C.globeSharedBuffers,Ne=[ye.width*yi.devicePixelRatio,ye.height*yi.devicePixelRatio],je=Float32Array.from(ye.globeMatrix),Ge={useDenormalizedUpVectorScale:!0};{const ye=C.transform,ve=YE(ye.zoom,H.exaggeration(),H.sourceCache._source.tileSize);_e=-1;const Ze=ue.TRIANGLES;for(const _e of le){const le=te.getTile(_e),qe=xx.disabled,$e=H.prevTerrainTileForTile[_e.key],We=H.terrainTileForTile[_e.key];HE($e,We)&&DS.newMorphing(_e.key,$e,We,ce,250),he.activeTexture.set(ue.TEXTURE0),le.texture.bind(ue.LINEAR,ue.CLAMP_TO_EDGE);const He=DS.getMorphValuesForProxy(_e.key),Xe=He?1:0;He&&Pt(Ge,{morphing:{srcDemTile:He.from,dstDemTile:He.to,phase:M(He.phase)}});const Ye=dd(_e.canonical),Je=Id(Ye.getCenter().lat),Qe=Sd(_e.canonical,Ye,Je,ye.worldSize/ye._pixelsPerMercatorPixel),tt=xd(ad(_e.canonical)),rt=ZE(ye.projMatrix,je,Ae,tt,Ed(ye.zoom),Ce,ye.frustumCorners.TL,ye.frustumCorners.TR,ye.frustumCorners.BR,ye.frustumCorners.BL,ye.globeCenterInViewSpace,ye.globeRadius,Ne,ve,Qe);if(u(_e,Xe),de&&(H.setupElevationDraw(le,de,Ge),C.uploadCommonUniforms(he,de,_e.toUnwrapped()),Oe)){const[H,te,le]=Oe.getGridBuffers(Je,0!==ve);de.draw(C,Ze,Se,qe,Me,Ex.backCCW,rt,"globe_raster",H,te,le)}}}if(Oe&&(C.renderDefaultNorthPole||C.renderDefaultSouthPole)){const ce=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];ve&&ce.push("CUSTOM_ANTIALIASING"),de=C.getOrCreateProgram("globeRaster",{defines:ce});for(const ce of le){const{x:le,y:_e,z:ve}=ce.canonical,Ae=0===_e,je=_e===(1<<ve)-1,[Ze,qe,$e,We]=Oe.getPoleBuffers(ve,!1);if(We&&(Ae||je)){const _e=te.getTile(ce);he.activeTexture.set(ue.TEXTURE0),_e.texture.bind(ue.LINEAR,ue.CLAMP_TO_EDGE);let Oe=Md(ve,le,ye);const He=xd(ad(ce.canonical)),E=(H,te)=>H.draw(C,ue.TRIANGLES,Se,xx.disabled,Me,Ex.disabled,ZE(ye.projMatrix,Oe,Oe,He,0,Ce,ye.frustumCorners.TL,ye.frustumCorners.TR,ye.frustumCorners.BR,ye.frustumCorners.BL,ye.globeCenterInViewSpace,ye.globeRadius,Ne,0),"globe_pole_raster",te,$e,We);H.setupElevationDraw(_e,de,Ge),C.uploadCommonUniforms(he,de,ce.toUnwrapped()),Ae&&C.renderDefaultNorthPole&&E(de,Ze),je&&C.renderDefaultSouthPole&&(Oe=ed.scale(ed.create(),Oe,[1,-1,1]),E(de,qe))}}}}(C,H,te,le,ce);else{const he=C.context,ue=he.gl;let de,_e;const ye=C.shadowRenderer,ve=$E(C,C.longestCutoffRange),u=H=>{if(_e===H)return;const te=[];te.push(qS[H]),ve.shouldRenderCutoff&&te.push("RENDER_CUTOFF"),de=C.getOrCreateProgram("terrainRaster",{defines:te}),_e=H},Me=C.colorModeForRenderPass(),Se=new gx(ue.LEQUAL,gx.ReadWrite,C.depthRangeFor3D);DS.update(ce);const Ae=C.transform,Ce=YE(Ae.zoom,H.exaggeration(),H.sourceCache._source.tileSize);let Oe=[0,0,0];if(ye){const H=C.style.directionalLight,te=C.style.ambientLight;H&&te&&(Oe=BA(H,te))}{_e=-1;const Ne=ue.TRIANGLES,[je,Ge]=[H.gridIndexBuffer,H.gridSegments];for(const _e of le){const le=te.getTile(_e),Ze=xx.disabled,qe=H.prevTerrainTileForTile[_e.key],$e=H.terrainTileForTile[_e.key];HE(qe,$e)&&DS.newMorphing(_e.key,qe,$e,ce,250),he.activeTexture.set(ue.TEXTURE0),le.texture.bind(ue.LINEAR,ue.CLAMP_TO_EDGE,ue.LINEAR_MIPMAP_NEAREST);const We=DS.getMorphValuesForProxy(_e.key),He=We?1:0;let Xe;We&&(Xe={morphing:{srcDemTile:We.from,dstDemTile:We.to,phase:M(We.phase)}});const Ye=qE(_e.projMatrix,KE(_e.canonical,Ae.renderWorldCopies)?Ce/10:Ce,Oe);if(u(He),!de)continue;H.setupElevationDraw(le,de,Xe);const Je=_e.toUnwrapped();ye&&ye.setupShadows(Je,de),C.uploadCommonUniforms(he,de,Je,null,ve),de.draw(C,Ne,Se,Ze,Me,Ex.backCCW,Ye,"terrain_raster",H.gridBuffer,je,Ge)}}}}(H,this,this.proxySourceCache,C,this._updateTimestamp),this.renderingToTexture=!0,H.gpuTimingDeferredRenderEnd(),C.splice(0,C.length))}renderBatch(C){if(0===this._drapedRenderBatches.length)return C+1;this.renderingToTexture=!0;const H=this.painter,te=this.painter.context,le=this.proxySourceCache,ce=this.proxiedCoords[le.id],he=this._drapedRenderBatches.shift(),ue=H.style.order,de=[];let _e=0;for(const ye of ce){const ce=le.getTileByID(ye.proxyTileKey),ve=le.proxyCachedFBO[ye.key]?le.proxyCachedFBO[ye.key][C]:void 0,Me=void 0!==ve?le.renderCache[ve]:this.pool[_e++],Se=void 0!==ve;if(ce.texture=Me.tex,Se&&!Me.dirty){de.push(ce.tileID);continue}let Ae;te.bindFramebuffer.set(Me.fb.framebuffer),this.renderedToTile=!1,Me.dirty&&(te.clear({color:kr.transparent,stencil:0}),Me.dirty=!1);for(let C=he.start;C<=he.end;++C){const le=H.style._mergedLayers[ue[C]];if(le.isHidden(H.transform.zoom))continue;const ce=H.style.getLayerSourceCache(le),he=ce?this.proxyToSource[ye.key][ce.id]:[ye];if(!he)continue;const de=he;te.viewport.set([0,0,Me.fb.width,Me.fb.height]),Ae!==(ce?ce.id:null)&&(this._setupStencil(Me,he,le,ce),Ae=ce?ce.id:null),H.renderLayer(H,ce,le,de)}if(0===this._drapedRenderBatches.length)for(const C of this._pendingGroundEffectLayers){const le=H.style._mergedLayers[ue[C]];if(le.isHidden(H.transform.zoom))continue;const ce=H.style.getLayerSourceCache(le),he=ce?this.proxyToSource[ye.key][ce.id]:[ye];if(!he)continue;const de=he;te.viewport.set([0,0,Me.fb.width,Me.fb.height]),Ae!==(ce?ce.id:null)&&(this._setupStencil(Me,he,le,ce),Ae=ce?ce.id:null),H.renderLayer(H,ce,le,de)}this.renderedToTile?(Me.dirty=!0,de.push(ce.tileID)):Se||--_e,5===_e&&(_e=0,this.renderToBackBuffer(de))}return this.renderToBackBuffer(de),this.renderingToTexture=!1,te.bindFramebuffer.set(null),te.viewport.set([0,0,H.width,H.height]),he.end+1}postRender(){}isLayerOrderingCorrect(C){const H=C.order.length;let te=-1,le=H;for(let ce=0;ce<H;++ce)this._style.isLayerDraped(C._mergedLayers[C.order[ce]])?te=Math.max(te,ce):le=Math.min(le,ce);return le>te}getMinElevationBelowMSL(){let C=0;return this._visibleDemTiles.filter((C=>C.dem)).forEach((H=>{C=Math.min(C,H.dem.tree.minimums[0])})),0===C?C:(C-30)*this._exaggeration}raycast(C,H,te){if(!this._visibleDemTiles)return null;const le=this._visibleDemTiles.filter((C=>C.dem)).map((le=>{const ce=le.tileID,he=1<<ce.overscaledZ,{x:ue,y:de}=ce.canonical,_e=ue/he,ye=(ue+1)/he,ve=de/he,Me=(de+1)/he;return{minx:_e,miny:ve,maxx:ye,maxy:Me,t:le.dem.tree.raycastRoot(_e,ve,ye,Me,C,H,te),tile:le}}));le.sort(((C,H)=>(null!==C.t?C.t:Number.MAX_VALUE)-(null!==H.t?H.t:Number.MAX_VALUE)));for(const ce of le){if(null==ce.t)return null;const le=ce.tile.dem.tree.raycast(ce.minx,ce.miny,ce.maxx,ce.maxy,C,H,te);if(null!=le)return le}return null}_createFBO(){const C=this.painter.context,H=C.gl,te=this.drapeBufferSize;C.activeTexture.set(H.TEXTURE0);const le=new gy(C,{width:te[0],height:te[1],data:null},H.RGBA);le.bind(H.LINEAR,H.CLAMP_TO_EDGE);const ce=C.createFramebuffer(te[0],te[1],!0,null);return ce.colorAttachment.set(le.texture),ce.depthAttachment=new mx(C,ce.framebuffer),void 0===this._sharedDepthStencil?(this._sharedDepthStencil=C.createRenderbuffer(C.gl.DEPTH_STENCIL,te[0],te[1]),this._stencilRef=0,ce.depthAttachment.set(this._sharedDepthStencil),C.clear({stencil:0})):ce.depthAttachment.set(this._sharedDepthStencil),C.extTextureFilterAnisotropic&&!C.extTextureFilterAnisotropicForceOff&&H.texParameterf(H.TEXTURE_2D,C.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,C.extTextureFilterAnisotropicMax),{fb:ce,tex:le,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._style.hasLightTransitions())return!0;for(const C in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[C].hasTransition())return!0;return this._style.order.some((C=>{const H=this._style._mergedLayers[C],te=H.isHidden(this.painter.transform.zoom);return"custom"===H.type?!te&&H.shouldRedrape():!te&&H.hasTransition()}))}_clearLineLayersFromRenderCache(){let C=!1;for(const H of this._style.getSources())if(H instanceof Rw){C=!0;break}if(!C)return;const H={};for(let C=0;C<this._style.order.length;++C){const te=this._style._mergedLayers[this._style.order[C]],le=this._style.getLayerSourceCache(te);if(le&&!H[le.id]&&!te.isHidden(this.painter.transform.zoom)&&"line"===te.type&&te.widthExpression()instanceof bo){H[le.id]=!0;for(const C of this.proxyCoords){const H=this.proxyToSource[C.key][le.id];if(H)for(const C of H)this._clearRenderCacheForTile(le.id,C)}}}}_clearRasterLayersFromRenderCache(){let C=!1;for(const H in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[H]._source instanceof Lw){C=!0;break}if(!C)return;const H={};for(let C=0;C<this._style.order.length;++C){const te=this._style._mergedLayers[this._style.order[C]],le=this._style.getLayerSourceCache(te);if(!le||H[le.id])continue;if(te.isHidden(this.painter.transform.zoom)||"raster"!==te.type)continue;const ce=te.paint.get("raster-fade-duration");for(const C of this.proxyCoords){const H=this.proxyToSource[C.key][le.id];if(H)for(const C of H){const H=QE(le.getTile(C),le.findLoadedParent(C,0),le,this.painter.transform,ce);(1!==H.opacity||0!==H.mix)&&this._clearRenderCacheForTile(le.id,C)}}}}_setupDrapedRenderBatches(){const C=this._style.order,H=C.length;if(0===H)return;const te=[];this._pendingGroundEffectLayers=[];let le,ce=0,he=this._style._mergedLayers[C[ce]];for(;!this._style.isLayerDraped(he)&&he.isHidden(this.painter.transform.zoom)&&++ce<H;)he=this._style._mergedLayers[C[ce]];for(;ce<H;++ce){const H=this._style._mergedLayers[C[ce]];H.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(H)?void 0===le&&(le=ce):("fill-extrusion"===H.type&&this._pendingGroundEffectLayers.push(ce),void 0!==le&&(te.push({start:le,end:ce-1}),le=void 0)))}if(void 0!==le&&te.push({start:le,end:ce-1}),0!==te.length){const C=te[te.length-1],H=this._pendingGroundEffectLayers.every((H=>H>C.end));H||W("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=te}_setupRenderCache(C){const H=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,H.renderCache.length>H.renderCachePool.length){const C=Object.values(H.proxyCachedFBO);H.proxyCachedFBO={};for(let te=0;te<C.length;++te){const le=Object.values(C[te]);H.renderCachePool.push(...le)}}return}this._clearRasterLayersFromRenderCache();const te=this.proxyCoords,le=this._tilesDirty;for(let ce=te.length-1;ce>=0;ce--){const he=te[ce];if(H.getTileByID(he.key),void 0!==H.proxyCachedFBO[he.key]){const te=C[he.key],ce=this.proxyToSource[he.key];let ue=0;for(const C in ce){const H=ce[C],he=te[C];if(!he||he.length!==H.length||H.some(((H,te)=>H!==he[te]||le[C]&&le[C].hasOwnProperty(H.key)))){ue=-1;break}++ue}for(const C in H.proxyCachedFBO[he.key])H.renderCache[H.proxyCachedFBO[he.key][C]].dirty=ue<0||ue!==Object.values(te).length}}const ce=[...this._drapedRenderBatches];ce.sort(((C,H)=>H.end-H.start-(C.end-C.start)));for(const C of ce)for(const le of te){if(H.proxyCachedFBO[le.key])continue;let te=H.renderCachePool.pop();void 0===te&&H.renderCache.length<50&&(te=H.renderCache.length,H.renderCache.push(this._createFBO())),void 0!==te&&(H.proxyCachedFBO[le.key]={},H.proxyCachedFBO[le.key][C.start]=te,H.renderCache[te].dirty=!0)}this._tilesDirty={}}_setupStencil(C,H,te,le){if(!le||!this._sourceTilesOverlap[le.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const ce=this.painter.context,he=ce.gl;if(H.length<=1)return void(this._overlapStencilType=!1);let ue;if(te.isTileClipped())ue=H.length,this._overlapStencilMode.test={func:he.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(H[0].overscaledZ>H[H.length-1].overscaledZ))return void(this._overlapStencilType=!1);ue=1,this._overlapStencilMode.test={func:he.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+ue>255&&(ce.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=ue,this._overlapStencilMode.ref=this._stencilRef,te.isTileClipped()&&this._renderTileClippingMasks(H,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return"Clip"===this._overlapStencilType||"Mask"===this._overlapStencilType}stencilModeForRTTOverlap(C){return this.renderingToTexture&&this._overlapStencilType?("Clip"===this._overlapStencilType&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[C.key]),this._overlapStencilMode):xx.disabled}_renderTileClippingMasks(C,H){const te=this.painter,le=this.painter.context,ce=le.gl;te._tileClippingMaskIDs={},le.setColorMode(bx.disabled),le.setDepthMode(gx.disabled);const he=te.getOrCreateProgram("clippingMask");for(const le of C){const C=te._tileClippingMaskIDs[le.key]=--H;he.draw(te,ce.TRIANGLES,gx.disabled,new xx({func:ce.ALWAYS,mask:0},C,255,ce.KEEP,ce.KEEP,ce.REPLACE),bx.disabled,Ex.disabled,JE(le.projMatrix),"$clipping",te.tileExtentBuffer,te.quadTriangleIndexBuffer,te.tileExtentSegments)}}pointCoordinate(C){const H=this.painter.transform;if(C.x<0||C.x>H.width||C.y<0||C.y>H.height)return null;const te=[C.x,C.y,1,1];Lu.transformMat4(te,te,H.pixelMatrixInverse),Lu.scale(te,te,1/te[3]),te[0]/=H.worldSize,te[1]/=H.worldSize;const le=H._camera.position,ce=Zd(1,H.center.lat),he=[le[0],le[1],le[2]/ce,0],ue=Ld.subtract([],te.slice(0,3),he);Ld.normalize(ue,ue);const de=this.raycast(he,ue,this._exaggeration);return null!==de&&de?(Ld.scaleAndAdd(he,he,ue,de),he[3]=he[2],he[2]*=ce,he):null}drawDepth(){const C=this.painter,H=C.context,te=this.proxySourceCache,le=Math.ceil(C.width),ce=Math.ceil(C.height);if(!this._depthFBO||this._depthFBO.width===le&&this._depthFBO.height===ce||(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0),!this._depthFBO){const C=H.gl,te=H.createFramebuffer(le,ce,!0,"renderbuffer");H.activeTexture.set(C.TEXTURE0);const he=new gy(H,{width:le,height:ce,data:null},C.RGBA);he.bind(C.NEAREST,C.CLAMP_TO_EDGE),te.colorAttachment.set(he.texture);const ue=H.createRenderbuffer(H.gl.DEPTH_COMPONENT16,le,ce);te.depthAttachment.set(ue),this._depthFBO=te,this._depthTexture=he}H.bindFramebuffer.set(this._depthFBO.framebuffer),H.viewport.set([0,0,le,ce]),function(C,H,te,le){if("globe"===C.transform.projection.name)return;const ce=C.context,he=ce.gl;ce.clear({depth:1});const ue=C.getOrCreateProgram("terrainDepth"),de=new gx(he.LESS,gx.ReadWrite,C.depthRangeFor3D);for(const ce of le){const le=te.getTile(ce),_e=qE(ce.projMatrix,0,[0,0,0]);H.setupElevationDraw(le,ue),ue.draw(C,he.TRIANGLES,de,xx.disabled,bx.unblended,Ex.backCCW,_e,"terrain_depth",H.gridBuffer,H.gridIndexBuffer,H.gridNoSkirtSegments)}}(C,this,te,this.proxyCoords)}_setupProxiedCoordsForOrtho(C,H,te){if(C.getSource()instanceof qb)return this._setupProxiedCoordsForImageSource(C,H,te);this._findCoveringTileCache[C.id]=this._findCoveringTileCache[C.id]||{};const le=this.proxiedCoords[C.id]=[],ce=this.proxyCoords;for(let H=0;H<ce.length;H++){const he=ce[H],ue=this._findTileCoveringTileID(he,C);if(ue){const H=this._createProxiedId(he,ue,te[he.key]&&te[he.key][C.id]);le.push(H),this.proxyToSource[he.key][C.id]=[H]}}let he=!1;for(let ce=0;ce<H.length;ce++){const ue=C.getTile(H[ce]);if(!ue||!ue.hasData())continue;const de=this._findTileCoveringTileID(ue.tileID,this.proxySourceCache);if(de&&de.tileID.canonical.z!==ue.tileID.canonical.z){const H=this.proxyToSource[de.tileID.key][C.id],ce=this._createProxiedId(de.tileID,ue,te[de.tileID.key]&&te[de.tileID.key][C.id]);H?H.splice(H.length-1,0,ce):this.proxyToSource[de.tileID.key][C.id]=[ce],le.push(ce),he=!0}}this._sourceTilesOverlap[C.id]=he}_setupProxiedCoordsForImageSource(C,H,te){if(!C.getSource().loaded())return;const le=this.proxiedCoords[C.id]=[],ce=this.proxyCoords,he=C.getSource(),ue=he.tileID;if(!ue)return;const de=new Ne(ue.x,ue.y)._div(1<<ue.z),_e=he.coordinates.map(ep.fromLngLat).reduce(((C,H)=>(C.min.x=Math.min(C.min.x,H.x-de.x),C.min.y=Math.min(C.min.y,H.y-de.y),C.max.x=Math.max(C.max.x,H.x-de.x),C.max.y=Math.max(C.max.y,H.y-de.y),C)),{min:new Ne(Number.MAX_VALUE,Number.MAX_VALUE),max:new Ne(-Number.MAX_VALUE,-Number.MAX_VALUE)}),c=(C,H)=>{const te=C.wrap+C.canonical.x/(1<<C.canonical.z),le=C.canonical.y/(1<<C.canonical.z),ce=wn/(1<<C.canonical.z),he=H.wrap+H.canonical.x/(1<<H.canonical.z),ue=H.canonical.y/(1<<H.canonical.z);return te+ce<he+_e.min.x||te>he+_e.max.x||le+ce<ue+_e.min.y||le>ue+_e.max.y};for(let he=0;he<ce.length;he++){const ue=ce[he];for(let ce=0;ce<H.length;ce++){const he=C.getTile(H[ce]);if(!he||!he.hasData())continue;if(c(ue,he.tileID))continue;const de=this._createProxiedId(ue,he,te[ue.key]&&te[ue.key][C.id]),_e=this.proxyToSource[ue.key][C.id];_e?_e.push(de):this.proxyToSource[ue.key][C.id]=[de],le.push(de)}}}_createProxiedId(C,H,te){let le=this.orthoMatrix;if(te){const C=te.find((C=>C.key===H.tileID.key));if(C)return C}if(H.tileID.key!==C.key){const te=C.canonical.z-H.tileID.canonical.z;let ce,he,ue;le=ed.create();const de=H.tileID.wrap-C.wrap<<C.overscaledZ;te>0?(ce=wn>>te,he=ce*((H.tileID.canonical.x<<te)-C.canonical.x+de),ue=ce*((H.tileID.canonical.y<<te)-C.canonical.y)):(ce=wn<<-te,he=wn*(H.tileID.canonical.x-(C.canonical.x+de<<-te)),ue=wn*(H.tileID.canonical.y-(C.canonical.y<<-te))),ed.ortho(le,0,ce,0,ce,0,1),ed.translate(le,le,[he,ue,0])}return new iM(H.tileID,C.key,le)}_findTileCoveringTileID(C,H){let te=H.getTile(C);if(te&&te.hasData())return te;const le=this._findCoveringTileCache[H.id],ce=le[C.key];if(te=ce?H.getTileByID(ce):null,te&&te.hasData()||null===ce)return te;let he=te?te.tileID:C,ue=he.overscaledZ;const de=H.getSource().minzoom,_e=[];if(!ce){const le=H.getSource().maxzoom;if(C.canonical.z>=le){const te=C.canonical.z-le;H.getSource().reparseOverscaled?(ue=Math.max(C.canonical.z+2,H.transform.tileZoom),he=new Bu(ue,C.wrap,le,C.canonical.x>>te,C.canonical.y>>te)):0!==te&&(ue=le,he=new Bu(ue,C.wrap,le,C.canonical.x>>te,C.canonical.y>>te))}he.key!==C.key&&(_e.push(he.key),te=H.getTile(he))}const c=C=>{_e.forEach((H=>{le[H]=C})),_e.length=0};for(ue-=1;ue>=de&&(!te||!te.hasData());ue--){te&&c(te.tileID.key);const C=he.calculateScaledKey(ue);if(te=H.getTileByID(C),te&&te.hasData())break;const ce=le[C];if(null===ce)break;void 0===ce?_e.push(C):te=H.getTileByID(ce)}return c(te?te.tileID.key:null),te&&te.hasData()?te:null}findDEMTileFor(C){return this.enabled?this._findTileCoveringTileID(C,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(C,H){let te=this._tilesDirty[C];te||(te=this._tilesDirty[C]={}),te[H.key]=!0}}function nM(C,H,te){const le=function(C,H,te){const le=Ld.dot(H,C),ce=Ld.dot(te,[.2126,.7152,.0722]),o=(C,H,te)=>(1-te)*C+te*H,he=o(1-.3*Math.min(ce,1),1,Math.min(le+1,1));return o(.92,1,Math.asin(z(H[2],-1,1))/Math.PI+.5)*he}(C,[0,0,1],H),ce=[0,0,0];Ld.scale(ce,te.slice(0,3),le);const he=[0,0,0];Ld.scale(he,H.slice(0,3),C[2]);const ue=[0,0,0];return Ld.add(ue,ce,he),ae(ue)}const YS=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],JS=["stars","fillExtrusion","fillExtrusionGroundEffect","model","symbolSDF","symbolIcon","symbolTextAndIcon"];class aM{static cacheKey(C,H,te,le){let ce=`${H}${le?le.cacheKey:""}`;for(const H of te)C.usedDefines.includes(H)&&(ce+=`/${H}`);return ce}constructor(C,H,te,le,ce,he){const ue=C.gl;this.program=ue.createProgram(),this.configuration=le,this.name=H,this.fixedDefines=[...he];const de=function(C){const H=[];for(let te=0;te<C.length;te++){if(null===C[te])continue;const le=C[te].split(" ");H.push(le.pop())}return H}(te.staticAttributes),_e=le?le.getBinderAttributes():[],ye=de.concat(_e);let ve=le?le.defines():[];ve=ve.concat(he.map((C=>`#define ${C}`)));const Me="#version 300 es\n";let Se=Me+ve.concat("\n#ifdef GL_ES\nprecision mediump float;\n#else\n\n#if !defined(lowp)\n#define lowp\n#endif\n\n#if !defined(mediump)\n#define mediump\n#endif\n\n#if !defined(highp)\n#define highp\n#endif\n\n#endif",fS,eS.fragmentSource).join("\n");for(const C of te.fragmentIncludes)Se+=`\n${JM[C]}`;Se+=`\n${te.fragmentSource}`;let Ae=Me+ve.concat("\n#ifdef GL_ES\nprecision highp float;\n#else\n\n#if !defined(lowp)\n#define lowp\n#endif\n\n#if !defined(mediump)\n#define mediump\n#endif\n\n#if !defined(highp)\n#define highp\n#endif\n\n#endif",fS,eS.vertexSource).join("\n");for(const C of te.vertexIncludes)Ae+=`\n${JM[C]}`;Ae+=`\n${te.vertexSource}`;const Ce=ue.createShader(ue.FRAGMENT_SHADER);if(ue.isContextLost())return void(this.failedToCreate=!0);ue.shaderSource(Ce,Se),ue.compileShader(Ce),ue.attachShader(this.program,Ce);const Oe=ue.createShader(ue.VERTEX_SHADER);if(ue.isContextLost())this.failedToCreate=!0;else{ue.shaderSource(Oe,Ae),ue.compileShader(Oe),ue.attachShader(this.program,Oe),this.attributes={},this.numAttributes=ye.length;for(let C=0;C<this.numAttributes;C++)if(ye[C]){const H=ye[C].startsWith("a_")?ye[C]:`a_${ye[C]}`;ue.bindAttribLocation(this.program,C,H),this.attributes[H]=C}ue.linkProgram(this.program),ue.deleteShader(Oe),ue.deleteShader(Ce),this.fixedUniforms=ce(C),this.binderUniforms=le?le.getUniforms(C):[],he.includes("TERRAIN")&&(this.terrainUniforms=(C=>({u_dem:new Il(C),u_dem_prev:new Il(C),u_dem_unpack:new Pl(C),u_dem_tl:new zl(C),u_dem_scale:new Cl(C),u_dem_tl_prev:new zl(C),u_dem_scale_prev:new Cl(C),u_dem_size:new Cl(C),u_dem_lerp:new Cl(C),u_exaggeration:new Cl(C),u_depth:new Il(C),u_depth_size_inv:new zl(C),u_meter_to_dem:new Cl(C),u_label_plane_matrix_inv:new kl(C)}))(C)),he.includes("GLOBE")&&(this.globeUniforms=(C=>({u_tile_tl_up:new Dl(C),u_tile_tr_up:new Dl(C),u_tile_br_up:new Dl(C),u_tile_bl_up:new Dl(C),u_tile_up_scale:new Cl(C)}))(C)),he.includes("FOG")&&(this.fogUniforms=(C=>({u_fog_matrix:new kl(C),u_fog_range:new zl(C),u_fog_color:new Pl(C),u_fog_horizon_blend:new Cl(C),u_fog_vertical_limit:new zl(C),u_fog_temporal_offset:new Cl(C),u_frustum_tl:new Dl(C),u_frustum_tr:new Dl(C),u_frustum_br:new Dl(C),u_frustum_bl:new Dl(C),u_globe_pos:new Dl(C),u_globe_radius:new Cl(C),u_globe_transition:new Cl(C),u_is_globe:new Il(C),u_viewport:new zl(C)}))(C)),he.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(C=>({u_cutoff_params:new Pl(C)}))(C)),he.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(C=>({u_lighting_ambient_color:new Dl(C),u_lighting_directional_dir:new Dl(C),u_lighting_directional_color:new Dl(C),u_ground_radiance:new Dl(C)}))(C)),he.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(C=>({u_light_matrix_0:new kl(C),u_light_matrix_1:new kl(C),u_fade_range:new zl(C),u_shadow_normal_offset:new Dl(C),u_shadow_intensity:new Cl(C),u_shadow_texel_size:new Cl(C),u_shadow_map_resolution:new Cl(C),u_shadow_direction:new Dl(C),u_shadow_bias:new Dl(C),u_shadowmap_0:new Il(C),u_shadowmap_1:new Il(C)}))(C))}}setTerrainUniformValues(C,H){if(!this.terrainUniforms)return;const te=this.terrainUniforms;if(!this.failedToCreate){C.program.set(this.program);for(const C in H)te[C]&&te[C].set(this.program,C,H[C])}}setGlobeUniformValues(C,H){if(!this.globeUniforms)return;const te=this.globeUniforms;if(!this.failedToCreate){C.program.set(this.program);for(const C in H)te[C]&&te[C].set(this.program,C,H[C])}}setFogUniformValues(C,H){if(!this.fogUniforms)return;const te=this.fogUniforms;if(!this.failedToCreate){C.program.set(this.program);for(const C in H)te[C].set(this.program,C,H[C])}}setCutoffUniformValues(C,H){if(!this.cutoffUniforms)return;const te=this.cutoffUniforms;if(!this.failedToCreate){C.program.set(this.program);for(const C in H)te[C].set(this.program,C,H[C])}}setLightsUniformValues(C,H){if(!this.lightsUniforms)return;const te=this.lightsUniforms;if(!this.failedToCreate){C.program.set(this.program);for(const C in H)te[C].set(this.program,C,H[C])}}setShadowUniformValues(C,H){if(this.failedToCreate||!this.shadowUniforms)return;const te=this.shadowUniforms;C.program.set(this.program);for(const C in H)te[C].set(this.program,C,H[C])}_drawDebugWireframe(C,H,te,le,ce,he,ue,de,_e,ye){const ve=C.options.wireframe;if(!1===ve.terrain&&!1===ve.layers2D&&!1===ve.layers3D)return;const Me=C.context;if(!(()=>!(!ve.terrain||"terrainRaster"!==this.name&&"globeRaster"!==this.name)||!(!ve.layers2D||C._terrain&&C._terrain.renderingToTexture||!YS.includes(this.name))||!(!ve.layers3D||!JS.includes(this.name)))())return;const Se=Me.gl,Ae=C.wireframeDebugCache.getLinesFromTrianglesBuffer(C.frameCounter,ce,Me);if(!Ae)return;const Ce=[...this.fixedDefines];Ce.push("DEBUG_WIREFRAME");const Oe=C.getOrCreateProgram(this.name,{config:this.configuration,defines:Ce});Me.program.set(Oe.program);const _=(C,H,te)=>{if(H[C]&&te[C])for(const le in H[C])te[C][le]&&te[C][le].set(te.program,le,H[C][le].current)};_e&&_e.setUniforms(Oe.program,Me,Oe.binderUniforms,ue,{zoom:de}),_("fixedUniforms",this,Oe),_("terrainUniforms",this,Oe),_("globeUniforms",this,Oe),_("fogUniforms",this,Oe),_("lightsUniforms",this,Oe),_("shadowUniforms",this,Oe),Ae.bind(),Me.setColorMode(new bx([Se.ONE,Se.ONE_MINUS_SRC_ALPHA,Se.ZERO,Se.ONE],kr.transparent,[!0,!0,!0,!1])),Me.setDepthMode(new gx(H.func===Se.LESS?Se.LEQUAL:H.func,gx.ReadOnly,H.range)),Me.setStencilMode(xx.disabled);const Ne=3*he.primitiveLength*2,je=3*he.primitiveOffset*2*2;ye&&ye>1?Se.drawElementsInstanced(Se.LINES,Ne,Se.UNSIGNED_SHORT,je,ye):Se.drawElements(Se.LINES,Ne,Se.UNSIGNED_SHORT,je),ce.bind(),Me.program.set(this.program),Me.setDepthMode(H),Me.setStencilMode(te),Me.setColorMode(le)}draw(C,H,te,le,ce,he,ue,de,_e,ye,ve,Me,Se,Ae,Ce,Oe){const Ne=C.context,je=Ne.gl;if(this.failedToCreate)return;Ne.program.set(this.program),Ne.setDepthMode(te),Ne.setStencilMode(le),Ne.setColorMode(ce),Ne.setCullFace(he);for(const C of Object.keys(this.fixedUniforms))this.fixedUniforms[C].set(this.program,C,ue[C]);Ae&&Ae.setUniforms(this.program,Ne,this.binderUniforms,Me,{zoom:Se});const Ge={[je.LINES]:2,[je.TRIANGLES]:3,[je.LINE_STRIP]:1}[H],Ze=Oe&&Oe>0?1:void 0;for(const he of ve.get()){const ue=he.vaos||(he.vaos={});(ue[de]||(ue[de]=new FE)).bind(Ne,this,_e,Ae?Ae.getPaintVertexBuffers():[],ye,he.vertexOffset,Ce||[],Ze),Oe&&Oe>1?je.drawElementsInstanced(H,he.primitiveLength*Ge,je.UNSIGNED_SHORT,he.primitiveOffset*Ge*2,Oe):je.drawElements(H,he.primitiveLength*Ge,je.UNSIGNED_SHORT,he.primitiveOffset*Ge*2),H===je.TRIANGLES&&this._drawDebugWireframe(C,te,le,ce,ye,he,Me,Se,Ae,Oe)}}}function lM(C,H){const te=Math.pow(2,H.tileID.overscaledZ),le=H.tileSize*Math.pow(2,C.transform.tileZoom)/te,ce=le*(H.tileID.canonical.x+H.tileID.wrap*te),he=le*H.tileID.canonical.y;return{u_image:0,u_texsize:H.imageAtlasTexture.size,u_tile_units_to_pixels:1/Xx(H,1,C.transform.tileZoom),u_pixel_coord_upper:[ce>>16,he>>16],u_pixel_coord_lower:[65535&ce,65535&he]}}const QS=ed.create(),hM=(C,H,te,le,ce,he,ue,de,_e,ye,ve,Me,Se,Ae,Ce)=>{const Oe=H.style.light,Ne=Oe.properties.get("position"),je=[Ne.x,Ne.y,Ne.z],Ge=Ju.create();"viewport"===Oe.properties.get("anchor")&&(Ju.fromRotation(Ge,-H.transform.angle),Ld.transformMat3(je,je,Ge));const Ze=Oe.properties.get("color"),qe=H.transform,$e={u_matrix:C,u_lightpos:je,u_lightintensity:Oe.properties.get("intensity"),u_lightcolor:[Ze.r,Ze.g,Ze.b],u_vertical_gradient:+te,u_opacity:le,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:QS,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_ao:ce,u_edge_radius:he,u_flood_light_color:Me,u_vertical_scale:Se,u_flood_light_intensity:Ae,u_ground_shadow_factor:Ce};return"globe"===qe.projection.name&&($e.u_tile_id=[ue.canonical.x,ue.canonical.y,1<<ue.canonical.z],$e.u_zoom_transition=_e,$e.u_inv_rot_matrix=ve,$e.u_merc_center=ye,$e.u_up_dir=qe.projection.upVector(new ku(0,0,0),ye[0]*wn,ye[1]*wn),$e.u_height_lift=de),$e},uM=(C,H,te)=>({u_matrix:C,u_edge_radius:H,u_vertical_scale:te}),dM=(C,H,te,le,ce,he,ue,de,_e,ye,ve,Me,Se,Ae)=>{const Ce=hM(C,H,te,le,ce,he,ue,_e,ye,ve,Me,Se,Ae,1,[0,0,0]),Oe={u_height_factor:-Math.pow(2,ue.overscaledZ)/de.tileSize/8};return k(Ce,lM(H,de),Oe)},pM=(C,H)=>({u_matrix:C,u_emissive_strength:H}),fM=(C,H,te,le)=>k(pM(C,H),lM(te,le)),mM=(C,H,te)=>({u_matrix:C,u_world:te,u_emissive_strength:H}),_M=(C,H,te,le,ce)=>k(fM(C,H,te,le),{u_world:ce}),gM=(C,H,te,le)=>{const ce=wn/te.tileSize;return{u_matrix:C,u_camera_to_center_distance:H.getCameraToCenterDistance(le),u_extrude_scale:[H.pixelsToGLUnits[0]/ce,H.pixelsToGLUnits[1]/ce]}},yM=(C,H,te=1)=>({u_matrix:C,u_color:H,u_overlay:0,u_overlay_scale:te}),eA=ed.create(),vM=(C,H,te,le,ce,he,ue)=>{const de=C.transform,_e="globe"===de.projection.name,ye=_e?wd(de.zoom,H.canonical)*de._pixelsPerMercatorPixel:Xx(te,1,he),ve={u_matrix:H.projMatrix,u_extrude_scale:ye,u_intensity:ue,u_inv_rot_matrix:eA,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(_e){ve.u_inv_rot_matrix=le,ve.u_merc_center=ce,ve.u_tile_id=[H.canonical.x,H.canonical.y,1<<H.canonical.z],ve.u_zoom_transition=Ed(de.zoom);const C=ce[0]*wn,te=ce[1]*wn;ve.u_up_dir=de.projection.upVector(new ku(0,0,0),C,te)}return ve},bM=(C,H,te,le,ce,he,ue,de,_e,ye,ve)=>{return{u_matrix:C,u_normalize_matrix:H,u_globe_matrix:te,u_tl_parent:le,u_scale_parent:ce,u_fade_t:he.mix,u_opacity:he.opacity*ue.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:ue.paint.get("raster-brightness-min"),u_brightness_high:ue.paint.get("raster-brightness-max"),u_saturation_factor:(Se=ue.paint.get("raster-saturation"),Se>0?1-1/(1.001-Se):-Se),u_contrast_factor:(Me=ue.paint.get("raster-contrast"),Me>0?1/(1-Me):1+Me),u_spin_weights:wM(ue.paint.get("raster-hue-rotate")),u_perspective_transform:de,u_colorization_mix:ye,u_colorization_scale:TM(ve),u_color_ramp:_e};var Me,Se};function wM(C){C*=Math.PI/180;const H=Math.sin(C),te=Math.cos(C);return[(2*te+1)/3,(-Math.sqrt(3)*H-te+1)/3,(Math.sqrt(3)*H-te+1)/3]}function TM([C,H]){if(C===H)return[C,H];const te=(H+C)/2,le=(H-C)/2*256/255;return[-(C=te-le)/((H=te+le)-C),1/(H-C)]}const tA=ed.create(),MM=(C,H,te,le,ce,he,ue,de,_e,ye,ve,Me,Se,Ae,Ce,Oe,Ne)=>{const je=ce.transform,Ge={u_is_size_zoom_constant:+("constant"===C||"source"===C),u_is_size_feature_constant:+("constant"===C||"camera"===C),u_size_t:H?H.uSizeT:0,u_size:H?H.uSize:0,u_camera_to_center_distance:je.getCameraToCenterDistance(Oe),u_rotate_symbol:+te,u_aspect_ratio:je.width/je.height,u_fade_change:ce.options.fadeDuration?ce.symbolFadeChange:1,u_matrix:he,u_label_plane_matrix:ue,u_coord_matrix:de,u_is_text:+_e,u_pitch_with_map:+le,u_texsize:ye,u_texture:0,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:tA,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:tA,u_up_vector:[0,-1,0],u_icon_transition:Ne||0};return"globe"===Oe.name&&(Ge.u_tile_id=[ve.canonical.x,ve.canonical.y,1<<ve.canonical.z],Ge.u_zoom_transition=Me,Ge.u_inv_rot_matrix=Ae,Ge.u_merc_center=Se,Ge.u_camera_forward=je._camera.forward(),Ge.u_ecef_origin=function(C,H){const te=[0,0,0],le=xd(ad(H.canonical));return Ld.transformMat4(te,te,le),Ld.transformMat4(te,te,C),te}(je.globeMatrix,ve.toUnwrapped()),Ge.u_tile_matrix=Float32Array.from(je.globeMatrix),Ge.u_up_vector=Ce),Ge},AM=(C,H,te,le,ce,he,ue,de,_e,ye,ve,Me,Se,Ae,Ce,Oe,Ne)=>k(MM(C,H,te,le,ce,he,ue,de,_e,ye,Me,Se,Ae,Ce,Oe,Ne),{u_gamma_scale:le?ce.transform.getCameraToCenterDistance(Ne)*Math.cos(ce.terrain?0:ce.transform._pitch):1,u_device_pixel_ratio:yi.devicePixelRatio,u_is_halo:+ve,undefined:void 0}),SM=(C,H,te,le,ce,he,ue,de,_e,ye,ve,Me,Se,Ae,Ce,Oe)=>k(AM(C,H,te,le,ce,he,ue,de,!0,_e,!0,ve,Me,Se,Ae,Ce,Oe),{u_texsize_icon:ye,u_texture_icon:1}),IM=(C,H,te,le)=>({u_matrix:C,u_emissive_strength:H,u_opacity:te,u_color:le}),CM=(C,H,te,le,ce,he,ue)=>k(function(C,H,te,le){const ce=te.imageManager.getPattern(C.toString(),H),{width:he,height:ue}=te.imageManager.getPixelSize(H),de=Math.pow(2,le.tileID.overscaledZ),_e=le.tileSize*Math.pow(2,te.transform.tileZoom)/de,ye=_e*(le.tileID.canonical.x+le.tileID.wrap*de),ve=_e*le.tileID.canonical.y;return{u_image:0,u_pattern_tl:ce.tl,u_pattern_br:ce.br,u_texsize:[he,ue],u_pattern_size:ce.displaySize,u_tile_units_to_pixels:1/Xx(le,1,te.transform.tileZoom),u_pixel_coord_upper:[ye>>16,ve>>16],u_pixel_coord_lower:[65535&ye,65535&ve]}}(ce,he,le,ue),{u_matrix:C,u_emissive_strength:H,u_opacity:te}),sA={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,ShadowMap0:10},DM=(C,H,te,le,ce,he,ue,de,_e,ye,ve,Me=[0,0,0])=>{const Se=le.style.light,Ae=Se.properties.get("position"),Ce=[-Ae.x,-Ae.y,Ae.z],Oe=Ju.create();"viewport"===Se.properties.get("anchor")&&(Ju.fromRotation(Oe,-le.transform.angle),Ld.transformMat3(Ce,Ce,Oe));const Ne="MASK"===ye.alphaMode,je=Se.properties.get("color"),Ge=ve.paint.get("model-ambient-occlusion-intensity"),Ze=ve.paint.get("model-color").constantOr(kr.white),qe=ve.paint.get("model-color-mix-intensity").constantOr(0);return{u_matrix:C,u_lighting_matrix:H,u_normal_matrix:te,u_lightpos:Ce,u_lightintensity:Se.properties.get("intensity"),u_lightcolor:[je.r,je.g,je.b],u_camera_pos:Me,u_opacity:ce,u_baseTextureIsAlpha:0,u_alphaMask:+Ne,u_alphaCutoff:ye.alphaCutoff,u_baseColorFactor:[he.r,he.g,he.b,he.a],u_emissiveFactor:[ue[0],ue[1],ue[2],1],u_metallicFactor:de,u_roughnessFactor:_e,u_baseColorTexture:sA.BaseColor,u_metallicRoughnessTexture:sA.MetallicRoughness,u_normalTexture:sA.Normal,u_occlusionTexture:sA.Occlusion,u_emissionTexture:sA.Emission,u_color_mix:[Ze.r,Ze.g,Ze.b,qe],u_aoIntensity:Ge}},aA=new Float32Array(16),RM=(C,H=aA,te=aA)=>({u_matrix:C,u_instance:H,u_node_matrix:te}),uA={fillExtrusion:C=>({u_matrix:new kl(C),u_lightpos:new Dl(C),u_lightintensity:new Cl(C),u_lightcolor:new Dl(C),u_vertical_gradient:new Cl(C),u_opacity:new Cl(C),u_edge_radius:new Cl(C),u_ao:new zl(C),u_tile_id:new Dl(C),u_zoom_transition:new Cl(C),u_inv_rot_matrix:new kl(C),u_merc_center:new zl(C),u_up_dir:new Dl(C),u_height_lift:new Cl(C),u_flood_light_color:new Dl(C),u_vertical_scale:new Cl(C),u_flood_light_intensity:new Cl(C),u_ground_shadow_factor:new Dl(C)}),fillExtrusionDepth:C=>({u_matrix:new kl(C),u_edge_radius:new Cl(C),u_vertical_scale:new Cl(C)}),fillExtrusionPattern:C=>({u_matrix:new kl(C),u_lightpos:new Dl(C),u_lightintensity:new Cl(C),u_lightcolor:new Dl(C),u_vertical_gradient:new Cl(C),u_height_factor:new Cl(C),u_edge_radius:new Cl(C),u_ao:new zl(C),u_tile_id:new Dl(C),u_zoom_transition:new Cl(C),u_inv_rot_matrix:new kl(C),u_merc_center:new zl(C),u_up_dir:new Dl(C),u_height_lift:new Cl(C),u_image:new Il(C),u_texsize:new zl(C),u_pixel_coord_upper:new zl(C),u_pixel_coord_lower:new zl(C),u_tile_units_to_pixels:new Cl(C),u_opacity:new Cl(C)}),fillExtrusionGroundEffect:C=>({u_matrix:new kl(C),u_opacity:new Cl(C),u_ao_pass:new Cl(C),u_meter_to_tile:new Cl(C),u_ao:new zl(C),u_flood_light_intensity:new Cl(C),u_flood_light_color:new Dl(C),u_attenuation:new Cl(C),u_edge_radius:new Cl(C),u_fb:new Il(C),u_fb_size:new Cl(C)}),fill:C=>({u_matrix:new kl(C),u_emissive_strength:new Cl(C)}),fillPattern:C=>({u_matrix:new kl(C),u_emissive_strength:new Cl(C),u_image:new Il(C),u_texsize:new zl(C),u_pixel_coord_upper:new zl(C),u_pixel_coord_lower:new zl(C),u_tile_units_to_pixels:new Cl(C)}),fillOutline:C=>({u_matrix:new kl(C),u_emissive_strength:new Cl(C),u_world:new zl(C)}),fillOutlinePattern:C=>({u_matrix:new kl(C),u_emissive_strength:new Cl(C),u_world:new zl(C),u_image:new Il(C),u_texsize:new zl(C),u_pixel_coord_upper:new zl(C),u_pixel_coord_lower:new zl(C),u_tile_units_to_pixels:new Cl(C)}),circle:C=>({u_camera_to_center_distance:new Cl(C),u_extrude_scale:new Nl(C),u_device_pixel_ratio:new Cl(C),u_matrix:new kl(C),u_inv_rot_matrix:new kl(C),u_merc_center:new zl(C),u_tile_id:new Dl(C),u_zoom_transition:new Cl(C),u_up_dir:new Dl(C),u_emissive_strength:new Cl(C)}),collisionBox:C=>({u_matrix:new kl(C),u_camera_to_center_distance:new Cl(C),u_extrude_scale:new zl(C)}),collisionCircle:C=>({u_matrix:new kl(C),u_inv_matrix:new kl(C),u_camera_to_center_distance:new Cl(C),u_viewport_size:new zl(C)}),debug:C=>({u_color:new Rl(C),u_matrix:new kl(C),u_overlay:new Il(C),u_overlay_scale:new Cl(C)}),clippingMask:C=>({u_matrix:new kl(C)}),heatmap:C=>({u_extrude_scale:new Cl(C),u_intensity:new Cl(C),u_matrix:new kl(C),u_inv_rot_matrix:new kl(C),u_merc_center:new zl(C),u_tile_id:new Dl(C),u_zoom_transition:new Cl(C),u_up_dir:new Dl(C)}),heatmapTexture:C=>({u_image:new Il(C),u_color_ramp:new Il(C),u_opacity:new Cl(C)}),hillshade:C=>({u_matrix:new kl(C),u_image:new Il(C),u_latrange:new zl(C),u_light:new zl(C),u_shadow:new Rl(C),u_highlight:new Rl(C),u_emissive_strength:new Cl(C),u_accent:new Rl(C)}),hillshadePrepare:C=>({u_matrix:new kl(C),u_image:new Il(C),u_dimension:new zl(C),u_zoom:new Cl(C),u_unpack:new Pl(C)}),line:C=>({u_matrix:new kl(C),u_pixels_to_tile_units:new Nl(C),u_device_pixel_ratio:new Cl(C),u_units_to_pixels:new zl(C),u_dash_image:new Il(C),u_gradient_image:new Il(C),u_image_height:new Cl(C),u_texsize:new zl(C),u_tile_units_to_pixels:new Cl(C),u_alpha_discard_threshold:new Cl(C),u_trim_offset:new zl(C),u_emissive_strength:new Cl(C)}),linePattern:C=>({u_matrix:new kl(C),u_texsize:new zl(C),u_pixels_to_tile_units:new Nl(C),u_device_pixel_ratio:new Cl(C),u_image:new Il(C),u_units_to_pixels:new zl(C),u_tile_units_to_pixels:new Cl(C),u_alpha_discard_threshold:new Cl(C)}),raster:C=>({u_matrix:new kl(C),u_normalize_matrix:new kl(C),u_globe_matrix:new kl(C),u_tl_parent:new zl(C),u_scale_parent:new Cl(C),u_fade_t:new Cl(C),u_opacity:new Cl(C),u_image0:new Il(C),u_image1:new Il(C),u_brightness_low:new Cl(C),u_brightness_high:new Cl(C),u_saturation_factor:new Cl(C),u_contrast_factor:new Cl(C),u_spin_weights:new Dl(C),u_perspective_transform:new zl(C),u_colorization_mix:new Pl(C),u_colorization_scale:new zl(C),u_color_ramp:new Il(C)}),symbolIcon:C=>({u_is_size_zoom_constant:new Il(C),u_is_size_feature_constant:new Il(C),u_size_t:new Cl(C),u_size:new Cl(C),u_camera_to_center_distance:new Cl(C),u_rotate_symbol:new Il(C),u_aspect_ratio:new Cl(C),u_fade_change:new Cl(C),u_matrix:new kl(C),u_label_plane_matrix:new kl(C),u_coord_matrix:new kl(C),u_is_text:new Il(C),u_pitch_with_map:new Il(C),u_texsize:new zl(C),u_tile_id:new Dl(C),u_zoom_transition:new Cl(C),u_inv_rot_matrix:new kl(C),u_merc_center:new zl(C),u_camera_forward:new Dl(C),u_tile_matrix:new kl(C),u_up_vector:new Dl(C),u_ecef_origin:new Dl(C),u_texture:new Il(C),u_icon_transition:new Cl(C)}),symbolSDF:C=>({u_is_size_zoom_constant:new Il(C),u_is_size_feature_constant:new Il(C),u_size_t:new Cl(C),u_size:new Cl(C),u_camera_to_center_distance:new Cl(C),u_rotate_symbol:new Il(C),u_aspect_ratio:new Cl(C),u_fade_change:new Cl(C),u_matrix:new kl(C),u_label_plane_matrix:new kl(C),u_coord_matrix:new kl(C),u_is_text:new Il(C),u_pitch_with_map:new Il(C),u_texsize:new zl(C),u_texture:new Il(C),u_gamma_scale:new Cl(C),u_device_pixel_ratio:new Cl(C),u_tile_id:new Dl(C),u_zoom_transition:new Cl(C),u_inv_rot_matrix:new kl(C),u_merc_center:new zl(C),u_camera_forward:new Dl(C),u_tile_matrix:new kl(C),u_up_vector:new Dl(C),u_ecef_origin:new Dl(C),u_is_halo:new Il(C)}),symbolTextAndIcon:C=>({u_is_size_zoom_constant:new Il(C),u_is_size_feature_constant:new Il(C),u_size_t:new Cl(C),u_size:new Cl(C),u_camera_to_center_distance:new Cl(C),u_rotate_symbol:new Il(C),u_aspect_ratio:new Cl(C),u_fade_change:new Cl(C),u_matrix:new kl(C),u_label_plane_matrix:new kl(C),u_coord_matrix:new kl(C),u_is_text:new Il(C),u_pitch_with_map:new Il(C),u_texsize:new zl(C),u_texsize_icon:new zl(C),u_texture:new Il(C),u_texture_icon:new Il(C),u_gamma_scale:new Cl(C),u_device_pixel_ratio:new Cl(C),u_is_halo:new Il(C)}),background:C=>({u_matrix:new kl(C),u_emissive_strength:new Cl(C),u_opacity:new Cl(C),u_color:new Rl(C)}),backgroundPattern:C=>({u_matrix:new kl(C),u_emissive_strength:new Cl(C),u_opacity:new Cl(C),u_image:new Il(C),u_pattern_tl:new zl(C),u_pattern_br:new zl(C),u_texsize:new zl(C),u_pattern_size:new zl(C),u_pixel_coord_upper:new zl(C),u_pixel_coord_lower:new zl(C),u_tile_units_to_pixels:new Cl(C)}),terrainRaster:GE,terrainDepth:GE,skybox:C=>({u_matrix:new kl(C),u_sun_direction:new Dl(C),u_cubemap:new Il(C),u_opacity:new Cl(C),u_temporal_offset:new Cl(C)}),skyboxGradient:C=>({u_matrix:new kl(C),u_color_ramp:new Il(C),u_center_direction:new Dl(C),u_radius:new Cl(C),u_opacity:new Cl(C),u_temporal_offset:new Cl(C)}),skyboxCapture:C=>({u_matrix_3f:new Bl(C),u_sun_direction:new Dl(C),u_sun_intensity:new Cl(C),u_color_tint_r:new Pl(C),u_color_tint_m:new Pl(C),u_luminance:new Cl(C)}),globeRaster:C=>({u_proj_matrix:new kl(C),u_globe_matrix:new kl(C),u_normalize_matrix:new kl(C),u_merc_matrix:new kl(C),u_zoom_transition:new Cl(C),u_merc_center:new zl(C),u_image0:new Il(C),u_grid_matrix:new Bl(C),u_skirt_height:new Cl(C),u_frustum_tl:new Dl(C),u_frustum_tr:new Dl(C),u_frustum_br:new Dl(C),u_frustum_bl:new Dl(C),u_globe_pos:new Dl(C),u_globe_radius:new Cl(C),u_viewport:new zl(C)}),globeAtmosphere:C=>({u_frustum_tl:new Dl(C),u_frustum_tr:new Dl(C),u_frustum_br:new Dl(C),u_frustum_bl:new Dl(C),u_horizon:new Cl(C),u_transition:new Cl(C),u_fadeout_range:new Cl(C),u_color:new Pl(C),u_high_color:new Pl(C),u_space_color:new Pl(C),u_temporal_offset:new Cl(C),u_horizon_angle:new Cl(C)}),model:C=>({u_matrix:new kl(C),u_lighting_matrix:new kl(C),u_normal_matrix:new kl(C),u_lightpos:new Dl(C),u_lightintensity:new Cl(C),u_lightcolor:new Dl(C),u_camera_pos:new Dl(C),u_opacity:new Cl(C),u_baseColorFactor:new Pl(C),u_emissiveFactor:new Pl(C),u_metallicFactor:new Cl(C),u_roughnessFactor:new Cl(C),u_baseTextureIsAlpha:new Il(C),u_alphaMask:new Il(C),u_alphaCutoff:new Cl(C),u_baseColorTexture:new Il(C),u_metallicRoughnessTexture:new Il(C),u_normalTexture:new Il(C),u_occlusionTexture:new Il(C),u_emissionTexture:new Il(C),u_color_mix:new Pl(C),u_aoIntensity:new Cl(C)}),modelDepth:C=>({u_matrix:new kl(C),u_instance:new kl(C),u_node_matrix:new kl(C)}),groundShadow:C=>({u_matrix:new kl(C),u_ground_shadow_factor:new Dl(C)}),stars:C=>({u_matrix:new kl(C),u_up:new Dl(C),u_right:new Dl(C),u_intensity_multiplier:new Cl(C)})};let pA;function OM(C,H,te,le,ce,he,ue){const de=C.context,_e=de.gl,ye=C.transform,ve=C.getOrCreateProgram("collisionBox"),Me=[];let Se=0,Ae=0;for(let de=0;de<le.length;de++){const Ce=le[de],Oe=H.getTile(Ce),Ne=Oe.getBucket(te);if(!Ne)continue;const je=jT(Ce,Ne,ye);let Ge=je;0===ce[0]&&0===ce[1]||(Ge=C.translatePosMatrix(je,Oe,ce,he));const Ze=ue?Ne.textCollisionBox:Ne.iconCollisionBox,qe=Ne.collisionCircleArray;if(qe.length>0){const C=ed.create(),H=Ge;ed.mul(C,Ne.placementInvProjMatrix,ye.glCoordMatrix),ed.mul(C,C,Ne.placementViewportMatrix),Me.push({circleArray:qe,circleOffset:Ae,transform:H,invTransform:C,projection:Ne.getProjection()}),Se+=qe.length/4,Ae=Se}Ze&&(C.terrain&&C.terrain.setupElevationDraw(Oe,ve),ve.draw(C,_e.LINES,gx.disabled,xx.disabled,C.colorModeForRenderPass(),Ex.disabled,gM(Ge,ye,Oe,Ne.getProjection()),te.id,Ze.layoutVertexBuffer,Ze.indexBuffer,Ze.segments,null,ye.zoom,null,[Ze.collisionVertexBuffer,Ze.collisionVertexBufferExt]))}if(!ue||!Me.length)return;const Ce=C.getOrCreateProgram("collisionCircle"),Oe=new Fa;Oe.resize(4*Se),Oe._trim();let Ne=0;for(const C of Me)for(let H=0;H<C.circleArray.length/4;H++){const te=4*H,le=C.circleArray[te+0],ce=C.circleArray[te+1],he=C.circleArray[te+2],ue=C.circleArray[te+3];Oe.emplace(Ne++,le,ce,he,ue,0),Oe.emplace(Ne++,le,ce,he,ue,1),Oe.emplace(Ne++,le,ce,he,ue,2),Oe.emplace(Ne++,le,ce,he,ue,3)}(!pA||pA.length<2*Se)&&(pA=function(C){const H=2*C,te=new Va;te.resize(H),te._trim();for(let C=0;C<H;C++){const H=6*C;te.uint16[H+0]=4*C+0,te.uint16[H+1]=4*C+1,te.uint16[H+2]=4*C+2,te.uint16[H+3]=4*C+2,te.uint16[H+4]=4*C+3,te.uint16[H+5]=4*C+0}return te}(Se));const je=de.createIndexBuffer(pA,!0),Ge=de.createVertexBuffer(Oe,zg.members,!0);for(const H of Me){const le={u_matrix:H.transform,u_inv_matrix:H.invTransform,u_camera_to_center_distance:(Ze=ye).getCameraToCenterDistance(H.projection),u_viewport_size:[Ze.width,Ze.height]};Ce.draw(C,_e.TRIANGLES,gx.disabled,xx.disabled,C.colorModeForRenderPass(),Ex.disabled,le,te.id,Ge,je,dl.simpleSegment(0,2*H.circleOffset,H.circleArray.length,H.circleArray.length/2),null,ye.zoom)}var Ze;Ge.destroy(),je.destroy()}const bA=ed.create();function FM({width:C,height:H,anchor:te,textOffset:le,textScale:ce},he){const{horizontalAlign:ue,verticalAlign:de}=L_(te),_e=-(ue-.5)*C,ye=-(de-.5)*H,ve=ug(te,le);return new Ne((_e/ce+ve[0])*he,(ye/ce+ve[1])*he)}function NM(C,H,te,le,ce,he,ue,de,_e,ye,ve){const Me=C.text.placedSymbolArray,Se=C.text.dynamicLayoutVertexArray,Ae=C.icon.dynamicLayoutVertexArray,Ce={},Oe=C.getProjection(),Ne=GT(de,Oe,he),je=he.elevation,Ge=Oe.upVectorScale(de.canonical,he.center.lat,he.worldSize).metersToTile;Se.clear();for(let Ae=0;Ae<Me.length;Ae++){const Ze=Me.get(Ae),{tileAnchorX:qe,tileAnchorY:$e,numGlyphs:We}=Ze,He=Ze.hidden||!Ze.crossTileID||C.allowVerticalPlacement&&!Ze.placedOrientation?null:le[Ze.crossTileID];if(He){let le=0,Me=0,Ae=0;if(je){const C=je?je.getAtTileOffset(de,qe,$e):0,[H,te,ce]=Oe.upVector(de.canonical,qe,$e);le=C*H*Ge,Me=C*te*Ge,Ae=C*ce*Ge}let[Xe,Ye,Je,Qe]=tv(Ze.projectedAnchorX+le,Ze.projectedAnchorY+Me,Ze.projectedAnchorZ+Ae,te?Ne:ue);const tt=iv(he.getCameraToCenterDistance(Oe),Qe);let rt=ce.evaluateSizeForFeature(C.textSizeData,ye,Ze)*tt/Dg;te&&(rt*=C.tilePixelRatio/_e);const ot=FM(He,rt);te?(({x:Xe,y:Ye,z:Je}=Oe.projectTilePoint(qe+ot.x,$e+ot.y,de.canonical)),[Xe,Ye,Je]=tv(Xe+le,Ye+Me,Je+Ae,ue)):(H&&ot._rotate(-he.angle),Xe+=ot.x,Ye+=ot.y,Je=0);const st=C.allowVerticalPlacement&&Ze.placedOrientation===Wg.vertical?Math.PI/2:0;for(let C=0;C<We;C++)ny(Se,Xe,Ye,Je,st);ve&&Ze.associatedIconIndex>=0&&(Ce[Ze.associatedIconIndex]={x:Xe,y:Ye,z:Je,angle:st})}else uv(We,Se)}if(ve){Ae.clear();const H=C.icon.placedSymbolArray;for(let C=0;C<H.length;C++){const te=H.get(C),{numGlyphs:le}=te,ce=Ce[C];if(te.hidden||!ce)uv(le,Ae);else{const{x:C,y:H,z:te,angle:he}=ce;for(let ce=0;ce<le;ce++)ny(Ae,C,H,te,he)}}C.icon.dynamicLayoutVertexBuffer.updateData(Ae)}C.text.dynamicLayoutVertexBuffer.updateData(Se)}function UM(C,H,te){return te.iconsInText&&H?"symbolTextAndIcon":C?"symbolSDF":"symbolIcon"}function VM(C,H,te,le,ce,he,ue,de,_e,ye,ve,Me){const Se=C.context,Ae=Se.gl,Ce=C.transform,Oe="map"===de,Ne="map"===_e,je=Oe&&"point"!==te.layout.get("symbol-placement"),Ge=Oe&&!Ne&&!je,Ze=void 0!==te.layout.get("symbol-sort-key").constantOr(1);let qe=!1;const $e=C.depthModeForSublayer(0,gx.ReadOnly),We=[Gd(Ce.center.lng),qd(Ce.center.lat)],He=te.layout.get("text-variable-anchor"),Xe="globe"===Ce.projection.name,Ye=[],Je=[0,-1,0];let Qe=Je;!Xe&&!Ce.mercatorFromTransition||Oe||(Qe=function(C){const H=C._camera.getWorldToCamera(C.worldSize,1),te=ed.multiply([],H,C.globeMatrix);ed.invert(te,te);const le=[0,0,0],ce=[0,1,0,0];return Lu.transformMat4(ce,ce,te),le[0]=ce[0],le[1]=ce[1],le[2]=ce[2],Ld.normalize(le,le),le}(Ce));for(const de of le){const le=H.getTile(de),_e=le.getBucket(te);if(!_e)continue;if("mercator"===_e.projection.name&&Xe)continue;const ve=ce?_e.text:_e.icon;if(!ve||_e.fullyClipped||!ve.segments.get().length)continue;const Me=ve.programConfigurations.get(te.id),Se=ce||_e.sdfIcons,$e=ce?_e.textSizeData:_e.iconSizeData,tt=Ne||0!==Ce.pitch,rt=a_($e,Ce.zoom);let ot,st,at,lt,ct=[0,0],ht=null;if(ce)st=le.glyphAtlasTexture,at=Ae.LINEAR,ot=le.glyphAtlasTexture.size,_e.iconsInText&&(ct=le.imageAtlasTexture.size,ht=le.imageAtlasTexture,lt=tt||C.options.rotating||C.options.zooming||"composite"===$e.kind||"camera"===$e.kind?Ae.LINEAR:Ae.NEAREST);else{const H=1!==te.layout.get("icon-size").constantOr(0)||_e.iconsNeedLinear;st=le.imageAtlasTexture,at=Se||C.options.rotating||C.options.zooming||H||tt?Ae.LINEAR:Ae.NEAREST,ot=le.imageAtlasTexture.size}const pt="globe"===_e.projection.name,ft=pt?Qe:Je,mt=pt?Ed(Ce.zoom):0,Ct=GT(de,_e.getProjection(),Ce),Ot=Ce.calculatePixelsToTileUnitsMatrix(le),Ft=Jx(Ct,le.tileID.canonical,Ne,Oe,Ce,_e.getProjection(),Ot),Nt=C.terrain&&Ne&&je?ed.invert(ed.create(),Ft):bA,Ut=ev(Ct,le.tileID.canonical,Ne,Oe,Ce,_e.getProjection(),Ot),Vt=He&&_e.hasTextData(),jt=_e.hasIconTextFit()&&Vt&&_e.hasIconData();if(je){const H=Ce.elevation,te=H?H.getAtTileOffsetFunc(de,Ce.center.lat,Ce.worldSize,_e.getProjection()):null,he=Qx(Ct,le.tileID.canonical,Ne,Oe,Ce,_e.getProjection(),Ot);nv(_e,Ct,C,ce,he,Ut,Ne,ye,te,de)}const Gt=je||ce&&He||jt,Zt=C.translatePosMatrix(Ct,le,he,ue),qt=Gt?bA:Ft,$t=C.translatePosMatrix(Ut,le,he,ue,!0),Wt=_e.getProjection().createInversionMatrix(Ce,de.canonical),Ht=te.paint.get("icon-image-cross-fade").constantOr(0),Kt=[];C.terrainRenderModeElevated()&&Ne&&Kt.push("PITCH_WITH_MAP_TERRAIN"),pt&&(Kt.push("PROJECTION_GLOBE_VIEW"),Gt&&Kt.push("PROJECTED_POS_ON_VIEWPORT")),Ht>0&&Kt.push("ICON_TRANSITION"),ve.zOffsetVertexBuffer&&Kt.push("Z_OFFSET");const ti=Se&&0!==te.paint.get(ce?"text-halo-width":"icon-halo-width").constantOr(1);let ii;ii=Se?_e.iconsInText?SM($e.kind,rt,Ge,Ne,C,Zt,qt,$t,ot,ct,de,mt,We,Wt,ft,_e.getProjection()):AM($e.kind,rt,Ge,Ne,C,Zt,qt,$t,ce,ot,!0,de,mt,We,Wt,ft,_e.getProjection()):MM($e.kind,rt,Ge,Ne,C,Zt,qt,$t,ce,ot,de,mt,We,Wt,ft,_e.getProjection(),Ht);const li={program:C.getOrCreateProgram(UM(Se,ce,_e),{config:Me,defines:Kt}),buffers:ve,uniformValues:ii,atlasTexture:st,atlasTextureIcon:ht,atlasInterpolation:at,atlasInterpolationIcon:lt,isSDF:Se,hasHalo:ti,tile:le,labelPlaneMatrixInv:Nt};if(Ze&&_e.canOverlap){qe=!0;const C=ve.segments.get();for(const H of C)Ye.push({segments:new dl([H]),sortKey:H.sortKey,state:li})}else Ye.push({segments:ve.segments,sortKey:0,state:li})}qe&&Ye.sort(((C,H)=>C.sortKey-H.sortKey));for(const H of Ye){const le=H.state;if(C.terrain&&C.terrain.setupElevationDraw(le.tile,le.program,{useDepthForOcclusion:Ce.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:le.labelPlaneMatrixInv}),Se.activeTexture.set(Ae.TEXTURE0),le.atlasTexture.bind(le.atlasInterpolation,Ae.CLAMP_TO_EDGE),le.atlasTextureIcon&&(Se.activeTexture.set(Ae.TEXTURE1),le.atlasTextureIcon&&le.atlasTextureIcon.bind(le.atlasInterpolationIcon,Ae.CLAMP_TO_EDGE)),C.uploadCommonLightUniforms(C.context,le.program),le.hasHalo){const ce=le.uniformValues;ce.u_is_halo=1,jM(le.buffers,H.segments,te,C,le.program,$e,ve,Me,ce,2),ce.u_is_halo=0}else{if(le.isSDF){const ce=le.uniformValues;le.hasHalo&&(ce.u_is_halo=1,jM(le.buffers,H.segments,te,C,le.program,$e,ve,Me,ce,1)),ce.u_is_halo=0}jM(le.buffers,H.segments,te,C,le.program,$e,ve,Me,le.uniformValues,1)}}}function jM(C,H,te,le,ce,he,ue,de,_e,ye){const ve=[C.dynamicLayoutVertexBuffer,C.opacityVertexBuffer,C.iconTransitioningVertexBuffer,C.globeExtVertexBuffer,C.zOffsetVertexBuffer];ce.draw(le,le.context.gl.TRIANGLES,he,ue,de,Ex.disabled,_e,te.id,C.layoutVertexBuffer,C.indexBuffer,H,te.paint,le.transform.zoom,C.programConfigurations.get(te.id),ve,ye)}function GM(C,H,te,le,ce,he,ue){const de=C.context.gl,_e=te.paint.get("fill-pattern"),ye=_e&&_e.constantOr(1);let ve,Me,Se,Ae,Ce;ue?(Me=ye&&!te.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",ve=de.LINES):(Me=ye?"fillPattern":"fill",ve=de.TRIANGLES);for(const Oe of le){const le=H.getTile(Oe);if(ye&&!le.patternsLoaded())continue;const Ne=le.getBucket(te);if(!Ne)continue;C.prepareDrawTile();const je=Ne.programConfigurations.get(te.id),Ge=C.isTileAffectedByFog(Oe),Ze=C.getOrCreateProgram(Me,{config:je,overrideFog:Ge});ye&&(C.context.activeTexture.set(de.TEXTURE0),le.imageAtlasTexture.bind(de.LINEAR,de.CLAMP_TO_EDGE),je.updatePaintBuffers());const qe=_e.constantOr(null);if(qe&&le.imageAtlas){const C=le.imageAtlas.patternPositions[qe.toString()];C&&je.setConstantPatternPositions(C)}const $e=C.translatePosMatrix(Oe.projMatrix,le,te.paint.get("fill-translate"),te.paint.get("fill-translate-anchor")),We=te.paint.get("fill-emissive-strength");if(ue){Ae=Ne.indexBuffer2,Ce=Ne.segments2;const H=C.terrain&&C.terrain.renderingToTexture?C.terrain.drapeBufferSize:[de.drawingBufferWidth,de.drawingBufferHeight];Se="fillOutlinePattern"===Me&&ye?_M($e,We,C,le,H):mM($e,We,H)}else Ae=Ne.indexBuffer,Ce=Ne.segments,Se=ye?fM($e,We,C,le):pM($e,We);C.uploadCommonUniforms(C.context,Ze,Oe.toUnwrapped()),Ze.draw(C,ve,ce,C.stencilModeForClipping(Oe),he,Ex.disabled,Se,te.id,Ne.layoutVertexBuffer,Ae,Ce,te.paint,C.transform.zoom,je,void 0)}}function qM(C,H,te,le,ce,he,ue,de){const _e=C.context,ye=_e.gl,ve=C.transform,Me=te.paint.get("fill-extrusion-pattern"),Se=Me.constantOr(1),Ae=te.paint.get("fill-extrusion-opacity"),Ce=C.style.enable3dLights(),Oe=te.paint.get(Ce&&!Se?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),Ne=[te.paint.get("fill-extrusion-ambient-occlusion-intensity"),Oe],je=te.layout.get("fill-extrusion-edge-radius"),Ge=je>0&&!te.paint.get("fill-extrusion-rounded-roof"),Ze=Ge?0:je,qe="globe"===ve.projection.name?vb():0,$e="globe"===ve.projection.name,We=$e?Ed(ve.zoom):0,He=[Gd(ve.center.lng),qd(ve.center.lat)],Xe=te.paint.get("fill-extrusion-flood-light-color").toArray01().slice(0,3),Ye=te.paint.get("fill-extrusion-flood-light-intensity"),Je=te.paint.get("fill-extrusion-vertical-scale"),Qe=$E(C,te.paint.get("fill-extrusion-cutoff-fade-range")),tt=[];let rt;$e&&tt.push("PROJECTION_GLOBE_VIEW"),Ne[0]>0&&tt.push("FAUX_AO"),Ge&&tt.push("ZERO_ROOF_RADIUS"),de&&tt.push("HAS_CENTROID"),Ye>0&&tt.push("FLOOD_LIGHT"),Qe.shouldRenderCutoff&&tt.push("RENDER_CUTOFF");const ot="shadow"===C.renderPass,st=C.shadowRenderer,at=ot&&!!st;C.shadowRenderer&&(C.shadowRenderer.useNormalOffset=!0);let lt=[0,0,0];if(st){const H=C.style.directionalLight,te=C.style.ambientLight;H&&te&&(lt=BA(H,te)),rt=tt.concat(["SHADOWS_SINGLE_CASCADE"])}const ct=at?"fillExtrusionDepth":Se?"fillExtrusionPattern":"fillExtrusion";for(const Ce of le){const le=H.getTile(Ce),Oe=le.getBucket(te);if(!Oe||Oe.projection.name!==ve.projection.name)continue;let je=!1;st&&(je=0===st.getMaxCascadeForTile(Ce.toUnwrapped()));const Ge=C.isTileAffectedByFog(Ce),at=Oe.programConfigurations.get(te.id),ht=C.getOrCreateProgram(ct,{config:at,defines:je?rt:tt,overrideFog:Ge});if(C.terrain){const H=C.terrain;C.style.terrainSetForDrapingOnly(),H.setupElevationDraw(le,ht,{useMeterToDem:!0})}if(!Oe.centroidVertexBuffer){const C=ht.attributes.a_centroid_pos;void 0!==C&&ye.vertexAttrib2f(C,0,0)}!ot&&st&&st.setupShadows(le.tileID.toUnwrapped(),ht,"vector-tile",le.tileID.overscaledZ),Se&&(C.context.activeTexture.set(ye.TEXTURE0),le.imageAtlasTexture.bind(ye.LINEAR,ye.CLAMP_TO_EDGE),at.updatePaintBuffers());const pt=Me.constantOr(null);if(pt&&le.imageAtlas){const C=le.imageAtlas.patternPositions[pt.toString()];C&&at.setConstantPatternPositions(C)}const ft=te.paint.get("fill-extrusion-vertical-gradient");let mt;if(ot&&st){if(YM(le.tileID,Oe,C))continue;const H=st.calculateShadowPassMatrixFromTile(le.tileID.toUnwrapped());mt=uM(H,Ze,Je)}else{const H=C.translatePosMatrix(Ce.projMatrix,le,te.paint.get("fill-extrusion-translate"),te.paint.get("fill-extrusion-translate-anchor")),ce=ve.projection.createInversionMatrix(ve,Ce.canonical);mt=Se?dM(H,C,ft,Ae,Ne,Ze,Ce,le,qe,We,He,ce,Xe,Je):hM(H,C,ft,Ae,Ne,Ze,Ce,qe,We,He,ce,Xe,Je,Ye,lt)}C.uploadCommonUniforms(_e,ht,Ce.toUnwrapped(),null,Qe);const Ct=[];(C.terrain||de)&&Ct.push(Oe.centroidVertexBuffer),$e&&Ct.push(Oe.layoutVertexExtBuffer),ht.draw(C,_e.gl.TRIANGLES,ce,he,ue,Ex.backCCW,mt,te.id,Oe.layoutVertexBuffer,Oe.indexBuffer,Oe.segments,te.paint,C.transform.zoom,at,Ct)}C.shadowRenderer&&(C.shadowRenderer.useNormalOffset=!1)}function ZM(C,H,te,le,ce,he,ue,de,_e,ye,ve,Me,Se,Ae,Ce,Oe,Ne,je,Ge){const Ze=C.context,qe=Ze.gl,$e=C.transform,We=C.transform.zoom,He=[],Xe=$E(C,te.paint.get("fill-extrusion-cutoff-fade-range"));"clear"===ye?(He.push("CLEAR_SUBPASS"),Ge&&(He.push("CLEAR_FROM_TEXTURE"),Ze.activeTexture.set(qe.TEXTURE0),Ge.bind(qe.LINEAR,qe.CLAMP_TO_EDGE))):"sdf"===ye&&He.push("SDF_SUBPASS"),Ne&&He.push("HAS_CENTROID"),Xe.shouldRenderCutoff&&He.push("RENDER_CUTOFF");const Ye=te.layout.get("fill-extrusion-edge-radius"),A=(H,le,ye,je,qe)=>{const $e=le.programConfigurations.get(te.id),Je=C.isTileAffectedByFog(H),Qe=C.getOrCreateProgram("fillExtrusionGroundEffect",{config:$e,defines:He,overrideFog:Je}),tt=((C,H,te,le,ce,he,ue,de,_e,ye,ve)=>({u_matrix:H,u_opacity:te,u_ao_pass:le?1:0,u_meter_to_tile:ce,u_ao:he,u_flood_light_intensity:ue,u_flood_light_color:de,u_attenuation:_e,u_edge_radius:ye,u_fb:0,u_fb_size:ve}))(0,je,ve,_e,qe,[Me,Se*qe],Ae,Ce,Oe,We>=17?0:Ye*qe,Ge?Ge.size[0]:0),rt=[];Ne&&rt.push(le.hiddenByLandmarkVertexBuffer),C.uploadCommonUniforms(Ze,Qe,H.toUnwrapped(),null,Xe),Qe.draw(C,Ze.gl.TRIANGLES,ce,he,ue,de,tt,te.id,le.vertexBuffer,le.indexBuffer,ye,te.paint,We,$e,rt)};for(const ce of le){const le=H.getTile(ce),he=le.getBucket(te);if(!he||he.projection.name!==$e.projection.name||!he.groundEffect||he.groundEffect&&!he.groundEffect.hasData())continue;const ue=he.groundEffect,de=1/he.tileToMeter;{const H=C.translatePosMatrix(ce.projMatrix,le,te.paint.get("fill-extrusion-translate"),te.paint.get("fill-extrusion-translate-anchor")),he=ue.getDefaultSegment();A(ce,ue,he,H,de)}if(je)for(let he=0;he<4;he++){const ue=sp[he](ce),_e=H.getTile(ue);if(!_e)continue;const ye=_e.getBucket(te);if(!ye||ye.projection.name!==$e.projection.name||!ye.groundEffect||ye.groundEffect&&!ye.groundEffect.hasData())continue;const ve=ye.groundEffect;let Me,Se;0===he?(Me=[-wn,0,0],Se=1):1===he?(Me=[wn,0,0],Se=0):2===he?(Me=[0,-wn,0],Se=3):(Me=[0,wn,0],Se=2);const Ae=ve.regionSegments[Se];if(!Ae)continue;const Ce=new Float32Array(16);ed.translate(Ce,ce.projMatrix,Me),A(ce,ve,Ae,C.translatePosMatrix(Ce,le,te.paint.get("fill-extrusion-translate"),te.paint.get("fill-extrusion-translate-anchor")),de)}}}function $M(C,H,te,le,ce,he,ue){0===le.centroidVertexArray.length&&le.createCentroidsBuffer();const de=he?he.findDEMTileFor(te):null;if(!(de&&de.dem||ue))return;const l=C=>{const te=H.getSource().minzoom,r=C=>{const te=H.getTileByID(C);if(te&&te.hasData())return te.getBucket(ce)},le=[0,-1,1];for(const H of le){if(C.overscaledZ+H<te)continue;const le=r(C.calculateScaledKey(C.overscaledZ+H));if(le)return le}},_e=[0,0,0],h=(C,H)=>(_e[0]=Math.min(C.min.y,H.min.y),_e[1]=Math.max(C.max.y,H.max.y),_e[2]=wn-H.min.x>C.max.x?H.min.x-wn:C.max.x,_e),u=(C,H)=>(_e[0]=Math.min(C.min.x,H.min.x),_e[1]=Math.max(C.max.x,H.max.x),_e[2]=wn-H.min.y>C.max.y?H.min.y-wn:C.max.y,_e),ye=[(C,H)=>h(C,H),(C,H)=>h(H,C),(C,H)=>u(C,H),(C,H)=>u(H,C)],p=(C,H,le,ce,ue,_e,ye)=>{if(!he)return 0;const ve=[[_e?le:C,_e?C:le,0],[_e?le:H,_e?H:le,0]],Me=ye<0?wn+ye:ye,Se=[_e?Me:(C+H)/2,_e?(C+H)/2:Me,0];return 0===le&&ye<0||0!==le&&ye>0?he.getForTilePoints(ue,[Se],!0,ce):ve.push(Se),he.getForTilePoints(te,ve,!0,de),Math.max(ve[0][2],ve[1][2],Se[2])/he.exaggeration()};for(let C=0;C<4;C++){const H=le.borderFeatureIndices[C];if(0===H.length)continue;const ce=sp[C](te),de=l(ce);if(!(de&&de instanceof db))continue;if(le.borderDoneWithNeighborZ[C]===de.canonical.z)continue;0===de.centroidVertexArray.length&&de.createCentroidsBuffer();const _e=he?he.findDEMTileFor(ce):null;if(!(_e&&_e.dem||ue))continue;const Ae=(C<2?1:5)-C,Ce=de.borderDoneWithNeighborZ[Ae]!==le.canonical.z,Oe=de.borderFeatureIndices[Ae];let je=0;if(le.canonical.z!==de.canonical.z){for(const C of H)le.showCentroid(le.featuresOnBorder[C]);if(Ce)for(const C of Oe)de.showCentroid(de.featuresOnBorder[C]);le.borderDoneWithNeighborZ[C]=de.canonical.z,de.borderDoneWithNeighborZ[Ae]=le.canonical.z}for(const te of H){const H=le.featuresOnBorder[te],he=le.centroidData[H.centroidDataIndex],Ce=H.borders[C];let Ge;for(;je<Oe.length;){Ge=de.featuresOnBorder[Oe[je]];const C=Ge.borders[Ae];if(C[1]>Ce[0]+3||C[0]>Ce[0]-3)break;de.showCentroid(Ge),je++}if(Ge&&je<Oe.length){const te=je;let Ze=0;for(;!(Ge.borders[Ae][0]>Ce[1]-3)&&(Ze++,++je!==Oe.length);)Ge=de.featuresOnBorder[Oe[je]];if(Ge=de.featuresOnBorder[Oe[te]],Ze>1){const C=Ge.borders[Ae];Math.abs(Ce[0]-C[0])<3&&Math.abs(Ce[1]-C[1])<3&&(Ze=1,je=te+1)}else if(0===Ze){le.showCentroid(H);continue}const qe=de.centroidData[Ge.centroidDataIndex];ue&&1===Ze&&(((Me=he).flags|(Se=qe).flags)&uw?(Me.flags|=uw,Se.flags|=uw):(Me.flags&=2147483647,Se.flags&=2147483647));let $e=new Ne(0,0);if(Ze>1)je=te;else if(_e&&_e.dem&&!(H.intersectsCount()>1||Ge.intersectsCount()>1)){const H=ye[C](he,qe),te=C%2?wn-1:0;ve=p(H[0],Math.min(wn-1,H[1]),te,_e,ce,C<2,H[2]),$e=new Ne(Math.ceil(7*(ve+450)),0)}he.centroidXY=qe.centroidXY=$e,le.writeCentroidToBuffer(he),de.writeCentroidToBuffer(qe)}else le.showCentroid(H)}le.borderDoneWithNeighborZ[C]=de.canonical.z,de.borderDoneWithNeighborZ[Ae]=le.canonical.z}var ve,Me,Se;(le.needsCentroidUpdate||!le.centroidVertexBuffer&&0!==le.centroidVertexArray.length)&&le.uploadCentroid(C)}const EA=[1,0,0],IA=[0,1,0],CA=[0,0,1];function YM(C,H,te){const le=te.transform,ce=te.shadowRenderer;if(!ce)return!0;const he=C.toUnwrapped(),ue=le.tileSize*ce._cascades[te.currentShadowCascade].scale;let de=H.maxHeight;if(le.elevation){const H=le.elevation.getMinMaxForTile(C);H&&(de+=H.max)}const _e=[...ce.shadowDirection];_e[2]=-_e[2];const ye=ce.computeSimplifiedTileShadowVolume(he,de,ue,_e);if(!ye)return!1;const ve=[EA,IA,CA,_e,[_e[0],0,_e[2]],[0,_e[1],_e[2]]],Me="globe"===le.projection.name,Se=le.scaleZoom(ue),Ae=$u.fromInvProjectionMatrix(le.invProjMatrix,le.worldSize,Se,!Me),Ce=ce.getCurrentCascadeFrustum();return 0===Ae.intersectsPrecise(ye.vertices,ye.planes,ve)||0===Ce.intersectsPrecise(ye.vertices,ye.planes,ve)}const DA=new kr(1,0,0,1),VA=new kr(0,1,0,1),jA=new kr(0,0,1,1),GA=new kr(1,0,1,1),ZA=new kr(0,1,1,1);function iA(C,H,te){const le=C.context,ce=C.transform,he=le.gl,ue="globe"===ce.projection.name,de=ue?["PROJECTION_GLOBE_VIEW"]:[];let _e=te.projMatrix;if(ue&&Ed(ce.zoom)>0){const C=vd(cd(te.canonical,ce));_e=ed.multiply(new Float32Array(16),ce.globeMatrix,C),ed.multiply(_e,ce.projMatrix,_e)}const ye=C.getOrCreateProgram("debug",{defines:de}),ve=H.getTileByID(te.key);C.terrain&&C.terrain.setupElevationDraw(ve,ye);const Me=gx.disabled,Se=xx.disabled,Ae=C.colorModeForRenderPass(),Ce="$debug";le.activeTexture.set(he.TEXTURE0),C.emptyTexture.bind(he.LINEAR,he.CLAMP_TO_EDGE),ue?ve._makeGlobeTileDebugBuffers(C.context,ce):ve._makeDebugTileBoundsBuffers(C.context,ce.projection);const Oe=ve._tileDebugBuffer||C.debugBuffer,Ne=ve._tileDebugIndexBuffer||C.debugIndexBuffer,je=ve._tileDebugSegments||C.debugSegments;ye.draw(C,he.LINE_STRIP,Me,Se,Ae,Ex.disabled,yM(_e,kr.red),Ce,Oe,Ne,je,null,null,null,[ve._globeTileDebugBorderBuffer]);const Ge=ve.latestRawTileData,Ze=Math.floor((Ge&&Ge.byteLength||0)/1024),qe=H.getTile(te).tileSize,$e=512/Math.min(qe,512)*(te.overscaledZ/ce.zoom)*.5;let We=te.canonical.toString();te.overscaledZ!==te.canonical.z&&(We+=` => ${te.overscaledZ}`),We+=` ${Ze}kb`,function(C,H){C.initDebugOverlayCanvas();const te=C.debugOverlayCanvas,le=C.context.gl,ce=C.debugOverlayCanvas.getContext("2d");ce.clearRect(0,0,te.width,te.height),ce.shadowColor="white",ce.shadowBlur=2,ce.lineWidth=1.5,ce.strokeStyle="white",ce.textBaseline="top",ce.font="bold 36px Open Sans, sans-serif",ce.fillText(H,5,5),ce.strokeText(H,5,5),C.debugOverlayTexture.update(te),C.debugOverlayTexture.bind(le.LINEAR,le.CLAMP_TO_EDGE)}(C,We);const He=ve._tileDebugTextBuffer||C.debugBuffer,Xe=ve._tileDebugTextIndexBuffer||C.quadTriangleIndexBuffer,Ye=ve._tileDebugTextSegments||C.debugSegments;ye.draw(C,he.TRIANGLES,Me,Se,bx.alphaBlended,Ex.disabled,yM(_e,kr.transparent,$e),Ce,He,Xe,Ye,null,null,null,[ve._globeTileDebugTextBuffer])}function rA(C,H,te,le){oA(C,0,H+te/2,C.transform.width,te,le)}function nA(C,H,te,le){oA(C,H-te/2,0,te,C.transform.height,le)}function oA(C,H,te,le,ce,he){const ue=C.context,de=ue.gl;de.enable(de.SCISSOR_TEST),de.scissor(H*yi.devicePixelRatio,te*yi.devicePixelRatio,le*yi.devicePixelRatio,ce*yi.devicePixelRatio),ue.clear({color:he}),de.disable(de.SCISSOR_TEST)}const qA=ba([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:YA}=qA;function lA(C,H,te,le){C.emplaceBack(H,te,le)}class cA{constructor(C){this.vertexArray=new Ua,this.indices=new Va,lA(this.vertexArray,-1,-1,1),lA(this.vertexArray,1,-1,1),lA(this.vertexArray,-1,1,1),lA(this.vertexArray,1,1,1),lA(this.vertexArray,-1,-1,-1),lA(this.vertexArray,1,-1,-1),lA(this.vertexArray,-1,1,-1),lA(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=C.createVertexBuffer(this.vertexArray,YA),this.indexBuffer=C.createIndexBuffer(this.indices),this.segment=dl.simpleSegment(0,0,36,12)}}function hA(C,H,te,le,ce,he){const ue=C.context.gl,de=H.paint.get("sky-atmosphere-color"),_e=H.paint.get("sky-atmosphere-halo-color"),ye=H.paint.get("sky-atmosphere-sun-intensity"),ve=((C,H,te,le,ce)=>({u_matrix_3f:C,u_sun_direction:H,u_sun_intensity:te,u_color_tint_r:[le.r,le.g,le.b,le.a],u_color_tint_m:[ce.r,ce.g,ce.b,ce.a],u_luminance:5e-5}))(Ju.fromMat4(Ju.create(),le),ce,ye,de,_e);ue.framebufferTexture2D(ue.FRAMEBUFFER,ue.COLOR_ATTACHMENT0,ue.TEXTURE_CUBE_MAP_POSITIVE_X+he,H.skyboxTexture,0),te.draw(C,ue.TRIANGLES,gx.disabled,xx.disabled,bx.unblended,Ex.frontCW,ve,"skyboxCapture",H.skyboxGeometry.vertexBuffer,H.skyboxGeometry.indexBuffer,H.skyboxGeometry.segment)}const KA=ba([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class dA{constructor(C){const H=new Za;H.emplaceBack(-1,1,1,0,0),H.emplaceBack(1,1,1,1,0),H.emplaceBack(1,-1,1,1,1),H.emplaceBack(-1,-1,1,0,1);const te=new Va;te.emplaceBack(0,1,2),te.emplaceBack(2,3,0),this.vertexBuffer=C.createVertexBuffer(H,KA.members),this.indexBuffer=C.createIndexBuffer(te),this.segments=dl.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const JA=ba([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class fA{constructor(){this.colorModeAlphaBlendedWriteRGB=new bx([1,Yv,1,Yv],kr.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new bx([1,0,1,0],kr.transparent,[!1,!1,!1,!0])}update(C){const H=C.context;if(!this.atmosphereBuffer){this.atmosphereBuffer=new dA(H);const C=100,te=200,le=function(C){const H=$n(30),te=[];for(let C=0;C<16e3;++C){const C=2*Math.PI*H(),le=Math.acos(1-2*H())-.5*Math.PI;te.push(Ld.fromValues(Math.cos(le)*Math.cos(C),Math.cos(le)*Math.sin(C),Math.sin(le)))}return te}(),ce=$n(300),he=new $a,ue=new Va;let de=0;for(let H=0;H<le.length;++H){const _e=Ld.scale([],le[H],200),ye=Math.max(0,1+.01*C*(1*ce()-.5)),ve=Math.max(0,1+.01*te*(1*ce()-.5));he.emplaceBack(_e[0],_e[1],_e[2],-1,-1,ye,ve),he.emplaceBack(_e[0],_e[1],_e[2],1,-1,ye,ve),he.emplaceBack(_e[0],_e[1],_e[2],1,1,ye,ve),he.emplaceBack(_e[0],_e[1],_e[2],-1,1,ye,ve),ue.emplaceBack(de+0,de+1,de+2),ue.emplaceBack(de+0,de+2,de+3),de+=4}this.starsVx=H.createVertexBuffer(he,JA.members),this.starsIdx=H.createIndexBuffer(ue),this.starsSegments=dl.simpleSegment(0,0,he.length,ue.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(C,H){const te=C.context,le=te.gl,ce=C.transform,he=new gx(le.LEQUAL,gx.ReadOnly,[0,1]),ue=Ed(ce.zoom),de=H.properties.get("color").toArray01(),_e=H.properties.get("high-color").toArray01(),ye=H.properties.get("space-color").toArray01PremultipliedAlpha(),ve=5e-4,Me=z((H.properties.get("horizon-blend")-0)/1*.2495+ve,5e-4,.25),Se=Ad(C,te,ce)&&Me===ve?ce.worldSize/(2*Math.PI*1.025)-1:ce.globeRadius,Ae=C.frameCounter/1e3%1,Ce=Ld.length(ce.globeCenterInViewSpace),Oe=Math.sqrt(Math.pow(Ce,2)-Math.pow(Se,2)),Ne=Math.acos(Oe/Ce),g=H=>{const ve="globe"===ce.projection.name?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];H&&ve.push("ALPHA_PASS");const Se=C.getOrCreateProgram("globeAtmosphere",{defines:ve}),Ce=((C,H,te,le,ce,he,ue,de,_e,ye,ve,Me)=>({u_frustum_tl:C,u_frustum_tr:H,u_frustum_br:te,u_frustum_bl:le,u_horizon:ce,u_transition:he,u_fadeout_range:ue,u_color:de,u_high_color:_e,u_space_color:ye,u_temporal_offset:ve,u_horizon_angle:Me}))(ce.frustumCorners.TL,ce.frustumCorners.TR,ce.frustumCorners.BR,ce.frustumCorners.BL,ce.frustumCorners.horizon,ue,Me,de,_e,ye,Ae,Ne);C.uploadCommonUniforms(te,Se);const Oe=this.atmosphereBuffer;Oe&&Se.draw(C,le.TRIANGLES,he,xx.disabled,H?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,Ex.backCW,Ce,H?"atmosphere_glow_alpha":"atmosphere_glow",Oe.vertexBuffer,Oe.indexBuffer,Oe.segments)};g(!1),g(!0)}drawStars(C,H){const te=z(H.properties.get("star-intensity"),0,1);if(0===te)return;const le=C.context,ce=le.gl,he=C.transform,ue=C.getOrCreateProgram("stars"),de=id.identity([]);id.rotateX(de,de,-he._pitch),id.rotateZ(de,de,-he.angle),id.rotateX(de,de,w(he._center.lat)),id.rotateY(de,de,-w(he._center.lng));const _e=ed.fromQuat(new Float32Array(16),de),ye=ed.multiply([],he.starsProjMatrix,_e),ve=Ju.fromMat4([],_e),Me=Ju.invert([],ve),Se=[0,1,0];Ld.transformMat3(Se,Se,Me),Ld.scale(Se,Se,.15);const Ae=[1,0,0];Ld.transformMat3(Ae,Ae,Me),Ld.scale(Ae,Ae,.15);const Ce=((C,H,te,le)=>({u_matrix:Float32Array.from(C),u_up:H,u_right:te,u_intensity_multiplier:le}))(ye,Se,Ae,te);C.uploadCommonUniforms(le,ue),this.starsVx&&this.starsIdx&&ue.draw(C,ce.TRIANGLES,gx.disabled,xx.disabled,this.colorModeAlphaBlendedWriteRGB,Ex.disabled,Ce,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}function mA(C,H){const te=[...C],le=H.cameraWorldSizeForFog/H.worldSize,ce=ed.identity([]);return ed.scale(ce,ce,[le,le,1]),ed.multiply(te,ce,te),ed.multiply(te,H.worldToFogMatrix,te),te}function _A(C,H,te,le){const ce=te.material,he=le.context,{baseColorTexture:ue,metallicRoughnessTexture:de}=ce.pbrMetallicRoughness,{normalTexture:_e,occlusionTexture:ye,emissionTexture:ve}=ce;function u(H,te,le){if(H&&(C.push(te),he.activeTexture.set(he.gl.TEXTURE0+le),H.gfxTexture)){const{minFilter:C,magFilter:te,wrapS:le,wrapT:ce}=H.sampler;H.gfxTexture.bindExtraParam(C,te,le,ce)}}u(ue,"HAS_TEXTURE_u_baseColorTexture",sA.BaseColor),u(de,"HAS_TEXTURE_u_metallicRoughnessTexture",sA.MetallicRoughness),u(_e,"HAS_TEXTURE_u_normalTexture",sA.Normal),u(ye,"HAS_TEXTURE_u_occlusionTexture",sA.Occlusion),u(ve,"HAS_TEXTURE_u_emissionTexture",sA.Emission),te.texcoordBuffer&&(C.push("HAS_ATTRIBUTE_a_uv_2f"),H.push(te.texcoordBuffer)),te.colorBuffer&&(C.push(12===te.colorBuffer.itemSize?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),H.push(te.colorBuffer)),te.normalBuffer&&(C.push("HAS_ATTRIBUTE_a_normal_3f"),H.push(te.normalBuffer)),te.pbrBuffer&&(C.push("HAS_ATTRIBUTE_a_pbr"),C.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),H.push(te.pbrBuffer)),"OPAQUE"!==ce.alphaMode&&"MASK"!==ce.alphaMode||C.push("UNPREMULT_TEXTURE_IN_SHADER"),ce.defined||C.push("DIFFUSE_SHADED"),C.push("USE_STANDARD_DERIVATIVES")}function gA(C,H,te,le,ce,he){const ue=te.paint.get("model-opacity"),de=H.context,_e=new gx(H.context.gl.LEQUAL,gx.ReadWrite,H.depthRangeFor3D),ye=H.transform,ve=C.mesh,Me=ve.material,Se=Me.pbrMetallicRoughness,Ae=H.style.fog;let Ce;Ce="pixels"===H.transform.projection.zAxisUnit?[...C.nodeModelMatrix]:ed.multiply([],le.zScaleMatrix,C.nodeModelMatrix),ed.multiply(Ce,le.negCameraPosMatrix,Ce);const Oe=ed.invert([],Ce);ed.transpose(Oe,Oe);const Ne=DM(new Float32Array(C.worldViewProjection),new Float32Array(Ce),new Float32Array(Oe),H,ue,Se.baseColorFactor,Me.emissiveFactor,Se.metallicFactor,Se.roughnessFactor,Me,te),je={defines:[]},Ge=[];_A(je.defines,Ge,ve,H);const Ze=H.shadowRenderer;Ze&&(Ze.useNormalOffset=!1);let qe=null;if(Ae){const te=mA(C.nodeModelMatrix,H.transform);if(qe=new Float32Array(te),"globe"!==ye.projection.name){const C=ve.aabb.min,H=ve.aabb.max,[le,ce]=Ae.getOpacityForBounds(te,C[0],C[1],H[0],H[1]);je.overrideFog=le>=AT||ce>=AT}}const $e=$E(H,te.paint.get("model-cutoff-fade-range"));$e.shouldRenderCutoff&&je.defines.push("RENDER_CUTOFF");const We=H.getOrCreateProgram("model",je);H.uploadCommonUniforms(de,We,null,qe,$e),"shadow"!==H.renderPass&&Ze&&Ze.setupShadowsFromMatrix(C.nodeModelMatrix,We),We.draw(H,de.gl.TRIANGLES,_e,ce,he,ve.material.doubleSided?Ex.disabled:Ex.backCCW,Ne,te.id,ve.vertexBuffer,ve.indexBuffer,ve.segments,te.paint,H.transform.zoom,void 0,Ge)}function yA(C,H,te,le,ce,he,ue){let de;de="globe"===C.projection.name?yv(te,C):[...te],ed.multiply(de,de,H.matrix);const _e=ed.multiply([],le,de);if(H.meshes)for(const C of H.meshes){if("BLEND"!==C.material.alphaMode){ue.push({mesh:C,depth:0,modelIndex:ce,worldViewProjection:_e,nodeModelMatrix:de});continue}const H=Ld.transformMat4([],C.centroid,_e);H[2]>0&&he.push({mesh:C,depth:H[2],modelIndex:ce,worldViewProjection:_e,nodeModelMatrix:de})}if(H.children)for(const de of H.children)yA(C,de,te,le,ce,he,ue)}function xA(C,H,te,le){const ce=te.shadowRenderer;if(!ce)return;const he=ce.getShadowPassDepthMode(),ue=ce.getShadowPassColorMode(),de=ce.calculateShadowPassMatrixFromMatrix(H),_e=RM(de);te.getOrCreateProgram("modelDepth",{defines:["DEPTH_TEXTURE"]}).draw(te,te.context.gl.TRIANGLES,he,xx.disabled,ue,Ex.backCCW,_e,le.id,C.vertexBuffer,C.indexBuffer,C.segments,le.paint,te.transform.zoom,void 0,void 0)}function vA(C,H,te){const le=H.updateZoomBasedPaintProperties(),ce=function(C,H,te){let le,ce,he,ue=C.terrain?C.terrain.exaggeration():0;if(C.terrain&&ue>0){const H=C.terrain,ce=H.findDEMTileFor(te);ce&&ce.dem?le=qm.create(H,te,ce):ue=0}if(0===ue&&(H.terrainElevationMin=0,H.terrainElevationMax=0),ue===H.validForExaggeration&&(0===ue||le&&le._demTile&&le._demTile.tileID===H.validForDEMTile.id&&le._dem._timestamp===H.validForDEMTile.timestamp))return!1;for(const C in H.instancesPerModel){const te=H.instancesPerModel[C];for(let C=0;C<te.instancedDataArray.length;++C){const de=(le?ue*le.getElevationAt(0|te.instancedDataArray.float32[16*C],0|te.instancedDataArray.float32[16*C+1],!0,!0):0)+te.instancesEvaluatedElevation[C];te.instancedDataArray.float32[16*C+6]=de,ce=ce?Math.min(H.terrainElevationMin,de):de,he=he?Math.max(H.terrainElevationMax,de):de}}return H.terrainElevationMin=ce||0,H.terrainElevationMax=he||0,H.validForExaggeration=ue,H.validForDEMTile=le&&le._demTile?{id:le._demTile.tileID,timestamp:le._dem._timestamp}:{id:void 0,timestamp:0},!0}(C,H,te);(le||ce)&&(H.uploaded=!1,H.upload(C.context))}const QA={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new Hu([0,0,0],[wn,wn,0])};function wA(C,H){const te=1<<C.canonical.z,le=H.getFreeCameraOptions().position,ce=H.elevation,he=C.canonical.x/te,ue=(C.canonical.x+1)/te,de=C.canonical.y/te,_e=(C.canonical.y+1)/te;let ye=H._centerAltitude;if(ce){const H=ce.getMinMaxForTile(C);H&&H.max>ye&&(ye=H.max)}const ve=z(le.x,he,ue)-le.x,Me=z(le.y,de,_e)-le.y,Se=Zd(ye,H.center.lat)-le.z;return H._zoomFromMercatorZ(Math.sqrt(ve*ve+Me*Me+Se*Se))}function TA(C,H,te,le,ce,he,ue){const de=C.context,_e="shadow"===C.renderPass,ye=C.shadowRenderer,ve=_e&&ye?ye.getShadowPassDepthMode():new gx(de.gl.LEQUAL,gx.ReadWrite,C.depthRangeFor3D),Me=C.isTileAffectedByFog(he);if(te.meshes)for(const Se of te.meshes){const Ae=["MODEL_POSITION_ON_GPU"],Ce=[];let Oe,Ne,je;le.instancedDataArray.length>20&&Ae.push("INSTANCED_ARRAYS");const Ge=$E(C,H.paint.get("model-cutoff-fade-range"));if(Ge.shouldRenderCutoff&&Ae.push("RENDER_CUTOFF"),_e&&ye)Oe=C.getOrCreateProgram("modelDepth",{defines:Ae}),Ne=RM(ue.shadowTileMatrix,ue.shadowTileMatrix,Float32Array.from(te.matrix)),je=ye.getShadowPassColorMode();else{_A(Ae,Ce,Se,C),Oe=C.getOrCreateProgram("model",{defines:Ae,overrideFog:Me});const le=Se.material,_e=le.pbrMetallicRoughness,ve=H.paint.get("model-opacity");Ne=DM(he.projMatrix,Float32Array.from(te.matrix),new Float32Array(16),C,ve,_e.baseColorFactor,le.emissiveFactor,_e.metallicFactor,_e.roughnessFactor,le,H,ce),ye&&(ue.shadowUniformsInitialized?Oe.setShadowUniformValues(de,ye.getShadowUniformValues()):(ye.setupShadows(he.toUnwrapped(),Oe,"model-tile",he.overscaledZ),ue.shadowUniformsInitialized=!0)),je=Ge.shouldRenderCutoff||ve<1||"OPAQUE"!==le.alphaMode?bx.alphaBlended:bx.unblended}C.uploadCommonUniforms(de,Oe,he.toUnwrapped(),null,Ge);const Ze=Se.material.doubleSided?Ex.disabled:Ex.backCCW;if(le.instancedDataArray.length>20)Ce.push(le.instancedDataBuffer),Oe.draw(C,de.gl.TRIANGLES,ve,xx.disabled,je,Ze,Ne,H.id,Se.vertexBuffer,Se.indexBuffer,Se.segments,H.paint,C.transform.zoom,void 0,Ce,le.instancedDataArray.length);else{const te=_e?"u_instance":"u_normal_matrix";for(let ce=0;ce<le.instancedDataArray.length;++ce)Ne[te]=new Float32Array(le.instancedDataArray.arrayBuffer,64*ce,16),Oe.draw(C,de.gl.TRIANGLES,ve,xx.disabled,je,Ze,Ne,H.id,Se.vertexBuffer,Se.indexBuffer,Se.segments,H.paint,C.transform.zoom,void 0,Ce)}}if(te.children)for(const de of te.children)TA(C,H,de,le,ce,he,ue)}const iI=[1,-1,1];function MA(C,H,te,le){if(!te.modelManager)return!0;const ce=te.modelManager;if(!te.shadowRenderer)return!0;const he=te.shadowRenderer,ue=H.aabb;let de=!0,_e=C.maxHeight;if(0===_e){let H=0;for(const te in C.instancesPerModel){const C=ce.getModel(te,le);C?H=Math.max(H,Math.max(Math.max(C.aabb.max[0],C.aabb.max[1]),C.aabb.max[2])):de=!1}_e=C.maxScale*H*1.41+C.maxVerticalOffset,de&&(C.maxHeight=_e)}ue.max[2]=_e,ue.min[2]+=C.terrainElevationMin,ue.max[2]+=C.terrainElevationMax,Ld.transformMat4(ue.min,ue.min,H.tileMatrix),Ld.transformMat4(ue.max,ue.max,H.tileMatrix);const ye=ue.intersects(he.getCurrentCascadeFrustum());return 0===te.currentShadowCascade&&(C.isInsideFirstShadowMapFrustum=2===ye),0===ye}class AA{}class SA{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(C,H,te){{const te=this._storage.get(H.id);if(te)return te.lastUsedFrameIdx=C,te.buf}const le=te.gl,ce=le.getBufferParameter(le.ELEMENT_ARRAY_BUFFER,le.BUFFER_SIZE),he=new ArrayBuffer(ce),ue=new Int16Array(he);le.getBufferSubData(le.ELEMENT_ARRAY_BUFFER,0,new Int16Array(he));const de=new ka;for(let C=0;C<ce/2;C+=3){const H=ue[C],te=ue[C+1],le=ue[C+2];de.emplaceBack(H,te),de.emplaceBack(te,le),de.emplaceBack(le,H)}const _e=te.bindVertexArrayOES.current,ye=new AA;return ye.buf=new zy(te,de),ye.lastUsedFrameIdx=C,this._storage.set(H.id,ye),te.bindVertexArrayOES.set(_e),ye.buf}update(C){for(const[H,te]of this._storage)C-te.lastUsedFrameIdx>30&&(te.buf.destroy(),this._storage.delete(H))}destroy(){for(const[C,H]of this._storage)H.buf.destroy(),this._storage.delete(C)}}const rI={symbol:function(C,H,te,le,ce){if("translucent"!==C.renderPass)return;const he=xx.disabled,ue=C.colorModeForRenderPass();te.layout.get("text-variable-anchor")&&function(C,H,te,le,ce,he,ue){const de=H.transform,_e="map"===ce,ye="map"===he;for(const H of C){const C=le.getTile(H),ce=C.getBucket(te);if(!ce||!ce.text||!ce.text.segments.get().length)continue;const he=a_(ce.textSizeData,de.zoom),ve=GT(H,ce.getProjection(),de),Me=de.calculatePixelsToTileUnitsMatrix(C),Se=Jx(ve,C.tileID.canonical,ye,_e,de,ce.getProjection(),Me),Ae=ce.hasIconTextFit()&&ce.hasIconData();if(he){const te=Math.pow(2,de.zoom-C.tileID.overscaledZ);NM(ce,_e,ye,ue,Rg,de,Se,H,te,he,Ae)}}}(le,C,te,H,te.layout.get("text-rotation-alignment"),te.layout.get("text-pitch-alignment"),ce),0!==te.paint.get("icon-opacity").constantOr(1)&&VM(C,H,te,le,!1,te.paint.get("icon-translate"),te.paint.get("icon-translate-anchor"),te.layout.get("icon-rotation-alignment"),te.layout.get("icon-pitch-alignment"),te.layout.get("icon-keep-upright"),he,ue),0!==te.paint.get("text-opacity").constantOr(1)&&VM(C,H,te,le,!0,te.paint.get("text-translate"),te.paint.get("text-translate-anchor"),te.layout.get("text-rotation-alignment"),te.layout.get("text-pitch-alignment"),te.layout.get("text-keep-upright"),he,ue),H.map.showCollisionBoxes&&(OM(C,H,te,le,te.paint.get("text-translate"),te.paint.get("text-translate-anchor"),!0),OM(C,H,te,le,te.paint.get("icon-translate"),te.paint.get("icon-translate-anchor"),!1))},circle:function(C,H,te,le){if("translucent"!==C.renderPass)return;const ce=te.paint.get("circle-opacity"),he=te.paint.get("circle-stroke-width"),ue=te.paint.get("circle-stroke-opacity"),de=void 0!==te.layout.get("circle-sort-key").constantOr(1),_e=te.paint.get("circle-emissive-strength");if(0===ce.constantOr(1)&&(0===he.constantOr(1)||0===ue.constantOr(1)))return;const ye=C.context,ve=ye.gl,Me=C.transform,Se=C.depthModeForSublayer(0,gx.ReadOnly),Ae=xx.disabled,Ce=C.colorModeForDrapableLayerRenderPass(_e),Oe="globe"===Me.projection.name,Ne=[Gd(Me.center.lng),qd(Me.center.lat)],je=[];for(let ce=0;ce<le.length;ce++){const he=le[ce],ue=H.getTile(he),_e=ue.getBucket(te);if(!_e||_e.projection.name!==Me.projection.name)continue;const ye=_e.programConfigurations.get(te.id),ve=kp(te),Se=C.isTileAffectedByFog(he);Oe&&ve.push("PROJECTION_GLOBE_VIEW");const Ae=C.getOrCreateProgram("circle",{config:ye,defines:ve,overrideFog:Se}),Ce=_e.layoutVertexBuffer,Ge=_e.globeExtVertexBuffer,Ze=_e.indexBuffer,qe=Me.projection.createInversionMatrix(Me,he.canonical),$e={programConfiguration:ye,program:Ae,layoutVertexBuffer:Ce,globeExtVertexBuffer:Ge,indexBuffer:Ze,uniformValues:Lp(C,he,ue,qe,Ne,te),tile:ue};if(de){const C=_e.segments.get();for(const H of C)je.push({segments:new dl([H]),sortKey:H.sortKey,state:$e})}else je.push({segments:_e.segments,sortKey:0,state:$e})}de&&je.sort(((C,H)=>C.sortKey-H.sortKey));const Ge={useDepthForOcclusion:Me.depthOcclusionForSymbolsAndCircles};for(const H of je){const{programConfiguration:le,program:ce,layoutVertexBuffer:he,globeExtVertexBuffer:ue,indexBuffer:de,uniformValues:_e,tile:Oe}=H.state,Ne=H.segments;C.terrain&&C.terrain.setupElevationDraw(Oe,ce,Ge),C.uploadCommonUniforms(ye,ce,Oe.tileID.toUnwrapped()),ce.draw(C,ve.TRIANGLES,Se,Ae,Ce,Ex.disabled,_e,te.id,he,de,Ne,te.paint,Me.zoom,le,[ue])}},heatmap:function(C,H,te,le){if(0!==te.paint.get("heatmap-opacity"))if("offscreen"===C.renderPass){const ce=C.context,he=ce.gl,ue=xx.disabled,de=new bx([he.ONE,he.ONE,he.ONE,he.ONE],kr.transparent,[!0,!0,!0,!0]);!function(C,H,te,le){const ce=C.gl,he=H.width*le,ue=H.height*le;C.activeTexture.set(ce.TEXTURE1),C.viewport.set([0,0,he,ue]);let de=te.heatmapFbo;if(!de||de&&(de.width!==he||de.height!==ue)){de&&de.destroy();const H=ce.createTexture();ce.bindTexture(ce.TEXTURE_2D,H),ce.texParameteri(ce.TEXTURE_2D,ce.TEXTURE_WRAP_S,ce.CLAMP_TO_EDGE),ce.texParameteri(ce.TEXTURE_2D,ce.TEXTURE_WRAP_T,ce.CLAMP_TO_EDGE),ce.texParameteri(ce.TEXTURE_2D,ce.TEXTURE_MIN_FILTER,ce.LINEAR),ce.texParameteri(ce.TEXTURE_2D,ce.TEXTURE_MAG_FILTER,ce.LINEAR),de=te.heatmapFbo=C.createFramebuffer(he,ue,!0,null),function(C,H,te,le,ce,he){const ue=C.gl;ue.texImage2D(ue.TEXTURE_2D,0,C.extRenderToTextureHalfFloat?ue.RGBA16F:ue.RGBA,ce,he,0,ue.RGBA,C.extRenderToTextureHalfFloat?ue.HALF_FLOAT:ue.UNSIGNED_BYTE,null),le.colorAttachment.set(te)}(C,0,H,de,he,ue)}else ce.bindTexture(ce.TEXTURE_2D,de.colorAttachment.get()),C.bindFramebuffer.set(de.framebuffer)}(ce,C,te,"globe"===C.transform.projection.name?.5:.25),ce.clear({color:kr.transparent});const _e=C.transform,ye="globe"===_e.projection.name,ve=ye?["PROJECTION_GLOBE_VIEW"]:[],Me=ye?Ex.frontCCW:Ex.disabled,Se=[Gd(_e.center.lng),qd(_e.center.lat)];for(let Ae=0;Ae<le.length;Ae++){const Ce=le[Ae];if(H.hasRenderableParent(Ce))continue;const Oe=H.getTile(Ce),Ne=Oe.getBucket(te);if(!Ne||Ne.projection.name!==_e.projection.name)continue;const je=C.isTileAffectedByFog(Ce),Ge=Ne.programConfigurations.get(te.id),Ze=C.getOrCreateProgram("heatmap",{config:Ge,defines:ve,overrideFog:je}),{zoom:qe}=C.transform;C.terrain&&C.terrain.setupElevationDraw(Oe,Ze),C.uploadCommonUniforms(ce,Ze,Ce.toUnwrapped());const $e=_e.projection.createInversionMatrix(_e,Ce.canonical);Ze.draw(C,he.TRIANGLES,gx.disabled,ue,de,Me,vM(C,Ce,Oe,$e,Se,qe,te.paint.get("heatmap-intensity")),te.id,Ne.layoutVertexBuffer,Ne.indexBuffer,Ne.segments,te.paint,C.transform.zoom,Ge,ye?[Ne.globeExtVertexBuffer]:null)}ce.viewport.set([0,0,C.width,C.height])}else"translucent"===C.renderPass&&(C.context.setColorMode(C.colorModeForRenderPass()),function(C,H){const te=C.context,le=te.gl,ce=H.heatmapFbo;if(!ce)return;te.activeTexture.set(le.TEXTURE0),le.bindTexture(le.TEXTURE_2D,ce.colorAttachment.get()),te.activeTexture.set(le.TEXTURE1);let he=H.colorRampTexture;he||(he=H.colorRampTexture=new gy(te,H.colorRamp,le.RGBA)),he.bind(le.LINEAR,le.CLAMP_TO_EDGE),C.getOrCreateProgram("heatmapTexture").draw(C,le.TRIANGLES,gx.disabled,xx.disabled,C.colorModeForRenderPass(),Ex.disabled,((C,H,te,le)=>({u_image:0,u_color_ramp:1,u_opacity:H.paint.get("heatmap-opacity")}))(0,H),H.id,C.viewportBuffer,C.quadTriangleIndexBuffer,C.viewportSegments,H.paint,C.transform.zoom)}(C,te))},line:function(C,H,te,le){if("translucent"!==C.renderPass)return;const ce=te.paint.get("line-opacity"),he=te.paint.get("line-width");if(0===ce.constantOr(1)||0===he.constantOr(1))return;const ue=te.paint.get("line-emissive-strength"),de=C.depthModeForSublayer(0,gx.ReadOnly),_e=C.colorModeForDrapableLayerRenderPass(ue),ye=C.terrain&&C.terrain.renderingToTexture?1:yi.devicePixelRatio,ve=te.paint.get("line-dasharray"),Me=ve.constantOr(1),Se=te.layout.get("line-cap"),Ae=te.paint.get("line-pattern"),Ce=Ae.constantOr(1),Oe=te.paint.get("line-pattern").constantOr(1),Ne=1!==te.paint.get("line-opacity").constantOr(1);let je=!Oe&&Ne;const Ge=te.paint.get("line-gradient"),Ze=Ce?"linePattern":"line",qe=C.context,$e=qe.gl,We=kb(te);C.terrain&&C.terrain.clipOrMaskOverlapStencilType()&&(je=!1);for(const ce of le){const le=H.getTile(ce);if(Ce&&!le.patternsLoaded())continue;const he=le.getBucket(te);if(!he)continue;C.prepareDrawTile();const ue=he.programConfigurations.get(te.id),Oe=C.isTileAffectedByFog(ce),Ne=C.getOrCreateProgram(Ze,{config:ue,defines:We,overrideFog:Oe}),He=Ae.constantOr(null);if(He&&le.imageAtlas){const C=le.imageAtlas.patternPositions[He.toString()];C&&ue.setConstantPatternPositions(C)}const Xe=ve.constantOr(null),Ye=Se.constantOr(null);if(!Ce&&Xe&&Ye&&le.lineAtlas){const C=le.lineAtlas.getDash(Xe,Ye);C&&ue.setConstantPatternPositions(C)}let[Je,Qe]=te.paint.get("line-trim-offset");if("round"===Ye||"square"===Ye){const C=1;Je!==Qe&&(0===Je&&(Je-=C),1===Qe&&(Qe+=C))}const tt=C.terrain?ce.projMatrix:null,rt=Ce?Pb(C,le,te,tt,ye):Db(C,le,te,tt,he.lineClipsArray.length,ye,[Je,Qe]);if(Ge){const le=he.gradients[te.id];let ue=le.texture;if(te.gradientVersion!==le.version){let de=256;if(te.stepInterpolant){const te=H.getSource().maxzoom,le=ce.canonical.z===te?Math.ceil(1<<C.transform.maxZoom-ce.canonical.z):1;de=z(U(he.maxLineLength/wn*1024*le),256,qe.maxTextureSize)}le.gradient=Yp({expression:te.gradientExpression(),evaluationKey:"lineProgress",resolution:de,image:le.gradient||void 0,clips:he.lineClipsArray}),le.texture?le.texture.update(le.gradient):le.texture=new gy(qe,le.gradient,$e.RGBA),le.version=te.gradientVersion,ue=le.texture}qe.activeTexture.set($e.TEXTURE1),ue.bind(te.stepInterpolant?$e.NEAREST:$e.LINEAR,$e.CLAMP_TO_EDGE)}Me&&(qe.activeTexture.set($e.TEXTURE0),le.lineAtlasTexture.bind($e.LINEAR,$e.REPEAT),ue.updatePaintBuffers()),Ce&&(qe.activeTexture.set($e.TEXTURE0),le.imageAtlasTexture.bind($e.LINEAR,$e.CLAMP_TO_EDGE),ue.updatePaintBuffers()),C.uploadCommonUniforms(qe,Ne,ce.toUnwrapped());const D=H=>{Ne.draw(C,$e.TRIANGLES,de,H,_e,Ex.disabled,rt,te.id,he.layoutVertexBuffer,he.indexBuffer,he.segments,te.paint,C.transform.zoom,ue,[he.layoutVertexBuffer2])};if(je){const H=C.stencilModeForClipping(ce).ref;0===H&&C.terrain&&qe.clear({stencil:0});const te={func:$e.EQUAL,mask:255};rt.u_alpha_discard_threshold=.8,D(new xx(te,H,255,$e.KEEP,$e.KEEP,$e.INVERT)),rt.u_alpha_discard_threshold=0,D(new xx(te,H,255,$e.KEEP,$e.KEEP,$e.KEEP))}else D(C.stencilModeForClipping(ce))}je&&(C.resetStencilClippingMasks(),C.terrain&&qe.clear({stencil:0}))},fill:function(C,H,te,le){const ce=te.paint.get("fill-color"),he=te.paint.get("fill-opacity");if(0===he.constantOr(1))return;const ue=te.paint.get("fill-emissive-strength"),de=C.colorModeForDrapableLayerRenderPass(ue),_e=te.paint.get("fill-pattern"),ye=C.opaquePassEnabledForLayer()&&!_e.constantOr(1)&&1===ce.constantOr(kr.transparent).a&&1===he.constantOr(0)?"opaque":"translucent";if(C.renderPass===ye){const ce=C.depthModeForSublayer(1,"opaque"===C.renderPass?gx.ReadWrite:gx.ReadOnly);GM(C,H,te,le,ce,de,!1)}if("translucent"===C.renderPass&&te.paint.get("fill-antialias")){const ce=C.depthModeForSublayer(te.getPaintProperty("fill-outline-color")?2:0,gx.ReadOnly);GM(C,H,te,le,ce,de,!0)}},"fill-extrusion":function(C,H,te,le){const ce=te.paint.get("fill-extrusion-opacity"),he=C.context,ue=he.gl,de=C.terrain,_e=de&&de.renderingToTexture,ye=te.paint.get("fill-extrusion-cutoff-fade-range");if(0===ce)return;const ve=C.conflationActive&&C.layerUsedInConflation(te,H.getSource());if(ve&&function(C,H,te,le){for(const ce of le){const le=H.getTile(ce).getBucket(te);le&&(le.updateReplacement(ce,C.replacementSource),le.uploadCentroid(C.context))}}(C,H,te,le),de||ve)for(const ce of le){const le=H.getTile(ce).getBucket(te);le&&$M(C.context,H,ce,le,te,de,ve)}if("shadow"===C.renderPass&&C.shadowRenderer){const he=C.shadowRenderer;if(de&&ce<.65&&te._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof bo)return;const ue=he.getShadowPassDepthMode(),_e=he.getShadowPassColorMode();qM(C,H,te,le,ue,xx.disabled,_e,ve)}else if("translucent"===C.renderPass){const Me=!te.paint.get("fill-extrusion-pattern").constantOr(1);if(!_e){const he=new gx(C.context.gl.LEQUAL,gx.ReadWrite,C.depthRangeFor3D);0===ye&&1===ce&&Me?qM(C,H,te,le,he,xx.disabled,bx.unblended,ve):(qM(C,H,te,le,he,xx.disabled,bx.disabled,ve),qM(C,H,te,le,he,C.stencilModeFor3D(),C.colorModeForRenderPass(),ve),C.resetStencilClippingMasks())}if(C.style.enable3dLights()&&Me&&(!de&&"globe"!==C.transform.projection.name||_e)){const ce=te.paint.get("fill-extrusion-opacity"),ye=te.paint.get("fill-extrusion-ambient-occlusion-intensity"),Me=te.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),Se=te.paint.get("fill-extrusion-flood-light-intensity"),Ae=te.paint.get("fill-extrusion-flood-light-color").toArray01().slice(0,3),Ce=ye>0&&Me>0,Oe=Se>0,_=(C,H,te)=>(1-te)*C+te*H,g=he=>{const de=C.depthModeForSublayer(1,gx.ReadOnly,ue.LEQUAL,!0),_e=te.paint.get(he?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),Ce=_(.1,3,_e),Oe=C._showOverdrawInspector;if(!Oe){const _e=new xx({func:ue.ALWAYS,mask:255},255,255,ue.KEEP,ue.KEEP,ue.REPLACE),Oe=new bx([ue.ONE,ue.ONE,ue.ONE,ue.ONE],kr.transparent,[!1,!1,!1,!0],ue.MIN);ZM(C,H,te,le,de,_e,Oe,Ex.disabled,he,"sdf",ce,ye,Me,Se,Ae,Ce,ve,!1)}{const _e=Oe?xx.disabled:new xx({func:ue.EQUAL,mask:255},255,255,ue.KEEP,ue.DECR,ue.DECR),Ne=Oe?C.colorModeForRenderPass():new bx([ue.ONE_MINUS_DST_ALPHA,ue.DST_ALPHA,ue.ONE,ue.ONE],kr.transparent,[!0,!0,!0,!0]);ZM(C,H,te,le,de,_e,Ne,Ex.disabled,he,"color",ce,ye,Me,Se,Ae,Ce,ve,!1)}};if(_e){const l=(he,de,_e)=>{const Ce=C.depthModeForSublayer(1,gx.ReadOnly,ue.LEQUAL,!1),Oe=te.paint.get(he?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),Ne=_(.1,3,Oe);{const _e=new bx([ue.ONE,ue.ONE,ue.ONE,ue.ONE],kr.transparent,[!1,!1,!1,!0]);ZM(C,H,te,le,Ce,xx.disabled,_e,Ex.disabled,he,"clear",ce,ye,Me,Se,Ae,Ne,ve,de)}{const _e=new xx({func:ue.ALWAYS,mask:255},255,255,ue.KEEP,ue.KEEP,ue.REPLACE),Oe=new bx([ue.ONE,ue.ONE,ue.ONE,ue.ONE],kr.transparent,[!1,!1,!1,!0],ue.MIN);ZM(C,H,te,le,Ce,_e,Oe,Ex.disabled,he,"sdf",ce,ye,Me,Se,Ae,Ne,ve,de)}{const _e=he?ue.ZERO:ue.ONE_MINUS_DST_ALPHA,Oe=new xx({func:ue.EQUAL,mask:255},255,255,ue.KEEP,ue.DECR,ue.DECR),je=new bx([_e,ue.DST_ALPHA,ue.ONE_MINUS_DST_ALPHA,ue.ZERO],kr.transparent,[!0,!0,!0,!0]);ZM(C,H,te,le,Ce,Oe,je,Ex.disabled,he,"color",ce,ye,Me,Se,Ae,Ne,ve,de)}{const Oe=new bx([ue.ONE,ue.ONE,ue.ONE,he?ue.ZERO:ue.ONE],kr.transparent,[!1,!1,!1,!0],he?ue.FUNC_ADD:ue.MAX);ZM(C,H,te,le,Ce,xx.disabled,Oe,Ex.disabled,he,"clear",ce,ye,Me,Se,Ae,Ne,ve,de,_e)}};if(Ce||Oe){let H;if(C.prepareDrawTile(),de){const C=de.drapeBufferSize[0],te=de.drapeBufferSize[1];H=de.framebufferCopyTexture,H&&(!H||H.size[0]===C&&H.size[1]===te)||(H&&H.destroy(),H=de.framebufferCopyTexture=new gy(he,new $p({width:C,height:te}),ue.RGBA)),H.bind(ue.LINEAR,ue.CLAMP_TO_EDGE),ue.copyTexImage2D(ue.TEXTURE_2D,0,ue.RGBA,0,0,C,te,0)}Ce&&l(!0,!1,H),Oe&&l(!1,!0,H)}}else Ce&&g(!0),Oe&&g(!1)}}},hillshade:function(C,H,te,le){if("offscreen"!==C.renderPass&&"translucent"!==C.renderPass)return;const ce=C.context,he=C.terrain&&C.terrain.renderingToTexture,[ue,de]="translucent"!==C.renderPass||he?[{},le]:C.stencilConfigForOverlap(le);for(const le of de){const ce=H.getTile(le);if(ce.needsHillshadePrepare&&"offscreen"===C.renderPass)jE(C,ce,te);else if("translucent"===C.renderPass){const H=C.depthModeForSublayer(0,gx.ReadOnly),de=te.paint.get("hillshade-emissive-strength"),_e=C.colorModeForDrapableLayerRenderPass(de),ye=he&&C.terrain?C.terrain.stencilModeForRTTOverlap(le):ue[le.overscaledZ];UE(C,le,ce,te,H,ye,_e)}}ce.viewport.set([0,0,C.width,C.height]),C.resetStencilClippingMasks()},raster:function(C,H,te,le,ce,he){if("translucent"!==C.renderPass)return;if(0===te.paint.get("raster-opacity"))return;const ue=C.context,de=ue.gl,_e=H.getSource(),ye=function(C,H,te){const le=[];let ce,he;if(C.paint.get("raster-color")){le.push("RASTER_COLOR"),ce=C.paint.get("raster-color-mix"),he=C.paint.get("raster-color-range"),H.activeTexture.set(te.TEXTURE2);let ue=C.colorRampTexture;ue||(ue=C.colorRampTexture=new gy(H,C.colorRamp,te.RGBA)),ue.bind(te.LINEAR,te.CLAMP_TO_EDGE)}return{mix:ce,range:he,defines:le}}(te,ue,de),ve=ye.defines;let Me=!1;if(_e instanceof qb&&!le.length){if("globe"!==C.transform.projection.name)return;if(_e.onNorthPole)Me=!0,ve.push("PROJECTION_GLOBE_VIEW");else{if(!_e.onSouthPole)return;Me=!0,ve.push("PROJECTION_GLOBE_VIEW")}}const Se=C.colorModeForDrapableLayerRenderPass(),Ae=C.terrain&&C.terrain.renderingToTexture,Ce=!C.options.moving,Oe="nearest"===te.paint.get("raster-resampling")?de.NEAREST:de.LINEAR;if(Me){const le=H.getSource();if(!(le instanceof qb))return;const ce=le.texture;if(!ce)return;const he=C.globeSharedBuffers;if(!he)return;const _e=new gx(de.LEQUAL,gx.ReadWrite,C.depthRangeFor3D),ve=Float32Array.from(C.transform.projMatrix);let Me=Md(0,0,C.transform);const Ae=Float32Array.from(xd(ad(new ku(0,0,0)))),Ce={opacity:1,mix:0};C.terrain&&C.terrain.prepareDrawTile(),ue.activeTexture.set(de.TEXTURE0),ce.bind(Oe,de.CLAMP_TO_EDGE),ue.activeTexture.set(de.TEXTURE1),ce.bind(Oe,de.CLAMP_TO_EDGE),ce.useMipmap&&ue.extTextureFilterAnisotropic&&C.transform.pitch>20&&de.texParameterf(de.TEXTURE_2D,ue.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,ue.extTextureFilterAnisotropicMax);const[Ne,je,Ge,Ze]=he.getPoleBuffers(0,!0);let qe;le.onNorthPole?(qe=Ne,C.renderDefaultNorthPole=!1):(Me=ed.scale(ed.create(),Me,[1,-1,1]),qe=je,C.renderDefaultSouthPole=!1);const $e=bM(ve,Ae,Me,[0,0],1,Ce,te,le.perspectiveTransform||[0,0],2,ye.mix||[0,0,0,0],ye.range||[0,0]),We=C.getOrCreateProgram("raster",{defines:ye.defines});return C.uploadCommonUniforms(ue,We,null),void We.draw(C,de.TRIANGLES,_e,xx.disabled,Se,Ex.disabled,$e,te.id,qe,Ge,Ze)}if(!le.length)return;const[Ne,je]=_e instanceof qb||Ae?[{},le]:C.stencilConfigForOverlap(le),Ge=je[je.length-1].overscaledZ;for(const le of je){const ce=Ae?gx.disabled:C.depthModeForSublayer(le.overscaledZ-Ge,1===te.paint.get("raster-opacity")?gx.ReadWrite:gx.ReadOnly,de.LESS),ve=le.toUnwrapped(),Me=H.getTile(le);if(Ae&&(!Me||!Me.hasData()))continue;if(!Me.texture)continue;const je=Ae?le.projMatrix:C.transform.calculateProjMatrix(ve,Ce),Ze=C.terrain&&Ae?C.terrain.stencilModeForRTTOverlap(le):Ne[le.overscaledZ],qe=he?0:te.paint.get("raster-fade-duration");Me.registerFadeDuration(qe);const $e=H.findLoadedParent(le,0),We=QE(Me,$e,H,C.transform,qe);let He,Xe;C.terrain&&C.terrain.prepareDrawTile(),ue.activeTexture.set(de.TEXTURE0),Me.texture.bind(Oe,de.CLAMP_TO_EDGE),ue.activeTexture.set(de.TEXTURE1),$e?($e.texture.bind(Oe,de.CLAMP_TO_EDGE),He=Math.pow(2,$e.tileID.overscaledZ-Me.tileID.overscaledZ),Xe=[Me.tileID.canonical.x*He%1,Me.tileID.canonical.y*He%1]):Me.texture.bind(Oe,de.CLAMP_TO_EDGE),Me.texture.useMipmap&&ue.extTextureFilterAnisotropic&&C.transform.pitch>20&&de.texParameterf(de.TEXTURE_2D,ue.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,ue.extTextureFilterAnisotropicMax);const Ye=_e instanceof qb?_e.perspectiveTransform:[0,0],Je=new Float32Array(16),Qe=bM(je,Je,Je,Xe||[0,0],He||1,We,te,Ye,2,ye.mix||[0,0,0,0],ye.range||[0,0]),tt=C.isTileAffectedByFog(le),rt=C.getOrCreateProgram("raster",{defines:ye.defines,overrideFog:tt});if(C.uploadCommonUniforms(ue,rt,ve),_e instanceof qb)_e.boundsBuffer&&_e.boundsSegments&&rt.draw(C,de.TRIANGLES,ce,xx.disabled,Se,Ex.disabled,Qe,te.id,_e.boundsBuffer,C.quadTriangleIndexBuffer,_e.boundsSegments);else{const{tileBoundsBuffer:H,tileBoundsIndexBuffer:le,tileBoundsSegments:he}=C.getTileBoundsBuffers(Me);rt.draw(C,de.TRIANGLES,ce,Ze,Se,Ex.disabled,Qe,te.id,H,le,he)}}C.resetStencilClippingMasks()},background:function(C,H,te,le){const ce=te.paint.get("background-color"),he=te.paint.get("background-opacity"),ue=te.paint.get("background-emissive-strength");if(0===he)return;const de=C.context,_e=de.gl,ye=C.transform,ve=ye.tileSize,Me=te.paint.get("background-pattern");if(C.isPatternMissing(Me,te.scope))return;const Se=!Me&&1===ce.a&&1===he&&C.opaquePassEnabledForLayer()?"opaque":"translucent";if(C.renderPass!==Se)return;const Ae=xx.disabled,Ce=C.depthModeForSublayer(0,"opaque"===Se?gx.ReadWrite:gx.ReadOnly),Oe=C.colorModeForDrapableLayerRenderPass(ue),Ne=Me?"backgroundPattern":"background";let je,Ge=le;Ge||(je=C.getBackgroundTiles(),Ge=Object.values(je).map((C=>C.tileID))),Me&&(de.activeTexture.set(_e.TEXTURE0),C.imageManager.bind(C.context,te.scope));for(const Se of Ge){const Ge=C.isTileAffectedByFog(Se),Ze=C.getOrCreateProgram(Ne,{overrideFog:Ge}),qe=Se.toUnwrapped(),$e=le?Se.projMatrix:C.transform.calculateProjMatrix(qe);C.prepareDrawTile();const We=H?H.getTile(Se):je?je[Se.key]:new Iy(Se,ve,ye.zoom,C),He=Me?CM($e,ue,he,C,Me,te.scope,{tileID:Se,tileSize:ve}):IM($e,ue,he,ce);C.uploadCommonUniforms(de,Ze,qe);const{tileBoundsBuffer:Xe,tileBoundsIndexBuffer:Ye,tileBoundsSegments:Je}=C.getTileBoundsBuffers(We);Ze.draw(C,_e.TRIANGLES,Ce,Ae,Oe,Ex.disabled,He,te.id,Xe,Ye,Je)}},sky:function(C,H,te){const le=C._atmosphere?Ed(C.transform.zoom):1,ce=te.paint.get("sky-opacity")*le;if(0===ce)return;const he=C.context,ue=te.paint.get("sky-type"),de=new gx(he.gl.LEQUAL,gx.ReadOnly,[0,1]),_e=C.frameCounter/1e3%1;"atmosphere"===ue?"offscreen"===C.renderPass?te.needsSkyboxCapture(C)&&(function(C,H,te,le){const ce=C.context,he=ce.gl;let ue=H.skyboxFbo;if(!ue){ue=H.skyboxFbo=ce.createFramebuffer(32,32,!0,null),H.skyboxGeometry=new cA(ce),H.skyboxTexture=ce.gl.createTexture(),he.bindTexture(he.TEXTURE_CUBE_MAP,H.skyboxTexture),he.texParameteri(he.TEXTURE_CUBE_MAP,he.TEXTURE_WRAP_S,he.CLAMP_TO_EDGE),he.texParameteri(he.TEXTURE_CUBE_MAP,he.TEXTURE_WRAP_T,he.CLAMP_TO_EDGE),he.texParameteri(he.TEXTURE_CUBE_MAP,he.TEXTURE_MIN_FILTER,he.LINEAR),he.texParameteri(he.TEXTURE_CUBE_MAP,he.TEXTURE_MAG_FILTER,he.LINEAR);for(let C=0;C<6;++C)he.texImage2D(he.TEXTURE_CUBE_MAP_POSITIVE_X+C,0,he.RGBA,32,32,0,he.RGBA,he.UNSIGNED_BYTE,null)}ce.bindFramebuffer.set(ue.framebuffer),ce.viewport.set([0,0,32,32]);const de=H.getCenter(C,!0),_e=C.getOrCreateProgram("skyboxCapture"),ye=new Float64Array(16);ed.identity(ye),ed.rotateY(ye,ye,.5*-Math.PI),hA(C,H,_e,ye,de,0),ed.identity(ye),ed.rotateY(ye,ye,.5*Math.PI),hA(C,H,_e,ye,de,1),ed.identity(ye),ed.rotateX(ye,ye,.5*-Math.PI),hA(C,H,_e,ye,de,2),ed.identity(ye),ed.rotateX(ye,ye,.5*Math.PI),hA(C,H,_e,ye,de,3),ed.identity(ye),hA(C,H,_e,ye,de,4),ed.identity(ye),ed.rotateY(ye,ye,Math.PI),hA(C,H,_e,ye,de,5),ce.viewport.set([0,0,C.width,C.height])}(C,te),te.markSkyboxValid(C)):"sky"===C.renderPass&&function(C,H,te,le,ce){const he=C.context,ue=he.gl,de=C.transform,_e=C.getOrCreateProgram("skybox");he.activeTexture.set(ue.TEXTURE0),ue.bindTexture(ue.TEXTURE_CUBE_MAP,H.skyboxTexture);const ye=((C,H,te,le,ce)=>({u_matrix:C,u_sun_direction:H,u_cubemap:0,u_opacity:le,u_temporal_offset:ce}))(de.skyboxMatrix,H.getCenter(C,!1),0,le,ce);C.uploadCommonUniforms(he,_e),_e.draw(C,ue.TRIANGLES,te,xx.disabled,C.colorModeForRenderPass(),Ex.backCW,ye,"skybox",H.skyboxGeometry.vertexBuffer,H.skyboxGeometry.indexBuffer,H.skyboxGeometry.segment)}(C,te,de,ce,_e):"gradient"===ue&&"sky"===C.renderPass&&function(C,H,te,le,ce){const he=C.context,ue=he.gl,de=C.transform,_e=C.getOrCreateProgram("skyboxGradient");H.skyboxGeometry||(H.skyboxGeometry=new cA(he)),he.activeTexture.set(ue.TEXTURE0);let ye=H.colorRampTexture;ye||(ye=H.colorRampTexture=new gy(he,H.colorRamp,ue.RGBA)),ye.bind(ue.LINEAR,ue.CLAMP_TO_EDGE);const ve=((C,H,te,le,ce)=>({u_matrix:C,u_color_ramp:0,u_center_direction:H,u_radius:w(te),u_opacity:le,u_temporal_offset:ce}))(de.skyboxMatrix,H.getCenter(C,!1),H.paint.get("sky-gradient-radius"),le,ce);C.uploadCommonUniforms(he,_e),_e.draw(C,ue.TRIANGLES,te,xx.disabled,C.colorModeForRenderPass(),Ex.backCW,ve,"skyboxGradient",H.skyboxGeometry.vertexBuffer,H.skyboxGeometry.indexBuffer,H.skyboxGeometry.segment)}(C,te,de,ce,_e)},debug:function(C,H,te){for(let le=0;le<te.length;le++)iA(C,H,te[le])},custom:function(C,H,te,le){const ce=C.context,he=te.implementation;if(!C.transform.projection.unsupportedLayers||!C.transform.projection.unsupportedLayers.includes("custom")||C.terrain&&(C.terrain.renderingToTexture||"offscreen"===C.renderPass)&&te.isLayerDraped(H)){if("offscreen"===C.renderPass){const H=he.prerender;if(H){if(C.setCustomLayerDefaults(),ce.setColorMode(C.colorModeForRenderPass()),"globe"===C.transform.projection.name){const te=C.transform.pointMerc;H.call(he,ce.gl,C.transform.customLayerMatrix(),C.transform.getProjection(),C.transform.globeToMercatorMatrix(),Ed(C.transform.zoom),[te.x,te.y],C.transform.pixelsPerMeterRatio)}else H.call(he,ce.gl,C.transform.customLayerMatrix());ce.setDirty(),C.setBaseState()}}else if("translucent"===C.renderPass){if(C.terrain&&C.terrain.renderingToTexture){const H=he.renderToTile;if(H){const te=le[0].canonical,ue=new ep(te.x+le[0].wrap*(1<<te.z),te.y,te.z);ce.setDepthMode(gx.disabled),ce.setStencilMode(xx.disabled),ce.setColorMode(C.colorModeForRenderPass()),C.setCustomLayerDefaults(),H.call(he,ce.gl,ue),ce.setDirty(),C.setBaseState()}return}C.setCustomLayerDefaults(),ce.setColorMode(C.colorModeForRenderPass()),ce.setStencilMode(xx.disabled);const H="3d"===he.renderingMode?new gx(C.context.gl.LEQUAL,gx.ReadWrite,C.depthRangeFor3D):C.depthModeForSublayer(0,gx.ReadOnly);if(ce.setDepthMode(H),"globe"===C.transform.projection.name){const H=C.transform.pointMerc;he.render(ce.gl,C.transform.customLayerMatrix(),C.transform.getProjection(),C.transform.globeToMercatorMatrix(),Ed(C.transform.zoom),[H.x,H.y],C.transform.pixelsPerMeterRatio)}else he.render(ce.gl,C.transform.customLayerMatrix());ce.setDirty(),C.setBaseState(),ce.bindFramebuffer.set(null)}}else W("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(C,H,te,le){if("opaque"===C.renderPass)return;const ce=te.paint.get("model-opacity");if(0===ce)return;const he=te.paint.get("model-cast-shadows");if("shadow"===C.renderPass){if(!he)return;if(C.terrain&&ce<.65&&te._transitionablePaint._values["model-opacity"].value.expression instanceof bo)return}const ue=C.shadowRenderer,de=te.paint.get("model-receive-shadows");ue&&(ue.useNormalOffset=!0,de||(ue.enabled=!1));const l=()=>{ue&&(ue.useNormalOffset=!0,de||(ue.enabled=!0))},_e=H.getSource();if("light-beam"===C.renderPass&&"batched-model"!==_e.type)return;if("vector"===_e.type||"geojson"===_e.type)return function(C,H,te,le){const ce=C.transform;if("mercator"!==ce.projection.name)return void W(`Drawing 3D models for ${ce.projection.name} projection is not yet implemented`);const he=ce.getFreeCameraOptions().position;if(!C.modelManager)return;const ue=C.modelManager,de=C.shadowRenderer;if(!te._unevaluatedLayout._values.hasOwnProperty("model-id"))return;const _e=te._unevaluatedLayout._values["model-id"],ye={...te.layout.get("model-id").parameters};for(const ve of le){const le=H.getTile(ve).getBucket(te);if(!le||le.projection.name!==ce.projection.name)continue;const Me=wA(ve,ce);ye.zoom=Me;const Se=_e.possiblyEvaluate(ye);if(vA(C,le,ve),QA.shadowUniformsInitialized=!1,QA.useSingleShadowCascade=!!de&&0===de.getMaxCascadeForTile(ve.toUnwrapped()),"shadow"===C.renderPass&&de){if(1===C.currentShadowCascade&&le.isInsideFirstShadowMapFrustum)continue;const H=ce.calculatePosMatrix(ve.toUnwrapped(),ce.worldSize);if(QA.tileMatrix.set(H),QA.shadowTileMatrix=Float32Array.from(de.calculateShadowPassMatrixFromMatrix(H)),QA.aabb.min.fill(0),QA.aabb.max[0]=QA.aabb.max[1]=wn,QA.aabb.max[2]=0,MA(le,QA,C,te.scope))continue}const Ae=1<<ve.canonical.z,Ce=[((he.x-ve.wrap)*Ae-ve.canonical.x)*wn,(he.y*Ae-ve.canonical.y)*wn,he.z*Ae*wn];for(let H in le.instancesPerModel){const ce=le.instancesPerModel[H];ce.features.length>0&&(H=Se.evaluate(ce.features[0].feature,{}));const he=ue.getModel(H,te.scope);if(he&&he.uploaded)for(const H of he.nodes)TA(C,te,H,ce,Ce,ve,QA)}}}(C,H,te,le),void l();if(!_e.loaded())return;if("batched-model"===_e.type)return function(C,H,te,le){const ce=C.context,he=C.transform,ue=C.style.fog,de=C.shadowRenderer;if("mercator"!==he.projection.name)return void W(`Drawing 3D landmark models for ${he.projection.name} projection is not yet implemented`);const _e=C.transform.getFreeCameraOptions().position,ye=Ld.scale([],[_e.x,_e.y,_e.z],C.transform.worldSize);Ld.negate(ye,ye);const ve=ed.identity([]),Me=Kd(he.center.lat,he.zoom),Se=ed.fromScaling([],[1,1,1/Me]);ed.translate(ve,ve,ye);const Ae=te.paint.get("model-opacity"),Ce=new gx(ce.gl.LEQUAL,gx.ReadWrite,C.depthRangeFor3D),Oe=new gx(ce.gl.LEQUAL,gx.ReadOnly,C.depthRangeFor3D),_=function(_e,ye){for(const Me of le){const le=H.getTile(Me).getBucket(te);if(!le||!le.uploaded)continue;let Ne=!1;de&&(Ne=0===de.getMaxCascadeForTile(Me.toUnwrapped()));const je=he.calculatePosMatrix(Me.toUnwrapped(),he.worldSize),Ge=le.modelTraits;for(const H of le.getNodesInfo()){if(H.hiddenByReplacement)continue;if(!H.node.meshes)continue;const le=H.node,Ze="light-beam"===C.renderPass,qe=[...je],$e=H.evaluatedScale;let We=0;C.terrain&&le.elevation&&(We=le.elevation*C.terrain.exaggeration()),ed.translate(qe,qe,[(le.anchor?le.anchor[0]:0)*($e[0]-1),(le.anchor?le.anchor[1]:0)*($e[1]-1),We]),$e!==Vb&&ed.scale(qe,qe,$e),ed.multiply(qe,qe,le.matrix);const He=ed.multiply([],Se,qe);ed.multiply(He,ve,He);const Xe=ed.invert([],He);ed.transpose(Xe,Xe),ed.scale(Xe,Xe,iI);const Ye=ed.multiply([],he.projMatrix,qe);for(let ve=0;ve<le.meshes.length;++ve){const Se=le.meshes[ve],je=ve===le.lightMeshIndex;if(je){if(!Ze&&!C.terrain&&C.shadowRenderer){C.currentLayer<C.firstLightBeamLayer&&(C.firstLightBeamLayer=C.currentLayer);continue}}else if(Ze)continue;const $e={defines:[]},We=[];_A($e.defines,We,Se,C),4&Ge||$e.defines.push("DIFFUSE_SHADED"),Ne&&$e.defines.push("SHADOWS_SINGLE_CASCADE");const Je="shadow"===C.renderPass;if(Je){xA(Se,qe,C,te);continue}let Qe=null;if(ue){const H=mA(qe,C.transform);if(Qe=new Float32Array(H),"globe"!==he.projection.name){const C=Se.aabb.min,te=Se.aabb.max,[le,ce]=ue.getOpacityForBounds(H,C[0],C[1],te[0],te[1]);$e.overrideFog=le>=AT||ce>=AT}}const tt=C.getOrCreateProgram("model",$e);!Je&&de&&(de.useNormalOffset=!!Se.normalBuffer,de.setupShadowsFromMatrix(qe,tt,de.useNormalOffset)),C.uploadCommonUniforms(ce,tt,Me.toUnwrapped(),Qe);const rt=Se.material,ot=rt.pbrMetallicRoughness;ot.metallicFactor=.9,ot.roughnessFactor=.5;const st=DM(new Float32Array(Ye),new Float32Array(He),new Float32Array(Xe),C,Ae,ot.baseColorFactor,rt.emissiveFactor,ot.metallicFactor,ot.roughnessFactor,rt,te);tt.draw(C,ce.gl.TRIANGLES,ye&&!je?Ce:Oe,xx.disabled,_e?je||Ae<1||H.hasTranslucentParts?bx.alphaBlended:bx.unblended:bx.disabled,Ex.backCCW,st,te.id,Se.vertexBuffer,Se.indexBuffer,Se.segments,te.paint,C.transform.zoom,void 0,We)}}}};(function(C,H,te,le){const ce=C.terrain?C.terrain.exaggeration():0,he=C.transform.zoom;for(const ue of le){const le=H.getTile(ue).getBucket(te);le&&(C.conflationActive&&le.updateReplacement(ue,C.replacementSource),le.evaluateScale(C,te),C.terrain&&ce>0&&le.elevationUpdate(C.terrain,ce,ue,te.source),le.needsReEvaluation(C,he,te)&&le.evaluate(te))}})(C,H,te,le),1===Ae?_(!0,!0):(_(!1,!0),_(!0,!1))}(C,H,te,le),void l();const ye=_e.getModels(),ve=[],Me=C.transform.getFreeCameraOptions().position,Se=Ld.scale([],[Me.x,Me.y,Me.z],C.transform.worldSize);Ld.negate(Se,Se);const Ae=[],Ce=[];let Oe=0;for(const H of ye){const le=te.paint.get("model-rotation").constantOr(null),ce=te.paint.get("model-scale").constantOr(null),he=te.paint.get("model-translation").constantOr(null);H.computeModelMatrix(C,le,ce,he,!0,!0,!1);const ue=ed.identity([]),de=Kd(H.position.lat,C.transform.zoom),_e=ed.fromScaling([],[1,1,1/de]);ed.translate(ue,ue,Se),ve.push({zScaleMatrix:_e,negCameraPosMatrix:ue});for(const te of H.nodes)yA(C.transform,te,H.matrix,C.transform.projMatrix,Oe,Ae,Ce);Oe++}if(Ae.sort(((C,H)=>H.depth-C.depth)),"shadow"!==C.renderPass){if(1===ce)for(const H of Ce)gA(H,C,te,ve[H.modelIndex],xx.disabled,C.colorModeForRenderPass());else{for(const H of Ce)gA(H,C,te,ve[H.modelIndex],xx.disabled,bx.disabled);for(const H of Ce)gA(H,C,te,ve[H.modelIndex],C.stencilModeFor3D(),C.colorModeForRenderPass());C.resetStencilClippingMasks()}for(const H of Ae)gA(H,C,te,ve[H.modelIndex],xx.disabled,C.colorModeForRenderPass());l()}else{for(const H of Ce)xA(H.mesh,H.nodeModelMatrix,C,te);for(const H of Ae)xA(H.mesh,H.nodeModelMatrix,C,te);l()}}},nI={modelUpload:function(C,H,te){const le=H.getSource();if(!le.loaded())return;if("vector"===le.type||"geojson"===le.type)return void(C.modelManager&&C.modelManager.upload(C,te));if("batched-model"===le.type)return;const ce=le.getModels();for(const H of ce)H.upload(C.context)}};class zA{constructor(C,H){this.context=new Mx(C),this.transform=H,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.setup(),this.numSublayers=Ax.maxUnderzooming+Ax.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new Vv,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new LA(this),this._wireframeDebugCache=new SA,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0}updateTerrain(C,H){const te=!!C&&!!C.terrain&&this.transform.projection.supportsTerrain;if(!(te||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new rM(this,C));const le=this._terrain;this.transform.elevation=te?le:null,le.update(C,this.transform,H),this.transform.elevation&&!le.enabled&&(this.transform.elevation=null)}_updateFog(C){const H=C.fog;if(!H||"globe"===this.transform.projection.name||H.getOpacity(this.transform.pitch)<1||H.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[te,le]=H.getFovAdjustedRange(this.transform._fov);if(te>le)return void(this.transform.fogCullDistSq=null);const ce=te+.78*(le-te);this.transform.fogCullDistSq=ce*ce}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled?this._terrain:null}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(C,H){if(this.width=C*yi.devicePixelRatio,this.height=H*yi.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const C of this.style.order)this.style._mergedLayers[C].resize()}setup(){const C=this.context,H=new Ta;H.emplaceBack(0,0),H.emplaceBack(wn,0),H.emplaceBack(0,wn),H.emplaceBack(wn,wn),this.tileExtentBuffer=C.createVertexBuffer(H,Vd.members),this.tileExtentSegments=dl.simpleSegment(0,0,4,2);const le=new Ta;le.emplaceBack(0,0),le.emplaceBack(wn,0),le.emplaceBack(0,wn),le.emplaceBack(wn,wn),this.debugBuffer=C.createVertexBuffer(le,Vd.members),this.debugSegments=dl.simpleSegment(0,0,4,5);const ce=new Ta;ce.emplaceBack(-1,-1),ce.emplaceBack(1,-1),ce.emplaceBack(-1,1),ce.emplaceBack(1,1),this.viewportBuffer=C.createVertexBuffer(ce,Vd.members),this.viewportSegments=dl.simpleSegment(0,0,4,2);const he=new Ma;he.emplaceBack(0,0,0,0),he.emplaceBack(wn,0,wn,0),he.emplaceBack(0,wn,0,wn),he.emplaceBack(wn,wn,wn,wn),this.mercatorBoundsBuffer=C.createVertexBuffer(he,Dv.members),this.mercatorBoundsSegments=dl.simpleSegment(0,0,4,2);const ue=new Va;ue.emplaceBack(0,1,2),ue.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=C.createIndexBuffer(ue);const de=new Wa;for(const C of[0,1,3,2,0])de.emplaceBack(C);this.debugIndexBuffer=C.createIndexBuffer(de),this.emptyTexture=new gy(C,new $p({width:1,height:1},Uint8Array.of(0,0,0,0)),C.gl.RGBA),this.identityMat=ed.create();const _e=this.context.gl;this.stencilClearMode=new xx({func:_e.ALWAYS,mask:0},0,255,_e.ZERO,_e.ZERO,_e.ZERO),this.loadTimeStamps.push(te.performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(C){return C._makeTileBoundsBuffers(this.context,this.transform.projection),C._tileBoundsBuffer?{tileBoundsBuffer:C._tileBoundsBuffer,tileBoundsIndexBuffer:C._tileBoundsIndexBuffer,tileBoundsSegments:C._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const C=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,C.TRIANGLES,gx.disabled,this.stencilClearMode,bx.disabled,Ex.disabled,JE(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(C,H,te){if(!H||this.currentStencilSource===H.id||!C.isTileClipped()||!te||0===te.length)return;if(this._tileClippingMaskIDs&&!this.terrain){let C=!1;for(const H of te)if(void 0===this._tileClippingMaskIDs[H.key]){C=!0;break}if(!C)return}this.currentStencilSource=H.id;const le=this.context,ce=le.gl;this.nextStencilID+te.length>256&&this.clearStencil(),le.setColorMode(bx.disabled),le.setDepthMode(gx.disabled);const he=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(const C of te){const te=H.getTile(C),le=this._tileClippingMaskIDs[C.key]=this.nextStencilID++,{tileBoundsBuffer:ue,tileBoundsIndexBuffer:de,tileBoundsSegments:_e}=this.getTileBoundsBuffers(te);he.draw(this,ce.TRIANGLES,gx.disabled,new xx({func:ce.ALWAYS,mask:0},le,255,ce.KEEP,ce.KEEP,ce.REPLACE),bx.disabled,Ex.disabled,JE(C.projMatrix),"$clipping",ue,de,_e)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const C=this.nextStencilID++,H=this.context.gl;return new xx({func:H.NOTEQUAL,mask:255},C,255,H.KEEP,H.KEEP,H.REPLACE)}stencilModeForClipping(C){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(C);const H=this.context.gl;return new xx({func:H.EQUAL,mask:255},this._tileClippingMaskIDs[C.key],0,H.KEEP,H.KEEP,H.REPLACE)}stencilConfigForOverlap(C){const H=this.context.gl,te=C.sort(((C,H)=>H.overscaledZ-C.overscaledZ)),le=te[te.length-1].overscaledZ,ce=te[0].overscaledZ-le+1;if(ce>1){this.currentStencilSource=void 0,this.nextStencilID+ce>256&&this.clearStencil();const C={};for(let te=0;te<ce;te++)C[te+le]=new xx({func:H.GEQUAL,mask:255},te+this.nextStencilID,255,H.KEEP,H.KEEP,H.REPLACE);return this.nextStencilID+=ce,[C,te]}return[{[le]:xx.disabled},te]}colorModeForRenderPass(){const C=this.context.gl;if(this._showOverdrawInspector){const H=1/8;return new bx([C.CONSTANT_COLOR,C.ONE,C.CONSTANT_COLOR,C.ONE],new kr(H,H,H,0),[!0,!0,!0,!0])}return"opaque"===this.renderPass?bx.unblended:bx.alphaBlended}colorModeForDrapableLayerRenderPass(C){const H=this.context.gl;return(()=>this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture)()&&"translucent"===this.renderPass?new bx([H.ONE,H.ONE_MINUS_SRC_ALPHA,H.CONSTANT_ALPHA,H.ONE_MINUS_SRC_ALPHA],new kr(0,0,0,void 0===C?0:C),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(C,H,te,le=!1){if(!this.opaquePassEnabledForLayer()&&!le)return gx.disabled;const ce=1-((1+this.currentLayer)*this.numSublayers+C)*this.depthEpsilon;return new gx(te||this.context.gl.LEQUAL,H,[ce,ce])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(C,H){this._wireframeDebugCache.update(this.frameCounter),this.style=C,this.options=H;const le=this.style._mergedLayers,ce=this.style.order,he=ce.map((C=>le[C])),ue=this.style._mergedSourceCaches;this.imageManager=C.imageManager,this.modelManager=C.modelManager,this.symbolFadeChange=C.placement.symbolFadeChange(yi.now()),this.imageManager.beginFrame();let de=0,_e=!1;for(const C in ue){const H=ue[C];H.used&&(H.prepare(this.context),H.getSource().usedInConflation&&++de)}const ye={},ve={},Me={},Se={},Ae={};for(const C in ue){const H=ue[C];ye[C]=H.getVisibleCoordinates(),ve[C]=ye[C].slice().reverse(),Me[C]=H.getVisibleCoordinates(!0).reverse(),Se[C]=H.getShadowCasterCoordinates(),Ae[C]=H.sortCoordinatesByDistance(ye[C])}const f=C=>{const H=this.style.getLayerSourceCache(C);return H&&H.used?H.getSource():null};if(de){const C=[];for(const H of he)this.layerUsedInConflation(H,f(H))&&C.push(H);if(C&&C.length>1){const H=[];for(const te of C){const C=this.style.getLayerSourceCache(te);C&&C.used&&C.getSource().usedInConflation&&H.push({layer:te.fqid,cache:C})}this.replacementSource.setSources(H),_e=!0}}_e||this.replacementSource.clear(),this.conflationActive=_e,this.minCutoffZoom=0,this.longestCutoffRange=0;for(const C of he){const H=C.cutoffRange();if(this.longestCutoffRange=Math.max(H,this.longestCutoffRange),H>0){const H=f(C);H&&(this.minCutoffZoom=Math.max(H.minzoom,this.minCutoffZoom)),C.minzoom&&(this.minCutoffZoom=Math.max(C.minzoom,this.minCutoffZoom))}}this.opaquePassCutoff=1/0;for(let C=0;C<he.length;C++)if(he[C].is3D()){this.opaquePassCutoff=C;break}const Ce=this.style&&this.style.fog;Ce?(this._fogVisible=0!==Ce.getOpacity(this.transform.pitch),this._fogVisible&&"globe"!==this.transform.projection.name&&(this._fogVisible=Ce.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(Me),this.opaquePassCutoff=0);const Oe=this._shadowRenderer;if(Oe){Oe.updateShadowParameters(this.transform,this.style.directionalLight);for(const C in ue)for(const H of ye[C]){let C={min:0,max:0};this.terrain&&(C=this.terrain.getMinMaxForTile(H)||C),Oe.addShadowReceiver(H.toUnwrapped(),C.min,C.max)}}"globe"!==this.transform.projection.name||this.globeSharedBuffers||(this.globeSharedBuffers=new kd(this.context));for(const H of he){if(H.isHidden(this.transform.zoom))continue;const te=C.getLayerSourceCache(H);this.uploadLayer(this,H,te)}if(this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new fA),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),!Gt.has(this.context.gl))return;this.renderPass="offscreen";for(const H of he){const te=C.getLayerSourceCache(H);if(!H.hasOffscreenPass()||H.isHidden(this.transform.zoom))continue;const le=te?ve[te.id]:void 0;("custom"===H.type||"raster"===H.type||H.isSky()||le&&le.length)&&this.renderLayer(this,te,H,le)}this.depthRangeFor3D=[0,1-(he.length+2)*this.numSublayers*this.depthEpsilon];const Ne=this.terrain;Ne&&(this.style.hasSymbolLayers()||this.style.hasCircleLayers())&&!this.transform.isOrthographic&&Ne.drawDepth(),this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,Se)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);const je="globe"===this.transform.projection.name||this.transform.isHorizonVisible(),Ge=(()=>{if(H.showOverdrawInspector)return kr.black;if(this.style.fog&&this.transform.projection.supportsFog&&!je){const C=this.style.fog.properties.get("color").toArray01();return new kr(...C)}if(this.style.fog&&this.transform.projection.supportsFog&&je){const C=this.style.fog.properties.get("space-color").toArray01();return new kr(...C)}return kr.transparent})();if(this.context.clear({color:Ge,depth:1}),this.clearStencil(),this._showOverdrawInspector=H.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&je&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=ce.length-1;this.currentLayer>=0;this.currentLayer--){const H=he[this.currentLayer],te=C.getLayerSourceCache(H);if(H.isSky())continue;const le=te?(H.is3D()?Ae:ve)[te.id]:void 0;this._renderTileClippingMasks(H,te,le),this.renderLayer(this,te,H,le)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&je&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||Ed(this.transform.zoom)>0)&&("globe"===this.transform.projection.name||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<ce.length;this.currentLayer++){const H=he[this.currentLayer],te=C.getLayerSourceCache(H);H.isSky()&&this.renderLayer(this,te,H,te?ve[te.id]:void 0)}this.renderPass="translucent",this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let Ze=0;for(Oe&&(Ze=Oe.getShadowCastingLayerCount());this.currentLayer<ce.length;){const H=he[this.currentLayer],te=C.getLayerSourceCache(H);if(H.isSky()){++this.currentLayer;continue}if(Ne&&this.style.isLayerDraped(H)){if(H.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=Ne.renderBatch(this.currentLayer);continue}let le;if(te&&(le=("symbol"===H.type?Me:H.is3D()?Ae:ve)[te.id]),this._renderTileClippingMasks(H,te,te?ye[te.id]:void 0),this.renderLayer(this,te,H,le),!Ne&&Oe&&Ze>0&&H.hasShadowPass()&&0==--Ze&&(Oe.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer)){const H=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=H;this.currentLayer++){const H=he[this.currentLayer];if(!H.hasLightBeamPass())continue;const te=C.getLayerSourceCache(H);this.renderLayer(this,te,H,te?ve[te.id]:void 0)}this.currentLayer=H,this.renderPass="translucent"}++this.currentLayer}if(this.terrain&&this.terrain.postRender(),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let H=null;he.forEach((te=>{const le=C.getLayerSourceCache(te);le&&!te.isHidden(this.transform.zoom)&&le.getVisibleCoordinates().length&&(!H||H.getSource().maxzoom<le.getSource().maxzoom)&&(H=le)})),H&&this.options.showTileBoundaries&&rI.debug(this,H,H.getVisibleCoordinates())}this.options.showPadding&&function(C){const H=C.transform.padding;rA(C,C.transform.height-(H.top||0),3,DA),rA(C,H.bottom||0,3,VA),nA(C,H.left||0,3,jA),nA(C,C.transform.width-(H.right||0),3,GA);const te=C.transform.centerPoint;!function(C,H,te,le){oA(C,H-1,te-10,2,20,le),oA(C,H-10,te-1,20,2,le)}(C,te.x,C.transform.height-te.y,ZA)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(te.performance.now()),this.saveCanvasCopy()),_e||(this.conflationActive=!1)}uploadLayer(C,H,te){this.gpuTimingStart(H),(!C.transform.projection.unsupportedLayers||!C.transform.projection.unsupportedLayers.includes(H.type)||C.terrain&&"custom"===H.type)&&nI[`${H.type}Upload`]&&nI[`${H.type}Upload`](C,te,H.scope),this.gpuTimingEnd()}renderLayer(C,H,te,le){te.isHidden(this.transform.zoom)||("background"===te.type||"sky"===te.type||"custom"===te.type||"model"===te.type||"raster"===te.type||le&&le.length)&&(this.id=te.id,this.gpuTimingStart(te),(!C.transform.projection.unsupportedLayers||!C.transform.projection.unsupportedLayers.includes(te.type)||C.terrain&&"custom"===te.type)&&rI[te.type](C,H,te,le,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(C){if(!this.options.gpuTiming)return;const H=this.context.extTimerQuery,te=this.context.gl;let le=this.gpuTimers[C.id];le||(le=this.gpuTimers[C.id]={calls:0,cpuTime:0,query:te.createQuery()}),le.calls++,te.beginQuery(H.TIME_ELAPSED_EXT,le.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const C=this.context.extTimerQuery,H=this.context.gl,te=H.createQuery();this.deferredRenderGpuTimeQueries.push(te),H.beginQuery(C.TIME_ELAPSED_EXT,te)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){const C=this.gpuTimers;return this.gpuTimers={},C}collectDeferredRenderGpuQueries(){const C=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],C}queryGpuTimers(C){const H={};for(const te in C){const le=C[te],ce=this.context.extTimerQuery,he=ce.getQueryParameter(le.query,this.context.gl.QUERY_RESULT)/1e6;ce.deleteQueryEXT(le.query),H[te]=he}return H}queryGpuTimeDeferredRender(C){if(!this.options.gpuTimingDeferredRender)return 0;const H=this.context.extTimerQuery,te=this.context.gl;let le=0;for(const ce of C)le+=H.getQueryParameter(ce,te.QUERY_RESULT)/1e6,H.deleteQueryEXT(ce);return le}translatePosMatrix(C,H,te,le,ce){if(!te[0]&&!te[1])return C;const he=ce?"map"===le?this.transform.angle:0:"viewport"===le?-this.transform.angle:0;if(he){const C=Math.sin(he),H=Math.cos(he);te=[te[0]*H-te[1]*C,te[0]*C+te[1]*H]}const ue=[ce?te[0]:Xx(H,te[0],this.transform.zoom),ce?te[1]:Xx(H,te[1],this.transform.zoom),0],de=new Float32Array(16);return ed.translate(de,C,ue),de}saveTileTexture(C){const H=this._tileTextures[C.size[0]];H?H.push(C):this._tileTextures[C.size[0]]=[C]}getTileTexture(C){const H=this._tileTextures[C];return H&&H.length>0?H.pop():null}isPatternMissing(C,H){return null===C||void 0!==C&&!this.imageManager.getPattern(C.toString(),H)}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture}terrainUseFloatDEM(){return null!=this.context.extTextureFloatLinear}currentGlobalDefines(C,H,te){const le=void 0===te?this.terrain&&this.terrain.renderingToTexture:te,ce=this.terrain&&0===this.terrain.exaggeration(),he=[];return this.style&&this.style.enable3dLights()&&("globeRaster"===C||"terrainRaster"===C?(he.push("LIGHTING_3D_MODE"),he.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):le||he.push("LIGHTING_3D_MODE")),"shadow"===this.renderPass?this._shadowMapDebug||he.push("DEPTH_TEXTURE"):this.shadowRenderer&&(this.shadowRenderer.useNormalOffset?he.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"):he.push("RENDER_SHADOWS","DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(he.push("TERRAIN"),this.terrainUseFloatDEM()&&he.push("TERRAIN_DEM_FLOAT_FORMAT"),ce&&he.push("ZERO_EXAGGERATION")),"globe"===this.transform.projection.name&&he.push("GLOBE"),!this._fogVisible||le||void 0!==H&&!H||he.push("FOG","FOG_DITHERING"),le&&he.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&he.push("OVERDRAW_INSPECTOR"),he}getOrCreateProgram(C,H){this.cache=this.cache||{};const te=H&&H.defines||[],le=H&&H.config,ce=this.currentGlobalDefines(C,H&&H.overrideFog,H&&H.overrideRtt).concat(te),he=aM.cacheKey(IS[C],C,ce,le);return this.cache[he]||(this.cache[he]=new aM(this.context,C,IS[C],le,uA[C],ce)),this.cache[he]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const C=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(C.FUNC_ADD)}initDebugOverlayCanvas(){null==this.debugOverlayCanvas&&(this.debugOverlayCanvas=te.document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new gy(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(C,H){if(this.style.enable3dLights()){const te=this.style.directionalLight,le=this.style.ambientLight;if(te&&le){const ce=((C,H)=>{const te=C.properties.get("direction"),le=C.properties.get("color").toArray01(),ce=C.properties.get("intensity"),he=H.properties.get("color").toArray01(),ue=H.properties.get("intensity"),de=[te.x,te.y,te.z],_e=se(he,ue),ye=se(le,ce);return{u_lighting_ambient_color:_e,u_lighting_directional_dir:de,u_lighting_directional_color:ye,u_ground_radiance:nM(de,ye,_e)}})(te,le);H.setLightsUniformValues(C,ce)}}}uploadCommonUniforms(C,H,te,le,ce){if(this.uploadCommonLightUniforms(C,H),this.terrain&&this.terrain.renderingToTexture)return;const he=this.style.fog;if(he){const ce=he.getOpacity(this.transform.pitch),ue=((C,H,te,le,ce,he,ue,de,_e,ye,ve,Me)=>{const Se=C.transform,Ae=H.properties.get("color").toArray01();Ae[3]=le;const Ce=C.frameCounter/1e3%1,[Oe,Ne]=H.properties.get("vertical-range");return{u_fog_matrix:te?Se.calculateFogTileMatrix(te):Me||C.identityMat,u_fog_range:H.getFovAdjustedRange(Se._fov),u_fog_color:Ae,u_fog_horizon_blend:H.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(Oe,Ne),Ne],u_fog_temporal_offset:Ce,u_frustum_tl:ce,u_frustum_tr:he,u_frustum_br:ue,u_frustum_bl:de,u_globe_pos:_e,u_globe_radius:ye,u_viewport:ve,u_globe_transition:Ed(Se.zoom),u_is_globe:+("globe"===Se.projection.name)}})(this,he,te,ce,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*yi.devicePixelRatio,this.transform.height*yi.devicePixelRatio],le);H.setFogUniformValues(C,ue)}ce&&H.setCutoffUniformValues(C,ce.uniformValues)}setTileLoadedFlag(C){this.tileLoaded=C}saveCanvasCopy(){const C=this.canvasCopy();C&&(this.frameCopies.push(C),this.tileLoaded=!1)}canvasCopy(){const C=this.context.gl,H=C.createTexture();return C.bindTexture(C.TEXTURE_2D,H),C.copyTexImage2D(C.TEXTURE_2D,0,C.RGBA,0,0,C.drawingBufferWidth,C.drawingBufferHeight,0),H}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const C=this.style&&this.style.fog;return!!C&&0!==C.getOpacity(this.transform.pitch)}getBackgroundTiles(){const C=this._backgroundTiles,H=this._backgroundTiles={},te=this.transform.coveringTiles({tileSize:512});for(const le of te)H[le.key]=C[le.key]||new Iy(le,512,this.transform.tileZoom,this);return H}clearBackgroundTiles(){this._backgroundTiles={}}layerUsedInConflation(C,H){return!(!C.is3D()||C.minzoom&&C.minzoom>this.transform.zoom||"building"!==C.sourceLayer&&(!H||"batched-model"!==H.type))}isTileAffectedByFog(C){if(!this.style||!this.style.fog)return!1;if("globe"===this.transform.projection.name)return!0;let H=this._cachedTileFogOpacities[C.key];return H||(this._cachedTileFogOpacities[C.key]=H=this.style.fog.getOpacityForTile(C)),H[0]>=AT||H[1]>=AT}}const sI=2048;class PA{constructor(C,H){this.aabb=C,this.lastCascade=H}}class RA{add(C,H){const te=this.receivers[C.key];void 0!==te?(te.aabb.min[0]=Math.min(te.aabb.min[0],H.min[0]),te.aabb.min[1]=Math.min(te.aabb.min[1],H.min[1]),te.aabb.min[2]=Math.min(te.aabb.min[2],H.min[2]),te.aabb.max[0]=Math.max(te.aabb.max[0],H.max[0]),te.aabb.max[1]=Math.max(te.aabb.max[1],H.max[1]),te.aabb.max[2]=Math.max(te.aabb.max[2],H.max[2])):this.receivers[C.key]=new PA(H,null)}clear(){this.receivers={}}get(C){return this.receivers[C.key]}computeRequiredCascades(C,H,te){const le=Hu.fromPoints(C.points);let ce=0;for(const C in this.receivers){const he=this.receivers[C];if(!he)continue;if(!le.intersectsAabb(he.aabb))continue;he.aabb.min=le.closestPoint(he.aabb.min),he.aabb.max=le.closestPoint(he.aabb.max);const ue=he.aabb.getCorners();for(let C=0;C<te.length;C++){let le=!0;for(const ce of ue){const he=[ce[0]*H,ce[1]*H,ce[2]];if(Ld.transformMat4(he,he,te[C].matrix),he[0]<-1||he[0]>1||he[1]<-1||he[1]>1){le=!1;break}}if(he.lastCascade=C,ce=Math.max(ce,C),le)break}}return ce+1}}class LA{constructor(C){this.painter=C,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new RA,this._depthMode=new gx(C.context.gl.LEQUAL,gx.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this.useNormalOffset=!1}destroy(){for(const C of this._cascades)C.texture.destroy(),C.framebuffer.destroy();this._cascades=[]}updateShadowParameters(C,H){const te=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!H||!H.properties)return;const le=H.properties.get("shadow-intensity");if(!H.shadowsEnabled()||le<=0)return;if(this._shadowLayerCount=te.style.order.reduce(((H,le)=>{const ce=te.style._mergedLayers[le];return H+(ce.hasShadowPass()&&!ce.isHidden(C.zoom)?1:0)}),0),this._enabled=this._shadowLayerCount>0,!this._enabled)return;const ce=te.context,he=sI,ue=sI;if(0===this._cascades.length)for(let C=0;C<2;++C){const C=te._shadowMapDebug,H=ce.gl,le=ce.createFramebuffer(he,ue,C,"texture"),de=new gy(ce,{width:he,height:ue,data:null},H.DEPTH_COMPONENT);if(le.depthAttachment.set(de.texture),C){const C=new gy(ce,{width:he,height:ue,data:null},H.RGBA);le.colorAttachment.set(C.texture)}this._cascades.push({framebuffer:le,texture:de,matrix:[],far:0,boundingSphereRadius:0,frustum:new $u,scale:0})}this.shadowDirection=OA(H);let de=0;if(C.elevation){const H=C.elevation,te=[1e4,-1e4];H.visibleDemTiles.filter((C=>C.dem)).forEach((C=>{const H=C.dem.tree;te[0]=Math.min(te[0],H.minimums[0]),te[1]=Math.max(te[1],H.maximums[0])})),1e4!==te[0]&&(de=(te[1]-te[0])*H.exaggeration())}const _e=1.5*C.cameraToCenterDistance,ye=3*_e,ve=new Float64Array(16);for(let H=0;H<2;++H){const te=this._cascades[H];let le=C.height/50,ce=1;0===H?ce=_e:(le=_e,ce=ye);const[he,ue]=FA(C,this.shadowDirection,le,ce,sI,de);te.scale=C.scale,te.matrix=he,te.boundingSphereRadius=ue,ed.invert(ve,te.matrix),te.frustum=$u.fromInvProjectionMatrix(ve,1,0,!0),te.far=ce}this._uniformValues.u_fade_range=[.75*this._cascades[1].far,this._cascades[1].far],this._uniformValues.u_shadow_intensity=le,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=.00048828125,this._uniformValues.u_shadow_map_resolution=sI,this._uniformValues.u_shadowmap_0=sA.ShadowMap0,this._uniformValues.u_shadowmap_1=sA.ShadowMap0+1,this._groundShadowTiles=te.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});const Me=te.transform.elevation;for(const C of this._groundShadowTiles){let H={min:0,max:0};if(Me){const te=Me.getMinMaxForTile(C);te&&(H=te)}this.addShadowReceiver(C.toUnwrapped(),H.min,H.max)}}get enabled(){return this._enabled}set enabled(C){this._enabled=C}drawShadowPass(C,H){if(!this._enabled)return;const te=this.painter,le=te.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(te.transform.getFrustum(0),te.transform.worldSize,this._cascades),le.viewport.set([0,0,sI,sI]);for(let ce=0;ce<this._numCascadesToRender;++ce){te.currentShadowCascade=ce,le.bindFramebuffer.set(this._cascades[ce].framebuffer.framebuffer),le.clear({color:kr.white,depth:1});for(const le of C.order){const ce=C._mergedLayers[le];if(!ce.hasShadowPass()||ce.isHidden(te.transform.zoom))continue;const he=C.getLayerSourceCache(ce),ue=he?H[he.id]:void 0;("model"===ce.type||ue&&ue.length)&&te.renderLayer(te,he,ce,ue)}}te.currentShadowCascade=0}drawGroundShadows(){if(!this._enabled)return;const C=this.painter,H=C.style,te=C.context,le=H.directionalLight,ce=H.ambientLight;if(!le||!ce)return;const he=[],ue=$E(C,C.longestCutoffRange);ue.shouldRenderCutoff&&he.push("RENDER_CUTOFF");const de=BA(le,ce),_e=new gx(te.gl.LEQUAL,gx.ReadOnly,C.depthRangeFor3D);for(const H of this._groundShadowTiles){const le=H.toUnwrapped(),ce=C.isTileAffectedByFog(H),ye=C.getOrCreateProgram("groundShadow",{defines:he,overrideFog:ce});this.setupShadows(le,ye),C.uploadCommonUniforms(te,ye,le,null,ue);const ve={u_matrix:C.transform.calculateProjMatrix(le),u_ground_shadow_factor:de};ye.draw(C,te.gl.TRIANGLES,_e,xx.disabled,bx.multiply,Ex.disabled,ve,"ground_shadow",C.tileExtentBuffer,C.quadTriangleIndexBuffer,C.tileExtentSegments,{},C.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?bx.unblended:bx.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(C){const H=this.painter.transform,te=H.calculatePosMatrix(C,H.worldSize);return ed.multiply(te,this._cascades[this.painter.currentShadowCascade].matrix,te),Float32Array.from(te)}calculateShadowPassMatrixFromMatrix(C){return ed.multiply(C,this._cascades[this.painter.currentShadowCascade].matrix,C),Float32Array.from(C)}setupShadows(C,H,te,le=0){if(!this._enabled)return;const ce=this.painter.transform,he=this.painter.context,ue=he.gl,de=this._uniformValues,_e=new Float64Array(16),ye=ce.calculatePosMatrix(C,ce.worldSize);for(let C=0;C<2;C++)ed.multiply(_e,this._cascades[C].matrix,ye),de[0===C?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(_e),he.activeTexture.set(ue.TEXTURE0+sA.ShadowMap0+C),this._cascades[C].texture.bind(ue.NEAREST,ue.CLAMP_TO_EDGE);if(this.useNormalOffset=!!te,this.useNormalOffset){const H=Qd(C.canonical),he=2/ce.tileSize*wn/sI,ue=he*this._cascades[0].boundingSphereRadius,_e=he*this._cascades[1].boundingSphereRadius,ye=("vector-tile"===te?1:3)/Math.pow(2,le-C.canonical.z-(1-ce.zoom+Math.floor(ce.zoom)));de.u_shadow_normal_offset=[H,ue*ye,_e*ye],de.u_shadow_bias=[6e-5,.0012,.012]}else de.u_shadow_bias=[36e-5,.0012,.012];H.setShadowUniformValues(he,de)}setupShadowsFromMatrix(C,H,te=!1){if(!this._enabled)return;const le=this.painter.context,ce=le.gl,he=this._uniformValues,ue=new Float64Array(16);for(let H=0;H<2;H++)ed.multiply(ue,this._cascades[H].matrix,C),he[0===H?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(ue),le.activeTexture.set(ce.TEXTURE0+sA.ShadowMap0+H),this._cascades[H].texture.bind(ce.NEAREST,ce.CLAMP_TO_EDGE);if(this.useNormalOffset=te,te){const C=5;he.u_shadow_normal_offset=[1,C,C],he.u_shadow_bias=[6e-5,.0012,.012]}else he.u_shadow_bias=[36e-5,.0012,.012];H.setShadowUniformValues(le,he)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(C,H,te,le){if(le[2]>=0)return{};const ce=function(C,H,te){const le=te/(1<<C.canonical.z);return new Hu([C.canonical.x*le+C.wrap*te,C.canonical.y*le+C.wrap*te,0],[(C.canonical.x+1)*le+C.wrap*te,(C.canonical.y+1)*le+C.wrap*te,H])}(C,H,te).getCorners(),he=H/-le[2];le[0]<0?(Ld.add(ce[0],ce[0],[le[0]*he,0,0]),Ld.add(ce[3],ce[3],[le[0]*he,0,0])):le[0]>0&&(Ld.add(ce[1],ce[1],[le[0]*he,0,0]),Ld.add(ce[2],ce[2],[le[0]*he,0,0])),le[1]<0?(Ld.add(ce[0],ce[0],[0,le[1]*he,0]),Ld.add(ce[1],ce[1],[0,le[1]*he,0])):le[1]>0&&(Ld.add(ce[2],ce[2],[0,le[1]*he,0]),Ld.add(ce[3],ce[3],[0,le[1]*he,0]));const ue={};return ue.vertices=ce,ue.planes=[kA(ce[1],ce[0],ce[4]),kA(ce[2],ce[1],ce[5]),kA(ce[3],ce[2],ce[6]),kA(ce[0],ce[3],ce[7])],ue}addShadowReceiver(C,H,te){this._receivers.add(C,Hu.fromTileIdAndHeight(C,H,te))}getMaxCascadeForTile(C){const H=this._receivers.get(C);return H&&H.lastCascade?H.lastCascade:0}}function kA(C,H,te){const le=Ld.sub([],te,H),ce=Ld.sub([],C,H),he=Ld.cross([],le,ce),ue=Ld.length(he);return 0===ue?[0,0,1,0]:(Ld.scale(he,he,1/ue),[he[0],he[1],he[2],-Ld.dot(he,H)])}function OA(C){const H=C.properties.get("direction"),te=J(H.x,H.y,H.z);te[2]=z(te[2],0,75);const le=K([te[0],te[1],te[2]]);return Ld.fromValues(le.x,le.y,le.z)}function BA(C,H){const te=C.properties.get("color"),le=C.properties.get("intensity"),ce=C.properties.get("direction"),he=[ce.x,ce.y,ce.z],ue=H.properties.get("color"),de=H.properties.get("intensity"),_e=Math.max(Ld.dot([0,0,1],he),0),ye=[0,0,0];Ld.scale(ye,ue.toArray01Linear().slice(0,3),de);const ve=[0,0,0];return Ld.scale(ve,te.toArray01Linear().slice(0,3),_e*le),ae([ye[0]>0?ye[0]/(ye[0]+ve[0]):0,ye[1]>0?ye[1]/(ye[1]+ve[1]):0,ye[2]>0?ye[2]/(ye[2]+ve[2]):0])}function FA(C,H,te,le,ce,he){const ue=C.zoom,de=C.scale,_e=C.worldSize,ye=1/_e,ve=C.aspect,Me=Math.sqrt(1+ve*ve)*Math.tan(.5*C.fovX),Se=Me*Me,Ae=le-te,Ce=le+te;let Oe,Ne;Se>Ae/Ce?(Oe=le,Ne=le*Me):(Oe=.5*Ce*(1+Se),Ne=.5*Math.sqrt(Ae*Ae+2*(le*le+te*te)*Se+Ce*Ce*Se*Se));const je=C.projection.pixelsPerMeter(C.center.lat,_e),Ge=C._camera.getCameraToWorldMercator(),Ze=[0,0,-Oe*ye];Ld.transformMat4(Ze,Ze,Ge);let qe=Ne*ye;const $e=C._edgeInsets;if(!(0===$e.left&&0===$e.top&&0===$e.right&&0===$e.bottom||$e.left===$e.right&&$e.top===$e.bottom)){const H=C._camera.getWorldToCamera(C.worldSize,"meters"===C.projection.zAxisUnit?je:1),ce=C._camera.getCameraToClipPerspective(C._fov,C.width/C.height,te,le);ce[8]=2*-C.centerOffset.x/C.width,ce[9]=2*C.centerOffset.y/C.height;const he=new Float64Array(16);ed.mul(he,ce,H);const ye=new Float64Array(16);ed.invert(ye,he);const ve=$u.fromInvProjectionMatrix(ye,_e,ue,!0);for(const H of ve.points){const te=((We=H)[0]/=de,We[1]/=de,We[2]=Zd(We[2],C._center.lat),We);qe=Math.max(qe,Ld.len(Ld.subtract([],Ze,te)))}}var We;qe*=ce/(ce-1);const He=Math.acos(H[2]),Xe=Math.atan2(-H[0],-H[1]),Ye=new jx;Ye.position=Ze,Ye.setPitchBearing(He,Xe);const Je=Ye.getWorldToCamera(_e,je),Qe=qe*_e,tt=Math.min(C._mercatorZfromZoom(17)*_e*-2,-2*Qe),rt=Ye.getCameraToClipOrthographic(-Qe,Qe,-Qe,Qe,tt,(Qe+he*je)/H[2]),ot=new Float64Array(16);ed.multiply(ot,rt,Je);const st=Ld.fromValues(Math.floor(1e6*Ze[0])/1e6*_e,Math.floor(1e6*Ze[1])/1e6*_e,0),at=.5*ce,lt=[0,0,0];Ld.transformMat4(lt,st,ot),Ld.scale(lt,lt,at);const ct=[Math.floor(lt[0]),Math.floor(lt[1]),Math.floor(lt[2])],ht=[0,0,0];Ld.sub(ht,lt,ct),Ld.scale(ht,ht,-1/at);const pt=new Float64Array(16);return ed.identity(pt),ed.translate(pt,pt,ht),ed.multiply(ot,pt,ot),[ot,Qe]}class NA extends It{constructor(C){super(),this.requestManager=C,this.models={"":{}},this.numModelsLoading={}}loadModel(C,H){return aT(this.requestManager.transformRequest(H,ot.Model).url).then((H=>{if(!H)return;const te=_T(H),le=new bv(C,void 0,void 0,te);return le.computeBoundsAndApplyParent(),le})).catch((te=>{this.fire(new St(new Error(`Could not load model ${C} from ${H}: ${te.message}`)))}))}load(C,H){this.models[H]||(this.models[H]={});const te=Object.keys(C);this.numModelsLoading[H]=(this.numModelsLoading[H]||0)+te.length;const le=[];for(const H of te)le.push(this.loadModel(H,C[H]));Promise.allSettled(le).then((C=>{for(let le=0;le<C.length;le++){const{status:ce,value:he}=C[le];"fulfilled"===ce&&he&&(this.models[H][te[le]]=he)}this.numModelsLoading[H]-=te.length,this.fire(new At("data",{dataType:"style"}))})).catch((C=>{this.fire(new St(new Error(`Could not load models: ${C.message}`)))}))}isLoaded(){for(const C in this.numModelsLoading)if(this.numModelsLoading[C]>0)return!1;return!0}hasModel(C,H){return!!this.getModel(C,H)}getModel(C,H){return this.models[H]||(this.models[H]={}),this.models[H][C]}addModel(C,H,te){this.models[te]||(this.models[te]={}),this.hasModel(C,te)&&this.removeModel(C,te),this.load({[C]:this.requestManager.normalizeModelURL(H)},te)}addModels(C,H){const te={};for(const H in C)te[H]=this.requestManager.normalizeModelURL(C[H]);this.load(te,H)}removeModel(C,H){this.models[H]||(this.models[H]={});const te=this.models[H][C];delete this.models[H][C],te.destroy()}listModels(C){return this.models[C]||(this.models[C]={}),Object.keys(this.models[C])}upload(C,H){this.models[H]||(this.models[H]={});for(const te in this.models[H])this.models[H][te].upload(C.context)}}const UA=(C,H)=>ws(C,H&&H.filter((C=>"source.canvas"!==C.identifier))),aI=O(PE,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setProjection","setCamera","addImport","removeImport","setImportUrl","setImportData","setImportConfig"]),lI=O(PE,["setCenter","setZoom","setBearing","setPitch"]),cI={version:8,layers:[],sources:{}},hI={duration:300,delay:0},uI=new Set(["fill","line","background","hillshade","raster"]);class $A extends It{constructor(C,H={}){super(),this.map=C,this.scope=H.scope||"",this.fragments=[],this.importDepth=H.importDepth||0,this.importsCache=H.importsCache||new Map,this.resolvedImports=H.resolvedImports||new Set,this.transition=k({},hI),this._buildingIndex=new MT(this),this.crossTileSymbolIndex=new wE,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._changes=H.styleChanges||new ga,this.dispatcher=H.dispatcher?H.dispatcher:new _w(Uw(),this),H.imageManager?this.imageManager=H.imageManager:(this.imageManager=new Qb,this.imageManager.setEventedParent(this)),this.imageManager.createScope(this.scope),this.glyphManager=H.glyphManager?H.glyphManager:new K_(C._requestManager,H.localFontFamily?2:H.localIdeographFontFamily?1:0,H.localFontFamily||H.localIdeographFontFamily),H.modelManager?this.modelManager=H.modelManager:(this.modelManager=new NA(C._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._serializedLayers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._order=[],this._markersNeedUpdate=!1,this.options=new Map,this._configDependentLayers=new Set,this.dispatcher.broadcast("setReferrer",st());const te=this;this._rtlTextPluginCallback=$A.registerForPluginStateChange((C=>{te.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:C.pluginStatus,pluginURL:C.pluginURL},((C,H)=>{if(Ws(C),H&&H.every((C=>C)))for(const C in te._sourceCaches){const H=te._sourceCaches[C],le=H.getSource().type;"vector"!==le&&"geojson"!==le||H.reload()}}))})),this.on("data",(C=>{if("source"!==C.dataType||"metadata"!==C.sourceDataType)return;const H=this.getOwnSource(C.sourceId);if(H&&H.vectorLayerIds)for(const C in this._layers){const te=this._layers[C];te.source===H.id&&this._validateLayer(te)}}))}loadURL(C,H={}){this.fire(new At("dataloading",{dataType:"style"}));const te="boolean"==typeof H.validate?H.validate:!De(C);C=this.map._requestManager.normalizeStyleURL(C,H.accessToken),this.resolvedImports.add(C);const le=this.importsCache.get(C);if(le)return this._load(le,te);const ce=this.map._requestManager.transformRequest(C,ot.Style);this._request=we(ce,((H,le)=>{if(this._request=null,H)this.fire(new St(H));else if(le)return this.importsCache.set(C,le),this._load(le,te)}))}loadJSON(C,H={}){this.fire(new At("dataloading",{dataType:"style"})),this._request=yi.frame((()=>{this._request=null,this._load(C,!1!==H.validate)}))}loadEmpty(){this.fire(new At("dataloading",{dataType:"style"})),this._load(cI,!1)}_loadImports(C,H){if(this.importDepth>=4)return W("Style doesn't support nesting deeper than 5"),this._reloadImports();const te=[];for(const le of C){const C=this._createFragmentStyle(le),ce=new Promise((H=>C.on("style.import.load",H)));if(te.push(ce),this.resolvedImports.has(le.url)){C.loadEmpty();continue}const he=le.data||this.importsCache.get(le.url);he?C.loadJSON(he,{validate:H}):le.url?C.loadURL(le.url,{validate:H}):C.loadEmpty(),this.fragments.push({style:C,id:le.id,config:le.config})}Promise.all(te).then((()=>this._reloadImports()))}_createFragmentStyle(C){const H=this.scope?pa(C.id,this.scope):C.id,te=new $A(this.map,{scope:H,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager});return te.setEventedParent(this.map,{style:te}),te.setConfig(C.config),te}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options});const C=this.isRootStyle();this._shouldPrecompile=C,this.fire(new At("data",{dataType:"style"})),this.fire(new At(C?"style.load":"style.import.load"))}_load(C,H){const te=C.schema;if(this.isRootStyle()&&(C.fragment||te&&!1!==C.fragment)){const te=k({},cI,{imports:[{id:"basemap",data:C,url:""}]});return void this._load(te,H)}if(this.updateSchema(te),H&&UA(this,hs(C)))return;this._loaded=!0,this.stylesheet=$(C);for(const H in C.sources)this.addSource(H,C.sources[H],{validate:!1});this._changes.changed=!1,C.sprite?this._loadSprite(C.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),this.glyphManager.setURL(C.glyphs,this.scope);const le=IT(this.stylesheet.layers);if(this._order=le.map((C=>C.id)),this.stylesheet.light&&W("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(1===this.stylesheet.lights.length&&"flat"===this.stylesheet.lights[0].type){const C=this.stylesheet.lights[0];this.light=new tw(C.properties,C.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new tw(this.stylesheet.light)),this._layers={},this._serializedLayers={};for(const C of le){const H=Kb(C,this.options);H.setScope(this.scope),H.isConfigDependent&&this._configDependentLayers.add(H.fqid),H.setEventedParent(this,{layer:{id:H.id}}),this._layers[H.id]=H,this._layers[H.id]=H,this._serializedLayers[H.id]=H.serialize();const te=this.getOwnLayerSourceCache(H),le=!!this.directionalLight&&this.directionalLight.shadowsEnabled();te&&H.canCastShadows()&&le&&(te.castsShadows=!0)}this.stylesheet.models&&this.modelManager.addModels(this.stylesheet.models,this.scope);const ce=this.stylesheet.terrain;if(ce&&!this.terrainSetForDrapingOnly()&&this._createTerrain(ce,1),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.mergeAll(),this._updateMapProjection(),this.map._triggerCameraUpdate(this.camera),this.fire(new At("data",{dataType:"style"})),C.imports)this._loadImports(C.imports,H);else{this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options});const C=this.isRootStyle();this._shouldPrecompile=C,this.fire(new At(C?"style.load":"style.import.load"))}}isRootStyle(){return 0===this.importDepth}mergeAll(){let C,H,te,le,ce,he,ue,de;this.forEachFragmentStyle((_e=>{if(_e.stylesheet){if(null!=_e.light&&(C=_e.light),_e.stylesheet.lights)for(const C of _e.stylesheet.lights)"ambient"===C.type&&null!=_e.ambientLight&&(H=_e.ambientLight),"directional"===C.type&&null!=_e.directionalLight&&(te=_e.directionalLight);(_e.stylesheet.terrain||_e.stylesheet.projection&&"globe"===_e.stylesheet.projection.name)&&null!=_e.terrain&&(!le||le&&0===le.drapeRenderMode||1===_e.terrain.drapeRenderMode)&&(le=_e.terrain),_e.stylesheet.fog&&null!=_e.fog&&(ce=_e.fog),null!=_e.stylesheet.camera&&(de=_e.stylesheet.camera),null!=_e.stylesheet.projection&&(he=_e.stylesheet.projection),null!=_e.stylesheet.transition&&(ue=_e.stylesheet.transition)}})),this.light=C,this.ambientLight=H,this.directionalLight=te,this.terrain=le,this.fog=ce,this.camera=de||{"camera-projection":"perspective"},this.projection=he||{name:"mercator"},this.transition=k({},hI,ue),this.mergeSources(),this.mergeLayers()}forEachFragmentStyle(C){const t=H=>{for(const C of H.fragments)t(C.style);C(H)};t(this)}mergeTerrain(){let C;this.forEachFragmentStyle((H=>{null!=H.terrain&&(!C||C&&0===C.drapeRenderMode||1===H.terrain.drapeRenderMode)&&(C=H.terrain)})),this.terrain=C}mergeProjection(){let C;this.forEachFragmentStyle((H=>{null!=H.stylesheet.projection&&(C=H.stylesheet.projection)})),this.projection=C||{name:"mercator"}}mergeSources(){const C={},H={},te={};this.forEachFragmentStyle((le=>{for(const H in le._sourceCaches){const te=pa(H,le.scope);C[te]=le._sourceCaches[H]}for(const C in le._otherSourceCaches){const te=pa(C,le.scope);H[te]=le._otherSourceCaches[C]}for(const C in le._symbolSourceCaches){const H=pa(C,le.scope);te[H]=le._symbolSourceCaches[C]}})),this._mergedSourceCaches=C,this._mergedOtherSourceCaches=H,this._mergedSymbolSourceCaches=te}mergeLayers(){const C={},H=[],te={};this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle((te=>{for(const le of te._order){const ce=te._layers[le];if("slot"===ce.type){const H=fa(le);if(C[H])continue;C[H]=[]}ce.slot&&C[ce.slot]?C[ce.slot].push(ce):H.push(ce)}})),this._mergedOrder=[];const r=(H=[])=>{for(const le of H)if("slot"===le.type){const H=fa(le.id);C[H]&&r(C[H])}else{const C=pa(le.id,le.scope);this._mergedOrder.push(C),te[C]=le,le.is3D()&&(this._has3DLayers=!0),"circle"===le.type&&(this._hasCircleLayers=!0),"symbol"===le.type&&(this._hasSymbolLayers=!0)}};r(H),this._mergedLayers=te,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&0===this.terrain.drapeRenderMode}getCamera(){return this.stylesheet.camera}setCamera(C){return this.stylesheet.camera=k({},this.stylesheet.camera,C),this.camera=this.stylesheet.camera,this}setProjection(C){C?this.stylesheet.projection=C:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?this.getTerrain()||this.stylesheet.terrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(C){this._spriteRequest=function(C,H,te){let le,ce,he;const ue=yi.devicePixelRatio>1?"@2x":"";let de=we(H.transformRequest(H.normalizeSpriteURL(C,ue,".json"),ot.SpriteJSON),((C,H)=>{de=null,he||(he=C,le=H,c())})),_e=Ie(H.transformRequest(H.normalizeSpriteURL(C,ue,".png"),ot.SpriteImage),((C,H)=>{_e=null,he||(he=C,ce=H,c())}));function c(){if(he)te(he);else if(le&&ce){const C=yi.getImageData(ce),H={};for(const te in le){const{width:ce,height:he,x:ue,y:de,sdf:_e,pixelRatio:ye,stretchX:ve,stretchY:Me,content:Se}=le[te],Ae=new $p({width:ce,height:he});$p.copy(C,Ae,{x:ue,y:de},{x:0,y:0},{width:ce,height:he}),H[te]={data:Ae,pixelRatio:ye,sdf:_e,stretchX:ve,stretchY:Me,content:Se}}te(null,H)}}return{cancel(){de&&(de.cancel(),de=null),_e&&(_e.cancel(),_e=null)}}}(C,this.map._requestManager,((C,H)=>{if(this._spriteRequest=null,C)this.fire(new St(C));else if(H)for(const C in H)this.imageManager.addImage(C,this.scope,H[C]);this.imageManager.setLoaded(!0,this.scope),this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new At("data",{dataType:"style"}))}))}_validateLayer(C){const H=this.getOwnSource(C.source);if(!H)return;const te=C.sourceLayer;te&&("geojson"===H.type||H.vectorLayerIds&&-1===H.vectorLayerIds.indexOf(te))&&this.fire(new St(new Error(`Source layer "${te}" does not exist on source "${H.id}" as specified by style layer "${C.id}"`)))}loaded(){if(!this._loaded)return!1;if(Object.keys(this._changes.updatedSourceCaches).length)return!1;for(const C in this._sourceCaches)if(!this._sourceCaches[C].loaded())return!1;if(!this.imageManager.isLoaded())return!1;if(!this.modelManager.isLoaded())return!1;for(const{style:C}of this.fragments)if(!C.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map(((C,H)=>{const te=this.fragments[H];return te&&te.style&&(C.data=te.style.serialize()),C}))}_serializeSources(){const C={};for(const H in this._sourceCaches){const te=this._sourceCaches[H].getSource();C[te.id]||(C[te.id]=te.serialize())}return C}_serializeLayers(C){const H=[];for(const te of C){const C=this._layers[te];C&&"custom"!==C.type&&H.push(C.serialize())}return H}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasTransitions(){if(this.hasLightTransitions())return!0;if(this.hasFogTransition())return!0;for(const C in this._sourceCaches)if(this._sourceCaches[C].hasTransition())return!0;for(const C in this._layers)if(this._layers[C].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}isLayerDraped(C){return!!this.terrain&&("function"==typeof C.isLayerDraped?C.isLayerDraped(this.getLayerSourceCache(C)):uI.has(C.type))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(C){const H=this.getOwnLayer(C);if(H)return H;this.fire(new St(new Error(`The layer '${C}' does not exist in the map's style.`)))}_checkSource(C){const H=this.getOwnSource(C);if(H)return H;this.fire(new St(new Error(`The source '${C}' does not exist in the map's style.`)))}update(C){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(C),this.directionalLight&&this.directionalLight.recalculate(C);const H=this.calculateLightsBrightness();C.brightness=H||0,H!==this._brightness&&(this._brightness=H,this.dispatcher.broadcast("setBrightness",H));const te=this._changes.changed;if(this._changes.changed){const H=this._changes.getLayerUpdatesByScope();for(const C in H){const{updatedIds:te,removedIds:le}=H[C];(te||le)&&this._updateWorkerLayers(C,te,le)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(C),this.light&&this.light.updateTransitions(C),this.ambientLight&&this.ambientLight.updateTransitions(C),this.directionalLight&&this.directionalLight.updateTransitions(C),this.fog&&this.fog.updateTransitions(C),this._changes.reset()}const le={};for(const C in this._mergedSourceCaches){const H=this._mergedSourceCaches[C];le[C]=H.used,H.used=!1}for(const H of this._mergedOrder){const te=this._mergedLayers[H];if(te.recalculate(C,this._availableImages),!te.isHidden(C.zoom)){const C=this.getOwnLayerSourceCache(te);C&&(C.used=!0)}if(!this._precompileDone&&this._shouldPrecompile)for(let H=te.minzoom||0;H<(te.maxzoom||25.5);H++){const H=this.map.painter;if(H){const le=te.getProgramIds();if(!le)continue;for(const ce of le){const le=te.getDefaultProgramParams(ce,C.zoom);le&&(H.style=this,this.fog&&(H._fogVisible=!0,le.overrideFog=!0,H.getOrCreateProgram(ce,le)),H._fogVisible=!1,le.overrideFog=!1,H.getOrCreateProgram(ce,le),(this.stylesheet.terrain||this.stylesheet.projection&&"globe"===this.stylesheet.projection.name)&&(le.overrideRtt=!0,H.getOrCreateProgram(ce,le)))}}}}this._shouldPrecompile&&(this._precompileDone=!0);for(const C in le){const H=this._mergedSourceCaches[C];le[C]!==H.used&&H.getSource().fire(new At("data",{sourceDataType:"visibility",dataType:"source",sourceId:H.getSource().id}))}this.light&&this.light.recalculate(C),this.terrain&&this.terrain.recalculate(C),this.fog&&this.fog.recalculate(C),this.z=C.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),te&&this.fire(new At("data",{dataType:"style"}));for(const{style:H}of this.fragments)H.update(C)}_updateTilesForChangedImages(){const C=Array.from(this._changes.changedImages.keys());if(C.length){for(const H in this._sourceCaches)this._sourceCaches[H].reloadTilesForDependencies(["icons","patterns"],C);this._changes.changedImages.clear()}}_updateWorkerLayers(C,H,te){const le=this.getFragmentStyle(C);this.dispatcher.broadcast("updateLayers",{layers:H?le._serializeLayers(H):[],scope:C,removedIds:te||[],options:le.options})}setState(C){if(this._checkLoaded(),UA(this,hs(C)))return!1;(C=$(C)).layers=IT(C.layers);const H=function(C,H){if(!C)return[{command:PE.setStyle,args:[H]}];let te=[];try{if(!x(C.version,H.version))return[{command:PE.setStyle,args:[H]}];x(C.center,H.center)||te.push({command:PE.setCenter,args:[H.center]}),x(C.zoom,H.zoom)||te.push({command:PE.setZoom,args:[H.zoom]}),x(C.bearing,H.bearing)||te.push({command:PE.setBearing,args:[H.bearing]}),x(C.pitch,H.pitch)||te.push({command:PE.setPitch,args:[H.pitch]}),x(C.sprite,H.sprite)||te.push({command:PE.setSprite,args:[H.sprite]}),x(C.glyphs,H.glyphs)||te.push({command:PE.setGlyphs,args:[H.glyphs]}),x(C.transition,H.transition)||te.push({command:PE.setTransition,args:[H.transition]}),x(C.light,H.light)||te.push({command:PE.setLight,args:[H.light]}),x(C.fog,H.fog)||te.push({command:PE.setFog,args:[H.fog]}),x(C.projection,H.projection)||te.push({command:PE.setProjection,args:[H.projection]}),x(C.lights,H.lights)||te.push({command:PE.setLights,args:[H.lights]}),x(C.camera,H.camera)||te.push({command:PE.setCamera,args:[H.camera]});const le={},ce=[];!function(C,H,te,le){let ce;for(ce in H=H||{},C=C||{})C.hasOwnProperty(ce)&&(H.hasOwnProperty(ce)||DT(ce,te,le));for(ce in H){if(!H.hasOwnProperty(ce))continue;const he=H[ce];C.hasOwnProperty(ce)?x(C[ce],he)||("geojson"===C[ce].type&&"geojson"===he.type&&RT(C,H,ce)?te.push({command:PE.setGeoJSONSourceData,args:[ce,he.data]}):PT(ce,H,te,le)):zT(ce,H,te)}}(C.sources,H.sources,ce,le);const he=[];C.layers&&C.layers.forEach((C=>{C.source&&le[C.source]?te.push({command:PE.removeLayer,args:[C.id]}):he.push(C)}));let ue=C.terrain;ue&&le[ue.source]&&(te.push({command:PE.setTerrain,args:[void 0]}),ue=void 0),te=te.concat(ce),x(ue,H.terrain)||te.push({command:PE.setTerrain,args:[H.terrain]}),function(C,H,te){H=H||[];const le=(C=C||[]).map(kT),ce=H.map(kT),he=C.reduce(OT,{}),ue=H.reduce(OT,{}),de=le.slice(),_e=Object.create(null);let ye,ve,Me,Se,Ae,Ce,Oe;for(ye=0,ve=0;ye<le.length;ye++)Me=le[ye],ue.hasOwnProperty(Me)?ve++:(te.push({command:PE.removeLayer,args:[Me]}),de.splice(de.indexOf(Me,ve),1));for(ye=0,ve=0;ye<ce.length;ye++)Me=ce[ce.length-1-ye],de[de.length-1-ye]!==Me&&(he.hasOwnProperty(Me)?(te.push({command:PE.removeLayer,args:[Me]}),de.splice(de.lastIndexOf(Me,de.length-ve),1)):ve++,Ce=de[de.length-ye],te.push({command:PE.addLayer,args:[ue[Me],Ce]}),de.splice(de.length-ye,0,Me),_e[Me]=!0);for(ye=0;ye<ce.length;ye++)if(Me=ce[ye],Se=he[Me],Ae=ue[Me],!_e[Me]&&!x(Se,Ae))if(x(Se.source,Ae.source)&&x(Se["source-layer"],Ae["source-layer"])&&x(Se.type,Ae.type)){for(Oe in LT(Se.layout,Ae.layout,te,Me,null,PE.setLayoutProperty),LT(Se.paint,Ae.paint,te,Me,null,PE.setPaintProperty),x(Se.slot,Ae.slot)||te.push({command:PE.setSlot,args:[Me,Ae.slot]}),x(Se.filter,Ae.filter)||te.push({command:PE.setFilter,args:[Me,Ae.filter]}),x(Se.minzoom,Ae.minzoom)&&x(Se.maxzoom,Ae.maxzoom)||te.push({command:PE.setLayerZoomRange,args:[Me,Ae.minzoom,Ae.maxzoom]}),Se)Se.hasOwnProperty(Oe)&&"layout"!==Oe&&"paint"!==Oe&&"filter"!==Oe&&"metadata"!==Oe&&"minzoom"!==Oe&&"maxzoom"!==Oe&&"slot"!==Oe&&(0===Oe.indexOf("paint.")?LT(Se[Oe],Ae[Oe],te,Me,Oe.slice(6),PE.setPaintProperty):x(Se[Oe],Ae[Oe])||te.push({command:PE.setLayerProperty,args:[Me,Oe,Ae[Oe]]}));for(Oe in Ae)Ae.hasOwnProperty(Oe)&&!Se.hasOwnProperty(Oe)&&"layout"!==Oe&&"paint"!==Oe&&"filter"!==Oe&&"metadata"!==Oe&&"minzoom"!==Oe&&"maxzoom"!==Oe&&"slot"!==Oe&&(0===Oe.indexOf("paint.")?LT(Se[Oe],Ae[Oe],te,Me,Oe.slice(6),PE.setPaintProperty):x(Se[Oe],Ae[Oe])||te.push({command:PE.setLayerProperty,args:[Me,Oe,Ae[Oe]]}))}else te.push({command:PE.removeLayer,args:[Me]}),Ce=de[de.lastIndexOf(Me)+1],te.push({command:PE.addLayer,args:[Ae,Ce]})}(he,H.layers,te),function(C=[],H=[],te){H=H||[];const le=(C=C||[]).map(kT),ce=H.map(kT),he=C.reduce(OT,{}),ue=H.reduce(OT,{}),de=le.slice();let _e,ye,ve,Me;for(_e=0,ye=0;_e<le.length;_e++)ve=le[_e],ue.hasOwnProperty(ve)?ye++:(te.push({command:PE.removeImport,args:[ve]}),de.splice(de.indexOf(ve,ye),1));for(_e=0,ye=0;_e<ce.length;_e++)ve=ce[ce.length-1-_e],de[de.length-1-_e]!==ve&&(he.hasOwnProperty(ve)?(te.push({command:PE.removeImport,args:[ve]}),de.splice(de.lastIndexOf(ve,de.length-ye),1)):ye++,Me=de[de.length-_e],te.push({command:PE.addImport,args:[ue[ve],Me]}),de.splice(de.length-_e,0,ve));for(const C of H){const H=he[C.id];if(!H||x(H,C))continue;x(H.config,C.config)||te.push({command:PE.setImportConfig,args:[C.id,C.config]}),x(H.url,C.url)||te.push({command:PE.setImportUrl,args:[C.id,C.url]});const le=C.data;x(H&&H.data,le)||te.push({command:PE.setImportData,args:[C.id,le]})}}(C.imports,H.imports,te)}catch(C){console.warn("Unable to compute style diff:",C),te=[{command:PE.setStyle,args:[H]}]}return te}(this.serialize(),C).filter((C=>!(C.command in lI)));if(0===H.length)return!1;const te=H.filter((C=>!(C.command in aI)));if(te.length>0)throw new Error(`Unimplemented: ${te.map((C=>C.command)).join(", ")}.`);return H.forEach((C=>{this[C.command].apply(this,C.args)})),this.stylesheet=C,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}addImage(C,H){return this.getImage(C)?this.fire(new St(new Error("An image with this name already exists."))):(this.imageManager.addImage(C,this.scope,H),this._afterImageUpdated(C),this)}updateImage(C,H){this.imageManager.updateImage(C,this.scope,H)}getImage(C){return this.imageManager.getImage(C,this.scope)}removeImage(C){return this.getImage(C)?(this.imageManager.removeImage(C,this.scope),this._afterImageUpdated(C),this):this.fire(new St(new Error("No image with this name exists.")))}_afterImageUpdated(C){this._availableImages=this.imageManager.listImages(this.scope),this._changes.changedImages.add(C),this._changes.changed=!0,this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.fire(new At("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModel(C,H,te={}){return this._checkLoaded(),this._validate(vs,`models.${C}`,H,null,te)||(this.modelManager.addModel(C,H,this.scope),this._changes.changed=!0),this}hasModel(C){return this.modelManager.hasModel(C,this.scope)}removeModel(C){return this.hasModel(C)?(this.modelManager.removeModel(C,this.scope),this):this.fire(new St(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(C,H,te={}){if(this._checkLoaded(),void 0!==this.getOwnSource(C))throw new Error(`There is already a source with ID "${C}".`);if(!H.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(H).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(H.type)>=0&&this._validate(us,`sources.${C}`,H,null,te))return;this.map&&this.map._collectResourceTiming&&(H.collectResourceTiming=!0);const le=vT(C,H,this.dispatcher,this);le.scope=this.scope,le.setEventedParent(this,(()=>({isSourceLoaded:this._isSourceCacheLoaded(le.id),source:le.serialize(),sourceId:le.id})));const n=C=>{const H=(C?"symbol:":"other:")+le.id,te=pa(H,this.scope),ce=this._sourceCaches[H]=new Ax(te,le,C);(C?this._symbolSourceCaches:this._otherSourceCaches)[le.id]=ce,ce.onAdd(this.map)};n(!1),"vector"!==H.type&&"geojson"!==H.type||n(!0),le.onAdd&&le.onAdd(this.map),this.mergeSources(),this._changes.changed=!0}removeSource(C){this._checkLoaded();const H=this.getOwnSource(C);if(!H)throw new Error("There is no source with this ID");for(const H in this._layers)if(this._layers[H].source===C)return this.fire(new St(new Error(`Source "${C}" cannot be removed while layer "${H}" is using it.`)));if(this.terrain&&this.terrain.get().source===C)return this.fire(new St(new Error(`Source "${C}" cannot be removed while terrain is using it.`)));const te=this.getOwnSourceCaches(C);for(const C of te){const H=fa(C.id);delete this._sourceCaches[H],delete this._changes.updatedSourceCaches[C.id],C.fire(new At("data",{sourceDataType:"metadata",dataType:"source",sourceId:C.getSource().id})),C.setEventedParent(null),C.clearTiles()}return delete this._otherSourceCaches[C],delete this._symbolSourceCaches[C],this.mergeSources(),H.setEventedParent(null),H.onRemove&&H.onRemove(this.map),this._changes.changed=!0,this}setGeoJSONSourceData(C,H){this._checkLoaded(),this.getOwnSource(C).setData(H),this._changes.changed=!0}getOwnSource(C){const H=this.getOwnSourceCache(C);return H&&H.getSource()}getOwnSources(){const C=[];for(const H in this._otherSourceCaches){const te=this.getOwnSourceCache(H);te&&C.push(te.getSource())}return C}setLights(C){if(this._checkLoaded(),!C)return delete this.ambientLight,void delete this.directionalLight;const H=this._getTransitionParameters();for(const te of C){if(this._validate(ps,"lights",te))return;switch(te.type){case"ambient":if(this.ambientLight){const C=this.ambientLight;C.set(te),C.updateTransitions(H)}else this.ambientLight=new gw(te,NT,this.scope,this.options);break;case"directional":if(this.directionalLight){const C=this.directionalLight;C.set(te),C.updateTransitions(H)}else this.directionalLight=new gw(te,eE,this.scope,this.options)}}const te=new ea(this.z||0,H);this.ambientLight&&this.ambientLight.recalculate(te),this.directionalLight&&this.directionalLight.recalculate(te),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){const C=this.directionalLight,H=this.ambientLight;if(!C||!H)return;const i=C=>.2126*(C[0]<=.03928?C[0]/12.92:Math.pow((C[0]+.055)/1.055,2.4))+.7152*(C[1]<=.03928?C[1]/12.92:Math.pow((C[1]+.055)/1.055,2.4))+.0722*(C[2]<=.03928?C[2]/12.92:Math.pow((C[2]+.055)/1.055,2.4)),te=C.properties.get("color").toArray01(),le=C.properties.get("intensity"),ce=C.properties.get("direction"),he=1-J(ce.x,ce.y,ce.z)[2]/90,ue=i(te)*le*he,de=H.properties.get("color").toArray01(),_e=H.properties.get("intensity");return(ue+i(de)*_e)/2}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;const C=[];return this.directionalLight&&C.push(this.directionalLight.get()),this.ambientLight&&C.push(this.ambientLight.get()),C}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(C){if(!C)return this;const H=this.fragments.find((({id:H})=>H===C));if(!H)throw new Error(`Style import not found: ${C}`);return H.style}setConfigProperty(C,H,te){const le=xo(te);if("success"!==le.result)return void UA(this,le.value);const ce=le.value.expression,he=this.getFragmentStyle(C);he.options.set(H,ce),he.updateConfigDependencies()}setConfig(C,H){if(this.options.clear(),C){for(const H in C){const te=xo(C[H]);"success"===te.result&&this.options.set(H,te.value.expression)}this.updateSchema(H)}}updateSchema(C){if(C)for(const H in C){if(this.options.has(H))continue;const te=xo(C[H].default);"success"===te.result&&this.options.set(H,te.value.expression)}}updateConfigDependencies(){for(const C of this._configDependentLayers){const H=this.getLayer(C);H&&(H.possiblyEvaluateVisibility(),this._updateLayer(H))}this.ambientLight&&this.ambientLight.scope===this.scope&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.scope===this.scope&&this.directionalLight.updateConfig(this.options),this._changes.changed=!0}addLayer(C,H,te={}){this._checkLoaded();const le=C.id;if(this._layers[le])return void this.fire(new St(new Error(`Layer with id "${le}" already exists on this map`)));let ce;if("custom"===C.type){if(UA(this,function(C){const H=[],te=C.id;return void 0===te&&H.push({message:`layers.${te}: missing required property "id"`}),void 0===C.render&&H.push({message:`layers.${te}: missing required method "render"`}),C.renderingMode&&"2d"!==C.renderingMode&&"3d"!==C.renderingMode&&H.push({message:`layers.${te}: property "renderingMode" must be either "2d" or "3d"`}),H}(C)))return;ce=Kb(C,this.options)}else{if("object"==typeof C.source&&(this.addSource(le,C.source),C=k(C=$(C),{source:le})),this._validate(_s,`layers.${le}`,C,{arrayIndex:-1},te))return;ce=Kb(C,this.options),this._validateLayer(ce),ce.setEventedParent(this,{layer:{id:le}}),this._serializedLayers[ce.id]=ce.serialize()}ce.isConfigDependent&&this._configDependentLayers.add(ce.fqid),ce.setScope(this.scope);const he=H?this._order.indexOf(H):this._order.length;if(H&&-1===he)return void this.fire(new St(new Error(`Layer with id "${H}" does not exist on this map.`)));this._order.splice(he,0,le),this._layerOrderChanged=!0,this._layers[le]=ce;const ue=this.getOwnLayerSourceCache(ce),de=!!this.directionalLight&&this.directionalLight.shadowsEnabled();ue&&ce.canCastShadows()&&de&&(ue.castsShadows=!0);const _e=this._changes.getRemovedLayer(ce);if(_e&&ce.source&&ue&&"custom"!==ce.type){this._changes.discardLayerRemoval(ce);const C=pa(ce.source,ce.scope);_e.type!==ce.type?this._changes.updatedSourceCaches[C]="clear":(this._changes.updatedSourceCaches[C]="reload",ue.pause())}this._updateLayer(ce),ce.onAdd&&ce.onAdd(this.map),ce.scope=this.scope,this.mergeLayers()}moveLayer(C,H){if(this._checkLoaded(),this._changes.changed=!0,!this._checkLayer(C))return;if(C===H)return;const te=this._order.indexOf(C);this._order.splice(te,1);const le=H?this._order.indexOf(H):this._order.length;H&&-1===le?this.fire(new St(new Error(`Layer with id "${H}" does not exist on this map.`))):(this._order.splice(le,0,C),this._layerOrderChanged=!0,this.mergeLayers())}removeLayer(C){this._checkLoaded();const H=this._checkLayer(C);if(!H)return;H.setEventedParent(null);const te=this._order.indexOf(C);this._order.splice(te,1),delete this._layers[C],delete this._serializedLayers[C],this._changes.changed=!0,this._layerOrderChanged=!0,this._configDependentLayers.delete(H.fqid),this._changes.removeLayer(H);const le=this.getOwnLayerSourceCache(H);if(le&&le.castsShadows){let C=!1;for(const te in this._layers)if(this._layers[te].source===H.source&&this._layers[te].canCastShadows()){C=!0;break}le.castsShadows=C}H.onRemove&&H.onRemove(this.map),this.mergeLayers()}getOwnLayer(C){return this._layers[C]}hasLayer(C){return C in this._mergedLayers}hasLayerType(C){for(const H in this._layers)if(this._layers[H].type===C)return!0;return!1}setLayerZoomRange(C,H,te){this._checkLoaded();const le=this._checkLayer(C);le&&(le.minzoom===H&&le.maxzoom===te||(null!=H&&(le.minzoom=H),null!=te&&(le.maxzoom=te),this._updateLayer(le)))}setSlot(C,H){this._checkLoaded();const te=this._checkLayer(C);te&&te.slot!==H&&(te.slot=H,this._updateLayer(te))}setFilter(C,H,te={}){this._checkLoaded();const le=this._checkLayer(C);if(le&&!x(le.filter,H))return null==H?(le.filter=void 0,void this._updateLayer(le)):void(this._validate(gs,`layers.${le.id}.filter`,H,{layerType:le.type},te)||(le.filter=$(H),this._updateLayer(le)))}getFilter(C){const H=this._checkLayer(C);if(H)return $(H.filter)}setLayoutProperty(C,H,te,le={}){this._checkLoaded();const ce=this._checkLayer(C);ce&&(x(ce.getLayoutProperty(H),te)||(ce.setLayoutProperty(H,te,le),ce.isConfigDependent&&this._configDependentLayers.add(ce.fqid),this._updateLayer(ce)))}getLayoutProperty(C,H){const te=this._checkLayer(C);if(te)return te.getLayoutProperty(H)}setPaintProperty(C,H,te,le={}){this._checkLoaded();const ce=this._checkLayer(C);if(!ce)return;if(x(ce.getPaintProperty(H),te))return;const he=ce.setPaintProperty(H,te,le);ce.isConfigDependent&&this._configDependentLayers.add(ce.fqid),he&&this._updateLayer(ce),this._changes.changed=!0,this._changes.updatedPaintProps.add(ce.fqid)}getPaintProperty(C,H){const te=this._checkLayer(C);if(te)return te.getPaintProperty(H)}setFeatureState(C,H){this._checkLoaded();const te=C.source,le=C.sourceLayer,ce=this._checkSource(te);if(!ce)return;const he=ce.type;if("geojson"===he&&le)return void this.fire(new St(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if("vector"===he&&!le)return void this.fire(new St(new Error("The sourceLayer parameter must be provided for vector source types.")));void 0===C.id&&this.fire(new St(new Error("The feature id parameter must be provided.")));const ue=this.getOwnSourceCaches(te);for(const te of ue)te.setFeatureState(le,C.id,H)}removeFeatureState(C,H){this._checkLoaded();const te=C.source,le=this._checkSource(te);if(!le)return;const ce=le.type,he="vector"===ce?C.sourceLayer:void 0;if("vector"===ce&&!he)return void this.fire(new St(new Error("The sourceLayer parameter must be provided for vector source types.")));if(H&&"string"!=typeof C.id&&"number"!=typeof C.id)return void this.fire(new St(new Error("A feature id is required to remove its specific state property.")));const ue=this.getOwnSourceCaches(te);for(const te of ue)te.removeFeatureState(he,C.id,H)}getFeatureState(C){this._checkLoaded();const H=C.source,te=C.sourceLayer,le=this._checkSource(H);if(le){if("vector"!==le.type||te)return void 0===C.id&&this.fire(new St(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(H)[0].getFeatureState(te,C.id);this.fire(new St(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(C){return this.stylesheet.transition=k({},this.stylesheet.transition,C),this.transition=this.stylesheet.transition,this}getTransition(){return k({},this.stylesheet.transition)}serialize(){this._checkLoaded();const C=this.getTerrain(),H=C&&this.terrain&&this.terrain.scope===this.scope?C:void 0;return Z({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:H,fog:this.stylesheet.fog,center:this.stylesheet.center,zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},(C=>void 0!==C))}_updateLayer(C){this._changes.updateLayer(C);const H=this.getLayerSourceCache(C),te=pa(C.source,C.scope);C.source&&!this._changes.updatedSourceCaches[te]&&H&&"raster"!==H.getSource().type&&(this._changes.updatedSourceCaches[te]="reload",H.pause()),this._changes.changed=!0,C.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(C){const t=C=>"fill-extrusion"===this._mergedLayers[C].type,H=this.order,te={},le=[];for(let ce=H.length-1;ce>=0;ce--){const he=H[ce];if(t(he)){te[he]=ce;for(const H of C){const C=H[he];if(C)for(const H of C)le.push(H)}}}le.sort(((C,H)=>H.intersectionZ-C.intersectionZ));const ce=[];for(let he=H.length-1;he>=0;he--){const ue=H[he];if(t(ue))for(let C=le.length-1;C>=0;C--){const H=le[C].feature;if(te[H.layer.id]<he)break;ce.push(H),le.pop()}else for(const H of C){const C=H[ue];if(C)for(const H of C)ce.push(H.feature)}}return ce}queryRenderedFeatures(C,H,te){H&&H.filter&&this._validate(gs,"queryRenderedFeatures.filter",H.filter,null,H),H.scope=this.scope,H.availableImages=this._availableImages,H.serializedLayers=this._serializedLayers;const le={};if(H&&H.layers){if(!Array.isArray(H.layers))return this.fire(new St(new Error("parameters.layers must be an Array."))),[];for(const C of H.layers){const H=this._mergedLayers[C];if(!H)return this.fire(new St(new Error(`The layer '${C}' does not exist in the map's style and cannot be queried for features.`))),[];le[H.source]=!0}}const ce=[],he=H.serializedLayers||{},ue=H&&H.layers?H.layers.some((C=>{const H=this.getLayer(C);return H&&H.is3D()})):this.has3DLayers(),de=vw.createFromScreenPoints(C,te);for(const C in this._mergedSourceCaches){const _e=this._mergedSourceCaches[C].getSource();if(!_e||_e.scope!==H.scope)continue;const ye=this._mergedSourceCaches[C].getSource().id;H.layers&&!le[ye]||ce.push(wT(this._mergedSourceCaches[C],this._mergedLayers,he,de,H,te,ue,!!this.map._showQueryGeometry))}return this.placement&&ce.push(function(C,H,te,le,ce,he,ue){const de={},_e=he.queryRenderedSymbols(le),ye=[];for(const C of Object.keys(_e).map(Number))ye.push(ue[C]);ye.sort(ET);for(const te of ye){const le=te.featureIndex.lookupSymbolFeatures(_e[te.bucketInstanceId],H,te.bucketIndex,te.sourceLayerIndex,ce.filter,ce.layers,ce.availableImages,C);for(const C in le){const H=de[C]=de[C]||[],ce=le[C];ce.sort(((C,H)=>{const le=te.featureSortOrder;if(le){const te=le.indexOf(C.featureIndex);return le.indexOf(H.featureIndex)-te}return H.featureIndex-C.featureIndex}));for(const C of ce)H.push(C)}}for(const H in de)de[H].forEach((le=>{const ce=le.feature,he=te(C[H]);if(!he)return;const ue=he.getFeatureState(ce.layer["source-layer"],ce.id);ce.source=ce.layer.source,ce.layer["source-layer"]&&(ce.sourceLayer=ce.layer["source-layer"]),ce.state=ue}));return de}(this._mergedLayers,he,this.getLayerSourceCache.bind(this),de.screenGeometry,H,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(ce)}querySourceFeatures(C,H){H&&H.filter&&this._validate(gs,"querySourceFeatures.filter",H.filter,null,H);const te=this.getOwnSourceCaches(C);let le=[];for(const C of te)le=le.concat(TT(C,H));return le}addSourceType(C,H,te){return $A.getSourceType(C)?te(new Error(`A source type called "${C}" already exists.`)):($A.setSourceType(C,H),H.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:C,url:H.workerSourceURL},te):te(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(C,H,te={}){this._checkLoaded();const le=this.light.getLight();let ce=!1;for(const H in C)if(!x(C[H],le[H])){ce=!0;break}if(!ce)return;const he=this._getTransitionParameters();this.light.setLight(C,H,te),this.light.updateTransitions(he)}getTerrain(){return this.terrain&&1===this.terrain.drapeRenderMode?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}setTerrain(C,H=1){if(this._checkLoaded(),!C)return delete this.terrain,delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);let te=C;if(1===H){if("object"==typeof te.source){const C="terrain-dem-src";this.addSource(C,te.source),te=$(te),te=k(te,{source:C})}if(this._validate(fs,"terrain",te))return}if(!this.terrain||this.terrain&&H!==this.terrain.drapeRenderMode){if(!te)return;this._createTerrain(te,H),this.fire(new At("data",{dataType:"style"}))}else{const H=this.terrain,le=H.get();for(const C of Object.keys(Ai.terrain))!te.hasOwnProperty(C)&&Ai.terrain[C].default&&(te[C]=Ai.terrain[C].default);for(const te in C)if(!x(C[te],le[te])){H.set(C),this.stylesheet.terrain=C;const te=this._getTransitionParameters({duration:0});H.updateTransitions(te),this.fire(new At("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(C){const H=this.fog=new dw(C,this.map.transform);this.stylesheet.fog=H.get();const te=this._getTransitionParameters({duration:0});H.updateTransitions(te)}_updateMarkersOpacity(){0!==this.map._markers.length&&this.map._requestDomTask((()=>{for(const C of this.map._markers)C._evaluateOpacity()}))}getFog(){return this.fog?this.fog.get():null}setFog(C){if(this._checkLoaded(),!C)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const H=this.fog;if(!x(H.get(),C)){H.set(C),this.stylesheet.fog=H.get();const te=this._getTransitionParameters({duration:0});H.updateTransitions(te)}}else this._createFog(C);this._markersNeedUpdate=!0}_getTransitionParameters(C){return{now:yi.now(),transition:k(this.transition,C)}}updateDrapeFirstLayers(){if(!this.terrain)return;const C=[],H=[];for(const te in this._mergedLayers)this.isLayerDraped(this._mergedLayers[te])?C.push(te):H.push(te);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...C),this._drapedFirstOrder.push(...H)}_createTerrain(C,H){const te=this.terrain=new eT(C,H);te.setScope(this.scope),this.stylesheet.terrain=C,this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();const le=this._getTransitionParameters({duration:0});te.updateTransitions(le)}_force3DLayerUpdate(){for(const C in this._layers){const H=this._layers[C];"fill-extrusion"===H.type&&this._updateLayer(H)}}_forceSymbolLayerUpdate(){for(const C in this._layers){const H=this._layers[C];"symbol"===H.type&&this._updateLayer(H)}}_validate(C,H,te,le,ce={}){if(ce&&!1===ce.validate)return!1;const he=k({},this.serialize());return UA(this,C.call(hs,k({key:H,style:he,value:te,styleSpec:Ai},le)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),ec.off("pluginStateChange",this._rtlTextPluginCallback);for(const C in this._mergedLayers)this._mergedLayers[C].setEventedParent(null);for(const C in this._mergedSourceCaches)this._mergedSourceCaches[C].clearTiles(),this._mergedSourceCaches[C].setEventedParent(null);this.setEventedParent(null),delete this.fog,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.modelManager.setEventedParent(null),this.dispatcher.remove())}clearSource(C){const H=this.getSourceCaches(C);for(const C of H)C.clearTiles()}clearSources(){for(const C in this._mergedSourceCaches)this._mergedSourceCaches[C].clearTiles()}reloadSource(C){const H=this.getSourceCaches(C);for(const C of H)C.resume(),C.reload()}updateSources(C){let H;this.directionalLight&&(H=OA(this.directionalLight));for(const te in this._mergedSourceCaches)this._mergedSourceCaches[te].update(C,void 0,void 0,H)}_generateCollisionBoxes(){for(const C in this._sourceCaches){const H=this._sourceCaches[C];H.resume(),H.reload()}}_updatePlacement(C,H,te,le,ce=!1){let he=!1,ue=!1;const de={},_e={};for(const H of this._mergedOrder){const te=this._mergedLayers[H];if("symbol"!==te.type)continue;const le=pa(te.source,te.scope);let ce=de[le];if(!ce){const C=this.getLayerSourceCache(te);if(!C)continue;const H=C.getRenderableIds(!0).map((H=>C.getTileByID(H)));_e[le]=H.slice(),ce=de[le]=H.sort(((C,H)=>H.tileID.overscaledZ-C.tileID.overscaledZ||(C.tileID.isLessThan(H.tileID)?-1:1)))}const ue=this.crossTileSymbolIndex.addLayer(te,ce,C.center.lng,C.projection);he=he||ue}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),ce=ce||this._layerOrderChanged||0===te,this._layerOrderChanged&&this.fire(new At("neworder")),(ce||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(yi.now(),C.zoom))&&(this.pauseablePlacement=new hE(C,this._mergedOrder,ce,H,te,le,this.placement,this.fog&&C.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,de,_e),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(yi.now()),ue=!0),he&&this.pauseablePlacement.placement.setStale()),ue||he)for(const C of this._mergedOrder){const H=this._mergedLayers[C];"symbol"===H.type&&this.placement.updateLayerOpacities(H,de[pa(H.source,H.scope)])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(yi.now())}_releaseSymbolFadeTiles(){for(const C in this._sourceCaches)this._sourceCaches[C].releaseSymbolFadeTiles()}addImport(C){this._checkLoaded();const H=this.stylesheet.imports=this.stylesheet.imports||[],te=H.findIndex((({id:H})=>H===C.id));return-1!==te?this.fire(new St(new Error(`Import with id '${C.id}' already exists in the map's style.`))):(H.push(C),this._loadImports([C],!0),this)}setImportUrl(C,H){this._checkLoaded();const te=this.stylesheet.imports||[],le=this.getImportIndex(C);if(-1===le)return this;te[le].url=H;const ce=this.fragments[le];ce.style=this._createFragmentStyle({id:C,url:H});const he=new Promise((C=>ce.style.on("style.import.load",C)));return ce.style.loadURL(H),he.then((()=>this._reloadImports())),this}setImportData(C,H){this._checkLoaded();const te=this.getImportIndex(C),le=this.stylesheet.imports||[];return-1===te?this:H?(this.fragments[te].style.setState(H),this._reloadImports(),this):(delete le[te].data,this.setImportUrl(C,le[te].url))}setImportConfig(C,H){this._checkLoaded();const te=this.getImportIndex(C),le=this.stylesheet.imports||[];if(-1===te)return this;H?le[te].config=H:delete le[te].config;const ce=this.fragments[te],he=ce.style.stylesheet&&ce.style.stylesheet.schema;return ce.config=H,ce.style.setConfig(H,he),ce.style.updateConfigDependencies(),this}removeImport(C){this._checkLoaded();const H=this.stylesheet.imports||[],te=this.getImportIndex(C);return-1===te||(H.splice(te,1),this.fragments[te].style._remove(),this.fragments.splice(te,1),this._reloadImports()),this}getImportIndex(C){const H=(this.stylesheet.imports||[]).findIndex((H=>H.id===C));return-1===H&&this.fire(new St(new Error(`Import '${C}' does not exist in the map's style and cannot be updated.`))),H}getLayer(C){return this._mergedLayers[C]}getSources(){const C=[];for(const H in this._mergedOtherSourceCaches){const te=this._mergedOtherSourceCaches[H];te&&C.push(te.getSource())}return C}getSource(C,H){const te=this.getSourceCache(C,H);return te&&te.getSource()}getLayerSource(C){const H=this.getLayerSourceCache(C);return H&&H.getSource()}getSourceCache(C,H){const te=pa(C,H);return this._mergedOtherSourceCaches[te]}getLayerSourceCache(C){const H=pa(C.source,C.scope);return"symbol"===C.type?this._mergedSymbolSourceCaches[H]:this._mergedOtherSourceCaches[H]}getSourceCaches(C){const H=[];return this._mergedOtherSourceCaches[C]&&H.push(this._mergedOtherSourceCaches[C]),this._mergedSymbolSourceCaches[C]&&H.push(this._mergedSymbolSourceCaches[C]),H}updateSourceCaches(){for(const C in this._changes.updatedSourceCaches){const H=this._changes.updatedSourceCaches[C];"reload"===H?this.reloadSource(C):"clear"===H&&this.clearSource(C)}}updateLayers(C){for(const H of this._changes.updatedPaintProps){const te=this.getLayer(H);te&&te.updateTransitions(C)}}getImages(C,H,te){this.imageManager.getImages(H.icons,H.scope,te),this._updateTilesForChangedImages();const r=C=>{C&&C.setDependencies(H.tileID.key,H.type,H.icons)};r(this._otherSourceCaches[H.source]),r(this._symbolSourceCaches[H.source])}getGlyphs(C,H,te){this.glyphManager.getGlyphs(H.stacks,H.scope,te)}getResource(C,H,te){return be(H,te)}getOwnSourceCache(C){return this._otherSourceCaches[C]}getOwnLayerSourceCache(C){return"symbol"===C.type?this._symbolSourceCaches[C.source]:this._otherSourceCaches[C.source]}getOwnSourceCaches(C){const H=[];return this._otherSourceCaches[C]&&H.push(this._otherSourceCaches[C]),this._symbolSourceCaches[C]&&H.push(this._symbolSourceCaches[C]),H}_isSourceCacheLoaded(C){const H=this.getOwnSourceCaches(C);return 0===H.length?(this.fire(new St(new Error(`There is no source with ID '${C}'`))),!1):H.every((C=>C.loaded()))}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}function HA(C,H){let te=!1,le=null;const n=()=>{le=null,te&&(C(),le=setTimeout(n,H),te=!1)};return()=>(te=!0,le||n(),le)}$A.getSourceType=function(C){return zE[C]},$A.setSourceType=function(C,H){zE[C]=H},$A.registerForPluginStateChange=function(C){return C({pluginStatus:Yl,pluginURL:Kl}),ec.on("pluginStateChange",C),C};class WA{constructor(C){this._hashName=C&&encodeURIComponent(C),j(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=HA(this._updateHashUnthrottled.bind(this),300)}addTo(C){return this._map=C,te.addEventListener("hashchange",this._onHashChange,!1),C.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),te.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const C=this._map;if(!C)return"";const H=XA(C);if(this._hashName){const C=this._hashName;let le=!1;const ce=te.location.hash.slice(1).split("&").map((te=>{const ce=te.split("=")[0];return ce===C?(le=!0,`${ce}=${H}`):te})).filter((C=>C));return le||ce.push(`${C}=${H}`),`#${ce.join("&")}`}return`#${H}`}_getCurrentHash(){const C=te.location.hash.replace("#","");if(this._hashName){let H;return C.split("&").map((C=>C.split("="))).forEach((C=>{C[0]===this._hashName&&(H=C)})),(H&&H[1]||"").split("/")}return C.split("/")}_onHashChange(){const C=this._map;if(!C)return!1;const H=this._getCurrentHash();if(H.length>=3&&!H.some((C=>isNaN(C)))){const te=C.dragRotate.isEnabled()&&C.touchZoomRotate.isEnabled()?+(H[3]||0):C.getBearing();return C.jumpTo({center:[+H[2],+H[1]],zoom:+H[0],bearing:te,pitch:+(H[4]||0)}),!0}return!1}_updateHashUnthrottled(){const C=te.location.href.replace(/(#.+)?$/,this.getHashString());te.history.replaceState(te.history.state,null,C)}}function XA(C,H){const te=C.getCenter(),le=Math.round(100*C.getZoom())/100,ce=Math.ceil((le*Math.LN2+Math.log(512/360/.5))/Math.LN10),he=Math.pow(10,ce),ue=Math.round(te.lng*he)/he,de=Math.round(te.lat*he)/he,_e=C.getBearing(),ye=C.getPitch();let ve=H?`/${ue}/${de}/${le}`:`${le}/${de}/${ue}`;return(_e||ye)&&(ve+="/"+Math.round(10*_e)/10),ye&&(ve+=`/${Math.round(ye)}`),ve}const dI={linearity:.3,easing:I(0,0,.3,1)},pI=k({deceleration:2500,maxSpeed:1400},dI),fI=k({deceleration:20,maxSpeed:1400},dI),mI=k({deceleration:1e3,maxSpeed:360},dI),_I=k({deceleration:1e3,maxSpeed:90},dI);class tS{constructor(C){this._map=C,this.clear()}clear(){this._inertiaBuffer=[]}record(C){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:yi.now(),settings:C})}_drainInertiaBuffer(){const C=this._inertiaBuffer,H=yi.now();for(;C.length>0&&H-C[0].time>160;)C.shift()}_onMoveEnd(C){if(this._map._prefersReducedMotion())return;if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const H={zoom:0,bearing:0,pitch:0,pan:new Ne(0,0),pinchAround:void 0,around:void 0};for(const{settings:C}of this._inertiaBuffer)H.zoom+=C.zoomDelta||0,H.bearing+=C.bearingDelta||0,H.pitch+=C.pitchDelta||0,C.panDelta&&H.pan._add(C.panDelta),C.around&&(H.around=C.around),C.pinchAround&&(H.pinchAround=C.pinchAround);const te=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,le={};if(H.pan.mag()){const ce=rS(H.pan.mag(),te,k({},pI,C||{}));le.offset=H.pan.mult(ce.amount/H.pan.mag()),le.center=this._map.transform.center,iS(le,ce)}if(H.zoom){const C=rS(H.zoom,te,fI);le.zoom=this._map.transform.zoom+C.amount,iS(le,C)}if(H.bearing){const C=rS(H.bearing,te,mI);le.bearing=this._map.transform.bearing+z(C.amount,-179,179),iS(le,C)}if(H.pitch){const C=rS(H.pitch,te,_I);le.pitch=this._map.transform.pitch+C.amount,iS(le,C)}if(le.zoom||le.bearing){const C=void 0===H.pinchAround?H.around:H.pinchAround;le.around=C?this._map.unproject(C):this._map.getCenter()}return this.clear(),le.noMoveStart=!0,le}}function iS(C,H){(!C.duration||C.duration<H.duration)&&(C.duration=H.duration,C.easing=H.easing)}function rS(C,H,te){const{maxSpeed:le,linearity:ce,deceleration:he}=te,ue=z(C*ce/(H/1e3),-le,le),de=Math.abs(ue)/(he*ce);return{easing:te.easing,duration:1e3*de,amount:ue*(de/2)}}class nS extends At{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(C,H,te,le={}){const ce=vt(H.getCanvasContainer(),te);super(C,k({point:ce,lngLat:H.unproject(ce),originalEvent:te},le)),this._defaultPrevented=!1,this.target=H}}class oS extends At{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(C,H,te){const le="touchend"===C?te.changedTouches:te.touches,ce=bt(H.getCanvasContainer(),le),he=ce.map((C=>H.unproject(C))),ue=ce.reduce(((C,H,te,le)=>C.add(H.div(le.length))),new Ne(0,0));super(C,{points:ce,point:ue,lngLats:he,lngLat:H.unproject(ue),originalEvent:te}),this._defaultPrevented=!1}}class sS extends At{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(C,H,te){super(C,{originalEvent:te}),this._defaultPrevented=!1}}class aS{constructor(C,H){this._map=C,this._clickTolerance=H.clickTolerance}reset(){this._mousedownPos=void 0}wheel(C){return this._firePreventable(new sS(C.type,this._map,C))}mousedown(C,H){return this._mousedownPos=H,this._firePreventable(new nS(C.type,this._map,C))}mouseup(C){this._map.fire(new nS(C.type,this._map,C))}preclick(C){const H=k({},C);H.type="preclick",this._map.fire(new nS(H.type,this._map,H))}click(C,H){this._mousedownPos&&this._mousedownPos.dist(H)>=this._clickTolerance||(this.preclick(C),this._map.fire(new nS(C.type,this._map,C)))}dblclick(C){return this._firePreventable(new nS(C.type,this._map,C))}mouseover(C){this._map.fire(new nS(C.type,this._map,C))}mouseout(C){this._map.fire(new nS(C.type,this._map,C))}touchstart(C){return this._firePreventable(new oS(C.type,this._map,C))}touchmove(C){this._map.fire(new oS(C.type,this._map,C))}touchend(C){this._map.fire(new oS(C.type,this._map,C))}touchcancel(C){this._map.fire(new oS(C.type,this._map,C))}_firePreventable(C){if(this._map.fire(C),C.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class lS{constructor(C){this._map=C}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(C){this._map.fire(new nS(C.type,this._map,C))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new nS("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(C){this._delayContextMenu?this._contextMenuEvent=C:this._map.fire(new nS(C.type,this._map,C)),this._map.listens("contextmenu")&&C.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class cS{constructor(C,H){this._map=C,this._el=C.getCanvasContainer(),this._container=C.getContainer(),this._clickTolerance=H.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(C,H){this.isEnabled()&&C.shiftKey&&0===C.button&&(_t(),this._startPos=this._lastPos=H,this._active=!0)}mousemoveWindow(C,H){if(!this._active)return;const te=H,le=this._startPos,ce=this._lastPos;if(!le||!ce||ce.equals(te)||!this._box&&te.dist(le)<this._clickTolerance)return;this._lastPos=te,this._box||(this._box=ut("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",C));const he=Math.min(le.x,te.x),ue=Math.max(le.x,te.x),de=Math.min(le.y,te.y),_e=Math.max(le.y,te.y);this._map._requestDomTask((()=>{this._box&&(this._box.style.transform=`translate(${he}px,${de}px)`,this._box.style.width=ue-he+"px",this._box.style.height=_e-de+"px")}))}mouseupWindow(C,H){if(!this._active)return;const te=this._startPos,le=H;if(te&&0===C.button){if(this.reset(),xt(),te.x!==le.x||te.y!==le.y)return this._map.fire(new At("boxzoomend",{originalEvent:C})),{cameraAnimation:C=>C.fitScreenCoordinates(te,le,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",C)}}keydown(C){this._active&&27===C.keyCode&&(this.reset(),this._fireEvent("boxzoomcancel",C))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),gt(),delete this._startPos,delete this._lastPos}_fireEvent(C,H){return this._map.fire(new At(C,{originalEvent:H}))}}function hS(C,H){const te={};for(let le=0;le<C.length;le++)te[C[le].identifier]=H[le];return te}class uS{constructor(C){this.reset(),this.numTouches=C.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(C,H,te){(this.centroid||te.length>this.numTouches)&&(this.aborted=!0),this.aborted||(0===this.startTime&&(this.startTime=C.timeStamp),te.length===this.numTouches&&(this.centroid=function(C){const H=new Ne(0,0);for(const te of C)H._add(te);return H.div(C.length)}(H),this.touches=hS(te,H)))}touchmove(C,H,te){if(this.aborted||!this.centroid)return;const le=hS(te,H);for(const C in this.touches){const H=le[C];(!H||H.dist(this.touches[C])>30)&&(this.aborted=!0)}}touchend(C,H,te){if((!this.centroid||C.timeStamp-this.startTime>500)&&(this.aborted=!0),0===te.length){const C=!this.aborted&&this.centroid;if(this.reset(),C)return C}}}class dS{constructor(C){this.singleTap=new uS(C),this.numTaps=C.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(C,H,te){this.singleTap.touchstart(C,H,te)}touchmove(C,H,te){this.singleTap.touchmove(C,H,te)}touchend(C,H,te){const le=this.singleTap.touchend(C,H,te);if(le){const H=C.timeStamp-this.lastTime<500,te=!this.lastTap||this.lastTap.dist(le)<30;if(H&&te||this.reset(),this.count++,this.lastTime=C.timeStamp,this.lastTap=le,this.count===this.numTaps)return this.reset(),le}}}class pS{constructor(){this._zoomIn=new dS({numTouches:1,numTaps:2}),this._zoomOut=new dS({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(C,H,te){this._zoomIn.touchstart(C,H,te),this._zoomOut.touchstart(C,H,te)}touchmove(C,H,te){this._zoomIn.touchmove(C,H,te),this._zoomOut.touchmove(C,H,te)}touchend(C,H,te){const le=this._zoomIn.touchend(C,H,te),ce=this._zoomOut.touchend(C,H,te);return le?(this._active=!0,C.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:H=>H.easeTo({duration:300,zoom:H.getZoom()+1,around:H.unproject(le)},{originalEvent:C})}):ce?(this._active=!0,C.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:H=>H.easeTo({duration:300,zoom:H.getZoom()-1,around:H.unproject(ce)},{originalEvent:C})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const gI={0:1,2:2};class mS{constructor(C){this.reset(),this._clickTolerance=C.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(C,H){return!1}_move(C,H){return{}}mousedown(C,H){if(this._lastPoint)return;const te=wt(C);this._correctButton(C,te)&&(this._lastPoint=H,this._eventButton=te)}mousemoveWindow(C,H){const te=this._lastPoint;if(te)if(C.preventDefault(),null!=this._eventButton&&function(C,H){const te=gI[H];return void 0===C.buttons||(C.buttons&te)!==te}(C,this._eventButton))this.reset();else if(this._moved||!(H.dist(te)<this._clickTolerance))return this._moved=!0,this._lastPoint=H,this._move(te,H)}mouseupWindow(C){this._lastPoint&&wt(C)===this._eventButton&&(this._moved&&xt(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class _S extends mS{mousedown(C,H){super.mousedown(C,H),this._lastPoint&&(this._active=!0)}_correctButton(C,H){return 0===H&&!C.ctrlKey}_move(C,H){return{around:H,panDelta:H.sub(C)}}}class gS extends mS{_correctButton(C,H){return 0===H&&C.ctrlKey||2===H}_move(C,H){const te=.8*(H.x-C.x);if(te)return this._active=!0,{bearingDelta:te}}contextmenu(C){C.preventDefault()}}class yS extends mS{_correctButton(C,H){return 0===H&&C.ctrlKey||2===H}_move(C,H){const te=-.5*(H.y-C.y);if(te)return this._active=!0,{pitchDelta:te}}contextmenu(C){C.preventDefault()}}class xS{constructor(C,H){this._map=C,this._el=C.getCanvasContainer(),this._minTouches=1,this._clickTolerance=H.clickTolerance||1,this.reset(),j(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new Ne(0,0)}touchstart(C,H,te){return this._calculateTransform(C,H,te)}touchmove(C,H,te){if(this._active&&!(te.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(1===te.length&&!ie())return void this._showTouchPanBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return C.cancelable&&C.preventDefault(),this._calculateTransform(C,H,te)}}touchend(C,H,te){this._calculateTransform(C,H,te),this._active&&te.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(C,H,te){te.length>0&&(this._active=!0);const le=hS(te,H),ce=new Ne(0,0),he=new Ne(0,0);let ue=0;for(const C in le){const H=le[C],te=this._touches[C];te&&(ce._add(H),he._add(H.sub(te)),ue++,le[C]=H)}if(this._touches=le,ue<this._minTouches||!he.mag())return;const de=he.div(ue);return this._sum._add(de),this._sum.mag()<this._clickTolerance?void 0:{around:ce.div(ue),panDelta:de}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=ut("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout((()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","null")}),500)}}class vS{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(C){}_move(C,H,te){return{}}touchstart(C,H,te){this._firstTwoTouches||te.length<2||(this._firstTwoTouches=[te[0].identifier,te[1].identifier],this._start([H[0],H[1]]))}touchmove(C,H,te){const le=this._firstTwoTouches;if(!le)return;C.preventDefault();const[ce,he]=le,ue=bS(te,H,ce),de=bS(te,H,he);if(!ue||!de)return;const _e=this._aroundCenter?null:ue.add(de).div(2);return this._move([ue,de],_e,C)}touchend(C,H,te){if(!this._firstTwoTouches)return;const[le,ce]=this._firstTwoTouches,he=bS(te,H,le),ue=bS(te,H,ce);he&&ue||(this._active&&xt(),this.reset())}touchcancel(){this.reset()}enable(C){this._enabled=!0,this._aroundCenter=!!C&&"center"===C.around}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function bS(C,H,te){for(let le=0;le<C.length;le++)if(C[le].identifier===te)return H[le]}function wS(C,H){return Math.log(C/H)/Math.LN2}class TS extends vS{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(C){this._startDistance=this._distance=C[0].dist(C[1])}_move(C,H){const te=this._distance;if(this._distance=C[0].dist(C[1]),this._active||!(Math.abs(wS(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:wS(this._distance,te),pinchAround:H}}}function ES(C,H){return 180*C.angleWith(H)/Math.PI}class MS extends vS{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(C){this._startVector=this._vector=C[0].sub(C[1]),this._minDiameter=C[0].dist(C[1])}_move(C,H){const te=this._vector;if(this._vector=C[0].sub(C[1]),te&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:ES(this._vector,te),pinchAround:H}}_isBelowThreshold(C){this._minDiameter=Math.min(this._minDiameter,C.mag());const H=25/(Math.PI*this._minDiameter)*360,te=this._startVector;if(!te)return!1;const le=ES(C,te);return Math.abs(le)<H}}function AS(C){return Math.abs(C.y)>Math.abs(C.x)}class SS extends vS{constructor(C){super(),this._map=C}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(C){this._lastPoints=C,AS(C[0].sub(C[1]))&&(this._valid=!1)}_move(C,H,te){const le=this._lastPoints;if(!le)return;const ce=C[0].sub(le[0]),he=C[1].sub(le[1]);return this._map._cooperativeGestures&&!ie()&&te.touches.length<3||(this._valid=this.gestureBeginsVertically(ce,he,te.timeStamp),!this._valid)?void 0:(this._lastPoints=C,this._active=!0,{pitchDelta:(ce.y+he.y)/2*-.5})}gestureBeginsVertically(C,H,te){if(void 0!==this._valid)return this._valid;const le=C.mag()>=2,ce=H.mag()>=2;if(!le&&!ce)return;if(!le||!ce)return null==this._firstMove&&(this._firstMove=te),te-this._firstMove<100&&void 0;const he=C.y>0==H.y>0;return AS(C)&&AS(H)&&he}}const yI={panStep:100,bearingStep:15,pitchStep:10};class CS{constructor(){const C=yI;this._panStep=C.panStep,this._bearingStep=C.bearingStep,this._pitchStep=C.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(C){if(C.altKey||C.ctrlKey||C.metaKey)return;let H=0,te=0,le=0,ce=0,he=0;switch(C.keyCode){case 61:case 107:case 171:case 187:H=1;break;case 189:case 109:case 173:H=-1;break;case 37:C.shiftKey?te=-1:(C.preventDefault(),ce=-1);break;case 39:C.shiftKey?te=1:(C.preventDefault(),ce=1);break;case 38:C.shiftKey?le=1:(C.preventDefault(),he=-1);break;case 40:C.shiftKey?le=-1:(C.preventDefault(),he=1);break;default:return}return this._rotationDisabled&&(te=0,le=0),{cameraAnimation:ue=>{const de=ue.getZoom();ue.easeTo({duration:300,easeId:"keyboardHandler",easing:zS,zoom:H?Math.round(de)+H*(C.shiftKey?2:1):de,bearing:ue.getBearing()+te*this._bearingStep,pitch:ue.getPitch()+le*this._pitchStep,offset:[-ce*this._panStep,-he*this._panStep],center:ue.getCenter()},{originalEvent:C})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function zS(C){return C*(2-C)}const xI=4.000244140625;class PS{constructor(C,H){this._map=C,this._el=C.getCanvasContainer(),this._handler=H,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=.0022222222222222222,j(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(C){this._defaultZoomRate=C}setWheelZoomRate(C){this._wheelZoomRate=C}isEnabled(){return!!this._enabled}isActive(){return this._active||void 0!==this._finishTimeout}isZooming(){return!!this._zooming}enable(C){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!C&&"center"===C.around,this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(C){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(C.ctrlKey||C.metaKey||this.isZooming()||ie()))return void this._showBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let H=C.deltaMode===te.WheelEvent.DOM_DELTA_LINE?40*C.deltaY:C.deltaY;const le=yi.now(),ce=le-(this._lastWheelEventTime||0);this._lastWheelEventTime=le,0!==H&&H%xI==0?this._type="wheel":0!==H&&Math.abs(H)<4?this._type="trackpad":ce>400?(this._type=null,this._lastValue=H,this._timeout=setTimeout(this._onTimeout,40,C)):this._type||(this._type=Math.abs(ce*H)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,H+=this._lastValue)),C.shiftKey&&H&&(H/=4),this._type&&(this._lastWheelEvent=C,this._delta-=H,this._active||this._start(C)),C.preventDefault()}_onTimeout(C){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(C)}_start(C){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const H=vt(this._el,C);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:H,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId)return;if(this._frameId=null,!this.isActive())return;const C=this._map.transform;"wheel"===this._type&&C.projection.wrap&&(C._center.lng>=180||C._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const t=()=>C._terrainEnabled()&&this._aroundCoord?C.computeZoomRelativeTo(this._aroundCoord):C.zoom;if(0!==this._delta){const H="wheel"===this._type&&Math.abs(this._delta)>xI?this._wheelZoomRate:this._defaultZoomRate;let te=2/(1+Math.exp(-Math.abs(this._delta*H)));this._delta<0&&0!==te&&(te=1/te);const le=t(),ce=Math.pow(2,le),he="number"==typeof this._targetZoom?C.zoomScale(this._targetZoom):ce;this._targetZoom=Math.min(C.maxZoom,Math.max(C.minZoom,C.scaleZoom(he*te))),"wheel"===this._type&&(this._startZoom=le,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}const H="number"==typeof this._targetZoom?this._targetZoom:t(),te=this._startZoom,le=this._easing;let ce,he=!1;if("wheel"===this._type&&te&&le){const C=Math.min((yi.now()-this._lastWheelEventTime)/200,1);ce=Wr(te,H,le(C)),C<1?this._frameId||(this._frameId=!0):he=!0}else ce=H,he=!0;this._active=!0,he&&(this._active=!1,this._finishTimeout=setTimeout((()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout}),200));let ue=ce-t();return ue*this._lastDelta<0&&(ue=0),{noInertia:!0,needsRenderFrame:!he,zoomDelta:ue,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(C){let H=qe;if(this._prevEase){const C=this._prevEase,te=(yi.now()-C.start)/C.duration,le=C.easing(te+.01)-C.easing(te),ce=.27/Math.sqrt(le*le+1e-4)*.01;H=I(ce,Math.sqrt(.0729-ce*ce),.25,1)}return this._prevEase={start:yi.now(),duration:C,easing:H},H}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=ut("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(te.navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout((()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","null")}),200)}}class RS{constructor(C,H){this._clickZoom=C,this._tapZoom=H}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class LS{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(C,H){return C.preventDefault(),{cameraAnimation:te=>{te.easeTo({duration:300,zoom:te.getZoom()+(C.shiftKey?-1:1),around:te.unproject(H)},{originalEvent:C})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class kS{constructor(){this._tap=new dS({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(C,H,te){this._swipePoint||(this._tapTime&&C.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?te.length>0&&(this._swipePoint=H[0],this._swipeTouch=te[0].identifier):this._tap.touchstart(C,H,te))}touchmove(C,H,te){if(this._tapTime){if(this._swipePoint){if(te[0].identifier!==this._swipeTouch)return;const le=H[0],ce=le.y-this._swipePoint.y;return this._swipePoint=le,C.preventDefault(),this._active=!0,{zoomDelta:ce/128}}}else this._tap.touchmove(C,H,te)}touchend(C,H,te){this._tapTime?this._swipePoint&&0===te.length&&this.reset():this._tap.touchend(C,H,te)&&(this._tapTime=C.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class OS{constructor(C,H,te){this._el=C,this._mousePan=H,this._touchPan=te}enable(C){this._inertiaOptions=C||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class BS{constructor(C,H,te){this._pitchWithRotate=C.pitchWithRotate,this._mouseRotate=H,this._mousePitch=te}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class FS{constructor(C,H,te,le){this._el=C,this._touchZoom=H,this._touchRotate=te,this._tapDragZoom=le,this._rotationDisabled=!1,this._enabled=!0}enable(C){this._touchZoom.enable(C),this._rotationDisabled||this._touchRotate.enable(C),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const NS=C=>C.zoom||C.drag||C.pitch||C.rotate;class US extends At{}class VS{constructor(){this.constants=[1,1,.01],this.radius=0}setup(C,H){const te=Ld.sub([],H,C);this.radius=Ld.length(te[2]<0?Ld.div([],te,this.constants):[te[0],te[1],0])}projectRay(C){Ld.div(C,C,this.constants),Ld.normalize(C,C),Ld.mul(C,C,this.constants);const H=Ld.scale([],C,this.radius);if(H[2]>0){const C=Ld.scale([],[0,0,1],Ld.dot(H,[0,0,1])),te=Ld.scale([],Ld.normalize([],[H[0],H[1],0]),this.radius),le=Ld.add([],H,Ld.scale([],Ld.sub([],Ld.add([],te,C),H),2));H[0]=le[0],H[1]=le[1]}return H}}function jS(C){return C.panDelta&&C.panDelta.mag()||C.zoomDelta||C.bearingDelta||C.pitchDelta}class GS{constructor(C,H){this._map=C,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new tS(C),this._bearingSnap=H.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new VS,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(H),j(["handleEvent","handleWindowEvent"],this);const le=this._el;this._listeners=[[le,"touchstart",{passive:!0}],[le,"touchmove",{passive:!1}],[le,"touchend",void 0],[le,"touchcancel",void 0],[le,"mousedown",void 0],[le,"mousemove",void 0],[le,"mouseup",void 0],[te.document,"mousemove",{capture:!0}],[te.document,"mouseup",void 0],[le,"mouseover",void 0],[le,"mouseout",void 0],[le,"dblclick",void 0],[le,"click",void 0],[le,"keydown",{capture:!1}],[le,"keyup",void 0],[le,"wheel",{passive:!1}],[le,"contextmenu",void 0],[te,"blur",void 0]];for(const[C,H,le]of this._listeners)C.addEventListener(H,C===te.document?this.handleWindowEvent:this.handleEvent,le)}destroy(){for(const[C,H,le]of this._listeners)C.removeEventListener(H,C===te.document?this.handleWindowEvent:this.handleEvent,le)}_addDefaultHandlers(C){const H=this._map,te=H.getCanvasContainer();this._add("mapEvent",new aS(H,C));const le=H.boxZoom=new cS(H,C);this._add("boxZoom",le);const ce=new pS,he=new LS;H.doubleClickZoom=new RS(he,ce),this._add("tapZoom",ce),this._add("clickZoom",he);const ue=new kS;this._add("tapDragZoom",ue);const de=H.touchPitch=new SS(H);this._add("touchPitch",de);const _e=new gS(C),ye=new yS(C);H.dragRotate=new BS(C,_e,ye),this._add("mouseRotate",_e,["mousePitch"]),this._add("mousePitch",ye,["mouseRotate"]);const ve=new _S(C),Me=new xS(H,C);H.dragPan=new OS(te,ve,Me),this._add("mousePan",ve),this._add("touchPan",Me,["touchZoom","touchRotate"]);const Se=new MS,Ae=new TS;H.touchZoomRotate=new FS(te,Ae,Se,ue),this._add("touchRotate",Se,["touchPan","touchZoom"]),this._add("touchZoom",Ae,["touchPan","touchRotate"]),this._add("blockableMapEvent",new lS(H));const Ce=H.scrollZoom=new PS(H,this);this._add("scrollZoom",Ce,["mousePan"]);const Oe=H.keyboard=new CS;this._add("keyboard",Oe);for(const te of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])C.interactive&&C[te]&&H[te].enable(C[te])}_add(C,H,te){this._handlers.push({handlerName:C,handler:H,allowed:te}),this._handlersById[C]=H}stop(C){if(!this._updatingCamera){for(const{handler:C}of this._handlers)C.reset();this._inertia.clear(),this._fireEvents({},{},C),this._changes=[],this._originalZoom=void 0}}isActive(){for(const{handler:C}of this._handlers)if(C.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!NS(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(C,H,te){for(const le in C)if(le!==te&&(!H||H.indexOf(le)<0))return!0;return!1}handleWindowEvent(C){this.handleEvent(C,`${C.type}Window`)}_getMapTouches(C){const H=[];for(const te of C)this._el.contains(te.target)&&H.push(te);return H}handleEvent(C,H){this._updatingCamera=!0;const te="renderFrame"===C.type,le=te?void 0:C,ce={needsRenderFrame:!1},he={},ue={},de=C.touches?this._getMapTouches(C.touches):void 0,_e=de?bt(this._el,de):te?void 0:vt(this._el,C);for(const{handlerName:te,handler:ye,allowed:ve}of this._handlers){if(!ye.isEnabled())continue;let Me;this._blockedByActive(ue,ve,te)?ye.reset():ye[H||C.type]&&(Me=ye[H||C.type](C,_e,de),this.mergeHandlerResult(ce,he,Me,te,le),Me&&Me.needsRenderFrame&&this._triggerRenderFrame()),(Me||ye.isActive())&&(ue[te]=ye)}const ye={};for(const C in this._previousActiveHandlers)ue[C]||(ye[C]=le);this._previousActiveHandlers=ue,(Object.keys(ye).length||jS(ce))&&(this._changes.push([ce,he,ye]),this._triggerRenderFrame()),(Object.keys(ue).length||jS(ce))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:ve}=ce;ve&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],ve(this._map))}mergeHandlerResult(C,H,te,le,ce){if(!te)return;k(C,te);const he={handlerName:le,originalEvent:te.originalEvent||ce};void 0!==te.zoomDelta&&(H.zoom=he),void 0!==te.panDelta&&(H.drag=he),void 0!==te.pitchDelta&&(H.pitch=he),void 0!==te.bearingDelta&&(H.rotate=he)}_applyChanges(){const C={},H={},te={};for(const[le,ce,he]of this._changes)le.panDelta&&(C.panDelta=(C.panDelta||new Ne(0,0))._add(le.panDelta)),le.zoomDelta&&(C.zoomDelta=(C.zoomDelta||0)+le.zoomDelta),le.bearingDelta&&(C.bearingDelta=(C.bearingDelta||0)+le.bearingDelta),le.pitchDelta&&(C.pitchDelta=(C.pitchDelta||0)+le.pitchDelta),void 0!==le.around&&(C.around=le.around),void 0!==le.aroundCoord&&(C.aroundCoord=le.aroundCoord),void 0!==le.pinchAround&&(C.pinchAround=le.pinchAround),le.noInertia&&(C.noInertia=le.noInertia),k(H,ce),k(te,he);this._updateMapTransform(C,H,te),this._changes=[]}_updateMapTransform(C,H,te){const le=this._map,ce=le.transform,o=C=>[C.x,C.y,C.z];if((C=>{const H=this._eventsInProgress.drag;return H&&!this._handlersById[H.handlerName].isActive()})()&&!jS(C)){const C=ce.zoom;ce.cameraElevationReference="sea",null!=this._originalZoom&&ce._orthographicProjectionAtLowPitch&&"globe"!==ce.projection.name&&0===ce.pitch?(ce.cameraElevationReference="ground",ce.zoom=this._originalZoom):(ce.recenterOnTerrain(),ce.cameraElevationReference="ground"),C!==ce.zoom&&this._map._update(!0)}if(ce._isCameraConstrained&&le._stop(!0),!jS(C))return void this._fireEvents(H,te,!0);let{panDelta:he,zoomDelta:ue,bearingDelta:de,pitchDelta:_e,around:ye,aroundCoord:ve,pinchAround:Me}=C;ce._isCameraConstrained&&(ue>0&&(ue=0),ce._isCameraConstrained=!1),void 0!==Me&&(ye=Me),(ue||(C=>H[C]&&!this._eventsInProgress[C])("drag"))&&ye&&(this._dragOrigin=o(ce.pointCoordinate3D(ye)),this._originalZoom=ce.zoom,this._trackingEllipsoid.setup(ce._camera.position,this._dragOrigin)),ce.cameraElevationReference="sea",le._stop(!0),ye=ye||le.transform.centerPoint,de&&(ce.bearing+=de),_e&&(ce.pitch+=_e),ce._updateCameraState();const Se=[0,0,0];if(he)if("mercator"===ce.projection.name){const C=this._trackingEllipsoid.projectRay(ce.screenPointToMercatorRay(ye).dir),H=this._trackingEllipsoid.projectRay(ce.screenPointToMercatorRay(ye.sub(he)).dir);Se[0]=H[0]-C[0],Se[1]=H[1]-C[1]}else{const C=ce.pointCoordinate(ye);if("globe"===ce.projection.name){he=he.rotate(-ce.angle);const H=ce._pixelsPerMercatorPixel/ce.worldSize;Se[0]=-he.x*Jd(Hd(C.y))*H,Se[1]=-he.y*Jd(ce.center.lat)*H}else{const H=ce.pointCoordinate(ye.sub(he));C&&H&&(Se[0]=H.x-C.x,Se[1]=H.y-C.y)}}const Ae=ce.zoom,Ce=[0,0,0];if(ue){const C=o(ve||ce.pointCoordinate3D(ye)),H={dir:Ld.normalize([],Ld.sub([],C,ce._camera.position))};if(H.dir[2]<0){const te=ce.zoomDeltaToMovement(C,ue);Ld.scale(Ce,H.dir,te)}}const Oe=Ld.add(Se,Se,Ce);ce._translateCameraConstrained(Oe),ue&&Math.abs(ce.zoom-Ae)>1e-4&&ce.recenterOnTerrain(),ce.cameraElevationReference="ground",this._map._update(),C.noInertia||this._inertia.record(C),this._fireEvents(H,te,!0)}_fireEvents(C,H,te){const le=NS(this._eventsInProgress),ce=NS(C),he={};for(const H in C){const{originalEvent:te}=C[H];this._eventsInProgress[H]||(he[`${H}start`]=te),this._eventsInProgress[H]=C[H]}!le&&ce&&this._fireEvent("movestart",ce.originalEvent);for(const C in he)this._fireEvent(C,he[C]);ce&&this._fireEvent("move",ce.originalEvent);for(const H in C){const{originalEvent:te}=C[H];this._fireEvent(H,te)}const ue={};let de;for(const C in this._eventsInProgress){const{handlerName:te,originalEvent:le}=this._eventsInProgress[C];this._handlersById[te].isActive()||(delete this._eventsInProgress[C],de=H[te]||le,ue[`${C}end`]=de)}for(const C in ue)this._fireEvent(C,ue[C]);const _e=NS(this._eventsInProgress);if(te&&(le||ce)&&!_e){this._updatingCamera=!0;const C=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),t=C=>0!==C&&-this._bearingSnap<C&&C<this._bearingSnap;C?(t(C.bearing||this._map.getBearing())&&(C.bearing=0),this._map.easeTo(C,{originalEvent:de})):(this._map.fire(new At("moveend",{originalEvent:de})),t(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(C,H){this._map.fire(new At(C,H?{originalEvent:H}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add((C=>{this._frameId=void 0,this.handleEvent(new US("renderFrame",{timeStamp:C})),this._applyChanges()}))}_triggerRenderFrame(){void 0===this._frameId&&(this._frameId=this._requestFrame())}}const vI="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class ZS extends It{constructor(C,H){super(),this._moving=!1,this._zooming=!1,this.transform=C,this._bearingSnap=H.bearingSnap,this._respectPrefersReducedMotion=!1!==H.respectPrefersReducedMotion,j(["_renderFrameCallback"],this)}getCenter(){return new Of(this.transform.center.lng,this.transform.center.lat)}setCenter(C,H){return this.jumpTo({center:C},H)}panBy(C,H,te){return C=Ne.convert(C).mult(-1),this.panTo(this.transform.center,k({offset:C},H),te)}panTo(C,H,te){return this.easeTo(k({center:C},H),te)}getZoom(){return this.transform.zoom}setZoom(C,H){return this.jumpTo({zoom:C},H),this}zoomTo(C,H,te){return this.easeTo(k({zoom:C},H),te)}zoomIn(C,H){return this.zoomTo(this.getZoom()+1,C,H),this}zoomOut(C,H){return this.zoomTo(this.getZoom()-1,C,H),this}getBearing(){return this.transform.bearing}setBearing(C,H){return this.jumpTo({bearing:C},H),this}getPadding(){return this.transform.padding}setPadding(C,H){return this.jumpTo({padding:C},H),this}rotateTo(C,H,te){return this.easeTo(k({bearing:C},H),te)}resetNorth(C,H){return this.rotateTo(0,k({duration:1e3},C),H),this}resetNorthPitch(C,H){return this.easeTo(k({bearing:0,pitch:0,duration:1e3},C),H),this}snapToNorth(C,H){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(C,H):this}getPitch(){return this.transform.pitch}setPitch(C,H){return this.jumpTo({pitch:C},H),this}cameraForBounds(C,H){C=Ql.convert(C);const te=H&&H.bearing||0,le=H&&H.pitch||0,ce=C.getNorthWest(),he=C.getSouthEast();return this._cameraForBounds(this.transform,ce,he,te,le,H)}_extendCameraOptions(C){const H={top:0,bottom:0,right:0,left:0};if("number"==typeof(C=k({padding:H,offset:[0,0],maxZoom:this.transform.maxZoom},C)).padding){const H=C.padding;C.padding={top:H,bottom:H,right:H,left:H}}return C.padding=k(H,C.padding),C}_minimumAABBFrustumDistance(C,H){const te=H.max[0]-H.min[0],le=H.max[1]-H.min[1];return te/le>C.aspect?te/(2*Math.tan(.5*C.fovX)*C.aspect):le/(2*Math.tan(.5*C.fovY)*C.aspect)}_cameraForBoundsOnGlobe(C,H,te,le,ce,he){const ue=C.clone(),de=this._extendCameraOptions(he);ue.bearing=le,ue.pitch=ce;const _e=Of.convert(H),ye=Of.convert(te),ve=.5*(_e.lat+ye.lat),Me=.5*(_e.lng+ye.lng),Se=md(ve,Me),Ae=Ld.normalize([],Se),Ce=Ld.normalize([],Ld.cross([],Ae,[0,1,0])),Oe=Ld.cross([],Ce,Ae),Ne=[Ce[0],Ce[1],Ce[2],0,Oe[0],Oe[1],Oe[2],0,Ae[0],Ae[1],Ae[2],0,0,0,0,1],je=[Se,md(_e.lat,_e.lng),md(ye.lat,_e.lng),md(ye.lat,ye.lng),md(_e.lat,ye.lng),md(ve,_e.lng),md(ve,ye.lng),md(_e.lat,Me),md(ye.lat,Me)];let Ge=Hu.fromPoints(je.map((C=>[Ld.dot(Ce,C),Ld.dot(Oe,C),Ld.dot(Ae,C)])));const Ze=Ld.transformMat4([],Ge.center,Ne);0===Ld.squaredLength(Ze)&&Ld.set(Ze,0,0,1),Ld.normalize(Ze,Ze),Ld.scale(Ze,Ze,Rp),ue.center=function([C,H,te]){const le=Math.hypot(C,H,te),ce=Math.atan2(C,te),he=.5*Math.PI-Math.acos(-H/le);return new Of(T(ce),T(he))}(Ze);const qe=ue.getWorldToCameraMatrix(),$e=ed.invert(new Float64Array(16),qe);Ge=Hu.applyTransform(Ge,ed.multiply([],qe,Ne)),Ld.transformMat4(Ze,Ze,qe);const We=.5*(Ge.max[2]-Ge.min[2]),He=this._minimumAABBFrustumDistance(ue,Ge),Xe=Ld.scale([],[0,0,1],We),Ye=Ld.add(Xe,Ze,Xe),Je=He+(0===ue.pitch?0:Ld.distance(Ze,Ye)),Qe=ue.globeCenterInViewSpace,tt=Ld.sub([],Ze,[Qe[0],Qe[1],Qe[2]]);Ld.normalize(tt,tt),Ld.scale(tt,tt,Je);const rt=Ld.add([],Ze,tt);Ld.transformMat4(rt,rt,$e);const ot=kf/Rp,st=Ld.length(rt),at=Zd(Math.max(st*ot-kf,Number.EPSILON),0),lt=Math.min(ue.zoomFromMercatorZAdjusted(at),de.maxZoom);return lt>.5*(Dp+Pp)?(ue.setProjection({name:"mercator"}),ue.zoom=lt,this._cameraForBounds(ue,H,te,le,ce,he)):{center:ue.center,zoom:lt,bearing:le,pitch:ce}}queryTerrainElevation(C,H){const te=this.transform.elevation;return te?(H=k({},{exaggerated:!0},H),te.getAtPoint(ep.fromLngLat(C),null,H.exaggerated)):null}_cameraForBounds(C,H,te,le,ce,he){if("globe"===C.projection.name)return this._cameraForBoundsOnGlobe(C,H,te,le,ce,he);const ue=C.clone(),de=this._extendCameraOptions(he),_e=ue.padding;ue.bearing=le,ue.pitch=ce;const ye=Of.convert(H),ve=Of.convert(te),Me=new Of(ye.lng,ve.lat),Se=new Of(ve.lng,ye.lat),Ae=ue.project(ye),Ce=ue.project(ve),Oe=this.queryTerrainElevation(ye),je=this.queryTerrainElevation(ve),Ge=this.queryTerrainElevation(Me),Ze=this.queryTerrainElevation(Se),qe=[[Ae.x,Ae.y,Math.min(Oe||0,je||0,Ge||0,Ze||0)],[Ce.x,Ce.y,Math.max(Oe||0,je||0,Ge||0,Ze||0)]];let $e=Hu.fromPoints(qe);const We=ue.getWorldToCameraMatrix(),He=ed.invert(new Float64Array(16),We);$e=Hu.applyTransform($e,We);const Xe=Ld.sub([],$e.max,$e.min),Ye=_e.left||0,Je=_e.right||0,Qe=_e.bottom||0,tt=_e.top||0,{left:rt,right:ot,top:st,bottom:at}=de.padding,lt=.5*(Ye+Je),ct=.5*(tt+Qe),ht=Math.min(ue.scaleZoom(ue.scale*Math.min((ue.width-(Ye+Je+rt+ot))/Xe[0],(ue.height-(Qe+tt+at+st))/Xe[1])),de.maxZoom),pt=ue.scale/ue.zoomScale(ht);$e=new Hu([$e.min[0]-(rt+lt)*pt,$e.min[1]-(at+ct)*pt,$e.min[2]],[$e.max[0]+(ot+lt)*pt,$e.max[1]+(st+ct)*pt,$e.max[2]]);const ft=.5*Xe[2],mt=this._minimumAABBFrustumDistance(ue,$e),Ct=[0,0,1,0];Lu.transformMat4(Ct,Ct,We),Lu.normalize(Ct,Ct);const Ot=Ld.scale([],Ct,mt+ft),Ft=Ld.add([],$e.center,Ot),Nt=("number"==typeof de.offset.x&&"number"==typeof de.offset.y?new Ne(de.offset.x,de.offset.y):Ne.convert(de.offset)).rotate(-w(le));$e.center[0]-=Nt.x*pt,$e.center[1]+=Nt.y*pt,Ld.transformMat4($e.center,$e.center,He),Ld.transformMat4(Ft,Ft,He);const Ut=[$e.center[0],$e.center[1],Ft[2]*ue.pixelsPerMeter];Ld.scale(Ut,Ut,1/ue.worldSize);const Vt=$d(Ut[0]),jt=Hd(Ut[1]),Gt=Math.min(ue._zoomFromMercatorZ(Ut[2]),de.maxZoom),Zt=new Of(Vt,jt);return ue.mercatorFromTransition&&Gt<.5*(Dp+Pp)?(ue.setProjection({name:"globe"}),ue.zoom=Gt,this._cameraForBounds(ue,H,te,le,ce,he)):{center:Zt,zoom:Gt,bearing:le,pitch:ce}}fitBounds(C,H,te){const le=this.cameraForBounds(C,H);return this._fitInternal(le,H,te)}fitScreenCoordinates(C,H,te,le,ce){const he=Ne.convert(C),ue=Ne.convert(H),de=new Ne(Math.min(he.x,ue.x),Math.min(he.y,ue.y)),_e=new Ne(Math.max(he.x,ue.x),Math.max(he.y,ue.y));if("mercator"===this.transform.projection.name&&this.transform.anyCornerOffEdge(he,ue))return this;const ye=this.transform.pointLocation3D(de),ve=this.transform.pointLocation3D(_e),Me=this.transform.pointLocation3D(new Ne(de.x,_e.y)),Se=this.transform.pointLocation3D(new Ne(_e.x,de.y)),Ae=[Math.min(ye.lng,ve.lng,Me.lng,Se.lng),Math.min(ye.lat,ve.lat,Me.lat,Se.lat)],Ce=[Math.max(ye.lng,ve.lng,Me.lng,Se.lng),Math.max(ye.lat,ve.lat,Me.lat,Se.lat)],Oe=le&&le.pitch?le.pitch:this.getPitch(),je=this._cameraForBounds(this.transform,Ae,Ce,te,Oe,le);return this._fitInternal(je,le,ce)}_fitInternal(C,H,te){return C?(delete(H=k(C,H)).padding,H.linear?this.easeTo(H,te):this.flyTo(H,te)):this}jumpTo(C,H){this.stop();const te=C.preloadOnly?this.transform.clone():this.transform;let le=!1,ce=!1,he=!1;return"zoom"in C&&te.zoom!==+C.zoom&&(le=!0,te.zoom=+C.zoom),void 0!==C.center&&(te.center=Of.convert(C.center)),"bearing"in C&&te.bearing!==+C.bearing&&(ce=!0,te.bearing=+C.bearing),"pitch"in C&&te.pitch!==+C.pitch&&(he=!0,te.pitch=+C.pitch),null==C.padding||te.isPaddingEqual(C.padding)||(te.padding=C.padding),C.preloadOnly?(this._preloadTiles(te),this):(this.fire(new At("movestart",H)).fire(new At("move",H)),le&&this.fire(new At("zoomstart",H)).fire(new At("zoom",H)).fire(new At("zoomend",H)),ce&&this.fire(new At("rotatestart",H)).fire(new At("rotate",H)).fire(new At("rotateend",H)),he&&this.fire(new At("pitchstart",H)).fire(new At("pitch",H)).fire(new At("pitchend",H)),this.fire(new At("moveend",H)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||W(vI),this.transform.getFreeCameraOptions()}setFreeCameraOptions(C,H){const te=this.transform;if(!te.projection.supportsFreeCamera)return W(vI),this;this.stop();const le=te.zoom,ce=te.pitch,he=te.bearing;te.setFreeCameraOptions(C);const ue=le!==te.zoom,de=ce!==te.pitch,_e=he!==te.bearing;return this.fire(new At("movestart",H)).fire(new At("move",H)),ue&&this.fire(new At("zoomstart",H)).fire(new At("zoom",H)).fire(new At("zoomend",H)),_e&&this.fire(new At("rotatestart",H)).fire(new At("rotate",H)).fire(new At("rotateend",H)),de&&this.fire(new At("pitchstart",H)).fire(new At("pitch",H)).fire(new At("pitchend",H)),this.fire(new At("moveend",H)),this}easeTo(C,H){this._stop(!1,C.easeId),(!1===(C=k({offset:[0,0],duration:500,easing:qe},C)).animate||this._prefersReducedMotion(C))&&(C.duration=0);const te=this.transform,le=this.getZoom(),ce=this.getBearing(),he=this.getPitch(),ue=this.getPadding(),de="zoom"in C?+C.zoom:le,_e="bearing"in C?this._normalizeBearing(C.bearing,ce):ce,ye="pitch"in C?+C.pitch:he,ve="padding"in C?C.padding:te.padding,Me=Ne.convert(C.offset);let Se,Ae,Ce;if("globe"===te.projection.name){const H=ep.fromLngLat(te.center),le=Me.rotate(-te.angle);H.x+=le.x/te.worldSize,H.y+=le.y/te.worldSize;const ce=H.toLngLat(),he=Of.convert(C.center||ce);this._normalizeCenter(he),Se=te.centerPoint.add(le),Ae=new Ne(H.x,H.y).mult(te.worldSize),Ce=new Ne(Gd(he.lng),qd(he.lat)).mult(te.worldSize).sub(Ae)}else{Se=te.centerPoint.add(Me);const H=te.pointLocation(Se),le=Of.convert(C.center||H);this._normalizeCenter(le),Ae=te.project(H),Ce=te.project(le).sub(Ae)}const Oe=te.zoomScale(de-le);let je,Ge;C.around&&(je=Of.convert(C.around),Ge=te.locationPoint(je));const Ze=this._zooming||de!==le,$e=this._rotating||ce!==_e,We=this._pitching||ye!==he,He=!te.isPaddingEqual(ve),T=te=>Ne=>{if(Ze&&(te.zoom=Wr(le,de,Ne)),$e&&(te.bearing=Wr(ce,_e,Ne)),We&&(te.pitch=Wr(he,ye,Ne)),He&&(te.interpolatePadding(ue,ve,Ne),Se=te.centerPoint.add(Me)),je)te.setLocationAtPoint(je,Ge);else{const C=te.zoomScale(te.zoom-le),H=de>le?Math.min(2,Oe):Math.max(.5,Oe),ce=Math.pow(H,1-Ne),he=te.unproject(Ae.add(Ce.mult(Ne*ce)).mult(C));te.setLocationAtPoint(te.renderWorldCopies?he.wrap():he,Se)}return C.preloadOnly||this._fireMoveEvents(H),te};if(C.preloadOnly){const H=this._emulate(T,C.duration,te);return this._preloadTiles(H),this}const Xe={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=Ze,this._rotating=$e,this._pitching=We,this._padding=He,this._easeId=C.easeId,this._prepareEase(H,C.noMoveStart,Xe),this._ease(T(te),(C=>{"sea"===te.cameraElevationReference&&te.recenterOnTerrain(),this._afterEase(H,C)}),C),this}_prepareEase(C,H,te={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&0===this.transform.pitch&&"globe"!==this.transform.projection.name&&(this.transform.cameraElevationReference="ground"),H||te.moving||this.fire(new At("movestart",C)),this._zooming&&!te.zooming&&this.fire(new At("zoomstart",C)),this._rotating&&!te.rotating&&this.fire(new At("rotatestart",C)),this._pitching&&!te.pitching&&this.fire(new At("pitchstart",C))}_fireMoveEvents(C){this.fire(new At("move",C)),this._zooming&&this.fire(new At("zoom",C)),this._rotating&&this.fire(new At("rotate",C)),this._pitching&&this.fire(new At("pitch",C))}_afterEase(C,H){if(this._easeId&&H&&this._easeId===H)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const te=this._zooming,le=this._rotating,ce=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,te&&this.fire(new At("zoomend",C)),le&&this.fire(new At("rotateend",C)),ce&&this.fire(new At("pitchend",C)),this.fire(new At("moveend",C))}flyTo(C,H){if(this._prefersReducedMotion(C)){const te=O(C,["center","zoom","bearing","pitch","around"]);return this.jumpTo(te,H)}this.stop(),C=k({offset:[0,0],speed:1.2,curve:1.42,easing:qe},C);const te=this.transform,le=this.getZoom(),ce=this.getBearing(),he=this.getPitch(),ue=this.getPadding(),de="zoom"in C?z(+C.zoom,te.minZoom,te.maxZoom):le,_e="bearing"in C?this._normalizeBearing(C.bearing,ce):ce,ye="pitch"in C?+C.pitch:he,ve="padding"in C?C.padding:te.padding,Me=te.zoomScale(de-le),Se=Ne.convert(C.offset);let Ae=te.centerPoint.add(Se);const Ce=te.pointLocation(Ae),Oe=Of.convert(C.center||Ce);this._normalizeCenter(Oe);const je=te.project(Ce),Ge=te.project(Oe).sub(je);let Ze=C.curve;const $e=Math.max(te.width,te.height),We=$e/Me,He=Ge.mag();if("minZoom"in C){const H=z(Math.min(C.minZoom,le,de),te.minZoom,te.maxZoom),ce=$e/te.zoomScale(H-le);Ze=Math.sqrt(ce/He*2)}const Xe=Ze*Ze;function E(C){const H=(We*We-$e*$e+(C?-1:1)*Xe*Xe*He*He)/(2*(C?We:$e)*Xe*He);return Math.log(Math.sqrt(H*H+1)-H)}function M(C){return(Math.exp(C)-Math.exp(-C))/2}function A(C){return(Math.exp(C)+Math.exp(-C))/2}const Ye=E(0);let I=function(C){return A(Ye)/A(Ye+Ze*C)},D=function(C){return $e*((A(Ye)*(M(H=Ye+Ze*C)/A(H))-M(Ye))/Xe)/He;var H},Je=(E(1)-Ye)/Ze;if(Math.abs(He)<1e-6||!isFinite(Je)){if(Math.abs($e-We)<1e-6)return this.easeTo(C,H);const te=We<$e?-1:1;Je=Math.abs(Math.log(We/$e))/Ze,D=function(){return 0},I=function(C){return Math.exp(te*Ze*C)}}C.duration="duration"in C?+C.duration:1e3*Je/("screenSpeed"in C?+C.screenSpeed/Ze:+C.speed),C.maxDuration&&C.duration>C.maxDuration&&(C.duration=0);const Qe=ce!==_e,tt=ye!==he,rt=!te.isPaddingEqual(ve),F=te=>Me=>{const Ce=Me*Je,Ne=1/I(Ce);te.zoom=1===Me?de:le+te.scaleZoom(Ne),Qe&&(te.bearing=Wr(ce,_e,Me)),tt&&(te.pitch=Wr(he,ye,Me)),rt&&(te.interpolatePadding(ue,ve,Me),Ae=te.centerPoint.add(Se));const Ze=1===Me?Oe:te.unproject(je.add(Ge.mult(D(Ce))).mult(Ne));return te.setLocationAtPoint(te.renderWorldCopies?Ze.wrap():Ze,Ae),te._updateCameraOnTerrain(),C.preloadOnly||this._fireMoveEvents(H),te};if(C.preloadOnly){const H=this._emulate(F,C.duration,te);return this._preloadTiles(H),this}return this._zooming=!0,this._rotating=Qe,this._pitching=tt,this._padding=rt,this._prepareEase(H,!1),this._ease(F(te),(()=>this._afterEase(H)),C),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(C,H){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const C=this._onEaseEnd;this._onEaseEnd=void 0,C.call(this,H)}if(!C){const C=this.handlers;C&&C.stop(!1)}return this}_ease(C,H,te){!1===te.animate||0===te.duration?(C(1),H()):(this._easeStart=yi.now(),this._easeOptions=te,this._onEaseFrame=C,this._onEaseEnd=H,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const C=Math.min((yi.now()-this._easeStart)/this._easeOptions.duration,1),H=this._onEaseFrame;H&&H(this._easeOptions.easing(C)),C<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(C,H){C=P(C,-180,180);const te=Math.abs(C-H);return Math.abs(C-360-H)<te&&(C-=360),Math.abs(C+360-H)<te&&(C+=360),C}_normalizeCenter(C){const H=this.transform;if(!H.renderWorldCopies||H.maxBounds)return;const te=C.lng-H.center.lng;C.lng+=te>180?-360:te<-180?360:0}_prefersReducedMotion(C){return this._respectPrefersReducedMotion&&yi.prefersReducedMotion&&!(C&&C.essential)}_emulate(C,H,te){const le=Math.ceil(15*H/1e3),ce=[],he=C(te.clone());for(let C=0;C<=le;C++){const H=he(C/le);ce.push(H.clone())}return ce}}class $S{constructor(C={}){this.options=C,j(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(C){const H=this.options&&this.options.compact;return this._map=C,this._container=ut("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=ut("button","mapboxgl-ctrl-attrib-button",this._container),ut("span","mapboxgl-ctrl-icon",this._compactButton).setAttribute("aria-hidden","true"),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=ut("div","mapboxgl-ctrl-attrib-inner",this._container),H&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),void 0===H&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_setElementTitle(C,H){const te=this._map._getUIString(`AttributionControl.${H}`);C.setAttribute("aria-label",te),C.removeAttribute("title"),C.firstElementChild&&C.firstElementChild.setAttribute("title",te)}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let C=this._editLink;C||(C=this._editLink=this._container.querySelector(".mapbox-improve-map"));const H=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||ue.ACCESS_TOKEN}];if(C){const te=H.reduce(((C,te,le)=>(te.value&&(C+=`${te.key}=${te.value}${le<H.length-1?"&":""}`),C)),"?");C.href=`${ue.FEEDBACK_URL}/${te}#${XA(this._map,!0)}`,C.rel="noopener nofollow",this._setElementTitle(C,"MapFeedback")}}_updateData(C){!C||"metadata"!==C.sourceDataType&&"visibility"!==C.sourceDataType&&"style"!==C.dataType||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let C=[];if(this._map.style.stylesheet){const C=this._map.style.stylesheet;this.styleOwner=C.owner,this.styleId=C.id}const H=this._map.style._mergedSourceCaches;for(const te in H){const le=H[te];if(le.used){const H=le.getSource();H.attribution&&C.indexOf(H.attribution)<0&&C.push(H.attribution)}}C.sort(((C,H)=>C.length-H.length)),C=C.filter(((H,te)=>{for(let le=te+1;le<C.length;le++)if(C[le].indexOf(H)>=0)return!1;return!0})),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?C=[...this.options.customAttribution,...C]:C.unshift(this.options.customAttribution));const te=C.join(" | ");te!==this._attribHTML&&(this._attribHTML=te,C.length?(this._innerContainer.innerHTML=te,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class HS{constructor(){j(["_updateLogo","_updateCompact"],this)}onAdd(C){this._map=C,this._container=ut("div","mapboxgl-ctrl");const H=ut("a","mapboxgl-ctrl-logo");return H.target="_blank",H.rel="noopener nofollow",H.href="https://www.mapbox.com/",H.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),H.setAttribute("rel","noopener nofollow"),this._container.appendChild(H),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(C){C&&"metadata"!==C.sourceDataType||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const C=this._map.style._sourceCaches;if(0===Object.entries(C).length)return!0;for(const H in C){const te=C[H].getSource();if(te.hasOwnProperty("mapbox_logo")&&!te.mapbox_logo)return!1}return!0}_updateCompact(){const C=this._container.children;if(C.length){const H=C[0];this._map.getCanvasContainer().offsetWidth<250?H.classList.add("mapboxgl-compact"):H.classList.remove("mapboxgl-compact")}}}class WS{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(C){const H=++this._id;return this._queue.push({callback:C,id:H,cancelled:!1}),H}remove(C){const H=this._currentlyRunning,te=H?this._queue.concat(H):this._queue;for(const H of te)if(H.id===C)return void(H.cancelled=!0)}run(C=0){const H=this._currentlyRunning=this._queue;this._queue=[];for(const te of H)if(!te.cancelled&&(te.callback(C),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}function XS(C,H,te){if(C=new Of(C.lng,C.lat),H){const le=new Of(C.lng-360,C.lat),ce=new Of(C.lng+360,C.lat),he=360*Math.ceil(Math.abs(C.lng-te.center.lng)/360),ue=te.locationPoint(C).distSqr(H),de=H.x<0||H.y<0||H.x>te.width||H.y>te.height;te.locationPoint(le).distSqr(H)<ue&&(de||Math.abs(le.lng-te.center.lng)<he)?C=le:te.locationPoint(ce).distSqr(H)<ue&&(de||Math.abs(ce.lng-te.center.lng)<he)&&(C=ce)}for(;Math.abs(C.lng-te.center.lng)>180;){const H=te.locationPoint(C);if(H.x>=0&&H.y>=0&&H.x<=te.width&&H.y<=te.height)break;C.lng>te.center.lng?C.lng-=360:C.lng+=360}return C}const bI={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};class KS extends It{constructor(C,H){if(super(),(C instanceof te.HTMLElement||H)&&(C=k({element:C},H)),j(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this),this._anchor=C&&C.anchor||"center",this._color=C&&C.color||"#3FB1CE",this._scale=C&&C.scale||1,this._draggable=C&&C.draggable||!1,this._clickTolerance=C&&C.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=C&&C.rotation||0,this._rotationAlignment=C&&C.rotationAlignment||"auto",this._pitchAlignment=C&&C.pitchAlignment&&C.pitchAlignment||"auto",this._updateMoving=()=>this._update(!0),this._occludedOpacity=C&&C.occludedOpacity||.2,C&&C.element)this._element=C.element,this._offset=Ne.convert(C&&C.offset||[0,0]);else{this._defaultMarker=!0,this._element=ut("div");const H=41,te=27,le=dt("svg",{display:"block",height:H*this._scale+"px",width:te*this._scale+"px",viewBox:`0 0 ${te} ${H}`},this._element),ce=dt("radialGradient",{id:"shadowGradient"},dt("defs",{},le));dt("stop",{offset:"10%","stop-opacity":.4},ce),dt("stop",{offset:"100%","stop-opacity":.05},ce),dt("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},le),dt("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},le),dt("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},le),dt("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},le),this._offset=Ne.convert(C&&C.offset||[0,-14])}this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",(C=>{C.preventDefault()})),this._element.addEventListener("mousedown",(C=>{C.preventDefault()}));const le=this._element.classList;for(const C in bI)le.remove(`mapboxgl-marker-anchor-${C}`);le.add(`mapboxgl-marker-anchor-${this._anchor}`);const ce=C&&C.className?C.className.trim().split(/\s+/):[];le.add(...ce),this._popup=null}addTo(C){return C===this._map||(this.remove(),this._map=C,C.getCanvasContainer().appendChild(this._element),C.on("move",this._updateMoving),C.on("moveend",this._update),C.on("remove",this._clearFadeTimer),C._addMarker(this),this.setDraggable(this._draggable),this._update(),C.on("click",this._onMapClick)),this}remove(){const C=this._map;return C&&(C.off("click",this._onMapClick),C.off("move",this._updateMoving),C.off("moveend",this._update),C.off("mousedown",this._addDragHandler),C.off("touchstart",this._addDragHandler),C.off("mouseup",this._onUp),C.off("touchend",this._onUp),C.off("mousemove",this._onMove),C.off("touchmove",this._onMove),C.off("remove",this._clearFadeTimer),C._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(C){return this._lngLat=Of.convert(C),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}getElement(){return this._element}setPopup(C){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),C){if(!("offset"in C.options)){const H=38.1,te=13.5,le=Math.sqrt(Math.pow(te,2)/2);C.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-H],"bottom-left":[le,-1*(H-te+le)],"bottom-right":[-le,-1*(H-te+le)],left:[te,-1*(H-te)],right:[-te,-1*(H-te)]}:this._offset}this._popup=C,C._marker=this,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(C){const H=C.code,te=C.charCode||C.keyCode;"Space"!==H&&"Enter"!==H&&32!==te&&13!==te||this.togglePopup()}_onMapClick(C){const H=C.originalEvent.target,te=this._element;this._popup&&(H===te||te.contains(H))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const C=this._popup;return C?(C.isOpen()?(C.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(C.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const C=this._map,H=this._pos;if(!C||!H)return!1;const te=C.unproject(H),le=C.getFreeCameraOptions();if(!le.position)return!1;const ce=le.position.toLngLat();return ce.distanceTo(te)<.9*ce.distanceTo(this._lngLat)}_evaluateOpacity(){const C=this._map;if(!C)return;const H=this._pos;if(!H||H.x<0||H.x>C.transform.width||H.y<0||H.y>C.transform.height)return void this._clearFadeTimer();const te=C.unproject(H);let le;C._showingGlobe()&&Dd(C.transform,this._lngLat)?le=0:(le=1-C._queryFogOpacity(te),C.transform._terrainEnabled()&&C.getTerrain()&&this._behindTerrain()&&(le*=this._occludedOpacity)),this._element.style.opacity=`${le}`,this._element.style.pointerEvents=le>0?"auto":"none",this._popup&&this._popup._setOpacity(le),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const C=this._pos;if(!C||!this._map)return;const H=this._offset.mult(this._scale);this._element.style.transform=`\n            translate(${C.x}px,${C.y}px)\n            ${bI[this._anchor]}\n            ${this._calculateXYTransform()} ${this._calculateZTransform()}\n            translate(${H.x}px,${H.y}px)\n        `}_calculateXYTransform(){const C=this._pos,H=this._map,te=this.getPitchAlignment();if(!H||!C||"map"!==te)return"";if(!H._showingGlobe()){const C=H.getPitch();return C?`rotateX(${C}deg)`:""}const le=T(zd(H.transform,this._lngLat)),ce=C.sub(Cd(H.transform)),he=Math.abs(ce.x)+Math.abs(ce.y);if(0===he)return"";const ue=le/he;return`rotateX(${-ce.y*ue}deg) rotateY(${ce.x*ue}deg)`}_calculateZTransform(){const C=this._pos,H=this._map;if(!H||!C)return"";let te=0;const le=this.getRotationAlignment();if("map"===le)if(H._showingGlobe()){const C=H.project(new Of(this._lngLat.lng,this._lngLat.lat+.001)),le=H.project(new Of(this._lngLat.lng,this._lngLat.lat-.001)).sub(C);te=T(Math.atan2(le.y,le.x))-90}else te=-H.getBearing();else if("horizon"===le){const le=D(4,6,H.getZoom()),ce=Cd(H.transform);ce.y+=le*H.transform.height;const he=C.sub(ce),ue=T(Math.atan2(he.y,he.x));te=(ue>90?ue-270:ue+90)*(1-le)}return te+=this._rotation,te?`rotateZ(${te}deg)`:""}_update(C){te.cancelAnimationFrame(this._updateFrameId);const H=this._map;H&&(H.transform.renderWorldCopies&&(this._lngLat=XS(this._lngLat,this._pos,H.transform)),this._pos=H.project(this._lngLat),!0===C?this._updateFrameId=te.requestAnimationFrame((()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())})):this._pos=this._pos.round(),H._requestDomTask((()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(H._showingGlobe()||H.getTerrain()||H.getFog())&&!this._fadeTimer&&(this._fadeTimer=setTimeout(this._evaluateOpacity.bind(this),60)))})))}getOffset(){return this._offset}setOffset(C){return this._offset=Ne.convert(C),this._update(),this}addClassName(C){return this._element.classList.add(C),this}removeClassName(C){return this._element.classList.remove(C),this}toggleClassName(C){return this._element.classList.toggle(C)}_onMove(C){const H=this._map;if(!H)return;const te=this._pointerdownPos,le=this._positionDelta;if(te&&le){if(!this._isDragging){const le=this._clickTolerance||H._clickTolerance;if(C.point.dist(te)<le)return;this._isDragging=!0}this._pos=C.point.sub(le),this._lngLat=H.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none","pending"===this._state&&(this._state="active",this.fire(new At("dragstart"))),this.fire(new At("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const C=this._map;C&&(C.off("mousemove",this._onMove),C.off("touchmove",this._onMove)),"active"===this._state&&this.fire(new At("dragend")),this._state="inactive"}_addDragHandler(C){const H=this._map,te=this._pos;H&&te&&this._element.contains(C.originalEvent.target)&&(C.preventDefault(),this._positionDelta=C.point.sub(te),this._pointerdownPos=C.point,this._state="pending",H.on("mousemove",this._onMove),H.on("touchmove",this._onMove),H.once("mouseup",this._onUp),H.once("touchend",this._onUp))}setDraggable(C){this._draggable=!!C;const H=this._map;return H&&(C?(H.on("mousedown",this._addDragHandler),H.on("touchstart",this._addDragHandler)):(H.off("mousedown",this._addDragHandler),H.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(C){return this._rotation=C||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(C){return this._rotationAlignment=C||"auto",this._update(),this}getRotationAlignment(){return"auto"===this._rotationAlignment||"horizon"===this._rotationAlignment&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(C){return this._pitchAlignment=C||"auto",this._update(),this}getPitchAlignment(){return"auto"===this._pitchAlignment?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(C){return this._occludedOpacity=C||.2,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const wI={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px"},TI=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function eI(C=new Ne(0,0),H="bottom"){if("number"==typeof C){const te=Math.round(Math.sqrt(.5*Math.pow(C,2)));switch(H){case"top":return new Ne(0,C);case"top-left":return new Ne(te,te);case"top-right":return new Ne(-te,te);case"bottom":return new Ne(0,-C);case"bottom-left":return new Ne(te,-te);case"bottom-right":return new Ne(-te,-te);case"left":return new Ne(C,0);case"right":return new Ne(-C,0)}return new Ne(0,0)}return C instanceof Ne||Array.isArray(C)?Ne.convert(C):Ne.convert(C[H]||[0,0])}class tI{constructor(C){this.jumpTo(C)}getValue(C){if(C<=this._startTime)return this._start;if(C>=this._endTime)return this._end;const H=M((C-this._startTime)/(this._endTime-this._startTime));return this._start*(1-H)+this._end*H}isEasing(C){return C>=this._startTime&&C<=this._endTime}jumpTo(C){this._startTime=-1/0,this._endTime=-1/0,this._start=C,this._end=C}easeTo(C,H,te){this._start=this.getValue(H),this._end=C,this._startTime=H,this._endTime=H+te}}const EI={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox logo","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use ⌘ + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"},MI={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1},SI={showCompass:!0,showZoom:!0,visualizePitch:!1};class oI{constructor(C,H,te=!1){this._clickTolerance=10,this.element=H,this.mouseRotate=new gS({clickTolerance:C.dragRotate._mouseRotate._clickTolerance}),this.map=C,te&&(this.mousePitch=new yS({clickTolerance:C.dragRotate._mousePitch._clickTolerance})),j(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),H.addEventListener("mousedown",this.mousedown),H.addEventListener("touchstart",this.touchstart,{passive:!1}),H.addEventListener("touchmove",this.touchmove),H.addEventListener("touchend",this.touchend),H.addEventListener("touchcancel",this.reset)}down(C,H){this.mouseRotate.mousedown(C,H),this.mousePitch&&this.mousePitch.mousedown(C,H),_t()}move(C,H){const te=this.map,le=this.mouseRotate.mousemoveWindow(C,H),ce=le&&le.bearingDelta;if(ce&&te.setBearing(te.getBearing()+ce),this.mousePitch){const le=this.mousePitch.mousemoveWindow(C,H),ce=le&&le.pitchDelta;ce&&te.setPitch(te.getPitch()+ce)}}off(){const C=this.element;C.removeEventListener("mousedown",this.mousedown),C.removeEventListener("touchstart",this.touchstart,{passive:!1}),C.removeEventListener("touchmove",this.touchmove),C.removeEventListener("touchend",this.touchend),C.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){gt(),te.removeEventListener("mousemove",this.mousemove),te.removeEventListener("mouseup",this.mouseup)}mousedown(C){this.down(k({},C,{ctrlKey:!0,preventDefault:()=>C.preventDefault()}),vt(this.element,C)),te.addEventListener("mousemove",this.mousemove),te.addEventListener("mouseup",this.mouseup)}mousemove(C){this.move(C,vt(this.element,C))}mouseup(C){this.mouseRotate.mouseupWindow(C),this.mousePitch&&this.mousePitch.mouseupWindow(C),this.offTemp()}touchstart(C){1!==C.targetTouches.length?this.reset():(this._startPos=this._lastPos=bt(this.element,C.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>C.preventDefault()},this._startPos))}touchmove(C){1!==C.targetTouches.length?this.reset():(this._lastPos=bt(this.element,C.targetTouches)[0],this.move({preventDefault:()=>C.preventDefault()},this._lastPos))}touchend(C){0===C.targetTouches.length&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}const AI={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},II={maxWidth:100,unit:"metric"},CI={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},zI={version:ce,supported:Wt,setRTLTextPlugin:function(C,H,te=!1){if(Yl===Ll||Yl===Ol||Yl===Fl)throw new Error("setRTLTextPlugin cannot be called multiple times.");Kl=yi.resolveURL(C),Yl=Ll,Wl=H,Xs(),te||Js()},getRTLTextPluginStatus:Ks,Map:class extends ZS{constructor(C){if(qt.mark(Zt.create),null!=(C=k({},MI,C)).minZoom&&null!=C.maxZoom&&C.minZoom>C.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(null!=C.minPitch&&null!=C.maxPitch&&C.minPitch>C.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(null!=C.minPitch&&C.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(null!=C.maxPitch&&C.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(C.antialias&&function(C){const H=C.navigator?C.navigator.userAgent:null;return!!function(C){if(null==He){const H=C.navigator?C.navigator.userAgent:null;He=!!C.safari||!(!H||!(/\b(iPad|iPhone|iPod)\b/.test(H)||H.match("Safari")&&!H.match("Chrome")))}return He}(C)&&H&&(H.match("Version/15.4")||H.match("Version/15.5")||H.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/))}(te)&&(C.antialias=!1,W("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new mv(C.minZoom,C.maxZoom,C.minPitch,C.maxPitch,C.renderWorldCopies),C),this._interactive=C.interactive,this._minTileCacheSize=C.minTileCacheSize,this._maxTileCacheSize=C.maxTileCacheSize,this._failIfMajorPerformanceCaveat=C.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=C.preserveDrawingBuffer,this._antialias=C.antialias,this._trackResize=C.trackResize,this._bearingSnap=C.bearingSnap,this._refreshExpiredTiles=C.refreshExpiredTiles,this._fadeDuration=C.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=C.crossSourceCollisions,this._collectResourceTiming=C.collectResourceTiming,this._language=this._parseLanguage(C.language),this._worldview=C.worldview,this._renderTaskQueue=new WS,this._domRenderTaskQueue=new WS,this._controls=[],this._markers=[],this._popups=[],this._mapId=F(),this._locale=k({},EI,C.locale),this._clickTolerance=C.clickTolerance,this._cooperativeGestures=C.cooperativeGestures,this._performanceMetricsCollection=C.performanceMetricsCollection,this._containerWidth=0,this._containerHeight=0,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new tI(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._requestManager=new ze(C.transformRequest,C.accessToken,C.testMode),this._silenceAuthErrors=!!C.testMode,"string"==typeof C.container){if(this._container=te.document.getElementById(C.container),!this._container)throw new Error(`Container '${C.container.toString()}' not found.`)}else{if(!(C.container instanceof te.HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=C.container}if(this._container.childNodes.length>0&&W("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),C.maxBounds&&this.setMaxBounds(C.maxBounds),j(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._setupPainter(),void 0===this.painter)throw new Error("Failed to initialize WebGL.");if(this.on("move",(()=>this._update(!1))),this.on("moveend",(()=>this._update(!1))),this.on("zoom",(()=>this._update(!0))),void 0!==te&&(this._fullscreenchangeEvent="onfullscreenchange"in te.document?"fullscreenchange":"webkitfullscreenchange",te.addEventListener("online",this._onWindowOnline,!1),te.addEventListener("resize",this._onWindowResize,!1),te.addEventListener("orientationchange",this._onWindowResize,!1),te.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),te.addEventListener("visibilitychange",this._onVisibilityChange,!1)),this.handlers=new GS(this,C),this._localFontFamily=C.localFontFamily,this._localIdeographFontFamily=C.localIdeographFontFamily,(C.style||!C.testMode)&&this.setStyle(C.style||ue.DEFAULT_STYLE,{localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),C.projection&&this.setProjection(C.projection),C.hash&&(this._hash=new WA("string"==typeof C.hash&&C.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){this.jumpTo({center:C.center,zoom:C.zoom,bearing:C.bearing,pitch:C.pitch});const H=C.bounds;H&&(this.resize(),this.fitBounds(H,k({},C.fitBoundsOptions,{duration:0})))}this.resize(),C.attributionControl&&this.addControl(new $S({customAttribution:C.customAttribution})),this._logoControl=new HS,this.addControl(this._logoControl,C.logoPosition),this.on("style.load",(()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet)})),this.on("data",(C=>{this._update("style"===C.dataType),this.fire(new At(`${C.dataType}data`,C))})),this.on("dataloading",(C=>{this.fire(new At(`${C.dataType}dataloading`,C))}))}_getMapId(){return this._mapId}addControl(C,H){if(void 0===H&&(H=C.getDefaultPosition?C.getDefaultPosition():"top-right"),!C||!C.onAdd)return this.fire(new St(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const te=C.onAdd(this);this._controls.push(C);const le=this._controlPositions[H];return-1!==H.indexOf("bottom")?le.insertBefore(te,le.firstChild):le.appendChild(te),this}removeControl(C){if(!C||!C.onRemove)return this.fire(new St(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const H=this._controls.indexOf(C);return H>-1&&this._controls.splice(H,1),C.onRemove(this),this}hasControl(C){return this._controls.indexOf(C)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(C){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const H=!this._moving;return H&&this.fire(new At("movestart",C)).fire(new At("move",C)),this.fire(new At("resize",C)),H&&this.fire(new At("moveend",C)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(C){return this.transform.setMaxBounds(Ql.convert(C)),this._update()}setMinZoom(C){if((C=null==C?-2:C)>=-2&&C<=this.transform.maxZoom)return this.transform.minZoom=C,this._update(),this.getZoom()<C?this.setZoom(C):this.fire(new At("zoomstart")).fire(new At("zoom")).fire(new At("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(C){if((C=null==C?22:C)>=this.transform.minZoom)return this.transform.maxZoom=C,this._update(),this.getZoom()>C?this.setZoom(C):this.fire(new At("zoomstart")).fire(new At("zoom")).fire(new At("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(C){if((C=null==C?0:C)<0)throw new Error("minPitch must be greater than or equal to 0");if(C>=0&&C<=this.transform.maxPitch)return this.transform.minPitch=C,this._update(),this.getPitch()<C?this.setPitch(C):this.fire(new At("pitchstart")).fire(new At("pitch")).fire(new At("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(C){if((C=null==C?85:C)>85)throw new Error("maxPitch must be less than or equal to 85");if(C>=this.transform.minPitch)return this.transform.maxPitch=C,this._update(),this.getPitch()>C?this.setPitch(C):this.fire(new At("pitchstart")).fire(new At("pitch")).fire(new At("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(C){return this.transform.renderWorldCopies=C,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(C){return"auto"===C?te.navigator.language:Array.isArray(C)?0===C.length?void 0:C.map((C=>"auto"===C?te.navigator.language:C)):C}setLanguage(C){const H=this._parseLanguage(C);if(!this.style||H===this._language)return this;this._language=H,this.style.clearSources();for(const C of this._controls)C._setLanguage&&C._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(C){return this.style&&C!==this._worldview?(this._worldview=C,this.style.clearSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return"globe"===this.transform.projection.name}setProjection(C){return this._lazyInitEmptyStyle(),C?"string"==typeof C&&(C={name:C}):C=null,this._useExplicitProjection=!!C,this._prioritizeAndUpdateProjection(C,this.style.projection)}_updateProjectionTransition(){if("globe"!==this.getProjection().name)return;const C=this.transform,H=C.projection.name;let te;"globe"===H&&C.zoom>=Pp?(C.setMercatorFromTransition(),te=!0):"mercator"===H&&C.zoom<Pp&&(C.setProjection({name:"globe"}),te=!0),te&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate())}_prioritizeAndUpdateProjection(C,H){return this._updateProjection(C||H||{name:"mercator"})}_updateProjection(C){let H;return H="globe"===C.name&&this.transform.zoom>=Pp?this.transform.setMercatorFromTransition():this.transform.setProjection(C),this.style.applyProjectionUpdate(),H&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(C){return this.transform.locationPoint3D(Of.convert(C))}unproject(C){return this.transform.pointLocation3D(Ne.convert(C))}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(C,H,te){if("mouseenter"===C||"mouseover"===C){let le=!1;const n=ce=>{const he=H.filter((C=>this.getLayer(C))),ue=he.length?this.queryRenderedFeatures(ce.point,{layers:he}):[];ue.length?le||(le=!0,te.call(this,new nS(C,this,ce.originalEvent,{features:ue}))):le=!1},o=()=>{le=!1};return{layers:new Set(H),listener:te,delegates:{mousemove:n,mouseout:o}}}if("mouseleave"===C||"mouseout"===C){let le=!1;const n=ce=>{const he=H.filter((C=>this.getLayer(C)));(he.length?this.queryRenderedFeatures(ce.point,{layers:he}):[]).length?le=!0:le&&(le=!1,te.call(this,new nS(C,this,ce.originalEvent)))},o=H=>{le&&(le=!1,te.call(this,new nS(C,this,H.originalEvent)))};return{layers:new Set(H),listener:te,delegates:{mousemove:n,mouseout:o}}}{const r=C=>{const le=H.filter((C=>this.getLayer(C))),ce=le.length?this.queryRenderedFeatures(C.point,{layers:le}):[];ce.length&&(C.features=ce,te.call(this,C),delete C.features)};return{layers:new Set(H),listener:te,delegates:{[C]:r}}}}on(C,H,te){if(void 0===te)return super.on(C,H);if(Array.isArray(H)||(H=[H]),H)for(const C of H)if(!this._isValidId(C))return this;const le=this._createDelegatedListener(C,H,te);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[C]=this._delegatedListeners[C]||[],this._delegatedListeners[C].push(le);for(const C in le.delegates)this.on(C,le.delegates[C]);return this}once(C,H,te){if(void 0===te)return super.once(C,H);if(Array.isArray(H)||(H=[H]),H)for(const C of H)if(!this._isValidId(C))return this;const le=this._createDelegatedListener(C,H,te);for(const C in le.delegates)this.once(C,le.delegates[C]);return this}off(C,H,te){if(void 0===te)return super.off(C,H);H=new Set(Array.isArray(H)?H:[H]);for(const C of H)if(!this._isValidId(C))return this;const r=(C,H)=>{if(C.size!==H.size)return!1;for(const te of C)if(!H.has(te))return!1;return!0},le=this._delegatedListeners?this._delegatedListeners[C]:void 0;return le&&(C=>{for(let le=0;le<C.length;le++){const ce=C[le];if(ce.listener===te&&r(ce.layers,H)){for(const C in ce.delegates)this.off(C,ce.delegates[C]);return C.splice(le,1),this}}})(le),this}queryRenderedFeatures(C,H){if(!this.style)return[];if(void 0!==H||void 0===C||C instanceof Ne||Array.isArray(C)||(H=C,C=void 0),C=C||[[0,0],[this.transform.width,this.transform.height]],(H=H||{}).layers&&Array.isArray(H.layers))for(const C of H.layers)if(!this._isValidId(C))return[];return this.style.queryRenderedFeatures(C,H,this.transform)}querySourceFeatures(C,H){return this._isValidId(C)?this.style.querySourceFeatures(C,H):[]}isPointOnSurface(C){const{name:H}=this.transform.projection;return"globe"!==H&&"mercator"!==H&&W(`${H} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(Ne.convert(C))}setStyle(C,H){return!1!==(H=k({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},H)).diff&&H.localIdeographFontFamily===this._localIdeographFontFamily&&H.localFontFamily===this._localFontFamily&&this.style&&C?(this._diffStyle(C,H),this):(this._localIdeographFontFamily=H.localIdeographFontFamily,this._localFontFamily=H.localFontFamily,this._updateStyle(C,H))}_getUIString(C){const H=this._locale[C];if(null==H)throw new Error(`Missing UI string '${C}'`);return H}_updateStyle(C,H){return this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),C&&(this.style=new $A(this,H||{}),this.style.setEventedParent(this,{style:this.style}),"string"==typeof C?this.style.loadURL(C):this.style.loadJSON(C)),this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new $A(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(C,H){if("string"==typeof C){const te=this._requestManager.normalizeStyleURL(C),le=this._requestManager.transformRequest(te,ot.Style);we(le,((C,te)=>{C?this.fire(new St(C)):te&&this._updateDiff(te,H)}))}else"object"==typeof C&&this._updateDiff(C,H)}_updateDiff(C,H){try{this.style.setState(C)&&this._update(!0)}catch(te){W(`Unable to perform style diff: ${te.message||te.error||te}.  Rebuilding the style from scratch.`),this._updateStyle(C,H)}}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(W("There is no style added to the map."),!1)}_isValidId(C){return!function(C){return C.indexOf("")>=0}(C)||(this.fire(new St(new Error(`IDs can't contain special symbols: "${C}".`))),!1)}addSource(C,H){return this._isValidId(C)?(this._lazyInitEmptyStyle(),this.style.addSource(C,H),this._update(!0)):this}isSourceLoaded(C){return!!this._isValidId(C)&&!!this.style&&this.style._isSourceCacheLoaded(C)}areTilesLoaded(){const C=this.style&&this.style._sourceCaches;for(const H in C){const te=C[H]._tiles;for(const C in te){const H=te[C];if("loaded"!==H.state&&"errored"!==H.state)return!1}}return!0}addSourceType(C,H,te){this._lazyInitEmptyStyle(),this.style.addSourceType(C,H,te)}removeSource(C){return this._isValidId(C)?(this.style.removeSource(C),this._updateTerrain(),this._update(!0)):this}getSource(C){return this._isValidId(C)?this.style.getOwnSource(C):null}addImage(C,H,{pixelRatio:le=1,sdf:ce=!1,stretchX:he,stretchY:ue,content:de}={}){if(this._lazyInitEmptyStyle(),H instanceof te.HTMLImageElement||te.ImageBitmap&&H instanceof te.ImageBitmap){const{width:te,height:_e,data:ye}=yi.getImageData(H);this.style.addImage(C,{data:new $p({width:te,height:_e},ye),pixelRatio:le,stretchX:he,stretchY:ue,content:de,sdf:ce,version:0})}else if(void 0===H.width||void 0===H.height)this.fire(new St(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:te,height:_e}=H,ye=H;this.style.addImage(C,{data:new $p({width:te,height:_e},new Uint8Array(ye.data)),pixelRatio:le,stretchX:he,stretchY:ue,content:de,sdf:ce,version:0,userImage:ye}),ye.onAdd&&ye.onAdd(this,C)}}updateImage(C,H){this._lazyInitEmptyStyle();const le=this.style.getImage(C);if(!le)return void this.fire(new St(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const ce=H instanceof te.HTMLImageElement||te.ImageBitmap&&H instanceof te.ImageBitmap?yi.getImageData(H):H,{width:he,height:ue}=ce;void 0!==he&&void 0!==ue?he===le.data.width&&ue===le.data.height?(le.data.replace(ce.data,!(H instanceof te.HTMLImageElement||te.ImageBitmap&&H instanceof te.ImageBitmap)),this.style.updateImage(C,le)):this.fire(new St(new Error(`The width and height of the updated image (${he}, ${ue})\n                must be that same as the previous version of the image\n                (${le.data.width}, ${le.data.height})`))):this.fire(new St(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")))}hasImage(C){return C?!!this.style&&!!this.style.getImage(C):(this.fire(new St(new Error("Missing required image id"))),!1)}removeImage(C){this.style.removeImage(C)}loadImage(C,H){Ie(this._requestManager.transformRequest(C,ot.Image),((C,le)=>{H(C,le instanceof te.HTMLImageElement?yi.getImageData(le):le)}))}listImages(){return this.style.listImages()}addModel(C,H){this._lazyInitEmptyStyle(),this.style.addModel(C,H)}hasModel(C){return C?this.style.hasModel(C):(this.fire(new St(new Error("Missing required model id"))),!1)}removeModel(C){this.style.removeModel(C)}listModels(){return this.style.listModels()}addLayer(C,H){return this._isValidId(C.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(C,H),this._update(!0)):this}moveLayer(C,H){return this._isValidId(C)?(this.style.moveLayer(C,H),this._update(!0)):this}removeLayer(C){return this._isValidId(C)?(this.style.removeLayer(C),this._update(!0)):this}getLayer(C){return this._isValidId(C)?this.style.getOwnLayer(C):null}setLayerZoomRange(C,H,te){return this._isValidId(C)?(this.style.setLayerZoomRange(C,H,te),this._update(!0)):this}setFilter(C,H,te={}){return this._isValidId(C)?(this.style.setFilter(C,H,te),this._update(!0)):this}getFilter(C){return this._isValidId(C)?this.style.getFilter(C):null}setPaintProperty(C,H,te,le={}){return this._isValidId(C)?(this.style.setPaintProperty(C,H,te,le),this._update(!0)):this}getPaintProperty(C,H){return this._isValidId(C)?this.style.getPaintProperty(C,H):null}setLayoutProperty(C,H,te,le={}){return this._isValidId(C)?(this.style.setLayoutProperty(C,H,te,le),this._update(!0)):this}getLayoutProperty(C,H){return this._isValidId(C)?this.style.getLayoutProperty(C,H):null}setConfigProperty(C,H,te){return this.style.setConfigProperty(C,H,te),this._update(!0)}setLights(C){if(this._lazyInitEmptyStyle(),C&&1===C.length&&"flat"===C[0].type){const H=C[0];H.properties?this.style.setFlatLight(H.properties,H.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(C),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){const C=this.style.getLights()||[];return 0===C.length&&C.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),C}setLight(C,H={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:C}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(C){return this._lazyInitEmptyStyle(),!C&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(C),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(C){return this._lazyInitEmptyStyle(),this.style.setFog(C),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setCamera(C){return this.style.setCamera(C),this._triggerCameraUpdate(C)}_triggerCameraUpdate(C){return this._update(this.transform.setOrthographicProjectionAtLowPitch("orthographic"===C["camera-projection"]))}getCamera(){return this.style.camera}_queryFogOpacity(C){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(Of.convert(C),this.transform):0}setFeatureState(C,H){return this._isValidId(C.source)?(this.style.setFeatureState(C,H),this._update()):this}removeFeatureState(C,H){return this._isValidId(C.source)?(this.style.removeFeatureState(C,H),this._update()):this}getFeatureState(C){return this._isValidId(C.source)?this.style.getFeatureState(C):null}_updateContainerDimensions(){if(!this._container)return;const C=this._container.getBoundingClientRect().width||400,H=this._container.getBoundingClientRect().height||300;let le,ce,he,ue=this._container;for(;ue&&(!ce||!he);){const C=te.getComputedStyle(ue).transform;C&&"none"!==C&&(le=C.match(/matrix.*\((.+)\)/)[1].split(", "),le[0]&&"0"!==le[0]&&"1"!==le[0]&&(ce=le[0]),le[3]&&"0"!==le[3]&&"1"!==le[3]&&(he=le[3])),ue=ue.parentElement}this._containerWidth=ce?Math.abs(C/ce):C,this._containerHeight=he?Math.abs(H/he):H}_detectMissingCSS(){"rgb(250, 128, 114)"!==te.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")&&W("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const C=this._container;C.classList.add("mapboxgl-map"),(this._missingCSSCanary=ut("div","mapboxgl-canary",C)).style.visibility="hidden",this._detectMissingCSS();const H=this._canvasContainer=ut("div","mapboxgl-canvas-container",C);this._canvas=ut("canvas","mapboxgl-canvas",H),this._interactive&&(H.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const te=this._controlContainer=ut("div","mapboxgl-control-container",C),le=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach((C=>{le[C]=ut("div",`mapboxgl-ctrl-${C}`,te)})),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(C,H){const te=yi.devicePixelRatio||1;this._canvas.width=te*Math.ceil(C),this._canvas.height=te*Math.ceil(H),this._canvas.style.width=`${C}px`,this._canvas.style.height=`${H}px`}_addMarker(C){this._markers.push(C)}_removeMarker(C){const H=this._markers.indexOf(C);-1!==H&&this._markers.splice(H,1)}_addPopup(C){this._popups.push(C)}_removePopup(C){const H=this._popups.indexOf(C);-1!==H&&this._popups.splice(H,1)}_setupPainter(){const C=k({},Wt.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),H=this._canvas.getContext("webgl2",C);H?(Ke(H,!0),this.painter=new zA(H,this.transform),this.on("data",(C=>{"source"===C.dataType&&this.painter.setTileLoadedFlag(!0)})),de.testSupport(H)):this.fire(new St(new Error("Failed to initialize WebGL")))}_contextLost(C){C.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new At("webglcontextlost",{originalEvent:C}))}_contextRestored(C){this._setupPainter(),this.resize(),this._update(),this.fire(new At("webglcontextrestored",{originalEvent:C}))}_onMapScroll(C){if(C.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(C){return this.style?(this._styleDirty=this._styleDirty||C,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(C){return this._update(),this._renderTaskQueue.add(C)}_cancelRenderFrame(C){this._renderTaskQueue.remove(C)}_requestDomTask(C){!this.loaded()||this.loaded()&&!this.isMoving()?C():this._domRenderTaskQueue.add(C)}_render(C){let H;this.fire(new At("renderstart"));const le=this.painter.context.extTimerQuery,ce=yi.now(),he=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(H=he.createQuery(),he.beginQuery(le.TIME_ELAPSED_EXT,H)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],te.performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],te.performance.now())),this._renderTaskQueue.run(C),this._domRenderTaskQueue.run(C),this._removed)return;this._updateProjectionTransition();const ue=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const C=this.transform.zoom,H=this.transform.pitch,te=yi.now(),le=new ea(C,{now:te,fadeDuration:ue,pitch:H,transition:this.style.transition});this.style.update(le)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let de=!1;if(this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),de=this._updateAverageElevation(ce),this.style.updateSources(this.transform),this._forceMarkerAndPopupUpdate()):de=this._updateAverageElevation(ce),this._placementDirty=this.style&&this.style._updatePlacement(this.painter.transform,this.showCollisionBoxes,ue,this._crossSourceCollisions),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:ue,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new At("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,this.fire(new At("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),H){const C=yi.now()-ce;he.endQuery(le.TIME_ELAPSED_EXT),setTimeout((()=>{const le=he.getQueryParameter(H,he.QUERY_RESULT)/1e6;he.deleteQuery(H),this.fire(new At("gpu-timing-frame",{cpuTime:C,gpuTime:le})),te.performance.mark("frame-gpu",{startTime:ce,detail:{gpuTime:le}})}),50)}if(this.listens("gpu-timing-layer")){const C=this.painter.collectGpuTimers();setTimeout((()=>{const H=this.painter.queryGpuTimers(C);this.fire(new At("gpu-timing-layer",{layerTimes:H}))}),50)}if(this.listens("gpu-timing-deferred-render")){const C=this.painter.collectDeferredRenderGpuQueries();setTimeout((()=>{const H=this.painter.queryGpuTimeDeferredRender(C);this.fire(new At("gpu-timing-deferred-render",{gpuTime:H}))}),50)}const _e=this._sourcesDirty||this._styleDirty||this._placementDirty||de;if(_e||this._repaint)this.triggerRepaint();else{const C=!this.isMoving()&&this.loaded();if(C&&(de=this._updateAverageElevation(ce,!0)),de)this.triggerRepaint();else if(this._triggerFrame(!1),C&&(this.fire(new At("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const C=this._calculateSpeedIndex();this.fire(new At("speedindexcompleted",{speedIndex:C})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||_e||(this._fullyLoaded=!0,qt.mark(Zt.fullLoad),this._performanceMetricsCollection&&Ut(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(C){for(const H of this._markers)C&&!this.getRenderWorldCopies()&&(H._lngLat=H._lngLat.wrap()),H._update();for(const H of this._popups)!C||this.getRenderWorldCopies()||H._trackPointer||(H._lngLat=H._lngLat.wrap()),H._update()}_updateAverageElevation(C,H=!1){const i=C=>(this.transform.averageElevation=C,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return 0!==this.transform.averageElevation&&i(0);const te=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(te||(H||C-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(C)){const H=this.transform.averageElevation;let le=this.transform.sampleAverageElevation();this.transform.elevation&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(le)?le=0:this._averageElevationLastSampledAt=C;const ce=Math.abs(H-le);if(ce>1){if(this._isInitialLoad||te)return this._averageElevation.jumpTo(le),i(le);this._averageElevation.easeTo(le,C,300)}else if(ce>1e-4)return this._averageElevation.jumpTo(le),i(le)}return!!this._averageElevation.isEasing(C)&&i(this._averageElevation.getValue(C))}_authenticate(){jt(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,(C=>{if(C&&(C.message===ht||401===C.status)){const C=this.painter.context.gl;Ke(C,!1),this._logoControl instanceof HS&&this._logoControl._updateLogo(),C&&C.clear(C.DEPTH_BUFFER_BIT|C.COLOR_BUFFER_BIT|C.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new St(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}})),Ft(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,(()=>{}))}_updateTerrain(){const C=this._isDragging();this.painter.updateTerrain(this.style,C)}_calculateSpeedIndex(){const C=this.painter.canvasCopy(),H=this.painter.getCanvasCopiesAndTimestamps();H.timeStamps.push(performance.now());const te=this.painter.context.gl,le=te.createFramebuffer();function n(C){te.framebufferTexture2D(te.FRAMEBUFFER,te.COLOR_ATTACHMENT0,te.TEXTURE_2D,C,0);const H=new Uint8Array(te.drawingBufferWidth*te.drawingBufferHeight*4);return te.readPixels(0,0,te.drawingBufferWidth,te.drawingBufferHeight,te.RGBA,te.UNSIGNED_BYTE,H),H}return te.bindFramebuffer(te.FRAMEBUFFER,le),this._canvasPixelComparison(n(C),H.canvasCopies.map(n),H.timeStamps)}_canvasPixelComparison(C,H,te){let le=te[1]-te[0];const ce=C.length/4;for(let he=0;he<H.length;he++){const ue=H[he];let de=0;for(let H=0;H<ue.length;H+=4)ue[H]===C[H]&&ue[H+1]===C[H+1]&&ue[H+2]===C[H+2]&&ue[H+3]===C[H+3]&&(de+=1);le+=(te[he+2]-te[he+1])*(1-de/ce)}return le}remove(){this._hash&&this._hash.remove();for(const C of this._controls)C.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),void 0!==te&&(te.removeEventListener("resize",this._onWindowResize,!1),te.removeEventListener("orientationchange",this._onWindowResize,!1),te.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),te.removeEventListener("online",this._onWindowOnline,!1),te.removeEventListener("visibilitychange",this._onVisibilityChange,!1));const C=this.painter.context.gl.getExtension("WEBGL_lose_context");C&&C.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),Gt.delete(this.painter.context.gl),this._removed=!0,this.fire(new At("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(C){this._renderNextFrame=this._renderNextFrame||C,this.style&&!this._frame&&(this._frame=yi.frame((C=>{const H=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,H&&this._render(C)})))}_preloadTiles(C){return R(this.style?Object.values(this.style._sourceCaches):[],((H,te)=>H._preloadTiles(C,te)),(()=>{this.triggerRepaint()})),this}_onWindowOnline(){this._update()}_onWindowResize(C){this._trackResize&&this.resize({originalEvent:C})._update()}_onVisibilityChange(){"hidden"===te.document.visibilityState&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(C){this._showTileBoundaries!==C&&(this._showTileBoundaries=C,this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(C){this._showTerrainWireframe!==C&&(this._showTerrainWireframe=C,this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(C){this._showLayers2DWireframe!==C&&(this._showLayers2DWireframe=C,this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(C){this._showLayers3DWireframe!==C&&(this._showLayers3DWireframe=C,this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(C){this._speedIndexTiming!==C&&(this._speedIndexTiming=C,this._update())}get showPadding(){return!!this._showPadding}set showPadding(C){this._showPadding!==C&&(this._showPadding=C,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(C){this._showCollisionBoxes!==C&&(this._showCollisionBoxes=C,C?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(C){this._showOverdrawInspector!==C&&(this._showOverdrawInspector=C,this._update())}get repaint(){return!!this._repaint}set repaint(C){this._repaint!==C&&(this._repaint=C,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(C){this._vertices=C,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(C){this._showTileAABBs!==C&&(this._showTileAABBs=C,C&&this._update())}_setCacheLimits(C,H){!function(C,H){Ye=C,Je=H}(C,H)}get version(){return ce}},NavigationControl:class{constructor(C){this.options=k({},SI,C),this._container=ut("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",(C=>C.preventDefault())),this.options.showZoom&&(j(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",(C=>{this._map&&this._map.zoomIn({},{originalEvent:C})})),ut("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",(C=>{this._map&&this._map.zoomOut({},{originalEvent:C})})),ut("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(j(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",(C=>{const H=this._map;H&&(this.options.visualizePitch?H.resetNorthPitch({},{originalEvent:C}):H.resetNorth({},{originalEvent:C}))})),this._compassIcon=ut("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const C=this._map;if(!C)return;const H=C.getZoom(),te=H===C.getMaxZoom(),le=H===C.getMinZoom();this._zoomInButton.disabled=te,this._zoomOutButton.disabled=le,this._zoomInButton.setAttribute("aria-disabled",te.toString()),this._zoomOutButton.setAttribute("aria-disabled",le.toString())}_rotateCompassArrow(){const C=this._map;if(!C)return;const H=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(C.transform.pitch*(Math.PI/180)),.5)}) rotateX(${C.transform.pitch}deg) rotateZ(${C.transform.angle*(180/Math.PI)}deg)`:`rotate(${C.transform.angle*(180/Math.PI)}deg)`;C._requestDomTask((()=>{this._compassIcon&&(this._compassIcon.style.transform=H)}))}onAdd(C){return this._map=C,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),C.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&C.on("pitch",this._rotateCompassArrow),C.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new oI(C,this._compass,this.options.visualizePitch)),this._container}onRemove(){const C=this._map;C&&(this._container.remove(),this.options.showZoom&&C.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&C.off("pitch",this._rotateCompassArrow),C.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(C,H){const te=ut("button",C,this._container);return te.type="button",te.addEventListener("click",H),te}_setButtonTitle(C,H){if(!this._map)return;const te=this._map._getUIString(`NavigationControl.${H}`);C.setAttribute("aria-label",te),C.firstElementChild&&C.firstElementChild.setAttribute("title",te)}},GeolocateControl:class extends It{constructor(C){super(),this.options=k({geolocation:te.navigator.geolocation},AI,C),j(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=HA(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(C){return this._map=C,this._container=ut("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){void 0!==this._geolocationWatchID&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(C){const i=(H=!!this.options.geolocation)=>{this._supportsGeolocation=H,C(H)};void 0!==this._supportsGeolocation?C(this._supportsGeolocation):void 0!==te.navigator.permissions?te.navigator.permissions.query({name:"geolocation"}).then((C=>i("denied"!==C.state))).catch((()=>i())):i()}_isOutOfMapMaxBounds(C){const H=this._map.getMaxBounds(),te=C.coords;return!!H&&(te.longitude<H.getWest()||te.longitude>H.getEast()||te.latitude<H.getSouth()||te.latitude>H.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(C){if(this._map){if(this._isOutOfMapMaxBounds(C))return this._setErrorState(),this.fire(new At("outofmaxbounds",C)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=C,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&"OFF"!==this._watchState&&this._updateMarker(C),this.options.trackUserLocation&&"ACTIVE_LOCK"!==this._watchState||this._updateCamera(C),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new At("geolocate",C)),this._finish()}}_updateCamera(C){const H=new Of(C.coords.longitude,C.coords.latitude),te=C.coords.accuracy,le=k({bearing:this._map.getBearing()},this.options.fitBoundsOptions);this._map.fitBounds(H.toBounds(te),le,{geolocateSource:!0})}_updateMarker(C){if(C){const H=new Of(C.coords.longitude,C.coords.latitude);this._accuracyCircleMarker.setLngLat(H).addTo(this._map),this._userLocationDotMarker.setLngLat(H).addTo(this._map),this._accuracy=C.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const C=this._map.transform,H=Zd(1,C._center.lat)*C.worldSize,te=Math.ceil(2*this._accuracy*H);this._circleElement.style.width=`${te}px`,this._circleElement.style.height=`${te}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&"number"==typeof this._heading?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(C){if(this._map){if(this.options.trackUserLocation)if(1===C.code){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const C=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",C),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",C),void 0!==this._geolocationWatchID&&this._clearWatch()}else{if(3===C.code&&this._noTimeout)return;this._setErrorState()}"OFF"!==this._watchState&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new At("error",C)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(C){if(void 0!==this._map){if(this._container.addEventListener("contextmenu",(C=>C.preventDefault())),this._geolocateButton=ut("button","mapboxgl-ctrl-geolocate",this._container),ut("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",!1===C){W("Geolocation support is not available so the GeolocateControl will be disabled.");const C=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",C),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",C)}else{const C=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",C),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",C)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=ut("div","mapboxgl-user-location"),this._dotElement.appendChild(ut("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(ut("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new KS({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=ut("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new KS({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",(C=>{C.geolocateSource||"ACTIVE_LOCK"!==this._watchState||C.originalEvent&&"resize"===C.originalEvent.type||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new At("trackuserlocationend")))}))}}_onDeviceOrientation(C){this._userLocationDotMarker&&(C.webkitCompassHeading?this._heading=C.webkitCompassHeading:!0===C.absolute&&(this._heading=-1*C.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return W("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new At("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new At("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new At("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if("OFF"===this._watchState&&void 0!==this._geolocationWatchID)this._clearWatch();else if(void 0===this._geolocationWatchID){let C;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(C={maximumAge:6e5,timeout:0},this._noTimeout=!0):(C=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,C),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const e=()=>{te.addEventListener("ondeviceorientationabsolute"in te?"deviceorientationabsolute":"deviceorientation",this._onDeviceOrientation)};void 0!==te.DeviceMotionEvent&&"function"==typeof te.DeviceMotionEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((C=>{"granted"===C&&e()})).catch(console.error):e()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),te.removeEventListener("deviceorientation",this._onDeviceOrientation),te.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:$S,ScaleControl:class{constructor(C){this.options=k({},II,C),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch(C){return!1}}(),j(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const C=this.options.maxWidth||100,H=this._map,te=H._containerHeight/2,le=H._containerWidth/2-C/2,ce=H.unproject([le,te]),he=H.unproject([le+C,te]),ue=ce.distanceTo(he);if("imperial"===this.options.unit){const H=3.2808*ue;H>5280?this._setScale(C,H/5280,"mile"):this._setScale(C,H,"foot")}else"nautical"===this.options.unit?this._setScale(C,ue/1852,"nautical-mile"):ue>=1e3?this._setScale(C,ue/1e3,"kilometer"):this._setScale(C,ue,"meter")}_setScale(C,H,te){this._map._requestDomTask((()=>{const le=function(C){const H=Math.pow(10,`${Math.floor(C)}`.length-1);let te=C/H;return te=te>=10?10:te>=5?5:te>=3?3:te>=2?2:te>=1?1:function(C){const H=Math.pow(10,Math.ceil(-Math.log(C)/Math.LN10));return Math.round(C*H)/H}(te),H*te}(H),ce=le/H;this._container.innerHTML=this._isNumberFormatSupported&&"nautical-mile"!==te?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:te}).format(le):`${le}&nbsp;${CI[te]}`,this._container.style.width=C*ce+"px"}))}onAdd(C){return this._map=C,this._language=C.getLanguage(),this._container=ut("div","mapboxgl-ctrl mapboxgl-ctrl-scale",C.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(C){this._language=C,this._update()}setUnit(C){this.options.unit=C,this._update()}},FullscreenControl:class{constructor(C){this._fullscreen=!1,C&&C.container&&(C.container instanceof te.HTMLElement?this._container=C.container:W("Full screen control 'container' must be a DOM element.")),j(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in te.document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in te.document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(C){return this._map=C,this._container||(this._container=this._map.getContainer()),this._controlContainer=ut("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",W("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,te.document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!te.document.fullscreenEnabled&&!te.document.webkitFullscreenEnabled)}_setupUI(){const C=this._fullscreenButton=ut("button","mapboxgl-ctrl-fullscreen",this._controlContainer);ut("span","mapboxgl-ctrl-icon",C).setAttribute("aria-hidden","true"),C.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),te.document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const C=this._getTitle();this._fullscreenButton.setAttribute("aria-label",C),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",C)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(te.document.fullscreenElement||te.document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?te.document.exitFullscreen?te.document.exitFullscreen():te.document.webkitCancelFullScreen&&te.document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends It{constructor(C){super(),this.options=k(Object.create(wI),C),j(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(C&&C.className?C.className.trim().split(/\s+/):[])}addTo(C){return this._map&&this.remove(),this._map=C,this.options.closeOnClick&&C.on("preclick",this._onClose),this.options.closeOnMove&&C.on("move",this._onClose),C.on("remove",this.remove),this._update(),C._addPopup(this),this._focusFirstElement(),this._trackPointer?(C.on("mousemove",this._onMouseEvent),C.on("mouseup",this._onMouseEvent),C._canvasContainer.classList.add("mapboxgl-track-pointer")):C.on("move",this._update),this.fire(new At("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const C=this._map;return C&&(C.off("move",this._update),C.off("move",this._onClose),C.off("preclick",this._onClose),C.off("click",this._onClose),C.off("remove",this.remove),C.off("mousemove",this._onMouseEvent),C.off("mouseup",this._onMouseEvent),C.off("drag",this._onMouseEvent),C._canvasContainer&&C._canvasContainer.classList.remove("mapboxgl-track-pointer"),C._removePopup(this),this._map=void 0),this.fire(new At("close")),this}getLngLat(){return this._lngLat}setLngLat(C){this._lngLat=Of.convert(C),this._pos=null,this._trackPointer=!1,this._update();const H=this._map;return H&&(H.on("move",this._update),H.off("mousemove",this._onMouseEvent),H._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const C=this._map;return C&&(C.off("move",this._update),C.on("mousemove",this._onMouseEvent),C.on("drag",this._onMouseEvent),C._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(C){return this.setDOMContent(te.document.createTextNode(C))}setHTML(C){const H=te.document.createDocumentFragment(),le=te.document.createElement("body");let ce;for(le.innerHTML=C;ce=le.firstChild,ce;)H.appendChild(ce);return this.setDOMContent(H)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(C){return this.options.maxWidth=C,this._update(),this}setDOMContent(C){let H=this._content;if(H)for(;H.hasChildNodes();)H.firstChild&&H.removeChild(H.firstChild);else H=this._content=ut("div","mapboxgl-popup-content",this._container||void 0);if(H.appendChild(C),this.options.closeButton){const C=this._closeButton=ut("button","mapboxgl-popup-close-button",H);C.type="button",C.setAttribute("aria-label","Close popup"),C.setAttribute("aria-hidden","true"),C.innerHTML="&#215;",C.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(C){return this._classList.add(C),this._updateClassList(),this}removeClassName(C){return this._classList.delete(C),this._updateClassList(),this}setOffset(C){return this.options.offset=C,this._update(),this}toggleClassName(C){let H;return this._classList.delete(C)?H=!1:(this._classList.add(C),H=!0),this._updateClassList(),H}_onMouseEvent(C){this._update(C.point)}_getAnchor(C){if(this.options.anchor)return this.options.anchor;const H=this._map,te=this._container,le=this._pos;if(!H||!te||!le)return"bottom";const ce=te.offsetWidth,he=te.offsetHeight,ue=le.x<ce/2,de=le.x>H.transform.width-ce/2;if(le.y+C<he)return ue?"top-left":de?"top-right":"top";if(le.y>H.transform.height-he){if(ue)return"bottom-left";if(de)return"bottom-right"}return ue?"left":de?"right":"bottom"}_updateClassList(){const C=this._container;if(!C)return;const H=[...this._classList];H.push("mapboxgl-popup"),this._anchor&&H.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&H.push("mapboxgl-popup-track-pointer"),C.className=H.join(" ")}_update(C){const H=this._map,te=this._content;if(!H||!this._lngLat&&!this._trackPointer||!te)return;let le=this._container;if(le||(le=this._container=ut("div","mapboxgl-popup",H.getContainer()),this._tip=ut("div","mapboxgl-popup-tip",le),le.appendChild(te)),this.options.maxWidth&&le.style.maxWidth!==this.options.maxWidth&&(le.style.maxWidth=this.options.maxWidth),H.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=XS(this._lngLat,this._pos,H.transform)),!this._trackPointer||C){const te=this._pos=this._trackPointer&&C?C:H.project(this._lngLat),le=eI(this.options.offset),ce=this._anchor=this._getAnchor(le.y),he=eI(this.options.offset,ce),ue=te.add(he).round();H._requestDomTask((()=>{this._container&&ce&&(this._container.style.transform=`${bI[ce]} translate(${ue.x}px,${ue.y}px)`)}))}if(!this._marker&&H._showingGlobe()){const C=Dd(H.transform,this._lngLat)?0:1;this._setOpacity(C)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const C=this._container.querySelector(TI);C&&C.focus()}_onClose(){this.remove()}_setOpacity(C){this._container&&(this._container.style.opacity=`${C}`),this._content&&(this._content.style.pointerEvents=C?"auto":"none")}},Marker:KS,Style:$A,LngLat:Of,LngLatBounds:Ql,Point:Ne,MercatorCoordinate:ep,FreeCameraOptions:Vx,Evented:It,config:ue,prewarm:function(){Uw().acquire(rE)},clearPrewarmedResources:function(){const C=nE;C&&(C.isPreloaded()&&1===C.numActive()?(C.release(rE),nE=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},get accessToken(){return ue.ACCESS_TOKEN},set accessToken(C){ue.ACCESS_TOKEN=C},get baseApiUrl(){return ue.API_URL},set baseApiUrl(C){ue.API_URL=C},get workerCount(){return Fw.workerCount},set workerCount(C){Fw.workerCount=C},get maxParallelImageRequests(){return ue.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(C){ue.MAX_PARALLEL_IMAGE_REQUESTS=C},clearStorage(C){!function(C){if(!pe())return;const H=te.caches.delete(Xe);C&&H.catch(C).then((()=>C()))}(C)},workerUrl:"",workerClass:null,get dracoUrl(){return Zw()},set dracoUrl(C){!function(C){sE=yi.resolveURL(C),uE||(uE=new _w(Uw(),new It)),uE.broadcast("setDracoUrl",sE)}(C)},setNow:yi.setNow,restoreNow:yi.restoreNow};C.A=mw,C.D=jm,C.E=wn,C.F=Zm,C.K=dE,C.O=Bu,C.P=Ne,C.T=Bv,C.V=l_,C.a=Jm,C.b=p_,C.c=Kb,C.d=class extends It{constructor(C,H,te,le,ce,he){super(),this.actor=C,this.layerIndex=H,this.availableImages=te,this.loadVectorData=ce||Pw,this.loading={},this.loaded={},this.deduped=new Dw(C.scheduler),this.isSpriteLoaded=le,this.scheduler=C.scheduler,this.brightness=he}loadTile(C,H){const te=C.uid,le=C&&C.request,ce=le&&le.collectResourceTiming,he=this.loading[te]=new Cw(C);he.abort=this.loadVectorData(C,((ue,de)=>{const _e=!this.loading[te];if(delete this.loading[te],_e||ue||!de)return he.status="done",_e||(this.loaded[te]=he),H(ue);const ye=de.rawData,ve={};de.expires&&(ve.expires=de.expires),de.cacheControl&&(ve.cacheControl=de.cacheControl),he.vectorTile=de.vectorTile||new n_(new S_(ye));const u=()=>{he.parse(he.vectorTile,this.layerIndex,this.availableImages,this.actor,((C,te)=>{if(C||!te)return H(C);const he={};if(ce){const C=it(le);C.length>0&&(he.resourceTiming=JSON.parse(JSON.stringify(C)))}H(null,k({rawTileData:ye.slice(0)},te,ve,he))}))};this.isSpriteLoaded?u():this.once("isSpriteLoaded",(()=>{this.scheduler?this.scheduler.add(u,{type:"parseTile",isSymbolTile:C.isSymbolTile,zoom:C.tileZoom}):u()})),this.loaded=this.loaded||{},this.loaded[te]=he}))}reloadTile(C,H){const te=this.loaded,le=C.uid,ce=this;if(te&&te[le]){const he=te[le];he.showCollisionBoxes=C.showCollisionBoxes,he.projection=C.projection,he.brightness=C.brightness,he.tileTransform=Tg(C.tileID.canonical,C.projection),he.extraShadowCaster=C.extraShadowCaster;const s=(C,te)=>{const le=he.reloadCallback;le&&(delete he.reloadCallback,he.parse(he.vectorTile,ce.layerIndex,this.availableImages,ce.actor,le)),H(C,te)};"parsing"===he.status?he.reloadCallback=s:"done"===he.status&&(he.vectorTile?he.parse(he.vectorTile,this.layerIndex,this.availableImages,this.actor,s):s())}}abortTile(C,H){const te=C.uid,le=this.loading[te];le&&(le.abort&&le.abort(),delete this.loading[te]),H()}removeTile(C,H){const te=this.loaded,le=C.uid;te&&te[le]&&delete te[le],H()}},C.e=xo,C.f=it,C.g=d,C.h=we,C.i=Te,C.j=function(C,H){const te=_T(C);for(const C of te){for(const H of C.meshes)gT(H);C.lights&&(C.lightMeshIndex=C.meshes.length,C.meshes.push(yT(C.lights,H)))}return te},C.k=ea,C.l=function(C){let H=0;if(new Uint32Array(C,0,1)[0]!==IE){const te=new Uint32Array(C,0,7),[,,le,ce,he,ue]=te;H=te.byteLength+ce+he+ue+he,(le!==C.byteLength||H>=C.byteLength)&&W("Invalid b3dm header information.")}return sT(C,H)},C.m=Hg,C.n=tc,C.o=At,C.p=Oe,C.q=function(C){fe(),Qe&&Qe.then((H=>{H.keys().then((te=>{for(let le=0;le<te.length-C;le++)H.delete(te[le])}))}))},C.r=DE,C.s=zI,C.t=Qd,C.v=L,C.w=te}));define(["./shared"],(function(C){function t(C){if("number"==typeof C||"boolean"==typeof C||"string"==typeof C||null==C)return JSON.stringify(C);if(Array.isArray(C)){let H="[";for(const te of C)H+=`${t(te)},`;return`${H}]`}let H="{";for(const te of Object.keys(C).sort())H+=`${te}:${t(C[te])},`;return`${H}}`}function r(H){let te="";for(const le of C.r)te+=`/${t(H[le])}`;return te}class o{constructor(C){this.keyCache={},C&&this.replace(C)}replace(C,H){this._layerConfigs={},this._layers={},this.update(C,[],H)}update(H,te,le){this._options=le;for(const te of H){this._layerConfigs[te.id]=te;const H=this._layers[te.id]=C.c(te,this._options);H.setScope(this.scope),H.compileFilter(),this.keyCache[te.id]&&delete this.keyCache[te.id]}for(const C of te)delete this.keyCache[C],delete this._layerConfigs[C],delete this._layers[C];this.familiesBySource={};const ce=function(C,H){const te={};for(let le=0;le<C.length;le++){const ce=H&&H[C[le].id]||r(C[le]);H&&(H[C[le].id]=ce);let he=te[ce];he||(he=te[ce]=[]),he.push(C[le])}const le=[];for(const C in te)le.push(te[C]);return le}(C.v(this._layerConfigs),this.keyCache);for(const C of ce){const H=C.map((C=>this._layers[C.id])),te=H[0];if("none"===te.visibility)continue;const le=te.source||"";let ce=this.familiesBySource[le];ce||(ce=this.familiesBySource[le]={});const he=te.sourceLayer||"_geojsonTileLayer";let ue=ce[he];ue||(ue=ce[he]=[]),ue.push(H)}}}class i{loadTile(H,te){const{uid:le,encoding:ce,rawImageData:he,padding:ue}=H,de=C.w.ImageBitmap&&he instanceof C.w.ImageBitmap?this.getImageData(he,ue):he;te(null,new C.D(le,de,ce,H.convertToFloat,ue<1))}getImageData(C,H){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(C.width,C.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=C.width,this.offscreenCanvas.height=C.height,this.offscreenCanvasContext.drawImage(C,0,0,C.width,C.height);const te=this.offscreenCanvasContext.getImageData(-H,-H,C.width+2*H,C.height+2*H);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),te}}function s(C,H){if(0!==C.length){n(C[0],H);for(var te=1;te<C.length;te++)n(C[te],!H)}}function n(C,H){for(var te=0,le=0,ce=0,he=C.length,ue=he-1;ce<he;ue=ce++){var de=(C[ce][0]-C[ue][0])*(C[ue][1]+C[ce][1]),_e=te+de;le+=Math.abs(te)>=Math.abs(de)?te-_e+de:de-_e+te,te=_e}te+le>=0!=!!H&&C.reverse()}var te=C.g((function e(C,H){var te,le=C&&C.type;if("FeatureCollection"===le)for(te=0;te<C.features.length;te++)e(C.features[te],H);else if("GeometryCollection"===le)for(te=0;te<C.geometries.length;te++)e(C.geometries[te],H);else if("Feature"===le)e(C.geometry,H);else if("Polygon"===le)s(C.coordinates,H);else if("MultiPolygon"===le)for(te=0;te<C.coordinates.length;te++)s(C.coordinates[te],H);return C}));const le=C.V.prototype.toGeoJSON;var ce={exports:{}},he=C.p,ue=C.a.VectorTileFeature,de=d;function d(C,te){(this||H).options=te||{},(this||H).features=C,(this||H).length=C.length}function p(C,te){(this||H).id="number"==typeof C.id?C.id:void 0,(this||H).type=C.type,(this||H).rawGeometry=1===C.type?[C.geometry]:C.geometry,(this||H).properties=C.tags,(this||H).extent=te||4096}d.prototype.feature=function(C){return new p((this||H).features[C],(this||H).options.extent)},p.prototype.loadGeometry=function(){var C=(this||H).rawGeometry;(this||H).geometry=[];for(var te=0;te<C.length;te++){for(var le=C[te],ce=[],ue=0;ue<le.length;ue++)ce.push(new he(le[ue][0],le[ue][1]));(this||H).geometry.push(ce)}return(this||H).geometry},p.prototype.bbox=function(){(this||H).geometry||this.loadGeometry();for(var C=(this||H).geometry,te=1/0,le=-1/0,ce=1/0,he=-1/0,ue=0;ue<C.length;ue++)for(var de=C[ue],_e=0;_e<de.length;_e++){var ye=de[_e];te=Math.min(te,ye.x),le=Math.max(le,ye.x),ce=Math.min(ce,ye.y),he=Math.max(he,ye.y)}return[te,ce,le,he]},p.prototype.toGeoJSON=ue.prototype.toGeoJSON;var _e=C.b,ye=de;function y(C){var H=new _e;return function(C,H){for(var te in C.layers)H.writeMessage(3,v,C.layers[te])}(C,H),H.finish()}function v(C,H){var te;H.writeVarintField(15,C.version||1),H.writeStringField(1,C.name||""),H.writeVarintField(5,C.extent||4096);var le={keys:[],values:[],keycache:{},valuecache:{}};for(te=0;te<C.length;te++)le.feature=C.feature(te),H.writeMessage(2,w,le);var ce=le.keys;for(te=0;te<ce.length;te++)H.writeStringField(3,ce[te]);var he=le.values;for(te=0;te<he.length;te++)H.writeMessage(4,I,he[te])}function w(C,H){var te=C.feature;void 0!==te.id&&H.writeVarintField(1,te.id),H.writeMessage(2,x,C),H.writeVarintField(3,te.type),H.writeMessage(4,b,te)}function x(C,H){var te=C.feature,le=C.keys,ce=C.values,he=C.keycache,ue=C.valuecache;for(var de in te.properties){var _e=te.properties[de],ye=he[de];if(null!==_e){void 0===ye&&(le.push(de),he[de]=ye=le.length-1),H.writeVarint(ye);var ve=typeof _e;"string"!==ve&&"boolean"!==ve&&"number"!==ve&&(_e=JSON.stringify(_e));var Me=ve+":"+_e,Se=ue[Me];void 0===Se&&(ce.push(_e),ue[Me]=Se=ce.length-1),H.writeVarint(Se)}}}function S(C,H){return(H<<3)+(7&C)}function M(C){return C<<1^C>>31}function b(C,H){for(var te=C.loadGeometry(),le=C.type,ce=0,he=0,ue=te.length,de=0;de<ue;de++){var _e=te[de],ye=1;1===le&&(ye=_e.length),H.writeVarint(S(1,ye));for(var ve=3===le?_e.length-1:_e.length,Me=0;Me<ve;Me++){1===Me&&1!==le&&H.writeVarint(S(2,ve-1));var Se=_e[Me].x-ce,Ae=_e[Me].y-he;H.writeVarint(M(Se)),H.writeVarint(M(Ae)),ce+=Se,he+=Ae}3===le&&H.writeVarint(S(7,1))}}function I(C,H){var te=typeof C;"string"===te?H.writeStringField(1,C):"boolean"===te?H.writeBooleanField(7,C):"number"===te&&(C%1!=0?H.writeDoubleField(3,C):C<0?H.writeSVarintField(6,C):H.writeVarintField(5,C))}ce.exports=y,ce.exports.fromVectorTileJs=y,ce.exports.fromGeojsonVt=function(C,H){H=H||{};var te={};for(var le in C)te[le]=new ye(C[le].features,H),te[le].name=le,te[le].version=H.version,te[le].extent=H.extent;return y({layers:te})},ce.exports.GeoJSONWrapper=ye;var ve=C.g(ce.exports);const Me={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:C=>C},Se=Math.fround||(Ae=new Float32Array(1),C=>(Ae[0]=+C,Ae[0]));var Ae;const Ce=3,Oe=5,Ne=6;class j{constructor(C){this.options=Object.assign(Object.create(Me),C),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(C){const{log:H,minZoom:te,maxZoom:le}=this.options;H&&console.time("total time");const ce=`prepare ${C.length} points`;H&&console.time(ce),this.points=C;const he=[];for(let H=0;H<C.length;H++){const te=C[H];if(!te.geometry)continue;const[le,ce]=te.geometry.coordinates,ue=Se(z(le)),de=Se(D(ce));he.push(ue,de,1/0,H,-1,1),this.options.reduce&&he.push(0)}let ue=this.trees[le+1]=this._createTree(he);H&&console.timeEnd(ce);for(let C=le;C>=te;C--){const te=+Date.now();ue=this.trees[C]=this._createTree(this._cluster(ue,C)),H&&console.log("z%d: %d clusters in %dms",C,ue.numItems,+Date.now()-te)}return H&&console.timeEnd("total time"),this}getClusters(C,H){let te=((C[0]+180)%360+360)%360-180;const le=Math.max(-90,Math.min(90,C[1]));let ce=180===C[2]?180:((C[2]+180)%360+360)%360-180;const he=Math.max(-90,Math.min(90,C[3]));if(C[2]-C[0]>=360)te=-180,ce=180;else if(te>ce){const C=this.getClusters([te,le,180,he],H),ue=this.getClusters([-180,le,ce,he],H);return C.concat(ue)}const ue=this.trees[this._limitZoom(H)],de=ue.range(z(te),D(he),z(ce),D(le)),_e=ue.data,ye=[];for(const C of de){const H=this.stride*C;ye.push(_e[H+Oe]>1?F(_e,H,this.clusterProps):this.points[_e[H+Ce]])}return ye}getChildren(C){const H=this._getOriginId(C),te=this._getOriginZoom(C),le="No cluster with the specified id.",ce=this.trees[te];if(!ce)throw new Error(le);const he=ce.data;if(H*this.stride>=he.length)throw new Error(le);const ue=this.options.radius/(this.options.extent*Math.pow(2,te-1)),de=ce.within(he[H*this.stride],he[H*this.stride+1],ue),_e=[];for(const H of de){const te=H*this.stride;he[te+4]===C&&_e.push(he[te+Oe]>1?F(he,te,this.clusterProps):this.points[he[te+Ce]])}if(0===_e.length)throw new Error(le);return _e}getLeaves(C,H,te){const le=[];return this._appendLeaves(le,C,H=H||10,te=te||0,0),le}getTile(C,H,te){const le=this.trees[this._limitZoom(C)],ce=Math.pow(2,C),{extent:he,radius:ue}=this.options,de=ue/he,_e=(te-de)/ce,ye=(te+1+de)/ce,ve={features:[]};return this._addTileFeatures(le.range((H-de)/ce,_e,(H+1+de)/ce,ye),le.data,H,te,ce,ve),0===H&&this._addTileFeatures(le.range(1-de/ce,_e,1,ye),le.data,ce,te,ce,ve),H===ce-1&&this._addTileFeatures(le.range(0,_e,de/ce,ye),le.data,-1,te,ce,ve),ve.features.length?ve:null}getClusterExpansionZoom(C){let H=this._getOriginZoom(C)-1;for(;H<=this.options.maxZoom;){const te=this.getChildren(C);if(H++,1!==te.length)break;C=te[0].properties.cluster_id}return H}_appendLeaves(C,H,te,le,ce){const he=this.getChildren(H);for(const H of he){const he=H.properties;if(he&&he.cluster?ce+he.point_count<=le?ce+=he.point_count:ce=this._appendLeaves(C,he.cluster_id,te,le,ce):ce<le?ce++:C.push(H),C.length===te)break}return ce}_createTree(H){const te=new C.K(H.length/this.stride|0,this.options.nodeSize,Float32Array);for(let C=0;C<H.length;C+=this.stride)te.add(H[C],H[C+1]);return te.finish(),te.data=H,te}_addTileFeatures(C,H,te,le,ce,he){for(const ue of C){const C=ue*this.stride,de=H[C+Oe]>1;let _e,ye,ve;if(de)_e=Z(H,C,this.clusterProps),ye=H[C],ve=H[C+1];else{const te=this.points[H[C+Ce]];_e=te.properties;const[le,ce]=te.geometry.coordinates;ye=z(le),ve=D(ce)}const Me={type:1,geometry:[[Math.round(this.options.extent*(ye*ce-te)),Math.round(this.options.extent*(ve*ce-le))]],tags:_e};let Se;Se=de||this.options.generateId?H[C+Ce]:this.points[H[C+Ce]].id,void 0!==Se&&(Me.id=Se),he.features.push(Me)}}_limitZoom(C){return Math.max(this.options.minZoom,Math.min(Math.floor(+C),this.options.maxZoom+1))}_cluster(C,H){const{radius:te,extent:le,reduce:ce,minPoints:he}=this.options,ue=te/(le*Math.pow(2,H)),de=C.data,_e=[],ye=this.stride;for(let te=0;te<de.length;te+=ye){if(de[te+2]<=H)continue;de[te+2]=H;const le=de[te],ve=de[te+1],Me=C.within(de[te],de[te+1],ue),Se=de[te+Oe];let Ae=Se;for(const C of Me){const te=C*ye;de[te+2]>H&&(Ae+=de[te+Oe])}if(Ae>Se&&Ae>=he){let C,he=le*Se,ue=ve*Se,Ce=-1;const Ne=((te/ye|0)<<5)+(H+1)+this.points.length;for(const le of Me){const _e=le*ye;if(de[_e+2]<=H)continue;de[_e+2]=H;const ve=de[_e+Oe];he+=de[_e]*ve,ue+=de[_e+1]*ve,de[_e+4]=Ne,ce&&(C||(C=this._map(de,te,!0),Ce=this.clusterProps.length,this.clusterProps.push(C)),ce(C,this._map(de,_e)))}de[te+4]=Ne,_e.push(he/Ae,ue/Ae,1/0,Ne,-1,Ae),ce&&_e.push(Ce)}else{for(let C=0;C<ye;C++)_e.push(de[te+C]);if(Ae>1)for(const C of Me){const te=C*ye;if(!(de[te+2]<=H)){de[te+2]=H;for(let C=0;C<ye;C++)_e.push(de[te+C])}}}}return _e}_getOriginId(C){return C-this.points.length>>5}_getOriginZoom(C){return(C-this.points.length)%32}_map(C,H,te){if(C[H+Oe]>1){const le=this.clusterProps[C[H+Ne]];return te?Object.assign({},le):le}const le=this.points[C[H+Ce]].properties,ce=this.options.map(le);return te&&ce===le?Object.assign({},ce):ce}}function F(C,H,te){return{type:"Feature",id:C[H+Ce],properties:Z(C,H,te),geometry:{type:"Point",coordinates:[(le=C[H],360*(le-.5)),E(C[H+1])]}};var le}function Z(C,H,te){const le=C[H+Oe],ce=le>=1e4?`${Math.round(le/1e3)}k`:le>=1e3?Math.round(le/100)/10+"k":le,he=C[H+Ne],ue=-1===he?{}:Object.assign({},te[he]);return Object.assign(ue,{cluster:!0,cluster_id:C[H+Ce],point_count:le,point_count_abbreviated:ce})}function z(C){return C/360+.5}function D(C){const H=Math.sin(C*Math.PI/180),te=.5-.25*Math.log((1+H)/(1-H))/Math.PI;return te<0?0:te>1?1:te}function E(C){const H=(180-360*C)*Math.PI/180;return 360*Math.atan(Math.exp(H))/Math.PI-90}var je={exports:{}};je.exports=function(){function e(C,H,te,le){for(var ce,he=le,ue=te-H>>1,de=te-H,_e=C[H],ye=C[H+1],ve=C[te],Me=C[te+1],Se=H+3;Se<te;Se+=3){var Ae=t(C[Se],C[Se+1],_e,ye,ve,Me);if(Ae>he)ce=Se,he=Ae;else if(Ae===he){var Ce=Math.abs(Se-ue);Ce<de&&(ce=Se,de=Ce)}}he>le&&(ce-H>3&&e(C,H,ce,le),C[ce+2]=he,te-ce>3&&e(C,ce,te,le))}function t(C,H,te,le,ce,he){var ue=ce-te,de=he-le;if(0!==ue||0!==de){var _e=((C-te)*ue+(H-le)*de)/(ue*ue+de*de);_e>1?(te=ce,le=he):_e>0&&(te+=ue*_e,le+=de*_e)}return(ue=C-te)*ue+(de=H-le)*de}function r(C,H,te,le){var ce={id:void 0===C?null:C,type:H,geometry:te,tags:le,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};return function(C){var H=C.geometry,te=C.type;if("Point"===te||"MultiPoint"===te||"LineString"===te)o(C,H);else if("Polygon"===te||"MultiLineString"===te)for(var le=0;le<H.length;le++)o(C,H[le]);else if("MultiPolygon"===te)for(le=0;le<H.length;le++)for(var ce=0;ce<H[le].length;ce++)o(C,H[le][ce])}(ce),ce}function o(C,H){for(var te=0;te<H.length;te+=3)C.minX=Math.min(C.minX,H[te]),C.minY=Math.min(C.minY,H[te+1]),C.maxX=Math.max(C.maxX,H[te]),C.maxY=Math.max(C.maxY,H[te+1])}function i(C,H,te,le){if(H.geometry){var ce=H.geometry.coordinates,he=H.geometry.type,ue=Math.pow(te.tolerance/((1<<te.maxZoom)*te.extent),2),de=[],_e=H.id;if(te.promoteId?_e=H.properties[te.promoteId]:te.generateId&&(_e=le||0),"Point"===he)s(ce,de);else if("MultiPoint"===he)for(var ye=0;ye<ce.length;ye++)s(ce[ye],de);else if("LineString"===he)n(ce,de,ue,!1);else if("MultiLineString"===he){if(te.lineMetrics){for(ye=0;ye<ce.length;ye++)n(ce[ye],de=[],ue,!1),C.push(r(_e,"LineString",de,H.properties));return}a(ce,de,ue,!1)}else if("Polygon"===he)a(ce,de,ue,!0);else{if("MultiPolygon"!==he){if("GeometryCollection"===he){for(ye=0;ye<H.geometry.geometries.length;ye++)i(C,{id:_e,geometry:H.geometry.geometries[ye],properties:H.properties},te,le);return}throw new Error("Input data is not a valid GeoJSON object.")}for(ye=0;ye<ce.length;ye++){var ve=[];a(ce[ye],ve,ue,!0),de.push(ve)}}C.push(r(_e,he,de,H.properties))}}function s(C,H){H.push(l(C[0])),H.push(h(C[1])),H.push(0)}function n(C,H,te,le){for(var ce,he,ue=0,de=0;de<C.length;de++){var _e=l(C[de][0]),ye=h(C[de][1]);H.push(_e),H.push(ye),H.push(0),de>0&&(ue+=le?(ce*ye-_e*he)/2:Math.sqrt(Math.pow(_e-ce,2)+Math.pow(ye-he,2))),ce=_e,he=ye}var ve=H.length-3;H[2]=1,e(H,0,ve,te),H[ve+2]=1,H.size=Math.abs(ue),H.start=0,H.end=H.size}function a(C,H,te,le){for(var ce=0;ce<C.length;ce++){var he=[];n(C[ce],he,te,le),H.push(he)}}function l(C){return C/360+.5}function h(C){var H=Math.sin(C*Math.PI/180),te=.5-.25*Math.log((1+H)/(1-H))/Math.PI;return te<0?0:te>1?1:te}function u(C,H,te,le,ce,he,ue,de){if(le/=H,he>=(te/=H)&&ue<le)return C;if(ue<te||he>=le)return null;for(var _e=[],ye=0;ye<C.length;ye++){var ve=C[ye],Me=ve.geometry,Se=ve.type,Ae=0===ce?ve.minX:ve.minY,Ce=0===ce?ve.maxX:ve.maxY;if(Ae>=te&&Ce<le)_e.push(ve);else if(!(Ce<te||Ae>=le)){var Oe=[];if("Point"===Se||"MultiPoint"===Se)c(Me,Oe,te,le,ce);else if("LineString"===Se)f(Me,Oe,te,le,ce,!1,de.lineMetrics);else if("MultiLineString"===Se)p(Me,Oe,te,le,ce,!1);else if("Polygon"===Se)p(Me,Oe,te,le,ce,!0);else if("MultiPolygon"===Se)for(var Ne=0;Ne<Me.length;Ne++){var je=[];p(Me[Ne],je,te,le,ce,!0),je.length&&Oe.push(je)}if(Oe.length){if(de.lineMetrics&&"LineString"===Se){for(Ne=0;Ne<Oe.length;Ne++)_e.push(r(ve.id,Se,Oe[Ne],ve.tags));continue}"LineString"!==Se&&"MultiLineString"!==Se||(1===Oe.length?(Se="LineString",Oe=Oe[0]):Se="MultiLineString"),"Point"!==Se&&"MultiPoint"!==Se||(Se=3===Oe.length?"Point":"MultiPoint"),_e.push(r(ve.id,Se,Oe,ve.tags))}}}return _e.length?_e:null}function c(C,H,te,le,ce){for(var he=0;he<C.length;he+=3){var ue=C[he+ce];ue>=te&&ue<=le&&(H.push(C[he]),H.push(C[he+1]),H.push(C[he+2]))}}function f(C,H,te,le,ce,he,ue){for(var de,_e,ye=d(C),ve=0===ce?m:y,Me=C.start,Se=0;Se<C.length-3;Se+=3){var Ae=C[Se],Ce=C[Se+1],Oe=C[Se+2],Ne=C[Se+3],je=C[Se+4],Ge=0===ce?Ae:Ce,Ze=0===ce?Ne:je,qe=!1;ue&&(de=Math.sqrt(Math.pow(Ae-Ne,2)+Math.pow(Ce-je,2))),Ge<te?Ze>te&&(_e=ve(ye,Ae,Ce,Ne,je,te),ue&&(ye.start=Me+de*_e)):Ge>le?Ze<le&&(_e=ve(ye,Ae,Ce,Ne,je,le),ue&&(ye.start=Me+de*_e)):g(ye,Ae,Ce,Oe),Ze<te&&Ge>=te&&(_e=ve(ye,Ae,Ce,Ne,je,te),qe=!0),Ze>le&&Ge<=le&&(_e=ve(ye,Ae,Ce,Ne,je,le),qe=!0),!he&&qe&&(ue&&(ye.end=Me+de*_e),H.push(ye),ye=d(C)),ue&&(Me+=de)}var $e=C.length-3;Ae=C[$e],Ce=C[$e+1],Oe=C[$e+2],(Ge=0===ce?Ae:Ce)>=te&&Ge<=le&&g(ye,Ae,Ce,Oe),$e=ye.length-3,he&&$e>=3&&(ye[$e]!==ye[0]||ye[$e+1]!==ye[1])&&g(ye,ye[0],ye[1],ye[2]),ye.length&&H.push(ye)}function d(C){var H=[];return H.size=C.size,H.start=C.start,H.end=C.end,H}function p(C,H,te,le,ce,he){for(var ue=0;ue<C.length;ue++)f(C[ue],H,te,le,ce,he,!1)}function g(C,H,te,le){C.push(H),C.push(te),C.push(le)}function m(C,H,te,le,ce,he){var ue=(he-H)/(le-H);return C.push(he),C.push(te+(ce-te)*ue),C.push(1),ue}function y(C,H,te,le,ce,he){var ue=(he-te)/(ce-te);return C.push(H+(le-H)*ue),C.push(he),C.push(1),ue}function v(C,H){for(var te=[],le=0;le<C.length;le++){var ce,he=C[le],ue=he.type;if("Point"===ue||"MultiPoint"===ue||"LineString"===ue)ce=w(he.geometry,H);else if("MultiLineString"===ue||"Polygon"===ue){ce=[];for(var de=0;de<he.geometry.length;de++)ce.push(w(he.geometry[de],H))}else if("MultiPolygon"===ue)for(ce=[],de=0;de<he.geometry.length;de++){for(var _e=[],ye=0;ye<he.geometry[de].length;ye++)_e.push(w(he.geometry[de][ye],H));ce.push(_e)}te.push(r(he.id,ue,ce,he.tags))}return te}function w(C,H){var te=[];te.size=C.size,void 0!==C.start&&(te.start=C.start,te.end=C.end);for(var le=0;le<C.length;le+=3)te.push(C[le]+H,C[le+1],C[le+2]);return te}function x(C,H){if(C.transformed)return C;var te,le,ce,he=1<<C.z,ue=C.x,de=C.y;for(te=0;te<C.features.length;te++){var _e=C.features[te],ye=_e.geometry,ve=_e.type;if(_e.geometry=[],1===ve)for(le=0;le<ye.length;le+=2)_e.geometry.push(S(ye[le],ye[le+1],H,he,ue,de));else for(le=0;le<ye.length;le++){var Me=[];for(ce=0;ce<ye[le].length;ce+=2)Me.push(S(ye[le][ce],ye[le][ce+1],H,he,ue,de));_e.geometry.push(Me)}}return C.transformed=!0,C}function S(C,H,te,le,ce,he){return[Math.round(te*(C*le-ce)),Math.round(te*(H*le-he))]}function M(C,H,te,le,ce){for(var he=H===ce.maxZoom?0:ce.tolerance/((1<<H)*ce.extent),ue={features:[],numPoints:0,numSimplified:0,numFeatures:0,source:null,x:te,y:le,z:H,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0},de=0;de<C.length;de++){ue.numFeatures++,b(ue,C[de],he,ce);var _e=C[de].minX,ye=C[de].minY,ve=C[de].maxX,Me=C[de].maxY;_e<ue.minX&&(ue.minX=_e),ye<ue.minY&&(ue.minY=ye),ve>ue.maxX&&(ue.maxX=ve),Me>ue.maxY&&(ue.maxY=Me)}return ue}function b(C,H,te,le){var ce=H.geometry,he=H.type,ue=[];if("Point"===he||"MultiPoint"===he)for(var de=0;de<ce.length;de+=3)ue.push(ce[de]),ue.push(ce[de+1]),C.numPoints++,C.numSimplified++;else if("LineString"===he)I(ue,ce,C,te,!1,!1);else if("MultiLineString"===he||"Polygon"===he)for(de=0;de<ce.length;de++)I(ue,ce[de],C,te,"Polygon"===he,0===de);else if("MultiPolygon"===he)for(var _e=0;_e<ce.length;_e++){var ye=ce[_e];for(de=0;de<ye.length;de++)I(ue,ye[de],C,te,!0,0===de)}if(ue.length){var ve=H.tags||null;if("LineString"===he&&le.lineMetrics){for(var Me in ve={},H.tags)ve[Me]=H.tags[Me];ve.mapbox_clip_start=ce.start/ce.size,ve.mapbox_clip_end=ce.end/ce.size}var Se={geometry:ue,type:"Polygon"===he||"MultiPolygon"===he?3:"LineString"===he||"MultiLineString"===he?2:1,tags:ve};null!==H.id&&(Se.id=H.id),C.features.push(Se)}}function I(C,H,te,le,ce,he){var ue=le*le;if(le>0&&H.size<(ce?ue:le))te.numPoints+=H.length/3;else{for(var de=[],_e=0;_e<H.length;_e+=3)(0===le||H[_e+2]>ue)&&(te.numSimplified++,de.push(H[_e]),de.push(H[_e+1])),te.numPoints++;ce&&function(C,H){for(var te=0,le=0,ce=C.length,he=ce-2;le<ce;he=le,le+=2)te+=(C[le]-C[he])*(C[le+1]+C[he+1]);if(te>0===H)for(le=0,ce=C.length;le<ce/2;le+=2){var ue=C[le],de=C[le+1];C[le]=C[ce-2-le],C[le+1]=C[ce-1-le],C[ce-2-le]=ue,C[ce-1-le]=de}}(de,he),C.push(de)}}function k(C,te){var le=(te=(this||H).options=function(C,H){for(var te in H)C[te]=H[te];return C}(Object.create((this||H).options),te)).debug;if(le&&console.time("preprocess data"),te.maxZoom<0||te.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(te.promoteId&&te.generateId)throw new Error("promoteId and generateId cannot be used together.");var ce=function(C,H){var te=[];if("FeatureCollection"===C.type)for(var le=0;le<C.features.length;le++)i(te,C.features[le],H,le);else i(te,"Feature"===C.type?C:{geometry:C},H);return te}(C,te);(this||H).tiles={},(this||H).tileCoords=[],le&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",te.indexMaxZoom,te.indexMaxPoints),console.time("generate tiles"),(this||H).stats={},(this||H).total=0),(ce=function(C,H){var te=H.buffer/H.extent,le=C,ce=u(C,1,-1-te,te,0,-1,2,H),he=u(C,1,1-te,2+te,0,-1,2,H);return(ce||he)&&(le=u(C,1,-te,1+te,0,-1,2,H)||[],ce&&(le=v(ce,1).concat(le)),he&&(le=le.concat(v(he,-1)))),le}(ce,te)).length&&this.splitTile(ce,0,0,0),le&&(ce.length&&console.log("features: %d, points: %d",(this||H).tiles[0].numFeatures,(this||H).tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",(this||H).total,JSON.stringify((this||H).stats)))}function P(C,H,te){return 32*((1<<C)*te+H)+C}return k.prototype.options={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0},k.prototype.splitTile=function(C,te,le,ce,he,ue,de){for(var _e=[C,te,le,ce],ye=(this||H).options,ve=ye.debug;_e.length;){ce=_e.pop(),le=_e.pop(),te=_e.pop(),C=_e.pop();var Me=1<<te,Se=P(te,le,ce),Ae=(this||H).tiles[Se];if(!Ae&&(ve>1&&console.time("creation"),Ae=(this||H).tiles[Se]=M(C,te,le,ce,ye),(this||H).tileCoords.push({z:te,x:le,y:ce}),ve)){ve>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",te,le,ce,Ae.numFeatures,Ae.numPoints,Ae.numSimplified),console.timeEnd("creation"));var Ce="z"+te;(this||H).stats[Ce]=((this||H).stats[Ce]||0)+1,(this||H).total++}if(Ae.source=C,he){if(te===ye.maxZoom||te===he)continue;var Oe=1<<he-te;if(le!==Math.floor(ue/Oe)||ce!==Math.floor(de/Oe))continue}else if(te===ye.indexMaxZoom||Ae.numPoints<=ye.indexMaxPoints)continue;if(Ae.source=null,0!==C.length){ve>1&&console.time("clipping");var Ne,je,Ge,Ze,qe,$e,We=.5*ye.buffer/ye.extent,He=.5-We,Xe=.5+We,Ye=1+We;Ne=je=Ge=Ze=null,qe=u(C,Me,le-We,le+Xe,0,Ae.minX,Ae.maxX,ye),$e=u(C,Me,le+He,le+Ye,0,Ae.minX,Ae.maxX,ye),C=null,qe&&(Ne=u(qe,Me,ce-We,ce+Xe,1,Ae.minY,Ae.maxY,ye),je=u(qe,Me,ce+He,ce+Ye,1,Ae.minY,Ae.maxY,ye),qe=null),$e&&(Ge=u($e,Me,ce-We,ce+Xe,1,Ae.minY,Ae.maxY,ye),Ze=u($e,Me,ce+He,ce+Ye,1,Ae.minY,Ae.maxY,ye),$e=null),ve>1&&console.timeEnd("clipping"),_e.push(Ne||[],te+1,2*le,2*ce),_e.push(je||[],te+1,2*le,2*ce+1),_e.push(Ge||[],te+1,2*le+1,2*ce),_e.push(Ze||[],te+1,2*le+1,2*ce+1)}}},k.prototype.getTile=function(C,te,le){var ce=(this||H).options,he=ce.extent,ue=ce.debug;if(C<0||C>24)return null;var de=1<<C,_e=P(C,te=(te%de+de)%de,le);if((this||H).tiles[_e])return x((this||H).tiles[_e],he);ue>1&&console.log("drilling down to z%d-%d-%d",C,te,le);for(var ye,ve=C,Me=te,Se=le;!ye&&ve>0;)ve--,Me=Math.floor(Me/2),Se=Math.floor(Se/2),ye=(this||H).tiles[P(ve,Me,Se)];return ye&&ye.source?(ue>1&&console.log("found parent tile z%d-%d-%d",ve,Me,Se),ue>1&&console.time("drilling down"),this.splitTile(ye.source,ve,Me,Se,C,te,le),ue>1&&console.timeEnd("drilling down"),(this||H).tiles[_e]?x((this||H).tiles[_e],he):null):null},function(C,H){return new k(C,H)}}();var Ge=C.g(je.exports);function Y(te,ce){const he=te.tileID.canonical;if(!(this||H)._geoJSONIndex)return ce(null,null);const ue=(this||H)._geoJSONIndex.getTile(he.z,he.x,he.y);if(!ue)return ce(null,null);const de=new class{constructor(H){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=C.E,this.length=H.length,this._features=H}feature(H){return new class{constructor(H){this._feature=H,this.extent=C.E,this.type=H.type,this.properties=H.tags,"id"in H&&!isNaN(H.id)&&(this.id=parseInt(H.id,10))}loadGeometry(){if(1===this._feature.type){const H=[];for(const te of this._feature.geometry)H.push([new C.P(te[0],te[1])]);return H}{const H=[];for(const te of this._feature.geometry){const le=[];for(const H of te)le.push(new C.P(H[0],H[1]));H.push(le)}return H}}toGeoJSON(C,H,te){return le.call(this,C,H,te)}}(this._features[H])}}(ue.features);let _e=ve(de);0===_e.byteOffset&&_e.byteLength===_e.buffer.byteLength||(_e=new Uint8Array(_e)),ce(null,{vectorTile:de,rawData:_e.buffer})}class G extends C.d{constructor(C,H,te,le,ce,he){super(C,H,te,le,Y,he),ce&&(this.loadGeoJSON=ce)}loadData(H,le){const ce=H&&H.request,he=ce&&ce.collectResourceTiming;this.loadGeoJSON(H,((ue,de)=>{if(ue||!de)return le(ue);if("object"!=typeof de)return le(new Error(`Input data given to '${H.source}' is not a valid GeoJSON object.`));{te(de,!0);try{if(H.filter){const te=C.e(H.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if("error"===te.result)throw new Error(te.value.map((C=>`${C.key}: ${C.message}`)).join(", "));const le=de.features.filter((C=>te.value.evaluate({zoom:0},C)));de={type:"FeatureCollection",features:le}}this._geoJSONIndex=H.cluster?new j(function({superclusterOptions:H,clusterProperties:te}){if(!te||!H)return H;const le={},ce={},he={accumulated:null,zoom:0},ue={properties:null},de=Object.keys(te);for(const H of de){const[he,ue]=te[H],de=C.e(ue),_e=C.e("string"==typeof he?[he,["accumulated"],["get",H]]:he);le[H]=de.value,ce[H]=_e.value}return H.map=C=>{ue.properties=C;const H={};for(const C of de)H[C]=le[C].evaluate(he,ue);return H},H.reduce=(C,H)=>{ue.properties=H;for(const H of de)he.accumulated=C[H],C[H]=ce[H].evaluate(he,ue)},H}(H)).load(de.features):Ge(de,H.geojsonVtOptions)}catch(ue){return le(ue)}this.loaded={};const _e={};if(he){const te=C.f(ce);te&&(_e.resourceTiming={},_e.resourceTiming[H.source]=JSON.parse(JSON.stringify(te)))}le(null,_e)}}))}reloadTile(C,H){const te=this.loaded;return te&&te[C.uid]?super.reloadTile(C,H):this.loadTile(C,H)}loadGeoJSON(H,te){if(H.request)C.h(H.request,te);else{if("string"!=typeof H.data)return te(new Error(`Input data given to '${H.source}' is not a valid GeoJSON object.`));try{return te(null,JSON.parse(H.data))}catch(C){return te(new Error(`Input data given to '${H.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(C,H){try{H(null,this._geoJSONIndex.getClusterExpansionZoom(C.clusterId))}catch(C){H(C)}}getClusterChildren(C,H){try{H(null,this._geoJSONIndex.getChildren(C.clusterId))}catch(C){H(C)}}getClusterLeaves(C,H){try{H(null,this._geoJSONIndex.getLeaves(C.clusterId,C.limit,C.offset))}catch(C){H(C)}}}class W{constructor(H,te){this.tileID=new C.O(H.tileID.overscaledZ,H.tileID.wrap,H.tileID.canonical.z,H.tileID.canonical.x,H.tileID.canonical.y),this.tileZoom=H.tileZoom,this.uid=H.uid,this.zoom=H.zoom,this.canonical=H.tileID.canonical,this.pixelRatio=H.pixelRatio,this.tileSize=H.tileSize,this.source=H.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=H.projection,this.brightness=te}parse(H,te,le,ce){this.status="parsing";const he=new C.O(le.tileID.overscaledZ,le.tileID.wrap,le.tileID.canonical.z,le.tileID.canonical.x,le.tileID.canonical.y),ue={},de=te.familiesBySource[le.source],_e=new C.F(he,le.promoteId);return _e.bucketLayerIDs=[],C.l(H).then((H=>{if(!H)return ce(new Error("Could not parse tile"));const te=C.j(H,1/C.t(le.tileID.canonical)),ye=H.json.extensionsUsed&&H.json.extensionsUsed.includes("MAPBOX_mesh_features"),ve=new C.k(this.zoom,{brightness:this.brightness});for(const le in de)for(const ce of de[le]){const le=ce[0],de=H.json.extensionsUsed;le.recalculate(ve,[]);const _e=new C.T(te,he,de&&de.includes("MAPBOX_mesh_features"),this.brightness);ye||(_e.needsUpload=!0),ue[le.fqid]=_e,_e.evaluate(le)}this.status="done",ce(null,{buckets:ue,featureIndex:_e})})).catch((C=>ce(new Error(C.message))))}}class X{constructor(C,H,te,le,ce,he){this.actor=C,this.layerIndex=H,this.brightness=he,this.loading={},this.loaded={}}loadTile(H,te){const le=H.uid,ce=this.loading[le]=new W(H,this.brightness);C.i(H.request,((C,he)=>{const ue=!this.loading[le];return delete this.loading[le],ue||C?(ce.status="done",ue||(this.loaded[le]=ce),te(C)):he&&0!==he.byteLength?void ce.parse(he,this.layerIndex,H,((C,H)=>{ce.status="done",this.loaded=this.loaded||{},this.loaded[le]=ce,C||!H?te(C):te(null,H)})):(ce.status="done",this.loaded[le]=ce,te())}))}reloadTile(C,H){const te=this.loaded,le=C.uid;if(te&&te[le]){const ce=te[le];ce.projection=C.projection,ce.brightness=C.brightness;const s=(te,le)=>{ce.reloadCallback&&(delete ce.reloadCallback,this.loadTile(C,H)),H(te,le)};"parsing"===ce.status?ce.reloadCallback=s:"done"===ce.status&&this.loadTile(C,H)}}abortTile(C,H){const te=C.uid;this.loading[te]&&delete this.loading[te],H()}removeTile(C,H){const te=this.loaded,le=C.uid;te&&te[le]&&delete te[le],H()}}class V{constructor(H){this.self=H,this.actor=new C.A(H,this),this.layerIndexes={},this.availableImages={},this.isSpriteLoaded={},this.projections={},this.defaultProjection=C.m({name:"mercator"}),this.workerSourceTypes={vector:C.d,geojson:G,"batched-model":X},this.workerSources={},this.demWorkerSources={},this.self.registerWorkerSource=(C,H)=>{if(this.workerSourceTypes[C])throw new Error(`Worker source with name "${C}" already registered.`);this.workerSourceTypes[C]=H},this.self.registerRTLTextPlugin=H=>{if(C.n.isParsed())throw new Error("RTL text plugin already registered.");C.n.applyArabicShaping=H.applyArabicShaping,C.n.processBidirectionalText=H.processBidirectionalText,C.n.processStyledBidirectionalText=H.processStyledBidirectionalText}}clearCaches(C,H,te){delete this.layerIndexes[C],delete this.availableImages[C],delete this.workerSources[C],delete this.demWorkerSources[C],te()}checkIfReady(C,H,te){te()}setReferrer(C,H){this.referrer=H}spriteLoaded(H,{scope:te,isLoaded:le}){if(this.isSpriteLoaded[H]||(this.isSpriteLoaded[H]={}),this.isSpriteLoaded[H][te]=le,this.workerSources[H]&&this.workerSources[H][te])for(const ce in this.workerSources[H][te]){const he=this.workerSources[H][te][ce];for(const H in he)he[H]instanceof C.d&&(he[H].isSpriteLoaded=le,he[H].fire(new C.o("isSpriteLoaded")))}}setImages(C,{scope:H,images:te},le){if(this.availableImages[C]||(this.availableImages[C]={}),this.availableImages[C][H]=te,this.workerSources[C]&&this.workerSources[C][H]){for(const le in this.workerSources[C][H]){const ce=this.workerSources[C][H][le];for(const C in ce)ce[C].availableImages=te}le()}else le()}setProjection(H,te){this.projections[H]=C.m(te)}setBrightness(C,H,te){this.brightness=H,te()}setLayers(C,H,te){this.getLayerIndex(C,H.scope).replace(H.layers,H.options),te()}updateLayers(C,H,te){this.getLayerIndex(C,H.scope).update(H.layers,H.removedIds,H.options),te()}loadTile(C,H,te){H.projection=this.projections[C]||this.defaultProjection,this.getWorkerSource(C,H.type,H.source,H.scope).loadTile(H,te)}loadDEMTile(C,H,te){this.getDEMWorkerSource(C,H.source,H.scope).loadTile(H,te)}reloadTile(C,H,te){H.projection=this.projections[C]||this.defaultProjection,this.getWorkerSource(C,H.type,H.source,H.scope).reloadTile(H,te)}abortTile(C,H,te){this.getWorkerSource(C,H.type,H.source,H.scope).abortTile(H,te)}removeTile(C,H,te){this.getWorkerSource(C,H.type,H.source,H.scope).removeTile(H,te)}removeSource(C,H,te){if(!(this.workerSources[C]&&this.workerSources[C][H.scope]&&this.workerSources[C][H.scope][H.type]&&this.workerSources[C][H.scope][H.type][H.source]))return;const le=this.workerSources[C][H.scope][H.type][H.source];delete this.workerSources[C][H.scope][H.type][H.source],void 0!==le.removeSource?le.removeSource(H,te):te()}loadWorkerSource(C,H,te){try{this.self.importScripts(H.url),te()}catch(C){te(C.toString())}}syncRTLPluginState(H,te,le){try{C.n.setState(te);const H=C.n.getPluginURL();if(C.n.isLoaded()&&!C.n.isParsed()&&null!=H){this.self.importScripts(H);const te=C.n.isParsed();le(te?void 0:new Error(`RTL Text Plugin failed to import scripts from ${H}`),te)}}catch(C){le(C.toString())}}setDracoUrl(C,H){this.dracoUrl=H}getAvailableImages(C,H){this.availableImages[C]||(this.availableImages[C]={});let te=this.availableImages[C][H];return te||(te=[]),te}getLayerIndex(C,H){this.layerIndexes[C]||(this.layerIndexes[C]={});let te=this.layerIndexes[C][H];return te||(te=this.layerIndexes[C][H]=new o,te.scope=H),te}getWorkerSource(C,H,te,le){if(this.workerSources[C]||(this.workerSources[C]={}),this.workerSources[C][le]||(this.workerSources[C][le]={}),this.workerSources[C][le][H]||(this.workerSources[C][le][H]={}),this.isSpriteLoaded[C]||(this.isSpriteLoaded[C]={}),!this.workerSources[C][le][H][te]){const ce={send:(H,te,le,ce,he,ue)=>{this.actor.send(H,te,le,C,he,ue)},scheduler:this.actor.scheduler};this.workerSources[C][le][H][te]=new this.workerSourceTypes[H](ce,this.getLayerIndex(C,le),this.getAvailableImages(C,le),this.isSpriteLoaded[C][le],void 0,this.brightness)}return this.workerSources[C][le][H][te]}getDEMWorkerSource(C,H,te){return this.demWorkerSources[C]||(this.demWorkerSources[C]={}),this.demWorkerSources[C][te]||(this.demWorkerSources[C][te]={}),this.demWorkerSources[C][te][H]||(this.demWorkerSources[C][te][H]=new i),this.demWorkerSources[C][te][H]}enforceCacheSizeLimit(H,te){C.q(te)}getWorkerPerformanceMetrics(C,H,te){te(void 0,void 0)}}return"undefined"!=typeof WorkerGlobalScope&&"undefined"!=typeof self&&self instanceof WorkerGlobalScope&&(self.worker=new V(self)),V}));define(["./shared"],(function(C){return C.s}));var he=ce;return he}));var ce=te;export{ce as default};

